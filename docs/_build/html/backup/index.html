

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Create database backup &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Some tricks" href="../working_with_aiida/troubleshooting.html" />
    <link rel="prev" title="Retrieving results" href="../working_with_aiida/resultmanager.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../working_with_aiida/index.html#backups">Backups</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Create database backup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#restore-database-backup">Restore database backup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#move-database">Move database</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setup-repository-backup">Setup repository backup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../working_with_aiida/index.html">Command line interface</a> &raquo;</li>
        
      <li>Create database backup</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/backup/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p id="backup">In this page you will find useful information on how to backup your database,
how to move it to a different location and how to backup your repository.</p>
<div class="section" id="create-database-backup">
<span id="backup-postgresql"></span><h1>Create database backup<a class="headerlink" href="#create-database-backup" title="Permalink to this headline">Â¶</a></h1>
<p>It is strongly advised to backup the content of your database daily. Below are
instructions to set this up for the PostgreSQL database, under Ubuntu
(tested with version 12.04).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Perform the following operation after having set up AiiDA. Only then
the <code class="docutils literal notranslate"><span class="pre">~/.aiida</span></code> folder (and the files within) will be created.</p>
</div>
<p>The database files are not put in the <code class="docutils literal notranslate"><span class="pre">.aiida</span></code> folder but in the system directories
which typically are not backed up. Moreover, the database is spread over lots of files
that, if backed up as they are at a given time, cannot be re-used to restore the database.</p>
<p>So you need to periodically (typically once a day) dump the database contents in a file
that will be backed up.
This can be done by the following bash script
<a class="reference download internal" download="" href="../_downloads/d0edbc7a01baf303ba230517ba184042/backup_postgresql.sh"><code class="xref download docutils literal notranslate"><span class="pre">backup_postgresql.sh</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
AIIDAUSER=aiida
AIIDADB=aiidadb
AIIDAPORT=5432
## STORE THE PASSWORD, IN THE PROPER FORMAT, IN THE ~/.pgpass file
## see http://www.postgresql.org/docs/current/static/libpq-pgpass.html
AIIDALOCALTMPDUMPFILE=~/.aiida/${AIIDADB}-backup.psql.gz


if [ -e ${AIIDALOCALTMPDUMPFILE} ]
then
    mv ${AIIDALOCALTMPDUMPFILE} ${AIIDALOCALTMPDUMPFILE}~
fi

# NOTE: password stored in ~/.pgpass, where pg_dump will read it automatically
pg_dump -h localhost -p $AIIDAPORT -U $AIIDAUSER $AIIDADB | gzip &gt; $AIIDALOCALTMPDUMPFILE || rm $AIIDALOCALTMPDUMPFILE
</pre></div>
</div>
<p>Before launching the script you need to create the file <code class="docutils literal notranslate"><span class="pre">~/.pgpass</span></code> to avoid having to enter your database
password each time you use the script. It should look like (<a class="reference download internal" download="" href="../_downloads/60566dc0d80c15342f04e9b04a3e96b8/pgpass"><code class="xref download docutils literal notranslate"><span class="pre">.pgpass</span></code></a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">localhost</span><span class="p">:</span><span class="mi">5432</span><span class="p">:</span><span class="n">aiidadb</span><span class="p">:</span><span class="n">aiida</span><span class="p">:</span><span class="n">YOUR_DATABASE_PASSWORD</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">YOUR_DATABASE_PASSWORD</span></code> is the password you set up for the database.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Do not forget to put this file in ~/ and to name it <code class="docutils literal notranslate"><span class="pre">.pgpass</span></code>.
Remember also to give it the right permissions (read and write): <code class="docutils literal notranslate"><span class="pre">chmod</span> <span class="pre">u=rw</span> <span class="pre">.pgpass</span></code>.</p>
</div>
<p>To dump the database in a file automatically everyday, you can add the following script
<a class="reference download internal" download="" href="../_downloads/a01ebf7237becec77fcfa484c414b6e7/backup-aiidadb-USERNAME"><code class="xref download docutils literal notranslate"><span class="pre">backup-aiidadb-USERNAME</span></code></a> in <code class="docutils literal notranslate"><span class="pre">/etc/cron.daily/</span></code>, which will
launch the previous script once per day:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="n">su</span> <span class="n">USERNAME</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;/home/USERNAME/.aiida/backup_postgresql.sh&quot;</span>
</pre></div>
</div>
<p>where all instances of <code class="docutils literal notranslate"><span class="pre">USERNAME</span></code> are replaced by your actual user name. The <code class="docutils literal notranslate"><span class="pre">su</span> <span class="pre">USERNAME</span></code>
makes the dumped file be owned by you rather than by <code class="docutils literal notranslate"><span class="pre">root</span></code>.
Remember to give the script the right permissions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">cron</span><span class="o">.</span><span class="n">daily</span><span class="o">/</span><span class="n">backup</span><span class="o">-</span><span class="n">aiidadb</span><span class="o">-</span><span class="n">USERNAME</span>
</pre></div>
</div>
<p>Finally make sure your database folder (<code class="docutils literal notranslate"><span class="pre">/home/USERNAME/.aiida/</span></code>) containing this dump file
and the <code class="docutils literal notranslate"><span class="pre">repository</span></code> directory, is properly backed up by
your backup software (under Ubuntu, Backup -&gt; check the âFoldersâ tab).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If your database is very large (more than a few hundreds of thousands
of nodes), a standard backup of your repository folder will be
very slow (up to days), thus slowing down your computer dramatically. To fix
this problem you can set up an incremental backup of your repository by following
the instructions <a class="reference internal" href="#repository-backup"><span class="std std-ref">here</span></a>.</p>
</div>
</div>
<div class="section" id="restore-database-backup">
<h1>Restore database backup<a class="headerlink" href="#restore-database-backup" title="Permalink to this headline">Â¶</a></h1>
<p>In order to retrieve the database from a backup, you have first to
create a empty database following the instructions described above in
âSetup instructions: PostgreSQLâ except the <code class="docutils literal notranslate"><span class="pre">verdi</span> <span class="pre">install</span></code>
phase. Once that you have created your empty database with the same
names of the backuped one, type the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">psql</span> <span class="o">-</span><span class="n">h</span> <span class="n">localhost</span> <span class="o">-</span><span class="n">U</span> <span class="n">aiida</span> <span class="o">-</span><span class="n">d</span> <span class="n">aiidadb</span> <span class="o">-</span><span class="n">f</span> <span class="n">aiidadb</span><span class="o">-</span><span class="n">backup</span><span class="o">.</span><span class="n">psql</span>
</pre></div>
</div>
</div>
<div class="section" id="move-database">
<span id="move-postgresql"></span><h1>Move database<a class="headerlink" href="#move-database" title="Permalink to this headline">Â¶</a></h1>
<p>It might happen that you need to move the physical location of the database
files on your hard-drive (for instance, due to the lack of space in the
partition where it is located). Below we explain how to do it.</p>
<p>First, make sure you have a backup of the full database (see instructions
<a class="reference internal" href="#backup-postgresql"><span class="std std-ref">here</span></a>), and that the AiiDA daemon is not running.
Then, become the UNIX <code class="docutils literal notranslate"><span class="pre">postgres</span></code> user, typing as root:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">su</span> <span class="o">-</span> <span class="n">postgres</span>
</pre></div>
</div>
<p>(or, equivalently, type <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">su</span> <span class="pre">-</span> <span class="pre">postgres</span></code>, depending on your distribution).</p>
<p>Then enter the postgres shell:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">psql</span>
</pre></div>
</div>
<p>and look for the current location of the data directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SHOW</span> <span class="n">data_directory</span><span class="p">;</span>
</pre></div>
</div>
<p>Typically you should get something like <code class="docutils literal notranslate"><span class="pre">/var/lib/postgresql/9.1/main</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In the above, <code class="docutils literal notranslate"><span class="pre">9.1</span></code> is replaced by the actual version number of your postgres distribution (the same applies to the remainder of the section).</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you are experiencing memory problems and cannot enter the postgres
shell, you can look directly into the file <code class="docutils literal notranslate"><span class="pre">/etc/postgresql/9.1/main/postgresql.conf</span></code>
and check out the line defining the variable <code class="docutils literal notranslate"><span class="pre">data_directory</span></code>.</p>
</div>
<p>Then exit the shell with <code class="docutils literal notranslate"><span class="pre">\q</span></code>, and stop the postgres database daemon:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="n">postgresql</span> <span class="n">stop</span>
</pre></div>
</div>
<p>Copy all the files and folders from the postgres data directory into the new directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">-</span><span class="n">a</span> <span class="n">SOURCE_DIRECTORY</span> <span class="n">DESTINATION_DIRECTORY</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">SOURCE_DIRECTORY</span></code> is the directory you got from the
<code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">data_directory;</span></code> command, and <code class="docutils literal notranslate"><span class="pre">DESTINATION_DIRECTORY</span></code> is the new
directory for the database files.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The behaviour of the <code class="docutils literal notranslate"><span class="pre">cp</span> <span class="pre">-a</span></code> command is to create a directory into <code class="docutils literal notranslate"><span class="pre">DESTINATION_DIRECTORY</span></code>, e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">-</span><span class="n">a</span> <span class="n">OLD_DIR</span><span class="o">/</span><span class="n">main</span><span class="o">/</span> <span class="n">NEW_DIR</span><span class="o">/</span>
</pre></div>
</div>
<p class="last">will create the directory <code class="docutils literal notranslate"><span class="pre">main</span></code> into <code class="docutils literal notranslate"><span class="pre">NEW_DIR</span></code>.</p>
</div>
<p>Make sure the permissions, owner and group are the same in the old and new directory
(including all levels above the <code class="docutils literal notranslate"><span class="pre">DESTINATION_DIRECTORY</span></code>). The owner and group
should be both <code class="docutils literal notranslate"><span class="pre">postgres</span></code>, at the notable exception of some symbolic links in
<code class="docutils literal notranslate"><span class="pre">server.crt</span></code> and <code class="docutils literal notranslate"><span class="pre">server.key</span></code> (these files might be absent, depending on your postgresql version number).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If the permissions of these links need to be changed, use the <code class="docutils literal notranslate"><span class="pre">-h</span></code>
option of <code class="docutils literal notranslate"><span class="pre">chown</span></code> to avoid changing the permissions of the destination of the
links. In case you have changed the permission of the links destination by
mistake, they should typically be (beware that this might depend on your
actual distribution!):</p>
<div class="last highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">989</span> <span class="n">Mar</span>  <span class="mi">1</span>  <span class="mi">2012</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">ssl</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">snakeoil</span><span class="o">.</span><span class="n">pem</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">-----</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">ssl</span><span class="o">-</span><span class="n">cert</span> <span class="mi">1704</span> <span class="n">Mar</span>  <span class="mi">1</span>  <span class="mi">2012</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">ssl</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">snakeoil</span><span class="o">.</span><span class="n">key</span>
</pre></div>
</div>
</div>
<p>Then you can change the postgres configuration file, that should typically
be located here:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postgresql</span><span class="o">/</span><span class="mf">9.1</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">postgresql</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>Make a backup version of this file, then look for the line defining
<code class="docutils literal notranslate"><span class="pre">data_directory</span></code> and replace it with the new data directory path:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data_directory</span> <span class="o">=</span> <span class="s1">&#39;NEW_DATA_DIRECTORY&#39;</span>
</pre></div>
</div>
<p>Then start again the database daemon:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="n">postgresql</span> <span class="n">start</span>
</pre></div>
</div>
<p>You can check that the data directory has indeed changed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">psql</span>
<span class="n">SHOW</span> <span class="n">data_directory</span><span class="p">;</span>
\<span class="n">q</span>
</pre></div>
</div>
<p>Before removing definitely the previous location of the database files,
first rename it and test AiiDA with the new database location (e.g. do simple
queries like <code class="docutils literal notranslate"><span class="pre">verdi</span> <span class="pre">code</span> <span class="pre">list</span></code> or create a node and store it). If
everything went fine, you can delete the old database location.</p>
</div>
<div class="section" id="setup-repository-backup">
<span id="repository-backup"></span><h1>Setup repository backup<a class="headerlink" href="#setup-repository-backup" title="Permalink to this headline">Â¶</a></h1>
<p>Apart from the database backup, you should also backup the AiiDA repository.
For small repositories, this can be easily done by a simple directory copy or,
even better, with the use of the rsync command which can copy only the differences.
However, both of the aforementioned approaches are not efficient in big
repositories where even a partial recursive directory listing may take
significant time, especially for filesystems where accessing a directory has
a constant (and significant) latency time. Therefore, we provide scripts for
making efficient backups of the AiiDA repository.</p>
<p>Before running the backup script, you will have to configure it. Therefore you
should execute the <code class="docutils literal notranslate"><span class="pre">backup_setup.py</span></code> which is located under
<code class="docutils literal notranslate"><span class="pre">MY_AIIDA_FOLDER/aiida/manage/backup</span></code>. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">verdi</span> <span class="o">-</span><span class="n">p</span> <span class="n">PROFILENAME</span> <span class="n">run</span> <span class="n">MY_AIIDA_FOLDER</span><span class="o">/</span><span class="n">aiida</span><span class="o">/</span><span class="n">manage</span><span class="o">/</span><span class="n">backup</span><span class="o">/</span><span class="n">backup_setup</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>where PROFILENAME is the name of the profile you want to use (if you donât specify the <code class="docutils literal notranslate"><span class="pre">-p</span></code> option, the default profile will be used). This will ask a set of questions. More precisely, it will initially ask for:</p>
<blockquote>
<div><ul class="simple">
<li>The backup folder. This is the destination of the backup <em>configuration file</em>.
By default a folder named <code class="docutils literal notranslate"><span class="pre">backup</span></code> in your <code class="docutils literal notranslate"><span class="pre">.aiida</span></code> directory is
proposed to be created.</li>
<li>The destination folder of the backup. This is the destination folder of the
files to be backed up. By default it is a folder inside the aforementioned
<code class="docutils literal notranslate"><span class="pre">backup</span></code> folder (e.g. <code class="docutils literal notranslate"><span class="pre">/home/aiida_user/.aiida/backup/backup_dest</span></code>).</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>You should backup the repository on a different disk than the one in
which you have the AiiDA repository! If you just use the same disk, you donât
have any security against the most common data loss cause: disk failure.
The best option is to use a destination folder mounted over ssh. For this
you need to install <code class="docutils literal notranslate"><span class="pre">sshfs</span></code> (under ubuntu: <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">sshfs</span></code>).</p>
<p>E.g. Imagine that you run your calculations on server_1 and you would like to
take regular repository backups to server_2. Then, you could mount a server_2
directory via sshfs on server_1 using the following command on server_1:</p>
<p><code class="docutils literal notranslate"><span class="pre">sshfs</span> <span class="pre">-o</span> <span class="pre">idmap=user</span> <span class="pre">-o</span> <span class="pre">rw</span> <span class="pre">backup_user&#64;server_2:/home/backup_user/backup_destination_dir/</span></code>
<code class="docutils literal notranslate"><span class="pre">/home/aiida_user/remote_backup_dir/</span></code></p>
<p class="last">You should put this line into the actions performed at start-up (under gnome you
can access them by typing <code class="docutils literal notranslate"><span class="pre">gnome-session-properties</span></code> in a terminal), so that the
remote directory is mounted automatically after a reboot.
Do <strong>not</strong> put it in your shellâs startup file (e.g. <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code>) -
otherwise each time you open a new terminal, your computer will complain that
the mount point is not emptyâ¦</p>
</div>
<p>A template backup configuration file (<code class="docutils literal notranslate"><span class="pre">backup_info.json.tmpl</span></code>) will be copied
in the backup folder. You can set the backup variables by yourself after renaming
the template file to <code class="docutils literal notranslate"><span class="pre">backup_info.json</span></code>, or you can answer the questions asked
by the script, and then <code class="docutils literal notranslate"><span class="pre">backup_info.json</span></code> will be created based on you answers.</p>
<p>The main script backs up the AiiDA repository that is referenced by the current
AiiDA database. The script will start from the <code class="docutils literal notranslate"><span class="pre">oldest_object_backedup</span></code> date
or the date of the oldest node object found and it will periodically
backup (in periods of <code class="docutils literal notranslate"><span class="pre">periodicity</span></code> days) until the ending date of the backup
specified by <code class="docutils literal notranslate"><span class="pre">end_date_of_backup</span></code> or <code class="docutils literal notranslate"><span class="pre">days_to_backup</span></code></p>
<p>The backup parameters to be set in the <code class="docutils literal notranslate"><span class="pre">backup_info.json</span></code> are:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">periodicity</span></code> (in days): The backup runs periodically for a number of days
defined in the periodicity variable. The purpose of this variable is to limit
the backup to run only on a few number of days and therefore to limit the
number of files that are backed up at every round. e.g. <code class="docutils literal notranslate"><span class="pre">&quot;periodicity&quot;:</span> <span class="pre">2</span></code>
Example: if you have files in the AiiDA repositories created in the past 30
days, and periodicity is 15, the first run will backup the files of the first
15 days; a second run of the script will backup the next 15 days, completing
the backup (if it is run within the same day). Further runs will only backup
newer files, if they are created.</li>
<li><code class="docutils literal notranslate"><span class="pre">oldest_object_backedup</span></code> (timestamp or null): This is the timestamp of the
oldest object that was backed up. If you are not aware of this value or if it
is the first time that you start a backup up for this repository, then set
this value to <code class="docutils literal notranslate"><span class="pre">null</span></code>. Then the script will search the creation date of the
oldest node object in the database and it will start
the backup from that date. E.g. <code class="docutils literal notranslate"><span class="pre">&quot;oldest_object_backedup&quot;:</span> <span class="pre">&quot;2015-07-20</span> <span class="pre">11:13:08.145804+02:00&quot;</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">end_date_of_backup</span></code>: If set, the backup script will backup files that
have a modification date until the value specified by this variable. If not set,
the ending of the backup will be set by the following variable
(<code class="docutils literal notranslate"><span class="pre">days_to_backup</span></code>) which specifies how many days to backup from the start
of the backup. If none of these variables are set (<code class="docutils literal notranslate"><span class="pre">end_date_of_backup</span></code>
and <code class="docutils literal notranslate"><span class="pre">days_to_backup</span></code>), then the end date of backup is set to the current date.
E.g. <code class="docutils literal notranslate"><span class="pre">&quot;end_date_of_backup&quot;:</span> <span class="pre">null</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;end_date_of_backup&quot;:</span> <span class="pre">&quot;2015-07-20</span> <span class="pre">11:13:08.145804+02:00&quot;</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">days_to_backup</span></code>: If set, you specify how many days you will backup from the starting date
of your backup. If it set to <code class="docutils literal notranslate"><span class="pre">null</span></code> and also
<code class="docutils literal notranslate"><span class="pre">end_date_of_backup</span></code> is set to <code class="docutils literal notranslate"><span class="pre">null</span></code>, then the end date of the backup is set
to the current date. You can not set <code class="docutils literal notranslate"><span class="pre">days_to_backup</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">end_date_of_backup</span></code>
at the same time (it will lead to an error). E.g. <code class="docutils literal notranslate"><span class="pre">&quot;days_to_backup&quot;:</span> <span class="pre">null</span></code>
or <code class="docutils literal notranslate"><span class="pre">&quot;days_to_backup&quot;:</span> <span class="pre">5</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">backup_length_threshold</span></code> (in hours): The backup script runs in rounds and
on every round it backs-up a number of days that are controlled primarily by
<code class="docutils literal notranslate"><span class="pre">periodicity</span></code> and also by <code class="docutils literal notranslate"><span class="pre">end_date_of_backup</span></code> / <code class="docutils literal notranslate"><span class="pre">days_to_backup</span></code>,
for the last backup round. The <code class="docutils literal notranslate"><span class="pre">backup_length_threshold</span></code> specifies the
lowest acceptable round length. This is important for the end of the backup.</li>
<li><code class="docutils literal notranslate"><span class="pre">backup_dir</span></code>: The destination directory of the backup. e.g.
<code class="docutils literal notranslate"><span class="pre">&quot;backup_dir&quot;:</span> <span class="pre">&quot;/home/aiida_user/.aiida/backup/backup_dest&quot;</span></code></li>
</ul>
</div></blockquote>
<p>To start the backup, run the <code class="docutils literal notranslate"><span class="pre">start_backup.py</span></code> script. Run as often as needed to complete a
full backup, and then run it periodically (e.g. calling it from a cron script, for instance every
day) to backup new changes.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>You can set up a cron job using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">crontab</span> <span class="o">-</span><span class="n">u</span> <span class="n">aiida_user</span> <span class="o">-</span><span class="n">e</span>
</pre></div>
</div>
<p>It will open an editor where you can add a line of the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">00</span> <span class="mi">03</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">aiida_user</span><span class="o">/.</span><span class="n">aiida</span><span class="o">/</span><span class="n">backup</span><span class="o">/</span><span class="n">start_backup</span><span class="o">.</span><span class="n">py</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="o">|</span> <span class="n">mail</span> <span class="o">-</span><span class="n">s</span> <span class="s2">&quot;Incremental backup of the repository&quot;</span> <span class="n">aiida_user_email</span><span class="nd">@domain</span><span class="o">.</span><span class="n">net</span>
</pre></div>
</div>
<p>or (if you need to backup a different profile than the default one):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">00</span> <span class="mi">03</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="n">verdi</span> <span class="o">-</span><span class="n">p</span> <span class="n">PROFILENAME</span> <span class="n">run</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">aiida_user</span><span class="o">/.</span><span class="n">aiida</span><span class="o">/</span><span class="n">backup</span><span class="o">/</span><span class="n">start_backup</span><span class="o">.</span><span class="n">py</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="o">|</span> <span class="n">mail</span> <span class="o">-</span><span class="n">s</span> <span class="s2">&quot;Incremental backup of the repository&quot;</span> <span class="n">aiida_user_email</span><span class="nd">@domain</span><span class="o">.</span><span class="n">net</span>
</pre></div>
</div>
<p class="last">This will launch the backup of the database every day at 3 AM, and send the output
(or any error message) to the email address of the user (provided the <code class="docutils literal notranslate"><span class="pre">mail</span></code>
command â from <code class="docutils literal notranslate"><span class="pre">mailutils</span></code> â is configured appropriately).</p>
</div>
<p>Finally, do not forget to exclude the repository folder from the normal backup
of your home directory!</p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../working_with_aiida/troubleshooting.html" class="btn btn-neutral float-right" title="Some tricks" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../working_with_aiida/resultmanager.html" class="btn btn-neutral float-left" title="Retrieving results" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>