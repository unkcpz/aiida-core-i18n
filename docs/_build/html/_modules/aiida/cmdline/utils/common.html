

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.cmdline.utils.common &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.cmdline.utils.common</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.cmdline.utils.common</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;Common utility functions for command line commands.&quot;&quot;&quot;</span>
<span class="c1"># pylint: disable=import-error</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="k">import</span> <span class="n">tabulate</span>


<div class="viewcode-block" id="get_env_with_venv_bin"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.utils.html#aiida.cmdline.utils.common.get_env_with_venv_bin">[docs]</a><span class="k">def</span> <span class="nf">get_env_with_venv_bin</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Create a clone of the current running environment with the AIIDA_PATH variable set directory of the config.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.manage.configuration</span> <span class="k">import</span> <span class="n">get_config</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>

    <span class="n">currenv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">currenv</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">currenv</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span>
    <span class="n">currenv</span><span class="p">[</span><span class="s1">&#39;AIIDA_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dirpath</span>
    <span class="n">currenv</span><span class="p">[</span><span class="s1">&#39;PYTHONUNBUFFERED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>

    <span class="k">return</span> <span class="n">currenv</span></div>


<div class="viewcode-block" id="format_local_time"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.utils.html#aiida.cmdline.utils.common.format_local_time">[docs]</a><span class="k">def</span> <span class="nf">format_local_time</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Format a datetime object or UNIX timestamp in a human readable format</span>

<span class="sd">    :param timestamp: a datetime object or a float representing a UNIX timestamp</span>
<span class="sd">    :param format_str: optional string format to pass to strftime</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">timezone</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">timezone</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">format_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">format_str</span><span class="p">)</span></div>


<div class="viewcode-block" id="print_last_process_state_change"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.utils.html#aiida.cmdline.utils.common.print_last_process_state_change">[docs]</a><span class="k">def</span> <span class="nf">print_last_process_state_change</span><span class="p">(</span><span class="n">process_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print the last time that a process of the specified type has changed its state.</span>
<span class="sd">    This function will also print a warning if the daemon is not running.</span>

<span class="sd">    :param process_type: optional process type for which to get the latest state change timestamp.</span>
<span class="sd">        Valid process types are either &#39;calculation&#39; or &#39;work&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.cmdline.utils.echo</span> <span class="k">import</span> <span class="n">echo_info</span><span class="p">,</span> <span class="n">echo_warning</span>
    <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">timezone</span>
    <span class="kn">from</span> <span class="nn">aiida.common.utils</span> <span class="k">import</span> <span class="n">str_timedelta</span>
    <span class="kn">from</span> <span class="nn">aiida.engine.daemon.client</span> <span class="k">import</span> <span class="n">get_daemon_client</span>
    <span class="kn">from</span> <span class="nn">aiida.engine.utils</span> <span class="k">import</span> <span class="n">get_process_state_change_timestamp</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">get_daemon_client</span><span class="p">()</span>

    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">get_process_state_change_timestamp</span><span class="p">(</span><span class="n">process_type</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">echo_info</span><span class="p">(</span><span class="s1">&#39;last time an entry changed state: never&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">timedelta</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">delta</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="n">formatted</span> <span class="o">=</span> <span class="n">format_local_time</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s1">&#39;at %H:%M:%S on %Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">relative</span> <span class="o">=</span> <span class="n">str_timedelta</span><span class="p">(</span><span class="n">timedelta</span><span class="p">,</span> <span class="n">negative_to_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_num_fields</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">echo_info</span><span class="p">(</span><span class="s1">&#39;last time an entry changed state: </span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">relative</span><span class="p">,</span> <span class="n">formatted</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">client</span><span class="o">.</span><span class="n">is_daemon_running</span><span class="p">:</span>
        <span class="n">echo_warning</span><span class="p">(</span><span class="s1">&#39;the daemon is not running&#39;</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_node_summary"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.utils.html#aiida.cmdline.utils.common.get_node_summary">[docs]</a><span class="k">def</span> <span class="nf">get_node_summary</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a multi line string with a pretty formatted summary of a Node</span>

<span class="sd">    :param node: a Node instance</span>
<span class="sd">    :return: a string summary of the node</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">plumpy</span> <span class="k">import</span> <span class="n">ProcessState</span>
    <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="k">import</span> <span class="n">ProcessNode</span>

    <span class="n">table_headers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Property&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">]</span>
    <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">])</span>
    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">pk</span><span class="p">)])</span>
    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)])</span>
    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">label</span><span class="p">])</span>
    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">description</span><span class="p">])</span>
    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;ctime&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">ctime</span><span class="p">])</span>
    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;mtime&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">mtime</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">process_state</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">process_state</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">process_state</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;process state&#39;</span><span class="p">,</span> <span class="n">ProcessState</span><span class="p">(</span><span class="n">process_state</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;process state&#39;</span><span class="p">,</span> <span class="n">process_state</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;exit status&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">exit_status</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;exit status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">computer</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">computer</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">computer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;computer&#39;</span><span class="p">,</span> <span class="s1">&#39;[</span><span class="si">{}</span><span class="s1">] </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">name</span><span class="p">)])</span>

    <span class="k">return</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">table_headers</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_node_info"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.utils.html#aiida.cmdline.utils.common.get_node_info">[docs]</a><span class="k">def</span> <span class="nf">get_node_info</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">include_summary</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a multi line string of information about the given node, such as the incoming and outcoming links.</span>

<span class="sd">    :param include_summary: boolean, if True, also include a summary of node properties</span>
<span class="sd">    :return: a string summary of the node including a description of all its links and log messages</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>
    <span class="kn">from</span> <span class="nn">aiida</span> <span class="k">import</span> <span class="n">orm</span>

    <span class="k">if</span> <span class="n">include_summary</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">get_node_summary</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="n">nodes_caller</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">(</span><span class="n">link_type</span><span class="o">=</span><span class="p">(</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_CALC</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="p">))</span>
    <span class="n">nodes_called</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_outgoing</span><span class="p">(</span><span class="n">link_type</span><span class="o">=</span><span class="p">(</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_CALC</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="p">))</span>
    <span class="n">nodes_input</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">(</span><span class="n">link_type</span><span class="o">=</span><span class="p">(</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_WORK</span><span class="p">))</span>
    <span class="n">nodes_output</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_outgoing</span><span class="p">(</span><span class="n">link_type</span><span class="o">=</span><span class="p">(</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">nodes_caller</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">format_nested_links</span><span class="p">(</span><span class="n">nodes_caller</span><span class="o">.</span><span class="n">nested</span><span class="p">(),</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Called by&#39;</span><span class="p">,</span> <span class="s1">&#39;PK&#39;</span><span class="p">,</span> <span class="s1">&#39;Type&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">nodes_input</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">format_nested_links</span><span class="p">(</span><span class="n">nodes_input</span><span class="o">.</span><span class="n">nested</span><span class="p">(),</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Inputs&#39;</span><span class="p">,</span> <span class="s1">&#39;PK&#39;</span><span class="p">,</span> <span class="s1">&#39;Type&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">nodes_output</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">format_nested_links</span><span class="p">(</span><span class="n">nodes_output</span><span class="o">.</span><span class="n">nested</span><span class="p">(),</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Outputs&#39;</span><span class="p">,</span> <span class="s1">&#39;PK&#39;</span><span class="p">,</span> <span class="s1">&#39;Type&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">nodes_called</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">format_nested_links</span><span class="p">(</span><span class="n">nodes_called</span><span class="o">.</span><span class="n">nested</span><span class="p">(),</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Called&#39;</span><span class="p">,</span> <span class="s1">&#39;PK&#39;</span><span class="p">,</span> <span class="s1">&#39;Type&#39;</span><span class="p">])</span>

    <span class="n">log_messages</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_logs_for</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">log_messages</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">table_headers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Log messages&#39;</span><span class="p">]</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;There are </span><span class="si">{}</span><span class="s1"> log messages for this calculation&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_messages</span><span class="p">))])</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;Run &#39;verdi process report </span><span class="si">{}</span><span class="s2">&#39; to see them&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">pk</span><span class="p">)])</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">table_headers</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="format_nested_links"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.utils.html#aiida.cmdline.utils.common.format_nested_links">[docs]</a><span class="k">def</span> <span class="nf">format_nested_links</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a nested dictionary of nodes, return a nested string representation.</span>

<span class="sd">    :param links: a nested dictionary of nodes</span>
<span class="sd">    :param headers: headers to use</span>
<span class="sd">    :return: nested formatted string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">collections</span>
    <span class="kn">import</span> <span class="nn">tabulate</span> <span class="k">as</span> <span class="nn">tb</span>

    <span class="n">tb</span><span class="o">.</span><span class="n">PRESERVE_WHITESPACE</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">indent_size</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="k">def</span> <span class="nf">format_recursive</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recursively format a dictionary of nodes into indented strings.&quot;&quot;&quot;</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">links</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">depth</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">])</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">format_recursive</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">depth</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">rows</span>

    <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">depth</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="n">format_recursive</span><span class="p">(</span><span class="n">links</span><span class="p">):</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{indent}{label}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">depth</span> <span class="o">*</span> <span class="n">indent_size</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">),</span> <span class="n">pk</span><span class="p">,</span> <span class="n">class_name</span><span class="p">])</span>

    <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">))</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">PRESERVE_WHITESPACE</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="get_calcjob_report"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.utils.html#aiida.cmdline.utils.common.get_calcjob_report">[docs]</a><span class="k">def</span> <span class="nf">get_calcjob_report</span><span class="p">(</span><span class="n">calcjob</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a multi line string representation of the log messages and output of a given calcjob</span>

<span class="sd">    :param calcjob: the calcjob node</span>
<span class="sd">    :return: a string representation of the log messages and scheduler output</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida</span> <span class="k">import</span> <span class="n">orm</span>
    <span class="kn">from</span> <span class="nn">aiida.common.datastructures</span> <span class="k">import</span> <span class="n">CalcJobState</span>

    <span class="n">log_messages</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_logs_for</span><span class="p">(</span><span class="n">calcjob</span><span class="p">)</span>
    <span class="n">scheduler_out</span> <span class="o">=</span> <span class="n">calcjob</span><span class="o">.</span><span class="n">get_scheduler_stdout</span><span class="p">()</span>
    <span class="n">scheduler_err</span> <span class="o">=</span> <span class="n">calcjob</span><span class="o">.</span><span class="n">get_scheduler_stderr</span><span class="p">()</span>
    <span class="n">calcjob_state</span> <span class="o">=</span> <span class="n">calcjob</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
    <span class="n">scheduler_state</span> <span class="o">=</span> <span class="n">calcjob</span><span class="o">.</span><span class="n">get_scheduler_state</span><span class="p">()</span>

    <span class="n">report</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">calcjob_state</span> <span class="o">==</span> <span class="n">CalcJobState</span><span class="o">.</span><span class="n">WITHSCHEDULER</span><span class="p">:</span>
        <span class="n">state_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, scheduler state: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">calcjob_state</span><span class="p">,</span>
                                                        <span class="n">scheduler_state</span> <span class="k">if</span> <span class="n">scheduler_state</span> <span class="k">else</span> <span class="s1">&#39;(unknown)&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">state_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">calcjob_state</span><span class="p">)</span>

    <span class="n">label_string</span> <span class="o">=</span> <span class="s1">&#39; [</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">calcjob</span><span class="o">.</span><span class="n">label</span><span class="p">)</span> <span class="k">if</span> <span class="n">calcjob</span><span class="o">.</span><span class="n">label</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

    <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;*** </span><span class="si">{}{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">calcjob</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">label_string</span><span class="p">,</span> <span class="n">state_string</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">scheduler_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;*** Scheduler output: N/A&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">scheduler_out</span><span class="p">:</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;*** Scheduler output:</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scheduler_out</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;*** (empty scheduler output file)&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">scheduler_err</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;*** Scheduler errors: N/A&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">scheduler_err</span><span class="p">:</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;*** Scheduler errors:</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scheduler_err</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;*** (empty scheduler errors file)&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">log_messages</span><span class="p">:</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;*** </span><span class="si">{}</span><span class="s1"> LOG MESSAGES:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_messages</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;*** 0 LOG MESSAGES&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">log_messages</span><span class="p">:</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;+-&gt; </span><span class="si">{}</span><span class="s1"> at </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">levelname</span><span class="p">,</span> <span class="n">log</span><span class="o">.</span><span class="n">time</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">log</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; | </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_process_function_report"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.utils.html#aiida.cmdline.utils.common.get_process_function_report">[docs]</a><span class="k">def</span> <span class="nf">get_process_function_report</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a multi line string representation of the log messages and output of a given process function node</span>

<span class="sd">    :param node: the node</span>
<span class="sd">    :return: a string representation of the log messages</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida</span> <span class="k">import</span> <span class="n">orm</span>

    <span class="n">report</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_logs_for</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;{time:%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S} [</span><span class="si">{id}</span><span class="s1">]: </span><span class="si">{msg}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">log</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">log</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">log</span><span class="o">.</span><span class="n">time</span><span class="p">))</span>

    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_workchain_report"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.utils.html#aiida.cmdline.utils.common.get_workchain_report">[docs]</a><span class="k">def</span> <span class="nf">get_workchain_report</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">levelname</span><span class="p">,</span> <span class="n">indent_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a multi line string representation of the log messages and output of a given workchain</span>

<span class="sd">    :param node: the workchain node</span>
<span class="sd">    :return: a nested string representation of the log messages</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=too-many-locals</span>
    <span class="kn">import</span> <span class="nn">itertools</span>
    <span class="kn">from</span> <span class="nn">aiida</span> <span class="k">import</span> <span class="n">orm</span>
    <span class="kn">from</span> <span class="nn">aiida.common.log</span> <span class="k">import</span> <span class="n">LOG_LEVELS</span>

    <span class="k">def</span> <span class="nf">get_report_messages</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">levelname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of log messages with given levelname and their depth for a node with a given uuid.&quot;&quot;&quot;</span>
        <span class="n">node_id</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span><span class="o">.</span><span class="n">id</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dbnode_id&#39;</span><span class="p">:</span> <span class="n">node_id</span><span class="p">}</span>

        <span class="n">entries</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span> <span class="k">if</span> <span class="n">LOG_LEVELS</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">levelname</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">LOG_LEVELS</span><span class="p">[</span><span class="n">levelname</span><span class="p">]]</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">_</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_subtree</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a nested tree of work calculation nodes and their nesting level starting from this uuid.</span>
<span class="sd">        The result is a list of uuid of these nodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">WorkChainNode</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;uuid&#39;</span><span class="p">:</span> <span class="n">uuid</span><span class="p">},</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;workcalculation&#39;</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">WorkChainNode</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">],</span>
            <span class="c1"># In the future, we should specify here the type of link</span>
            <span class="c1"># for now, CALL links are the only ones allowing calc-calc</span>
            <span class="c1"># (we here really want instead to follow CALL links)</span>
            <span class="n">with_incoming</span><span class="o">=</span><span class="s1">&#39;workcalculation&#39;</span><span class="p">,</span>
            <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;subworkchains&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">builder</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>

        <span class="c1"># This will return a single flat list of tuples, where the first element</span>
        <span class="c1"># corresponds to the WorkChain pk and the second element is an integer</span>
        <span class="c1"># that represents its level of nesting within the chain</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">level</span><span class="p">)]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">get_subtree</span><span class="p">(</span><span class="n">subuuid</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">subuuid</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]))</span>

    <span class="n">workchain_tree</span> <span class="o">=</span> <span class="n">get_subtree</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">max_depth</span><span class="p">:</span>
        <span class="n">report_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">get_report_messages</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">levelname</span><span class="p">)</span> <span class="k">for</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">depth</span> <span class="ow">in</span> <span class="n">workchain_tree</span> <span class="k">if</span> <span class="n">depth</span> <span class="o">&lt;</span> <span class="n">max_depth</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">report_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_report_messages</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">levelname</span><span class="p">)</span> <span class="k">for</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">depth</span> <span class="ow">in</span> <span class="n">workchain_tree</span><span class="p">]</span>

    <span class="n">reports</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">report_list</span><span class="p">))</span>
    <span class="n">reports</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">reports</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;No log messages recorded for this entry&#39;</span>

    <span class="n">log_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">reports</span><span class="p">]</span>
    <span class="n">levelnames</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levelname</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">reports</span><span class="p">]</span>
    <span class="n">width_id</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">log_ids</span><span class="p">)))</span>
    <span class="n">width_levelname</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">levelnames</span><span class="p">)</span>
    <span class="n">report</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">entry</span><span class="p">,</span> <span class="n">depth</span> <span class="ow">in</span> <span class="n">reports</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;{time:%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S} [{id:&lt;</span><span class="si">{width_id}</span><span class="s1">} | {levelname:&gt;</span><span class="si">{width_levelname}</span><span class="s1">}]:</span><span class="si">{indent}</span><span class="s1"> </span><span class="si">{message}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">entry</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">levelname</span><span class="o">=</span><span class="n">entry</span><span class="o">.</span><span class="n">levelname</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">entry</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
            <span class="n">time</span><span class="o">=</span><span class="n">entry</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
            <span class="n">width_id</span><span class="o">=</span><span class="n">width_id</span><span class="p">,</span>
            <span class="n">width_levelname</span><span class="o">=</span><span class="n">width_levelname</span><span class="p">,</span>
            <span class="n">indent</span><span class="o">=</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">depth</span> <span class="o">*</span> <span class="n">indent_size</span><span class="p">))</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report</span><span class="p">)</span></div>


<div class="viewcode-block" id="print_process_spec"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.utils.html#aiida.cmdline.utils.common.print_process_spec">[docs]</a><span class="k">def</span> <span class="nf">print_process_spec</span><span class="p">(</span><span class="n">process_spec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print the process spec in a human-readable formatted way.</span>

<span class="sd">    :param process_spec: a `ProcessSpec` instance</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">build_entries</span><span class="p">(</span><span class="n">ports</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build a list of entries to be printed for a `PortNamespace.</span>

<span class="sd">        :param ports: the port namespace</span>
<span class="sd">        :return: list of tuples with port name, required, valid types and info strings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">port</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ports</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">required</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>

            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">valid_types</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">valid_type</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">valid_type</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="k">else</span> <span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">valid_type</span><span class="p">,)</span>
            <span class="n">valid_types</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">valid_type</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">valid_type</span> <span class="ow">in</span> <span class="n">valid_types</span> <span class="k">if</span> <span class="n">valid_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
            <span class="n">required</span> <span class="o">=</span> <span class="s1">&#39;required&#39;</span> <span class="k">if</span> <span class="n">port</span><span class="o">.</span><span class="n">required</span> <span class="k">else</span> <span class="s1">&#39;optional&#39;</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">help</span> <span class="k">if</span> <span class="n">port</span><span class="o">.</span><span class="n">help</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">[:</span><span class="mi">75</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; ...&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">75</span> <span class="k">else</span> <span class="n">info</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">required</span><span class="p">,</span> <span class="n">valid_types</span><span class="p">,</span> <span class="n">info</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;{:&gt;</span><span class="si">{width_name}</span><span class="s1">s}:  </span><span class="si">{:10s}</span><span class="s1">{:</span><span class="si">{width_type}</span><span class="s1">}</span><span class="si">{}</span><span class="s1">&#39;</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">build_entries</span><span class="p">(</span><span class="n">process_spec</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">build_entries</span><span class="p">(</span><span class="n">process_spec</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span>
    <span class="n">max_width_name</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="o">+</span> <span class="n">outputs</span><span class="p">])</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">max_width_type</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="o">+</span> <span class="n">outputs</span><span class="p">])</span> <span class="o">+</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">process_spec</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
        <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s1">&#39;Inputs&#39;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;required&#39;</span><span class="p">:</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="n">width_name</span><span class="o">=</span><span class="n">max_width_name</span><span class="p">,</span> <span class="n">width_type</span><span class="o">=</span><span class="n">max_width_type</span><span class="p">),</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="n">width_name</span><span class="o">=</span><span class="n">max_width_name</span><span class="p">,</span> <span class="n">width_type</span><span class="o">=</span><span class="n">max_width_type</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">process_spec</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
        <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s1">&#39;Outputs&#39;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;required&#39;</span><span class="p">:</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="n">width_name</span><span class="o">=</span><span class="n">max_width_name</span><span class="p">,</span> <span class="n">width_type</span><span class="o">=</span><span class="n">max_width_type</span><span class="p">),</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="n">width_name</span><span class="o">=</span><span class="n">max_width_name</span><span class="p">,</span> <span class="n">width_type</span><span class="o">=</span><span class="n">max_width_type</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">process_spec</span><span class="o">.</span><span class="n">exit_codes</span><span class="p">:</span>
        <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s1">&#39;Exit codes&#39;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">exit_code</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">process_spec</span><span class="o">.</span><span class="n">exit_codes</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">exit_code</span><span class="p">:</span> <span class="n">exit_code</span><span class="o">.</span><span class="n">status</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">exit_code</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
        <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s1">&#39;{:&gt;</span><span class="si">{width_name}</span><span class="s1">d}:  </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exit_code</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">width_name</span><span class="o">=</span><span class="n">max_width_name</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_num_workers"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.utils.html#aiida.cmdline.utils.common.get_num_workers">[docs]</a><span class="k">def</span> <span class="nf">get_num_workers</span><span class="p">():</span>  <span class="c1">#pylint: disable=inconsistent-return-statements</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the number of active daemon workers from the circus client</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">CircusCallError</span>
    <span class="kn">from</span> <span class="nn">aiida.manage.manager</span> <span class="k">import</span> <span class="n">get_manager</span>

    <span class="n">manager</span> <span class="o">=</span> <span class="n">get_manager</span><span class="p">()</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_daemon_client</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">client</span><span class="o">.</span><span class="n">is_daemon_running</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_numprocesses</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;ok&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">client</span><span class="o">.</span><span class="n">DAEMON_ERROR_TIMEOUT</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CircusCallError</span><span class="p">(</span><span class="s1">&#39;verdi thought the daemon was alive, but the call to the daemon timed-out&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">client</span><span class="o">.</span><span class="n">DAEMON_ERROR_NOT_RUNNING</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CircusCallError</span><span class="p">(</span><span class="s1">&#39;verdi thought the daemon was running, but really it is not&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CircusCallError</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;numprocesses&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CircusCallError</span><span class="p">(</span><span class="s1">&#39;Circus did not return the number of daemon processes&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_worker_load"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.utils.html#aiida.cmdline.utils.common.check_worker_load">[docs]</a><span class="k">def</span> <span class="nf">check_worker_load</span><span class="p">(</span><span class="n">active_slots</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the percentage usage of the daemon worker slots exceeds a threshold.</span>
<span class="sd">    If it does, print a warning.</span>

<span class="sd">    The purpose of this check is to warn the user if they are close to running out of worker slots</span>
<span class="sd">    which could lead to their processes becoming stuck indefinitely.</span>

<span class="sd">    :param active_slots: the number of currently active worker slots</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">CircusCallError</span>
    <span class="kn">from</span> <span class="nn">aiida.cmdline.utils</span> <span class="k">import</span> <span class="n">echo</span>
    <span class="kn">from</span> <span class="nn">aiida.manage.external.rmq</span> <span class="k">import</span> <span class="n">_RMQ_TASK_PREFETCH_COUNT</span>

    <span class="n">warning_threshold</span> <span class="o">=</span> <span class="mf">0.9</span>  <span class="c1"># 90%</span>

    <span class="n">slots_per_worker</span> <span class="o">=</span> <span class="n">_RMQ_TASK_PREFETCH_COUNT</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">active_workers</span> <span class="o">=</span> <span class="n">get_num_workers</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">CircusCallError</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s2">&quot;Could not contact Circus to get the number of active workers&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">active_workers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">available_slots</span> <span class="o">=</span> <span class="n">active_workers</span> <span class="o">*</span> <span class="n">slots_per_worker</span>
        <span class="n">percent_load</span> <span class="o">=</span> <span class="p">(</span><span class="n">active_slots</span> <span class="o">/</span> <span class="n">available_slots</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">percent_load</span> <span class="o">&gt;</span> <span class="n">warning_threshold</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># New line</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.0f}% o</span><span class="s2">f the available daemon worker slots have been used!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percent_load</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_warning</span><span class="p">(</span><span class="s2">&quot;Increase the number of workers with &#39;verdi daemon incr&#39;.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>