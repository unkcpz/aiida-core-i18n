

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.cmdline.commands.cmd_computer &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.cmdline.commands.cmd_computer</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.cmdline.commands.cmd_computer</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="c1"># pylint: disable=invalid-name,too-many-statements,too-many-branches</span>
<span class="sd">&quot;&quot;&quot;`verdi computer` command.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="nb">zip</span>

<span class="kn">import</span> <span class="nn">click</span>

<span class="kn">from</span> <span class="nn">aiida.cmdline.commands.cmd_verdi</span> <span class="k">import</span> <span class="n">verdi</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.params</span> <span class="k">import</span> <span class="n">options</span><span class="p">,</span> <span class="n">arguments</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.params.options.commands</span> <span class="k">import</span> <span class="n">computer</span> <span class="k">as</span> <span class="n">options_computer</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.utils</span> <span class="k">import</span> <span class="n">echo</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.utils.decorators</span> <span class="k">import</span> <span class="n">with_dbenv</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.utils.multi_line_input</span> <span class="k">import</span> <span class="n">ensure_scripts</span>
<span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="n">InputValidationError</span>
<span class="kn">from</span> <span class="nn">aiida.plugins.entry_point</span> <span class="k">import</span> <span class="n">get_entry_points</span>
<span class="kn">from</span> <span class="nn">aiida.transports</span> <span class="k">import</span> <span class="n">cli</span> <span class="k">as</span> <span class="n">transport_cli</span>


<span class="nd">@verdi</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;computer&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">verdi_computer</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Setup and manage computers.&quot;&quot;&quot;</span>


<div class="viewcode-block" id="get_computer_names"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.commands.html#aiida.cmdline.commands.cmd_computer.get_computer_names">[docs]</a><span class="k">def</span> <span class="nf">get_computer_names</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the list of computers in the DB.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.orm.querybuilder</span> <span class="k">import</span> <span class="n">QueryBuilder</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity_type</span><span class="o">=</span><span class="s1">&#39;computer&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>  <span class="c1"># return the first entry</span>

    <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="prompt_for_computer_configuration"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.commands.html#aiida.cmdline.commands.cmd_computer.prompt_for_computer_configuration">[docs]</a><span class="k">def</span> <span class="nf">prompt_for_computer_configuration</span><span class="p">(</span><span class="n">computer</span><span class="p">):</span>  <span class="c1"># pylint: disable=unused-argument</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="_computer_test_get_jobs"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.commands.html#aiida.cmdline.commands.cmd_computer._computer_test_get_jobs">[docs]</a><span class="k">def</span> <span class="nf">_computer_test_get_jobs</span><span class="p">(</span><span class="n">transport</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">authinfo</span><span class="p">):</span>  <span class="c1"># pylint: disable=unused-argument</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Internal test to check if it is possible to check the queue state.</span>

<span class="sd">    :param transport: an open transport</span>
<span class="sd">    :param scheduler: the corresponding scheduler class</span>
<span class="sd">    :param authinfo: the AuthInfo object (from which one can get computer and aiidauser)</span>
<span class="sd">    :return: True if the test succeeds, False if it fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;&gt; Getting job list...&quot;</span><span class="p">)</span>
    <span class="n">found_jobs</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">get_jobs</span><span class="p">(</span><span class="n">as_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;  `-&gt; OK, </span><span class="si">{}</span><span class="s2"> jobs found in the queue.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">found_jobs</span><span class="p">)))</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="_computer_test_no_unexpected_output"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.commands.html#aiida.cmdline.commands.cmd_computer._computer_test_no_unexpected_output">[docs]</a><span class="k">def</span> <span class="nf">_computer_test_no_unexpected_output</span><span class="p">(</span><span class="n">transport</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">authinfo</span><span class="p">):</span>  <span class="c1"># pylint: disable=unused-argument</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that there is no unexpected output from the connection.</span>

<span class="sd">    This can happen if e.g. there is some spurious command in the</span>
<span class="sd">    .bashrc or .bash_profile that is not guarded in case of non-interactive</span>
<span class="sd">    shells.</span>

<span class="sd">    :param transport: an open transport</span>
<span class="sd">    :param scheduler: the corresponding scheduler class</span>
<span class="sd">    :param authinfo: the AuthInfo object (from which one can get computer and aiidauser)</span>
<span class="sd">    :return: True if the test succeeds, False if it fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Execute a command that should not return any error</span>
    <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;&gt; Checking that no spurious output is present...&quot;</span><span class="p">)</span>
    <span class="n">retval</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">transport</span><span class="o">.</span><span class="n">exec_command_wait</span><span class="p">(</span><span class="s1">&#39;echo -n&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span><span class="s2">&quot;* ERROR! The command &#39;echo -n&#39; returned a non-zero return code (</span><span class="si">{}</span><span class="s2">)!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">retval</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">stdout</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;&quot;&quot;* ERROR! There is some spurious output in the standard output,</span>
<span class="s2">that we report below between the === signs:</span>
<span class="s2">=========================================================</span>
<span class="si">{}</span><span class="s2"></span>
<span class="s2">=========================================================</span>
<span class="s2">Please check that you don&#39;t have code producing output in</span>
<span class="s2">your ~/.bash_profile (or ~/.bashrc). If you don&#39;t want to</span>
<span class="s2">remove the code, but just to disable it for non-interactive</span>
<span class="s2">shells, see comments in issue #1980 on GitHub:</span>
<span class="s2">https://github.com/aiidateam/aiida_core/issues/1890</span>
<span class="s2">(and in the AiiDA documentation, linked from that issue)</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stdout</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">stderr</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;&quot;&quot;* ERROR! There is some spurious output in the stderr,</span>
<span class="s2">that we report below between the === signs:</span>
<span class="s2">=========================================================</span>
<span class="si">{}</span><span class="s2"></span>
<span class="s2">=========================================================</span>
<span class="s2">Please check that you don&#39;t have code producing output in</span>
<span class="s2">your ~/.bash_profile (or ~/.bashrc). If you don&#39;t want to</span>
<span class="s2">remove the code, but just to disable it for non-interactive</span>
<span class="s2">shells, see comments in issue #1980 on GitHub:</span>
<span class="s2">https://github.com/aiidateam/aiida_core/issues/1890</span>
<span class="s2">(and in the AiiDA documentation, linked from that issue)</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stderr</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;      [OK]&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="_computer_create_temp_file"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.commands.html#aiida.cmdline.commands.cmd_computer._computer_create_temp_file">[docs]</a><span class="k">def</span> <span class="nf">_computer_create_temp_file</span><span class="p">(</span><span class="n">transport</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">authinfo</span><span class="p">):</span>  <span class="c1"># pylint: disable=unused-argument</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Internal test to check if it is possible to create a temporary file</span>
<span class="sd">    and then delete it in the work directory</span>

<span class="sd">    :note: exceptions could be raised</span>

<span class="sd">    :param transport: an open transport</span>
<span class="sd">    :param scheduler: the corresponding scheduler class</span>
<span class="sd">    :param authinfo: the AuthInfo object (from which one can get computer and aiidauser)</span>
<span class="sd">    :return: True if the test succeeds, False if it fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">tempfile</span>
    <span class="kn">import</span> <span class="nn">datetime</span>
    <span class="kn">import</span> <span class="nn">os</span>

    <span class="n">file_content</span> <span class="o">=</span> <span class="s2">&quot;Test from &#39;verdi computer test&#39; on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>
    <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;&gt; Creating a temporary file in the work directory...&quot;</span><span class="p">)</span>
    <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;  `-&gt; Getting the remote user name...&quot;</span><span class="p">)</span>
    <span class="n">remote_user</span> <span class="o">=</span> <span class="n">transport</span><span class="o">.</span><span class="n">whoami</span><span class="p">()</span>
    <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;      [remote username: </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">remote_user</span><span class="p">))</span>
    <span class="n">workdir</span> <span class="o">=</span> <span class="n">authinfo</span><span class="o">.</span><span class="n">get_workdir</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">remote_user</span><span class="p">)</span>
    <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;      [Checking/creating work directory: </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">workdir</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">transport</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">transport</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
        <span class="n">transport</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tempf</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">tempf</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;  `-&gt; Creating the file </span><span class="si">{}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
        <span class="n">remote_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">tempf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
        <span class="n">tempf</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">transport</span><span class="o">.</span><span class="n">putfile</span><span class="p">(</span><span class="n">tempf</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">remote_file_path</span><span class="p">)</span>
    <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;  `-&gt; Checking if the file has been created...&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">transport</span><span class="o">.</span><span class="n">path_exists</span><span class="p">(</span><span class="n">remote_file_path</span><span class="p">):</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span><span class="s2">&quot;* ERROR! The file was not found!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;      [OK]&quot;</span><span class="p">)</span>
    <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;  `-&gt; Retrieving the file and checking its content...&quot;</span><span class="p">)</span>

    <span class="n">handle</span><span class="p">,</span> <span class="n">destfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">transport</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">remote_file_path</span><span class="p">,</span> <span class="n">destfile</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">destfile</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dfile</span><span class="p">:</span>
            <span class="n">read_string</span> <span class="o">=</span> <span class="n">dfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;      [Retrieved]&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">read_string</span> <span class="o">!=</span> <span class="n">file_content</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span><span class="s2">&quot;* ERROR! The file content is different from what was expected!&quot;</span><span class="p">)</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;** Expected:&quot;</span><span class="p">)</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;** Found:&quot;</span><span class="p">)</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">read_string</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;      [Content OK]&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">destfile</span><span class="p">)</span>

    <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;  `-&gt; Removing the file...&quot;</span><span class="p">)</span>
    <span class="n">transport</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">remote_file_path</span><span class="p">)</span>
    <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;  [Deleted successfully]&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="get_parameter_default"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.commands.html#aiida.cmdline.commands.cmd_computer.get_parameter_default">[docs]</a><span class="k">def</span> <span class="nf">get_parameter_default</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the value for a specific parameter from the computer_builder or the default value of that option</span>

<span class="sd">    :param parameter: parameter name</span>
<span class="sd">    :param ctx: click context of the command</span>
<span class="sd">    :return: parameter default value, or None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">ctx</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">get_params</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">parameter</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">computer_builder</span><span class="p">,</span> <span class="n">parameter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">default</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">default</span>

    <span class="k">return</span> <span class="n">value</span></div>


<span class="c1"># pylint: disable=unused-argument</span>
<div class="viewcode-block" id="set_computer_builder"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.commands.html#aiida.cmdline.commands.cmd_computer.set_computer_builder">[docs]</a><span class="k">def</span> <span class="nf">set_computer_builder</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the computer spec for defaults of following options.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.orm.utils.builders.computer</span> <span class="k">import</span> <span class="n">ComputerBuilder</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">computer_builder</span> <span class="o">=</span> <span class="n">ComputerBuilder</span><span class="o">.</span><span class="n">from_computer</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span></div>


<span class="nd">@verdi_computer</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;setup&#39;</span><span class="p">)</span>
<span class="nd">@options_computer</span><span class="o">.</span><span class="n">LABEL</span><span class="p">()</span>
<span class="nd">@options_computer</span><span class="o">.</span><span class="n">HOSTNAME</span><span class="p">()</span>
<span class="nd">@options_computer</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">()</span>
<span class="nd">@options_computer</span><span class="o">.</span><span class="n">TRANSPORT</span><span class="p">()</span>
<span class="nd">@options_computer</span><span class="o">.</span><span class="n">SCHEDULER</span><span class="p">()</span>
<span class="nd">@options_computer</span><span class="o">.</span><span class="n">SHEBANG</span><span class="p">()</span>
<span class="nd">@options_computer</span><span class="o">.</span><span class="n">WORKDIR</span><span class="p">()</span>
<span class="nd">@options_computer</span><span class="o">.</span><span class="n">MPI_RUN_COMMAND</span><span class="p">()</span>
<span class="nd">@options_computer</span><span class="o">.</span><span class="n">MPI_PROCS_PER_MACHINE</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">PREPEND_TEXT</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">APPEND_TEXT</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">NON_INTERACTIVE</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">CONFIG_FILE</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">pass_context</span>
<span class="nd">@with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">computer_setup</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">non_interactive</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add a computer.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.orm.utils.builders.computer</span> <span class="k">import</span> <span class="n">ComputerBuilder</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">get_computer_names</span><span class="p">():</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s1">&#39;A computer called </span><span class="si">{c}</span><span class="s1"> already exists. &#39;</span>
                           <span class="s1">&#39;Use &quot;verdi computer duplicate </span><span class="si">{c}</span><span class="s1">&quot; to set up a new &#39;</span>
                           <span class="s1">&#39;computer starting from the settings of </span><span class="si">{c}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">non_interactive</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pre</span><span class="p">,</span> <span class="n">post</span> <span class="o">=</span> <span class="n">ensure_scripts</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;prepend_text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;append_text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InputValidationError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">BadParameter</span><span class="p">(</span><span class="s1">&#39;invalid prepend and or append text: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;prepend_text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pre</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;append_text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">post</span>

    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;transport&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;transport&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;scheduler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;scheduler&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>

    <span class="n">computer_builder</span> <span class="o">=</span> <span class="n">ComputerBuilder</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">computer</span> <span class="o">=</span> <span class="n">computer_builder</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">ComputerBuilder</span><span class="o">.</span><span class="n">ComputerValidationError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">computer</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s1">&#39;unable to store the computer: </span><span class="si">{}</span><span class="s1">. Exiting...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_success</span><span class="p">(</span><span class="s1">&#39;Computer&lt;</span><span class="si">{}</span><span class="s1">&gt; </span><span class="si">{}</span><span class="s1"> created&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">computer</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">computer</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="n">echo</span><span class="o">.</span><span class="n">echo_info</span><span class="p">(</span><span class="s1">&#39;Note: before the computer can be used, it has to be configured with the command:&#39;</span><span class="p">)</span>
    <span class="n">echo</span><span class="o">.</span><span class="n">echo_info</span><span class="p">(</span><span class="s1">&#39;  verdi computer configure </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">computer</span><span class="o">.</span><span class="n">get_transport_type</span><span class="p">(),</span> <span class="n">computer</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>


<span class="nd">@verdi_computer</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;duplicate&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">COMPUTER</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="n">set_computer_builder</span><span class="p">)</span>
<span class="nd">@options_computer</span><span class="o">.</span><span class="n">LABEL</span><span class="p">(</span><span class="n">contextual_default</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">get_parameter_default</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">))</span>
<span class="nd">@options_computer</span><span class="o">.</span><span class="n">HOSTNAME</span><span class="p">(</span><span class="n">contextual_default</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">get_parameter_default</span><span class="p">,</span> <span class="s1">&#39;hostname&#39;</span><span class="p">))</span>
<span class="nd">@options_computer</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">(</span><span class="n">contextual_default</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">get_parameter_default</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">))</span>
<span class="nd">@options_computer</span><span class="o">.</span><span class="n">TRANSPORT</span><span class="p">(</span><span class="n">contextual_default</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">get_parameter_default</span><span class="p">,</span> <span class="s1">&#39;transport&#39;</span><span class="p">))</span>
<span class="nd">@options_computer</span><span class="o">.</span><span class="n">SCHEDULER</span><span class="p">(</span><span class="n">contextual_default</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">get_parameter_default</span><span class="p">,</span> <span class="s1">&#39;scheduler&#39;</span><span class="p">))</span>
<span class="nd">@options_computer</span><span class="o">.</span><span class="n">SHEBANG</span><span class="p">(</span><span class="n">contextual_default</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">get_parameter_default</span><span class="p">,</span> <span class="s1">&#39;shebang&#39;</span><span class="p">))</span>
<span class="nd">@options_computer</span><span class="o">.</span><span class="n">WORKDIR</span><span class="p">(</span><span class="n">contextual_default</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">get_parameter_default</span><span class="p">,</span> <span class="s1">&#39;work_dir&#39;</span><span class="p">))</span>
<span class="nd">@options_computer</span><span class="o">.</span><span class="n">MPI_RUN_COMMAND</span><span class="p">(</span><span class="n">contextual_default</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">get_parameter_default</span><span class="p">,</span> <span class="s1">&#39;mpirun_command&#39;</span><span class="p">))</span>
<span class="nd">@options_computer</span><span class="o">.</span><span class="n">MPI_PROCS_PER_MACHINE</span><span class="p">(</span><span class="n">contextual_default</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">get_parameter_default</span><span class="p">,</span> <span class="s1">&#39;mpiprocs_per_machine&#39;</span><span class="p">))</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">PREPEND_TEXT</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">APPEND_TEXT</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">NON_INTERACTIVE</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">pass_context</span>
<span class="nd">@with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">computer_duplicate</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">computer</span><span class="p">,</span> <span class="n">non_interactive</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Duplicate a computer.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida</span> <span class="k">import</span> <span class="n">orm</span>
    <span class="kn">from</span> <span class="nn">aiida.orm.utils.builders.computer</span> <span class="k">import</span> <span class="n">ComputerBuilder</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">get_computer_names</span><span class="p">():</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s1">&#39;A computer called </span><span class="si">{}</span><span class="s1"> already exists&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">non_interactive</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pre</span><span class="p">,</span> <span class="n">post</span> <span class="o">=</span> <span class="n">ensure_scripts</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;prepend_text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;append_text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InputValidationError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">click</span><span class="o">.</span><span class="n">BadParameter</span><span class="p">(</span><span class="s1">&#39;invalid prepend and or append text: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;prepend_text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pre</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;append_text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">post</span>

    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;transport&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;transport&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;scheduler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;scheduler&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>

    <span class="n">computer_builder</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">computer_builder</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">computer_builder</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">computer</span> <span class="o">=</span> <span class="n">computer_builder</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">ComputerBuilder</span><span class="o">.</span><span class="n">ComputerValidationError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_success</span><span class="p">(</span><span class="s1">&#39;stored computer </span><span class="si">{}</span><span class="s1">&lt;</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">computer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">computer</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">computer</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s1">&#39;unable to store the computer: </span><span class="si">{}</span><span class="s1">. Exiting...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_success</span><span class="p">(</span><span class="s1">&#39;Computer&lt;</span><span class="si">{}</span><span class="s1">&gt; </span><span class="si">{}</span><span class="s1"> created&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">computer</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">computer</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="n">is_configured</span> <span class="o">=</span> <span class="n">computer</span><span class="o">.</span><span class="n">is_user_configured</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_default</span><span class="p">())</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_configured</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_info</span><span class="p">(</span><span class="s1">&#39;Note: before the computer can be used, it has to be configured with the command:&#39;</span><span class="p">)</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_info</span><span class="p">(</span><span class="s1">&#39;  verdi computer configure </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">computer</span><span class="o">.</span><span class="n">get_transport_type</span><span class="p">(),</span> <span class="n">computer</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>


<span class="nd">@verdi_computer</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;enable&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">COMPUTER</span><span class="p">()</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">USER</span><span class="p">()</span>
<span class="nd">@with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">computer_enable</span><span class="p">(</span><span class="n">computer</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Enable the computer for the given user.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">NotExistent</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">authinfo</span> <span class="o">=</span> <span class="n">computer</span><span class="o">.</span><span class="n">get_authinfo</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">NotExistent</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s2">&quot;User with email &#39;</span><span class="si">{}</span><span class="s2">&#39; is not configured for computer &#39;</span><span class="si">{}</span><span class="s2">&#39; yet.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">computer</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">authinfo</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
        <span class="n">authinfo</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_info</span><span class="p">(</span><span class="s2">&quot;Computer &#39;</span><span class="si">{}</span><span class="s2">&#39; enabled for user </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">computer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">()))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_info</span><span class="p">(</span><span class="s2">&quot;Computer &#39;</span><span class="si">{}</span><span class="s2">&#39; was already enabled for user </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">computer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
                                                                                  <span class="n">user</span><span class="o">.</span><span class="n">last_name</span><span class="p">))</span>


<span class="nd">@verdi_computer</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;disable&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">COMPUTER</span><span class="p">()</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">USER</span><span class="p">()</span>
<span class="nd">@with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">computer_disable</span><span class="p">(</span><span class="n">computer</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Disable the computer for the given user.</span>

<span class="sd">    Thi can be useful, for example, when a computer is under maintenance.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">NotExistent</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">authinfo</span> <span class="o">=</span> <span class="n">computer</span><span class="o">.</span><span class="n">get_authinfo</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">NotExistent</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s2">&quot;User with email &#39;</span><span class="si">{}</span><span class="s2">&#39; is not configured for computer &#39;</span><span class="si">{}</span><span class="s2">&#39; yet.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">computer</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">authinfo</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
        <span class="n">authinfo</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_info</span><span class="p">(</span><span class="s2">&quot;Computer &#39;</span><span class="si">{}</span><span class="s2">&#39; disabled for user </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">computer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">()))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_info</span><span class="p">(</span><span class="s2">&quot;Computer &#39;</span><span class="si">{}</span><span class="s2">&#39; was already disabled for user </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">computer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
                                                                                   <span class="n">user</span><span class="o">.</span><span class="n">last_name</span><span class="p">))</span>


<span class="nd">@verdi_computer</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">ALL</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Show also disabled or unconfigured computers.&#39;</span><span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">RAW</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Show only the computer names, one per line.&#39;</span><span class="p">)</span>
<span class="nd">@with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">computer_list</span><span class="p">(</span><span class="n">all_entries</span><span class="p">,</span> <span class="n">raw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;List available computers.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="k">import</span> <span class="n">Computer</span><span class="p">,</span> <span class="n">User</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">raw</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_info</span><span class="p">(</span><span class="s1">&#39;List of configured computers&#39;</span><span class="p">)</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_info</span><span class="p">(</span><span class="s2">&quot;Use &#39;verdi computer show COMPUTERNAME&#39; to display more detailed information&quot;</span><span class="p">)</span>

    <span class="n">computers</span> <span class="o">=</span> <span class="n">Computer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_default</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">computers</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_info</span><span class="p">(</span><span class="s2">&quot;No computers configured yet. Use &#39;verdi computer setup&#39;&quot;</span><span class="p">)</span>

    <span class="n">sort</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">computer</span><span class="p">:</span> <span class="n">computer</span><span class="o">.</span><span class="n">name</span>
    <span class="n">highlight</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">comp</span><span class="p">:</span> <span class="n">comp</span><span class="o">.</span><span class="n">is_user_configured</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="ow">and</span> <span class="n">comp</span><span class="o">.</span><span class="n">is_user_enabled</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">hide</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">comp</span><span class="p">:</span> <span class="ow">not</span> <span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">is_user_configured</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="ow">and</span> <span class="n">comp</span><span class="o">.</span><span class="n">is_user_enabled</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">all_entries</span>
    <span class="n">echo</span><span class="o">.</span><span class="n">echo_formatted_list</span><span class="p">(</span><span class="n">computers</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">highlight</span><span class="o">=</span><span class="n">highlight</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>


<span class="nd">@verdi_computer</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">COMPUTER</span><span class="p">()</span>
<span class="nd">@with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">computer_show</span><span class="p">(</span><span class="n">computer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show information for a computer.&quot;&quot;&quot;</span>
    <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">computer</span><span class="o">.</span><span class="n">full_text_info</span><span class="p">)</span>


<span class="nd">@verdi_computer</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;rename&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">COMPUTER</span><span class="p">()</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">LABEL</span><span class="p">(</span><span class="s1">&#39;NEW_NAME&#39;</span><span class="p">)</span>
<span class="nd">@with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">computer_rename</span><span class="p">(</span><span class="n">computer</span><span class="p">,</span> <span class="n">new_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rename a computer.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">UniquenessError</span>

    <span class="n">old_name</span> <span class="o">=</span> <span class="n">computer</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">old_name</span> <span class="o">==</span> <span class="n">new_name</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s2">&quot;The old and new names are the same.&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">computer</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>
        <span class="n">computer</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s2">&quot;Invalid input! </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">UniquenessError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s2">&quot;Uniqueness error encountered! Probably a &quot;</span>
                           <span class="s2">&quot;computer with name &#39;</span><span class="si">{}</span><span class="s2">&#39; already exists&quot;</span>
                           <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_name</span><span class="p">))</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s2">&quot;(Message was: </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>

    <span class="n">echo</span><span class="o">.</span><span class="n">echo_success</span><span class="p">(</span><span class="s2">&quot;Computer &#39;</span><span class="si">{}</span><span class="s2">&#39; renamed to &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">))</span>


<span class="nd">@verdi_computer</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">USER</span><span class="p">(</span>
    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Test the connection for a given AiiDA user, specified by&quot;</span>
    <span class="s2">&quot;their email address. If not specified, uses the current default user.&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;-t&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--print-traceback&#39;</span><span class="p">,</span>
    <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print the full traceback in case an exception is raised&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">COMPUTER</span><span class="p">()</span>
<span class="nd">@with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">computer_test</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">print_traceback</span><span class="p">,</span> <span class="n">computer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test the connection to a computer.</span>

<span class="sd">    It tries to connect, to get the list of calculations on the queue and</span>
<span class="sd">    to perform other tests.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">traceback</span>
    <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">NotExistent</span>
    <span class="kn">from</span> <span class="nn">aiida</span> <span class="k">import</span> <span class="n">orm</span>

    <span class="c1"># Set a user automatically if one is not specified in the command line</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_default</span><span class="p">()</span>

    <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Testing computer&lt;</span><span class="si">{}</span><span class="s1">&gt; for user&lt;</span><span class="si">{}</span><span class="s1">&gt;...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">computer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">authinfo</span> <span class="o">=</span> <span class="n">computer</span><span class="o">.</span><span class="n">get_authinfo</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">NotExistent</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s1">&#39;Computer&lt;</span><span class="si">{}</span><span class="s1">&gt; is not yet configured for user&lt;</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">computer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">authinfo</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_warning</span><span class="p">(</span><span class="s1">&#39;Computer&lt;</span><span class="si">{}</span><span class="s1">&gt; is disabled for user&lt;</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">computer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">))</span>
        <span class="n">click</span><span class="o">.</span><span class="n">confirm</span><span class="p">(</span><span class="s1">&#39;Do you really want to test it?&#39;</span><span class="p">,</span> <span class="n">abort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">authinfo</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">get_scheduler</span><span class="p">()</span>
    <span class="n">transport</span> <span class="o">=</span> <span class="n">authinfo</span><span class="o">.</span><span class="n">get_transport</span><span class="p">()</span>

    <span class="c1"># STARTING TESTS HERE</span>
    <span class="n">num_failures</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num_tests</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;&gt; Testing connection...&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">transport</span><span class="p">:</span>
            <span class="n">scheduler</span><span class="o">.</span><span class="n">set_transport</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="n">num_tests</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_computer_test_no_unexpected_output</span><span class="p">,</span> <span class="n">_computer_test_get_jobs</span><span class="p">,</span> <span class="n">_computer_create_temp_file</span><span class="p">]:</span>
                <span class="n">num_tests</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">succeeded</span> <span class="o">=</span> <span class="n">test</span><span class="p">(</span><span class="n">transport</span><span class="o">=</span><span class="n">transport</span><span class="p">,</span> <span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler</span><span class="p">,</span> <span class="n">authinfo</span><span class="o">=</span><span class="n">authinfo</span><span class="p">)</span>
                <span class="c1"># pylint:disable=broad-except</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                    <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span><span class="s1">&#39;* The test raised an exception!&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">print_traceback</span><span class="p">:</span>
                        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;** Full traceback:&#39;</span><span class="p">)</span>
                        <span class="c1"># Indent</span>
                        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;   </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;** </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span>
                        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;** (use the --print-traceback option to see the full traceback)&#39;</span><span class="p">)</span>
                    <span class="n">succeeded</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">succeeded</span><span class="p">:</span>
                    <span class="n">num_failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">num_failures</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Some tests failed! (</span><span class="si">{}</span><span class="s1"> out of </span><span class="si">{}</span><span class="s1"> failed)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_failures</span><span class="p">,</span> <span class="n">num_tests</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Test completed (all </span><span class="si">{}</span><span class="s1"> tests succeeded)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_tests</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>  <span class="c1"># pylint:disable=broad-except</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_error</span><span class="p">(</span><span class="s1">&#39;** Error while trying to connect to the computer! Cannot perform following tests, stopping.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">print_traceback</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;** Full traceback:&#39;</span><span class="p">)</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;   </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;(use the --print-traceback option to see the full traceback)&#39;</span><span class="p">)</span>
        <span class="n">succeeded</span> <span class="o">=</span> <span class="kc">False</span>


<span class="nd">@verdi_computer</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">COMPUTER</span><span class="p">()</span>
<span class="nd">@with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">computer_delete</span><span class="p">(</span><span class="n">computer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Configure the authentication information for a given computer</span>

<span class="sd">    Does not delete the computer if there are calculations that are using</span>
<span class="sd">    it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">InvalidOperation</span>
    <span class="kn">from</span> <span class="nn">aiida</span> <span class="k">import</span> <span class="n">orm</span>

    <span class="n">compname</span> <span class="o">=</span> <span class="n">computer</span><span class="o">.</span><span class="n">name</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">computer</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">InvalidOperation</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>

    <span class="n">echo</span><span class="o">.</span><span class="n">echo_success</span><span class="p">(</span><span class="s2">&quot;Computer &#39;</span><span class="si">{}</span><span class="s2">&#39; deleted.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compname</span><span class="p">))</span>


<span class="nd">@verdi_computer</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;configure&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">computer_configure</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Configure a computer with one of the available transport types.&quot;&quot;&quot;</span>


<span class="nd">@computer_configure</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;--defaults&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Show the default configuration settings for this computer.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--as-option-string&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">USER</span><span class="p">()</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">COMPUTER</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">computer_config_show</span><span class="p">(</span><span class="n">computer</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">defaults</span><span class="p">,</span> <span class="n">as_option_string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show the current or default configuration for COMPUTER.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">tabulate</span>
    <span class="kn">from</span> <span class="nn">aiida.common.escaping</span> <span class="k">import</span> <span class="n">escape_for_bash</span>

    <span class="n">transport_cls</span> <span class="o">=</span> <span class="n">computer</span><span class="o">.</span><span class="n">get_transport_class</span><span class="p">()</span>
    <span class="n">option_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">transport_cli</span><span class="o">.</span><span class="n">create_configure_cmd</span><span class="p">(</span><span class="n">computer</span><span class="o">.</span><span class="n">get_transport_type</span><span class="p">())</span><span class="o">.</span><span class="n">params</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">click</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Option</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">option_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">option</span> <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">option_list</span> <span class="k">if</span> <span class="n">option</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">transport_cls</span><span class="o">.</span><span class="n">get_valid_auth_params</span><span class="p">()]</span>

    <span class="k">if</span> <span class="n">defaults</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="n">option</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">transport_cli</span><span class="o">.</span><span class="n">transport_option_default</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">computer</span><span class="p">)</span> <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">option_list</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">computer</span><span class="o">.</span><span class="n">get_configuration</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="n">option_items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">as_option_string</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">option_list</span><span class="p">:</span>
            <span class="n">t_opt</span> <span class="o">=</span> <span class="n">transport_cls</span><span class="o">.</span><span class="n">auth_options</span><span class="p">[</span><span class="n">option</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t_opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;switch&#39;</span><span class="p">):</span>
                    <span class="n">option_value</span> <span class="o">=</span> <span class="n">option</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;--no-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">option</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">t_opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_flag&#39;</span><span class="p">):</span>
                    <span class="n">is_default</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="n">transport_cli</span><span class="o">.</span><span class="n">transport_option_default</span><span class="p">(</span>
                        <span class="n">option</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">computer</span><span class="p">)</span>
                    <span class="n">option_value</span> <span class="o">=</span> <span class="n">option</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">is_default</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">option_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="n">option</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
                <span class="n">option_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">option_value</span><span class="p">)</span>
        <span class="n">opt_string</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">option_items</span><span class="p">)</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">escape_for_bash</span><span class="p">(</span><span class="n">opt_string</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">transport_cls</span><span class="o">.</span><span class="n">get_valid_auth_params</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;* &#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="n">name</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;* &#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">))</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">tabulate</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;plain&#39;</span><span class="p">))</span>


<span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="n">get_entry_points</span><span class="p">(</span><span class="s1">&#39;aiida.transports&#39;</span><span class="p">):</span>
    <span class="n">computer_configure</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">transport_cli</span><span class="o">.</span><span class="n">create_configure_cmd</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>