

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.cmdline.commands.cmd_export &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.cmdline.commands.cmd_export</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.cmdline.commands.cmd_export</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="c1"># pylint: disable=too-many-arguments,import-error</span>
<span class="sd">&quot;&quot;&quot;`verdi export` command.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">io</span>

<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">tabulate</span>

<span class="kn">from</span> <span class="nn">aiida.cmdline.commands.cmd_verdi</span> <span class="k">import</span> <span class="n">verdi</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.params</span> <span class="k">import</span> <span class="n">arguments</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.params</span> <span class="k">import</span> <span class="n">options</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.utils</span> <span class="k">import</span> <span class="n">decorators</span>
<span class="kn">from</span> <span class="nn">aiida.cmdline.utils</span> <span class="k">import</span> <span class="n">echo</span>
<span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">DanglingLinkError</span>


<span class="nd">@verdi</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;export&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">verdi_export</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Create and manage export archives.&quot;&quot;&quot;</span>


<span class="nd">@verdi_export</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;inspect&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;archive&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readable</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--version&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Print the archive format version and exit.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--data&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Print the data contents and exit.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;--meta-data&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Print the meta data contents and exit.&#39;</span><span class="p">)</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">inspect</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">meta_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inspect the contents of an exported archive without importing the content.</span>

<span class="sd">    By default a summary of the archive contents will be printed. The various options can be used to</span>
<span class="sd">    change exactly what information is displayed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.common.archive</span> <span class="k">import</span> <span class="n">Archive</span>

    <span class="k">with</span> <span class="n">Archive</span><span class="p">(</span><span class="n">archive</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive_object</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">version</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">archive_object</span><span class="o">.</span><span class="n">version_format</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_dictionary</span><span class="p">(</span><span class="n">archive_object</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">meta_data</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_dictionary</span><span class="p">(</span><span class="n">archive_object</span><span class="o">.</span><span class="n">meta_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">archive_object</span><span class="o">.</span><span class="n">get_info</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="n">k</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
            <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([(</span><span class="n">k</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">archive_object</span><span class="o">.</span><span class="n">get_data_statistics</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()]))</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">tabulate</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>


<span class="nd">@verdi_export</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">OUTPUT_FILE</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">CODES</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">COMPUTERS</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">GROUPS</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">NODES</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">ARCHIVE_FORMAT</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">FORCE</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;overwrite output file if it already exists&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;--input-forward/--no-input-forward&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Follow forward INPUT links (recursively) when calculating the node set to export.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;--create-reversed/--no-create-reversed&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">show_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Follow reverse CREATE links (recursively) when calculating the node set to export.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;--return-reversed/--no-return-reversed&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Follow reverse RETURN links (recursively) when calculating the node set to export.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;--call-reversed/--no-call-reversed&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Follow reverse CALL links (recursively) when calculating the node set to export.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;--include-logs/--exclude-logs&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">show_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Include or exclude logs for node(s) in export.&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s1">&#39;--include-comments/--exclude-comments&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">show_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Include or exclude comments for node(s) in export. (Will also export extra users who commented).&#39;</span><span class="p">)</span>
<span class="nd">@decorators</span><span class="o">.</span><span class="n">with_dbenv</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">codes</span><span class="p">,</span> <span class="n">computers</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">archive_format</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">input_forward</span><span class="p">,</span> <span class="n">create_reversed</span><span class="p">,</span>
           <span class="n">return_reversed</span><span class="p">,</span> <span class="n">call_reversed</span><span class="p">,</span> <span class="n">include_comments</span><span class="p">,</span> <span class="n">include_logs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export various entities, such as Codes, Computers, Groups and Nodes, to an archive file for backup or</span>
<span class="sd">    sharing purposes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.orm.importexport</span> <span class="k">import</span> <span class="n">export</span><span class="p">,</span> <span class="n">export_zip</span>

    <span class="n">entities</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">codes</span><span class="p">:</span>
        <span class="n">entities</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">codes</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">computers</span><span class="p">:</span>
        <span class="n">entities</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">computers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">entities</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">entities</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;input_forward&#39;</span><span class="p">:</span> <span class="n">input_forward</span><span class="p">,</span>
        <span class="s1">&#39;create_reversed&#39;</span><span class="p">:</span> <span class="n">create_reversed</span><span class="p">,</span>
        <span class="s1">&#39;return_reversed&#39;</span><span class="p">:</span> <span class="n">return_reversed</span><span class="p">,</span>
        <span class="s1">&#39;call_reversed&#39;</span><span class="p">:</span> <span class="n">call_reversed</span><span class="p">,</span>
        <span class="s1">&#39;include_comments&#39;</span><span class="p">:</span> <span class="n">include_comments</span><span class="p">,</span>
        <span class="s1">&#39;include_logs&#39;</span><span class="p">:</span> <span class="n">include_logs</span><span class="p">,</span>
        <span class="s1">&#39;overwrite&#39;</span><span class="p">:</span> <span class="n">force</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">archive_format</span> <span class="o">==</span> <span class="s1">&#39;zip&#39;</span><span class="p">:</span>
        <span class="n">export_function</span> <span class="o">=</span> <span class="n">export_zip</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;use_compression&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
    <span class="k">elif</span> <span class="n">archive_format</span> <span class="o">==</span> <span class="s1">&#39;zip-uncompressed&#39;</span><span class="p">:</span>
        <span class="n">export_function</span> <span class="o">=</span> <span class="n">export_zip</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;use_compression&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
    <span class="k">elif</span> <span class="n">archive_format</span> <span class="o">==</span> <span class="s1">&#39;tar.gz&#39;</span><span class="p">:</span>
        <span class="n">export_function</span> <span class="o">=</span> <span class="n">export</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">export_function</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">output_file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s1">&#39;failed to write the export archive file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_success</span><span class="p">(</span><span class="s1">&#39;wrote the export archive file to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_file</span><span class="p">))</span>


<span class="nd">@verdi_export</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;migrate&#39;</span><span class="p">)</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">INPUT_FILE</span><span class="p">()</span>
<span class="nd">@arguments</span><span class="o">.</span><span class="n">OUTPUT_FILE</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">ARCHIVE_FORMAT</span><span class="p">()</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">FORCE</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;overwrite output file if it already exists&#39;</span><span class="p">)</span>
<span class="nd">@options</span><span class="o">.</span><span class="n">SILENT</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">migrate</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">silent</span><span class="p">,</span> <span class="n">archive_format</span><span class="p">):</span>
    <span class="c1"># pylint: disable=too-many-locals,too-many-statements,too-many-branches</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Migrate an existing export archive file to the most recent version of the export format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">tarfile</span>
    <span class="kn">import</span> <span class="nn">zipfile</span>

    <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">json</span>
    <span class="kn">from</span> <span class="nn">aiida.common.folders</span> <span class="k">import</span> <span class="n">SandboxFolder</span>
    <span class="kn">from</span> <span class="nn">aiida.common.archive</span> <span class="k">import</span> <span class="n">extract_zip</span><span class="p">,</span> <span class="n">extract_tar</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s1">&#39;the output file already exists&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">SandboxFolder</span><span class="p">(</span><span class="n">sandbox_in_repo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">folder</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">is_zipfile</span><span class="p">(</span><span class="n">input_file</span><span class="p">):</span>
            <span class="n">extract_zip</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">is_tarfile</span><span class="p">(</span><span class="n">input_file</span><span class="p">):</span>
            <span class="n">extract_tar</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s1">&#39;invalid file format, expected either a zip archive or gzipped tarball&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="s1">&#39;data.json&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fhandle</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="s1">&#39;metadata.json&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fhandle</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s1">&#39;export archive does not contain the required file </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fhandle</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>

        <span class="n">old_version</span> <span class="o">=</span> <span class="n">verify_metadata_version</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        <span class="n">new_version</span> <span class="o">=</span> <span class="n">migrate_recursive</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="s1">&#39;data.json&#39;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="s1">&#39;metadata.json&#39;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">archive_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;zip&#39;</span><span class="p">,</span> <span class="s1">&#39;zip-uncompressed&#39;</span><span class="p">]:</span>
            <span class="n">compression</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span> <span class="k">if</span> <span class="n">archive_format</span> <span class="o">==</span> <span class="s1">&#39;zip&#39;</span> <span class="k">else</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_STORED</span>
            <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span> <span class="n">allowZip64</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
                <span class="n">src</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="n">abspath</span>
                <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
                    <span class="n">relpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">dirnames</span> <span class="o">+</span> <span class="n">filenames</span><span class="p">:</span>
                        <span class="n">real_src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                        <span class="n">real_dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">relpath</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                        <span class="n">archive</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">real_src</span><span class="p">,</span> <span class="n">real_dest</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">archive_format</span> <span class="o">==</span> <span class="s1">&#39;tar.gz&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;w:gz&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">tarfile</span><span class="o">.</span><span class="n">PAX_FORMAT</span><span class="p">,</span> <span class="n">dereference</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
                <span class="n">archive</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_success</span><span class="p">(</span><span class="s1">&#39;migrated the archive from version </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_version</span><span class="p">,</span> <span class="n">new_version</span><span class="p">))</span>


<div class="viewcode-block" id="verify_metadata_version"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.commands.html#aiida.cmdline.commands.cmd_export.verify_metadata_version">[docs]</a><span class="k">def</span> <span class="nf">verify_metadata_version</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utility function to verify that the metadata has the correct version number.</span>
<span class="sd">    If no version number is passed, it will just extract the version number</span>
<span class="sd">    and return it.</span>

<span class="sd">    :param metadata: the content of an export archive metadata.json file</span>
<span class="sd">    :param version: string version number that the metadata is expected to have</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">metadata_version</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;export_version&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;could not find the export_version field in the metadata&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">metadata_version</span>

    <span class="k">if</span> <span class="n">metadata_version</span> <span class="o">!=</span> <span class="n">version</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;expected export file with version </span><span class="si">{}</span><span class="s1"> but found version </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">metadata_version</span><span class="p">))</span>

    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="update_metadata"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.commands.html#aiida.cmdline.commands.cmd_export.update_metadata">[docs]</a><span class="k">def</span> <span class="nf">update_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the metadata with a new version number and a notification of the</span>
<span class="sd">    conversion that was executed</span>

<span class="sd">    :param metadata: the content of an export archive metadata.json file</span>
<span class="sd">    :param version: string version number that the updated metadata should get</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">aiida</span>
    <span class="n">old_version</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;export_version&#39;</span><span class="p">]</span>
    <span class="n">conversion_info</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conversion_info&#39;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="n">conversion_message</span> <span class="o">=</span> <span class="s1">&#39;Converted from version </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1"> with external script&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_version</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
    <span class="n">conversion_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conversion_message</span><span class="p">)</span>

    <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;aiida_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aiida</span><span class="o">.</span><span class="n">get_version</span><span class="p">()</span>
    <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;export_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">version</span>
    <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;conversion_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conversion_info</span></div>


<div class="viewcode-block" id="migrate_v1_to_v2"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.commands.html#aiida.cmdline.commands.cmd_export.migrate_v1_to_v2">[docs]</a><span class="k">def</span> <span class="nf">migrate_v1_to_v2</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Migration of export files from v0.1 to v0.2, which means generalizing the</span>
<span class="sd">    field names with respect to the database backend</span>

<span class="sd">    :param data: the content of an export archive data.json file</span>
<span class="sd">    :param metadata: the content of an export archive metadata.json file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">old_version</span> <span class="o">=</span> <span class="s1">&#39;0.1&#39;</span>
    <span class="n">new_version</span> <span class="o">=</span> <span class="s1">&#39;0.2&#39;</span>

    <span class="n">old_start</span> <span class="o">=</span> <span class="s2">&quot;aiida.djsite&quot;</span>
    <span class="n">new_start</span> <span class="o">=</span> <span class="s2">&quot;aiida.backends.djsite&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">verify_metadata_version</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">old_version</span><span class="p">)</span>
        <span class="n">update_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">new_version</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># pylint: disable=try-except-raise</span>
        <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">get_new_string</span><span class="p">(</span><span class="n">old_string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace the old module prefix with the new.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">old_string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">old_start</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_start</span><span class="p">,</span> <span class="n">old_string</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">old_start</span><span class="p">):])</span>

        <span class="k">return</span> <span class="n">old_string</span>

    <span class="k">def</span> <span class="nf">replace_requires</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace the requires keys with new module path.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">new_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;requires&#39;</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">old_start</span><span class="p">):</span>
                    <span class="n">new_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_new_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace_requires</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_data</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">old_start</span><span class="p">):</span>
                <span class="n">new_key</span> <span class="o">=</span> <span class="n">get_new_string</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;unique_identifiers&#39;</span><span class="p">,</span> <span class="s1">&#39;all_fields_info&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">old_start</span><span class="p">):</span>
                <span class="n">new_key</span> <span class="o">=</span> <span class="n">get_new_string</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">metadata</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">metadata</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>

    <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;all_fields_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace_requires</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;all_fields_info&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="migrate_v2_to_v3"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.commands.html#aiida.cmdline.commands.cmd_export.migrate_v2_to_v3">[docs]</a><span class="k">def</span> <span class="nf">migrate_v2_to_v3</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>  <span class="c1"># pylint: disable=too-many-locals,too-many-statements,too-many-branches</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Migration of export files from v0.2 to v0.3, which means adding the link</span>
<span class="sd">    types to the link entries and making the entity key names backend agnostic</span>
<span class="sd">    by effectively removing the prefix &#39;aiida.backends.djsite.db.models&#39;</span>

<span class="sd">    :param data: the content of an export archive data.json file</span>
<span class="sd">    :param metadata: the content of an export archive metadata.json file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">enum</span>

    <span class="n">old_version</span> <span class="o">=</span> <span class="s1">&#39;0.2&#39;</span>
    <span class="n">new_version</span> <span class="o">=</span> <span class="s1">&#39;0.3&#39;</span>

    <span class="k">class</span> <span class="nc">LinkType</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>  <span class="c1"># pylint: disable=too-few-public-methods</span>
        <span class="sd">&quot;&quot;&quot;This was the state of the `aiida.common.links.LinkType` enum before aiida-core v1.0.0a5&quot;&quot;&quot;</span>

        <span class="n">UNSPECIFIED</span> <span class="o">=</span> <span class="s1">&#39;unspecified&#39;</span>
        <span class="n">CREATE</span> <span class="o">=</span> <span class="s1">&#39;createlink&#39;</span>
        <span class="n">RETURN</span> <span class="o">=</span> <span class="s1">&#39;returnlink&#39;</span>
        <span class="n">INPUT</span> <span class="o">=</span> <span class="s1">&#39;inputlink&#39;</span>
        <span class="n">CALL</span> <span class="o">=</span> <span class="s1">&#39;calllink&#39;</span>

    <span class="k">class</span> <span class="nc">NodeType</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>  <span class="c1"># pylint: disable=too-few-public-methods</span>
        <span class="sd">&quot;&quot;&quot;A simple enum of relevant node types&quot;&quot;&quot;</span>

        <span class="n">NONE</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="n">CALC</span> <span class="o">=</span> <span class="s1">&#39;calculation&#39;</span>
        <span class="n">CODE</span> <span class="o">=</span> <span class="s1">&#39;code&#39;</span>
        <span class="n">DATA</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>
        <span class="n">WORK</span> <span class="o">=</span> <span class="s1">&#39;work&#39;</span>

    <span class="n">entity_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;aiida.backends.djsite.db.models.DbNode&#39;</span><span class="p">:</span> <span class="s1">&#39;Node&#39;</span><span class="p">,</span>
        <span class="s1">&#39;aiida.backends.djsite.db.models.DbLink&#39;</span><span class="p">:</span> <span class="s1">&#39;Link&#39;</span><span class="p">,</span>
        <span class="s1">&#39;aiida.backends.djsite.db.models.DbGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;Group&#39;</span><span class="p">,</span>
        <span class="s1">&#39;aiida.backends.djsite.db.models.DbComputer&#39;</span><span class="p">:</span> <span class="s1">&#39;Computer&#39;</span><span class="p">,</span>
        <span class="s1">&#39;aiida.backends.djsite.db.models.DbUser&#39;</span><span class="p">:</span> <span class="s1">&#39;User&#39;</span><span class="p">,</span>
        <span class="s1">&#39;aiida.backends.djsite.db.models.DbAttribute&#39;</span><span class="p">:</span> <span class="s1">&#39;Attribute&#39;</span>
    <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">verify_metadata_version</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">old_version</span><span class="p">)</span>
        <span class="n">update_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">new_version</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># pylint: disable=try-except-raise</span>
        <span class="k">raise</span>

    <span class="c1"># Create a mapping from node uuid to node type</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">node_uuid</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span>
                <span class="n">node_type_string</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">node_type_string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;calculation.job.&#39;</span><span class="p">):</span>
                <span class="n">node_type</span> <span class="o">=</span> <span class="n">NodeType</span><span class="o">.</span><span class="n">CALC</span>
            <span class="k">elif</span> <span class="n">node_type_string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;calculation.inline.&#39;</span><span class="p">):</span>
                <span class="n">node_type</span> <span class="o">=</span> <span class="n">NodeType</span><span class="o">.</span><span class="n">CALC</span>
            <span class="k">elif</span> <span class="n">node_type_string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;code.Code&#39;</span><span class="p">):</span>
                <span class="n">node_type</span> <span class="o">=</span> <span class="n">NodeType</span><span class="o">.</span><span class="n">CODE</span>
            <span class="k">elif</span> <span class="n">node_type_string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;data.&#39;</span><span class="p">):</span>
                <span class="n">node_type</span> <span class="o">=</span> <span class="n">NodeType</span><span class="o">.</span><span class="n">DATA</span>
            <span class="k">elif</span> <span class="n">node_type_string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;calculation.work.&#39;</span><span class="p">):</span>
                <span class="n">node_type</span> <span class="o">=</span> <span class="n">NodeType</span><span class="o">.</span><span class="n">WORK</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node_type</span> <span class="o">=</span> <span class="n">NodeType</span><span class="o">.</span><span class="n">NONE</span>

            <span class="n">mapping</span><span class="p">[</span><span class="n">node_uuid</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_type</span>

    <span class="c1"># For each link, deduce the link type and insert it in place</span>
    <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;links_uuid&#39;</span><span class="p">]:</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">input_type</span> <span class="o">=</span> <span class="n">NodeType</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]])</span>
            <span class="n">output_type</span> <span class="o">=</span> <span class="n">NodeType</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DanglingLinkError</span><span class="p">(</span><span class="s1">&#39;Unknown node UUID </span><span class="si">{}</span><span class="s1"> or </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]))</span>

        <span class="c1"># The following table demonstrates the logic for infering the link type</span>
        <span class="c1"># (CODE, DATA) -&gt; (WORK, CALC) : INPUT</span>
        <span class="c1"># (CALC)       -&gt; (DATA)       : CREATE</span>
        <span class="c1"># (WORK)       -&gt; (DATA)       : RETURN</span>
        <span class="c1"># (WORK)       -&gt; (CALC, WORK) : CALL</span>
        <span class="k">if</span> <span class="n">input_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">NodeType</span><span class="o">.</span><span class="n">CODE</span><span class="p">,</span> <span class="n">NodeType</span><span class="o">.</span><span class="n">DATA</span><span class="p">]</span> <span class="ow">and</span> <span class="n">output_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">NodeType</span><span class="o">.</span><span class="n">CALC</span><span class="p">,</span> <span class="n">NodeType</span><span class="o">.</span><span class="n">WORK</span><span class="p">]:</span>
            <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="n">input_type</span> <span class="o">==</span> <span class="n">NodeType</span><span class="o">.</span><span class="n">CALC</span> <span class="ow">and</span> <span class="n">output_type</span> <span class="o">==</span> <span class="n">NodeType</span><span class="o">.</span><span class="n">DATA</span><span class="p">:</span>
            <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="n">input_type</span> <span class="o">==</span> <span class="n">NodeType</span><span class="o">.</span><span class="n">WORK</span> <span class="ow">and</span> <span class="n">output_type</span> <span class="o">==</span> <span class="n">NodeType</span><span class="o">.</span><span class="n">DATA</span><span class="p">:</span>
            <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="n">input_type</span> <span class="o">==</span> <span class="n">NodeType</span><span class="o">.</span><span class="n">WORK</span> <span class="ow">and</span> <span class="n">output_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">NodeType</span><span class="o">.</span><span class="n">CALC</span><span class="p">,</span> <span class="n">NodeType</span><span class="o">.</span><span class="n">WORK</span><span class="p">]:</span>
            <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CALL</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">link</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">UNSPECIFIED</span><span class="o">.</span><span class="n">value</span>

    <span class="c1"># Now we migrate the entity key names i.e. removing the &#39;aiida.backends.djsite.db.models&#39; prefix</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;unique_identifiers&#39;</span><span class="p">,</span> <span class="s1">&#39;all_fields_info&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">old_key</span><span class="p">,</span> <span class="n">new_key</span> <span class="ow">in</span> <span class="n">entity_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">old_key</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                <span class="n">metadata</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">old_key</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">metadata</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">old_key</span><span class="p">]</span>

    <span class="c1"># Replace the &#39;requires&#39; keys in the nested dictionaries in &#39;all_fields_info&#39;</span>
    <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;all_fields_info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">prop</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;requires&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">entity_map</span><span class="p">:</span>
                    <span class="n">prop</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity_map</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>

    <span class="c1"># Replace any present keys in the data.json</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;export_data&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">old_key</span><span class="p">,</span> <span class="n">new_key</span> <span class="ow">in</span> <span class="n">entity_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">old_key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">old_key</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">old_key</span><span class="p">]</span></div>


<div class="viewcode-block" id="migrate_recursive"><a class="viewcode-back" href="../../../../apidoc/aiida.cmdline.commands.html#aiida.cmdline.commands.cmd_export.migrate_recursive">[docs]</a><span class="k">def</span> <span class="nf">migrate_recursive</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recursive migration of export files from v0.1 to newest version,</span>
<span class="sd">    See specific migration functions for detailed descriptions.</span>
<span class="sd">    NOTE: Remember to update newest_version to the newest export version,</span>
<span class="sd">    when/if a migration is available.</span>

<span class="sd">    :param metadata: the content of an export archive metadata.json file</span>
<span class="sd">    :param data: the content of an export archive data.json file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">newest_version</span> <span class="o">=</span> <span class="s1">&#39;0.3&#39;</span>
    <span class="n">old_version</span> <span class="o">=</span> <span class="n">verify_metadata_version</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">old_version</span> <span class="o">==</span> <span class="s1">&#39;0.1&#39;</span><span class="p">:</span>
            <span class="n">migrate_v1_to_v2</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">old_version</span> <span class="o">==</span> <span class="s1">&#39;0.2&#39;</span><span class="p">:</span>
            <span class="n">migrate_v2_to_v3</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s1">&#39;cannot migrate from version </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_version</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">DanglingLinkError</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_critical</span><span class="p">(</span><span class="s1">&#39;export file is invalid because it contains dangling links&#39;</span><span class="p">)</span>

    <span class="n">new_version</span> <span class="o">=</span> <span class="n">verify_metadata_version</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">new_version</span> <span class="o">&lt;</span> <span class="n">newest_version</span><span class="p">:</span>
        <span class="n">migrate_recursive</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_version</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>