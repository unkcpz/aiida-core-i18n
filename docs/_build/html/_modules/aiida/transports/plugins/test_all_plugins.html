

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.transports.plugins.test_all_plugins &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.transports.plugins.test_all_plugins</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.transports.plugins.test_all_plugins</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains a set of unittest test classes that can be loaded from</span>
<span class="sd">the plugin.</span>
<span class="sd">Every transport plugin should be able to pass all of these common tests.</span>
<span class="sd">Plugin specific tests will be written in the plugin itself.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># TODO : test for copy with pattern</span>
<span class="c1"># TODO : test for copy with/without patterns, overwriting folder</span>
<span class="c1"># TODO : test for exotic cases of copy with source = destination</span>
<span class="c1"># TODO : silly cases of copy/put/get from self to self</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="nb">range</span>


<div class="viewcode-block" id="get_all_custom_transports"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.get_all_custom_transports">[docs]</a><span class="k">def</span> <span class="nf">get_all_custom_transports</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Autodiscover all custom transports defined in the variable</span>
<span class="sd">    plugin_transpors inside each test_* file in this folder.</span>
<span class="sd">    </span>
<span class="sd">    Therefore, do not move this function out of this file.</span>
<span class="sd">    </span>
<span class="sd">    :return: a dictionary of objects as defined in the various plugin_transport</span>
<span class="sd">      variables of the different files (the key is the module in which</span>
<span class="sd">      it was found)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">importlib</span>
    <span class="kn">import</span> <span class="nn">os</span>

    <span class="n">modulename</span> <span class="o">=</span> <span class="vm">__name__</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">this_full_fname</span> <span class="o">=</span> <span class="vm">__file__</span>
    <span class="n">thisdir</span><span class="p">,</span> <span class="n">thisfname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">this_full_fname</span><span class="p">)</span>

    <span class="n">test_modules</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">thisdir</span><span class="p">)</span> <span class="k">if</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;test_&#39;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Remove this module: note that I should be careful because __file__, from</span>
    <span class="c1"># the second time on, is the pyc file rather than the py file</span>
    <span class="n">thisbasename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">thisfname</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">test_modules</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thisbasename</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning, this module (</span><span class="si">{}</span><span class="s2">) was not found!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">thisbasename</span><span class="p">))</span>

    <span class="n">all_custom_transports</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">test_modules</span><span class="p">:</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">modulename</span><span class="p">,</span> <span class="n">m</span><span class="p">]))</span>
        <span class="n">custom_transport</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plugin_transport&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">custom_transport</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Define the plugin_transport variable inside the </span><span class="si">{}</span><span class="s2"> module!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_custom_transports</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">custom_transport</span>

    <span class="k">return</span> <span class="n">all_custom_transports</span></div>


<div class="viewcode-block" id="run_for_all_plugins"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.run_for_all_plugins">[docs]</a><span class="k">def</span> <span class="nf">run_for_all_plugins</span><span class="p">(</span><span class="n">actual_test_method</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator method that actually run the methods with an additional </span>
<span class="sd">    parameter (custom_transport), once for every custom_transport defined</span>
<span class="sd">    in the test_* files [except this one].</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">CollectiveException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="n">all_custom_transports</span> <span class="o">=</span> <span class="n">get_all_custom_transports</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_all_plugins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The wrapper function that calls the subfunction for each transport.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exceptions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tr_name</span><span class="p">,</span> <span class="n">custom_transport</span> <span class="ow">in</span> <span class="n">all_custom_transports</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">actual_test_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">traceback</span>

                <span class="n">exceptions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">e</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span> <span class="n">tr_name</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">exceptions</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="ne">AssertionError</span><span class="p">)</span> <span class="k">for</span> <span class="n">exc</span> <span class="ow">in</span> <span class="n">exceptions</span><span class="p">):</span>
                <span class="n">exception_to_raise</span> <span class="o">=</span> <span class="ne">AssertionError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exception_to_raise</span> <span class="o">=</span> <span class="n">CollectiveException</span>

            <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;*** At least one test for a subplugin failed. See below ***&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">exc</span> <span class="ow">in</span> <span class="n">exceptions</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;*** [For plugin </span><span class="si">{}</span><span class="s2">]: Exception &#39;</span><span class="si">{}</span><span class="s2">&#39;: </span><span class="si">{}</span><span class="s2">&quot;</span>
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">exc</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">raise</span> <span class="n">exception_to_raise</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">messages</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">test_all_plugins</span></div>


<div class="viewcode-block" id="TestBasicFunctionality"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestBasicFunctionality">[docs]</a><span class="k">class</span> <span class="nc">TestBasicFunctionality</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests to check basic functionality of transports.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestBasicFunctionality.test_is_open"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestBasicFunctionality.test_is_open">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_is_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test that the is_open property works.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">custom_transport</span><span class="o">.</span><span class="n">is_open</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">custom_transport</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">custom_transport</span><span class="o">.</span><span class="n">is_open</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">custom_transport</span><span class="o">.</span><span class="n">is_open</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestDirectoryManipulation"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestDirectoryManipulation">[docs]</a><span class="k">class</span> <span class="nc">TestDirectoryManipulation</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests to check, create and delete folders.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestDirectoryManipulation.test_makedirs"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestDirectoryManipulation.test_makedirs">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_makedirs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the functioning of makedirs command</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Imports required later</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">import</span> <span class="nn">string</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">))</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;temp_dir_test&#39;</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
            <span class="k">while</span> <span class="n">t</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                <span class="c1"># I append a random letter/number until it is unique</span>
                <span class="n">directory</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

            <span class="c1"># define folder structure</span>
            <span class="n">dir_tree</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span>
            <span class="c1"># I create the tree</span>
            <span class="n">t</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_tree</span><span class="p">)</span>
            <span class="c1"># verify the existence</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">dir_tree</span><span class="p">)</span>

            <span class="c1"># try to recreate the same folder</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_tree</span><span class="p">)</span>

            <span class="c1"># recreate but with ignore flag</span>
            <span class="n">t</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_tree</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">dir_tree</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestDirectoryManipulation.test_rmtree"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestDirectoryManipulation.test_rmtree">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_rmtree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the functioning of rmtree command</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Imports required later</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">import</span> <span class="nn">string</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">))</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;temp_dir_test&#39;</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
            <span class="k">while</span> <span class="n">t</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                <span class="c1"># I append a random letter/number until it is unique</span>
                <span class="n">directory</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

            <span class="c1"># define folder structure</span>
            <span class="n">dir_tree</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span>
            <span class="c1"># I create the tree</span>
            <span class="n">t</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_tree</span><span class="p">)</span>
            <span class="c1"># remove it</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
            <span class="c1"># verify the removal</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">))</span>

            <span class="c1"># also tests that it works with a single file</span>
            <span class="c1"># create file</span>
            <span class="n">local_file_name</span> <span class="o">=</span> <span class="s1">&#39;file.txt&#39;</span>
            <span class="n">text</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;Viva Verdi</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">local_file_name</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
                <span class="n">fhandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="c1"># remove it</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">local_file_name</span><span class="p">)</span>
            <span class="c1"># verify the removal</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">local_file_name</span><span class="p">))</span>

            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestDirectoryManipulation.test_listdir"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestDirectoryManipulation.test_listdir">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_listdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        create directories, verify listdir, delete a folder with subfolders</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Imports required later</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">import</span> <span class="nn">string</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">trans</span><span class="p">:</span>
            <span class="c1"># We cannot use tempfile.mkdtemp because we&#39;re on a remote folder</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">))</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;temp_dir_test&#39;</span>
            <span class="n">trans</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">trans</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
            <span class="k">while</span> <span class="n">trans</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                <span class="c1"># I append a random letter/number until it is unique</span>
                <span class="n">directory</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>
            <span class="n">trans</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">trans</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">list_of_dir</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;-f a&amp;&#39;</span><span class="p">,</span> <span class="s1">&#39;as&#39;</span><span class="p">,</span> <span class="s1">&#39;a2&#39;</span><span class="p">,</span> <span class="s1">&#39;a4f&#39;</span><span class="p">]</span>
            <span class="n">list_of_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">this_dir</span> <span class="ow">in</span> <span class="n">list_of_dir</span><span class="p">:</span>
                <span class="n">trans</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">this_dir</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">list_of_files</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpf</span><span class="p">:</span>
                    <span class="c1"># Just put an empty file there at the right file name</span>
                    <span class="n">trans</span><span class="o">.</span><span class="n">putfile</span><span class="p">(</span><span class="n">tmpf</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

            <span class="n">list_found</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">list_found</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">list_of_dir</span> <span class="o">+</span> <span class="n">list_of_files</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;a*&#39;</span><span class="p">)),</span> <span class="nb">sorted</span><span class="p">([</span><span class="s1">&#39;as&#39;</span><span class="p">,</span> <span class="s1">&#39;a2&#39;</span><span class="p">,</span> <span class="s1">&#39;a4f&#39;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;a?&#39;</span><span class="p">)),</span> <span class="nb">sorted</span><span class="p">([</span><span class="s1">&#39;as&#39;</span><span class="p">,</span> <span class="s1">&#39;a2&#39;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;a[2-4]*&#39;</span><span class="p">)),</span> <span class="nb">sorted</span><span class="p">([</span><span class="s1">&#39;a2&#39;</span><span class="p">,</span> <span class="s1">&#39;a4f&#39;</span><span class="p">]))</span>

            <span class="k">for</span> <span class="n">this_dir</span> <span class="ow">in</span> <span class="n">list_of_dir</span><span class="p">:</span>
                <span class="n">trans</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">this_dir</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">this_file</span> <span class="ow">in</span> <span class="n">list_of_files</span><span class="p">:</span>
                <span class="n">trans</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">this_file</span><span class="p">)</span>

            <span class="n">trans</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
            <span class="n">trans</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestDirectoryManipulation.test_listdir_withattributes"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestDirectoryManipulation.test_listdir_withattributes">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_listdir_withattributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        create directories, verify listdir_withattributes, delete a folder with subfolders</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Imports required later</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">import</span> <span class="nn">string</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="k">def</span> <span class="nf">simplify_attributes</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Take data from listdir_withattributes and return a dictionary</span>
<span class="sd">            {fname: isdir}</span>

<span class="sd">            :param data: the output of listdir_withattributes</span>
<span class="sd">            :return: dictionary: the key is a filename, the value is True if it&#39;s a directory, False otherwise</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">_</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span> <span class="n">_</span><span class="p">[</span><span class="s1">&#39;isdir&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">data</span><span class="p">}</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">trans</span><span class="p">:</span>
            <span class="c1"># We cannot use tempfile.mkdtemp because we&#39;re on a remote folder</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">))</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;temp_dir_test&#39;</span>
            <span class="n">trans</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">trans</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
            <span class="k">while</span> <span class="n">trans</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                <span class="c1"># I append a random letter/number until it is unique</span>
                <span class="n">directory</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>
            <span class="n">trans</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">trans</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">list_of_dir</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;-f a&amp;&#39;</span><span class="p">,</span> <span class="s1">&#39;as&#39;</span><span class="p">,</span> <span class="s1">&#39;a2&#39;</span><span class="p">,</span> <span class="s1">&#39;a4f&#39;</span><span class="p">]</span>
            <span class="n">list_of_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">this_dir</span> <span class="ow">in</span> <span class="n">list_of_dir</span><span class="p">:</span>
                <span class="n">trans</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">this_dir</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">list_of_files</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpf</span><span class="p">:</span>
                    <span class="c1"># Just put an empty file there at the right file name</span>
                    <span class="n">trans</span><span class="o">.</span><span class="n">putfile</span><span class="p">(</span><span class="n">tmpf</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

            <span class="n">comparison_list</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="kc">True</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">list_of_dir</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">list_of_files</span><span class="p">:</span>
                <span class="n">comparison_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">simplify_attributes</span><span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">listdir_withattributes</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)),</span> <span class="n">comparison_list</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
                <span class="n">simplify_attributes</span><span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">listdir_withattributes</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;a*&#39;</span><span class="p">)),</span> <span class="p">{</span>
                    <span class="s1">&#39;as&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;a2&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;a4f&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="kc">False</span>
                <span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">simplify_attributes</span><span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">listdir_withattributes</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;a?&#39;</span><span class="p">)),</span> <span class="p">{</span><span class="s1">&#39;as&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;a2&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">simplify_attributes</span><span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">listdir_withattributes</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;a[2-4]*&#39;</span><span class="p">)),</span> <span class="p">{</span><span class="s1">&#39;a2&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;a4f&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

            <span class="k">for</span> <span class="n">this_dir</span> <span class="ow">in</span> <span class="n">list_of_dir</span><span class="p">:</span>
                <span class="n">trans</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">this_dir</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">this_file</span> <span class="ow">in</span> <span class="n">list_of_files</span><span class="p">:</span>
                <span class="n">trans</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">this_file</span><span class="p">)</span>

            <span class="n">trans</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
            <span class="n">trans</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestDirectoryManipulation.test_dir_creation_deletion"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestDirectoryManipulation.test_dir_creation_deletion">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_dir_creation_deletion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="c1"># Imports required later</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">import</span> <span class="nn">string</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">))</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;temp_dir_test&#39;</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
            <span class="k">while</span> <span class="n">t</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                <span class="c1"># I append a random letter/number until it is unique</span>
                <span class="n">directory</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="c1"># I create twice the same directory</span>
                <span class="n">t</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestDirectoryManipulation.test_dir_copy"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestDirectoryManipulation.test_dir_copy">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_dir_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify if in the copy of a directory also the protection bits</span>
<span class="sd">        are carried over</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Imports required later</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">import</span> <span class="nn">string</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">))</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;temp_dir_test&#39;</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">t</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                <span class="c1"># I append a random letter/number until it is unique</span>
                <span class="n">directory</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

            <span class="n">dest_directory</span> <span class="o">=</span> <span class="n">directory</span> <span class="o">+</span> <span class="s1">&#39;_copy&#39;</span>
            <span class="n">t</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">dest_directory</span><span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">dest_directory</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestDirectoryManipulation.test_dir_permissions_creation_modification"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestDirectoryManipulation.test_dir_permissions_creation_modification">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_dir_permissions_creation_modification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        verify if chmod raises IOError when trying to change bits on a</span>
<span class="sd">        non-existing folder</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Imports required later</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">import</span> <span class="nn">string</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">))</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;temp_dir_test&#39;</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">t</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                <span class="c1"># I append a random letter/number until it is unique</span>
                <span class="n">directory</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>

            <span class="c1"># create directory with non default permissions</span>
            <span class="n">t</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

            <span class="c1"># change permissions</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="mo">0o777</span><span class="p">)</span>

            <span class="c1"># test if the security bits have changed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_mode</span><span class="p">(</span><span class="n">directory</span><span class="p">),</span> <span class="mo">0o777</span><span class="p">)</span>

            <span class="c1"># change permissions</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="mo">0o511</span><span class="p">)</span>

            <span class="c1"># test if the security bits have changed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_mode</span><span class="p">(</span><span class="n">directory</span><span class="p">),</span> <span class="mo">0o511</span><span class="p">)</span>

            <span class="c1"># TODO : bug in paramiko. When changing the directory to very low \</span>
            <span class="c1"># I cannot set it back to higher permissions</span>

            <span class="c1">## TODO: probably here we should then check for</span>
            <span class="c1">## the new directory modes. To see if we want a higher</span>
            <span class="c1">## level function to ask for the mode, or we just</span>
            <span class="c1">## use get_attribute</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

            <span class="c1"># change permissions of an empty string, non existing folder.</span>
            <span class="n">fake_dir</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">IOError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">fake_dir</span><span class="p">,</span> <span class="mo">0o777</span><span class="p">)</span>

            <span class="n">fake_dir</span> <span class="o">=</span> <span class="s1">&#39;pippo&#39;</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">IOError</span><span class="p">):</span>
                <span class="c1"># chmod to a non existing folder</span>
                <span class="n">t</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">fake_dir</span><span class="p">,</span> <span class="mo">0o777</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestDirectoryManipulation.test_dir_reading_permissions"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestDirectoryManipulation.test_dir_reading_permissions">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_dir_reading_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try to enter a directory with no read permissions.</span>
<span class="sd">        Verify that the cwd has not changed after failed try.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Imports required later</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">import</span> <span class="nn">string</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">))</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;temp_dir_test&#39;</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">t</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                <span class="c1"># I append a random letter/number until it is unique</span>
                <span class="n">directory</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>

            <span class="c1"># create directory with non default permissions</span>
            <span class="n">t</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

            <span class="c1"># change permissions to low ones</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># test if the security bits have changed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_mode</span><span class="p">(</span><span class="n">directory</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">old_cwd</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">IOError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

            <span class="n">new_cwd</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">old_cwd</span><span class="p">,</span> <span class="n">new_cwd</span><span class="p">)</span></div>

            <span class="c1"># TODO : the test leaves a directory even if it is successful</span>
            <span class="c1">#        The bug is in paramiko. After lowering the permissions,</span>
            <span class="c1">#        I cannot restore them to higher values</span>
            <span class="c1">#t.rmdir(directory)</span>

<div class="viewcode-block" id="TestDirectoryManipulation.test_isfile_isdir_to_empty_string"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestDirectoryManipulation.test_isfile_isdir_to_empty_string">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_isfile_isdir_to_empty_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        I check that isdir or isfile return False when executed on an</span>
<span class="sd">        empty string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestDirectoryManipulation.test_isfile_isdir_to_non_existing_string"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestDirectoryManipulation.test_isfile_isdir_to_non_existing_string">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_isfile_isdir_to_non_existing_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        I check that isdir or isfile return False when executed on an</span>
<span class="sd">        empty string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
            <span class="n">fake_folder</span> <span class="o">=</span> <span class="s1">&#39;pippo&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fake_folder</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">fake_folder</span><span class="p">))</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">IOError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">fake_folder</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestDirectoryManipulation.test_chdir_to_empty_string"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestDirectoryManipulation.test_chdir_to_empty_string">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_chdir_to_empty_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        I check that if I pass an empty string to chdir, the cwd does</span>
<span class="sd">        not change (this is a paramiko default behavior), but getcwd()</span>
<span class="sd">        is still correctly defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">new_dir</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">new_dir</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span></div></div>


<div class="viewcode-block" id="TestPutGetFile"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestPutGetFile">[docs]</a><span class="k">class</span> <span class="nc">TestPutGetFile</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test to verify whether the put and get functions behave correctly on files.</span>
<span class="sd">    1) they work</span>
<span class="sd">    2) they need abs paths where necessary, i.e. for local paths</span>
<span class="sd">    3) they reject empty strings</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestPutGetFile.test_put_and_get"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestPutGetFile.test_put_and_get">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_put_and_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">import</span> <span class="nn">string</span>

        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
        <span class="n">remote_dir</span> <span class="o">=</span> <span class="n">local_dir</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;tmp_try&#39;</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">remote_dir</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">t</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                <span class="c1"># I append a random letter/number until it is unique</span>
                <span class="n">directory</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

            <span class="n">local_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;file.txt&#39;</span><span class="p">)</span>
            <span class="n">remote_file_name</span> <span class="o">=</span> <span class="s1">&#39;file_remote.txt&#39;</span>
            <span class="n">retrieved_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;file_retrieved.txt&#39;</span><span class="p">)</span>

            <span class="n">text</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;Viva Verdi</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">local_file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
                <span class="n">fhandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="c1"># here use full path in src and dst</span>
            <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local_file_name</span><span class="p">,</span> <span class="n">remote_file_name</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remote_file_name</span><span class="p">,</span> <span class="n">retrieved_file_name</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">putfile</span><span class="p">(</span><span class="n">local_file_name</span><span class="p">,</span> <span class="n">remote_file_name</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">remote_file_name</span><span class="p">,</span> <span class="n">retrieved_file_name</span><span class="p">)</span>

            <span class="n">list_of_files</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="c1"># it is False because local_file_name has the full path,</span>
            <span class="c1"># while list_of_files has not</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">local_file_name</span> <span class="ow">in</span> <span class="n">list_of_files</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">remote_file_name</span> <span class="ow">in</span> <span class="n">list_of_files</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">retrieved_file_name</span> <span class="ow">in</span> <span class="n">list_of_files</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">local_file_name</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">remote_file_name</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">retrieved_file_name</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestPutGetFile.test_put_get_abs_path"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestPutGetFile.test_put_get_abs_path">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_put_get_abs_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        test of exception for non existing files and abs path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">import</span> <span class="nn">string</span>

        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
        <span class="n">remote_dir</span> <span class="o">=</span> <span class="n">local_dir</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;tmp_try&#39;</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">remote_dir</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">t</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                <span class="c1"># I append a random letter/number until it is unique</span>
                <span class="n">directory</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

            <span class="n">partial_file_name</span> <span class="o">=</span> <span class="s1">&#39;file.txt&#39;</span>
            <span class="n">local_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;file.txt&#39;</span><span class="p">)</span>
            <span class="n">remote_file_name</span> <span class="o">=</span> <span class="s1">&#39;file_remote.txt&#39;</span>
            <span class="n">retrieved_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;file_retrieved.txt&#39;</span><span class="p">)</span>

            <span class="n">fhandle</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">local_file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
            <span class="n">fhandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># partial_file_name is not an abs path</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">partial_file_name</span><span class="p">,</span> <span class="n">remote_file_name</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">putfile</span><span class="p">(</span><span class="n">partial_file_name</span><span class="p">,</span> <span class="n">remote_file_name</span><span class="p">)</span>

            <span class="c1"># retrieved_file_name does not exist</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">retrieved_file_name</span><span class="p">,</span> <span class="n">remote_file_name</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">putfile</span><span class="p">(</span><span class="n">retrieved_file_name</span><span class="p">,</span> <span class="n">remote_file_name</span><span class="p">)</span>

            <span class="c1"># remote_file_name does not exist</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">IOError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remote_file_name</span><span class="p">,</span> <span class="n">retrieved_file_name</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">IOError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">remote_file_name</span><span class="p">,</span> <span class="n">retrieved_file_name</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local_file_name</span><span class="p">,</span> <span class="n">remote_file_name</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">putfile</span><span class="p">(</span><span class="n">local_file_name</span><span class="p">,</span> <span class="n">remote_file_name</span><span class="p">)</span>

            <span class="c1"># local filename is not an abs path</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remote_file_name</span><span class="p">,</span> <span class="s1">&#39;delete_me.txt&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">remote_file_name</span><span class="p">,</span> <span class="s1">&#39;delete_me.txt&#39;</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">remote_file_name</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">local_file_name</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestPutGetFile.test_put_get_empty_string"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestPutGetFile.test_put_get_empty_string">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_put_get_empty_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        test of exception put/get of empty strings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO : verify the correctness of \n at the end of a file</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">import</span> <span class="nn">string</span>

        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
        <span class="n">remote_dir</span> <span class="o">=</span> <span class="n">local_dir</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;tmp_try&#39;</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">remote_dir</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">t</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                <span class="c1"># I append a random letter/number until it is unique</span>
                <span class="n">directory</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

            <span class="n">local_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;file_local.txt&#39;</span><span class="p">)</span>
            <span class="n">remote_file_name</span> <span class="o">=</span> <span class="s1">&#39;file_remote.txt&#39;</span>
            <span class="n">retrieved_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;file_retrieved.txt&#39;</span><span class="p">)</span>

            <span class="n">text</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;Viva Verdi</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">local_file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
                <span class="n">fhandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="c1"># localpath is an empty string</span>
            <span class="c1"># ValueError because it is not an abs path</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">remote_file_name</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">putfile</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">remote_file_name</span><span class="p">)</span>

            <span class="c1"># remote path is an empty string</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">IOError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local_file_name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">IOError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">putfile</span><span class="p">(</span><span class="n">local_file_name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local_file_name</span><span class="p">,</span> <span class="n">remote_file_name</span><span class="p">)</span>
            <span class="c1"># overwrite the remote_file_name</span>
            <span class="n">t</span><span class="o">.</span><span class="n">putfile</span><span class="p">(</span><span class="n">local_file_name</span><span class="p">,</span> <span class="n">remote_file_name</span><span class="p">)</span>

            <span class="c1"># remote path is an empty string</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">IOError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">retrieved_file_name</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">IOError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">retrieved_file_name</span><span class="p">)</span>

            <span class="c1"># local path is an empty string</span>
            <span class="c1"># ValueError because it is not an abs path</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remote_file_name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">remote_file_name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="c1"># TODO : get doesn&#39;t retrieve empty files.</span>
            <span class="c1"># Is it what we want?</span>
            <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remote_file_name</span><span class="p">,</span> <span class="n">retrieved_file_name</span><span class="p">)</span>
            <span class="c1"># overwrite retrieved_file_name</span>
            <span class="n">t</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">remote_file_name</span><span class="p">,</span> <span class="n">retrieved_file_name</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">local_file_name</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">remote_file_name</span><span class="p">)</span>
            <span class="c1"># If it couldn&#39;t end the copy, it leaves what he did on</span>
            <span class="c1"># local file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;file_retrieved.txt&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">retrieved_file_name</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestPutGetTree"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestPutGetTree">[docs]</a><span class="k">class</span> <span class="nc">TestPutGetTree</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test to verify whether the put and get functions behave correctly on folders.</span>
<span class="sd">    1) they work</span>
<span class="sd">    2) they need abs paths where necessary, i.e. for local paths</span>
<span class="sd">    3) they reject empty strings</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestPutGetTree.test_put_and_get"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestPutGetTree.test_put_and_get">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_put_and_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">import</span> <span class="nn">string</span>

        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
        <span class="n">remote_dir</span> <span class="o">=</span> <span class="n">local_dir</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;tmp_try&#39;</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>

            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">remote_dir</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">)):</span>
                <span class="c1"># I append a random letter/number until it is unique</span>
                <span class="n">directory</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>

            <span class="n">local_subfolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;tmp1&#39;</span><span class="p">)</span>
            <span class="n">remote_subfolder</span> <span class="o">=</span> <span class="s1">&#39;tmp2&#39;</span>
            <span class="n">retrieved_subfolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;tmp3&#39;</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">local_subfolder</span><span class="p">))</span>

            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

            <span class="n">local_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_subfolder</span><span class="p">,</span> <span class="s1">&#39;file.txt&#39;</span><span class="p">)</span>

            <span class="n">text</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;Viva Verdi</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">local_file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
                <span class="n">fhandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="c1"># here use full path in src and dst</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local_subfolder</span><span class="p">,</span> <span class="n">remote_subfolder</span><span class="p">)</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remote_subfolder</span><span class="p">,</span> <span class="n">retrieved_subfolder</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">puttree</span><span class="p">(</span><span class="n">local_subfolder</span><span class="p">,</span> <span class="n">remote_subfolder</span><span class="p">)</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">gettree</span><span class="p">(</span><span class="n">remote_subfolder</span><span class="p">,</span> <span class="n">retrieved_subfolder</span><span class="p">)</span>

                <span class="c1"># Here I am mixing the local with the remote fold</span>
                <span class="n">list_of_dirs</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="c1"># # it is False because local_file_name has the full path,</span>
                <span class="c1"># # while list_of_files has not</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">local_subfolder</span> <span class="ow">in</span> <span class="n">list_of_dirs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">remote_subfolder</span> <span class="ow">in</span> <span class="n">list_of_dirs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">retrieved_subfolder</span> <span class="ow">in</span> <span class="n">list_of_dirs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;tmp1&#39;</span> <span class="ow">in</span> <span class="n">list_of_dirs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;tmp3&#39;</span> <span class="ow">in</span> <span class="n">list_of_dirs</span><span class="p">)</span>

                <span class="n">list_pushed_file</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;tmp2&#39;</span><span class="p">)</span>
                <span class="n">list_retrieved_file</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;tmp3&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;file.txt&#39;</span> <span class="ow">in</span> <span class="n">list_pushed_file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;file.txt&#39;</span> <span class="ow">in</span> <span class="n">list_retrieved_file</span><span class="p">)</span>

            <span class="kn">import</span> <span class="nn">shutil</span>

            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">local_subfolder</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">retrieved_subfolder</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">remote_subfolder</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestPutGetTree.test_put_and_get_overwrite"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestPutGetTree.test_put_and_get_overwrite">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_put_and_get_overwrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">shutil</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">import</span> <span class="nn">string</span>

        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
        <span class="n">remote_dir</span> <span class="o">=</span> <span class="n">local_dir</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;tmp_try&#39;</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">remote_dir</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">)):</span>
                <span class="c1"># I append a random letter/number until it is unique</span>
                <span class="n">directory</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>

            <span class="n">local_subfolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;tmp1&#39;</span><span class="p">)</span>
            <span class="n">remote_subfolder</span> <span class="o">=</span> <span class="s1">&#39;tmp2&#39;</span>
            <span class="n">retrieved_subfolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;tmp3&#39;</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">local_subfolder</span><span class="p">))</span>

            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

            <span class="n">local_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_subfolder</span><span class="p">,</span> <span class="s1">&#39;file.txt&#39;</span><span class="p">)</span>

            <span class="n">text</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;Viva Verdi</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">local_file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
                <span class="n">fhandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local_subfolder</span><span class="p">,</span> <span class="n">remote_subfolder</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remote_subfolder</span><span class="p">,</span> <span class="n">retrieved_subfolder</span><span class="p">)</span>

            <span class="c1"># by defaults rewrite everything</span>
            <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local_subfolder</span><span class="p">,</span> <span class="n">remote_subfolder</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remote_subfolder</span><span class="p">,</span> <span class="n">retrieved_subfolder</span><span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local_subfolder</span><span class="p">,</span> <span class="n">remote_subfolder</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remote_subfolder</span><span class="p">,</span> <span class="n">retrieved_subfolder</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">puttree</span><span class="p">(</span><span class="n">local_subfolder</span><span class="p">,</span> <span class="n">remote_subfolder</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">gettree</span><span class="p">(</span><span class="n">remote_subfolder</span><span class="p">,</span> <span class="n">retrieved_subfolder</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">local_subfolder</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">retrieved_subfolder</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">remote_subfolder</span><span class="p">)</span>
            <span class="c1"># t.rmtree(remote_subfolder)</span>
            <span class="c1"># here I am mixing inevitably the local and the remote folder</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestPutGetTree.test_copy"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestPutGetTree.test_copy">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">import</span> <span class="nn">string</span>

        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
        <span class="n">remote_dir</span> <span class="o">=</span> <span class="n">local_dir</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;tmp_try&#39;</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">remote_dir</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">)):</span>
                <span class="c1"># I append a random letter/number until it is unique</span>
                <span class="n">directory</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

            <span class="n">local_base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">local_base_dir</span><span class="p">)</span>

            <span class="c1"># first test put: I create three files in local</span>
            <span class="n">file_1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_base_dir</span><span class="p">,</span> <span class="s1">&#39;a.txt&#39;</span><span class="p">)</span>
            <span class="n">file_2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_base_dir</span><span class="p">,</span> <span class="s1">&#39;b.tmp&#39;</span><span class="p">)</span>
            <span class="n">file_3</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_base_dir</span><span class="p">,</span> <span class="s1">&#39;c.txt&#39;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;Viva Verdi</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="p">[</span><span class="n">file_1</span><span class="p">,</span> <span class="n">file_2</span><span class="p">,</span> <span class="n">file_3</span><span class="p">]:</span>
                <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
                    <span class="n">fhandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="c1"># first test the copy. Copy of two files matching patterns, into a folder</span>
            <span class="n">t</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;*.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;a.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;c.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;a.txt&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;c.txt&#39;</span><span class="p">)</span>
            <span class="c1"># second test copy. Copy of two folders</span>
            <span class="n">t</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;prova&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;a.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;b.tmp&#39;</span><span class="p">,</span> <span class="s1">&#39;c.txt&#39;</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">)))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="c1"># third test copy. Can copy one file into a new file</span>
            <span class="n">t</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;*.tmp&#39;</span><span class="p">),</span> <span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;prova&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="c1"># fourth test copy: can&#39;t copy more than one file on the same file,</span>
            <span class="c1"># i.e., the destination should be a folder</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;*.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="c1"># fifth test, copying one file into a folder</span>
            <span class="n">t</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;a.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">)),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;a.txt&#39;</span><span class="p">]))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="c1"># sixth test, copying one file into a file</span>
            <span class="n">t</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;a.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="c1"># copy of folder into an existing folder</span>
            <span class="c1">#NOTE: the command cp has a different behavior on Mac vs Ubuntu</span>
            <span class="c1">#tests performed locally on a Mac may result in a failure.</span>
            <span class="n">t</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;local&#39;</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;a.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;b.tmp&#39;</span><span class="p">,</span> <span class="s1">&#39;c.txt&#39;</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">))))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="c1"># exit</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestPutGetTree.test_put"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestPutGetTree.test_put">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="c1"># exactly the same tests of copy, just with the put function</span>
        <span class="c1"># and therefore the local path must be absolute</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">import</span> <span class="nn">string</span>

        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
        <span class="n">remote_dir</span> <span class="o">=</span> <span class="n">local_dir</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;tmp_try&#39;</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">remote_dir</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">)):</span>
                <span class="c1"># I append a random letter/number until it is unique</span>
                <span class="n">directory</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

            <span class="n">local_base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">local_base_dir</span><span class="p">)</span>

            <span class="c1"># first test put: I create three files in local</span>
            <span class="n">file_1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_base_dir</span><span class="p">,</span> <span class="s1">&#39;a.txt&#39;</span><span class="p">)</span>
            <span class="n">file_2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_base_dir</span><span class="p">,</span> <span class="s1">&#39;b.tmp&#39;</span><span class="p">)</span>
            <span class="n">file_3</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_base_dir</span><span class="p">,</span> <span class="s1">&#39;c.txt&#39;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;Viva Verdi</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="p">[</span><span class="n">file_1</span><span class="p">,</span> <span class="n">file_2</span><span class="p">,</span> <span class="n">file_3</span><span class="p">]:</span>
                <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
                    <span class="n">fhandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="c1"># first test put. Copy of two files matching patterns, into a folder</span>
            <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_base_dir</span><span class="p">,</span> <span class="s1">&#39;*.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;a.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;c.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;a.txt&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;c.txt&#39;</span><span class="p">)</span>
            <span class="c1"># second. Copy of folder into a non existing folder</span>
            <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local_base_dir</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;prova&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;a.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;b.tmp&#39;</span><span class="p">,</span> <span class="s1">&#39;c.txt&#39;</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">)))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="c1"># third. copy of folder into an existing folder</span>
            <span class="n">t</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local_base_dir</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;prova&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;local&#39;</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;a.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;b.tmp&#39;</span><span class="p">,</span> <span class="s1">&#39;c.txt&#39;</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">))))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="c1"># third test copy. Can copy one file into a new file</span>
            <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_base_dir</span><span class="p">,</span> <span class="s1">&#39;*.tmp&#39;</span><span class="p">),</span> <span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;prova&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="c1"># fourth test copy: can&#39;t copy more than one file on the same file,</span>
            <span class="c1"># i.e., the destination should be a folder</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_base_dir</span><span class="p">,</span> <span class="s1">&#39;*.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="c1"># copy of folder into file</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;existing.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
                <span class="n">fhandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_base_dir</span><span class="p">),</span> <span class="s1">&#39;existing.txt&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;existing.txt&#39;</span><span class="p">)</span>
            <span class="c1"># fifth test, copying one file into a folder</span>
            <span class="n">t</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_base_dir</span><span class="p">,</span> <span class="s1">&#39;a.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">)),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;a.txt&#39;</span><span class="p">]))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="c1"># sixth test, copying one file into a file</span>
            <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_base_dir</span><span class="p">,</span> <span class="s1">&#39;a.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;prova&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;prova&#39;</span><span class="p">)</span>

            <span class="c1"># exit</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestPutGetTree.test_get"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestPutGetTree.test_get">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="c1"># exactly the same tests of copy, just with the put function</span>
        <span class="c1"># and therefore the local path must be absolute</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">import</span> <span class="nn">string</span><span class="o">,</span> <span class="nn">shutil</span>

        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
        <span class="n">remote_dir</span> <span class="o">=</span> <span class="n">local_dir</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;tmp_try&#39;</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">remote_dir</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">)):</span>
                <span class="c1"># I append a random letter/number until it is unique</span>
                <span class="n">directory</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

            <span class="n">local_base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">)</span>
            <span class="n">local_destination</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">local_base_dir</span><span class="p">)</span>

            <span class="c1"># first test put: I create three files in local</span>
            <span class="n">file_1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_base_dir</span><span class="p">,</span> <span class="s1">&#39;a.txt&#39;</span><span class="p">)</span>
            <span class="n">file_2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_base_dir</span><span class="p">,</span> <span class="s1">&#39;b.tmp&#39;</span><span class="p">)</span>
            <span class="n">file_3</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_base_dir</span><span class="p">,</span> <span class="s1">&#39;c.txt&#39;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;Viva Verdi</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="p">[</span><span class="n">file_1</span><span class="p">,</span> <span class="n">file_2</span><span class="p">,</span> <span class="n">file_3</span><span class="p">]:</span>
                <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
                    <span class="n">fhandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="c1"># first test put. Copy of two files matching patterns, into a folder</span>
            <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;*.txt&#39;</span><span class="p">),</span> <span class="n">local_destination</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;a.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;c.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">local_destination</span><span class="p">)))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;a.txt&#39;</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;c.txt&#39;</span><span class="p">))</span>
            <span class="c1"># second. Copy of folder into a non existing folder</span>
            <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;prova&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">local_destination</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;a.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;b.tmp&#39;</span><span class="p">,</span> <span class="s1">&#39;c.txt&#39;</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">))))</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">))</span>
            <span class="c1"># third. copy of folder into an existing folder</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;prova&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">local_destination</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;local&#39;</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">))))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;a.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;b.tmp&#39;</span><span class="p">,</span> <span class="s1">&#39;c.txt&#39;</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">))))</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">))</span>
            <span class="c1"># third test copy. Can copy one file into a new file</span>
            <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;*.tmp&#39;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;prova&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">local_destination</span><span class="p">)))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">))</span>
            <span class="c1"># fourth test copy: can&#39;t copy more than one file on the same file,</span>
            <span class="c1"># i.e., the destination should be a folder</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;*.txt&#39;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">))</span>
            <span class="c1"># copy of folder into file</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;existing.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
                <span class="n">fhandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;existing.txt&#39;</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;existing.txt&#39;</span><span class="p">))</span>
            <span class="c1"># fifth test, copying one file into a folder</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;a.txt&#39;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">))),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;a.txt&#39;</span><span class="p">]))</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">))</span>
            <span class="c1"># sixth test, copying one file into a file</span>
            <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;a.txt&#39;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">)))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="s1">&#39;prova&#39;</span><span class="p">))</span>

            <span class="c1"># exit</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestPutGetTree.test_put_get_abs_path"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestPutGetTree.test_put_get_abs_path">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_put_get_abs_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        test of exception for non existing files and abs path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">import</span> <span class="nn">string</span>

        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
        <span class="n">remote_dir</span> <span class="o">=</span> <span class="n">local_dir</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;tmp_try&#39;</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">remote_dir</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">)):</span>
                <span class="c1"># I append a random letter/number until it is unique</span>
                <span class="n">directory</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>

            <span class="n">local_subfolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;tmp1&#39;</span><span class="p">)</span>
            <span class="n">remote_subfolder</span> <span class="o">=</span> <span class="s1">&#39;tmp2&#39;</span>
            <span class="n">retrieved_subfolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;tmp3&#39;</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">local_subfolder</span><span class="p">))</span>

            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">local_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_subfolder</span><span class="p">,</span> <span class="s1">&#39;file.txt&#39;</span><span class="p">)</span>

            <span class="n">fhandle</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">local_file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
            <span class="n">fhandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># &#39;tmp1&#39; is not an abs path</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;tmp1&#39;</span><span class="p">,</span> <span class="n">remote_subfolder</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">putfile</span><span class="p">(</span><span class="s1">&#39;tmp1&#39;</span><span class="p">,</span> <span class="n">remote_subfolder</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">puttree</span><span class="p">(</span><span class="s1">&#39;tmp1&#39;</span><span class="p">,</span> <span class="n">remote_subfolder</span><span class="p">)</span>

            <span class="c1"># &#39;tmp3&#39; does not exist</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">retrieved_subfolder</span><span class="p">,</span> <span class="n">remote_subfolder</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">putfile</span><span class="p">(</span><span class="n">retrieved_subfolder</span><span class="p">,</span> <span class="n">remote_subfolder</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">puttree</span><span class="p">(</span><span class="n">retrieved_subfolder</span><span class="p">,</span> <span class="n">remote_subfolder</span><span class="p">)</span>

            <span class="c1"># remote_file_name does not exist</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">IOError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;non_existing&#39;</span><span class="p">,</span> <span class="n">retrieved_subfolder</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">IOError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="s1">&#39;non_existing&#39;</span><span class="p">,</span> <span class="n">retrieved_subfolder</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">IOError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">gettree</span><span class="p">(</span><span class="s1">&#39;non_existing&#39;</span><span class="p">,</span> <span class="n">retrieved_subfolder</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local_subfolder</span><span class="p">,</span> <span class="n">remote_subfolder</span><span class="p">)</span>

            <span class="c1"># local filename is not an abs path</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remote_subfolder</span><span class="p">,</span> <span class="s1">&#39;delete_me_tree&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">remote_subfolder</span><span class="p">,</span> <span class="s1">&#39;delete_me_tree&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">gettree</span><span class="p">(</span><span class="n">remote_subfolder</span><span class="p">,</span> <span class="s1">&#39;delete_me_tree&#39;</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_subfolder</span><span class="p">,</span> <span class="s1">&#39;file.txt&#39;</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">local_subfolder</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">remote_subfolder</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestPutGetTree.test_put_get_empty_string"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestPutGetTree.test_put_get_empty_string">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_put_get_empty_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        test of exception put/get of empty strings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO : verify the correctness of \n at the end of a file</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">import</span> <span class="nn">string</span>

        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
        <span class="n">remote_dir</span> <span class="o">=</span> <span class="n">local_dir</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;tmp_try&#39;</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">remote_dir</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">)):</span>
                <span class="c1"># I append a random letter/number until it is unique</span>
                <span class="n">directory</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>

            <span class="n">local_subfolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;tmp1&#39;</span><span class="p">)</span>
            <span class="n">remote_subfolder</span> <span class="o">=</span> <span class="s1">&#39;tmp2&#39;</span>
            <span class="n">retrieved_subfolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;tmp3&#39;</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">local_subfolder</span><span class="p">))</span>

            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">local_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_subfolder</span><span class="p">,</span> <span class="s1">&#39;file.txt&#39;</span><span class="p">)</span>

            <span class="n">text</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;Viva Verdi</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">local_file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
                <span class="n">fhandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="c1"># localpath is an empty string</span>
            <span class="c1"># ValueError because it is not an abs path</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">puttree</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">remote_subfolder</span><span class="p">)</span>

            <span class="c1"># remote path is an empty string</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">IOError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">puttree</span><span class="p">(</span><span class="n">local_subfolder</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">puttree</span><span class="p">(</span><span class="n">local_subfolder</span><span class="p">,</span> <span class="n">remote_subfolder</span><span class="p">)</span>

            <span class="c1"># remote path is an empty string</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">IOError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">gettree</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">retrieved_subfolder</span><span class="p">)</span>

            <span class="c1"># local path is an empty string</span>
            <span class="c1"># ValueError because it is not an abs path</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">gettree</span><span class="p">(</span><span class="n">remote_subfolder</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="c1"># TODO : get doesn&#39;t retrieve empty files.</span>
            <span class="c1"># Is it what we want?</span>
            <span class="n">t</span><span class="o">.</span><span class="n">gettree</span><span class="p">(</span><span class="n">remote_subfolder</span><span class="p">,</span> <span class="n">retrieved_subfolder</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_subfolder</span><span class="p">,</span> <span class="s1">&#39;file.txt&#39;</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">local_subfolder</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_subfolder</span><span class="p">,</span> <span class="s1">&#39;file.txt&#39;</span><span class="p">))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">remote_subfolder</span><span class="p">)</span>
            <span class="c1"># If it couldn&#39;t end the copy, it leaves what he did on local file</span>
            <span class="c1"># here I am mixing local with remote</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;file.txt&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;tmp3&#39;</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">retrieved_subfolder</span><span class="p">,</span> <span class="s1">&#39;file.txt&#39;</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">retrieved_subfolder</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestExecuteCommandWait"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestExecuteCommandWait">[docs]</a><span class="k">class</span> <span class="nc">TestExecuteCommandWait</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test some simple command executions and stdin/stdout management.</span>

<span class="sd">    It also checks for escaping of the folder names.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestExecuteCommandWait.test_exec_pwd"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestExecuteCommandWait.test_exec_pwd">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_exec_pwd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        I create a strange subfolder with a complicated name and</span>
<span class="sd">        then see if I can run pwd. This also checks the correct</span>
<span class="sd">        escaping of funny characters, both in the directory</span>
<span class="sd">        creation (which should be done by paramiko) and in the command</span>
<span class="sd">        execution (done in this module, in the _exec_command_internal function).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="c1"># Start value</span>
        <span class="n">delete_at_end</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>

            <span class="c1"># To compare with: getcwd uses the normalized (&#39;realpath&#39;) path</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;/tmp&#39;</span><span class="p">)</span>
            <span class="n">subfolder</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;_&#39;s f&quot;#&quot;&quot;&quot;</span>  <span class="c1"># A folder with characters to escape</span>
            <span class="n">subfolder_fullpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">subfolder</span><span class="p">)</span>

            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">subfolder</span><span class="p">):</span>
                <span class="c1"># Since I created the folder, I will remember to</span>
                <span class="c1"># delete it at the end of this test</span>
                <span class="n">delete_at_end</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">t</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">subfolder</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">subfolder</span><span class="p">))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">subfolder</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">subfolder_fullpath</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
            <span class="n">retcode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">exec_command_wait</span><span class="p">(</span><span class="s1">&#39;pwd&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">retcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># I have to strip it because &#39;pwd&#39; returns a trailing \n</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">subfolder_fullpath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">delete_at_end</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
                <span class="n">t</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">subfolder</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestExecuteCommandWait.test_exec_with_stdin_string"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestExecuteCommandWait.test_exec_with_stdin_string">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_exec_with_stdin_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="n">test_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;some_test String&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">retcode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">exec_command_wait</span><span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">test_string</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">retcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">test_string</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestExecuteCommandWait.test_exec_with_stdin_unicode"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestExecuteCommandWait.test_exec_with_stdin_unicode">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_exec_with_stdin_unicode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="n">test_string</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;some_test String&quot;</span>
        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">retcode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">exec_command_wait</span><span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">test_string</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">retcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">test_string</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestExecuteCommandWait.test_exec_with_stdin_filelike"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestExecuteCommandWait.test_exec_with_stdin_filelike">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_exec_with_stdin_filelike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="n">cStringIO</span> <span class="k">as</span> <span class="n">StringIO</span>

        <span class="n">test_string</span> <span class="o">=</span> <span class="s2">&quot;some_test String&quot;</span>
        <span class="n">stdin</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">test_string</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">retcode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">exec_command_wait</span><span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">retcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">test_string</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestExecuteCommandWait.test_exec_with_wrong_stdin"><a class="viewcode-back" href="../../../../apidoc/aiida.transports.plugins.html#aiida.transports.plugins.test_all_plugins.TestExecuteCommandWait.test_exec_with_wrong_stdin">[docs]</a>    <span class="nd">@run_for_all_plugins</span>
    <span class="k">def</span> <span class="nf">test_exec_with_wrong_stdin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_transport</span><span class="p">):</span>
        <span class="c1"># I pass a number</span>
        <span class="k">with</span> <span class="n">custom_transport</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">exec_command_wait</span><span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>