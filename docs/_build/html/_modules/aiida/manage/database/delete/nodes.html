

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.manage.database.delete.nodes &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.manage.database.delete.nodes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.manage.database.delete.nodes</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;Function to delete nodes from the database.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="nb">zip</span>

<span class="kn">import</span> <span class="nn">click</span>

<span class="kn">from</span> <span class="nn">aiida.cmdline.utils</span> <span class="k">import</span> <span class="n">echo</span>


<div class="viewcode-block" id="delete_nodes"><a class="viewcode-back" href="../../../../../apidoc/aiida.manage.database.delete.html#aiida.manage.database.delete.nodes.delete_nodes">[docs]</a><span class="k">def</span> <span class="nf">delete_nodes</span><span class="p">(</span><span class="n">pks</span><span class="p">,</span>
                 <span class="n">follow_calls</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">follow_returns</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">disable_checks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete nodes by a list of pks</span>

<span class="sd">    :note: The script will also delete all children calculations generated from the specified nodes.</span>

<span class="sd">    :param pks: a list of the PKs of the nodes to delete</span>
<span class="sd">    :param bool follow_calls: Follow calls</span>
<span class="sd">    :param bool follow_returns:</span>
<span class="sd">        Follow returns. This is a very dangerous option, since anything returned by a workflow might have</span>
<span class="sd">        been used as input in many other calculations. Use with care, and never combine with force.</span>
<span class="sd">    :param bool dry_run: Do not delete, a dry run, with statistics printed according to verbosity levels.</span>
<span class="sd">    :param bool force: Do not ask for confirmation to delete nodes.</span>
<span class="sd">    :param bool disable_checks:</span>
<span class="sd">        If True, will not check whether calculations are losing created data or called instances.</span>
<span class="sd">        If checks are disabled, also logging is disabled.</span>
<span class="sd">    :param bool force: Do not ask for confirmation to delete nodes.</span>
<span class="sd">    :param int verbosity:</span>
<span class="sd">        The verbosity levels, 0 prints nothing, 1 prints just sums and total, 2 prints individual nodes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=too-many-arguments,too-many-branches,too-many-locals,too-many-statements</span>
    <span class="kn">from</span> <span class="nn">aiida.backends.utils</span> <span class="k">import</span> <span class="n">delete_nodes_and_connections</span>
    <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">exceptions</span>
    <span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>
    <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="k">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">,</span> <span class="n">Data</span><span class="p">,</span> <span class="n">QueryBuilder</span><span class="p">,</span> <span class="n">load_node</span>

    <span class="n">user_email</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_default</span><span class="p">()</span><span class="o">.</span><span class="n">email</span>

    <span class="n">starting_pks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">pks</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">load_node</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NotExistent</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo_warning</span><span class="p">(</span><span class="s1">&#39;warning: node with pk&lt;</span><span class="si">{}</span><span class="s1">&gt; does not exist, skipping&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pk</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">starting_pks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">starting_pks</span><span class="p">:</span>
        <span class="c1"># I prefer checking explicitly, an empty set might be problematic for the queries done below.</span>
        <span class="k">if</span> <span class="n">verbosity</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;Nothing to delete&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># The following code is just for the querying of downwards provenance.</span>
    <span class="c1"># Ideally, there should be a module to interface with, but this is the solution for now.</span>
    <span class="c1"># By only dealing with ids, and keeping track of what has been already</span>
    <span class="c1"># visited in the query, there&#39;s good performance and no infinite loops.</span>
    <span class="n">link_types_to_follow</span> <span class="o">=</span> <span class="p">[</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_WORK</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">follow_calls</span><span class="p">:</span>
        <span class="n">link_types_to_follow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_CALC</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">link_types_to_follow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">follow_returns</span><span class="p">:</span>
        <span class="n">link_types_to_follow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="n">edge_filters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">link_types_to_follow</span><span class="p">}}</span>

    <span class="c1"># Operational set always includes the recently (in the last iteration added) nodes.</span>
    <span class="n">operational_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">starting_pks</span><span class="p">))</span>  <span class="c1"># Union to copy the set!</span>
    <span class="n">pks_set_to_delete</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">starting_pks</span><span class="p">))</span>
    <span class="k">while</span> <span class="n">operational_set</span><span class="p">:</span>
        <span class="c1"># new_pks_set are the the pks of all nodes that are connected to the operational node set</span>
        <span class="c1"># with the links specified.</span>
        <span class="n">new_pks_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="ow">in</span> <span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">operational_set</span>
            <span class="p">}</span>
        <span class="p">})</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">edge_filters</span><span class="o">=</span><span class="n">edge_filters</span><span class="p">)</span><span class="o">.</span><span class="n">iterall</span><span class="p">())</span>
        <span class="c1"># The operational set is only those pks that haven&#39;t been yet put into the pks_set_to_delete.</span>
        <span class="n">operational_set</span> <span class="o">=</span> <span class="n">new_pks_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">pks_set_to_delete</span><span class="p">)</span>

        <span class="c1"># I add these pks in the pks_set_to_delete with a union</span>
        <span class="n">pks_set_to_delete</span> <span class="o">=</span> <span class="n">pks_set_to_delete</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">new_pks_set</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;I </span><span class="si">{}</span><span class="s2"> delete </span><span class="si">{}</span><span class="s2"> node</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;would&#39;</span> <span class="k">if</span> <span class="n">dry_run</span> <span class="k">else</span> <span class="s1">&#39;will&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pks_set_to_delete</span><span class="p">),</span>
                                                 <span class="s1">&#39;s&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pks_set_to_delete</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">pks_set_to_delete</span>
                <span class="p">}},</span> <span class="n">project</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;node_type&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">))</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;The nodes I </span><span class="si">{}</span><span class="s2"> delete:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;would&#39;</span> <span class="k">if</span> <span class="n">dry_run</span> <span class="k">else</span> <span class="s1">&#39;will&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">type_string</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">builder</span><span class="o">.</span><span class="n">iterall</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">short_type_string</span> <span class="o">=</span> <span class="n">type_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="n">short_type_string</span> <span class="o">=</span> <span class="n">type_string</span>
                <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;   </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">short_type_string</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>

    <span class="c1"># Here I am checking whether I am deleting</span>
    <span class="c1"># A data instance without also deleting the creator, which brakes relationship between a calculation and its data</span>
    <span class="c1"># A calculation instance that was called, without also deleting the caller.</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">disable_checks</span><span class="p">:</span>
        <span class="n">link_types_to_follow</span> <span class="o">=</span> <span class="p">[</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_CALC</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
        <span class="n">called_qb</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">called_qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ProcessNode</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;!in&#39;</span><span class="p">:</span> <span class="n">pks_set_to_delete</span><span class="p">}},</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="n">called_qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">ProcessNode</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="s1">&#39;node_type&#39;</span><span class="p">,</span>
            <span class="n">edge_project</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">pks_set_to_delete</span>
            <span class="p">}},</span>
            <span class="n">edge_filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">link_types_to_follow</span>
            <span class="p">}})</span>
        <span class="n">caller_to_called2delete</span> <span class="o">=</span> <span class="n">called_qb</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">caller_to_called2delete</span><span class="p">:</span>
            <span class="n">calculation_pks_losing_called</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">caller_to_called2delete</span><span class="p">)))</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{}</span><span class="s2"> calculation</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> lose at least one called instance&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">calculation_pks_losing_called</span><span class="p">),</span> <span class="s1">&#39;s&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">calculation_pks_losing_called</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;would&#39;</span> <span class="k">if</span> <span class="n">dry_run</span> <span class="k">else</span> <span class="s1">&#39;will&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span>
                    <span class="s2">&quot;These are the calculations that </span><span class="si">{}</span><span class="s2"> lose a called instance:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;would&#39;</span> <span class="k">if</span> <span class="n">dry_run</span> <span class="k">else</span> <span class="s1">&#39;will&#39;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">calc_losing_called_pk</span> <span class="ow">in</span> <span class="n">calculation_pks_losing_called</span><span class="p">:</span>
                    <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">load_node</span><span class="p">(</span><span class="n">calc_losing_called_pk</span><span class="p">))</span>

        <span class="n">created_qb</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">created_qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ProcessNode</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;!in&#39;</span><span class="p">:</span> <span class="n">pks_set_to_delete</span><span class="p">}},</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="n">created_qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">Data</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="s1">&#39;node_type&#39;</span><span class="p">,</span>
            <span class="n">edge_project</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="n">pks_set_to_delete</span>
            <span class="p">}},</span>
            <span class="n">edge_filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;==&#39;</span><span class="p">:</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="o">.</span><span class="n">value</span>
            <span class="p">}})</span>

        <span class="n">creator_to_created2delete</span> <span class="o">=</span> <span class="n">created_qb</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">creator_to_created2delete</span><span class="p">:</span>
            <span class="n">calculation_pks_losing_created</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">creator_to_created2delete</span><span class="p">)))</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{}</span><span class="s2"> calculation</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> lose at least one created data-instance&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">calculation_pks_losing_created</span><span class="p">),</span> <span class="s1">&#39;s&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">calculation_pks_losing_created</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;would&#39;</span> <span class="k">if</span> <span class="n">dry_run</span> <span class="k">else</span> <span class="s1">&#39;will&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;These are the calculations that </span><span class="si">{}</span><span class="s2"> lose a created data-instance:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s1">&#39;would&#39;</span> <span class="k">if</span> <span class="n">dry_run</span> <span class="k">else</span> <span class="s1">&#39;will&#39;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">calc_losing_created_pk</span> <span class="ow">in</span> <span class="n">calculation_pks_losing_created</span><span class="p">:</span>
                    <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">load_node</span><span class="p">(</span><span class="n">calc_losing_created_pk</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">This was a dry run, exiting without deleting anything&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Asking for user confirmation here</span>
    <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">echo</span><span class="o">.</span><span class="n">echo_warning</span><span class="p">(</span><span class="s2">&quot;YOU ARE ABOUT TO DELETE </span><span class="si">{}</span><span class="s2"> NODES! THIS CANNOT BE UNDONE!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pks_set_to_delete</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">click</span><span class="o">.</span><span class="n">confirm</span><span class="p">(</span><span class="s2">&quot;Shall I continue?&quot;</span><span class="p">):</span>
            <span class="n">echo</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;Exiting without deleting&quot;</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="c1"># Recover the list of folders to delete before actually deleting the nodes. I will delete the folders only later,</span>
    <span class="c1"># so that if there is a problem during the deletion of the nodes in the DB, I don&#39;t delete the folders</span>
    <span class="n">repositories</span> <span class="o">=</span> <span class="p">[</span><span class="n">load_node</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">_repository</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">pks_set_to_delete</span><span class="p">]</span>  <span class="c1"># pylint: disable=protected-access</span>

    <span class="n">delete_nodes_and_connections</span><span class="p">(</span><span class="n">pks_set_to_delete</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">disable_checks</span><span class="p">:</span>
        <span class="c1"># I pass now to the log the information for calculations losing created data or called instances</span>
        <span class="k">for</span> <span class="n">calc_pk</span><span class="p">,</span> <span class="n">calc_type_string</span><span class="p">,</span> <span class="n">link_label</span> <span class="ow">in</span> <span class="n">caller_to_called2delete</span><span class="p">:</span>
            <span class="n">calc</span> <span class="o">=</span> <span class="n">load_node</span><span class="p">(</span><span class="n">calc_pk</span><span class="p">)</span>
            <span class="n">calc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;User </span><span class="si">{}</span><span class="s2"> deleted &quot;</span>
                                <span class="s2">&quot;an instance of type </span><span class="si">{}</span><span class="s2"> &quot;</span>
                                <span class="s2">&quot;called with the label </span><span class="si">{}</span><span class="s2"> &quot;</span>
                                <span class="s2">&quot;by this calculation&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_email</span><span class="p">,</span> <span class="n">calc_type_string</span><span class="p">,</span> <span class="n">link_label</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">calc_pk</span><span class="p">,</span> <span class="n">data_type_string</span><span class="p">,</span> <span class="n">link_label</span> <span class="ow">in</span> <span class="n">creator_to_created2delete</span><span class="p">:</span>
            <span class="n">calc</span> <span class="o">=</span> <span class="n">load_node</span><span class="p">(</span><span class="n">calc_pk</span><span class="p">)</span>
            <span class="n">calc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;User </span><span class="si">{}</span><span class="s2"> deleted &quot;</span>
                                <span class="s2">&quot;an instance of type </span><span class="si">{}</span><span class="s2"> &quot;</span>
                                <span class="s2">&quot;created with the label </span><span class="si">{}</span><span class="s2"> &quot;</span>
                                <span class="s2">&quot;by this calculation&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_email</span><span class="p">,</span> <span class="n">data_type_string</span><span class="p">,</span> <span class="n">link_label</span><span class="p">))</span>

    <span class="c1"># If we are here, we managed to delete the entries from the DB.</span>
    <span class="c1"># I can now delete the folders</span>
    <span class="k">for</span> <span class="n">repository</span> <span class="ow">in</span> <span class="n">repositories</span><span class="p">:</span>
        <span class="n">repository</span><span class="o">.</span><span class="n">erase</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>