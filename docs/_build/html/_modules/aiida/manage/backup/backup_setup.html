

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.manage.backup.backup_setup &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.manage.backup.backup_setup</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.manage.backup.backup_setup</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;Class to backup an AiiDA instance profile.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">aiida.backends</span> <span class="k">import</span> <span class="n">BACKEND_DJANGO</span><span class="p">,</span> <span class="n">BACKEND_SQLA</span>
<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="nn">aiida.manage</span> <span class="k">import</span> <span class="n">configuration</span>
<span class="kn">from</span> <span class="nn">aiida.manage.backup.backup_base</span> <span class="k">import</span> <span class="n">AbstractBackup</span><span class="p">,</span> <span class="n">BackupError</span>
<span class="kn">from</span> <span class="nn">aiida.manage.configuration.settings</span> <span class="k">import</span> <span class="n">AIIDA_CONFIG_FOLDER</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">backup_utils</span> <span class="k">as</span> <span class="n">utils</span>


<div class="viewcode-block" id="BackupSetup"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.backends.tests.test_backup_script.BackupSetup">[docs]</a><span class="k">class</span> <span class="nc">BackupSetup</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  <span class="c1"># pylint: disable=useless-object-inheritance</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class setups the main backup script related information &amp; files like::</span>

<span class="sd">        - the backup parameter file. It also allows the user to set it up by answering questions.</span>
<span class="sd">        - the backup folders.</span>
<span class="sd">        - the script that initiates the backup.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="BackupSetup.__init__"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.backends.tests.test_backup_script.BackupSetup.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The backup directory names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conf_backup_folder_rel</span> <span class="o">=</span> <span class="s2">&quot;backup_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">PROFILE</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_backup_folder_rel</span> <span class="o">=</span> <span class="s2">&quot;backup_dest&quot;</span>

        <span class="c1"># The backup configuration file (&amp; template) names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backup_info_filename</span> <span class="o">=</span> <span class="s2">&quot;backup_info.json&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backup_info_tmpl_filename</span> <span class="o">=</span> <span class="s2">&quot;backup_info.json.tmpl&quot;</span>

        <span class="c1"># The name of the script that initiates the backup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_script_filename</span> <span class="o">=</span> <span class="s2">&quot;start_backup.py&quot;</span>

        <span class="c1"># Configuring the logging</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(name)-12s</span><span class="s1"> </span><span class="si">%(levelname)-8s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># The logger of the backup script</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;aiida_backup_setup&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BackupSetup.construct_backup_variables"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.backends.tests.test_backup_script.BackupSetup.construct_backup_variables">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">construct_backup_variables</span><span class="p">(</span><span class="n">file_backup_folder_abs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct backup variables.&quot;&quot;&quot;</span>
        <span class="n">backup_variables</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Setting the oldest backup timestamp</span>
        <span class="n">oldest_object_bk</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ask_question</span><span class="p">(</span>
            <span class="s2">&quot;Please provide the oldest backup timestamp &quot;</span>
            <span class="s2">&quot;(e.g. 2014-07-18 13:54:53.688484+00:00). &quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">oldest_object_bk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">backup_variables</span><span class="p">[</span><span class="n">AbstractBackup</span><span class="o">.</span><span class="n">OLDEST_OBJECT_BK_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">backup_variables</span><span class="p">[</span><span class="n">AbstractBackup</span><span class="o">.</span><span class="n">OLDEST_OBJECT_BK_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">oldest_object_bk</span><span class="p">)</span>

        <span class="c1"># Setting the backup directory</span>
        <span class="n">backup_variables</span><span class="p">[</span><span class="n">AbstractBackup</span><span class="o">.</span><span class="n">BACKUP_DIR_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_backup_folder_abs</span>

        <span class="c1"># Setting the days_to_backup</span>
        <span class="n">backup_variables</span><span class="p">[</span><span class="n">AbstractBackup</span><span class="o">.</span><span class="n">DAYS_TO_BACKUP_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ask_question</span><span class="p">(</span>
            <span class="s2">&quot;Please provide the number of days to backup.&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Setting the end date</span>
        <span class="n">end_date_of_backup_key</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ask_question</span><span class="p">(</span>
            <span class="s2">&quot;Please provide the end date of the backup &quot;</span> <span class="o">+</span> <span class="s2">&quot;(e.g. 2014-07-18 13:54:53.688484+00:00).&quot;</span><span class="p">,</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end_date_of_backup_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">backup_variables</span><span class="p">[</span><span class="n">AbstractBackup</span><span class="o">.</span><span class="n">END_DATE_OF_BACKUP_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">backup_variables</span><span class="p">[</span><span class="n">AbstractBackup</span><span class="o">.</span><span class="n">END_DATE_OF_BACKUP_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_date_of_backup_key</span><span class="p">)</span>

        <span class="c1"># Setting the backup periodicity</span>
        <span class="n">backup_variables</span><span class="p">[</span><span class="n">AbstractBackup</span><span class="o">.</span><span class="n">PERIODICITY_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ask_question</span><span class="p">(</span><span class="s2">&quot;Please periodicity (in days).&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span>
                                                                              <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Setting the backup threshold</span>
        <span class="n">backup_variables</span><span class="p">[</span><span class="n">AbstractBackup</span><span class="o">.</span><span class="n">BACKUP_LENGTH_THRESHOLD_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ask_question</span><span class="p">(</span>
            <span class="s2">&quot;Please provide the backup threshold (in hours).&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">backup_variables</span></div>

<div class="viewcode-block" id="BackupSetup.create_dir"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.backends.tests.test_backup_script.BackupSetup.create_dir">[docs]</a>    <span class="k">def</span> <span class="nf">create_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the directories for the backup folder and return its path.&quot;&quot;&quot;</span>
        <span class="n">final_path</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">query_string</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">final_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">query_yes_no</span><span class="p">(</span><span class="s2">&quot;The path </span><span class="si">{}</span><span class="s2"> doesn&#39;t exist. Should it be created?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">final_path</span><span class="p">),</span> <span class="s2">&quot;yes&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">final_path</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error creating the path </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">final_path</span><span class="p">)</span>
                    <span class="k">raise</span>
        <span class="k">return</span> <span class="n">final_path</span></div>

<div class="viewcode-block" id="BackupSetup.print_info"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.backends.tests.test_backup_script.BackupSetup.print_info">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">print_info</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Write a string with information to stdout.&quot;&quot;&quot;</span>
        <span class="n">info_str</span> <span class="o">=</span> \
<span class="sd">&quot;&quot;&quot;Variables to set up in the JSON file</span>
<span class="sd">------------------------------------</span>

<span class="sd"> * ``periodicity`` (in days): The backup runs periodically for a number of days</span>
<span class="sd">   defined in the periodicity variable. The purpose of this variable is to limit</span>
<span class="sd">   the backup to run only on a few number of days and therefore to limit the</span>
<span class="sd">   number of files that are backed up at every round. e.g. ``&quot;periodicity&quot;: 2``</span>
<span class="sd">   Example: if you have files in the AiiDA repositories created in the past 30</span>
<span class="sd">   days, and periodicity is 15, the first run will backup the files of the first</span>
<span class="sd">   15 days; a second run of the script will backup the next 15 days, completing</span>
<span class="sd">   the backup (if it is run within the same day). Further runs will only backup</span>
<span class="sd">   newer files, if they are created.</span>

<span class="sd"> * ``oldest_object_backedup`` (timestamp or null): This is the timestamp of the</span>
<span class="sd">   oldest object that was backed up. If you are not aware of this value or if it</span>
<span class="sd">   is the first time that you start a backup up for this repository, then set</span>
<span class="sd">   this value to ``null``. Then the script will search the creation date of the</span>
<span class="sd">   oldest node object in the database and it will start</span>
<span class="sd">   the backup from that date. E.g. ``&quot;oldest_object_backedup&quot;:</span>
<span class="sd">   &quot;2015-07-20 11:13:08.145804+02:00&quot;``</span>

<span class="sd"> * ``end_date_of_backup``: If set, the backup script will backup files that</span>
<span class="sd">   have a modification date until the value specified by this variable. If not</span>
<span class="sd">   set, the ending of the backup will be set by the following variable</span>
<span class="sd">   (``days_to_backup``) which specifies how many days to backup from the start</span>
<span class="sd">   of the backup. If none of these variables are set (``end_date_of_backup``</span>
<span class="sd">   and ``days_to_backup``), then the end date of backup is set to the current</span>
<span class="sd">   date. E.g. ``&quot;end_date_of_backup&quot;: null`` or ``&quot;end_date_of_backup&quot;:</span>
<span class="sd">   &quot;2015-07-20 11:13:08.145804+02:00&quot;``</span>


<span class="sd"> * ``days_to_backup``: If set, you specify how many days you will backup from</span>
<span class="sd">   the starting date of your backup. If it set to ``null`` and also</span>
<span class="sd">   ``end_date_of_backup`` is set to ``null``, then the end date of the backup</span>
<span class="sd">   is set to the current date. You can not set ``days_to_backup``</span>
<span class="sd">   &amp; ``end_date_of_backup`` at the same time (it will lead to an error).</span>
<span class="sd">   E.g. ``&quot;days_to_backup&quot;: null`` or ``&quot;days_to_backup&quot;: 5``</span>

<span class="sd"> * ``backup_length_threshold`` (in hours): The backup script runs in rounds and</span>
<span class="sd">   on every round it backs-up a number of days that are controlled primarily by</span>
<span class="sd">   ``periodicity`` and also by ``end_date_of_backup`` / ``days_to_backup``,</span>
<span class="sd">   for the last backup round. The ``backup_length_threshold`` specifies the</span>
<span class="sd">   lowest acceptable round length. This is important for the end of the backup.</span>

<span class="sd"> * ``backup_dir``: The destination directory of the backup. e.g.</span>
<span class="sd">   ``&quot;backup_dir&quot;: &quot;/scratch/aiida_user/backup_script_dest&quot;``</span>
<span class="sd">&quot;&quot;&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">info_str</span><span class="p">)</span></div>

<div class="viewcode-block" id="BackupSetup.run"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.backends.tests.test_backup_script.BackupSetup.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the backup.&quot;&quot;&quot;</span>
        <span class="n">conf_backup_folder_abs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span>
            <span class="s2">&quot;Please provide the backup folder by providing the full path.&quot;</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">AIIDA_CONFIG_FOLDER</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf_backup_folder_rel</span><span class="p">))</span>

        <span class="n">file_backup_folder_abs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span>
            <span class="s2">&quot;Please provide the destination folder of the backup (normally in &quot;</span>
            <span class="s2">&quot;the previously provided backup folder).&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conf_backup_folder_abs</span><span class="p">,</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">_file_backup_folder_rel</span><span class="p">))</span>

        <span class="c1"># The template backup configuration file</span>
        <span class="n">template_conf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup_info_tmpl_filename</span><span class="p">)</span>

        <span class="c1"># Copy the sample configuration file to the backup folder</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">template_conf_path</span><span class="p">,</span> <span class="n">conf_backup_folder_abs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error copying the file </span><span class="si">%s</span><span class="s2"> to the directory </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">template_conf_path</span><span class="p">,</span>
                               <span class="n">conf_backup_folder_abs</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">query_yes_no</span><span class="p">(</span>
                <span class="s2">&quot;A sample configuration file was copied to </span><span class="si">{}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;Would you like to &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conf_backup_folder_abs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;see the configuration parameters explanation?&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_info</span><span class="p">()</span>

        <span class="c1"># Construct the path to the backup configuration file</span>
        <span class="n">final_conf_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conf_backup_folder_abs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup_info_filename</span><span class="p">)</span>

        <span class="c1"># If the backup parameters are configured now</span>
        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">query_yes_no</span><span class="p">(</span><span class="s2">&quot;Would you like to configure the backup &quot;</span> <span class="o">+</span> <span class="s2">&quot;configuration file now?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span><span class="p">):</span>

            <span class="c1"># Ask questions to properly setup the backup variables</span>
            <span class="n">backup_variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_backup_variables</span><span class="p">(</span><span class="n">file_backup_folder_abs</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">final_conf_filepath</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">backup_info_file</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">backup_variables</span><span class="p">,</span> <span class="n">backup_info_file</span><span class="p">)</span>
        <span class="c1"># If the backup parameters are configured manually</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Please rename the file </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backup_info_tmpl_filename</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s2">&quot;found in </span><span class="si">{}</span><span class="s2"> to &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conf_backup_folder_abs</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> and &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backup_info_filename</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s2">&quot;change the backup parameters accordingly.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Please adapt the startup script accordingly to point to the &quot;</span> <span class="o">+</span>
                             <span class="s2">&quot;correct backup configuration file. For the moment, it points &quot;</span> <span class="o">+</span>
                             <span class="s2">&quot;to </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conf_backup_folder_abs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup_info_filename</span><span class="p">)))</span>

        <span class="c1"># The contents of the startup script</span>
        <span class="k">if</span> <span class="n">configuration</span><span class="o">.</span><span class="n">PROFILE</span><span class="o">.</span><span class="n">database_backend</span> <span class="o">==</span> <span class="n">BACKEND_DJANGO</span><span class="p">:</span>
            <span class="n">backup_import</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;from aiida.manage.backup.backup_django import Backup&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">configuration</span><span class="o">.</span><span class="n">PROFILE</span><span class="o">.</span><span class="n">database_backend</span> <span class="o">==</span> <span class="n">BACKEND_SQLA</span><span class="p">:</span>
            <span class="n">backup_import</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;from aiida.manage.backup.backup_sqlalchemy import Backup&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BackupError</span><span class="p">(</span><span class="s2">&quot;Following backend is unknown: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">PROFILE</span><span class="o">.</span><span class="n">database_backend</span><span class="p">))</span>

        <span class="n">script_content</span> <span class="o">=</span> \
<span class="sa">u</span><span class="sd">&quot;&quot;&quot;#!/usr/bin/env python</span>
<span class="sd">import logging</span>
<span class="sd">from aiida.manage.configuration import load_profile</span>

<span class="sd">load_profile(profile=&#39;{}&#39;)</span>

<span class="sd">{}</span>

<span class="sd"># Create the backup instance</span>
<span class="sd">backup_inst = Backup(backup_info_filepath=&quot;{}&quot;, additional_back_time_mins = 2)</span>

<span class="sd"># Define the backup logging level</span>
<span class="sd">backup_inst._logger.setLevel(logging.INFO)</span>

<span class="sd"># Start the backup</span>
<span class="sd">backup_inst.run()</span>
<span class="sd">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">PROFILE</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">backup_import</span><span class="p">,</span> <span class="n">final_conf_filepath</span><span class="p">)</span>

        <span class="c1"># Script full path</span>
        <span class="n">script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conf_backup_folder_abs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_script_filename</span><span class="p">)</span>

        <span class="c1"># Write the contents to the script</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">script_file</span><span class="p">:</span>
            <span class="n">script_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">script_content</span><span class="p">)</span>

        <span class="c1"># Set the right permissions</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">statistics</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">script_path</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="n">statistics</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IEXEC</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Problem setting the right permissions to the script </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">script_path</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Backup setup completed.&quot;</span><span class="p">)</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">BackupSetup</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>