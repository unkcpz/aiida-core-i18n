

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.manage.backup.backup_base &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.manage.backup.backup_base</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.manage.backup.backup_base</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">abc</span> <span class="k">import</span> <span class="n">abstractmethod</span><span class="p">,</span> <span class="n">ABCMeta</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">dateutil.parser</span> <span class="k">import</span> <span class="n">parse</span>
<span class="kn">from</span> <span class="nn">pytz</span> <span class="k">import</span> <span class="n">timezone</span> <span class="k">as</span> <span class="n">ptimezone</span>

<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">timezone</span> <span class="k">as</span> <span class="n">dtimezone</span>
<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">json</span>


<div class="viewcode-block" id="AbstractBackup"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.manage.backup.backup_base.AbstractBackup">[docs]</a><span class="nd">@six</span><span class="o">.</span><span class="n">add_metaclass</span><span class="p">(</span><span class="n">ABCMeta</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">AbstractBackup</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class handles the backup of the AiiDA repository that is referenced</span>
<span class="sd">    by the current AiiDA database. The backup will start from the</span>
<span class="sd">    given backup timestamp (*oldest_object_backedup*) or the date of the</span>
<span class="sd">    oldest node/workflow object found and it will periodically backup</span>
<span class="sd">    (in periods of *periodicity* days) until the ending date of the backup</span>
<span class="sd">    specified by *end_date_of_backup* or *days_to_backup*.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Keys in the dictionary loaded by the JSON file</span>
    <span class="n">OLDEST_OBJECT_BK_KEY</span> <span class="o">=</span> <span class="s2">&quot;oldest_object_backedup&quot;</span>
    <span class="n">BACKUP_DIR_KEY</span> <span class="o">=</span> <span class="s2">&quot;backup_dir&quot;</span>
    <span class="n">DAYS_TO_BACKUP_KEY</span> <span class="o">=</span> <span class="s2">&quot;days_to_backup&quot;</span>
    <span class="n">END_DATE_OF_BACKUP_KEY</span> <span class="o">=</span> <span class="s2">&quot;end_date_of_backup&quot;</span>
    <span class="n">PERIODICITY_KEY</span> <span class="o">=</span> <span class="s2">&quot;periodicity&quot;</span>
    <span class="n">BACKUP_LENGTH_THRESHOLD_KEY</span> <span class="o">=</span> <span class="s2">&quot;backup_length_threshold&quot;</span>

    <span class="c1"># Backup parameters that will be populated by the JSON file</span>

    <span class="c1"># Where did the last backup stop</span>
    <span class="n">_oldest_object_bk</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># The destination directory of the backup</span>
    <span class="n">_backup_dir</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># How many days to backup</span>
    <span class="n">_days_to_backup</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Until what date we should backup</span>
    <span class="n">_end_date_of_backup</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># How many consecutive days to backup in one round.</span>
    <span class="n">_periodicity</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># The threshold (in hours) between the oldest object to be backed up</span>
    <span class="c1"># and the end of the backup. If the difference is bellow this threshold</span>
    <span class="c1"># the backup should not start.</span>
    <span class="n">_backup_length_threshold</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># The end of the backup dates (or days) until the end are translated to</span>
    <span class="c1"># the following internal variable containing the end date</span>
    <span class="n">_internal_end_date_of_backup</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_additional_back_time_mins</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_ignore_backup_dir_existence_check</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="AbstractBackup.__init__"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.manage.backup.backup_base.AbstractBackup.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_info_filepath</span><span class="p">,</span> <span class="n">additional_back_time_mins</span><span class="p">):</span>

        <span class="c1"># The path to the JSON file with the backup information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backup_info_filepath</span> <span class="o">=</span> <span class="n">backup_info_filepath</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_additional_back_time_mins</span> <span class="o">=</span> <span class="n">additional_back_time_mins</span>

        <span class="c1"># Configuring the logging</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(name)-12s</span><span class="s1"> </span><span class="si">%(levelname)-8s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># The logger of the backup script</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;aiida.aiida_backup&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractBackup._read_backup_info_from_file"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.manage.backup.backup_base.AbstractBackup._read_backup_info_from_file">[docs]</a>    <span class="k">def</span> <span class="nf">_read_backup_info_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_info_file_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method reads the backup information from the given file and</span>
<span class="sd">        passes the dictionary to the method responsible for the initialization</span>
<span class="sd">        of the needed class variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">backup_variables</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">backup_info_file_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">backup_info_file</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">backup_variables</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">backup_info_file</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not parse file &quot;</span> <span class="o">+</span> <span class="n">backup_info_file_name</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">BackupError</span><span class="p">(</span><span class="s2">&quot;Could not parse file &quot;</span> <span class="o">+</span> <span class="n">backup_info_file_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_read_backup_info_from_dict</span><span class="p">(</span><span class="n">backup_variables</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractBackup._read_backup_info_from_dict"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.manage.backup.backup_base.AbstractBackup._read_backup_info_from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">_read_backup_info_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_variables</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method reads the backup information from the given dictionary and</span>
<span class="sd">        sets the needed class variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Setting the oldest backup date. This will be used as start of</span>
        <span class="c1"># the new backup procedure.</span>
        <span class="c1">#</span>
        <span class="c1"># If the oldest backup date is not set, then find the oldest</span>
        <span class="c1"># creation timestamp and set it as the oldest backup date.</span>
        <span class="k">if</span> <span class="n">backup_variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OLDEST_OBJECT_BK_KEY</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># qb = QueryBuilder()</span>
            <span class="c1"># qb.append(</span>
            <span class="c1">#     Node,</span>
            <span class="c1"># )</span>
            <span class="c1"># qb.order_by({Node: {&#39;ctime&#39;: &#39;asc&#39;}})</span>
            <span class="c1"># query_node_res = qb.first()</span>

            <span class="n">query_node_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_first_node</span><span class="p">()</span>

            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">query_node_res</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The oldest modification date was not found.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">BackupError</span><span class="p">(</span><span class="s2">&quot;The oldest modification date was not found.&quot;</span><span class="p">)</span>

            <span class="n">oldest_timestamps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">query_node_res</span><span class="p">:</span>
                <span class="n">oldest_timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query_node_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ctime</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_oldest_object_bk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">oldest_timestamps</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting the oldest modification date to the &quot;</span>
                              <span class="s2">&quot;creation date of the oldest object &quot;</span>
                              <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_oldest_object_bk</span><span class="p">))</span>

        <span class="c1"># If the oldest backup date is not None then try to parse it</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_oldest_object_bk</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">backup_variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OLDEST_OBJECT_BK_KEY</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oldest_object_bk</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">curr_timezone</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dtimezone</span><span class="o">.</span><span class="n">get_current_timezone</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_oldest_object_bk</span> <span class="o">=</span> <span class="n">ptimezone</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">curr_timezone</span><span class="p">))</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_oldest_object_bk</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No timezone defined in the oldest &quot;</span>
                                      <span class="s2">&quot;modification date timestamp. Setting &quot;</span>
                                      <span class="s2">&quot;current timezone (</span><span class="si">{}</span><span class="s2">).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curr_timezone</span><span class="p">))</span>
            <span class="c1"># If it is not parsable...</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;We did not manage to parse the start timestamp of the last backup.&quot;</span><span class="p">)</span>
                <span class="k">raise</span>

        <span class="c1"># Setting the backup directory &amp; normalizing it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backup_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">backup_variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BACKUP_DIR_KEY</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_backup_dir_existence_check</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backup_dir</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The given backup directory doesn&#39;t exist.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">BackupError</span><span class="p">(</span><span class="s2">&quot;The given backup directory doesn&#39;t exist.&quot;</span><span class="p">)</span>

        <span class="c1"># You can not set an end-of-backup date and end days from the backup</span>
        <span class="c1"># that you should stop.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">backup_variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DAYS_TO_BACKUP_KEY</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="n">backup_variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">END_DATE_OF_BACKUP_KEY</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Only one end of backup date can be set.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">BackupError</span><span class="p">(</span><span class="s2">&quot;Only one backup end can be set (date or days from backup start.&quot;</span><span class="p">)</span>

        <span class="c1"># Check if there is an end-of-backup date</span>
        <span class="k">elif</span> <span class="n">backup_variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">END_DATE_OF_BACKUP_KEY</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_end_date_of_backup</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">backup_variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">END_DATE_OF_BACKUP_KEY</span><span class="p">))</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_date_of_backup</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">curr_timezone</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dtimezone</span><span class="o">.</span><span class="n">get_current_timezone</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_end_date_of_backup</span> <span class="o">=</span> \
                        <span class="n">ptimezone</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">curr_timezone</span><span class="p">))</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_end_date_of_backup</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No timezone defined in the end date of &quot;</span>
                                      <span class="s2">&quot;backup timestamp. Setting current &quot;</span>
                                      <span class="s2">&quot;timezone (</span><span class="si">{}</span><span class="s2">).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curr_timezone</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_internal_end_date_of_backup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_date_of_backup</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The end date of the backup could not be parsed correctly&quot;</span><span class="p">)</span>
                <span class="k">raise</span>

        <span class="c1"># Check if there is defined a days to backup</span>
        <span class="k">elif</span> <span class="n">backup_variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DAYS_TO_BACKUP_KEY</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_days_to_backup</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">backup_variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DAYS_TO_BACKUP_KEY</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_internal_end_date_of_backup</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_oldest_object_bk</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_days_to_backup</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The days to backup should be an integer&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="c1"># If the backup end is not set, then the ending date remains open</span>

        <span class="c1"># Parse the backup periodicity.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_periodicity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">backup_variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PERIODICITY_KEY</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The backup _periodicity should be an integer&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="c1"># Parse the backup length threshold</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hours_th</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">backup_variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BACKUP_LENGTH_THRESHOLD_KEY</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_backup_length_threshold</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">hours_th</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The backup length threshold should be an integer&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="AbstractBackup._dictionarize_backup_info"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.manage.backup.backup_base.AbstractBackup._dictionarize_backup_info">[docs]</a>    <span class="k">def</span> <span class="nf">_dictionarize_backup_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This dictionarises the backup information and returns the dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">backup_variables</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OLDEST_OBJECT_BK_KEY</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_oldest_object_bk</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BACKUP_DIR_KEY</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup_dir</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">DAYS_TO_BACKUP_KEY</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_days_to_backup</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">END_DATE_OF_BACKUP_KEY</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_date_of_backup</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_end_date_of_backup</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PERIODICITY_KEY</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_periodicity</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BACKUP_LENGTH_THRESHOLD_KEY</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backup_length_threshold</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">//</span> <span class="mi">3600</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">backup_variables</span></div>

<div class="viewcode-block" id="AbstractBackup._store_backup_info"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.manage.backup.backup_base.AbstractBackup._store_backup_info">[docs]</a>    <span class="k">def</span> <span class="nf">_store_backup_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_info_file_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method writes the backup variables dictionary to a file with the</span>
<span class="sd">        given filename.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">backup_variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dictionarize_backup_info</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">backup_info_file_name</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">backup_info_file</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">backup_variables</span><span class="p">,</span> <span class="n">backup_info_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractBackup._find_files_to_backup"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.manage.backup.backup_base.AbstractBackup._find_files_to_backup">[docs]</a>    <span class="k">def</span> <span class="nf">_find_files_to_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query the database for nodes that were created after the</span>
<span class="sd">        the start of the last backup. Return a query set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Go a bit further back to avoid any rounding problems. Set the</span>
        <span class="c1"># smallest timestamp to be backed up.</span>
        <span class="n">start_of_backup</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_oldest_object_bk</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_additional_back_time_mins</span><span class="p">))</span>

        <span class="c1"># Find the end of backup for this round using the given _periodicity.</span>
        <span class="n">backup_end_for_this_round</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_oldest_object_bk</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_periodicity</span><span class="p">))</span>

        <span class="c1"># If the end of the backup is after the given end by the user,</span>
        <span class="c1"># adapt it accordingly</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_internal_end_date_of_backup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="n">backup_end_for_this_round</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_end_date_of_backup</span><span class="p">):</span>
            <span class="n">backup_end_for_this_round</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_end_date_of_backup</span>

        <span class="c1"># If the end of the backup is after then current time,</span>
        <span class="c1"># adapt the end accordingly</span>
        <span class="n">now_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">dtimezone</span><span class="o">.</span><span class="n">get_current_timezone</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">backup_end_for_this_round</span> <span class="o">&gt;</span> <span class="n">now_timestamp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;We can not backup until </span><span class="si">{}</span><span class="s2">. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">backup_end_for_this_round</span><span class="p">)</span> <span class="o">+</span>
                              <span class="s2">&quot;We will backup until now (</span><span class="si">{}</span><span class="s2">).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">now_timestamp</span><span class="p">))</span>
            <span class="n">backup_end_for_this_round</span> <span class="o">=</span> <span class="n">now_timestamp</span>

        <span class="c1"># Check if the backup length is below the backup length threshold</span>
        <span class="k">if</span> <span class="n">backup_end_for_this_round</span> <span class="o">-</span> <span class="n">start_of_backup</span> <span class="o">&lt;</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_backup_length_threshold</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Backup (timestamp) length is below the given threshold. Backup finished&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Construct the queries &amp; query sets</span>
        <span class="n">query_sets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_query_sets</span><span class="p">(</span><span class="n">start_of_backup</span><span class="p">,</span> <span class="n">backup_end_for_this_round</span><span class="p">)</span>

        <span class="c1"># Set the new start of the backup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_oldest_object_bk</span> <span class="o">=</span> <span class="n">backup_end_for_this_round</span>

        <span class="c1"># Check if threshold is 0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup_length_threshold</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">query_sets</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">query_sets</span></div>

<div class="viewcode-block" id="AbstractBackup._get_repository_path"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.manage.backup.backup_base.AbstractBackup._get_repository_path">[docs]</a>    <span class="k">def</span> <span class="nf">_get_repository_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">aiida.manage.configuration</span> <span class="k">import</span> <span class="n">get_profile</span>
        <span class="k">return</span> <span class="n">get_profile</span><span class="p">()</span><span class="o">.</span><span class="n">repository_path</span></div>

<div class="viewcode-block" id="AbstractBackup._backup_needed_files"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.manage.backup.backup_base.AbstractBackup._backup_needed_files">[docs]</a>    <span class="k">def</span> <span class="nf">_backup_needed_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_sets</span><span class="p">):</span>
        <span class="n">repository_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_repository_path</span><span class="p">())</span>

        <span class="n">parent_dir_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">copy_counter</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">dir_no_to_copy</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">query_set</span> <span class="ow">in</span> <span class="n">query_sets</span><span class="p">:</span>
            <span class="n">dir_no_to_copy</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_query_set_length</span><span class="p">(</span><span class="n">query_set</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Start copying </span><span class="si">{}</span><span class="s2"> directories&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dir_no_to_copy</span><span class="p">))</span>

        <span class="n">last_progress_print</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">percent_progress</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">query_set</span> <span class="ow">in</span> <span class="n">query_sets</span><span class="p">:</span>
            <span class="n">iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_query_set_iterator</span><span class="p">(</span><span class="n">query_set</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
                <span class="n">source_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_source_directory</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

                <span class="c1"># Get the relative directory without the / which</span>
                <span class="c1"># separates the repository_path from the relative_dir.</span>
                <span class="n">relative_dir</span> <span class="o">=</span> <span class="n">source_dir</span><span class="p">[(</span><span class="nb">len</span><span class="p">(</span><span class="n">repository_path</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):]</span>
                <span class="n">destination_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backup_dir</span><span class="p">,</span> <span class="n">relative_dir</span><span class="p">)</span>

                <span class="c1"># Remove the destination directory if it already exists</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">destination_dir</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">destination_dir</span><span class="p">)</span>

                <span class="c1"># Copy the needed directory</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">destination_dir</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">EnvironmentError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Problem copying directory </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source_dir</span><span class="p">)</span> <span class="o">+</span>
                                         <span class="s2">&quot;to </span><span class="si">{}</span><span class="s2">. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">destination_dir</span><span class="p">)</span> <span class="o">+</span>
                                         <span class="s2">&quot;More information: </span><span class="si">{}</span><span class="s2"> (Error no: </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">))</span>
                    <span class="c1"># Raise envEr</span>

                <span class="c1"># Extract the needed parent directories</span>
                <span class="n">AbstractBackup</span><span class="o">.</span><span class="n">_extract_parent_dirs</span><span class="p">(</span><span class="n">relative_dir</span><span class="p">,</span> <span class="n">parent_dir_set</span><span class="p">)</span>
                <span class="n">copy_counter</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_progress_print</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">):</span>
                    <span class="n">last_progress_print</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="n">percent_progress</span> <span class="o">=</span> <span class="n">copy_counter</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">dir_no_to_copy</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copied </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">copy_counter</span><span class="p">)</span> <span class="o">+</span>
                                      <span class="s2">&quot;directories [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,)</span> <span class="o">+</span>
                                      <span class="s2">&quot; (</span><span class="si">{}</span><span class="s2">/100)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percent_progress</span><span class="p">))</span>

                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="ow">and</span>
                        <span class="n">percent_progress</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">copy_counter</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">dir_no_to_copy</span><span class="p">)):</span>
                    <span class="n">percent_progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">copy_counter</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">dir_no_to_copy</span><span class="p">)</span>
                    <span class="n">last_progress_print</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copied </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">copy_counter</span><span class="p">)</span> <span class="o">+</span>
                                      <span class="s2">&quot;directories [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,)</span> <span class="o">+</span>
                                      <span class="s2">&quot; (</span><span class="si">{}</span><span class="s2">/100)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percent_progress</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> directories copied&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">copy_counter</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Start setting permissions&quot;</span><span class="p">)</span>
        <span class="n">perm_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">tempRelPath</span> <span class="ow">in</span> <span class="n">parent_dir_set</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copystat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">repository_path</span><span class="p">,</span> <span class="n">tempRelPath</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backup_dir</span><span class="p">,</span> <span class="n">tempRelPath</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Problem setting permissions to directory &quot;</span> <span class="o">+</span>
                                     <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backup_dir</span><span class="p">,</span> <span class="n">tempRelPath</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">repository_path</span><span class="p">,</span> <span class="n">tempRelPath</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;More information: &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (Error no: </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">))</span>
            <span class="n">perm_counter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set correct permissions to </span><span class="si">{}</span><span class="s2"> directories.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">perm_counter</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;End of backup&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Backed up objects with modification timestamp &quot;</span>
                          <span class="s2">&quot;less or equal to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_oldest_object_bk</span><span class="p">))</span></div>

<div class="viewcode-block" id="AbstractBackup._extract_parent_dirs"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.manage.backup.backup_base.AbstractBackup._extract_parent_dirs">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_extract_parent_dirs</span><span class="p">(</span><span class="n">given_rel_dir</span><span class="p">,</span> <span class="n">parent_dir_set</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method extracts the parent directories of the givenDir</span>
<span class="sd">        and populates the parent_dir_set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sub_paths</span> <span class="o">=</span> <span class="n">given_rel_dir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>

        <span class="n">temp_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">sub_path</span> <span class="ow">in</span> <span class="n">sub_paths</span><span class="p">:</span>
            <span class="n">temp_path</span> <span class="o">+=</span> <span class="n">sub_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
            <span class="n">parent_dir_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">parent_dir_set</span></div>

<div class="viewcode-block" id="AbstractBackup.run"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.manage.backup.backup_base.AbstractBackup.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_backup_info_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backup_info_filepath</span><span class="p">)</span>
            <span class="n">item_sets_to_backup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_files_to_backup</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">item_sets_to_backup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_backup_needed_files</span><span class="p">(</span><span class="n">item_sets_to_backup</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_store_backup_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backup_info_filepath</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">item_sets_to_backup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Threshold is 0. Backed up one round and exiting.&quot;</span><span class="p">)</span>
                <span class="k">break</span></div>

<div class="viewcode-block" id="AbstractBackup._query_first_node"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.manage.backup.backup_base.AbstractBackup._query_first_node">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_query_first_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query first node</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="AbstractBackup._get_query_set_length"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.manage.backup.backup_base.AbstractBackup._get_query_set_length">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_get_query_set_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_set</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get query set length</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="AbstractBackup._get_query_sets"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.manage.backup.backup_base.AbstractBackup._get_query_sets">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_get_query_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_of_backup</span><span class="p">,</span> <span class="n">backup_end_for_this_round</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get query set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="AbstractBackup._get_query_set_iterator"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.manage.backup.backup_base.AbstractBackup._get_query_set_iterator">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_get_query_set_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_set</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get query set iterator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="AbstractBackup._get_source_directory"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.manage.backup.backup_base.AbstractBackup._get_source_directory">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_get_source_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get source directory of item</span>
<span class="sd">        :param self:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="BackupError"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.manage.backup.backup_base.BackupError">[docs]</a><span class="k">class</span> <span class="nc">BackupError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

<div class="viewcode-block" id="BackupError.__init__"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.manage.backup.backup_base.BackupError.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="BackupError.__str__"><a class="viewcode-back" href="../../../../apidoc/aiida.manage.backup.html#aiida.manage.backup.backup_base.BackupError.__str__">[docs]</a>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>