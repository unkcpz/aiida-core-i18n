

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.manage.fixtures &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.manage.fixtures</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.manage.fixtures</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Testing tools for related projects like plugins.</span>

<span class="sd">Fixtures (pytest) and specific test classes &amp; test runners (unittest)</span>
<span class="sd">that set up a complete temporary AiiDA environment for plugin tests.</span>

<span class="sd">Filesystem:</span>

<span class="sd">    * temporary config (``.aiida``) folder</span>
<span class="sd">    * temporary repository folder</span>

<span class="sd">Database:</span>

<span class="sd">    * temporary database cluster via the ``pgtest`` package</span>
<span class="sd">    * with aiida database user</span>
<span class="sd">    * with aiida_db database</span>

<span class="sd">AiiDA:</span>

<span class="sd">    * set to use the temporary config folder</span>
<span class="sd">    * create and configure a profile</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="k">import</span> <span class="n">contextmanager</span>

<span class="kn">from</span> <span class="nn">pgtest.pgtest</span> <span class="k">import</span> <span class="n">PGTest</span>

<span class="kn">from</span> <span class="nn">aiida.backends</span> <span class="k">import</span> <span class="n">BACKEND_DJANGO</span><span class="p">,</span> <span class="n">BACKEND_SQLA</span>
<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">aiida.manage</span> <span class="k">import</span> <span class="n">configuration</span>
<span class="kn">from</span> <span class="nn">aiida.manage.configuration.settings</span> <span class="k">import</span> <span class="n">create_instance_directories</span>
<span class="kn">from</span> <span class="nn">aiida.manage.manager</span> <span class="k">import</span> <span class="n">get_manager</span><span class="p">,</span> <span class="n">reset_manager</span>
<span class="kn">from</span> <span class="nn">aiida.manage.external.postgres</span> <span class="k">import</span> <span class="n">Postgres</span>


<div class="viewcode-block" id="FixtureError"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.FixtureError">[docs]</a><span class="k">class</span> <span class="nc">FixtureError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised by FixtureManager, when it encounters a situation in which consistent behaviour can not be guaranteed&quot;&quot;&quot;</span>

<div class="viewcode-block" id="FixtureError.__init__"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.FixtureError.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FixtureError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span></div>

<div class="viewcode-block" id="FixtureError.__str__"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.FixtureError.__str__">[docs]</a>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="FixtureManager"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.FixtureManager">[docs]</a><span class="k">class</span> <span class="nc">FixtureManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  <span class="c1"># pylint: disable=too-many-public-methods,useless-object-inheritance</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manage the life cycle of a completely separated and temporary AiiDA environment</span>

<span class="sd">    * No previously created database of profile is required to run tests using this environment</span>
<span class="sd">    * Tests using this environment will never pollute the user&#39;s work environment</span>

<span class="sd">    Example::</span>

<span class="sd">        fixtures = FixtureManager()</span>
<span class="sd">        fixtures.create_aiida_db()  # set up only the database</span>
<span class="sd">        fixtures.create_profile()  # set up a profile (creates the db too if necessary)</span>

<span class="sd">        # ready for testing</span>

<span class="sd">        # run test 1</span>

<span class="sd">        fixtures.reset_db()</span>
<span class="sd">        # database ready for independent test 2</span>

<span class="sd">        # run test 2</span>

<span class="sd">        fixtures.destroy_all()</span>
<span class="sd">        # everything cleaned up</span>

<span class="sd">    Usage (unittest): See the :py:class:`PluginTestCase` and the :py:class:`TestRunner`.</span>


<span class="sd">    Usage (pytest)::</span>

<span class="sd">        import pytest</span>

<span class="sd">        @pytest.fixture(scope=&#39;session&#39;)</span>
<span class="sd">        def aiida_profile():</span>
<span class="sd">            # set up a test profile for the duration of the tests</span>
<span class="sd">            with aiida.manage.fixtures.fixture_manager() as fixture_manager:</span>
<span class="sd">                yield fixture_manager</span>

<span class="sd">        @pytest.fixture(scope=&#39;function&#39;)</span>
<span class="sd">        def new_database(aiida_profile):</span>
<span class="sd">            # clear the database after each test</span>
<span class="sd">            yield aiida_profile</span>
<span class="sd">            aiida_profile.reset_db()</span>

<span class="sd">        def test_my_stuff(new_database):</span>
<span class="sd">            # run a test</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_test_case</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="FixtureManager.__init__"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.FixtureManager.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">aiida.manage.configuration</span> <span class="k">import</span> <span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs_env</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;repo&#39;</span><span class="p">:</span> <span class="s1">&#39;test_repo&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="s1">&#39;.aiida&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;engine&#39;</span><span class="p">:</span> <span class="s1">&#39;postgresql_psycopg2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;backend&#39;</span><span class="p">:</span> <span class="s1">&#39;django&#39;</span><span class="p">,</span>
            <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;test@aiida.mail&#39;</span><span class="p">,</span>
            <span class="s1">&#39;first_name&#39;</span><span class="p">:</span> <span class="s1">&#39;AiiDA&#39;</span><span class="p">,</span>
            <span class="s1">&#39;last_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Plugintest&#39;</span><span class="p">,</span>
            <span class="s1">&#39;institution&#39;</span><span class="p">:</span> <span class="s1">&#39;aiidateam&#39;</span><span class="p">,</span>
            <span class="s1">&#39;db_user&#39;</span><span class="p">:</span> <span class="s1">&#39;aiida&#39;</span><span class="p">,</span>
            <span class="s1">&#39;db_pass&#39;</span><span class="p">:</span> <span class="s1">&#39;aiida_pw&#39;</span><span class="p">,</span>
            <span class="s1">&#39;db_name&#39;</span><span class="p">:</span> <span class="s1">&#39;aiida_db&#39;</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pg_cluster</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postgres</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_running_on_test_db</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_running_on_test_profile</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">CONFIG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">[</span><span class="s1">&#39;config_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">AIIDA_CONFIG_FOLDER</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">PROFILE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__backend</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_backend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the backend</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Lazy load the backend so we don&#39;t do it too early (i.e. before load_dbenv())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__backend</span> <span class="o">=</span> <span class="n">get_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__backend</span>

<div class="viewcode-block" id="FixtureManager.create_db_cluster"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.FixtureManager.create_db_cluster">[docs]</a>    <span class="k">def</span> <span class="nf">create_db_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pg_cluster</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pg_cluster</span> <span class="o">=</span> <span class="n">PGTest</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pg_cluster</span><span class="o">.</span><span class="n">dsn</span><span class="p">)</span></div>

<div class="viewcode-block" id="FixtureManager.create_aiida_db"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.FixtureManager.create_aiida_db">[docs]</a>    <span class="k">def</span> <span class="nf">create_aiida_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the necessary database on the temporary postgres instance&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">configuration</span><span class="o">.</span><span class="n">PROFILE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FixtureError</span><span class="p">(</span><span class="s1">&#39;AiiDA dbenv can not be loaded while creating a test db environment&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_params</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_db_cluster</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postgres</span> <span class="o">=</span> <span class="n">Postgres</span><span class="p">(</span><span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dbinfo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postgres</span><span class="o">.</span><span class="n">dbinfo</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postgres</span><span class="o">.</span><span class="n">create_dbuser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_pass</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postgres</span><span class="o">.</span><span class="n">create_db</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_running_on_test_db</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="FixtureManager.create_profile"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.FixtureManager.create_profile">[docs]</a>    <span class="k">def</span> <span class="nf">create_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set AiiDA to use the test config dir and create a default profile there</span>

<span class="sd">        Warning: the AiiDA dbenv must not be loaded when this is called!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">configuration</span><span class="o">.</span><span class="n">PROFILE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FixtureError</span><span class="p">(</span><span class="s1">&#39;AiiDA dbenv can not be loaded while creating a test profile&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_running_on_test_db</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_aiida_db</span><span class="p">()</span>
        <span class="kn">from</span> <span class="nn">aiida.manage.configuration</span> <span class="k">import</span> <span class="n">settings</span><span class="p">,</span> <span class="n">load_profile</span><span class="p">,</span> <span class="n">Profile</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="n">configuration</span><span class="o">.</span><span class="n">CONFIG</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">AIIDA_CONFIG_FOLDER</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dir</span>
        <span class="n">configuration</span><span class="o">.</span><span class="n">PROFILE</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">create_instance_directories</span><span class="p">()</span>
        <span class="n">profile_name</span> <span class="o">=</span> <span class="s1">&#39;test_profile&#39;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">Profile</span><span class="p">(</span><span class="n">profile_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_dictionary</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">add_profile</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set_default_profile</span><span class="p">(</span><span class="n">profile_name</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">load_profile</span><span class="p">(</span><span class="n">profile_name</span><span class="p">)</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="n">get_manager</span><span class="p">()</span><span class="o">.</span><span class="n">_load_backend</span><span class="p">(</span><span class="n">schema_check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">backend</span><span class="o">.</span><span class="n">migrate</span><span class="p">()</span>

        <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="k">import</span> <span class="n">User</span>
        <span class="kn">from</span> <span class="nn">aiida.cmdline.commands.cmd_user</span> <span class="k">import</span> <span class="n">set_default_user</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">user_dictionary</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">set_default_user</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
        <span class="n">load_profile</span><span class="p">(</span><span class="n">profile_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__is_running_on_test_profile</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_test_case</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_db</span><span class="p">()</span></div>

<div class="viewcode-block" id="FixtureManager.reset_db"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.FixtureManager.reset_db">[docs]</a>    <span class="k">def</span> <span class="nf">reset_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cleans all data from the database between tests&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_case</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
        <span class="n">reset_manager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_db</span><span class="p">()</span></div>

<div class="viewcode-block" id="FixtureManager.init_db"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.FixtureManager.init_db">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">init_db</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Initialise the database state&quot;&quot;&quot;</span>
        <span class="n">configuration</span><span class="o">.</span><span class="n">reset_profile</span><span class="p">()</span>
        <span class="n">configuration</span><span class="o">.</span><span class="n">load_profile</span><span class="p">()</span>

        <span class="c1"># Create the default user</span>
        <span class="kn">from</span> <span class="nn">aiida</span> <span class="k">import</span> <span class="n">orm</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">get_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_profile</span><span class="p">()</span><span class="o">.</span><span class="n">default_user</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span>
            <span class="c1"># The default user already exists, no problem</span>
            <span class="k">pass</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">profile_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Profile parameters&quot;&quot;&quot;</span>
        <span class="n">dictionary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;database_engine&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span>
            <span class="s1">&#39;database_backend&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">,</span>
            <span class="s1">&#39;database_port&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_port</span><span class="p">,</span>
            <span class="s1">&#39;database_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">,</span>
            <span class="s1">&#39;database_hostname&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_host</span><span class="p">,</span>
            <span class="s1">&#39;database_username&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_user</span><span class="p">,</span>
            <span class="s1">&#39;database_password&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_pass</span><span class="p">,</span>
            <span class="s1">&#39;repository_uri&#39;</span><span class="p">:</span> <span class="s1">&#39;file://&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">dictionary</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">user_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;User parameters&quot;&quot;&quot;</span>
        <span class="n">dictionary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
            <span class="s1">&#39;first_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
            <span class="s1">&#39;last_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span>
            <span class="s1">&#39;institution&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">institution</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">dictionary</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">db_host</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">)</span>

    <span class="nd">@db_host</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">db_host</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_params</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hostname</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">first_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;first_name&#39;</span><span class="p">]</span>

    <span class="nd">@first_name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">first_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;first_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;last_name&#39;</span><span class="p">]</span>

    <span class="nd">@last_name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">last_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;last_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">institution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;institution&#39;</span><span class="p">]</span>

    <span class="nd">@institution</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">institution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">institution</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;institution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">institution</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">db_port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@db_port</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">db_port</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_params</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>

<div class="viewcode-block" id="FixtureManager.repo_ok"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.FixtureManager.repo_ok">[docs]</a>    <span class="k">def</span> <span class="nf">repo_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">)))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">repo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_dir</span><span class="p">(</span><span class="s1">&#39;repo&#39;</span><span class="p">)</span>

    <span class="nd">@repo</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">repo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repo_dir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs_env</span><span class="p">[</span><span class="s1">&#39;repo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo_dir</span>

<div class="viewcode-block" id="FixtureManager._return_dir"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.FixtureManager._return_dir">[docs]</a>    <span class="k">def</span> <span class="nf">_return_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a path to a directory from the fs environment&quot;&quot;&quot;</span>
        <span class="n">dir_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs_env</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FixtureError</span><span class="p">(</span><span class="s1">&#39;no directory set for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">dir_path</span>
        <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>

    <span class="nd">@email</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;engine&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">backend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;backend&#39;</span><span class="p">]</span>

    <span class="nd">@backend</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">backend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_running_on_test_profile</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FixtureError</span><span class="p">(</span><span class="s1">&#39;backend cannot be changed after setting up the environment&#39;</span><span class="p">)</span>

        <span class="n">valid_backends</span> <span class="o">=</span> <span class="p">[</span><span class="n">BACKEND_DJANGO</span><span class="p">,</span> <span class="n">BACKEND_SQLA</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">backend</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_backends</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid backend </span><span class="si">{}</span><span class="s1">, must be one of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">valid_backends</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;backend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backend</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">config_dir_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dir</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_dir</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">config_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_dir</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">)</span>

    <span class="nd">@config_dir</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">config_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_dir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs_env</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_dir</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">db_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;db_user&#39;</span><span class="p">]</span>

    <span class="nd">@db_user</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">db_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;db_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">db_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;db_pass&#39;</span><span class="p">]</span>

    <span class="nd">@db_pass</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">db_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">passwd</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;db_pass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">passwd</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">db_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;db_name&#39;</span><span class="p">]</span>

    <span class="nd">@db_name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">db_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;db_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs_env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="nd">@root_dir</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">root_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs_env</span><span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_dir</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root_dir_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">))</span>

<div class="viewcode-block" id="FixtureManager.destroy_all"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.FixtureManager.destroy_all">[docs]</a>    <span class="k">def</span> <span class="nf">destroy_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all traces of the test run&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.manage.configuration</span> <span class="k">import</span> <span class="n">settings</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pg_cluster</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pg_cluster</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pg_cluster</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_running_on_test_db</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_running_on_test_profile</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;config&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">:</span>
            <span class="n">configuration</span><span class="o">.</span><span class="n">CONFIG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;config_dir&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">:</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">AIIDA_CONFIG_FOLDER</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">[</span><span class="s1">&#39;config_dir&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;profile&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">:</span>
            <span class="n">configuration</span><span class="o">.</span><span class="n">PROFILE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="FixtureManager._create_test_case"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.FixtureManager._create_test_case">[docs]</a>    <span class="k">def</span> <span class="nf">_create_test_case</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the test case for the correct backend which will be used to clean up</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_running_on_test_profile</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FixtureError</span><span class="p">(</span><span class="s1">&#39;No test profile has been set up yet, cannot create appropriate test case&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;backend&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">BACKEND_DJANGO</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">aiida.backends.djsite.db.testbase</span> <span class="k">import</span> <span class="n">DjangoTests</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test_case</span> <span class="o">=</span> <span class="n">DjangoTests</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;backend&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">BACKEND_SQLA</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">aiida.backends.sqlalchemy.tests.testbase</span> <span class="k">import</span> <span class="n">SqlAlchemyTests</span>
            <span class="kn">from</span> <span class="nn">aiida.backends.sqlalchemy</span> <span class="k">import</span> <span class="n">get_scoped_session</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_test_case</span> <span class="o">=</span> <span class="n">SqlAlchemyTests</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test_case</span><span class="o">.</span><span class="n">test_session</span> <span class="o">=</span> <span class="n">get_scoped_session</span><span class="p">()</span></div>

<div class="viewcode-block" id="FixtureManager.has_profile_open"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.FixtureManager.has_profile_open">[docs]</a>    <span class="k">def</span> <span class="nf">has_profile_open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_running_on_test_profile</span></div></div>


<span class="n">_GLOBAL_FIXTURE_MANAGER</span> <span class="o">=</span> <span class="n">FixtureManager</span><span class="p">()</span>


<div class="viewcode-block" id="fixture_manager"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.fixture_manager">[docs]</a><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">fixture_manager</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="n">BACKEND_DJANGO</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager for FixtureManager objects</span>

<span class="sd">    Example test runner (unittest)::</span>

<span class="sd">        with fixture_manager(backend) as fixture_mgr:</span>
<span class="sd">            # ready for tests</span>
<span class="sd">        # everything cleaned up</span>

<span class="sd">    Example fixture (pytest)::</span>

<span class="sd">        def aiida_profile():</span>
<span class="sd">            with fixture_manager(backend) as fixture_mgr:</span>
<span class="sd">                yield fixture_mgr</span>

<span class="sd">    :param backend: database backend, either BACKEND_SQLA or BACKEND_DJANGO</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_GLOBAL_FIXTURE_MANAGER</span><span class="o">.</span><span class="n">has_profile_open</span><span class="p">():</span>
            <span class="n">_GLOBAL_FIXTURE_MANAGER</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
            <span class="n">_GLOBAL_FIXTURE_MANAGER</span><span class="o">.</span><span class="n">create_profile</span><span class="p">()</span>
        <span class="k">yield</span> <span class="n">_GLOBAL_FIXTURE_MANAGER</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">_GLOBAL_FIXTURE_MANAGER</span><span class="o">.</span><span class="n">destroy_all</span><span class="p">()</span></div>


<div class="viewcode-block" id="PluginTestCase"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.PluginTestCase">[docs]</a><span class="k">class</span> <span class="nc">PluginTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up a complete temporary AiiDA environment for plugin tests.</span>

<span class="sd">    Note: This test class needs to be run through the :py:class:`TestRunner`</span>
<span class="sd">    and will **not** work simply with `python -m unittest discover`.</span>

<span class="sd">    Usage example::</span>

<span class="sd">        MyTestCase(aiida.manage.fixtures.PluginTestCase):</span>

<span class="sd">            def setUp(self):</span>
<span class="sd">                # load my test data</span>

<span class="sd">            # optionally extend setUpClass / tearDownClass / tearDown if needed</span>

<span class="sd">            def test_my_plugin(self):</span>
<span class="sd">                # execute tests</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Filled in during setUpClass</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type :class:`aiida.orm.Backend`</span>

<div class="viewcode-block" id="PluginTestCase.setUpClass"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.PluginTestCase.setUpClass">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">fixture_manager</span> <span class="o">=</span> <span class="n">_GLOBAL_FIXTURE_MANAGER</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">fixture_manager</span><span class="o">.</span><span class="n">has_profile_open</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Fixture mananger has no open profile. Please use aiida.manage.fixtures.TestRunner to run these tests.&quot;</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">get_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span></div>

<div class="viewcode-block" id="PluginTestCase.tearDown"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.PluginTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixture_manager</span><span class="o">.</span><span class="n">reset_db</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="TestRunner"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.TestRunner">[docs]</a><span class="k">class</span> <span class="nc">TestRunner</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">TextTestRunner</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Testrunner for unit tests using the fixture manager.</span>

<span class="sd">    Usage example::</span>

<span class="sd">        import unittest</span>
<span class="sd">        from aiida.manage.fixtures import TestRunner</span>

<span class="sd">        tests = unittest.defaultTestLoader.discover(&#39;.&#39;)</span>
<span class="sd">        TestRunner().run(tests)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># pylint: disable=arguments-differ</span>
<div class="viewcode-block" id="TestRunner.run"><a class="viewcode-back" href="../../../apidoc/aiida.manage.html#aiida.manage.fixtures.TestRunner.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suite</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">BACKEND_DJANGO</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run tests using fixture manager for specified backend.</span>

<span class="sd">        :param tests: A suite of tests, as returned e.g. by :py:meth:`unittest.TestLoader.discover`</span>
<span class="sd">        :param backend: Database backend to be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.utils</span> <span class="k">import</span> <span class="n">Capturing</span>
        <span class="k">with</span> <span class="n">Capturing</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">fixture_manager</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TestRunner</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>