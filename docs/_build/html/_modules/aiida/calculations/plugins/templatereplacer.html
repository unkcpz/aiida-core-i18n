

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.calculations.plugins.templatereplacer &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.calculations.plugins.templatereplacer</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.calculations.plugins.templatereplacer</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;Implementation of CalcJobNode to replace a template for testing and demonstration purposes.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">from</span> <span class="nn">aiida</span> <span class="k">import</span> <span class="n">orm</span>
<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">aiida.common.datastructures</span> <span class="k">import</span> <span class="n">CalcInfo</span><span class="p">,</span> <span class="n">CodeInfo</span>
<span class="kn">from</span> <span class="nn">aiida.engine</span> <span class="k">import</span> <span class="n">CalcJob</span>


<div class="viewcode-block" id="TemplatereplacerCalculation"><a class="viewcode-back" href="../../../../developer_guide/core/orm_overview.html#aiida.calculations.plugins.templatereplacer.TemplatereplacerCalculation">[docs]</a><span class="k">class</span> <span class="nc">TemplatereplacerCalculation</span><span class="p">(</span><span class="n">CalcJob</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple stub of a plugin that can be used to replace some text in a given template.</span>
<span class="sd">    Can be used for many different codes, or as a starting point to develop a new plugin.</span>

<span class="sd">    This simple plugin takes two node inputs, both of type Dict, with the labels</span>
<span class="sd">    &#39;parameters&#39; and &#39;template&#39;</span>

<span class="sd">    You can also add other SinglefileData nodes as input, that will be copied according to</span>
<span class="sd">    what is written in &#39;template&#39; (see below).</span>

<span class="sd">    * parameters: a set of parameters that will be used for substitution.</span>

<span class="sd">    * template: can contain the following parameters:</span>

<span class="sd">        * input_file_template: a string with substitutions to be managed with the format()</span>
<span class="sd">          function of python, i.e. if you want to substitute a variable called &#39;varname&#39;, you write</span>
<span class="sd">          {varname} in the text. See http://www.python.org/dev/peps/pep-3101/ for more</span>
<span class="sd">          details. The replaced file will be the input file.</span>

<span class="sd">        * input_file_name: a string with the file name for the input. If it is not provided, no</span>
<span class="sd">          file will be created.</span>

<span class="sd">        * output_file_name: a string with the file name for the output. If it is not provided, no</span>
<span class="sd">          redirection will be done and the output will go in the scheduler output file.</span>

<span class="sd">        * cmdline_params: a list of strings, to be passed as command line parameters.</span>
<span class="sd">          Each one is substituted with the same rule of input_file_template. Optional</span>

<span class="sd">        * input_through_stdin: if True, the input file name is passed via stdin. Default is False if missing.</span>

<span class="sd">        * files_to_copy: if defined, a list of tuple pairs, with format (&#39;link_name&#39;, &#39;dest_rel_path&#39;);</span>
<span class="sd">            for each tuple, an input link to this calculation is looked for, with link labeled &#39;link_label&#39;,</span>
<span class="sd">            and with file type &#39;Singlefile&#39;, and the content is copied to a remote file named &#39;dest_rel_path&#39;</span>
<span class="sd">            Errors are raised in the input links are non-existent, or of the wrong type, or if there are</span>
<span class="sd">            unused input files.</span>

<span class="sd">        * retrieve_temporary_files: a list of relative filepaths, that if defined, will be retrieved and</span>
<span class="sd">            temporarily stored in an unstored FolderData node that will be available during the</span>
<span class="sd">            Parser.parser_with_retrieved call under the key specified by the Parser.retrieved_temporary_folder key</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TemplatereplacerCalculation.define"><a class="viewcode-back" href="../../../../apidoc/aiida.calculations.plugins.html#aiida.calculations.plugins.templatereplacer.TemplatereplacerCalculation.define">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="c1"># yapf: disable</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TemplatereplacerCalculation</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.parser_name&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;templatereplacer.doubler&#39;</span><span class="p">,</span>
            <span class="n">non_db</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;template&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;A template for the input file.&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;parameters&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Parameters used to replace placeholders in the template.&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input_namespace</span><span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">RemoteData</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">SinglefileData</span><span class="p">),</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;output_parameters&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">default_output_node</span> <span class="o">=</span> <span class="s1">&#39;output_parameters&#39;</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">exit_code</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;ERROR_NO_RETRIEVED_FOLDER&#39;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s1">&#39;The retrieved folder data node could not be accessed.&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">exit_code</span><span class="p">(</span><span class="mi">101</span><span class="p">,</span> <span class="s1">&#39;ERROR_NO_TEMPORARY_RETRIEVED_FOLDER&#39;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s1">&#39;The temporary retrieved folder data node could not be accessed.&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">exit_code</span><span class="p">(</span><span class="mi">105</span><span class="p">,</span> <span class="s1">&#39;ERROR_NO_OUTPUT_FILE_NAME_DEFINED&#39;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s1">&#39;The `template` input node did not specify the key `output_file_name`.&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">exit_code</span><span class="p">(</span><span class="mi">110</span><span class="p">,</span> <span class="s1">&#39;ERROR_READING_OUTPUT_FILE&#39;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s1">&#39;The output file could not be read from the retrieved folder.&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">exit_code</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="s1">&#39;ERROR_READING_TEMPORARY_RETRIEVED_FILE&#39;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s1">&#39;A temporary retrieved file could not be read from the temporary retrieved folder.&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">exit_code</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="s1">&#39;ERROR_INVALID_OUTPUT&#39;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s1">&#39;The output file contains invalid output.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TemplatereplacerCalculation.prepare_for_submission"><a class="viewcode-back" href="../../../../developer_guide/core/orm_overview.html#aiida.calculations.plugins.templatereplacer.TemplatereplacerCalculation.prepare_for_submission">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_for_submission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is the routine to be called when you want to create the input files and related stuff with a plugin.</span>

<span class="sd">        :param folder: a aiida.common.folders.Folder subclass where the plugin should put all its files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=too-many-locals,too-many-statements,too-many-branches</span>
        <span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="n">StringIO</span>
        <span class="kn">from</span> <span class="nn">aiida.common.utils</span> <span class="k">import</span> <span class="n">validate_list_of_string_tuples</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">ValidationError</span>

        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">code</span>
        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">get_dict</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get_dict</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">input_file_template</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;input_file_template&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">input_file_name</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;input_file_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">output_file_name</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;output_file_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">cmdline_params_tmpl</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cmdline_params&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">input_through_stdin</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;input_through_stdin&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">files_to_copy</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;files_to_copy&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">retrieve_temporary_files</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;retrieve_temporary_files&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">if</span> <span class="n">template</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InputValidationError</span><span class="p">(</span>
                <span class="s1">&#39;The following keys could not be used in the template node: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">validate_list_of_string_tuples</span><span class="p">(</span><span class="n">files_to_copy</span><span class="p">,</span> <span class="n">tuple_length</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InputValidationError</span><span class="p">(</span><span class="s2">&quot;invalid file_to_copy format: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>

        <span class="n">local_copy_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">remote_copy_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">link_name</span><span class="p">,</span> <span class="n">dest_rel_path</span> <span class="ow">in</span> <span class="n">files_to_copy</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fileobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">link_name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InputValidationError</span><span class="p">(</span><span class="s2">&quot;You are asking to copy a file link </span><span class="si">{}</span><span class="s2">, &quot;</span>
                                                      <span class="s2">&quot;but there is no input link with such a name&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">link_name</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">SinglefileData</span><span class="p">):</span>
                <span class="n">local_copy_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fileobj</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">dest_rel_path</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">RemoteData</span><span class="p">):</span>  <span class="c1"># can be a folder</span>
                <span class="n">remote_copy_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fileobj</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">get_remote_path</span><span class="p">(),</span> <span class="n">dest_rel_path</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InputValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;If you ask to copy a file link </span><span class="si">{}</span><span class="s2">, &quot;</span>
                    <span class="s2">&quot;it must be either a SinglefileData or a RemoteData; it is instead of type </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">link_name</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">input_file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">input_file_template</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InputValidationError</span><span class="p">(</span>
                <span class="s2">&quot;If you give an input_file_name, you must also specify a input_file_template&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">input_through_stdin</span> <span class="ow">and</span> <span class="n">input_file_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InputValidationError</span><span class="p">(</span>
                <span class="s2">&quot;If you ask for input_through_stdin you have to specify a input_file_name&quot;</span><span class="p">)</span>

        <span class="n">input_content</span> <span class="o">=</span> <span class="n">input_file_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">input_file_name</span><span class="p">:</span>
            <span class="n">folder</span><span class="o">.</span><span class="n">create_file_from_filelike</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">input_content</span><span class="p">),</span> <span class="n">input_file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">input_file_template</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No input file name passed, but a input file template is present&quot;</span><span class="p">)</span>

        <span class="n">cmdline_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cmdline_params_tmpl</span><span class="p">]</span>

        <span class="n">calcinfo</span> <span class="o">=</span> <span class="n">CalcInfo</span><span class="p">()</span>
        <span class="n">calcinfo</span><span class="o">.</span><span class="n">retrieve_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">calcinfo</span><span class="o">.</span><span class="n">retrieve_temporary_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">calcinfo</span><span class="o">.</span><span class="n">local_copy_list</span> <span class="o">=</span> <span class="n">local_copy_list</span>
        <span class="n">calcinfo</span><span class="o">.</span><span class="n">remote_copy_list</span> <span class="o">=</span> <span class="n">remote_copy_list</span>

        <span class="n">codeinfo</span> <span class="o">=</span> <span class="n">CodeInfo</span><span class="p">()</span>
        <span class="n">codeinfo</span><span class="o">.</span><span class="n">cmdline_params</span> <span class="o">=</span> <span class="n">cmdline_params</span>

        <span class="k">if</span> <span class="n">input_through_stdin</span><span class="p">:</span>
            <span class="n">codeinfo</span><span class="o">.</span><span class="n">stdin_name</span> <span class="o">=</span> <span class="n">input_file_name</span>

        <span class="k">if</span> <span class="n">output_file_name</span><span class="p">:</span>
            <span class="n">codeinfo</span><span class="o">.</span><span class="n">stdout_name</span> <span class="o">=</span> <span class="n">output_file_name</span>
            <span class="n">calcinfo</span><span class="o">.</span><span class="n">retrieve_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_file_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">retrieve_temporary_files</span><span class="p">:</span>
            <span class="n">calcinfo</span><span class="o">.</span><span class="n">retrieve_temporary_list</span> <span class="o">=</span> <span class="n">retrieve_temporary_files</span>

        <span class="n">codeinfo</span><span class="o">.</span><span class="n">code_uuid</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">uuid</span>
        <span class="n">calcinfo</span><span class="o">.</span><span class="n">codes_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">codeinfo</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">calcinfo</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>