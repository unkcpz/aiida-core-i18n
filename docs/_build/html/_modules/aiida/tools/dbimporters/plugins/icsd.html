

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.tools.dbimporters.plugins.icsd &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.tools.dbimporters.plugins.icsd</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.tools.dbimporters.plugins.icsd</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">from</span> <span class="nn">aiida.tools.dbimporters.baseclasses</span> <span class="k">import</span> <span class="p">(</span><span class="n">DbImporter</span><span class="p">,</span> <span class="n">DbSearchResults</span><span class="p">,</span>
                                                 <span class="n">CifEntry</span><span class="p">)</span>


<div class="viewcode-block" id="IcsdImporterExp"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdImporterExp">[docs]</a><span class="k">class</span> <span class="nc">IcsdImporterExp</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="CifFileErrorExp"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.CifFileErrorExp">[docs]</a><span class="k">class</span> <span class="nc">CifFileErrorExp</span><span class="p">(</span><span class="n">IcsdImporterExp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raised when the author loop is missing in a CIF file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="NoResultsWebExp"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.NoResultsWebExp">[docs]</a><span class="k">class</span> <span class="nc">NoResultsWebExp</span><span class="p">(</span><span class="n">IcsdImporterExp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raised when a webpage query returns no results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="IcsdDbImporter"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter">[docs]</a><span class="k">class</span> <span class="nc">IcsdDbImporter</span><span class="p">(</span><span class="n">DbImporter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Importer for the Inorganic Crystal Structure Database, short ICSD, provided by</span>
<span class="sd">    FIZ Karlsruhe. It allows to run queries and analyse all the results.</span>
<span class="sd">    See the :ref:`DbImporter documentation and</span>
<span class="sd">    tutorial page &lt;ICSD_importer_guide&gt;` for more information.</span>

<span class="sd">    :param server: Server URL, the web page of the database. It is</span>
<span class="sd">        required in order to have access to the full database.</span>
<span class="sd">        I t should contain both the protocol and the domain name</span>
<span class="sd">        and end with a slash, as in::</span>

<span class="sd">          server = &quot;http://ICSDSERVER.com/&quot;</span>

<span class="sd">    :param urladd: part of URL which is added between query and and the server URL</span>
<span class="sd">        (default: ``index.php?``). only needed for web page query</span>
<span class="sd">    :param querydb: boolean, decides whether the mysql database is queried</span>
<span class="sd">        (default: True).</span>
<span class="sd">        If False, the query results are obtained through the web page</span>
<span class="sd">        query, which is</span>
<span class="sd">        restricted to a maximum of 1000 results per query.</span>
<span class="sd">    :param dl_db: icsd comes with a full (default: ``icsd``) and a demo</span>
<span class="sd">        database (``icsdd``).</span>
<span class="sd">        This parameter allows the user to switch to the demo database</span>
<span class="sd">        for testing purposes, if the access rights to the full database</span>
<span class="sd">        are not granted.</span>
<span class="sd">    :param host: MySQL database host. If the MySQL database is hosted on</span>
<span class="sd">        a different machine, use  &quot;127.0.0.1&quot; as host, and open</span>
<span class="sd">        a SSH tunnel to the host using::</span>

<span class="sd">            ssh -L 3306:localhost:3306 username@hostname.com</span>

<span class="sd">        or (if e.g. you get an URLError with Errno 111 (Connection refused)</span>
<span class="sd">        upon querying)::</span>
<span class="sd">        </span>
<span class="sd">            ssh -L 3306:localhost:3306 -L 8010:localhost:80 username@hostname.com</span>

<span class="sd">    :param user: mysql database username (default: dba)</span>
<span class="sd">    :param passwd: mysql database password (default: sql)</span>
<span class="sd">    :param db: name of the database (default: icsd)</span>
<span class="sd">    :param port: Port to access the mysql database (default: 3306)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">length_precision</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">angle_precision</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">volume_precision</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">temperature_precision</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">density_precision</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">pressure_precision</span> <span class="o">=</span> <span class="mi">1</span>

<div class="viewcode-block" id="IcsdDbImporter.__init__"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;server&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;urladd&quot;</span><span class="p">:</span> <span class="s2">&quot;index.php?&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;querydb&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                              <span class="s2">&quot;dl_db&quot;</span><span class="p">:</span> <span class="s2">&quot;icsd&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;dba&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;passwd&quot;</span><span class="p">:</span> <span class="s2">&quot;sql&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;db&quot;</span><span class="p">:</span> <span class="s2">&quot;icsd&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="s2">&quot;3306&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_db</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="c1"># for mysql db query</span>
<div class="viewcode-block" id="IcsdDbImporter._int_clause"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter._int_clause">[docs]</a>    <span class="k">def</span> <span class="nf">_int_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return SQL query predicate for querying integer fields</span>
<span class="sd">        :param key: Database keyword</span>
<span class="sd">        :param alias: Query parameter name</span>
<span class="sd">        :param values: Corresponding values from query</span>
<span class="sd">        :return: SQL query predicate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">integer_types</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;incorrect value for keyword &#39;&quot;</span> <span class="o">+</span> <span class="n">alias</span> <span class="o">+</span> \
                                 <span class="s2">&quot;&#39; -- only integers and strings are accepted&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> IN (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">values</span><span class="p">))</span></div>

<div class="viewcode-block" id="IcsdDbImporter._str_exact_clause"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter._str_exact_clause">[docs]</a>    <span class="k">def</span> <span class="nf">_str_exact_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return SQL query predicate for querying string fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">integer_types</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;incorrect value for keyword &#39;&quot;</span> <span class="o">+</span> <span class="n">alias</span> <span class="o">+</span> \
                                 <span class="s2">&quot;&#39; -- only integers and strings are accepted&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> IN (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">values</span><span class="p">))</span></div>

<div class="viewcode-block" id="IcsdDbImporter._formula_clause"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter._formula_clause">[docs]</a>    <span class="k">def</span> <span class="nf">_formula_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return SQL query predicate for querying formula fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;incorrect value for keyword &#39;&quot;</span> <span class="o">+</span> <span class="n">alias</span> <span class="o">+</span> \
                                 <span class="s2">&quot;&#39; -- only strings are accepted&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str_exact_clause</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> \
                                     <span class="n">alias</span><span class="p">,</span> \
                                     <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">values</span><span class="p">])</span></div>

<div class="viewcode-block" id="IcsdDbImporter._str_fuzzy_clause"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter._str_fuzzy_clause">[docs]</a>    <span class="k">def</span> <span class="nf">_str_fuzzy_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return SQL query predicate for fuzzy querying of string fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">integer_types</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;incorrect value for keyword &#39;&quot;</span> <span class="o">+</span> <span class="n">alias</span> <span class="o">+</span> \
                                 <span class="s2">&quot;&#39; -- only integers and strings are accepted&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot; OR &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> LIKE &#39;%</span><span class="si">{}</span><span class="s2">%&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">values</span><span class="p">)</span></div>

<div class="viewcode-block" id="IcsdDbImporter._composition_clause"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter._composition_clause">[docs]</a>    <span class="k">def</span> <span class="nf">_composition_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return SQL query predicate for querying elements in formula fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;incorrect value for keyword &#39;&quot;</span> <span class="o">+</span> <span class="n">alias</span> <span class="o">+</span> \
                                 <span class="s2">&quot;&#39; -- only strings are accepted&quot;</span><span class="p">)</span>
        <span class="c1"># SUM_FORM in the ICSD always stores a numeral after the element name,</span>
        <span class="c1"># STRUCT_FORM does not, so it&#39;s better to use SUM_FORM for the composition query.</span>
        <span class="c1"># The element-numeral pair can be in the beginning of the formula expression (therefore no space before),</span>
        <span class="c1"># or at the end of the formula expression (no space after).</span>
        <span class="c1"># Be aware that one needs to check that space/beginning of line before and ideally also space/end of line</span>
        <span class="c1"># after, because I found that capitalization of the element name is not enforced in these queries.</span>
        <span class="k">return</span> <span class="s2">&quot; AND &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;SUM_FORM REGEXP &#39;(^|\ )</span><span class="si">{}</span><span class="s2">[0-9\.]+($|\ )&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">values</span><span class="p">)</span></div>

<div class="viewcode-block" id="IcsdDbImporter._double_clause"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter._double_clause">[docs]</a>    <span class="k">def</span> <span class="nf">_double_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">precision</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return SQL query predicate for querying double-valued fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">integer_types</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;incorrect value for keyword &#39;&quot;</span> <span class="o">+</span> <span class="n">alias</span> <span class="o">+</span> \
                                 <span class="s2">&quot;&#39; -- only integers and floats are accepted&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot; OR &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> BETWEEN </span><span class="si">{}</span><span class="s2"> AND </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">d</span><span class="o">-</span><span class="n">precision</span><span class="p">,</span> <span class="n">d</span><span class="o">+</span><span class="n">precision</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">values</span><span class="p">)</span></div>

<div class="viewcode-block" id="IcsdDbImporter._crystal_system_clause"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter._crystal_system_clause">[docs]</a>    <span class="k">def</span> <span class="nf">_crystal_system_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return SQL query predicate for querying crystal_system.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid_systems</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;cubic&quot;</span><span class="p">:</span> <span class="s2">&quot;CU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hexagonal&quot;</span><span class="p">:</span> <span class="s2">&quot;HE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;monoclinic&quot;</span><span class="p">:</span> <span class="s2">&quot;MO&quot;</span><span class="p">,</span>
            <span class="s2">&quot;orthorhombic&quot;</span><span class="p">:</span> <span class="s2">&quot;OR&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tetragonal&quot;</span><span class="p">:</span> <span class="s2">&quot;TE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;trigonal&quot;</span><span class="p">:</span> <span class="s2">&quot;TG&quot;</span><span class="p">,</span>
            <span class="s2">&quot;triclinic&quot;</span><span class="p">:</span> <span class="s2">&quot;TC&quot;</span>
        <span class="p">}</span>  <span class="c1"># from icsd accepted crystal systems</span>

        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">integer_types</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;incorrect value for keyword &#39;&quot;</span> <span class="o">+</span> <span class="n">alias</span> <span class="o">+</span> \
                                 <span class="s2">&quot;&#39; -- only strings are accepted&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot; IN (&quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">valid_systems</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span></div>

<div class="viewcode-block" id="IcsdDbImporter._length_clause"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter._length_clause">[docs]</a>    <span class="k">def</span> <span class="nf">_length_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return SQL query predicate for querying lattice vector lengths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">double_clause</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length_precision</span><span class="p">)</span></div>

<div class="viewcode-block" id="IcsdDbImporter._density_clause"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter._density_clause">[docs]</a>    <span class="k">def</span> <span class="nf">_density_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return SQL query predicate for querying density.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">double_clause</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_precision</span><span class="p">)</span></div>

<div class="viewcode-block" id="IcsdDbImporter._angle_clause"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter._angle_clause">[docs]</a>    <span class="k">def</span> <span class="nf">_angle_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return SQL query predicate for querying lattice angles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">double_clause</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_precision</span><span class="p">)</span></div>

<div class="viewcode-block" id="IcsdDbImporter._volume_clause"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter._volume_clause">[docs]</a>    <span class="k">def</span> <span class="nf">_volume_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return SQL query predicate for querying unit cell volume.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">double_clause</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_precision</span><span class="p">)</span></div>

<div class="viewcode-block" id="IcsdDbImporter._temperature_clause"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter._temperature_clause">[docs]</a>    <span class="k">def</span> <span class="nf">_temperature_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return SQL query predicate for querying temperature.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">double_clause</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature_precision</span><span class="p">)</span></div>

<div class="viewcode-block" id="IcsdDbImporter._pressure_clause"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter._pressure_clause">[docs]</a>    <span class="k">def</span> <span class="nf">_pressure_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return SQL query predicate for querying pressure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">double_clause</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_precision</span><span class="p">)</span></div>

    <span class="c1"># for the web query</span>
<div class="viewcode-block" id="IcsdDbImporter._parse_all"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter._parse_all">[docs]</a>    <span class="k">def</span> <span class="nf">_parse_all</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert numbers, strings, lists into strings.</span>
<span class="sd">        :param k: query parameter</span>
<span class="sd">        :param v: corresponding values</span>
<span class="sd">        :return retval: string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">retval</span></div>

<div class="viewcode-block" id="IcsdDbImporter._parse_number"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter._parse_number">[docs]</a>    <span class="k">def</span> <span class="nf">_parse_number</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert int into string.</span>
<span class="sd">        :param k: query parameter</span>
<span class="sd">        :param v: corresponding values</span>
<span class="sd">        :return retval: string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">retval</span></div>

<div class="viewcode-block" id="IcsdDbImporter._parse_mineral"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter._parse_mineral">[docs]</a>    <span class="k">def</span> <span class="nf">_parse_mineral</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert mineral_name and chemical_name into right format.</span>
<span class="sd">        :param k: query parameter</span>
<span class="sd">        :param v: corresponding values</span>
<span class="sd">        :return retval: string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;mineral_name&quot;</span><span class="p">:</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="s2">&quot;M=&quot;</span> <span class="o">+</span> <span class="n">v</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;chemical_name&quot;</span><span class="p">:</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="s2">&quot;C=&quot;</span> <span class="o">+</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">retval</span></div>

<div class="viewcode-block" id="IcsdDbImporter._parse_volume"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter._parse_volume">[docs]</a>    <span class="k">def</span> <span class="nf">_parse_volume</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert volume, cell parameter and angle queries into right format.</span>
<span class="sd">        :param k: query parameter</span>
<span class="sd">        :param v: corresponding values</span>
<span class="sd">        :return retval: string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;volume&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;v=&quot;</span> <span class="o">+</span> <span class="n">v</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;a=&quot;</span> <span class="o">+</span> <span class="n">v</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;b=&quot;</span> <span class="o">+</span> <span class="n">v</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;c=&quot;</span> <span class="o">+</span> <span class="n">v</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;al=&quot;</span> <span class="o">+</span> <span class="n">v</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;beta&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;be=&quot;</span> <span class="o">+</span> <span class="n">v</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;gamma&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;ga=&quot;</span> <span class="o">+</span> <span class="n">v</span></div>

<div class="viewcode-block" id="IcsdDbImporter._parse_system"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter._parse_system">[docs]</a>    <span class="k">def</span> <span class="nf">_parse_system</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return crystal system in the right format.</span>
<span class="sd">        :param k: query parameter</span>
<span class="sd">        :param v: corresponding values</span>
<span class="sd">        :return retval: string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid_systems</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;cubic&quot;</span><span class="p">:</span> <span class="s2">&quot;CU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hexagonal&quot;</span><span class="p">:</span> <span class="s2">&quot;HE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;monoclinic&quot;</span><span class="p">:</span> <span class="s2">&quot;MO&quot;</span><span class="p">,</span>
            <span class="s2">&quot;orthorhombic&quot;</span><span class="p">:</span> <span class="s2">&quot;OR&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tetragonal&quot;</span><span class="p">:</span> <span class="s2">&quot;TE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;trigonal&quot;</span><span class="p">:</span> <span class="s2">&quot;TG&quot;</span><span class="p">,</span>
            <span class="s2">&quot;triclinic&quot;</span><span class="p">:</span> <span class="s2">&quot;TC&quot;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">valid_systems</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span></div>

    <span class="c1"># mysql database - query parameter (alias) : [mysql keyword (key), function to call]</span>
    <span class="n">keywords_db</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;COLL_CODE&#39;</span><span class="p">,</span> <span class="n">_int_clause</span><span class="p">],</span>
                   <span class="s1">&#39;element&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;SUM_FORM;&#39;</span><span class="p">,</span> <span class="n">_composition_clause</span><span class="p">],</span>
                   <span class="s1">&#39;number_of_elements&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;EL_COUNT&#39;</span><span class="p">,</span> <span class="n">_int_clause</span><span class="p">],</span>
                   <span class="s1">&#39;chemical_name&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;CHEM_NAME&#39;</span><span class="p">,</span> <span class="n">_str_fuzzy_clause</span><span class="p">],</span>
                   <span class="s1">&#39;formula&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;SUM_FORM&#39;</span><span class="p">,</span> <span class="n">_formula_clause</span><span class="p">],</span>
                   <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;C_VOL&#39;</span><span class="p">,</span> <span class="n">_volume_clause</span><span class="p">],</span>
                   <span class="s1">&#39;spacegroup&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;SGR&#39;</span><span class="p">,</span> <span class="n">_str_exact_clause</span><span class="p">],</span>
                   <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;A_LEN&#39;</span><span class="p">,</span> <span class="n">_length_clause</span><span class="p">],</span>
                   <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;B_LEN&#39;</span><span class="p">,</span> <span class="n">_length_clause</span><span class="p">],</span>
                   <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;C_LEN&#39;</span><span class="p">,</span> <span class="n">_length_clause</span><span class="p">],</span>
                   <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;ALPHA&#39;</span><span class="p">,</span> <span class="n">_angle_clause</span><span class="p">],</span>
                   <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;BETA&#39;</span><span class="p">,</span> <span class="n">_angle_clause</span><span class="p">],</span>
                   <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;GAMMA&#39;</span><span class="p">,</span> <span class="n">_angle_clause</span><span class="p">],</span>
                   <span class="s1">&#39;density&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;DENSITY_CALC&#39;</span><span class="p">,</span> <span class="n">_density_clause</span><span class="p">],</span>
                   <span class="s1">&#39;wyckoff&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;WYCK&#39;</span><span class="p">,</span> <span class="n">_str_exact_clause</span><span class="p">],</span>
                   <span class="s1">&#39;molar_mass&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;MOL_MASS&#39;</span><span class="p">,</span> <span class="n">_density_clause</span><span class="p">],</span>
                   <span class="s1">&#39;pdf_num&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;PDF_NUM&#39;</span><span class="p">,</span> <span class="n">_str_exact_clause</span><span class="p">],</span>
                   <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="n">_int_clause</span><span class="p">],</span>
                   <span class="s1">&#39;measurement_temp&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;TEMPERATURE&#39;</span><span class="p">,</span> <span class="n">_temperature_clause</span><span class="p">],</span>
                   <span class="s1">&#39;authors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;AUTHORS_TEXT&#39;</span><span class="p">,</span> <span class="n">_str_fuzzy_clause</span><span class="p">],</span>
                   <span class="s1">&#39;journal&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;journal&#39;</span><span class="p">,</span> <span class="n">_str_fuzzy_clause</span><span class="p">],</span>
                   <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;AU_TITLE&#39;</span><span class="p">,</span> <span class="n">_str_fuzzy_clause</span><span class="p">],</span>
                   <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;MPY&#39;</span><span class="p">,</span> <span class="n">_int_clause</span><span class="p">],</span>
                   <span class="s1">&#39;crystal_system&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;CRYST_SYS_CODE&#39;</span><span class="p">,</span> <span class="n">_crystal_system_clause</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="c1"># keywords accepted for the web page query</span>
    <span class="n">keywords</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;authors&quot;</span><span class="p">,</span> <span class="n">_parse_all</span><span class="p">),</span>
                <span class="s2">&quot;authors&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;authors&quot;</span><span class="p">,</span> <span class="n">_parse_all</span><span class="p">),</span>
                <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;elements&quot;</span><span class="p">,</span> <span class="n">_parse_all</span><span class="p">),</span>
                <span class="s2">&quot;number_of_elements&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;elementc&quot;</span><span class="p">,</span> <span class="n">_parse_all</span><span class="p">),</span>
                <span class="s2">&quot;mineral_name&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;mineral&quot;</span><span class="p">,</span> <span class="n">_parse_mineral</span><span class="p">),</span>
                <span class="s2">&quot;chemical_name&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;mineral&quot;</span><span class="p">,</span> <span class="n">_parse_mineral</span><span class="p">),</span>
                <span class="s2">&quot;formula&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;formula&quot;</span><span class="p">,</span> <span class="n">_parse_all</span><span class="p">),</span>
                <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="n">_parse_volume</span><span class="p">),</span>
                <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="n">_parse_volume</span><span class="p">),</span>
                <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="n">_parse_volume</span><span class="p">),</span>
                <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="n">_parse_volume</span><span class="p">),</span>
                <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="n">_parse_volume</span><span class="p">),</span>
                <span class="s2">&quot;beta&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="n">_parse_volume</span><span class="p">),</span>
                <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="n">_parse_volume</span><span class="p">),</span>
                <span class="s2">&quot;spacegroup&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;spaceg&quot;</span><span class="p">,</span> <span class="n">_parse_all</span><span class="p">),</span>
                <span class="s2">&quot;journal&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;journal&quot;</span><span class="p">,</span> <span class="n">_parse_all</span><span class="p">),</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">_parse_all</span><span class="p">),</span>
                <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">_parse_all</span><span class="p">),</span>
                <span class="s2">&quot;crystal_system&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">_parse_system</span><span class="p">),</span>
    <span class="p">}</span>
    
<div class="viewcode-block" id="IcsdDbImporter.query"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter.query">[docs]</a>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Depending on the db_parameters, the mysql database or the web page are queried.</span>
<span class="sd">        Valid parameters are found using IcsdDbImporter.get_supported_keywords().</span>

<span class="sd">        :param kwargs: A list of &#39;&#39;keyword = [values]&#39;&#39; pairs.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">[</span><span class="s2">&quot;querydb&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_sql_db</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queryweb</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="IcsdDbImporter._query_sql_db"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter._query_sql_db">[docs]</a>    <span class="k">def</span> <span class="nf">_query_sql_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a query on Icsd mysql database using ``keyword = value`` pairs,</span>
<span class="sd">        specified in ``kwargs``. Returns an instance of IcsdSearchResults.</span>
<span class="sd">        :param kwargs: A list of ``keyword = [values]`` pairs</span>
<span class="sd">        :return: IcsdSearchResults</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sql_where_query</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># second part of sql query</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="n">sql_where_query</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords_db</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> 
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">keywords_db</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> 
                                                        <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)))</span>
        <span class="k">if</span> <span class="s2">&quot;crystal_system&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># to query another table than the main one, add LEFT JOIN in front of WHERE</span>
            <span class="n">sql_query</span> <span class="o">=</span> <span class="s2">&quot;LEFT JOIN space_group ON space_group.sgr=icsd.sgr LEFT &quot;</span>\
                        <span class="s2">&quot;JOIN space_group_number ON &quot;</span>\
                        <span class="s2">&quot;space_group_number.sgr_num=space_group.sgr_num &quot;</span>\
                        <span class="o">+</span> <span class="s2">&quot;WHERE&quot;</span> <span class="o">+</span> <span class="s2">&quot; AND &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sql_where_query</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sql_where_query</span><span class="p">:</span>
            <span class="n">sql_query</span> <span class="o">=</span> <span class="s2">&quot;WHERE&quot;</span> <span class="o">+</span> <span class="s2">&quot; AND &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sql_where_query</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sql_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">return</span> <span class="n">IcsdSearchResults</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">sql_query</span><span class="p">,</span> <span class="n">db_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">)</span></div>


<div class="viewcode-block" id="IcsdDbImporter._queryweb"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter._queryweb">[docs]</a>    <span class="k">def</span> <span class="nf">_queryweb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a query on the Icsd web database using ``keyword = value`` pairs,</span>
<span class="sd">        specified in ``kwargs``. Returns an instance of IcsdSearchResults.</span>
<span class="sd">        :note: Web search has a maximum result number fixed at 1000.</span>
<span class="sd">        :param kwargs: A list of ``keyword = [values]`` pairs</span>
<span class="sd">        :return: IcsdSearchResults</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="n">urllib</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">actual_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;Search&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nb_rows&quot;</span><span class="p">:</span> <span class="s2">&quot;100&quot;</span><span class="p">,</span>  <span class="c1"># max is 100</span>
            <span class="s2">&quot;order_by&quot;</span><span class="p">:</span> <span class="s2">&quot;yearDesc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;authors&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mineral&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">realname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">newv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">](</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="c1"># Because different keys correspond to the same search field.</span>
                <span class="k">if</span> <span class="n">realname</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;authors&quot;</span><span class="p">,</span> <span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;mineral&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">actual_args</span><span class="p">[</span><span class="n">realname</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual_args</span><span class="p">[</span><span class="n">realname</span><span class="p">]</span> <span class="o">+</span> <span class="n">newv</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">actual_args</span><span class="p">[</span><span class="n">realname</span><span class="p">]</span> <span class="o">=</span> <span class="n">newv</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ICSDImporter got an unexpected keyword argument &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">url_values</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actual_args</span><span class="p">)</span>
        <span class="n">query_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">[</span><span class="s2">&quot;urladd&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">url_values</span>

        <span class="k">return</span> <span class="n">IcsdSearchResults</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query_url</span><span class="p">,</span> <span class="n">db_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">)</span></div>

<div class="viewcode-block" id="IcsdDbImporter.setup_db"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter.setup_db">[docs]</a>    <span class="k">def</span> <span class="nf">setup_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the database connection details.</span>
<span class="sd">        At least the host server has to be defined.</span>

<span class="sd">        :param kwargs: db_parameters for the mysql database connection</span>
<span class="sd">          (host, user, passwd, db, port)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>

<div class="viewcode-block" id="IcsdDbImporter.get_supported_keywords"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdDbImporter.get_supported_keywords">[docs]</a>    <span class="k">def</span> <span class="nf">get_supported_keywords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: List of all supported query keywords.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">[</span><span class="s2">&quot;querydb&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords_db</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="IcsdSearchResults"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdSearchResults">[docs]</a><span class="k">class</span> <span class="nc">IcsdSearchResults</span><span class="p">(</span><span class="n">DbSearchResults</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Result manager for the query performed on ICSD.</span>

<span class="sd">    :param query: mysql query or webpage query</span>
<span class="sd">    :param db_parameters: database parameter setup during the</span>
<span class="sd">      initialisation of the IcsdDbImporter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cif_url</span> <span class="o">=</span> <span class="s2">&quot;/index.php?format=cif&amp;action=Export&amp;id%5B%5D=</span><span class="si">{}</span><span class="s2">&quot;</span>
    <span class="n">db_name</span> <span class="o">=</span> <span class="s2">&quot;Icsd&quot;</span>

<div class="viewcode-block" id="IcsdSearchResults.__init__"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdSearchResults.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">db_parameters</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span> <span class="o">=</span> <span class="n">db_parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cif_numbers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_version</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sql_select_query</span> <span class="o">=</span> <span class="s2">&quot;SELECT SQL_CALC_FOUND_ROWS icsd.IDNUM, icsd.COLL_CODE, icsd.STRUCT_FORM &quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sql_from_query</span> <span class="o">=</span> <span class="s2">&quot;FROM icsd &quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">[</span><span class="s2">&quot;querydb&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query_db_version</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_page</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the list of results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span>

<div class="viewcode-block" id="IcsdSearchResults.next"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdSearchResults.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return next result as IcsdEntry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_results</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span></div>

<div class="viewcode-block" id="IcsdSearchResults.at"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdSearchResults.at">[docs]</a>    <span class="k">def</span> <span class="nf">at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return ``position``-th result as IcsdEntry.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">position</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_results</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;index out of bounds&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">position</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query_page</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">position</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">[</span><span class="s2">&quot;querydb&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">position</span><span class="p">]</span> <span class="o">=</span> <span class="n">IcsdEntry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">[</span><span class="s2">&quot;server&quot;</span><span class="p">]</span> <span class="o">+</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">[</span><span class="s2">&quot;dl_db&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cif_url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="n">position</span><span class="p">]),</span>
                    <span class="n">db_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cif_numbers</span><span class="p">[</span><span class="n">position</span><span class="p">],</span> 
                    <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_version</span><span class="p">,</span> 
                    <span class="n">extras</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;idnum&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="n">position</span><span class="p">]})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">position</span><span class="p">]</span> <span class="o">=</span> <span class="n">IcsdEntry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">[</span><span class="s2">&quot;server&quot;</span><span class="p">]</span> <span class="o">+</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">[</span><span class="s2">&quot;dl_db&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cif_url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="n">position</span><span class="p">]),</span>
                    <span class="n">db_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">,</span> <span class="n">extras</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;idnum&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="n">position</span><span class="p">]})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">position</span><span class="p">]</span></div>


<div class="viewcode-block" id="IcsdSearchResults.query_db_version"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdSearchResults.query_db_version">[docs]</a>    <span class="k">def</span> <span class="nf">query_db_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query the version of the icsd database (last row of RELEASE_TAGS).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">[</span><span class="s2">&quot;querydb&quot;</span><span class="p">]:</span>

            <span class="n">sql_select_query</span> <span class="o">=</span> <span class="s2">&quot;SELECT RELEASE_TAG &quot;</span>
            <span class="n">sql_from_query</span> <span class="o">=</span> <span class="s2">&quot;FROM icsd.icsd_database_information &quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_connect_db</span><span class="p">()</span>
            <span class="n">query_statement</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sql_select_query</span><span class="p">,</span> <span class="n">sql_from_query</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_statement</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect_db</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_version</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">IcsdImporterExp</span><span class="p">(</span><span class="s2">&quot;Database version not found&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Cannot query the database version with &quot;</span>
                                      <span class="s2">&quot;a web query.&quot;</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="IcsdSearchResults.query_page"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdSearchResults.query_page">[docs]</a>    <span class="k">def</span> <span class="nf">query_page</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query the mysql or web page database, depending on the db_parameters.</span>
<span class="sd">        Store the number_of_results, cif file number and the corresponding icsd number.</span>

<span class="sd">        :note: Icsd uses its own number system, different from the CIF</span>
<span class="sd">                file numbers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">[</span><span class="s2">&quot;querydb&quot;</span><span class="p">]:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_connect_db</span><span class="p">()</span>
            <span class="n">query_statement</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}{}</span><span class="s2"> LIMIT </span><span class="si">{}</span><span class="s2">, 100&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_select_query</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">sql_from_query</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span>
                                                            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_statement</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cif_numbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT FOUND_ROWS()&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">number_of_results</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect_db</span><span class="p">()</span>


        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="n">urllib</span>
            <span class="kn">from</span> <span class="nn">bs4</span> <span class="k">import</span> <span class="n">BeautifulSoup</span>
            <span class="kn">import</span> <span class="nn">re</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">[</span><span class="s2">&quot;server&quot;</span><span class="p">]</span> <span class="o">+</span> 
                                               <span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">[</span><span class="s2">&quot;db&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> 
                                               <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">)))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">number_of_results</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span>
                                                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NoResultsWebExp</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;checkbox&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="IcsdSearchResults._connect_db"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdSearchResults._connect_db">[docs]</a>    <span class="k">def</span> <span class="nf">_connect_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect to the MySQL database for performing searches.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">MySQLdb</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pymysql</span> <span class="k">as</span> <span class="nn">MySQLdb</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">],</span>
                                  <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span>
                                  <span class="n">passwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">[</span><span class="s1">&#39;passwd&#39;</span><span class="p">],</span>
                                  <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">[</span><span class="s1">&#39;db&#39;</span><span class="p">],</span>
                                  <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_parameters</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span></div>

<div class="viewcode-block" id="IcsdSearchResults._disconnect_db"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdSearchResults._disconnect_db">[docs]</a>    <span class="k">def</span> <span class="nf">_disconnect_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close connection to the MySQL database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="IcsdEntry"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdEntry">[docs]</a><span class="k">class</span> <span class="nc">IcsdEntry</span><span class="p">(</span><span class="n">CifEntry</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represent an entry from Icsd.</span>
<span class="sd">    </span>
<span class="sd">    :note:</span>
<span class="sd">      - Before July 2nd 2015, source[&#39;id&#39;] contained icsd.IDNUM (internal</span>
<span class="sd">        icsd id number) and source[&#39;extras&#39;][&#39;cif_nr&#39;] the cif number </span>
<span class="sd">        (icsd.COLL_CODE).</span>
<span class="sd">      - After July 2nd 2015, source[&#39;id&#39;] has been replaced by the cif </span>
<span class="sd">        number and source[&#39;extras&#39;][&#39;idnum&#39;] is icsd.IDNUM .</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_license</span> <span class="o">=</span> <span class="s1">&#39;ICSD&#39;</span>

<div class="viewcode-block" id="IcsdEntry.__init__"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdEntry.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an instance of IcsdEntry, related to the supplied URI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IcsdEntry</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;db_name&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;db_name&#39;</span><span class="p">,</span><span class="s1">&#39;Icsd&#39;</span><span class="p">),</span>
            <span class="s1">&#39;db_uri&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="n">uri</span><span class="p">,</span>
            <span class="s1">&#39;extras&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;idnum&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;extras&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;idnum&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)},</span>
            <span class="s1">&#39;license&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_license</span><span class="p">,</span>
        <span class="p">}</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">contents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns raw contents of a file as string. This overrides the DbEntry implementation because</span>
<span class="sd">        the ICSD php backend returns the contents of the CIF in ISO-8859-1 encoding. However, the</span>
<span class="sd">        PyCifRW library (and most other sensible applications), expects UTF-8. Therefore, we decode</span>
<span class="sd">        the original CIF data to unicode and encode it in the UTF-8 format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">hashlib</span> <span class="k">import</span> <span class="n">md5</span>
            <span class="kn">from</span> <span class="nn">six.moves.urllib.request</span> <span class="k">import</span> <span class="n">urlopen</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;iso-8859-1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;source_md5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span>

<div class="viewcode-block" id="IcsdEntry.get_ase_structure"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.IcsdEntry.get_ase_structure">[docs]</a>    <span class="k">def</span> <span class="nf">get_ase_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: ASE structure corresponding to the cif file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="n">cStringIO</span> <span class="k">as</span> <span class="n">StringIO</span>
        <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="k">import</span> <span class="n">CifData</span>

        <span class="n">cif</span> <span class="o">=</span> <span class="n">correct_cif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cif</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">CifData</span><span class="o">.</span><span class="n">read_cif</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">cif</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="correct_cif"><a class="viewcode-back" href="../../../../../apidoc/aiida.tools.dbimporters.plugins.html#aiida.tools.dbimporters.plugins.icsd.correct_cif">[docs]</a><span class="k">def</span> <span class="nf">correct_cif</span><span class="p">(</span><span class="n">cif</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Correct the format of the CIF files.</span>
<span class="sd">    At the moment, it only fixes missing quotes in the authors field</span>
<span class="sd">    (``ase.read.io`` only works if the author names are quoted,</span>
<span class="sd">    if not an AssertionError is raised).</span>

<span class="sd">    :param cif: A string containing the content of the CIF file.</span>
<span class="sd">    :return: a string containing the corrected CIF file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Do more checks to be sure it&#39;s working in everycase </span>
    <span class="c1"># -&gt; no _publ_author_name, several lines, correct input</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">cif</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">author_index</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;_publ_author_name&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CifFileErrorExp</span><span class="p">(</span><span class="s1">&#39;_publ_author_name line missing in cif file&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inc</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">words</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">author_index</span> <span class="o">+</span> <span class="n">inc</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="c1">#in case loop is finished -&gt; return cif lines.</span>
            <span class="c1">#use regular expressions ?</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;loop_&quot;</span> <span class="ow">or</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">((</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">and</span> <span class="n">words</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
                  <span class="ow">or</span> <span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">and</span> <span class="n">words</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)):</span>
                <span class="c1"># if quotes are already there, check next line</span>
                <span class="n">inc</span> <span class="o">=</span> <span class="n">inc</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="p">[</span><span class="n">author_index</span> <span class="o">+</span> <span class="n">inc</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">lines</span><span class="p">[</span><span class="n">author_index</span> <span class="o">+</span> <span class="n">inc</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
                <span class="n">inc</span> <span class="o">=</span> <span class="n">inc</span> <span class="o">+</span> <span class="mi">1</span></div>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>