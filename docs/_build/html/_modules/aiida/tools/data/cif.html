

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.tools.data.cif &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.tools.data.cif</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.tools.data.cif</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;Tools to operate on `CifData` nodes.&quot;&quot;&quot;</span>
<span class="c1"># pylint: disable=invalid-name</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="nb">range</span>

<span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="k">import</span> <span class="n">CifData</span>
<span class="kn">from</span> <span class="nn">aiida.engine</span> <span class="k">import</span> <span class="n">calcfunction</span>


<div class="viewcode-block" id="InvalidOccupationsError"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.data.html#aiida.tools.data.cif.InvalidOccupationsError">[docs]</a><span class="k">class</span> <span class="nc">InvalidOccupationsError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An exception that will be raised if pymatgen fails to parse the structure from a</span>
<span class="sd">    cif because some site occupancies exceed the occupancy tolerance. This often happens</span>
<span class="sd">    for structures that have attached species, such as hydrogen, and specify a placeholder</span>
<span class="sd">    position for it, leading to occupancies greater than one. Pymatgen only issues a</span>
<span class="sd">    warning in this case and simply does not return a structure</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<span class="n">symmetry_tags</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;_symmetry_equiv_pos_site_id&#39;</span><span class="p">,</span>
    <span class="s1">&#39;_symmetry_equiv_pos_as_xyz&#39;</span><span class="p">,</span>
    <span class="s1">&#39;_symmetry_Int_Tables_number&#39;</span><span class="p">,</span>
    <span class="s1">&#39;_symmetry_space_group_name_H-M&#39;</span><span class="p">,</span>
    <span class="s1">&#39;_symmetry_space_group_name_Hall&#39;</span><span class="p">,</span>
    <span class="s1">&#39;_space_group_symop_id&#39;</span><span class="p">,</span>
    <span class="s1">&#39;_space_group_symop_operation_xyz&#39;</span><span class="p">,</span>
    <span class="s1">&#39;_space_group_symop_sg_id&#39;</span><span class="p">,</span>
    <span class="s1">&#39;_space_group_id&#39;</span><span class="p">,</span>
    <span class="s1">&#39;_space_group_IT_number&#39;</span><span class="p">,</span>
    <span class="s1">&#39;_space_group_name_H-M_alt&#39;</span><span class="p">,</span>
    <span class="s1">&#39;_space_group_name_Hall&#39;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="symop_string_from_symop_matrix_tr"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.data.html#aiida.tools.data.cif.symop_string_from_symop_matrix_tr">[docs]</a><span class="k">def</span> <span class="nf">symop_string_from_symop_matrix_tr</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">tr</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">eps</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a CIF representation of symmetry operator plus translation.</span>
<span class="sd">    See International Tables for Crystallography Vol. A. (2002) for</span>
<span class="sd">    definition.</span>

<span class="sd">    :param matrix: 3x3 matrix, representing the symmetry operator</span>
<span class="sd">    :param tr: translation vector of length 3 (default 0)</span>
<span class="sd">    :param eps: epsilon parameter for fuzzy comparison x == 0</span>
<span class="sd">    :return: CIF representation of symmetry operator</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
            <span class="k">elif</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">eps</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
            <span class="k">if</span> <span class="n">sign</span><span class="p">:</span>
                <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sign</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">tr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">eps</span> <span class="ow">or</span> <span class="n">tr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">:</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
            <span class="k">if</span> <span class="n">tr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">eps</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
            <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sign</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tr</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
        <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span></div>


<div class="viewcode-block" id="_get_aiida_structure_ase_inline"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.data.html#aiida.tools.data.cif._get_aiida_structure_ase_inline">[docs]</a><span class="nd">@calcfunction</span>
<span class="k">def</span> <span class="nf">_get_aiida_structure_ase_inline</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates :py:class:`aiida.orm.nodes.data.structure.StructureData` using ASE.</span>

<span class="sd">    .. note:: unable to correctly import structures of alloys.</span>
<span class="sd">    .. note:: requires ASE module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="k">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">StructureData</span>

    <span class="n">parameters</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parameters&#39;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get_dict</span><span class="p">()</span>

    <span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;occupancy_tolerance&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;site_tolerance&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;structure&#39;</span><span class="p">:</span> <span class="n">StructureData</span><span class="p">(</span><span class="n">ase</span><span class="o">=</span><span class="n">cif</span><span class="o">.</span><span class="n">get_ase</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">))}</span></div>


<div class="viewcode-block" id="_get_aiida_structure_pymatgen_inline"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.data.html#aiida.tools.data.cif._get_aiida_structure_pymatgen_inline">[docs]</a><span class="nd">@calcfunction</span>
<span class="k">def</span> <span class="nf">_get_aiida_structure_pymatgen_inline</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates :py:class:`aiida.orm.nodes.data.structure.StructureData` using pymatgen.</span>

<span class="sd">    :param occupancy_tolerance: If total occupancy of a site is between 1 and occupancy_tolerance,</span>
<span class="sd">        the occupancies will be scaled down to 1.</span>
<span class="sd">    :param site_tolerance: This tolerance is used to determine if two sites are sitting in the same position,</span>
<span class="sd">        in which case they will be combined to a single disordered site. Defaults to 1e-4.</span>

<span class="sd">    .. note:: requires pymatgen module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pymatgen.io.cif</span> <span class="k">import</span> <span class="n">CifParser</span>
    <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="k">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">StructureData</span>

    <span class="n">parameters</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parameters&#39;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get_dict</span><span class="p">()</span>

    <span class="n">constructor_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;primitive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;primitive_cell&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">argument</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;occupancy_tolerance&#39;</span><span class="p">,</span> <span class="s1">&#39;site_tolerance&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">argument</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
            <span class="n">constructor_kwargs</span><span class="p">[</span><span class="n">argument</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">argument</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">cif</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">CifParser</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">**</span><span class="n">constructor_kwargs</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">structures</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_structures</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>

        <span class="c1"># Verify whether the failure was due to wrong occupancy numbers</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s1">&#39;occupancy_tolerance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E10</span>
            <span class="k">with</span> <span class="n">cif</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="n">parser</span> <span class="o">=</span> <span class="n">CifParser</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">**</span><span class="n">constructor_kwargs</span><span class="p">)</span>
            <span class="n">structures</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_structures</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># If it still fails, the occupancies were not the reason for failure</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;pymatgen failed to provide a structure from the cif file&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If it now succeeds, non-unity occupancies were the culprit</span>
            <span class="k">raise</span> <span class="n">InvalidOccupationsError</span><span class="p">(</span>
                <span class="s1">&#39;detected atomic sites with an occupation number larger than the occupation tolerance&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;structure&#39;</span><span class="p">:</span> <span class="n">StructureData</span><span class="p">(</span><span class="n">pymatgen_structure</span><span class="o">=</span><span class="n">structures</span><span class="p">[</span><span class="mi">0</span><span class="p">])}</span></div>


<div class="viewcode-block" id="refine_inline"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.data.html#aiida.tools.data.cif.refine_inline">[docs]</a><span class="nd">@calcfunction</span>
<span class="k">def</span> <span class="nf">refine_inline</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Refine (reduce) the cell of :py:class:`aiida.orm.nodes.data.cif.CifData`,</span>
<span class="sd">    find and remove symmetrically equivalent atoms.</span>

<span class="sd">    :param node: a :py:class:`aiida.orm.nodes.data.cif.CifData` instance.</span>
<span class="sd">    :return: dict with :py:class:`aiida.orm.nodes.data.cif.CifData`</span>

<span class="sd">    .. note:: can be used as inline calculation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.orm.nodes.data.structure</span> <span class="k">import</span> <span class="n">StructureData</span><span class="p">,</span> <span class="n">ase_refine_cell</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CifData seems to contain more than one data &quot;</span>
                         <span class="s2">&quot;block -- multiblock CIF files are not &quot;</span>
                         <span class="s2">&quot;supported yet&quot;</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">original_atoms</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_ase</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_atoms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CifData seems to contain more than one crystal &quot;</span>
                         <span class="s2">&quot;structure -- such refinement is not supported &quot;</span>
                         <span class="s2">&quot;yet&quot;</span><span class="p">)</span>

    <span class="n">original_atoms</span> <span class="o">=</span> <span class="n">original_atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">refined_atoms</span><span class="p">,</span> <span class="n">symmetry</span> <span class="o">=</span> <span class="n">ase_refine_cell</span><span class="p">(</span><span class="n">original_atoms</span><span class="p">)</span>

    <span class="n">cif</span> <span class="o">=</span> <span class="n">CifData</span><span class="p">(</span><span class="n">ase</span><span class="o">=</span><span class="n">refined_atoms</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">cif</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span>

    <span class="c1"># Remove all existing symmetry tags before overwriting:</span>
    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">symmetry_tags</span><span class="p">:</span>
        <span class="n">cif</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">RemoveCifItem</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>

    <span class="n">cif</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;_symmetry_space_group_name_H-M&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;hm&#39;</span><span class="p">]</span>
    <span class="n">cif</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;_symmetry_space_group_name_Hall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;hall&#39;</span><span class="p">]</span>
    <span class="n">cif</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;_symmetry_Int_Tables_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">]</span>
    <span class="n">cif</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;_symmetry_equiv_pos_as_xyz&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="p">[</span><span class="n">symop_string_from_symop_matrix_tr</span><span class="p">(</span><span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;rotations&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                           <span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;translations&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symmetry</span><span class="p">[</span><span class="s1">&#39;rotations&#39;</span><span class="p">]))]</span>

    <span class="c1"># Summary formula has to be calculated from non-reduced set of atoms.</span>
    <span class="n">cif</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;_chemical_formula_sum&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">StructureData</span><span class="p">(</span><span class="n">ase</span><span class="o">=</span><span class="n">original_atoms</span><span class="p">)</span><span class="o">.</span><span class="n">get_formula</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;hill&#39;</span><span class="p">,</span>
                                                      <span class="n">separator</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="c1"># If the number of reduced atoms multiplies the number of non-reduced</span>
    <span class="c1"># atoms, the new Z value can be calculated.</span>
    <span class="k">if</span> <span class="s1">&#39;_cell_formula_units_Z&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">old_Z</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;_cell_formula_units_Z&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_atoms</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">refined_atoms</span><span class="p">):</span>
            <span class="n">new_Z</span> <span class="o">=</span> <span class="n">old_Z</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_atoms</span><span class="p">)</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">refined_atoms</span><span class="p">)</span>
            <span class="n">cif</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;_cell_formula_units_Z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_Z</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;cif&#39;</span><span class="p">:</span> <span class="n">cif</span><span class="p">}</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>