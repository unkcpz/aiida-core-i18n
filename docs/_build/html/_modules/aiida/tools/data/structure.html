

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.tools.data.structure &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.tools.data.structure</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.tools.data.structure</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="nb">zip</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">aiida.common.constants</span> <span class="k">import</span> <span class="n">elements</span>
<span class="kn">from</span> <span class="nn">aiida.orm.nodes.data.structure</span> <span class="k">import</span> <span class="n">Kind</span><span class="p">,</span> <span class="n">Site</span><span class="p">,</span> <span class="n">StructureData</span>
<span class="kn">from</span> <span class="nn">aiida.engine</span> <span class="k">import</span> <span class="n">calcfunction</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;structure_to_spglib_tuple&#39;</span><span class="p">,</span> <span class="s1">&#39;spglib_tuple_to_structure&#39;</span><span class="p">)</span>


<span class="nd">@calcfunction</span>
<span class="k">def</span> <span class="nf">_get_cif_ase_inline</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates :py:class:`aiida.orm.nodes.data.cif.CifData` using ASE.</span>

<span class="sd">    .. note:: requires ASE module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="k">import</span> <span class="n">CifData</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">parameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get_dict</span><span class="p">()</span>
    <span class="n">cif</span> <span class="o">=</span> <span class="n">CifData</span><span class="p">(</span><span class="n">ase</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">get_ase</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="n">formula</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">get_formula</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;hill&#39;</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cif</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">cif</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;_symmetry_space_group_name_H-M&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;P 1&#39;</span>
        <span class="n">cif</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;_symmetry_space_group_name_Hall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;P 1&#39;</span>
        <span class="n">cif</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;_symmetry_Int_Tables_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">cif</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;_cell_formula_units_Z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">cif</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;_chemical_formula_sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formula</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;cif&#39;</span><span class="p">:</span> <span class="n">cif</span><span class="p">}</span>


<div class="viewcode-block" id="structure_to_spglib_tuple"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.data.structure.html#aiida.tools.structure_to_spglib_tuple">[docs]</a><span class="k">def</span> <span class="nf">structure_to_spglib_tuple</span><span class="p">(</span><span class="n">structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert an AiiDA structure to a tuple of the format (cell, scaled_positions, element_numbers).</span>

<span class="sd">    :param structure: the AiiDA structure</span>
<span class="sd">    :return: (structure_tuple, kind_info, kinds) where structure_tuple</span>
<span class="sd">        is a tuple of format (cell, scaled_positions, element_numbers);</span>
<span class="sd">        kind_info is a dictionary mapping the kind_names to</span>
<span class="sd">        the numbers used in element_numbers. When possible, it uses</span>
<span class="sd">        the Z number of the element, otherwise it uses numbers &gt; 1000;</span>
<span class="sd">        kinds is a list of the kinds of the structure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get_new_number</span><span class="p">(</span><span class="n">the_list</span><span class="p">,</span> <span class="n">start_from</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the first integer &gt;= start_from not yet in the list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">start_from</span>
        <span class="n">comp_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">the_list</span> <span class="k">if</span> <span class="n">_</span> <span class="o">&gt;=</span> <span class="n">start_from</span><span class="p">)</span>

        <span class="n">current_pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comp_list</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">current_pos</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">retval</span>
            <span class="k">if</span> <span class="n">retval</span> <span class="o">==</span> <span class="n">comp_list</span><span class="p">[</span><span class="n">current_pos</span><span class="p">]:</span>
                <span class="n">current_pos</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">retval</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="n">retval</span>

    <span class="n">Z</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">elements</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
    <span class="n">abs_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_</span><span class="o">.</span><span class="n">position</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">sites</span><span class="p">])</span>
    <span class="n">rel_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">abs_pos</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cell</span><span class="p">))</span>
    <span class="n">kinds</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">kinds</span><span class="p">}</span>

    <span class="n">kind_numbers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">kinds</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kind</span><span class="o">.</span><span class="n">symbols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">realnumber</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">kind</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">realnumber</span> <span class="ow">in</span> <span class="n">kind_numbers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">number</span> <span class="o">=</span> <span class="n">get_new_number</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span><span class="n">kind_numbers</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">start_from</span><span class="o">=</span><span class="n">realnumber</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">number</span> <span class="o">=</span> <span class="n">realnumber</span>
            <span class="n">kind_numbers</span><span class="p">[</span><span class="n">kind</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">number</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">number</span> <span class="o">=</span> <span class="n">get_new_number</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">kind_numbers</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">start_from</span><span class="o">=</span><span class="mi">200000</span><span class="p">)</span>
            <span class="n">kind_numbers</span><span class="p">[</span><span class="n">kind</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">number</span>

    <span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="n">kind_numbers</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">kind_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">sites</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">((</span><span class="n">cell</span><span class="p">,</span> <span class="n">rel_pos</span><span class="p">,</span> <span class="n">numbers</span><span class="p">),</span> <span class="n">kind_numbers</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">kinds</span><span class="p">))</span></div>


<div class="viewcode-block" id="spglib_tuple_to_structure"><a class="viewcode-back" href="../../../../apidoc/aiida.tools.data.structure.html#aiida.tools.spglib_tuple_to_structure">[docs]</a><span class="k">def</span> <span class="nf">spglib_tuple_to_structure</span><span class="p">(</span><span class="n">structure_tuple</span><span class="p">,</span> <span class="n">kind_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kinds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a tuple of the format (cell, scaled_positions, element_numbers) to an AiiDA structure.</span>

<span class="sd">    Unless the element_numbers are identical to the Z number of the atoms,</span>
<span class="sd">    you should pass both kind_info and kinds, with the same format as returned</span>
<span class="sd">    by get_tuple_from_aiida_structure.</span>

<span class="sd">    :param structure_tuple: the structure in format (structure_tuple, kind_info)</span>
<span class="sd">    :param kind_info: a dictionary mapping the kind_names to</span>
<span class="sd">       the numbers used in element_numbers. If not provided, assumes {element_name: element_Z}</span>
<span class="sd">    :param kinds: a list of the kinds of the structure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">kind_info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">kinds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If you pass kind_info, you should also pass kinds&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kinds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">kind_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If you pass kinds, you should also pass kind_info&quot;</span><span class="p">)</span>

    <span class="n">Z</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">elements</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">cell</span><span class="p">,</span> <span class="n">rel_pos</span><span class="p">,</span> <span class="n">numbers</span> <span class="o">=</span> <span class="n">structure_tuple</span>
    <span class="k">if</span> <span class="n">kind_info</span><span class="p">:</span>
        <span class="n">_kind_info</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">kind_info</span><span class="p">)</span>
        <span class="n">_kinds</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">kinds</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># For each site</span>
            <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">elements</span><span class="p">[</span><span class="n">num</span><span class="p">][</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You did not pass kind_info, but at least one number &quot;</span>
                             <span class="s2">&quot;is not a valid Z number: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">_kind_info</span> <span class="o">=</span> <span class="p">{</span><span class="n">elements</span><span class="p">[</span><span class="n">num</span><span class="p">][</span><span class="s1">&#39;symbol&#39;</span><span class="p">]:</span> <span class="n">num</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">numbers</span><span class="p">)}</span>
        <span class="c1"># Get the default kinds</span>
        <span class="n">_kinds</span> <span class="o">=</span> <span class="p">[</span><span class="n">Kind</span><span class="p">(</span><span class="n">symbols</span><span class="o">=</span><span class="n">sym</span><span class="p">)</span> <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">symbols</span><span class="p">)]</span>

    <span class="n">_kinds_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_kinds</span><span class="p">}</span>
    <span class="c1"># Now I will use in any case _kinds and _kind_info</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_kind_info</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">_kind_info</span><span class="o">.</span><span class="n">values</span><span class="p">())):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;There is at least a number repeated twice in kind_info!&quot;</span><span class="p">)</span>
    <span class="c1"># Invert the mapping</span>
    <span class="n">mapping_num_kindname</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_kind_info</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="c1"># Create the actual mapping</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mapping_to_kinds</span> <span class="o">=</span> <span class="p">{</span><span class="n">num</span><span class="p">:</span> <span class="n">_kinds_dict</span><span class="p">[</span><span class="n">kindname</span><span class="p">]</span> <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">kindname</span>
                            <span class="ow">in</span> <span class="n">mapping_num_kindname</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Unable to find &#39;</span><span class="si">{}</span><span class="s2">&#39; in the kinds list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">site_kinds</span> <span class="o">=</span> <span class="p">[</span><span class="n">mapping_to_kinds</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to find kind in kind_info for number </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="n">structure</span> <span class="o">=</span> <span class="n">StructureData</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="n">cell</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_kinds</span><span class="p">:</span>
        <span class="n">structure</span><span class="o">.</span><span class="n">append_kind</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">abs_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rel_pos</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">abs_pos</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">site_kinds</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The length of the positions array is different from the &quot;</span>
                         <span class="s2">&quot;length of the element numbers&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">kind</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">site_kinds</span><span class="p">,</span> <span class="n">abs_pos</span><span class="p">):</span>
        <span class="n">structure</span><span class="o">.</span><span class="n">append_site</span><span class="p">(</span><span class="n">Site</span><span class="p">(</span><span class="n">kind_name</span><span class="o">=</span><span class="n">kind</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="n">pos</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">structure</span></div>


<span class="k">def</span> <span class="nf">xyz_parser_iterator</span><span class="p">(</span><span class="n">xyz_string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields a tuple `(natoms, comment, atomiter)`for each frame</span>
<span class="sd">    in a XYZ file where `atomiter` is an iterator yielding a</span>
<span class="sd">    nested tuple `(symbol, (x, y, z))` for each entry.</span>

<span class="sd">    :param xyz_string: a string containing XYZ-structured text</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">BlockIterator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An iterator for wrapping the iterator returned by `match.finditer`</span>
<span class="sd">        to extract the required fields directly from the match object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">natoms</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_it</span> <span class="o">=</span> <span class="n">it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_natoms</span> <span class="o">=</span> <span class="n">natoms</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_catom</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pylint: disable=missing-docstring</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_it</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="c1"># if we reached the number of atoms declared, everything is well</span>
                <span class="c1"># and we re-raise the StopIteration exception</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_catom</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_natoms</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># otherwise we got too less entries</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Number of atom entries (</span><span class="si">{}</span><span class="s2">) is smaller than the number of atoms (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_catom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_natoms</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_catom</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_catom</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_natoms</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Number of atom entries (</span><span class="si">{}</span><span class="s2">) is larger than the number of atoms (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_catom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_natoms</span><span class="p">))</span>

            <span class="k">return</span> <span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;sym&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)),</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)),</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">))))</span>

        <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            The iterator method expected by python 2.x,</span>
<span class="sd">            implemented as python 3.x style method.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span>

    <span class="n">pos_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">^                                                                             # Linestart</span>
<span class="sd">[ \t]*                                                                        # Optional white space</span>
<span class="sd">(?P&lt;sym&gt;[A-Za-z]+[A-Za-z0-9]*)\s+                                             # get the symbol</span>
<span class="sd">(?P&lt;x&gt; [\+\-]?  ( \d*[\.]\d+  | \d+[\.]?\d* )  ([Ee][\+\-]?\d+)? ) [ \t]+     # Get x</span>
<span class="sd">(?P&lt;y&gt; [\+\-]?  ( \d*[\.]\d+  | \d+[\.]?\d* )  ([Ee][\+\-]?\d+)? ) [ \t]+     # Get y</span>
<span class="sd">(?P&lt;z&gt; [\+\-]?  ( \d*[\.]\d+  | \d+[\.]?\d* )  ([Ee][\+\-]?\d+)? )            # Get z</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">X</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
    <span class="n">pos_block_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                                                            # First line contains an integer</span>
<span class="sd">                                                            # and only an integer: the number of atoms</span>
<span class="sd">^[ \t]* (?P&lt;natoms&gt; [0-9]+) [ \t]*[\n]                      # End first line</span>
<span class="sd">(?P&lt;comment&gt;.*) [\n]                                        # The second line is a comment</span>
<span class="sd">(?P&lt;positions&gt;                                              # This is the block of positions</span>
<span class="sd">    (</span>
<span class="sd">        (</span>
<span class="sd">            \s*                                             # White space in front of the element spec is ok</span>
<span class="sd">            (</span>
<span class="sd">                [A-Za-z]+[A-Za-z0-9]*                       # Element spec</span>
<span class="sd">                (</span>
<span class="sd">                    \s+                                     # White space in front of the number</span>
<span class="sd">                    [\+\-]?                                 # Plus or minus in front of the number (optional)</span>
<span class="sd">                    (</span>
<span class="sd">                        (</span>
<span class="sd">                            \d*                             # optional decimal in the beginning .0001 is ok, for example</span>
<span class="sd">                            [\.]                            # There has to be a dot followed by</span>
<span class="sd">                            \d+                             # at least one decimal</span>
<span class="sd">                        )</span>
<span class="sd">                        |                                   # OR</span>
<span class="sd">                        (</span>
<span class="sd">                            \d+                             # at least one decimal, followed by</span>
<span class="sd">                            [\.]?                           # an optional dot</span>
<span class="sd">                            \d*                             # followed by optional decimals</span>
<span class="sd">                        )</span>
<span class="sd">                    )</span>
<span class="sd">                    ([Ee][\+\-]?\d+)?                       # optional exponents E+03, e-05</span>
<span class="sd">                ){3}                                        # I expect three float values</span>
<span class="sd">                |</span>
<span class="sd">                \#                                          # If a line is commented out, that is also ok</span>
<span class="sd">            )</span>
<span class="sd">            .*                                              # ignore what is after the comment or the position spec</span>
<span class="sd">            |                                               # OR</span>
<span class="sd">            \s*                                             # A line only containing white space</span>
<span class="sd">         )</span>
<span class="sd">        [\n]                                                # line break at the end</span>
<span class="sd">    )+</span>
<span class="sd">)                                                           # A positions block should be one or more lines</span>
<span class="sd">                    &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">X</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">pos_block_regex</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">xyz_string</span><span class="p">):</span>
        <span class="n">natoms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;natoms&#39;</span><span class="p">))</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">natoms</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">),</span> <span class="n">BlockIterator</span><span class="p">(</span><span class="n">pos_regex</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;positions&#39;</span><span class="p">)),</span> <span class="n">natoms</span><span class="p">))</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>