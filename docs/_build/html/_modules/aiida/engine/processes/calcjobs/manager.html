

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.engine.processes.calcjobs.manager &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.engine.processes.calcjobs.manager</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.engine.processes.calcjobs.manager</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module containing utilities and classes relating to job calculations running</span>
<span class="sd">on systems that require transport.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">six</span> <span class="k">import</span> <span class="n">iteritems</span><span class="p">,</span> <span class="n">itervalues</span>
<span class="kn">from</span> <span class="nn">tornado</span> <span class="k">import</span> <span class="n">concurrent</span><span class="p">,</span> <span class="n">gen</span>

<span class="kn">from</span> <span class="nn">aiida</span> <span class="k">import</span> <span class="n">schedulers</span>
<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">...utils</span> <span class="k">import</span> <span class="n">RefObjectStore</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;JobsList&#39;</span><span class="p">,</span> <span class="s1">&#39;JobManager&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="JobsList"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.processes.calcjobs.manager.JobsList">[docs]</a><span class="k">class</span> <span class="nc">JobsList</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  <span class="c1"># pylint: disable=useless-object-inheritance</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A list of submitted jobs on a machine connected to by transport based on the</span>
<span class="sd">    authorisation information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="JobsList.__init__"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.processes.calcjobs.manager.JobsList.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authinfo</span><span class="p">,</span> <span class="n">transport_queue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param authinfo: The authinfo used to check the jobs list</span>
<span class="sd">        :type authinfo: :class:`aiida.orm.AuthInfo`</span>
<span class="sd">        :param transport_queue: A transport queue</span>
<span class="sd">        :type: :class:`aiida.engine.transports.TransportQueue`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_authinfo</span> <span class="o">=</span> <span class="n">authinfo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transport_queue</span> <span class="o">=</span> <span class="n">transport_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="o">=</span> <span class="n">transport_queue</span><span class="o">.</span><span class="n">loop</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_jobs_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_updated</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_job_update_requests</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Mapping: {job_id: Future}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_handle</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="JobsList.get_minimum_update_interval"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.processes.calcjobs.manager.JobsList.get_minimum_update_interval">[docs]</a>    <span class="k">def</span> <span class="nf">get_minimum_update_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the minimum interval that can be expected between updates of the list</span>
<span class="sd">        :return: The minimum interval</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authinfo</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">get_minimum_job_poll_interval</span><span class="p">()</span></div>

<div class="viewcode-block" id="JobsList.get_last_updated"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.processes.calcjobs.manager.JobsList.get_last_updated">[docs]</a>    <span class="k">def</span> <span class="nf">get_last_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the timestamp of when the list was last updated as produced by `time.time()`</span>

<span class="sd">        :return: The last update point</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_updated</span></div>

<div class="viewcode-block" id="JobsList._get_jobs_from_scheduler"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.processes.calcjobs.manager.JobsList._get_jobs_from_scheduler">[docs]</a>    <span class="nd">@gen</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">_get_jobs_from_scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the current jobs list from the scheduler</span>

<span class="sd">        :return: A dictionary of {job_id: job info}</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transport_queue</span><span class="o">.</span><span class="n">request_transport</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_authinfo</span><span class="p">)</span> <span class="k">as</span> <span class="n">request</span><span class="p">:</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">request</span>

            <span class="n">scheduler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authinfo</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">get_scheduler</span><span class="p">()</span>
            <span class="n">scheduler</span><span class="o">.</span><span class="n">set_transport</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>

            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;as_dict&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">get_feature</span><span class="p">(</span><span class="s1">&#39;can_query_by_user&#39;</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$USER&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;jobs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_jobs_with_scheduler</span><span class="p">()</span>

            <span class="n">scheduler_response</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">get_jobs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">jobs_cache</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_info</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">scheduler_response</span><span class="p">):</span>
                <span class="c1"># If the job is done then get detailed job information</span>
                <span class="n">detailed_job_info</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">job_info</span><span class="o">.</span><span class="n">job_state</span> <span class="o">==</span> <span class="n">schedulers</span><span class="o">.</span><span class="n">JobState</span><span class="o">.</span><span class="n">DONE</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">detailed_job_info</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">get_detailed_jobinfo</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">FeatureNotAvailable</span><span class="p">:</span>
                        <span class="n">detailed_job_info</span> <span class="o">=</span> <span class="s1">&#39;This scheduler does not implement get_detailed_jobinfo&#39;</span>

                <span class="n">job_info</span><span class="o">.</span><span class="n">detailedJobinfo</span> <span class="o">=</span> <span class="n">detailed_job_info</span>
                <span class="n">jobs_cache</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_info</span>

            <span class="k">raise</span> <span class="n">gen</span><span class="o">.</span><span class="n">Return</span><span class="p">(</span><span class="n">jobs_cache</span><span class="p">)</span></div>

<div class="viewcode-block" id="JobsList._update_job_info"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.processes.calcjobs.manager.JobsList._update_job_info">[docs]</a>    <span class="nd">@gen</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">_update_job_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update all of the job information objects for a given authinfo, that is to say for</span>
<span class="sd">        all the jobs on a particular machine for a particular user.</span>

<span class="sd">        This will set the futures for all pending update requests where the corresponding job</span>
<span class="sd">        has a new status compared to the last update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_requests_outstanding</span><span class="p">():</span>
                <span class="k">return</span>

            <span class="c1"># Update our cache of the job states</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_jobs_cache</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_jobs_from_scheduler</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="c1"># Set the exception on all the update futures</span>
            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_job_update_requests</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">future</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                    <span class="n">future</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_job_update_requests</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">future</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                    <span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobs_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_job_update_requests</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="JobsList.request_job_info_update"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.processes.calcjobs.manager.JobsList.request_job_info_update">[docs]</a>    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">request_job_info_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Request job info about a job when it next changes it&#39;s job state.  If the job is not</span>
<span class="sd">        found in the jobs list at the update the future will resolve to None.</span>

<span class="sd">        :param job_id: The job identifier</span>
<span class="sd">        :return: A future that will resolve to a JobInfo object when the job changes state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get or create the future</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_update_requests</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">Future</span><span class="p">())</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">done</span><span class="p">(),</span> <span class="s2">&quot;The future should be no be in the done state&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_updating</span><span class="p">()</span>
            <span class="k">yield</span> <span class="n">request</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="JobsList._ensure_updating"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.processes.calcjobs.manager.JobsList._ensure_updating">[docs]</a>    <span class="k">def</span> <span class="nf">_ensure_updating</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure that we are updating the job list from the remote resource.</span>
<span class="sd">        This will automatically stop if there are no outstanding requests.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nd">@gen</span><span class="o">.</span><span class="n">coroutine</span>
        <span class="k">def</span> <span class="nf">updating</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot; Do the actual update, stop if not requests left &quot;&quot;&quot;</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_job_info</span><span class="p">()</span>
            <span class="c1"># Any outstanding requests?</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_requests_outstanding</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_handle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_next_update_delay</span><span class="p">(),</span> <span class="n">updating</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_handle</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Check if we&#39;re already updating</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_handle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_handle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_next_update_delay</span><span class="p">(),</span> <span class="n">updating</span><span class="p">)</span></div>

<div class="viewcode-block" id="JobsList._has_job_state_changed"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.processes.calcjobs.manager.JobsList._has_job_state_changed">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_has_job_state_changed</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :type old: :class:`aiida.schedulers.JobInfo`</span>
<span class="sd">        :type new: :class:`aiida.schedulers.JobInfo`</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">new</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">new</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># One is None and the other isn&#39;t</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">old</span><span class="o">.</span><span class="n">job_state</span> <span class="o">!=</span> <span class="n">new</span><span class="o">.</span><span class="n">job_state</span> <span class="ow">or</span> <span class="n">old</span><span class="o">.</span><span class="n">job_substate</span> <span class="o">!=</span> <span class="n">new</span><span class="o">.</span><span class="n">job_substate</span></div>

<div class="viewcode-block" id="JobsList._get_next_update_delay"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.processes.calcjobs.manager.JobsList._get_next_update_delay">[docs]</a>    <span class="k">def</span> <span class="nf">_get_next_update_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate when we are next allowed to call the scheduler get jobs command</span>
<span class="sd">        based on when we last called it, how long has elapsed and the minimum given</span>
<span class="sd">        update interval.</span>

<span class="sd">        :return: The delay (in seconds) for when it&#39;s safe to call the get jobs command</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_updated</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Never updated, so do it straight away</span>
            <span class="k">return</span> <span class="mf">0.</span>

        <span class="c1"># Make sure to actually &#39;get&#39; it here, so that if the user changed it</span>
        <span class="c1"># between times we use the current value</span>
        <span class="n">minimum_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authinfo</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">get_minimum_job_poll_interval</span><span class="p">()</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_updated</span>

        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">minimum_interval</span> <span class="o">-</span> <span class="n">elapsed</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span></div>

<div class="viewcode-block" id="JobsList._update_requests_outstanding"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.processes.calcjobs.manager.JobsList._update_requests_outstanding">[docs]</a>    <span class="k">def</span> <span class="nf">_update_requests_outstanding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_job_update_requests</span><span class="p">))</span></div>

<div class="viewcode-block" id="JobsList._get_jobs_with_scheduler"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.processes.calcjobs.manager.JobsList._get_jobs_with_scheduler">[docs]</a>    <span class="k">def</span> <span class="nf">_get_jobs_with_scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all the jobs that are currently with scheduler for this authinfo</span>

<span class="sd">        :return: the list of jobs with the scheduler</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_update_requests</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span></div></div>


<div class="viewcode-block" id="JobManager"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.processes.calcjobs.manager.JobManager">[docs]</a><span class="k">class</span> <span class="nc">JobManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  <span class="c1"># pylint: disable=useless-object-inheritance</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A manager for jobs on a (usually) remote resource such as a supercomputer</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="JobManager.__init__"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.processes.calcjobs.manager.JobManager.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transport_queue</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transport_queue</span> <span class="o">=</span> <span class="n">transport_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_job_lists</span> <span class="o">=</span> <span class="n">RefObjectStore</span><span class="p">()</span></div>

<div class="viewcode-block" id="JobManager.request_job_info_update"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.processes.calcjobs.manager.JobManager.request_job_info_update">[docs]</a>    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">request_job_info_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authinfo</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a future that will resolve to information about a given job.  This is a context</span>
<span class="sd">        manager so that if the user leaves the context the request is automatically cancelled.</span>

<span class="sd">        :return: A tuple containing the JobInfo object and detailed job info.  Both can be None.</span>
<span class="sd">        :rtype: :class:`tornado.concurrent.Future`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Define a way to create a JobsList if needed</span>
        <span class="n">create</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">JobsList</span><span class="p">,</span> <span class="n">authinfo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transport_queue</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_lists</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">authinfo</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">create</span><span class="p">)</span> <span class="k">as</span> <span class="n">job_list</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">job_list</span><span class="o">.</span><span class="n">request_job_info_update</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span> <span class="k">as</span> <span class="n">request</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">request</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                        <span class="n">request</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>