

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.engine.processes.calcjobs.calcjob &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.engine.processes.calcjobs.calcjob</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.engine.processes.calcjobs.calcjob</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;Implementation of the CalcJob process.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">import</span> <span class="nn">plumpy</span>

<span class="kn">from</span> <span class="nn">aiida</span> <span class="k">import</span> <span class="n">orm</span>
<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">aiida.common.lang</span> <span class="k">import</span> <span class="n">override</span>
<span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>

<span class="kn">from</span> <span class="nn">..process</span> <span class="k">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">ProcessState</span>
<span class="kn">from</span> <span class="nn">..process_spec</span> <span class="k">import</span> <span class="n">CalcJobProcessSpec</span>
<span class="kn">from</span> <span class="nn">.tasks</span> <span class="k">import</span> <span class="n">Waiting</span><span class="p">,</span> <span class="n">UPLOAD_COMMAND</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;CalcJob&#39;</span><span class="p">,)</span>


<div class="viewcode-block" id="CalcJob"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.CalcJob">[docs]</a><span class="k">class</span> <span class="nc">CalcJob</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implementation of the CalcJob process.&quot;&quot;&quot;</span>

    <span class="n">_node_class</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span>
    <span class="n">_spec_class</span> <span class="o">=</span> <span class="n">CalcJobProcessSpec</span>
    <span class="n">link_label_retrieved</span> <span class="o">=</span> <span class="s1">&#39;retrieved&#39;</span>

<div class="viewcode-block" id="CalcJob.__init__"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.CalcJob.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct the instance only if it is a sub class of `CalcJob` otherwise raise `InvalidOperation`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">CalcJob</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InvalidOperation</span><span class="p">(</span><span class="s1">&#39;cannot construct or launch a base `CalcJob` class.&#39;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">CalcJob</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="CalcJob.define"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.CalcJob.define">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="c1"># yapf: disable</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CalcJob</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The Code to use for this job.&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.dry_run&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;When set to True will prepare the calculation job for submission but not actually launch it.&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.input_filename&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Filename to which the input for the code that is to be run will be written.&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.output_filename&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Filename to which the content of stdout of the code that is to be run will be written.&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.scheduler_stdout&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;_scheduler-stdout.txt&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Filename to which the content of stdout of the scheduler will be written.&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.scheduler_stderr&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;_scheduler-stderr.txt&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Filename to which the content of stderr of the scheduler will be written.&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.resources&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set the dictionary of resources to be used by the scheduler plugin, like the number of nodes, &#39;</span>
                 <span class="s1">&#39;cpus etc. This dictionary is scheduler-plugin dependent. Look at the documentation of the &#39;</span>
                 <span class="s1">&#39;scheduler for more details.&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.max_wallclock_seconds&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set the wallclock in seconds asked to the scheduler&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.custom_scheduler_commands&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set a (possibly multiline) string with the commands that the user wants to manually set for the &#39;</span>
                 <span class="s1">&#39;scheduler. The difference of this option with respect to the `prepend_text` is the position in &#39;</span>
                 <span class="s1">&#39;the scheduler submission file where such text is inserted: with this option, the string is &#39;</span>
                 <span class="s1">&#39;inserted before any non-scheduler command&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.queue_name&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set the name of the queue on the remote computer&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.account&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set the account to use in for the queue on the remote computer&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.qos&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set the quality of service to use in for the queue on the remote computer&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.computer&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set the computer to be used by the calculation&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.withmpi&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set the calculation to use mpi&#39;</span><span class="p">,)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.mpirun_extra_params&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set the extra params to pass to the mpirun (or equivalent) command after the one provided in &#39;</span>
                 <span class="s1">&#39;computer.mpirun_command. Example: mpirun -np 8 extra_params[0] extra_params[1] ... exec.x&#39;</span><span class="p">,)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.import_sys_environment&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If set to true, the submission script will load the system environment variables&#39;</span><span class="p">,)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.environment_variables&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set a dictionary of custom environment variables for this calculation&#39;</span><span class="p">,)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.priority&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set the priority of the job to be queued&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.max_memory_kb&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set the maximum memory (in KiloBytes) to be asked to the scheduler&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.prepend_text&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set the calculation-specific prepend text, which is going to be prepended in the scheduler-job &#39;</span>
                 <span class="s1">&#39;script, just before the code execution&#39;</span><span class="p">,)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.append_text&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set the calculation-specific append text, which is going to be appended in the scheduler-job &#39;</span>
                 <span class="s1">&#39;script, just after the code execution&#39;</span><span class="p">,)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;metadata.options.parser_name&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set a string for the output parser. Can be None if no output plugin is available or needed&#39;</span><span class="p">)</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;remote_folder&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">RemoteData</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Input files necessary to run the process will be stored in this folder node.&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">link_label_retrieved</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">FolderData</span><span class="p">,</span> <span class="n">pass_to_parser</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Files that are retrieved by the daemon will be stored in this node. By default the stdout and stderr &#39;</span>
                 <span class="s1">&#39;of the scheduler will be added, but one can add more by specifying them in `CalcInfo.retrieve_list`.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CalcJob.get_state_classes"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.CalcJob.get_state_classes">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_state_classes</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="c1"># Overwrite the waiting state</span>
        <span class="n">states_map</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CalcJob</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">get_state_classes</span><span class="p">()</span>
        <span class="n">states_map</span><span class="p">[</span><span class="n">ProcessState</span><span class="o">.</span><span class="n">WAITING</span><span class="p">]</span> <span class="o">=</span> <span class="n">Waiting</span>
        <span class="k">return</span> <span class="n">states_map</span></div>

<div class="viewcode-block" id="CalcJob.on_terminated"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.CalcJob.on_terminated">[docs]</a>    <span class="nd">@override</span>
    <span class="k">def</span> <span class="nf">on_terminated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cleanup the node by deleting the calulation job state.</span>

<span class="sd">        .. note:: This has to be done before calling the super because that will seal the node after we cannot change it</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">delete_state</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CalcJob</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">on_terminated</span><span class="p">()</span></div>

<div class="viewcode-block" id="CalcJob.run"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.CalcJob.run">[docs]</a>    <span class="nd">@override</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the calculation, we put it in the TOSUBMIT state and then wait for it to be completed.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="k">import</span> <span class="n">Code</span><span class="p">,</span> <span class="n">load_node</span>
        <span class="kn">from</span> <span class="nn">aiida.common.folders</span> <span class="k">import</span> <span class="n">SandboxFolder</span><span class="p">,</span> <span class="n">SubmitTestFolder</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">InputValidationError</span>

        <span class="c1"># The following conditional is required for the caching to properly work. Even if the source node has a process</span>
        <span class="c1"># state of `Finished` the cached process will still enter the running state. The process state will have then</span>
        <span class="c1"># been overridden by the engine to `Running` so we cannot check that, but if the `exit_status` is anything other</span>
        <span class="c1"># than `None`, it should mean this node was taken from the cache, so the process should not be rerun.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">exit_status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">exit_status</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
            <span class="n">folder_class</span> <span class="o">=</span> <span class="n">SubmitTestFolder</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">folder_class</span> <span class="o">=</span> <span class="n">SandboxFolder</span>

        <span class="k">with</span> <span class="n">folder_class</span><span class="p">()</span> <span class="k">as</span> <span class="n">folder</span><span class="p">:</span>
            <span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">computer</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">dry_run</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">has_cached_links</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">InvalidOperation</span><span class="p">(</span><span class="s1">&#39;calculation node has unstored links in cache&#39;</span><span class="p">)</span>

            <span class="n">calc_info</span><span class="p">,</span> <span class="n">script_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">presubmit</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
            <span class="n">calc_info</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="n">input_codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">load_node</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">code_uuid</span><span class="p">,</span> <span class="n">sub_classes</span><span class="o">=</span><span class="p">(</span><span class="n">Code</span><span class="p">,))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">calc_info</span><span class="o">.</span><span class="n">codes_info</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">input_codes</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="o">.</span><span class="n">can_run_on</span><span class="p">(</span><span class="n">computer</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">InputValidationError</span><span class="p">(</span>
                        <span class="s1">&#39;The selected code </span><span class="si">{}</span><span class="s1"> for calculation </span><span class="si">{}</span><span class="s1"> cannot run on computer </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">code</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">computer</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

            <span class="c1"># After this call, no modifications to the folder should be done</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">put_object_from_tree</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">aiida.engine.daemon.execmanager</span> <span class="k">import</span> <span class="n">upload_calculation</span>
                <span class="kn">from</span> <span class="nn">aiida.transports.plugins.local</span> <span class="k">import</span> <span class="n">LocalTransport</span>
                <span class="k">with</span> <span class="n">LocalTransport</span><span class="p">()</span> <span class="k">as</span> <span class="n">transport</span><span class="p">:</span>
                    <span class="n">transport</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">abspath</span><span class="p">)</span>
                    <span class="n">upload_calculation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">transport</span><span class="p">,</span> <span class="n">calc_info</span><span class="p">,</span> <span class="n">script_filename</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">plumpy</span><span class="o">.</span><span class="n">Stop</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Launch the upload operation</span>
        <span class="k">return</span> <span class="n">plumpy</span><span class="o">.</span><span class="n">Wait</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Waiting to upload&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="n">UPLOAD_COMMAND</span><span class="p">,</span> <span class="n">calc_info</span><span class="p">,</span> <span class="n">script_filename</span><span class="p">))</span></div>

<div class="viewcode-block" id="CalcJob.prepare_for_submission"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.CalcJob.prepare_for_submission">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_for_submission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Docs.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="CalcJob.parse"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.CalcJob.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retrieved_temporary_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse a retrieved job calculation.</span>

<span class="sd">        This is called once it&#39;s finished waiting for the calculation to be finished and the data has been retrieved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">shutil</span>
        <span class="kn">from</span> <span class="nn">aiida.engine.daemon</span> <span class="k">import</span> <span class="n">execmanager</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">exit_code</span> <span class="o">=</span> <span class="n">execmanager</span><span class="o">.</span><span class="n">parse_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retrieved_temporary_folder</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Delete the temporary folder</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">retrieved_temporary_folder</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exception</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span>

        <span class="c1"># Finally link up the outputs and we&#39;re done</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_outgoing</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">link_label</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">exit_code</span></div>

<div class="viewcode-block" id="CalcJob.presubmit"><a class="viewcode-back" href="../../../../../apidoc/aiida.engine.processes.calcjobs.html#aiida.engine.CalcJob.presubmit">[docs]</a>    <span class="k">def</span> <span class="nf">presubmit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the calculation folder with all inputs, ready to be copied to the cluster.</span>

<span class="sd">        :param folder: a SandboxFolder, empty in input, that will be filled with</span>
<span class="sd">          calculation input files and the scheduling script.</span>

<span class="sd">        :return calcinfo: the CalcInfo object containing the information</span>
<span class="sd">            needed by the daemon to handle operations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=too-many-locals,too-many-statements,too-many-branches</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">PluginInternalError</span><span class="p">,</span> <span class="n">ValidationError</span>
        <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">json</span>
        <span class="kn">from</span> <span class="nn">aiida.common.utils</span> <span class="k">import</span> <span class="n">validate_list_of_string_tuples</span>
        <span class="kn">from</span> <span class="nn">aiida.common.datastructures</span> <span class="k">import</span> <span class="n">CodeInfo</span><span class="p">,</span> <span class="n">CodeRunMode</span>
        <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="k">import</span> <span class="n">load_node</span><span class="p">,</span> <span class="n">Code</span><span class="p">,</span> <span class="n">Computer</span>
        <span class="kn">from</span> <span class="nn">aiida.plugins</span> <span class="k">import</span> <span class="n">DataFactory</span>
        <span class="kn">from</span> <span class="nn">aiida.schedulers.datastructures</span> <span class="k">import</span> <span class="n">JobTemplate</span>

        <span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">computer</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">(</span><span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">)</span>

        <span class="n">codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">all_nodes</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">Code</span><span class="p">)]</span>

        <span class="n">calcinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_for_submission</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="n">scheduler</span> <span class="o">=</span> <span class="n">computer</span><span class="o">.</span><span class="n">get_scheduler</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">codes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">code</span><span class="o">.</span><span class="n">is_local</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">code</span><span class="o">.</span><span class="n">get_local_executable</span><span class="p">()</span> <span class="ow">in</span> <span class="n">folder</span><span class="o">.</span><span class="n">get_content_list</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">PluginInternalError</span><span class="p">(</span><span class="s2">&quot;The plugin created a file </span><span class="si">{}</span><span class="s2"> that is also &quot;</span>
                                              <span class="s2">&quot;the executable name!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">get_local_executable</span><span class="p">()))</span>

        <span class="c1"># I create the job template to pass to the scheduler</span>
        <span class="n">job_tmpl</span> <span class="o">=</span> <span class="n">JobTemplate</span><span class="p">()</span>
        <span class="n">job_tmpl</span><span class="o">.</span><span class="n">shebang</span> <span class="o">=</span> <span class="n">computer</span><span class="o">.</span><span class="n">get_shebang</span><span class="p">()</span>
        <span class="n">job_tmpl</span><span class="o">.</span><span class="n">submit_as_hold</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">job_tmpl</span><span class="o">.</span><span class="n">rerunnable</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">job_tmpl</span><span class="o">.</span><span class="n">job_environment</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># &#39;email&#39;, &#39;email_on_started&#39;, &#39;email_on_terminated&#39;,</span>
        <span class="n">job_tmpl</span><span class="o">.</span><span class="n">job_name</span> <span class="o">=</span> <span class="s1">&#39;aiida-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_output_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">scheduler_stdout</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">scheduler_stderr</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">scheduler_stdout</span><span class="p">:</span>
            <span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_join_files</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_error_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">scheduler_stderr</span>
            <span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_join_files</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Set retrieve path, add also scheduler STDOUT and STDERR</span>
        <span class="n">retrieve_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">calcinfo</span><span class="o">.</span><span class="n">retrieve_list</span> <span class="k">if</span> <span class="n">calcinfo</span><span class="o">.</span><span class="n">retrieve_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_output_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_output_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">retrieve_list</span><span class="p">):</span>
            <span class="n">retrieve_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_output_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_join_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_error_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_error_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">retrieve_list</span><span class="p">):</span>
                <span class="n">retrieve_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_error_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">set_retrieve_list</span><span class="p">(</span><span class="n">retrieve_list</span><span class="p">)</span>

        <span class="n">retrieve_singlefile_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">calcinfo</span><span class="o">.</span><span class="n">retrieve_singlefile_list</span>
                                    <span class="k">if</span> <span class="n">calcinfo</span><span class="o">.</span><span class="n">retrieve_singlefile_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[])</span>
        <span class="c1"># a validation on the subclasses of retrieve_singlefile_list</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">subclassname</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">retrieve_singlefile_list</span><span class="p">:</span>
            <span class="n">file_sub_class</span> <span class="o">=</span> <span class="n">DataFactory</span><span class="p">(</span><span class="n">subclassname</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">file_sub_class</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">SinglefileData</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PluginInternalError</span><span class="p">(</span>
                    <span class="s2">&quot;[presubmission of calc </span><span class="si">{}</span><span class="s2">] retrieve_singlefile_list subclass problem: </span><span class="si">{}</span><span class="s2"> is &quot;</span>
                    <span class="s2">&quot;not subclass of SinglefileData&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">file_sub_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">set_retrieve_singlefile_list</span><span class="p">(</span><span class="n">retrieve_singlefile_list</span><span class="p">)</span>

        <span class="c1"># Handle the retrieve_temporary_list</span>
        <span class="n">retrieve_temporary_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">calcinfo</span><span class="o">.</span><span class="n">retrieve_temporary_list</span>
                                   <span class="k">if</span> <span class="n">calcinfo</span><span class="o">.</span><span class="n">retrieve_temporary_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">set_retrieve_temporary_list</span><span class="p">(</span><span class="n">retrieve_temporary_list</span><span class="p">)</span>

        <span class="c1"># the if is done so that if the method returns None, this is</span>
        <span class="c1"># not added. This has two advantages:</span>
        <span class="c1"># - it does not add too many \n\n if most of the prepend_text are empty</span>
        <span class="c1"># - most importantly, skips the cases in which one of the methods</span>
        <span class="c1">#   would return None, in which case the join method would raise</span>
        <span class="c1">#   an exception</span>
        <span class="n">prepend_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">computer</span><span class="o">.</span><span class="n">get_prepend_text</span><span class="p">()]</span> <span class="o">+</span> \
            <span class="p">[</span><span class="n">code</span><span class="o">.</span><span class="n">get_prepend_text</span><span class="p">()</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">codes</span><span class="p">]</span> <span class="o">+</span> \
            <span class="p">[</span><span class="n">calcinfo</span><span class="o">.</span><span class="n">prepend_text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;prepend_text&#39;</span><span class="p">)]</span>
        <span class="n">job_tmpl</span><span class="o">.</span><span class="n">prepend_text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prepend_text</span> <span class="k">for</span> <span class="n">prepend_text</span> <span class="ow">in</span> <span class="n">prepend_texts</span> <span class="k">if</span> <span class="n">prepend_text</span><span class="p">)</span>

        <span class="n">append_texts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;append_text&#39;</span><span class="p">),</span> <span class="n">calcinfo</span><span class="o">.</span><span class="n">append_text</span><span class="p">]</span> <span class="o">+</span> \
            <span class="p">[</span><span class="n">code</span><span class="o">.</span><span class="n">get_append_text</span><span class="p">()</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">codes</span><span class="p">]</span> <span class="o">+</span> \
            <span class="p">[</span><span class="n">computer</span><span class="o">.</span><span class="n">get_append_text</span><span class="p">()]</span>
        <span class="n">job_tmpl</span><span class="o">.</span><span class="n">append_text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">append_text</span> <span class="k">for</span> <span class="n">append_text</span> <span class="ow">in</span> <span class="n">append_texts</span> <span class="k">if</span> <span class="n">append_text</span><span class="p">)</span>

        <span class="c1"># Set resources, also with get_default_mpiprocs_per_machine</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">)</span>
        <span class="n">def_cpus_machine</span> <span class="o">=</span> <span class="n">computer</span><span class="o">.</span><span class="n">get_default_mpiprocs_per_machine</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">def_cpus_machine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resources</span><span class="p">[</span><span class="s1">&#39;default_mpiprocs_per_machine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">def_cpus_machine</span>
        <span class="n">job_tmpl</span><span class="o">.</span><span class="n">job_resource</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">create_job_resource</span><span class="p">(</span><span class="o">**</span><span class="n">resources</span><span class="p">)</span>

        <span class="n">subst_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tot_num_mpiprocs&#39;</span><span class="p">:</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">job_resource</span><span class="o">.</span><span class="n">get_tot_num_mpiprocs</span><span class="p">()}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">job_resource</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">subst_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">mpi_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">subst_dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">computer</span><span class="o">.</span><span class="n">get_mpirun_command</span><span class="p">()]</span>
        <span class="n">extra_mpirun_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;mpirun_extra_params&#39;</span><span class="p">)</span>  <span class="c1"># same for all codes in the same calc</span>

        <span class="c1"># set the codes_info</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">calcinfo</span><span class="o">.</span><span class="n">codes_info</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">PluginInternalError</span><span class="p">(</span><span class="s2">&quot;codes_info passed to CalcInfo must be a list of CalcInfo objects&quot;</span><span class="p">)</span>

        <span class="n">codes_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">code_info</span> <span class="ow">in</span> <span class="n">calcinfo</span><span class="o">.</span><span class="n">codes_info</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code_info</span><span class="p">,</span> <span class="n">CodeInfo</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PluginInternalError</span><span class="p">(</span><span class="s2">&quot;Invalid codes_info, must be a list of CodeInfo objects&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">code_info</span><span class="o">.</span><span class="n">code_uuid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PluginInternalError</span><span class="p">(</span><span class="s2">&quot;CalcInfo should have &quot;</span>
                                          <span class="s2">&quot;the information of the code &quot;</span>
                                          <span class="s2">&quot;to be launched&quot;</span><span class="p">)</span>
            <span class="n">this_code</span> <span class="o">=</span> <span class="n">load_node</span><span class="p">(</span><span class="n">code_info</span><span class="o">.</span><span class="n">code_uuid</span><span class="p">,</span> <span class="n">sub_classes</span><span class="o">=</span><span class="p">(</span><span class="n">Code</span><span class="p">,))</span>

            <span class="n">this_withmpi</span> <span class="o">=</span> <span class="n">code_info</span><span class="o">.</span><span class="n">withmpi</span>  <span class="c1"># to decide better how to set the default</span>
            <span class="k">if</span> <span class="n">this_withmpi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">calcinfo</span><span class="o">.</span><span class="n">codes_info</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">PluginInternalError</span><span class="p">(</span><span class="s2">&quot;For more than one code, it is &quot;</span>
                                              <span class="s2">&quot;necessary to set withmpi in &quot;</span>
                                              <span class="s2">&quot;codes_info&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">this_withmpi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;withmpi&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">this_withmpi</span><span class="p">:</span>
                <span class="n">this_argv</span> <span class="o">=</span> <span class="p">(</span><span class="n">mpi_args</span> <span class="o">+</span> <span class="n">extra_mpirun_params</span> <span class="o">+</span> <span class="p">[</span><span class="n">this_code</span><span class="o">.</span><span class="n">get_execname</span><span class="p">()]</span> <span class="o">+</span>
                             <span class="p">(</span><span class="n">code_info</span><span class="o">.</span><span class="n">cmdline_params</span> <span class="k">if</span> <span class="n">code_info</span><span class="o">.</span><span class="n">cmdline_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">this_argv</span> <span class="o">=</span> <span class="p">[</span><span class="n">this_code</span><span class="o">.</span><span class="n">get_execname</span><span class="p">()]</span> <span class="o">+</span> <span class="p">(</span><span class="n">code_info</span><span class="o">.</span><span class="n">cmdline_params</span>
                                                          <span class="k">if</span> <span class="n">code_info</span><span class="o">.</span><span class="n">cmdline_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[])</span>

            <span class="c1"># overwrite the old cmdline_params and add codename and mpirun stuff</span>
            <span class="n">code_info</span><span class="o">.</span><span class="n">cmdline_params</span> <span class="o">=</span> <span class="n">this_argv</span>

            <span class="n">codes_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code_info</span><span class="p">)</span>
        <span class="n">job_tmpl</span><span class="o">.</span><span class="n">codes_info</span> <span class="o">=</span> <span class="n">codes_info</span>

        <span class="c1"># set the codes execution mode</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">codes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">job_tmpl</span><span class="o">.</span><span class="n">codes_run_mode</span> <span class="o">=</span> <span class="n">calcinfo</span><span class="o">.</span><span class="n">codes_run_mode</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PluginInternalError</span><span class="p">(</span><span class="s2">&quot;Need to set the order of the code execution (parallel or serial?)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job_tmpl</span><span class="o">.</span><span class="n">codes_run_mode</span> <span class="o">=</span> <span class="n">CodeRunMode</span><span class="o">.</span><span class="n">SERIAL</span>
        <span class="c1">########################################################################</span>

        <span class="n">custom_sched_commands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;custom_scheduler_commands&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">custom_sched_commands</span><span class="p">:</span>
            <span class="n">job_tmpl</span><span class="o">.</span><span class="n">custom_scheduler_commands</span> <span class="o">=</span> <span class="n">custom_sched_commands</span>

        <span class="n">job_tmpl</span><span class="o">.</span><span class="n">import_sys_environment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;import_sys_environment&#39;</span><span class="p">)</span>

        <span class="n">job_tmpl</span><span class="o">.</span><span class="n">job_environment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;environment_variables&#39;</span><span class="p">)</span>

        <span class="n">queue_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;queue_name&#39;</span><span class="p">)</span>
        <span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;account&#39;</span><span class="p">)</span>
        <span class="n">qos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;qos&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">queue_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_tmpl</span><span class="o">.</span><span class="n">queue_name</span> <span class="o">=</span> <span class="n">queue_name</span>
        <span class="k">if</span> <span class="n">account</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_tmpl</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">account</span>
        <span class="k">if</span> <span class="n">qos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_tmpl</span><span class="o">.</span><span class="n">qos</span> <span class="o">=</span> <span class="n">qos</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;priority&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">priority</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_tmpl</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">priority</span>
        <span class="n">max_memory_kb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;max_memory_kb&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_memory_kb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_tmpl</span><span class="o">.</span><span class="n">max_memory_kb</span> <span class="o">=</span> <span class="n">max_memory_kb</span>
        <span class="n">max_wallclock_seconds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;max_wallclock_seconds&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_wallclock_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_tmpl</span><span class="o">.</span><span class="n">max_wallclock_seconds</span> <span class="o">=</span> <span class="n">max_wallclock_seconds</span>
        <span class="n">max_memory_kb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;max_memory_kb&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_memory_kb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_tmpl</span><span class="o">.</span><span class="n">max_memory_kb</span> <span class="o">=</span> <span class="n">max_memory_kb</span>

        <span class="n">script_filename</span> <span class="o">=</span> <span class="s1">&#39;_aiidasubmit.sh&#39;</span>
        <span class="n">script_content</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">get_submit_script</span><span class="p">(</span><span class="n">job_tmpl</span><span class="p">)</span>
        <span class="n">folder</span><span class="o">.</span><span class="n">create_file_from_filelike</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">script_content</span><span class="p">),</span> <span class="n">script_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>

        <span class="n">subfolder</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="n">get_subfolder</span><span class="p">(</span><span class="s1">&#39;.aiida&#39;</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subfolder</span><span class="o">.</span><span class="n">create_file_from_filelike</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">job_tmpl</span><span class="p">)),</span> <span class="s1">&#39;job_tmpl.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="n">subfolder</span><span class="o">.</span><span class="n">create_file_from_filelike</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">calcinfo</span><span class="p">)),</span> <span class="s1">&#39;calcinfo.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">calcinfo</span><span class="o">.</span><span class="n">local_copy_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">calcinfo</span><span class="o">.</span><span class="n">local_copy_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">calcinfo</span><span class="o">.</span><span class="n">remote_copy_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">calcinfo</span><span class="o">.</span><span class="n">remote_copy_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Some validation</span>
        <span class="n">this_pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">pk</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">pk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;[UNSTORED]&quot;</span>
        <span class="n">local_copy_list</span> <span class="o">=</span> <span class="n">calcinfo</span><span class="o">.</span><span class="n">local_copy_list</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">validate_list_of_string_tuples</span><span class="p">(</span><span class="n">local_copy_list</span><span class="p">,</span> <span class="n">tuple_length</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PluginInternalError</span><span class="p">(</span><span class="s2">&quot;[presubmission of calc </span><span class="si">{}</span><span class="s2">] &quot;</span>
                                      <span class="s2">&quot;local_copy_list format problem: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_pk</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>

        <span class="n">remote_copy_list</span> <span class="o">=</span> <span class="n">calcinfo</span><span class="o">.</span><span class="n">remote_copy_list</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">validate_list_of_string_tuples</span><span class="p">(</span><span class="n">remote_copy_list</span><span class="p">,</span> <span class="n">tuple_length</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PluginInternalError</span><span class="p">(</span><span class="s2">&quot;[presubmission of calc </span><span class="si">{}</span><span class="s2">] &quot;</span>
                                      <span class="s2">&quot;remote_copy_list format problem: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_pk</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">remote_computer_uuid</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dest_rel_path</span><span class="p">)</span> <span class="ow">in</span> <span class="n">remote_copy_list</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">Computer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">remote_computer_uuid</span><span class="p">)</span>  <span class="c1"># pylint: disable=unused-variable</span>
            <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NotExistent</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PluginInternalError</span><span class="p">(</span><span class="s2">&quot;[presubmission of calc </span><span class="si">{}</span><span class="s2">] &quot;</span>
                                          <span class="s2">&quot;The remote copy requires a computer with UUID=</span><span class="si">{}</span><span class="s2">&quot;</span>
                                          <span class="s2">&quot;but no such computer was found in the &quot;</span>
                                          <span class="s2">&quot;database&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_pk</span><span class="p">,</span> <span class="n">remote_computer_uuid</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">dest_rel_path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PluginInternalError</span><span class="p">(</span><span class="s2">&quot;[presubmission of calc </span><span class="si">{}</span><span class="s2">] &quot;</span>
                                          <span class="s2">&quot;The destination path of the remote copy &quot;</span>
                                          <span class="s2">&quot;is absolute! (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_pk</span><span class="p">,</span> <span class="n">dest_rel_path</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">calcinfo</span><span class="p">,</span> <span class="n">script_filename</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>