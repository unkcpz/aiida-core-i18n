

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.schedulers.plugins.direct &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.schedulers.plugins.direct</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.schedulers.plugins.direct</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Plugin for direct execution.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">import</span> <span class="nn">aiida.schedulers</span>
<span class="kn">from</span> <span class="nn">aiida.common.escaping</span> <span class="k">import</span> <span class="n">escape_for_bash</span>
<span class="kn">from</span> <span class="nn">aiida.schedulers</span> <span class="k">import</span> <span class="n">SchedulerError</span>
<span class="kn">from</span> <span class="nn">aiida.schedulers.datastructures</span> <span class="k">import</span> <span class="p">(</span><span class="n">JobInfo</span><span class="p">,</span> <span class="n">JobState</span><span class="p">,</span> <span class="n">NodeNumberJobResource</span><span class="p">)</span>

<span class="c1">## From the ps man page on Mac OS X 10.12</span>
<span class="c1">#     state     The state is given by a sequence of characters, for example,</span>
<span class="c1">#               ``RWNA&#39;&#39;.  The first character indicates the run state of the</span>
<span class="c1">#               process:</span>
<span class="c1">#</span>
<span class="c1">#               I       Marks a process that is idle (sleeping for longer than</span>
<span class="c1">#                       about 20 seconds).</span>
<span class="c1">#               R       Marks a runnable process.</span>
<span class="c1">#               S       Marks a process that is sleeping for less than about 20</span>
<span class="c1">#                       seconds.</span>
<span class="c1">#               T       Marks a stopped process.</span>
<span class="c1">#               U       Marks a process in uninterruptible wait.</span>
<span class="c1">#               Z       Marks a dead process (a ``zombie&#39;&#39;).</span>

<span class="c1"># From the man page of ps on Ubuntu 14.04:</span>
<span class="c1">#       Here are the different values that the s, stat and state output</span>
<span class="c1">#       specifiers (header &quot;STAT&quot; or &quot;S&quot;) will display to describe the state of</span>
<span class="c1">#       a process:</span>
<span class="c1">#</span>
<span class="c1">#               D    uninterruptible sleep (usually IO)</span>
<span class="c1">#               R    running or runnable (on run queue)</span>
<span class="c1">#               S    interruptible sleep (waiting for an event to complete)</span>
<span class="c1">#               T    stopped, either by a job control signal or because it is</span>
<span class="c1">#                    being traced</span>
<span class="c1">#               W    paging (not valid since the 2.6.xx kernel)</span>
<span class="c1">#               X    dead (should never be seen)</span>
<span class="c1">#               Z    defunct (&quot;zombie&quot;) process, terminated but not reaped by</span>
<span class="c1">#                    its parent</span>

<span class="n">_MAP_STATUS_PS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span>
    <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span>
    <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span>
    <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span>
    <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">SUSPENDED</span><span class="p">,</span>
    <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span>
    <span class="s1">&#39;W&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span>
    <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">DONE</span><span class="p">,</span>
    <span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">DONE</span><span class="p">,</span>
    <span class="c1"># Not sure about these three, I comment them out (they used to be in</span>
    <span class="c1"># here, but they don&#39;t appear neither on ubuntu nor on Mac)</span>
    <span class="c1">#    &#39;F&#39;: JobState.DONE,</span>
    <span class="c1">#    &#39;H&#39;: JobState.QUEUED_HELD,</span>
    <span class="c1">#    &#39;Q&#39;: JobState.QUEUED,</span>
<span class="p">}</span>


<div class="viewcode-block" id="DirectJobResource"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.direct.DirectJobResource">[docs]</a><span class="k">class</span> <span class="nc">DirectJobResource</span><span class="p">(</span><span class="n">NodeNumberJobResource</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="DirectScheduler"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.direct.DirectScheduler">[docs]</a><span class="k">class</span> <span class="nc">DirectScheduler</span><span class="p">(</span><span class="n">aiida</span><span class="o">.</span><span class="n">schedulers</span><span class="o">.</span><span class="n">Scheduler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Support for the direct execution bypassing schedulers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_logger</span> <span class="o">=</span> <span class="n">aiida</span><span class="o">.</span><span class="n">schedulers</span><span class="o">.</span><span class="n">Scheduler</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">getChild</span><span class="p">(</span><span class="s1">&#39;direct&#39;</span><span class="p">)</span>

    <span class="c1"># Query only by list of jobs and not by user</span>
    <span class="n">_features</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;can_query_by_user&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># The class to be used for the job resource.</span>
    <span class="n">_job_resource_class</span> <span class="o">=</span> <span class="n">DirectJobResource</span>

<div class="viewcode-block" id="DirectScheduler._get_joblist_command"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.direct.DirectScheduler._get_joblist_command">[docs]</a>    <span class="k">def</span> <span class="nf">_get_joblist_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The command to report full information on existing jobs.</span>

<span class="sd">        TODO: in the case of job arrays, decide what to do (i.e., if we want</span>
<span class="sd">              to pass the -t options to list each subjob).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using subprocess.Popen with `preexec_fn=os.setsid` (as done in both local and ssh transport) results in</span>
        <span class="c1"># processes without a controlling terminal.</span>
        <span class="c1"># The -x option tells ps to include processes which do not have a controlling terminal, which would not be</span>
        <span class="c1"># listed otherwise (leading the direct scheduler to conclude that the process already completed).</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;ps -xo pid,stat,user,time&#39;</span>

        <span class="k">if</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="n">command</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">escape_for_bash</span><span class="p">(</span><span class="n">jobs</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">command</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">escape_for_bash</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;If provided, the &#39;jobs&#39; variable must be a string or a list of strings&quot;</span><span class="p">)</span>

        <span class="n">command</span> <span class="o">+=</span> <span class="s1">&#39;| tail -n +2&#39;</span>  <span class="c1"># -header, do not use &#39;h&#39;</span>

        <span class="k">return</span> <span class="n">command</span></div>

<div class="viewcode-block" id="DirectScheduler._get_submit_script_header"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.direct.DirectScheduler._get_submit_script_header">[docs]</a>    <span class="k">def</span> <span class="nf">_get_submit_script_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_tmpl</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the submit script header, using the parameters from the</span>
<span class="sd">        job_tmpl.</span>

<span class="sd">        Args:</span>
<span class="sd">           job_tmpl: an JobTemplate instance with relevant parameters set.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">empty_line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Redirecting script output on the correct files</span>
        <span class="c1"># Should be one of the first commands</span>
        <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_output_path</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;exec &gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_output_path</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_join_files</span><span class="p">:</span>
            <span class="c1"># TODO: manual says:</span>
            <span class="c1"># By  default both standard output and standard error are directed</span>
            <span class="c1"># to a file of the name &quot;slurm-%j.out&quot;, where the &quot;%j&quot; is replaced</span>
            <span class="c1"># with  the  job  allocation  number.</span>
            <span class="c1"># See that this automatic redirection works also if</span>
            <span class="c1"># I specify a different --output file</span>
            <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_error_path</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;sched_join_files is True, but sched_error_path is set; ignoring sched_error_path&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_error_path</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;exec 2&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_error_path</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># To avoid automatic join of files</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;exec 2&gt;&amp;1&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">max_memory_kb</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">virtual_memory_kb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">max_memory_kb</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">virtual_memory_kb</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max_memory_kb must be &quot;</span>
                                 <span class="s2">&quot;a positive integer (in kB)! It is instead &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span>
                                 <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">max_memory_kb</span><span class="p">)))</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ulimit -v </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">virtual_memory_kb</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">import_sys_environment</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;env --ignore-environment </span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">custom_scheduler_commands</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">custom_scheduler_commands</span><span class="p">)</span>

        <span class="c1"># Job environment variables are to be set on one single line.</span>
        <span class="c1"># This is a tough job due to the escaping of commas, etc.</span>
        <span class="c1"># moreover, I am having issues making it work.</span>
        <span class="c1"># Therefore, I assume that this is bash and export variables by</span>
        <span class="c1"># and.</span>

        <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">job_environment</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">empty_line</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# ENVIRONMENT VARIABLES BEGIN ###&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">job_environment</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If you provide job_environment, it must be a dictionary&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">job_environment</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;export </span><span class="si">{}</span><span class="s2">=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">escape_for_bash</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# ENVIRONMENT VARIABLES  END  ###&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">empty_line</span><span class="p">)</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">empty_line</span><span class="p">)</span>

        <span class="c1">## The following code is not working as there&#39;s an empty line</span>
        <span class="c1">## inserted between the header and the actual command.</span>
        <span class="c1"># if job_tmpl.max_wallclock_seconds is not None:</span>
        <span class="c1">#     try:</span>
        <span class="c1">#         tot_secs = int(job_tmpl.max_wallclock_seconds)</span>
        <span class="c1">#         if tot_secs &lt;= 0:</span>
        <span class="c1">#             raise ValueError</span>
        <span class="c1">#     except ValueError:</span>
        <span class="c1">#         raise ValueError(</span>
        <span class="c1">#             &quot;max_wallclock_seconds must be &quot;</span>
        <span class="c1">#             &quot;a positive integer (in seconds)! It is instead &#39;{}&#39;&quot;</span>
        <span class="c1">#             &quot;&quot;.format((job_tmpl.max_wallclock_seconds)))</span>
        <span class="c1">#     lines.append(&quot;timeout {} \\&quot;.format(tot_secs))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="DirectScheduler._get_submit_command"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.direct.DirectScheduler._get_submit_command">[docs]</a>    <span class="k">def</span> <span class="nf">_get_submit_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submit_script</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the string to execute to submit a given script.</span>

<span class="sd">        .. note:: One needs to redirect stdout and stderr to /dev/null</span>
<span class="sd">           otherwise the daemon remains hanging for the script to run</span>

<span class="sd">        :param submit_script: the path of the submit script relative to the working</span>
<span class="sd">            directory.</span>
<span class="sd">            IMPORTANT: submit_script should be already escaped.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">submit_command</span> <span class="o">=</span> <span class="s1">&#39;bash -e </span><span class="si">{}</span><span class="s1"> &gt; /dev/null 2&gt;&amp;1 &amp; echo $!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">submit_script</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;submitting with: &quot;</span> <span class="o">+</span> <span class="n">submit_command</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">submit_command</span></div>

<div class="viewcode-block" id="DirectScheduler._parse_joblist_output"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.direct.DirectScheduler._parse_joblist_output">[docs]</a>    <span class="k">def</span> <span class="nf">_parse_joblist_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retval</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the queue output string, as returned by executing the</span>
<span class="sd">        command returned by _get_joblist_command command (qstat -f).</span>

<span class="sd">        Return a list of JobInfo objects, one of each job,</span>
<span class="sd">        each relevant parameters implemented.</span>

<span class="sd">        .. note:: depending on the scheduler configuration, finished jobs</span>
<span class="sd">            may either appear here, or not.</span>
<span class="sd">            This function will only return one element for each job find</span>
<span class="sd">            in the qstat output; missing jobs (for whatever reason) simply</span>
<span class="sd">            will not appear here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">re</span>

        <span class="n">filtered_stderr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">stderr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">filtered_stderr</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Warning in _parse_joblist_output, non-empty &quot;</span>
                                <span class="s2">&quot;(filtered) stderr=&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filtered_stderr</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s2">&quot;Error during direct execution parsing (_parse_joblist_output function)&quot;</span><span class="p">)</span>

        <span class="c1"># Create dictionary and parse specific fields</span>
        <span class="n">job_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s*PID&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="c1"># Skip the header if present</span>
                <span class="k">continue</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="n">this_job</span> <span class="o">=</span> <span class="n">JobInfo</span><span class="p">()</span>
            <span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s2">&quot;Unexpected output from the scheduler, &quot;</span>
                                     <span class="s2">&quot;not enough fields in line &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">job_state_string</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># I just check the first character</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No &#39;job_state&#39; field for job id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>
                <span class="n">this_job</span><span class="o">.</span><span class="n">job_state</span> <span class="o">=</span> <span class="n">JobState</span><span class="o">.</span><span class="n">UNDETERMINED</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">this_job</span><span class="o">.</span><span class="n">job_state</span> <span class="o">=</span> \
                        <span class="n">_MAP_STATUS_PS</span><span class="p">[</span><span class="n">job_state_string</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unrecognized job_state &#39;</span><span class="si">{}</span><span class="s2">&#39; for job &quot;</span>
                                        <span class="s2">&quot;id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_state_string</span><span class="p">,</span> <span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>
                    <span class="n">this_job</span><span class="o">.</span><span class="n">job_state</span> <span class="o">=</span> <span class="n">JobState</span><span class="o">.</span><span class="n">UNDETERMINED</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># I strip the part after the @: is this always ok?</span>
                <span class="n">this_job</span><span class="o">.</span><span class="n">job_owner</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No &#39;job_owner&#39; field for job id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">this_job</span><span class="o">.</span><span class="n">wallclock_time_seconds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_time</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># May not have started yet</span>
                <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Error parsing &#39;resources_used.walltime&#39; for job id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>

            <span class="c1"># I append to the list of jobs to return</span>
            <span class="n">job_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_job</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">job_list</span></div>

<div class="viewcode-block" id="DirectScheduler.get_jobs"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.direct.DirectScheduler.get_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">get_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">as_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overrides original method from DirectScheduler in order to list</span>
<span class="sd">        missing processes as DONE.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">job_stats</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">DirectScheduler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_jobs</span><span class="p">(</span><span class="n">jobs</span><span class="o">=</span><span class="n">jobs</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">as_dict</span><span class="o">=</span><span class="n">as_dict</span><span class="p">)</span>

        <span class="n">found_jobs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Get the list of known jobs</span>
        <span class="k">if</span> <span class="n">as_dict</span><span class="p">:</span>
            <span class="n">found_jobs</span> <span class="o">=</span> <span class="n">job_stats</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">found_jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span><span class="o">.</span><span class="n">job_id</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">job_stats</span><span class="p">]</span>
        <span class="c1"># Now check if there are any the user requested but were not found</span>
        <span class="n">not_found_jobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">found_jobs</span><span class="p">))</span> <span class="k">if</span> <span class="n">jobs</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="n">not_found_jobs</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">JobInfo</span><span class="p">()</span>
            <span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span>
            <span class="n">job</span><span class="o">.</span><span class="n">job_state</span> <span class="o">=</span> <span class="n">JobState</span><span class="o">.</span><span class="n">DONE</span>
            <span class="c1"># Owner and wallclock time is unknown</span>
            <span class="k">if</span> <span class="n">as_dict</span><span class="p">:</span>
                <span class="n">job_stats</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">job_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">job_stats</span></div>

<div class="viewcode-block" id="DirectScheduler._convert_time"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.direct.DirectScheduler._convert_time">[docs]</a>    <span class="k">def</span> <span class="nf">_convert_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a string in the format HH:MM:SS to a number of seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">re</span>

        <span class="n">pieces</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[:.]&#39;</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pieces</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Wrong number of pieces (expected 3) for time string </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">string</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong number of pieces for time string.&quot;</span><span class="p">)</span>

        <span class="n">days</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pieces_first</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pieces_first</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">days</span><span class="p">,</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pieces_first</span>
            <span class="n">days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">days</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">hours</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not a valid number of hours: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not a valid number of hours.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">mins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">mins</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not a valid number of minutes: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not a valid number of minutes.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">secs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">secs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not a valid number of seconds: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not a valid number of seconds.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">days</span> <span class="o">*</span> <span class="mi">86400</span> <span class="o">+</span> <span class="n">hours</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">+</span> <span class="n">mins</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">secs</span></div>

<div class="viewcode-block" id="DirectScheduler._parse_submit_output"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.direct.DirectScheduler._parse_submit_output">[docs]</a>    <span class="k">def</span> <span class="nf">_parse_submit_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retval</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the output of the submit command, as returned by executing the</span>
<span class="sd">        command returned by _get_submit_command command.</span>

<span class="sd">        To be implemented by the plugin.</span>

<span class="sd">        Return a string with the JobID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in _parse_submit_output: retval=</span><span class="si">{}</span><span class="s2">; &quot;</span>
                              <span class="s2">&quot;stdout=</span><span class="si">{}</span><span class="s2">; stderr=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s2">&quot;Error during submission, retval=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                                 <span class="s2">&quot;stdout=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">stderr=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">stderr</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;in _parse_submit_output for </span><span class="si">{}</span><span class="s2">: &quot;</span>
                                <span class="s2">&quot;there was some text in stderr: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="p">),</span> <span class="n">stderr</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Unable to get the PID: retval=</span><span class="si">{}</span><span class="s2">; &quot;</span>
                              <span class="s2">&quot;stdout=</span><span class="si">{}</span><span class="s2">; stderr=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s2">&quot;Unable to get the PID: retval=</span><span class="si">{}</span><span class="s2">; &quot;</span>
                                 <span class="s2">&quot;stdout=</span><span class="si">{}</span><span class="s2">; stderr=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></div>

<div class="viewcode-block" id="DirectScheduler._get_kill_command"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.direct.DirectScheduler._get_kill_command">[docs]</a>    <span class="k">def</span> <span class="nf">_get_kill_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the command to kill the job with specified jobid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">submit_command</span> <span class="o">=</span> <span class="s1">&#39;kill </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;killing job </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">submit_command</span></div>

<div class="viewcode-block" id="DirectScheduler._parse_kill_output"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.direct.DirectScheduler._parse_kill_output">[docs]</a>    <span class="k">def</span> <span class="nf">_parse_kill_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retval</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the output of the kill command.</span>

<span class="sd">        To be implemented by the plugin.</span>

<span class="sd">        :return: True if everything seems ok, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in _parse_kill_output: retval=</span><span class="si">{}</span><span class="s2">; &quot;</span>
                              <span class="s2">&quot;stdout=</span><span class="si">{}</span><span class="s2">; stderr=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">stderr</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;in _parse_kill_output for </span><span class="si">{}</span><span class="s2">: &quot;</span>
                                <span class="s2">&quot;there was some text in stderr: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="p">),</span> <span class="n">stderr</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;in _parse_kill_output for </span><span class="si">{}</span><span class="s2">: &quot;</span>
                                <span class="s2">&quot;there was some text in stdout: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="p">),</span> <span class="n">stdout</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">True</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>