

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.schedulers.plugins.pbsbaseclasses &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.schedulers.plugins.pbsbaseclasses</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.schedulers.plugins.pbsbaseclasses</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Base classes for PBSPro and PBS/Torque plugins.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">from</span> <span class="nn">aiida.common.escaping</span> <span class="k">import</span> <span class="n">escape_for_bash</span>
<span class="kn">from</span> <span class="nn">aiida.schedulers</span> <span class="k">import</span> <span class="n">Scheduler</span><span class="p">,</span> <span class="n">SchedulerError</span><span class="p">,</span> <span class="n">SchedulerParsingError</span>
<span class="kn">from</span> <span class="nn">aiida.schedulers.datastructures</span> <span class="k">import</span> <span class="p">(</span><span class="n">JobInfo</span><span class="p">,</span> <span class="n">JobState</span><span class="p">,</span> <span class="n">MachineInfo</span><span class="p">,</span> <span class="n">NodeNumberJobResource</span><span class="p">)</span>

<span class="n">_LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># This maps PbsPro status letters to our own status list</span>

<span class="c1">## List of states from the man page of qstat</span>
<span class="c1"># B  Array job has at least one subjob running.</span>
<span class="c1"># E  Job is exiting after having run.</span>
<span class="c1"># F  Job is finished.</span>
<span class="c1"># H  Job is held.</span>
<span class="c1"># M  Job was moved to another server.</span>
<span class="c1"># Q  Job is queued.</span>
<span class="c1"># R  Job is running.</span>
<span class="c1"># S  Job is suspended.</span>
<span class="c1"># T  Job is being moved to new location.</span>
<span class="c1"># U  Cycle-harvesting job is suspended due to  keyboard  activity.</span>
<span class="c1"># W  Job is waiting for its submitter-assigned start time to be reached.</span>
<span class="c1"># X  Subjob has completed execution or has been deleted.</span>

<span class="c1">## These are instead the states from PBS/Torque v.2.4.16 (from Ubuntu)</span>
<span class="c1"># C -  Job is completed after having run [different from above, but not clashing]</span>
<span class="c1"># E -  Job is exiting after having run. [same as above]</span>
<span class="c1"># H -  Job is held. [same as above]</span>
<span class="c1"># Q -  job is queued, eligible to run or routed. [same as above]</span>
<span class="c1"># R -  job is running. [same as above]</span>
<span class="c1"># T -  job is being moved to new location. [same as above]</span>
<span class="c1"># W -  job is waiting for its execution time</span>
<span class="c1">#     (-a option) to be reached. [similar to above]</span>
<span class="c1"># S -  (Unicos only) job is suspend. [as above]</span>

<span class="n">_MAP_STATUS_PBS_COMMON</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span>
    <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span>  <span class="c1"># If exiting, for our purposes it is still running</span>
    <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">DONE</span><span class="p">,</span>
    <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">QUEUED_HELD</span><span class="p">,</span>
    <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">UNDETERMINED</span><span class="p">,</span>  <span class="c1"># TODO: check if this is ok?</span>
    <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">QUEUED</span><span class="p">,</span>
    <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span>
    <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">SUSPENDED</span><span class="p">,</span>
    <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">QUEUED</span><span class="p">,</span>  <span class="c1"># We assume that from the AiiDA point of view</span>
    <span class="c1"># it is still queued</span>
    <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">SUSPENDED</span><span class="p">,</span>
    <span class="s1">&#39;W&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">QUEUED</span><span class="p">,</span>
    <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">DONE</span><span class="p">,</span>
    <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">JobState</span><span class="o">.</span><span class="n">DONE</span><span class="p">,</span>  <span class="c1"># This is the completed state of PBS/Torque</span>
<span class="p">}</span>


<div class="viewcode-block" id="PbsJobResource"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.pbsbaseclasses.PbsJobResource">[docs]</a><span class="k">class</span> <span class="nc">PbsJobResource</span><span class="p">(</span><span class="n">NodeNumberJobResource</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for PBS job resources</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PbsJobResource.__init__"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.pbsbaseclasses.PbsJobResource.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        It extends the base class init method and calculates the</span>
<span class="sd">        num_cores_per_machine fields to pass to PBSlike schedulers.</span>

<span class="sd">        Checks that num_cores_per_machine is a multiple of</span>
<span class="sd">        num_cores_per_mpiproc and/or num_mpiprocs_per_machine</span>

<span class="sd">        Check sequence</span>

<span class="sd">        1. If num_cores_per_mpiproc and num_cores_per_machine both are</span>
<span class="sd">           specified check whether it satisfies the check</span>
<span class="sd">        2. If only num_cores_per_mpiproc is passed, calculate</span>
<span class="sd">           num_cores_per_machine</span>
<span class="sd">        3. If only num_cores_per_machine is passed, use it</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PbsJobResource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">value_error</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;num_cores_per_machine must be equal to &quot;</span>
                       <span class="s2">&quot;num_cores_per_mpiproc * num_mpiprocs_per_machine, &quot;</span>
                       <span class="s2">&quot;and in perticular it should be a multiple of &quot;</span>
                       <span class="s2">&quot;num_cores_per_mpiproc and/or num_mpiprocs_per_machine&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cores_per_machine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cores_per_mpiproc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cores_per_machine</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cores_per_mpiproc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_mpiprocs_per_machine</span><span class="p">):</span>
                <span class="c1"># If user specify both values, check if specified</span>
                <span class="c1"># values are correct</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">value_error</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cores_per_mpiproc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cores_per_mpiproc</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_cores_per_mpiproc must be &gt;=1&quot;</span><span class="p">)</span>
            <span class="c1"># calculate num_cores_per_machine</span>
            <span class="c1"># In this plugin we never used num_cores_per_mpiproc so if it</span>
            <span class="c1"># is not defined it is OK.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_cores_per_machine</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cores_per_mpiproc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_mpiprocs_per_machine</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PbsBaseClass"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.pbsbaseclasses.PbsBaseClass">[docs]</a><span class="nd">@six</span><span class="o">.</span><span class="n">add_metaclass</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">PbsBaseClass</span><span class="p">(</span><span class="n">Scheduler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class with support for the PBSPro scheduler</span>
<span class="sd">    (http://www.pbsworks.com/) and for PBS and Torque</span>
<span class="sd">    (http://www.adaptivecomputing.com/products/open-source/torque/).</span>

<span class="sd">    Only a few properties need to be redefined, see examples of the pbspro and</span>
<span class="sd">    torque plugins</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Query only by list of jobs and not by user</span>
    <span class="n">_features</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;can_query_by_user&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># The class to be used for the job resource.</span>
    <span class="n">_job_resource_class</span> <span class="o">=</span> <span class="n">PbsJobResource</span>

    <span class="n">_map_status</span> <span class="o">=</span> <span class="n">_MAP_STATUS_PBS_COMMON</span>

<div class="viewcode-block" id="PbsBaseClass._get_resource_lines"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.pbsbaseclasses.PbsBaseClass._get_resource_lines">[docs]</a>    <span class="k">def</span> <span class="nf">_get_resource_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_machines</span><span class="p">,</span> <span class="n">num_mpiprocs_per_machine</span><span class="p">,</span> <span class="n">num_cores_per_machine</span><span class="p">,</span> <span class="n">max_memory_kb</span><span class="p">,</span>
                            <span class="n">max_wallclock_seconds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a set a list of lines (possibly empty) with the header</span>
<span class="sd">        lines relative to:</span>

<span class="sd">        * num_machines</span>
<span class="sd">        * num_mpiprocs_per_machine</span>
<span class="sd">        * num_cores_per_machine</span>
<span class="sd">        * max_memory_kb</span>
<span class="sd">        * max_wallclock_seconds</span>

<span class="sd">        This is done in an external function because it may change in</span>
<span class="sd">        different subclasses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Implement the _get_resource_lines in each subclass!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PbsBaseClass._get_joblist_command"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.pbsbaseclasses.PbsBaseClass._get_joblist_command">[docs]</a>    <span class="k">def</span> <span class="nf">_get_joblist_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The command to report full information on existing jobs.</span>

<span class="sd">        TODO: in the case of job arrays, decide what to do (i.e., if we want</span>
<span class="sd">              to pass the -t options to list each subjob).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">FeatureNotAvailable</span>

        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;qstat&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">jobs</span> <span class="ow">and</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FeatureNotAvailable</span><span class="p">(</span><span class="s2">&quot;Cannot query by user and job(s) in PBS&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-u</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">escape_for_bash</span><span class="p">(</span><span class="n">jobs</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">escape_for_bash</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;If provided, the &#39;jobs&#39; variable must be a string or an iterable of strings&quot;</span><span class="p">)</span>

        <span class="n">comm</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;qstat command: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comm</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">comm</span></div>

<div class="viewcode-block" id="PbsBaseClass._get_detailed_jobinfo_command"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.pbsbaseclasses.PbsBaseClass._get_detailed_jobinfo_command">[docs]</a>    <span class="k">def</span> <span class="nf">_get_detailed_jobinfo_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the command to run to get the detailed information on a job,</span>
<span class="sd">        even after the job has finished.</span>

<span class="sd">        The output text is just retrieved, and returned for logging purposes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;tracejob -v </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">escape_for_bash</span><span class="p">(</span><span class="n">jobid</span><span class="p">))</span></div>

<div class="viewcode-block" id="PbsBaseClass._get_submit_script_header"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.pbsbaseclasses.PbsBaseClass._get_submit_script_header">[docs]</a>    <span class="k">def</span> <span class="nf">_get_submit_script_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_tmpl</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the submit script header, using the parameters from the</span>
<span class="sd">        job_tmpl.</span>

<span class="sd">        Args:</span>
<span class="sd">           job_tmpl: an JobTemplate instance with relevant parameters set.</span>

<span class="sd">        TODO: truncate the title if too long</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">re</span>
        <span class="kn">import</span> <span class="nn">string</span>

        <span class="n">empty_line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">submit_as_hold</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#PBS -h&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">rerunnable</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#PBS -r y&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#PBS -r n&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
            <span class="c1"># If not specified, but email events are set, PBSPro</span>
            <span class="c1"># sends the mail to the job owner by default</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;#PBS -M </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">email</span><span class="p">))</span>

        <span class="n">email_events</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">email_on_started</span><span class="p">:</span>
            <span class="n">email_events</span> <span class="o">+=</span> <span class="s2">&quot;b&quot;</span>
        <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">email_on_terminated</span><span class="p">:</span>
            <span class="n">email_events</span> <span class="o">+=</span> <span class="s2">&quot;ea&quot;</span>
        <span class="k">if</span> <span class="n">email_events</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#PBS -m </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">email_events</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Email triggers provided to PBSPro script for job,&quot;</span>
                             <span class="s2">&quot;but no email field set; will send emails to &quot;</span>
                             <span class="s2">&quot;the job owner as set in the scheduler&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#PBS -m n&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">job_name</span><span class="p">:</span>
            <span class="c1"># From qsub man page:</span>
            <span class="c1"># string, up to 15 characters in length.  It must</span>
            <span class="c1"># consist of an  alphabetic  or  numeric  character</span>
            <span class="c1"># followed  by printable, non-white-space characters.</span>
            <span class="c1"># Default:  if a script is used to submit the job, the job&#39;s name</span>
            <span class="c1"># is the name of the script.  If no script  is  used,  the  job&#39;s</span>
            <span class="c1"># name is &quot;STDIN&quot;.</span>
            <span class="c1">#</span>
            <span class="c1"># I leave only letters, numbers, dots, dashes and underscores</span>
            <span class="c1"># Note: I don&#39;t compile the regexp, I am going to use it only once</span>
            <span class="n">job_title</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^a-zA-Z0-9_.-]+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>

            <span class="c1"># prepend a &#39;j&#39; (for &#39;job&#39;) before the string if the string</span>
            <span class="c1"># is now empty or does not start with a valid charachter</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">job_title</span> <span class="ow">or</span> <span class="p">(</span><span class="n">job_title</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">):</span>
                <span class="n">job_title</span> <span class="o">=</span> <span class="s1">&#39;j&#39;</span> <span class="o">+</span> <span class="n">job_title</span>

            <span class="c1"># Truncate to the first 15 characters</span>
            <span class="c1"># Nothing is done if the string is shorter.</span>
            <span class="n">job_title</span> <span class="o">=</span> <span class="n">job_title</span><span class="p">[:</span><span class="mi">15</span><span class="p">]</span>

            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#PBS -N </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_title</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">import_sys_environment</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#PBS -V&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_output_path</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#PBS -o </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_output_path</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_join_files</span><span class="p">:</span>
            <span class="c1"># from qsub man page:</span>
            <span class="c1"># &#39;oe&#39;: Standard error and standard output are merged  into</span>
            <span class="c1">#       standard output</span>
            <span class="c1"># &#39;eo&#39;: Standard error and standard output are merged  into</span>
            <span class="c1">#       standard error</span>
            <span class="c1"># &#39;n&#39; : Standard error and standard output are not merged (default)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#PBS -j oe&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_error_path</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;sched_join_files is True, but sched_error_path is set in &quot;</span>
                             <span class="s2">&quot;PBSPro script; ignoring sched_error_path&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_error_path</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#PBS -e </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">sched_error_path</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">queue_name</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#PBS -q </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">queue_name</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">account</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#PBS -A </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">account</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">priority</span><span class="p">:</span>
            <span class="c1"># Priority of the job.  Format: host-dependent integer.  Default:</span>
            <span class="c1"># zero.   Range:  [-1024,  +1023] inclusive.  Sets job&#39;s Priority</span>
            <span class="c1"># attribute to priority.</span>
            <span class="c1"># TODO: Here I expect that priority is passed in the correct PBSPro</span>
            <span class="c1"># format. To fix.</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#PBS -p </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">priority</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">job_resource</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Job resources (as the num_machines) are required for the PBSPro scheduler plugin&quot;</span><span class="p">)</span>

        <span class="n">resource_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resource_lines</span><span class="p">(</span>
            <span class="n">num_machines</span><span class="o">=</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">job_resource</span><span class="o">.</span><span class="n">num_machines</span><span class="p">,</span>
            <span class="n">num_mpiprocs_per_machine</span><span class="o">=</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">job_resource</span><span class="o">.</span><span class="n">num_mpiprocs_per_machine</span><span class="p">,</span>
            <span class="n">num_cores_per_machine</span><span class="o">=</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">job_resource</span><span class="o">.</span><span class="n">num_cores_per_machine</span><span class="p">,</span>
            <span class="n">max_memory_kb</span><span class="o">=</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">max_memory_kb</span><span class="p">,</span>
            <span class="n">max_wallclock_seconds</span><span class="o">=</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">max_wallclock_seconds</span><span class="p">)</span>

        <span class="n">lines</span> <span class="o">+=</span> <span class="n">resource_lines</span>

        <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">custom_scheduler_commands</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">custom_scheduler_commands</span><span class="p">)</span>

        <span class="c1"># Job environment variables are to be set on one single line.</span>
        <span class="c1"># This is a tough job due to the escaping of commas, etc.</span>
        <span class="c1"># moreover, I am having issues making it work.</span>
        <span class="c1"># Therefore, I assume that this is bash and export variables by</span>
        <span class="c1"># and.</span>

        <span class="k">if</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">job_environment</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">empty_line</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# ENVIRONMENT VARIABLES BEGIN ###&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_tmpl</span><span class="o">.</span><span class="n">job_environment</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If you provide job_environment, it must be a dictionary&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">job_tmpl</span><span class="o">.</span><span class="n">job_environment</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;export </span><span class="si">{}</span><span class="s2">=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">escape_for_bash</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# ENVIRONMENT VARIABLES  END  ###&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">empty_line</span><span class="p">)</span>

        <span class="c1"># Required to change directory to the working directory, that is</span>
        <span class="c1"># the one from which the job was submitted</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cd &quot;$PBS_O_WORKDIR&quot;&#39;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">empty_line</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="PbsBaseClass._get_submit_command"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.pbsbaseclasses.PbsBaseClass._get_submit_command">[docs]</a>    <span class="k">def</span> <span class="nf">_get_submit_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submit_script</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the string to execute to submit a given script.</span>

<span class="sd">        Args:</span>
<span class="sd">            submit_script: the path of the submit script relative to the working</span>
<span class="sd">                directory.</span>
<span class="sd">                IMPORTANT: submit_script should be already escaped.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">submit_command</span> <span class="o">=</span> <span class="s1">&#39;qsub </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">submit_script</span><span class="p">)</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;submitting with: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">submit_command</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">submit_command</span></div>

<div class="viewcode-block" id="PbsBaseClass._parse_joblist_output"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.pbsbaseclasses.PbsBaseClass._parse_joblist_output">[docs]</a>    <span class="k">def</span> <span class="nf">_parse_joblist_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retval</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the queue output string, as returned by executing the</span>
<span class="sd">        command returned by _get_joblist_command command (qstat -f).</span>

<span class="sd">        Return a list of JobInfo objects, one of each job,</span>
<span class="sd">        each relevant parameters implemented.</span>

<span class="sd">        Note: depending on the scheduler configuration, finished jobs may</span>
<span class="sd">            either appear here, or not.</span>
<span class="sd">            This function will only return one element for each job find</span>
<span class="sd">            in the qstat output; missing jobs (for whatever reason) simply</span>
<span class="sd">            will not appear here.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># I don&#39;t raise because if I pass a list of jobs, I get a non-zero status</span>
        <span class="c1"># if one of the job is not in the list anymore</span>

        <span class="c1"># retval should be zero</span>
        <span class="c1"># if retval != 0:</span>
        <span class="c1"># _LOGGER.warning(&quot;Error in _parse_joblist_output: retval={}; &quot;</span>
        <span class="c1">#    &quot;stdout={}; stderr={}&quot;.format(retval, stdout, stderr))</span>

        <span class="c1"># issue a warning if there is any stderr output</span>
        <span class="c1"># but I strip lines containing &quot;Unknown Job Id&quot;, that happens</span>
        <span class="c1"># also when I ask for a calculation that has finished</span>
        <span class="c1">#</span>
        <span class="c1"># I also strip for &quot;Job has finished&quot; because this happens for</span>
        <span class="c1"># those schedulers configured to leave the job in the output</span>
        <span class="c1"># of qstat for some time after job completion.</span>
        <span class="n">filtered_stderr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">stderr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;Unknown Job Id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span> <span class="ow">and</span> <span class="s2">&quot;Job has finished&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filtered_stderr</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Warning in _parse_joblist_output, non-empty &quot;</span>
                            <span class="s2">&quot;(filtered) stderr=&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filtered_stderr</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s2">&quot;Error during qstat parsing (_parse_joblist_output function)&quot;</span><span class="p">)</span>

        <span class="n">jobdata_raw</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># will contain raw data parsed from qstat output</span>
        <span class="c1"># Get raw data and split in lines</span>
        <span class="k">for</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Each new job stanza starts with the string &#39;Job Id:&#39;: I</span>
            <span class="c1"># create a new item in the jobdata_raw list</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Job Id:&#39;</span><span class="p">):</span>
                <span class="n">jobdata_raw</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s1">&#39;lines&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;warning_lines_idx&#39;</span><span class="p">:</span> <span class="p">[]})</span>
                <span class="c1"># warning_lines_idx: lines that do not start either with</span>
                <span class="c1"># tab or space</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                    <span class="c1"># This is a non-empty line, therefore it is an attribute</span>
                    <span class="c1"># of the last job found</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">jobdata_raw</span><span class="p">:</span>
                        <span class="c1"># The list is still empty! (This means that I found a</span>
                        <span class="c1"># non-empty line, before finding the first &#39;Job Id:&#39;</span>
                        <span class="c1"># string: it is an error. However this may happen</span>
                        <span class="c1"># only before the first job.</span>
                        <span class="k">raise</span> <span class="n">SchedulerParsingError</span><span class="p">(</span><span class="s2">&quot;I did not find the header for the first job&quot;</span><span class="p">)</span>
                        <span class="c1"># _LOGGER.warning(&quot;I found some text before the &quot;</span>
                        <span class="c1"># &quot;first job: {}&quot;.format(l))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">):</span>
                            <span class="c1"># If it starts with a space, it is a new field</span>
                            <span class="n">jobdata_raw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;lines&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">):</span>
                            <span class="c1"># If a line starts with a TAB,</span>
                            <span class="c1"># I append to the previous string</span>
                            <span class="c1"># stripping the TAB</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">jobdata_raw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;lines&#39;</span><span class="p">]:</span>
                                <span class="k">raise</span> <span class="n">SchedulerParsingError</span><span class="p">(</span><span class="s2">&quot;Line </span><span class="si">{}</span><span class="s2"> is the first line of the job, but it &quot;</span>
                                                            <span class="s2">&quot;starts with a TAB! (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_num</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
                            <span class="n">jobdata_raw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;lines&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># raise SchedulerParsingError(</span>
                            <span class="c1">#    &quot;Wrong starting character at line {}! ({})&quot;</span>
                            <span class="c1">#    &quot;&quot;.format(line_num, l))</span>
                            <span class="c1">## For some reasons, the output of &#39;comment&#39; and</span>
                            <span class="c1">## &#39;Variable_List&#39;, for instance, can have</span>
                            <span class="c1">## newlines if they are included... # I do a</span>
                            <span class="c1">## workaround</span>
                            <span class="n">jobdata_raw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;lines&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                            <span class="n">jobdata_raw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;warning_lines_idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jobdata_raw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;lines&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create dictionary and parse specific fields</span>
        <span class="n">job_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobdata_raw</span><span class="p">:</span>
            <span class="n">this_job</span> <span class="o">=</span> <span class="n">JobInfo</span><span class="p">()</span>
            <span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

            <span class="n">lines_without_equals_sign</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;lines&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;=&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>

            <span class="c1"># There are lines without equals sign: this is bad</span>
            <span class="k">if</span> <span class="n">lines_without_equals_sign</span><span class="p">:</span>
                <span class="c1"># Should I only warn?</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;There are lines without equals sign! </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lines_without_equals_sign</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">SchedulerParsingError</span><span class="p">(</span><span class="s2">&quot;There are lines without equals sign.&quot;</span><span class="p">)</span>

            <span class="n">raw_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;lines&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">i</span>
            <span class="p">}</span>

            <span class="c1">## I ignore the errors for the time being - this seems to be</span>
            <span class="c1">## a problem if there are \n in the content of some variables?</span>
            <span class="c1">## I consider this a workaround...</span>
            <span class="c1"># for line_with_warning in set(job[&#39;warning_lines_idx&#39;]):</span>
            <span class="c1">#    if job[&#39;lines&#39;][line_with_warning].split(</span>
            <span class="c1">#        &#39;=&#39;,1)[0].strip().lower() != &quot;comment&quot;:</span>
            <span class="c1">#        raise SchedulerParsingError(</span>
            <span class="c1">#            &quot;Wrong starting character in one of the lines &quot;</span>
            <span class="c1">#            &quot;of job {}, and it&#39;s not a comment! ({})&quot;</span>
            <span class="c1">#            &quot;&quot;.format(this_job.job_id,</span>
            <span class="c1">#                      job[&#39;lines&#39;][line_with_warning]))</span>

            <span class="n">problematic_fields</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line_with_warning</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;warning_lines_idx&#39;</span><span class="p">]):</span>
                <span class="n">problematic_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;lines&#39;</span><span class="p">][</span><span class="n">line_with_warning</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">problematic_fields</span><span class="p">:</span>
                <span class="c1"># These are the fields that contain unexpected newlines</span>
                <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;warning_fields_with_newlines&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">problematic_fields</span>

            <span class="c1"># I believe that exit_status and terminating_signal cannot be</span>
            <span class="c1"># retrieved from the qstat -f output.</span>

            <span class="c1"># I wrap calls in try-except clauses to avoid errors if a field</span>
            <span class="c1"># is missing</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">this_job</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;job_name&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No &#39;job_name&#39; field for job id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">this_job</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># Many jobs do not have a comment; I do not complain about it.</span>
                <span class="k">pass</span>
                <span class="c1"># _LOGGER.debug(&quot;No &#39;comment&#39; field for job id {}&quot;.format(</span>
                <span class="c1">#    this_job.job_id))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">job_state_string</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;job_state&#39;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">this_job</span><span class="o">.</span><span class="n">job_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_status</span><span class="p">[</span><span class="n">job_state_string</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unrecognized job_state &#39;</span><span class="si">{}</span><span class="s2">&#39; for job &quot;</span>
                                    <span class="s2">&quot;id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_state_string</span><span class="p">,</span> <span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>
                    <span class="n">this_job</span><span class="o">.</span><span class="n">job_state</span> <span class="o">=</span> <span class="n">JobState</span><span class="o">.</span><span class="n">UNDETERMINED</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No &#39;job_state&#39; field for job id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>
                <span class="n">this_job</span><span class="o">.</span><span class="n">job_state</span> <span class="o">=</span> <span class="n">JobState</span><span class="o">.</span><span class="n">UNDETERMINED</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">this_job</span><span class="o">.</span><span class="n">job_substate</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;substate&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No &#39;substate&#39; field for job id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">exec_hosts</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;exec_host&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># No exec_host information found (it may be ok, if the job</span>
                <span class="c1"># is not running)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># parse each host; syntax, from the man page:</span>
                <span class="c1"># hosta/J1+hostb/J2*P+...</span>
                <span class="c1"># where  J1 and J2 are an index of the job</span>
                <span class="c1"># on the named host and P is the number of</span>
                <span class="c1"># processors allocated from that host to this job.</span>
                <span class="c1"># P does not appear if it is 1.</span>
                <span class="k">try</span><span class="p">:</span>

                    <span class="n">exec_host_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">exec_host</span> <span class="ow">in</span> <span class="n">exec_hosts</span><span class="p">:</span>
                        <span class="n">node</span> <span class="o">=</span> <span class="n">MachineInfo</span><span class="p">()</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">exec_host</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">jobIndex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">num_cpus</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">jobIndex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">num_cpus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong number of pieces: </span><span class="si">{}</span><span class="s2"> &quot;</span>
                                             <span class="s2">&quot;instead of 1 or 2 in exec_hosts: &quot;</span>
                                             <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">exec_hosts</span><span class="p">))</span>
                        <span class="n">exec_host_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="n">this_job</span><span class="o">.</span><span class="n">allocated_machines</span> <span class="o">=</span> <span class="n">exec_host_list</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Problem parsing the node names, I &quot;</span>
                                  <span class="s2">&quot;got Exception </span><span class="si">{}</span><span class="s2"> with message </span><span class="si">{}</span><span class="s2">; &quot;</span>
                                  <span class="s2">&quot;exec_hosts was </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">)),</span> <span class="n">exc</span><span class="p">,</span> <span class="n">exec_hosts</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># I strip the part after the @: is this always ok?</span>
                <span class="n">this_job</span><span class="o">.</span><span class="n">job_owner</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;job_owner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No &#39;job_owner&#39; field for job id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">this_job</span><span class="o">.</span><span class="n">num_cpus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;resource_list.ncpus&#39;</span><span class="p">])</span>
                <span class="c1"># TODO: understand if this is the correct field also for</span>
                <span class="c1">#       multithreaded (OpenMP) jobs.</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No &#39;resource_list.ncpus&#39; field for job id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;resource_list.ncpus&#39; is not an integer &quot;</span>
                                <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">) for job id </span><span class="si">{}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;resource_list.ncpus&#39;</span><span class="p">],</span> <span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">this_job</span><span class="o">.</span><span class="n">num_mpiprocs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;resource_list.mpiprocs&#39;</span><span class="p">])</span>
                <span class="c1"># TODO: understand if this is the correct field also for</span>
                <span class="c1">#       multithreaded (OpenMP) jobs.</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No &#39;resource_list.mpiprocs&#39; field for job id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;resource_list.mpiprocs&#39; is not an integer &quot;</span>
                                <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">) for job id </span><span class="si">{}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;resource_list.mpiprocs&#39;</span><span class="p">],</span> <span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">this_job</span><span class="o">.</span><span class="n">num_machines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;resource_list.nodect&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No &#39;resource_list.nodect&#39; field for job id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;resource_list.nodect&#39; is not an integer &quot;</span>
                                <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">) for job id </span><span class="si">{}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;resource_list.nodect&#39;</span><span class="p">],</span> <span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>

            <span class="c1"># Double check of redundant info</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">this_job</span><span class="o">.</span><span class="n">allocated_machines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">this_job</span><span class="o">.</span><span class="n">num_machines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">machine</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">machine</span> <span class="ow">in</span> <span class="n">this_job</span><span class="o">.</span><span class="n">allocated_machines</span><span class="p">))</span> <span class="o">!=</span> <span class="n">this_job</span><span class="o">.</span><span class="n">num_machines</span><span class="p">:</span>
                    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The length of the list of allocated &quot;</span>
                                  <span class="s2">&quot;nodes (</span><span class="si">{}</span><span class="s2">) is different from the &quot;</span>
                                  <span class="s2">&quot;expected number of nodes (</span><span class="si">{}</span><span class="s2">)!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                      <span class="nb">len</span><span class="p">(</span><span class="n">this_job</span><span class="o">.</span><span class="n">allocated_machines</span><span class="p">),</span> <span class="n">this_job</span><span class="o">.</span><span class="n">num_machines</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">this_job</span><span class="o">.</span><span class="n">queue_name</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;queue&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No &#39;queue&#39; field for job id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">this_job</span><span class="o">.</span><span class="n">RequestedWallclockTime</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_time</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;resource_list.walltime&#39;</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No &#39;resource_list.walltime&#39; field for job id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Error parsing &#39;resource_list.walltime&#39; for job id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">this_job</span><span class="o">.</span><span class="n">wallclock_time_seconds</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_time</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;resources_used.walltime&#39;</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># May not have started yet</span>
                <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Error parsing &#39;resources_used.walltime&#39; for job id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">this_job</span><span class="o">.</span><span class="n">cpu_time</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_time</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;resources_used.cput&#39;</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># May not have started yet</span>
                <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Error parsing &#39;resources_used.cput&#39; for job id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>

            <span class="c1">#</span>
            <span class="c1"># ctime: The time that the job was created</span>
            <span class="c1"># mtime: The time that the job was last modified, changed state,</span>
            <span class="c1">#        or changed locations.</span>
            <span class="c1"># qtime: The time that the job entered the current queue</span>
            <span class="c1"># stime: The time when the job started execution.</span>
            <span class="c1"># etime: The time that the job became eligible to run, i.e. in a</span>
            <span class="c1">#        queued state while residing in an execution queue.</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">this_job</span><span class="o">.</span><span class="n">submission_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_time_string</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;ctime&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No &#39;ctime&#39; field for job id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Error parsing &#39;ctime&#39; for job id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">this_job</span><span class="o">.</span><span class="n">dispatch_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_time_string</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;stime&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># The job may not have been started yet</span>
                <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Error parsing &#39;stime&#39; for job id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>

            <span class="c1"># TODO: see if we want to set also finish_time for finished jobs,</span>
            <span class="c1"># if there are any</span>

            <span class="c1"># Everything goes here anyway for debugging purposes</span>
            <span class="n">this_job</span><span class="o">.</span><span class="n">raw_data</span> <span class="o">=</span> <span class="n">raw_data</span>

            <span class="c1"># I append to the list of jobs to return</span>
            <span class="n">job_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_job</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">job_list</span></div>

<div class="viewcode-block" id="PbsBaseClass._convert_time"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.pbsbaseclasses.PbsBaseClass._convert_time">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_convert_time</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a string in the format HH:MM:SS to a number of seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pieces</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pieces</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Wrong number of pieces (expected 3) for time string </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">string</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong number of pieces for time string.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">hours</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not a valid number of hours: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not a valid number of hours.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">mins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">mins</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not a valid number of minutes: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not a valid number of minutes.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">secs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">secs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not a valid number of seconds: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not a valid number of seconds.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">hours</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">+</span> <span class="n">mins</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">secs</span></div>

<div class="viewcode-block" id="PbsBaseClass._parse_time_string"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.pbsbaseclasses.PbsBaseClass._parse_time_string">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_parse_time_string</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%a</span><span class="s1"> %b </span><span class="si">%d</span><span class="s1"> %H:%M:%S %Y&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse a time string in the format returned from qstat -f and</span>
<span class="sd">        returns a datetime object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">time</span>
        <span class="kn">import</span> <span class="nn">datetime</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">time_struct</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Unable to parse time string </span><span class="si">{}</span><span class="s2">, the message was </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Problem parsing the time string.&quot;</span><span class="p">)</span>

        <span class="c1"># I convert from a time_struct to a datetime object going through</span>
        <span class="c1"># the seconds since epoch, as suggested on stackoverflow:</span>
        <span class="c1"># http://stackoverflow.com/questions/1697815</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">time_struct</span><span class="p">))</span></div>

<div class="viewcode-block" id="PbsBaseClass._parse_submit_output"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.pbsbaseclasses.PbsBaseClass._parse_submit_output">[docs]</a>    <span class="k">def</span> <span class="nf">_parse_submit_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retval</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the output of the submit command, as returned by executing the</span>
<span class="sd">        command returned by _get_submit_command command.</span>

<span class="sd">        To be implemented by the plugin.</span>

<span class="sd">        Return a string with the JobID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in _parse_submit_output: retval=</span><span class="si">{}</span><span class="s2">; &quot;</span>
                          <span class="s2">&quot;stdout=</span><span class="si">{}</span><span class="s2">; stderr=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s2">&quot;Error during submission, retval=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                                 <span class="s2">&quot;stdout=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">stderr=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">stderr</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;in _parse_submit_output there was some text in stderr: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stderr</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></div>

<div class="viewcode-block" id="PbsBaseClass._get_kill_command"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.pbsbaseclasses.PbsBaseClass._get_kill_command">[docs]</a>    <span class="k">def</span> <span class="nf">_get_kill_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the command to kill the job with specified jobid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">submit_command</span> <span class="o">=</span> <span class="s1">&#39;qdel </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;killing job </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">submit_command</span></div>

<div class="viewcode-block" id="PbsBaseClass._parse_kill_output"><a class="viewcode-back" href="../../../../apidoc/aiida.schedulers.plugins.html#aiida.schedulers.plugins.pbsbaseclasses.PbsBaseClass._parse_kill_output">[docs]</a>    <span class="k">def</span> <span class="nf">_parse_kill_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retval</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the output of the kill command.</span>

<span class="sd">        To be implemented by the plugin.</span>

<span class="sd">        :return: True if everything seems ok, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in _parse_kill_output: retval=</span><span class="si">{}</span><span class="s2">; &quot;</span>
                          <span class="s2">&quot;stdout=</span><span class="si">{}</span><span class="s2">; stderr=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">stderr</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;in _parse_kill_output there was some text in stderr: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stderr</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;in _parse_kill_output there was some text in stdout: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stdout</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">True</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>