

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.restapi.translator.node &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.restapi.translator.node</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.restapi.translator.node</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;Translator for node&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">InputValidationError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">,</span> \
    <span class="n">InvalidOperation</span>
<span class="kn">from</span> <span class="nn">aiida.restapi.common.exceptions</span> <span class="k">import</span> <span class="n">RestValidationError</span>
<span class="kn">from</span> <span class="nn">aiida.restapi.translator.base</span> <span class="k">import</span> <span class="n">BaseTranslator</span>
<span class="kn">from</span> <span class="nn">aiida.manage.manager</span> <span class="k">import</span> <span class="n">get_manager</span>
<span class="kn">from</span> <span class="nn">aiida</span> <span class="k">import</span> <span class="n">orm</span>


<div class="viewcode-block" id="NodeTranslator"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.translator.html#aiida.restapi.translator.node.NodeTranslator">[docs]</a><span class="k">class</span> <span class="nc">NodeTranslator</span><span class="p">(</span><span class="n">BaseTranslator</span><span class="p">):</span>
    <span class="c1"># pylint: disable=too-many-instance-attributes,anomalous-backslash-in-string,too-many-arguments,too-many-branches,fixme</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Translator relative to resource &#39;nodes&#39; and aiida class Node</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># A label associated to the present class (coincides with the resource name)</span>
    <span class="n">__label__</span> <span class="o">=</span> <span class="s2">&quot;nodes&quot;</span>
    <span class="c1"># The AiiDA class one-to-one associated to the present class</span>
    <span class="n">_aiida_class</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Node</span>
    <span class="c1"># The string name of the AiiDA class</span>
    <span class="n">_aiida_type</span> <span class="o">=</span> <span class="s2">&quot;node.Node&quot;</span>
    <span class="c1"># The string associated to the AiiDA class in the query builder lexicon</span>
    <span class="n">_qb_type</span> <span class="o">=</span> <span class="n">_aiida_type</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>

    <span class="c1"># If True (False) the corresponding AiiDA class has (no) uuid property</span>
    <span class="n">_has_uuid</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">_result_type</span> <span class="o">=</span> <span class="n">__label__</span>

    <span class="n">_content_type</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_alist</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_nalist</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_elist</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_nelist</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_downloadformat</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_visformat</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_filename</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_rtype</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="NodeTranslator.__init__"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.translator.html#aiida.restapi.translator.node.NodeTranslator.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise the parameters.</span>
<span class="sd">        Create the basic query_help</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Assume default class is this class (cannot be done in the</span>
        <span class="c1"># definition as it requires self)</span>
        <span class="k">if</span> <span class="n">Class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>

        <span class="c1"># basic initialization</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NodeTranslator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">Class</span><span class="o">=</span><span class="n">Class</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_default_projections</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;node_type&quot;</span><span class="p">,</span> <span class="s2">&quot;ctime&quot;</span><span class="p">,</span> <span class="s2">&quot;mtime&quot;</span><span class="p">,</span> <span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;attributes&quot;</span><span class="p">,</span> <span class="s2">&quot;extras&quot;</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_user_projections</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span>

        <span class="c1">## node schema</span>
        <span class="c1"># All the values from column_order must present in additional info dict</span>
        <span class="c1"># Note: final schema will contain details for only the fields present in column order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schema_projections</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;column_order&quot;</span><span class="p">:</span>
            <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;node_type&quot;</span><span class="p">,</span> <span class="s2">&quot;ctime&quot;</span><span class="p">,</span> <span class="s2">&quot;mtime&quot;</span><span class="p">,</span> <span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;user_email&quot;</span><span class="p">,</span> <span class="s2">&quot;attributes&quot;</span><span class="p">,</span> <span class="s2">&quot;extras&quot;</span><span class="p">],</span>
            <span class="s2">&quot;additional_info&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;is_display&quot;</span><span class="p">:</span> <span class="kc">True</span>
                <span class="p">},</span>
                <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;is_display&quot;</span><span class="p">:</span> <span class="kc">False</span>
                <span class="p">},</span>
                <span class="s2">&quot;node_type&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;is_display&quot;</span><span class="p">:</span> <span class="kc">True</span>
                <span class="p">},</span>
                <span class="s2">&quot;ctime&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;is_display&quot;</span><span class="p">:</span> <span class="kc">True</span>
                <span class="p">},</span>
                <span class="s2">&quot;mtime&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;is_display&quot;</span><span class="p">:</span> <span class="kc">True</span>
                <span class="p">},</span>
                <span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;is_display&quot;</span><span class="p">:</span> <span class="kc">False</span>
                <span class="p">},</span>
                <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;is_display&quot;</span><span class="p">:</span> <span class="kc">False</span>
                <span class="p">},</span>
                <span class="s2">&quot;user_email&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;is_display&quot;</span><span class="p">:</span> <span class="kc">True</span>
                <span class="p">},</span>
                <span class="s2">&quot;attributes&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;is_display&quot;</span><span class="p">:</span> <span class="kc">False</span>
                <span class="p">},</span>
                <span class="s2">&quot;extras&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;is_display&quot;</span><span class="p">:</span> <span class="kc">False</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1"># Inspect the subclasses of NodeTranslator, to avoid hard-coding</span>
        <span class="c1"># (should resemble the following tree)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                                          /- KpointsTranslator</span>
<span class="sd">                                         /</span>
<span class="sd">                         /- DataTranslator  -- SructureTranslator</span>
<span class="sd">                        /                \</span>
<span class="sd">                                          \- BandsTranslator</span>
<span class="sd">        NodeTranslator  -- CodeTranslator</span>
<span class="sd">                        \</span>
<span class="sd">                         \- CalculationTranslator</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_subclasses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_subclasses</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span> <span class="o">=</span> <span class="n">get_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span></div>

<div class="viewcode-block" id="NodeTranslator.set_query_type"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.translator.html#aiida.restapi.translator.node.NodeTranslator.set_query_type">[docs]</a>    <span class="k">def</span> <span class="nf">set_query_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">query_type</span><span class="p">,</span>
                       <span class="n">alist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">nalist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">elist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">nelist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">downloadformat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">visformat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">rtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets one of the mutually exclusive values for self._result_type and</span>
<span class="sd">        self._content_type.</span>

<span class="sd">        :param query_type:(string) the value assigned to either variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">query_type</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">query_type</span> <span class="o">==</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result_type</span> <span class="o">=</span> <span class="s1">&#39;with_outgoing&#39;</span>
        <span class="k">elif</span> <span class="n">query_type</span> <span class="o">==</span> <span class="s2">&quot;outputs&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result_type</span> <span class="o">=</span> <span class="s2">&quot;with_incoming&quot;</span>
        <span class="k">elif</span> <span class="n">query_type</span> <span class="o">==</span> <span class="s2">&quot;attributes&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="o">=</span> <span class="s2">&quot;attributes&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alist</span> <span class="o">=</span> <span class="n">alist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nalist</span> <span class="o">=</span> <span class="n">nalist</span>
        <span class="k">elif</span> <span class="n">query_type</span> <span class="o">==</span> <span class="s2">&quot;extras&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="o">=</span> <span class="s2">&quot;extras&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_elist</span> <span class="o">=</span> <span class="n">elist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nelist</span> <span class="o">=</span> <span class="n">nelist</span>
        <span class="k">elif</span> <span class="n">query_type</span> <span class="o">==</span> <span class="s1">&#39;visualization&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="o">=</span> <span class="s1">&#39;visualization&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_visformat</span> <span class="o">=</span> <span class="n">visformat</span>
        <span class="k">elif</span> <span class="n">query_type</span> <span class="o">==</span> <span class="s1">&#39;download&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="o">=</span> <span class="s1">&#39;download&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_downloadformat</span> <span class="o">=</span> <span class="n">downloadformat</span>
        <span class="k">elif</span> <span class="n">query_type</span> <span class="o">==</span> <span class="s2">&quot;retrieved_inputs&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="o">=</span> <span class="s1">&#39;retrieved_inputs&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">filename</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rtype</span> <span class="o">=</span> <span class="n">rtype</span>
        <span class="k">elif</span> <span class="n">query_type</span> <span class="o">==</span> <span class="s2">&quot;retrieved_outputs&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="o">=</span> <span class="s1">&#39;retrieved_outputs&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">filename</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rtype</span> <span class="o">=</span> <span class="n">rtype</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputValidationError</span><span class="p">(</span><span class="s2">&quot;invalid result/content value: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query_type</span><span class="p">))</span>

        <span class="c1"># Add input/output relation to the query help</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_type</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__label__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_query_help</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;entity_type&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;node.Node.&quot;</span><span class="p">,</span> <span class="s2">&quot;data.Data.&quot;</span><span class="p">),</span>
                <span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_type</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_result_type</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__label__</span>
            <span class="p">})</span></div>

<div class="viewcode-block" id="NodeTranslator.set_query"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.translator.html#aiida.restapi.translator.node.NodeTranslator.set_query">[docs]</a>    <span class="k">def</span> <span class="nf">set_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">orders</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">projections</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">query_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">node_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">alist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">nalist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">elist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">nelist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">downloadformat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">visformat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">rtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds filters, default projections, order specs to the query_help,</span>
<span class="sd">        and initializes the qb object</span>

<span class="sd">        :param filters: dictionary with the filters</span>
<span class="sd">        :param orders: dictionary with the order for each tag</span>
<span class="sd">        :param projections: dictionary with the projection. It is discarded</span>
<span class="sd">            if query_type==&#39;attributes&#39;/&#39;extras&#39;</span>
<span class="sd">        :param query_type: (string) specify the result or the content (&quot;attr&quot;)</span>
<span class="sd">        :param id: (integer) id of a specific node</span>
<span class="sd">        :param alist: list of attributes queried for node</span>
<span class="sd">        :param nalist: list of attributes, returns all attributes except this for node</span>
<span class="sd">        :param elist: list of extras queries for node</span>
<span class="sd">        :param nelist: list of extras, returns all extras except this for node</span>
<span class="sd">        :param downloadformat: file format to download e.g. cif, xyz</span>
<span class="sd">        :param visformat: data format to visualise the node. Mainly used for structure,</span>
<span class="sd">            cif, kpoints. E.g. jsmol, chemdoodle</span>
<span class="sd">        :param filename: name of the file to return its content</span>
<span class="sd">        :param rtype: return type of the file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">## Check the compatibility of query_type and id</span>
        <span class="k">if</span> <span class="n">query_type</span> <span class="o">!=</span> <span class="s2">&quot;default&quot;</span> <span class="ow">and</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;non default result/content can only be &quot;</span>
                                  <span class="s2">&quot;applied to a specific node (specify an id)&quot;</span><span class="p">)</span>

        <span class="c1">## Set the type of query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_query_type</span><span class="p">(</span>
            <span class="n">query_type</span><span class="p">,</span>
            <span class="n">alist</span><span class="o">=</span><span class="n">alist</span><span class="p">,</span>
            <span class="n">nalist</span><span class="o">=</span><span class="n">nalist</span><span class="p">,</span>
            <span class="n">elist</span><span class="o">=</span><span class="n">elist</span><span class="p">,</span>
            <span class="n">nelist</span><span class="o">=</span><span class="n">nelist</span><span class="p">,</span>
            <span class="n">downloadformat</span><span class="o">=</span><span class="n">downloadformat</span><span class="p">,</span>
            <span class="n">visformat</span><span class="o">=</span><span class="n">visformat</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
            <span class="n">rtype</span><span class="o">=</span><span class="n">rtype</span><span class="p">)</span>

        <span class="c1">## Define projections</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use &#39;*&#39; so that the object itself will be returned.</span>
            <span class="c1"># In get_results() we access attributes/extras by</span>
            <span class="c1"># calling the attributes/extras.</span>
            <span class="n">projections</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># i.e. use the input parameter projection</span>

        <span class="c1"># TODO this actually works, but the logic is a little bit obscure.</span>
        <span class="c1"># Make it clearer</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__label__</span><span class="p">:</span>
            <span class="n">projections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_projections</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">NodeTranslator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_query</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span> <span class="n">orders</span><span class="o">=</span><span class="n">orders</span><span class="p">,</span> <span class="n">projections</span><span class="o">=</span><span class="n">projections</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="NodeTranslator._get_content"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.translator.html#aiida.restapi.translator.node.NodeTranslator._get_content">[docs]</a>    <span class="k">def</span> <span class="nf">_get_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used by get_results() in case of endpoint include &quot;content&quot; option</span>
<span class="sd">        :return: data: a dictionary containing the results obtained by</span>
<span class="sd">        running the query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_qb_initialized</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidOperation</span><span class="p">(</span><span class="s2">&quot;query builder object has not been initialized.&quot;</span><span class="p">)</span>

        <span class="c1"># Count the total number of rows returned by the query (if not already done)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="c1"># If count==0 return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="c1"># otherwise ...</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qbobj</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># content/attributes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="o">==</span> <span class="s2">&quot;attributes&quot;</span><span class="p">:</span>
            <span class="c1"># Get all attrs if nalist and alist are both None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alist</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nalist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">}</span>
            <span class="c1"># Get all attrs except those contained in nalist</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alist</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nalist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nalist</span><span class="p">:</span>
                        <span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span><span class="p">:</span> <span class="n">attrs</span><span class="p">}</span>
            <span class="c1"># Get all attrs contained in alist</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nalist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alist</span><span class="p">:</span>
                        <span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span><span class="p">:</span> <span class="n">attrs</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RestValidationError</span><span class="p">(</span><span class="s2">&quot;you cannot specify both alist and nalist&quot;</span><span class="p">)</span>
        <span class="c1"># content/extras</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="o">==</span> <span class="s2">&quot;extras&quot;</span><span class="p">:</span>

            <span class="c1"># Get all extras if nelist and elist are both None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elist</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nelist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">extras</span><span class="p">}</span>

            <span class="c1"># Get all extras except those contained in nelist</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elist</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nelist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">extras</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nelist</span><span class="p">:</span>
                        <span class="n">extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span><span class="p">:</span> <span class="n">extras</span><span class="p">}</span>

            <span class="c1"># Get all extras contained in elist</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nelist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">extras</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elist</span><span class="p">:</span>
                        <span class="n">extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span><span class="p">:</span> <span class="n">extras</span><span class="p">}</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RestValidationError</span><span class="p">(</span><span class="s2">&quot;you cannot specify both elist and nelist&quot;</span><span class="p">)</span>

        <span class="c1"># Data needed for visualization appropriately serialized (this</span>
        <span class="c1"># actually works only for data derived classes)</span>
        <span class="c1"># TODO refactor the code so to have this option only in data and</span>
        <span class="c1"># derived classes</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="o">==</span> <span class="s1">&#39;visualization&#39;</span><span class="p">:</span>
            <span class="c1"># In this we do not return a dictionary but just an object and</span>
            <span class="c1"># the dictionary format is set by get_visualization_data</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_visualization_data</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visformat</span><span class="p">)}</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="o">==</span> <span class="s1">&#39;download&#39;</span><span class="p">:</span>
            <span class="c1"># In this we do not return a dictionary but download the file in</span>
            <span class="c1"># specified format if available</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_downloadable_data</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_downloadformat</span><span class="p">)}</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="o">==</span> <span class="s1">&#39;retrieved_inputs&#39;</span><span class="p">:</span>
            <span class="c1"># This type is only available for calc nodes. In case of job calc it</span>
            <span class="c1"># returns calc inputs prepared to submit calc on the cluster else []</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_retrieved_inputs</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rtype</span><span class="p">)}</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="o">==</span> <span class="s1">&#39;retrieved_outputs&#39;</span><span class="p">:</span>
            <span class="c1"># This type is only available for calc nodes. In case of job calc it</span>
            <span class="c1"># returns calc outputs retrieved from the cluster else []</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_retrieved_outputs</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rtype</span><span class="p">)}</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;invalid content type&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="NodeTranslator._get_subclasses"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.translator.html#aiida.restapi.translator.node.NodeTranslator._get_subclasses">[docs]</a>    <span class="k">def</span> <span class="nf">_get_subclasses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Import all submodules of the package containing the present class.</span>
<span class="sd">        Includes subpackages recursively, if specified.</span>

<span class="sd">        :param parent: package/class.</span>
<span class="sd">            If package looks for the classes in submodules.</span>
<span class="sd">            If class, first lookss for the package where it is contained</span>
<span class="sd">        :param parent_class: class of which to look for subclasses</span>
<span class="sd">        :param recursive: True/False (go recursively into submodules)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">pkgutil</span>
        <span class="kn">import</span> <span class="nn">imp</span>
        <span class="kn">import</span> <span class="nn">inspect</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="c1"># If no parent class is specified set it to self.__class</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">parent</span>

        <span class="c1"># Suppose parent is class</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">parent</span><span class="p">):</span>

            <span class="c1"># Set the package where the class is contained</span>
            <span class="n">classfile</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
            <span class="n">package_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">classfile</span><span class="p">)</span>

            <span class="c1"># If parent class is not specified, assume it is the parent</span>
            <span class="k">if</span> <span class="n">parent_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">parent_class</span> <span class="o">=</span> <span class="n">parent</span>

        <span class="c1"># Suppose parent is a package (directory containing __init__.py).</span>
        <span class="c1"># Check if it contains attribute __path__</span>
        <span class="k">elif</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismodule</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s1">&#39;__path__&#39;</span><span class="p">):</span>

            <span class="c1"># Assume path is one element list</span>
            <span class="n">package_path</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># if parent is a package, parent_class cannot be None</span>
            <span class="k">if</span> <span class="n">parent_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;argument parent_class cannot be None&#39;</span><span class="p">)</span>

                <span class="c1"># Recursively check the subpackages</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">is_pkg</span> <span class="ow">in</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">walk_packages</span><span class="p">([</span><span class="n">package_path</span><span class="p">]):</span>
            <span class="c1"># N.B. pkgutil.walk_package requires a LIST of paths.</span>

            <span class="n">full_path_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">package_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_pkg</span><span class="p">:</span>
                <span class="n">app_module</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">load_package</span><span class="p">(</span><span class="n">full_path_base</span><span class="p">,</span> <span class="n">full_path_base</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">full_path</span> <span class="o">=</span> <span class="n">full_path_base</span> <span class="o">+</span> <span class="s1">&#39;.py&#39;</span>
                <span class="c1"># I could use load_module but it takes lots of arguments,</span>
                <span class="c1"># then I use load_source</span>
                <span class="n">app_module</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">load_source</span><span class="p">(</span><span class="s2">&quot;rst&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="n">full_path</span><span class="p">)</span>

            <span class="c1"># Go through the content of the module</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_pkg</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">app_module</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">parent_class</span><span class="p">):</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="c1"># Look in submodules</span>
            <span class="k">elif</span> <span class="n">is_pkg</span> <span class="ow">and</span> <span class="n">recursive</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_subclasses</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">app_module</span><span class="p">,</span> <span class="n">parent_class</span><span class="o">=</span><span class="n">parent_class</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="NodeTranslator.get_visualization_data"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.translator.html#aiida.restapi.translator.node.NodeTranslator.get_visualization_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_visualization_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">visformat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generic function to get the data required to visualize the node with</span>
<span class="sd">        a specific plugin.</span>
<span class="sd">        Actual definition is in child classes as the content to be be</span>
<span class="sd">        returned and its format depends on the visualization plugin specific</span>
<span class="sd">        to the resource</span>

<span class="sd">        :param node: node object that has to be visualized</span>
<span class="sd">        :param visformat: visualization format</span>
<span class="sd">        :returns: data selected and serialized for visualization</span>

<span class="sd">        If this method is called by Node resource it will look for the type</span>
<span class="sd">        of object and invoke the correct method in the lowest-compatibel</span>
<span class="sd">        subclass</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Look for the translator associated to the class of which this node</span>
        <span class="c1"># is instance</span>
        <span class="n">tclass</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">subclass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subclasses</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">subclass</span><span class="o">.</span><span class="n">_aiida_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">tclass</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
                <span class="n">lowtrans</span> <span class="o">=</span> <span class="n">subclass</span>

        <span class="n">visualization_data</span> <span class="o">=</span> <span class="n">lowtrans</span><span class="o">.</span><span class="n">get_visualization_data</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">visformat</span><span class="o">=</span><span class="n">visformat</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">visualization_data</span></div>

<div class="viewcode-block" id="NodeTranslator.get_downloadable_data"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.translator.html#aiida.restapi.translator.node.NodeTranslator.get_downloadable_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_downloadable_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">download_format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generic function to download file in specified format.</span>
<span class="sd">        Actual definition is in child classes as the content to be</span>
<span class="sd">        returned and its format depends on the visualization plugin specific</span>
<span class="sd">        to the resource</span>

<span class="sd">        :param node: node object</span>
<span class="sd">        :param download_format: file extension format</span>
<span class="sd">        :returns: data in selected format to download</span>

<span class="sd">        If this method is called by Node resource it will look for the type</span>
<span class="sd">        of object and invoke the correct method in the lowest-compatibel</span>
<span class="sd">        subclass</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Look for the translator associated to the class of which this node</span>
        <span class="c1"># is instance</span>
        <span class="n">tclass</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">subclass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subclasses</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">subclass</span><span class="o">.</span><span class="n">_aiida_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">tclass</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
                <span class="n">lowtrans</span> <span class="o">=</span> <span class="n">subclass</span>

        <span class="n">downloadable_data</span> <span class="o">=</span> <span class="n">lowtrans</span><span class="o">.</span><span class="n">get_downloadable_data</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">download_format</span><span class="o">=</span><span class="n">download_format</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">downloadable_data</span></div>

<div class="viewcode-block" id="NodeTranslator.get_retrieved_inputs"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.translator.html#aiida.restapi.translator.node.NodeTranslator.get_retrieved_inputs">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_retrieved_inputs</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generic function to return output of calc inputls verdi command.</span>
<span class="sd">        Actual definition is in child classes as the content to be</span>
<span class="sd">        returned and its format depends on the visualization plugin specific</span>
<span class="sd">        to the resource</span>

<span class="sd">        :param node: node object</span>
<span class="sd">        :returns: list of calc inputls command</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=unused-argument</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="NodeTranslator.get_retrieved_outputs"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.translator.html#aiida.restapi.translator.node.NodeTranslator.get_retrieved_outputs">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_retrieved_outputs</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generic function to return output of calc outputls verdi command.</span>
<span class="sd">        Actual definition is in child classes as the content to be</span>
<span class="sd">        returned and its format depends on the visualization plugin specific</span>
<span class="sd">        to the resource</span>

<span class="sd">        :param node: node object</span>
<span class="sd">        :returns: list of calc outputls command</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=unused-argument</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="NodeTranslator.get_file_content"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.translator.html#aiida.restapi.translator.node.NodeTranslator.get_file_content">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_file_content</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        It reads the file from directory and returns its content.</span>

<span class="sd">        Instead of using &quot;send_from_directory&quot; from flask, this method is written</span>
<span class="sd">        because in next aiida releases the file can be stored locally or in object storage.</span>

<span class="sd">        :param node: aiida folderData node which contains file</span>
<span class="sd">        :param file_name: name of the file to return its contents</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="n">file_parts</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_parts</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">file_parts</span><span class="p">:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_subfolder</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">node</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">fobj</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fobj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>

<div class="viewcode-block" id="NodeTranslator.get_results"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.translator.html#aiida.restapi.translator.node.NodeTranslator.get_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns either a list of nodes or details of single node from database</span>

<span class="sd">        :return: either a list of nodes or the details of single node</span>
<span class="sd">            from the database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_content</span><span class="p">()</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">NodeTranslator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span></div>

<div class="viewcode-block" id="NodeTranslator.get_statistics"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.translator.html#aiida.restapi.translator.node.NodeTranslator.get_statistics">[docs]</a>    <span class="k">def</span> <span class="nf">get_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return statistics for a given node&quot;&quot;&quot;</span>

        <span class="n">qmanager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">query_manager</span>
        <span class="k">return</span> <span class="n">qmanager</span><span class="o">.</span><span class="n">get_creation_statistics</span><span class="p">(</span><span class="n">user_pk</span><span class="o">=</span><span class="n">user_pk</span><span class="p">)</span></div>

<div class="viewcode-block" id="NodeTranslator.get_io_tree"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.translator.html#aiida.restapi.translator.node.NodeTranslator.get_io_tree">[docs]</a>    <span class="k">def</span> <span class="nf">get_io_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uuid_pattern</span><span class="p">,</span> <span class="n">tree_in_limit</span><span class="p">,</span> <span class="n">tree_out_limit</span><span class="p">):</span>
        <span class="c1"># pylint: disable=too-many-statements,too-many-locals</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        json data to display nodes in tree format</span>
<span class="sd">        :param uuid_pattern: main node uuid</span>
<span class="sd">        :return: json data to display node tree</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.orm.querybuilder</span> <span class="k">import</span> <span class="n">QueryBuilder</span>
        <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="k">import</span> <span class="n">Node</span>

        <span class="k">def</span> <span class="nf">get_node_shape</span><span class="p">(</span><span class="n">ntype</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get tree node shape depending on node type</span>
<span class="sd">            :param ntype: node type</span>
<span class="sd">            :return: shape of the node displayed in tree</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">node_type</span> <span class="o">=</span> <span class="n">ntype</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># default and data node shape</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="s2">&quot;dot&quot;</span>

            <span class="k">if</span> <span class="n">node_type</span> <span class="o">==</span> <span class="s2">&quot;calculation&quot;</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="s2">&quot;square&quot;</span>
            <span class="k">elif</span> <span class="n">node_type</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="s2">&quot;triangle&quot;</span>

            <span class="k">return</span> <span class="n">shape</span>

        <span class="k">def</span> <span class="nf">get_node_description</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get the description of the node.</span>
<span class="sd">            CalcJobNodes migrated from AiiDA &lt; 1.0.0 do not have a valid CalcJobState,</span>
<span class="sd">            in this case the function returns as description the type of the node (CalcJobNode)</span>
<span class="sd">            :param node: node object</span>
<span class="sd">            :return: description of the node</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_description</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">node_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">description</span>

        <span class="c1"># Check whether uuid_pattern identifies a unique node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_id_validity</span><span class="p">(</span><span class="n">uuid_pattern</span><span class="p">)</span>

        <span class="n">qb_obj</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb_obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span> <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id_filter</span><span class="p">)</span>

        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">node_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">qb_obj</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">main_node</span> <span class="o">=</span> <span class="n">qb_obj</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="n">main_node</span><span class="o">.</span><span class="n">pk</span>
            <span class="n">uuid</span> <span class="o">=</span> <span class="n">main_node</span><span class="o">.</span><span class="n">uuid</span>
            <span class="n">nodetype</span> <span class="o">=</span> <span class="n">main_node</span><span class="o">.</span><span class="n">node_type</span>
            <span class="n">nodelabel</span> <span class="o">=</span> <span class="n">main_node</span><span class="o">.</span><span class="n">label</span>
            <span class="n">display_type</span> <span class="o">=</span> <span class="n">nodetype</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">get_node_description</span><span class="p">(</span><span class="n">main_node</span><span class="p">)</span>

            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">node_count</span><span class="p">,</span>
                <span class="s2">&quot;nodeid&quot;</span><span class="p">:</span> <span class="n">pk</span><span class="p">,</span>
                <span class="s2">&quot;nodeuuid&quot;</span><span class="p">:</span> <span class="n">uuid</span><span class="p">,</span>
                <span class="s2">&quot;nodetype&quot;</span><span class="p">:</span> <span class="n">nodetype</span><span class="p">,</span>
                <span class="s2">&quot;nodelabel&quot;</span><span class="p">:</span> <span class="n">nodelabel</span><span class="p">,</span>
                <span class="s2">&quot;displaytype&quot;</span><span class="p">:</span> <span class="n">display_type</span><span class="p">,</span>
                <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="s2">&quot;main_node&quot;</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="n">get_node_shape</span><span class="p">(</span><span class="n">nodetype</span><span class="p">)</span>
            <span class="p">})</span>
        <span class="n">node_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># get all inputs</span>
        <span class="n">qb_obj</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb_obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">],</span> <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id_filter</span><span class="p">)</span>
        <span class="n">qb_obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">],</span> <span class="n">edge_project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">with_outgoing</span><span class="o">=</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tree_in_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">qb_obj</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">tree_in_limit</span><span class="p">)</span>

        <span class="n">input_node_pks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sent_no_of_incomings</span> <span class="o">=</span> <span class="n">qb_obj</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sent_no_of_incomings</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node_input</span> <span class="ow">in</span> <span class="n">qb_obj</span><span class="o">.</span><span class="n">iterdict</span><span class="p">():</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">node_input</span><span class="p">[</span><span class="s1">&#39;in&#39;</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
                <span class="n">pk</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">pk</span>
                <span class="n">linklabel</span> <span class="o">=</span> <span class="n">node_input</span><span class="p">[</span><span class="s1">&#39;main--in&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                <span class="n">linktype</span> <span class="o">=</span> <span class="n">node_input</span><span class="p">[</span><span class="s1">&#39;main--in&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>

                <span class="c1"># add node if it is not present</span>
                <span class="k">if</span> <span class="n">pk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_node_pks</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">input_node_pks</span><span class="p">[</span><span class="n">pk</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_count</span>
                    <span class="n">uuid</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span>
                    <span class="n">nodetype</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">node_type</span>
                    <span class="n">nodelabel</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">label</span>
                    <span class="n">display_type</span> <span class="o">=</span> <span class="n">nodetype</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">description</span> <span class="o">=</span> <span class="n">get_node_description</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

                    <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">node_count</span><span class="p">,</span>
                        <span class="s2">&quot;nodeid&quot;</span><span class="p">:</span> <span class="n">pk</span><span class="p">,</span>
                        <span class="s2">&quot;nodeuuid&quot;</span><span class="p">:</span> <span class="n">uuid</span><span class="p">,</span>
                        <span class="s2">&quot;nodetype&quot;</span><span class="p">:</span> <span class="n">nodetype</span><span class="p">,</span>
                        <span class="s2">&quot;nodelabel&quot;</span><span class="p">:</span> <span class="n">nodelabel</span><span class="p">,</span>
                        <span class="s2">&quot;displaytype&quot;</span><span class="p">:</span> <span class="n">display_type</span><span class="p">,</span>
                        <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="s2">&quot;inputs&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                        <span class="s2">&quot;linklabel&quot;</span><span class="p">:</span> <span class="n">linklabel</span><span class="p">,</span>
                        <span class="s2">&quot;linktype&quot;</span><span class="p">:</span> <span class="n">linktype</span><span class="p">,</span>
                        <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="n">get_node_shape</span><span class="p">(</span><span class="n">nodetype</span><span class="p">)</span>
                    <span class="p">})</span>
                    <span class="n">node_count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">from_edge</span> <span class="o">=</span> <span class="n">input_node_pks</span><span class="p">[</span><span class="n">pk</span><span class="p">]</span>
                <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">from_edge</span><span class="p">,</span>
                    <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;arrows&quot;</span><span class="p">:</span> <span class="s2">&quot;to&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;inherit&quot;</span><span class="p">:</span> <span class="s1">&#39;from&#39;</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;linktype&quot;</span><span class="p">:</span> <span class="n">linktype</span><span class="p">,</span>
                <span class="p">})</span>

        <span class="c1"># get all outputs</span>
        <span class="n">qb_obj</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb_obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">],</span> <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id_filter</span><span class="p">)</span>
        <span class="n">qb_obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">],</span> <span class="n">edge_project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">with_incoming</span><span class="o">=</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tree_out_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">qb_obj</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">tree_out_limit</span><span class="p">)</span>

        <span class="n">output_node_pks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sent_no_of_outgoings</span> <span class="o">=</span> <span class="n">qb_obj</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sent_no_of_outgoings</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">qb_obj</span><span class="o">.</span><span class="n">iterdict</span><span class="p">():</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;out&#39;</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
                <span class="n">pk</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">pk</span>
                <span class="n">linklabel</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;main--out&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                <span class="n">linktype</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;main--out&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>

                <span class="c1"># add node if it is not present</span>
                <span class="k">if</span> <span class="n">pk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output_node_pks</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">output_node_pks</span><span class="p">[</span><span class="n">pk</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_count</span>
                    <span class="n">uuid</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span>
                    <span class="n">nodetype</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">node_type</span>
                    <span class="n">nodelabel</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">label</span>
                    <span class="n">display_type</span> <span class="o">=</span> <span class="n">nodetype</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">description</span> <span class="o">=</span> <span class="n">get_node_description</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

                    <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">node_count</span><span class="p">,</span>
                        <span class="s2">&quot;nodeid&quot;</span><span class="p">:</span> <span class="n">pk</span><span class="p">,</span>
                        <span class="s2">&quot;nodeuuid&quot;</span><span class="p">:</span> <span class="n">uuid</span><span class="p">,</span>
                        <span class="s2">&quot;nodetype&quot;</span><span class="p">:</span> <span class="n">nodetype</span><span class="p">,</span>
                        <span class="s2">&quot;nodelabel&quot;</span><span class="p">:</span> <span class="n">nodelabel</span><span class="p">,</span>
                        <span class="s2">&quot;displaytype&quot;</span><span class="p">:</span> <span class="n">display_type</span><span class="p">,</span>
                        <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="s2">&quot;outputs&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                        <span class="s2">&quot;linklabel&quot;</span><span class="p">:</span> <span class="n">linklabel</span><span class="p">,</span>
                        <span class="s2">&quot;linktype&quot;</span><span class="p">:</span> <span class="n">linktype</span><span class="p">,</span>
                        <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="n">get_node_shape</span><span class="p">(</span><span class="n">nodetype</span><span class="p">)</span>
                    <span class="p">})</span>
                    <span class="n">node_count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">to_edge</span> <span class="o">=</span> <span class="n">output_node_pks</span><span class="p">[</span><span class="n">pk</span><span class="p">]</span>
                <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">to_edge</span><span class="p">,</span>
                    <span class="s2">&quot;arrows&quot;</span><span class="p">:</span> <span class="s2">&quot;to&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;inherit&quot;</span><span class="p">:</span> <span class="s1">&#39;to&#39;</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;linktype&quot;</span><span class="p">:</span> <span class="n">linktype</span>
                <span class="p">})</span>

        <span class="c1"># count total no of nodes</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id_filter</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">with_outgoing</span><span class="o">=</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
        <span class="n">total_no_of_incomings</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="n">builder</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id_filter</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">with_incoming</span><span class="o">=</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
        <span class="n">total_no_of_outgoings</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="p">,</span>
            <span class="s2">&quot;edges&quot;</span><span class="p">:</span> <span class="n">edges</span><span class="p">,</span>
            <span class="s2">&quot;total_no_of_incomings&quot;</span><span class="p">:</span> <span class="n">total_no_of_incomings</span><span class="p">,</span>
            <span class="s2">&quot;total_no_of_outgoings&quot;</span><span class="p">:</span> <span class="n">total_no_of_outgoings</span><span class="p">,</span>
            <span class="s2">&quot;sent_no_of_incomings&quot;</span><span class="p">:</span> <span class="n">sent_no_of_incomings</span><span class="p">,</span>
            <span class="s2">&quot;sent_no_of_outgoings&quot;</span><span class="p">:</span> <span class="n">sent_no_of_outgoings</span>
        <span class="p">}</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>