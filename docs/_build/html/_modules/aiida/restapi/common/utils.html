

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.restapi.common.utils &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.restapi.common.utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.restapi.common.utils</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot; Util methods &quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">flask.json</span> <span class="k">import</span> <span class="n">JSONEncoder</span>

<span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">InputValidationError</span><span class="p">,</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">aiida.restapi.common.exceptions</span> <span class="k">import</span> <span class="n">RestValidationError</span><span class="p">,</span> \
    <span class="n">RestInputValidationError</span>

<span class="c1"># Important to match querybuilder keys</span>
<span class="n">PK_DBSYNONYM</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span>
<span class="c1"># Example uuid (version 4)</span>
<span class="n">UUID_REF</span> <span class="o">=</span> <span class="s1">&#39;d55082b6-76dc-426b-af89-0e08b59524d2&#39;</span>


<span class="c1">########################## Classes #####################</span>
<div class="viewcode-block" id="CustomJSONEncoder"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.common.html#aiida.restapi.common.utils.CustomJSONEncoder">[docs]</a><span class="k">class</span> <span class="nc">CustomJSONEncoder</span><span class="p">(</span><span class="n">JSONEncoder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom json encoder for serialization.</span>
<span class="sd">    This has to be provided to the Flask app in order to replace the default</span>
<span class="sd">    encoder.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CustomJSONEncoder.default"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.common.html#aiida.restapi.common.utils.CustomJSONEncoder.default">[docs]</a>    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="c1"># pylint: disable=method-hidden</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override default method from JSONEncoder to change serializer</span>
<span class="sd">        :param o: Object e.g. dict, list that will be serialized</span>
<span class="sd">        :return: serialized object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">aiida.restapi.common.config</span> <span class="k">import</span> <span class="n">SERIALIZER_CONFIG</span>

        <span class="c1"># Treat the datetime objects</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;datetime_format&#39;</span> <span class="ow">in</span> <span class="n">SERIALIZER_CONFIG</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> \
                            <span class="n">SERIALIZER_CONFIG</span><span class="p">[</span>
                                <span class="s1">&#39;datetime_format&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">SERIALIZER_CONFIG</span><span class="p">[</span><span class="s1">&#39;datetime_format&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;asinput&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">o</span> <span class="o">=</span> <span class="n">o</span> <span class="o">-</span> <span class="n">o</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">()</span>
                        <span class="k">return</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">year</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                                         <span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span> <span class="o">+</span> <span class="s1">&#39;T&#39;</span> <span class="o">+</span> \
                               <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span>
                                   <span class="n">o</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                                         <span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">second</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>

        <span class="c1"># If not returned yet, do it in the default way</span>
        <span class="k">return</span> <span class="n">JSONEncoder</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DatetimePrecision"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.common.html#aiida.restapi.common.utils.DatetimePrecision">[docs]</a><span class="k">class</span> <span class="nc">DatetimePrecision</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># pylint: disable=too-few-public-methods,useless-object-inheritance</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple class which stores a datetime object with its precision. No</span>
<span class="sd">    internal check is done (cause itis not possible).</span>

<span class="sd">    precision:  1 (only full date)</span>
<span class="sd">                2 (date plus hour)</span>
<span class="sd">                3 (date + hour + minute)</span>
<span class="sd">                4 (dare + hour + minute +second)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DatetimePrecision.__init__"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.common.html#aiida.restapi.common.utils.DatetimePrecision.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtobj</span><span class="p">,</span> <span class="n">precision</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Constructor to check valid datetime object and precision &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtobj</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;dtobj argument has to be a datetime object&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">precision</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;precision argument has to be an integer&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dtobj</span> <span class="o">=</span> <span class="n">dtobj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span></div></div>


<div class="viewcode-block" id="Utils"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.common.html#aiida.restapi.common.utils.Utils">[docs]</a><span class="k">class</span> <span class="nc">Utils</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  <span class="c1"># pylint: disable=useless-object-inheritance</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that gathers all the utility functions for parsing URI,</span>
<span class="sd">    validating request, pass it to the translator, and building HTTP response</span>

<span class="sd">    An istance of Utils has to be included in the api class so that the</span>
<span class="sd">    configuration parameters used to build the api are automatically</span>
<span class="sd">    accessible by the methods of Utils without the need to import them from</span>
<span class="sd">    the config.py file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Conversion map from the query_string operators to the query_builder</span>
    <span class="c1">#  operators</span>
    <span class="n">op_conv_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;=&#39;</span><span class="p">:</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span>
        <span class="s1">&#39;!=&#39;</span><span class="p">:</span> <span class="s1">&#39;!==&#39;</span><span class="p">,</span>
        <span class="s1">&#39;=in=&#39;</span><span class="p">:</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span>
        <span class="s1">&#39;=notin=&#39;</span><span class="p">:</span> <span class="s1">&#39;!in&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&gt;=&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span>
        <span class="s1">&#39;=like=&#39;</span><span class="p">:</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span>
        <span class="s1">&#39;=ilike=&#39;</span><span class="p">:</span> <span class="s1">&#39;ilike&#39;</span>
    <span class="p">}</span>

<div class="viewcode-block" id="Utils.__init__"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.common.html#aiida.restapi.common.utils.Utils.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets internally the configuration parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;PREFIX&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perpage_default</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;PERPAGE_DEFAULT&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_default</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;LIMIT_DEFAULT&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Utils.strip_api_prefix"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.common.html#aiida.restapi.common.utils.Utils.strip_api_prefix">[docs]</a>    <span class="k">def</span> <span class="nf">strip_api_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes the PREFIX from an URL path. PREFIX must be defined in the</span>
<span class="sd">        config.py file::</span>

<span class="sd">            PREFIX = &quot;/api/v2&quot;</span>
<span class="sd">            path = &quot;/api/v2/calculations/page/2&quot;</span>
<span class="sd">            strip_api_prefix(path) ==&gt; &quot;/calculations/page/2&quot;</span>

<span class="sd">        :param path: the URL path string</span>
<span class="sd">        :return: the same URL without the prefix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">):]</span>

        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s1">&#39;path has to start with </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">))</span></div>

<div class="viewcode-block" id="Utils.split_path"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.common.html#aiida.restapi.common.utils.Utils.split_path">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">split_path</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param path: entire path contained in flask request</span>
<span class="sd">        :return: list of each element separated by &#39;/&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="p">]</span></div>

<div class="viewcode-block" id="Utils.parse_path"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.common.html#aiida.restapi.common.utils.Utils.parse_path">[docs]</a>    <span class="k">def</span> <span class="nf">parse_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_string</span><span class="p">,</span> <span class="n">parse_pk_uuid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># pylint: disable=too-many-return-statements,too-many-branches</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes the path and parse it checking its validity. Does not parse &quot;io&quot;,</span>
<span class="sd">        &quot;content&quot; fields. I do not check the validity of the path, since I assume</span>
<span class="sd">        that this is done by the Flask routing methods.</span>

<span class="sd">        :param path_string: the path string</span>
<span class="sd">        :param parse_id_uuid: if &#39;pk&#39; (&#39;uuid&#39;) expects an integer (uuid starting pattern)</span>
<span class="sd">        :return: resource_type (string)</span>
<span class="sd">            page (integer)</span>
<span class="sd">            node_id (string: uuid starting pattern, int: pk)</span>
<span class="sd">            query_type (string))</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">## Initialization</span>
        <span class="n">page</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">node_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">query_type</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strip_api_prefix</span><span class="p">(</span><span class="n">path_string</span><span class="p">))</span>

        <span class="c1">## Pop out iteratively the &quot;words&quot; of the path until it is an empty</span>
        <span class="c1"># list.</span>
        <span class="c1">##  This way it should be easier to plug in more endpoint logic</span>

        <span class="c1"># Resource type</span>
        <span class="n">resource_type</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">query_type</span><span class="p">)</span>

        <span class="c1"># Validate uuid or starting pattern of uuid.</span>
        <span class="c1"># Technique: - take our UUID_REF and replace the first characters the</span>
        <span class="c1">#  string to be validated as uuid.</span>
        <span class="c1">#            - validate instead the newly built string</span>
        <span class="k">if</span> <span class="n">parse_pk_uuid</span> <span class="o">==</span> <span class="s1">&#39;pk&#39;</span><span class="p">:</span>
            <span class="n">raw_id</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check whether it can be an integer</span>
                <span class="n">node_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">parse_pk_uuid</span> <span class="o">==</span> <span class="s1">&#39;uuid&#39;</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">uuid</span>
            <span class="n">raw_id</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">maybe_uuid</span> <span class="o">=</span> <span class="n">raw_id</span> <span class="o">+</span> <span class="n">UUID_REF</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_id</span><span class="p">):]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="n">maybe_uuid</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># assume that it cannot be an id and go to the next check</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># It is a node_id so pop out the path element</span>
                <span class="n">node_id</span> <span class="o">=</span> <span class="n">raw_id</span>
                <span class="n">path</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">query_type</span><span class="p">)</span>

        <span class="c1"># Query type (input, output, attributes, extras, visualization,</span>
        <span class="c1"># schema, statistics)</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;schema&#39;</span><span class="p">:</span>
            <span class="n">query_type</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;url requesting schema resources do not admit further fields&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">query_type</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;statistics&#39;</span><span class="p">:</span>
            <span class="n">query_type</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;url requesting statistics resources do not admit further fields&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">query_type</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;io&quot;</span> <span class="ow">or</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span>
            <span class="n">path</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">query_type</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">query_type</span><span class="p">)</span>

        <span class="c1"># Page (this has to be in any case the last field)</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;page&quot;</span><span class="p">:</span>
            <span class="n">path</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">query_type</span><span class="p">)</span>
            <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">query_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="Utils.validate_request"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.common.html#aiida.restapi.common.utils.Utils.validate_request">[docs]</a>    <span class="k">def</span> <span class="nf">validate_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">perpage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">page</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">query_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">is_querystring_defined</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># pylint: disable=fixme,no-self-use,too-many-arguments,too-many-branches</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs various checks on the consistency of the request.</span>
<span class="sd">        Add here all the checks that you want to do, except validity of the page</span>
<span class="sd">        number that is done in paginate().</span>
<span class="sd">        Future additional checks must be added here</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO Consider using **kwargs so to make easier to add more validations</span>
        <span class="c1"># 1. perpage incompatible with offset and limits</span>
        <span class="k">if</span> <span class="n">perpage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">RestValidationError</span><span class="p">(</span><span class="s2">&quot;perpage key is incompatible with limit and offset&quot;</span><span class="p">)</span>
        <span class="c1"># 2. /page/&lt;int: page&gt; in path is incompatible with limit and offset</span>
        <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">RestValidationError</span><span class="p">(</span><span class="s2">&quot;requesting a specific page is incompatible with limit and offset&quot;</span><span class="p">)</span>
        <span class="c1"># 3. perpage requires that the path contains a page request</span>
        <span class="k">if</span> <span class="n">perpage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">page</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RestValidationError</span><span class="p">(</span><span class="s2">&quot;perpage key requires that a page is &quot;</span>
                                      <span class="s2">&quot;requested (i.e. the path must contain &quot;</span>
                                      <span class="s2">&quot;/page/)&quot;</span><span class="p">)</span>
        <span class="c1"># 4. No querystring if query type = schema&#39;</span>
        <span class="k">if</span> <span class="n">query_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;schema&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_querystring_defined</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;schema requests do not allow specifying a query string&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Utils.paginate"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.common.html#aiida.restapi.common.utils.Utils.paginate">[docs]</a>    <span class="k">def</span> <span class="nf">paginate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">perpage</span><span class="p">,</span> <span class="n">total_count</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates limit and offset for the reults of a query,</span>
<span class="sd">        given the page and the number of restuls per page.</span>
<span class="sd">        Moreover, calculates the last available page and raises an exception</span>
<span class="sd">        if the</span>
<span class="sd">        required page exceeds that limit.</span>
<span class="sd">        If number of rows==0, only page 1 exists</span>
<span class="sd">        :param page: integer number of the page that has to be viewed</span>
<span class="sd">        :param perpage: integer defining how many results a page contains</span>
<span class="sd">        :param total_count: the total number of rows retrieved by the query</span>
<span class="sd">        :return: integers: limit, offset, rel_pages</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">ceil</span>

        <span class="c1">## Type checks</span>
        <span class="c1"># Mandatory params</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputValidationError</span><span class="p">(</span><span class="s2">&quot;page number must be an integer&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">total_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_count</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputValidationError</span><span class="p">(</span><span class="s2">&quot;total_count must be an integer&quot;</span><span class="p">)</span>
        <span class="c1"># Non-mandatory params</span>
        <span class="k">if</span> <span class="n">perpage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">perpage</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">perpage</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InputValidationError</span><span class="p">(</span><span class="s2">&quot;perpage must be an integer&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perpage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perpage_default</span>

        <span class="c1">## First_page is anyway 1</span>
        <span class="n">first_page</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1">## Calculate last page</span>
        <span class="k">if</span> <span class="n">total_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">last_page</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="n">total_count</span> <span class="o">/</span> <span class="n">perpage</span><span class="p">))</span>

        <span class="c1">## Check validity of required page and calculate limit, offset,</span>
        <span class="c1"># previous,</span>
        <span class="c1">#  and next page</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="n">last_page</span> <span class="ow">or</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;Non existent page requested. The &quot;</span>
                                           <span class="s2">&quot;page range is [</span><span class="si">{}</span><span class="s2"> : </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">first_page</span><span class="p">,</span> <span class="n">last_page</span><span class="p">))</span>

        <span class="n">limit</span> <span class="o">=</span> <span class="n">perpage</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">perpage</span>
        <span class="n">prev_page</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">prev_page</span> <span class="o">=</span> <span class="n">page</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">next_page</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">last_page</span><span class="p">:</span>
            <span class="n">next_page</span> <span class="o">=</span> <span class="n">page</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">rel_pages</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">prev</span><span class="o">=</span><span class="n">prev_page</span><span class="p">,</span> <span class="nb">next</span><span class="o">=</span><span class="n">next_page</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="n">first_page</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="n">last_page</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">rel_pages</span><span class="p">)</span></div>

<div class="viewcode-block" id="Utils.build_headers"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.common.html#aiida.restapi.common.utils.Utils.build_headers">[docs]</a>    <span class="k">def</span> <span class="nf">build_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_pages</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">total_count</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the header dictionary for an HTTP response. It includes related</span>
<span class="sd">        pages, total count of results (before pagination).</span>

<span class="sd">        :param rel_pages: a dictionary defining related pages (first, prev, next, last)</span>
<span class="sd">        :param url: (string) the full url, i.e. the url that the client uses to get Rest resources</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">## Type validation</span>
        <span class="c1"># mandatory parameters</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">total_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_count</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputValidationError</span><span class="p">(</span><span class="s2">&quot;total_count must be a long integer&quot;</span><span class="p">)</span>

        <span class="c1"># non mandatory parameters</span>
        <span class="k">if</span> <span class="n">rel_pages</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rel_pages</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InputValidationError</span><span class="p">(</span><span class="s2">&quot;rel_pages must be a dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InputValidationError</span><span class="p">(</span><span class="s2">&quot;url must be a string&quot;</span><span class="p">)</span>

        <span class="c1">## Input consistency</span>
        <span class="c1"># rel_pages cannot be defined without url</span>
        <span class="k">if</span> <span class="n">rel_pages</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputValidationError</span><span class="p">(</span><span class="s2">&quot;&#39;rel_pages&#39; parameter requires &#39;url&#39; parameter to be defined&quot;</span><span class="p">)</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1">## Setting mandatory headers</span>
        <span class="c1"># set X-Total-Count</span>
        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Total-Count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_count</span>
        <span class="n">expose_header</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;X-Total-Count&quot;</span><span class="p">]</span>

        <span class="c1">## Two auxiliary functions</span>
        <span class="k">def</span> <span class="nf">split_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Split url into path and query string &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;?&#39;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
                <span class="p">[</span><span class="n">path</span><span class="p">,</span> <span class="n">query_string</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span>
                <span class="n">question_mark</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">url</span>
                <span class="n">query_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">question_mark</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">query_string</span><span class="p">,</span> <span class="n">question_mark</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">make_rel_url</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="n">page</span><span class="p">):</span>
            <span class="n">new_path_elems</span> <span class="o">=</span> <span class="n">path_elems</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">page</span><span class="p">)]</span>
            <span class="k">return</span> <span class="s1">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_path_elems</span><span class="p">)</span> <span class="o">+</span> \
                   <span class="n">question_mark</span> <span class="o">+</span> <span class="n">query_string</span> <span class="o">+</span> <span class="s2">&quot;&gt;; rel=</span><span class="si">{}</span><span class="s2">, &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span>

        <span class="c1">## Setting non-mandatory parameters</span>
        <span class="c1"># set links to related pages</span>
        <span class="k">if</span> <span class="n">rel_pages</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">query_string</span><span class="p">,</span> <span class="n">question_mark</span><span class="p">)</span> <span class="o">=</span> <span class="n">split_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">path_elems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">path_elems</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;page&#39;</span> <span class="ow">or</span> <span class="n">path_elems</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;page&#39;</span><span class="p">:</span>
                <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span> <span class="ow">in</span> <span class="n">rel_pages</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_rel_url</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="n">page</span><span class="p">))</span>
                <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Link&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>
                <span class="n">expose_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Link&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># to expose header access in cross-domain requests</span>
        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Expose-Headers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expose_header</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">headers</span></div>

<div class="viewcode-block" id="Utils.build_response"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.common.html#aiida.restapi.common.utils.Utils.build_response">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">build_response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build the response</span>

<span class="sd">        :param status: status of the response, e.g. 200=OK, 400=bad request</span>
<span class="sd">        :param headers: dictionary for additional header k,v pairs,</span>
<span class="sd">            e.g. X-total-count=&lt;number of rows resulting from query&gt;</span>
<span class="sd">        :param data: a dictionary with the data returned by the Resource</span>

<span class="sd">        :return: a Flask response object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">## Type checks</span>
        <span class="c1"># mandatory parameters</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InputValidationError</span><span class="p">(</span><span class="s2">&quot;data must be a dictionary&quot;</span><span class="p">)</span>

        <span class="c1"># non-mandatory parameters</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InputValidationError</span><span class="p">(</span><span class="s2">&quot;status must be an integer&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InputValidationError</span><span class="p">(</span><span class="s2">&quot;header must be a dictionary&quot;</span><span class="p">)</span>

        <span class="c1"># Build response</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status</span>

        <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="Utils.build_datetime_filter"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.common.html#aiida.restapi.common.utils.Utils.build_datetime_filter">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">build_datetime_filter</span><span class="p">(</span><span class="n">dtobj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function constructs a filter for a datetime object to be in a</span>
<span class="sd">        certain datetime interval according to the precision.</span>

<span class="sd">        The interval is [reference_datetime, reference_datetime + delta_time],</span>
<span class="sd">        where delta_time is a function fo the required precision.</span>

<span class="sd">        This function should be used to replace a datetime filter based on</span>
<span class="sd">        the equality operator that is inehrently &quot;picky&quot; because it implies</span>
<span class="sd">        matching two datetime objects down to the microsecond or something,</span>
<span class="sd">        by a &quot;tolerant&quot; operator which checks whether the datetime is in an</span>
<span class="sd">        interval.</span>

<span class="sd">        :return: a suitable entry of the filter dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtobj</span><span class="p">,</span> <span class="n">DatetimePrecision</span><span class="p">):</span>
            <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;dtobj argument has to be a DatetimePrecision object&quot;</span><span class="p">)</span>

        <span class="n">reference_datetime</span> <span class="o">=</span> <span class="n">dtobj</span><span class="o">.</span><span class="n">dtobj</span>
        <span class="n">precision</span> <span class="o">=</span> <span class="n">dtobj</span><span class="o">.</span><span class="n">precision</span>

        <span class="c1">## Define interval according to the precision</span>
        <span class="k">if</span> <span class="n">precision</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">delta_time</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">precision</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">delta_time</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">precision</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">delta_time</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">precision</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">delta_time</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RestValidationError</span><span class="p">(</span><span class="s2">&quot;The datetime resolution is not valid.&quot;</span><span class="p">)</span>

        <span class="n">filters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;and&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;&gt;=&#39;</span><span class="p">:</span> <span class="n">reference_datetime</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="n">reference_datetime</span> <span class="o">+</span> <span class="n">delta_time</span><span class="p">}]}</span>

        <span class="k">return</span> <span class="n">filters</span></div>

<div class="viewcode-block" id="Utils.build_translator_parameters"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.common.html#aiida.restapi.common.utils.Utils.build_translator_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">build_translator_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_list</span><span class="p">):</span>
        <span class="c1"># pylint: disable=too-many-locals,too-many-statements,too-many-branches</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes a list of elements resulting from the parsing the query_string and</span>
<span class="sd">        elaborates them in order to provide translator-compliant instructions</span>

<span class="sd">        :param field_list: a (nested) list of elements resulting from parsing the query_string</span>
<span class="sd">        :returns: the filters in the</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">## Create void variables</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">orderby</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">perpage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">alist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">nalist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">elist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">nelist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">downloadformat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">visformat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">rtype</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># io tree limit parameters</span>
        <span class="n">tree_in_limit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tree_out_limit</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">## Count how many time a key has been used for the filters and check if</span>
        <span class="c1"># reserved keyword</span>
        <span class="c1"># have been used twice,</span>
        <span class="n">field_counts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">field_list</span><span class="p">:</span>
            <span class="n">field_key</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">field_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">field_counts</span><span class="p">[</span><span class="n">field_key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="c1"># Store the information whether membership operator is used</span>
                <span class="c1"># is_membership = (field[1] is &#39;=in=&#39;)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Check if the key of a filter using membership operator is used</span>
                <span class="c1"># in multiple filters</span>
                <span class="c1"># if is_membership is True or field[1] is &#39;=in=&#39;:</span>
                <span class="c1"># raise RestInputValidationError(&quot;If a key appears in &quot;</span>
                <span class="c1">#                                &quot;multiple filters, &quot;</span>
                <span class="c1">#                                &quot;those cannot use &quot;</span>
                <span class="c1">#                                &quot;membership opertor &#39;=in=&#39;&quot;)</span>
                <span class="n">field_counts</span><span class="p">[</span><span class="n">field_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_counts</span><span class="p">[</span><span class="n">field_key</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1">## Check the reserved keywords</span>
        <span class="k">if</span> <span class="s1">&#39;limit&#39;</span> <span class="ow">in</span> <span class="n">field_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">field_counts</span><span class="p">[</span><span class="s1">&#39;limit&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;You cannot specify limit more than once&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;offset&#39;</span> <span class="ow">in</span> <span class="n">field_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">field_counts</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;You cannot specify offset more than once&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;perpage&#39;</span> <span class="ow">in</span> <span class="n">field_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">field_counts</span><span class="p">[</span><span class="s1">&#39;perpage&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;You cannot specify perpage more than once&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;orderby&#39;</span> <span class="ow">in</span> <span class="n">field_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">field_counts</span><span class="p">[</span><span class="s1">&#39;orderby&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;You cannot specify orderby more than once&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;alist&#39;</span> <span class="ow">in</span> <span class="n">field_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">field_counts</span><span class="p">[</span><span class="s1">&#39;alist&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;You cannot specify alist more than once&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;nalist&#39;</span> <span class="ow">in</span> <span class="n">field_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">field_counts</span><span class="p">[</span><span class="s1">&#39;nalist&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;You cannot specify nalist more than once&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;elist&#39;</span> <span class="ow">in</span> <span class="n">field_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">field_counts</span><span class="p">[</span><span class="s1">&#39;elist&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;You cannot specify elist more than once&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;nelist&#39;</span> <span class="ow">in</span> <span class="n">field_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">field_counts</span><span class="p">[</span><span class="s1">&#39;nelist&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;You cannot specify nelist more than once&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;format&#39;</span> <span class="ow">in</span> <span class="n">field_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">field_counts</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;You cannot specify format more than once&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;visformat&#39;</span> <span class="ow">in</span> <span class="n">field_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">field_counts</span><span class="p">[</span><span class="s1">&#39;visformat&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;You cannot specify visformat more than once&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;filename&#39;</span> <span class="ow">in</span> <span class="n">field_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">field_counts</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;You cannot specify filename more than once&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;rtype&#39;</span> <span class="ow">in</span> <span class="n">field_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">field_counts</span><span class="p">[</span><span class="s1">&#39;rtype&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;You cannot specify rtype more than once&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;in_limit&#39;</span> <span class="ow">in</span> <span class="n">field_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">field_counts</span><span class="p">[</span><span class="s1">&#39;in_limit&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;You cannot specify in_limit more than once&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;out_limit&#39;</span> <span class="ow">in</span> <span class="n">field_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">field_counts</span><span class="p">[</span><span class="s1">&#39;out_limit&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;You cannot specify out_limit more than once&quot;</span><span class="p">)</span>

        <span class="c1">## Extract results</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">field_list</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
                    <span class="n">limit</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;only assignment operator &#39;=&#39; is permitted after &#39;limit&#39;&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;offset&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;only assignment operator &#39;=&#39; is permitted after &#39;offset&#39;&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;perpage&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
                    <span class="n">perpage</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;only assignment operator &#39;=&#39; is permitted after &#39;perpage&#39;&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;alist&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
                    <span class="n">alist</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;only assignment operator &#39;=&#39; is permitted after &#39;alist&#39;&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nalist&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
                    <span class="n">nalist</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;only assignment operator &#39;=&#39; is permitted after &#39;nalist&#39;&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;elist&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
                    <span class="n">elist</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;only assignment operator &#39;=&#39; is permitted after &#39;elist&#39;&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nelist&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
                    <span class="n">nelist</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;only assignment operator &#39;=&#39; is permitted after &#39;nelist&#39;&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;orderby&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
                    <span class="c1"># Consider value (gives string) and value_list (gives list of</span>
                    <span class="c1"># strings) cases</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">orderby</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">orderby</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;only assignment operator &#39;=&#39; is permitted after &#39;orderby&#39;&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
                    <span class="n">downloadformat</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;only assignment operator &#39;=&#39; is permitted after &#39;format&#39;&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;visformat&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
                    <span class="n">visformat</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;only assignment operator &#39;=&#39; is permitted after &#39;visformat&#39;&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;filename&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;only assignment operator &#39;=&#39; is permitted after &#39;filename&#39;&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rtype&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
                    <span class="n">rtype</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;only assignment operator &#39;=&#39; is permitted after &#39;rtype&#39;&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;in_limit&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
                    <span class="n">tree_in_limit</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;only assignment operator &#39;=&#39; is permitted after &#39;in_limit&#39;&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;out_limit&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
                    <span class="n">tree_out_limit</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;only assignment operator &#39;=&#39; is permitted after &#39;out_limit&#39;&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="c1">## Construct the filter entry.</span>
                <span class="n">field_key</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">operator</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">field_value</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_value</span><span class="p">,</span> <span class="n">DatetimePrecision</span><span class="p">)</span> <span class="ow">and</span> <span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
                    <span class="n">filter_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_datetime_filter</span><span class="p">(</span><span class="n">field_value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filter_value</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">op_conv_map</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span> <span class="n">field_value</span><span class="p">}</span>

                <span class="c1"># Here I treat the AND clause</span>
                <span class="k">if</span> <span class="n">field_counts</span><span class="p">[</span><span class="n">field_key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">field_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">filters</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">field_key</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;and&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">filter_value</span><span class="p">]}})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">filters</span><span class="p">[</span><span class="n">field_key</span><span class="p">][</span><span class="s1">&#39;and&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filter_value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filters</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">field_key</span><span class="p">:</span> <span class="n">filter_value</span><span class="p">})</span>

        <span class="c1"># #Impose defaults if needed</span>
        <span class="c1"># if limit is None:</span>
        <span class="c1">#     limit = self.limit_default</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">perpage</span><span class="p">,</span> <span class="n">orderby</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">alist</span><span class="p">,</span> <span class="n">nalist</span><span class="p">,</span> <span class="n">elist</span><span class="p">,</span> <span class="n">nelist</span><span class="p">,</span> <span class="n">downloadformat</span><span class="p">,</span> <span class="n">visformat</span><span class="p">,</span>
                <span class="n">filename</span><span class="p">,</span> <span class="n">rtype</span><span class="p">,</span> <span class="n">tree_in_limit</span><span class="p">,</span> <span class="n">tree_out_limit</span><span class="p">)</span></div>

<div class="viewcode-block" id="Utils.parse_query_string"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.common.html#aiida.restapi.common.utils.Utils.parse_query_string">[docs]</a>    <span class="k">def</span> <span class="nf">parse_query_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_string</span><span class="p">):</span>
        <span class="c1"># pylint: disable=too-many-locals</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function that parse the querystring, extracting infos for limit, offset,</span>
<span class="sd">        ordering, filters, attribute and extra projections.</span>
<span class="sd">        :param query_string (as obtained from request.query_string)</span>
<span class="sd">        :return: parsed values for the querykeys</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">pyparsing</span> <span class="k">import</span> <span class="n">Word</span><span class="p">,</span> <span class="n">alphas</span><span class="p">,</span> <span class="n">nums</span><span class="p">,</span> <span class="n">alphanums</span><span class="p">,</span> <span class="n">printables</span><span class="p">,</span> \
            <span class="n">ZeroOrMore</span><span class="p">,</span> <span class="n">OneOrMore</span><span class="p">,</span> <span class="n">Suppress</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Group</span><span class="p">,</span> \
            <span class="n">QuotedString</span><span class="p">,</span> <span class="n">Combine</span><span class="p">,</span> \
            <span class="n">StringStart</span> <span class="k">as</span> <span class="n">SS</span><span class="p">,</span> <span class="n">StringEnd</span> <span class="k">as</span> <span class="n">SE</span><span class="p">,</span> \
            <span class="n">WordEnd</span> <span class="k">as</span> <span class="n">WE</span><span class="p">,</span> \
            <span class="n">ParseException</span>

        <span class="kn">from</span> <span class="nn">pyparsing</span> <span class="k">import</span> <span class="n">pyparsing_common</span> <span class="k">as</span> <span class="n">ppc</span>
        <span class="kn">from</span> <span class="nn">dateutil</span> <span class="k">import</span> <span class="n">parser</span> <span class="k">as</span> <span class="n">dtparser</span>
        <span class="kn">from</span> <span class="nn">psycopg2.tz</span> <span class="k">import</span> <span class="n">FixedOffsetTimezone</span>

        <span class="c1">## Define grammar</span>
        <span class="c1"># key types</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">Word</span><span class="p">(</span><span class="n">alphas</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">alphanums</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="c1"># operators</span>
        <span class="n">operator</span> <span class="o">=</span> <span class="p">(</span><span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;=like=&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;=ilike=&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;=in=&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;=notin=&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="o">|</span>
                    <span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;!=&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;&gt;=&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;&lt;=&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">))</span>
        <span class="c1"># Value types</span>
        <span class="n">value_num</span> <span class="o">=</span> <span class="n">ppc</span><span class="o">.</span><span class="n">number</span>
        <span class="n">value_bool</span> <span class="o">=</span> <span class="p">(</span><span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;true&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;false&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">addParseAction</span><span class="p">(</span><span class="k">lambda</span> <span class="n">toks</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">value_string</span> <span class="o">=</span> <span class="n">QuotedString</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">escQuote</span><span class="o">=</span><span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">)</span>
        <span class="n">value_orderby</span> <span class="o">=</span> <span class="n">Combine</span><span class="p">(</span><span class="n">Optional</span><span class="p">(</span><span class="n">Word</span><span class="p">(</span><span class="s1">&#39;+-&#39;</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>

        <span class="c1">## DateTimeShift value. First, compose the atomic values and then</span>
        <span class="c1"># combine</span>
        <span class="c1">#  them and convert them to datetime objects</span>
        <span class="c1"># Date</span>
        <span class="n">value_date</span> <span class="o">=</span> <span class="n">Combine</span><span class="p">(</span>
            <span class="n">Word</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">Word</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">Word</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="c1"># Time</span>
        <span class="n">value_time</span> <span class="o">=</span> <span class="n">Combine</span><span class="p">(</span>
            <span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">Word</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">Optional</span><span class="p">(</span><span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">Word</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span>
            <span class="n">Optional</span><span class="p">(</span><span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">Word</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="mi">2</span><span class="p">)))</span>
        <span class="c1"># Shift</span>
        <span class="n">value_shift</span> <span class="o">=</span> <span class="n">Combine</span><span class="p">(</span><span class="n">Word</span><span class="p">(</span><span class="s1">&#39;+-&#39;</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">Word</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">Optional</span><span class="p">(</span><span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">Word</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="mi">2</span><span class="p">)))</span>
        <span class="c1"># Combine atomic values</span>
        <span class="n">value_datetime</span> <span class="o">=</span> <span class="n">Combine</span><span class="p">(</span>
            <span class="n">value_date</span> <span class="o">+</span> <span class="n">Optional</span><span class="p">(</span><span class="n">value_time</span><span class="p">)</span> <span class="o">+</span> <span class="n">Optional</span><span class="p">(</span><span class="n">value_shift</span><span class="p">)</span> <span class="o">+</span> <span class="n">WE</span><span class="p">(</span><span class="n">printables</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="c1"># To us the</span>
            <span class="c1"># word must end with &#39;&amp;&#39; or end of the string</span>
            <span class="c1"># Adding  WordEnd  only here is very important. This makes atomic</span>
            <span class="c1"># values for date, time and shift not really</span>
            <span class="c1"># usable alone individually.</span>
        <span class="p">)</span>

        <span class="c1">########################################################################</span>

        <span class="k">def</span> <span class="nf">validate_time</span><span class="p">(</span><span class="n">toks</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Function to convert datetime string into datetime object. The format is</span>
<span class="sd">            compliant with ParseAction requirements</span>

<span class="sd">            :param toks: datetime string passed in tokens</span>
<span class="sd">            :return: datetime object</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">datetime_string</span> <span class="o">=</span> <span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Check the precision</span>
            <span class="n">precision</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">datetime_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">))</span>

            <span class="c1"># Parse</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dtobj</span> <span class="o">=</span> <span class="n">dtparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">datetime_string</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;time value has wrong format. The &quot;</span>
                                               <span class="s2">&quot;right format is &quot;</span>
                                               <span class="s2">&quot;&lt;date&gt;T&lt;time&gt;&lt;offset&gt;, &quot;</span>
                                               <span class="s2">&quot;where &lt;date&gt; is expressed as &quot;</span>
                                               <span class="s2">&quot;[YYYY]-[MM]-[DD], &quot;</span>
                                               <span class="s2">&quot;&lt;time&gt; is expressed as [HH]:[MM]:[&quot;</span>
                                               <span class="s2">&quot;SS], &quot;</span>
                                               <span class="s2">&quot;&lt;offset&gt; is expressed as +/-[HH]:[&quot;</span>
                                               <span class="s2">&quot;MM] &quot;</span>
                                               <span class="s2">&quot;given with &quot;</span>
                                               <span class="s2">&quot;respect to UTC&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dtobj</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dtobj</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tzoffset_minutes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dtobj</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">()</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">//</span> <span class="mi">60</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">DatetimePrecision</span><span class="p">(</span>
                    <span class="n">dtobj</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">FixedOffsetTimezone</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="n">tzoffset_minutes</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)),</span> <span class="n">precision</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">DatetimePrecision</span><span class="p">(</span><span class="n">dtobj</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">FixedOffsetTimezone</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)),</span> <span class="n">precision</span><span class="p">)</span>

        <span class="c1">########################################################################</span>

        <span class="c1"># Convert datetime value to datetime object</span>
        <span class="n">value_datetime</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span><span class="n">validate_time</span><span class="p">)</span>

        <span class="c1"># More General types</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value_string</span> <span class="o">|</span> <span class="n">value_bool</span> <span class="o">|</span> <span class="n">value_datetime</span> <span class="o">|</span> <span class="n">value_num</span> <span class="o">|</span> <span class="n">value_orderby</span><span class="p">)</span>
        <span class="c1"># List of values (I do not check the homogeneity of the types of values,</span>
        <span class="c1"># query builder will do it somehow)</span>
        <span class="n">value_list</span> <span class="o">=</span> <span class="n">Group</span><span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="n">OneOrMore</span><span class="p">(</span><span class="n">Suppress</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="n">Optional</span><span class="p">(</span><span class="n">Suppress</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)))</span>

        <span class="c1"># Fields</span>
        <span class="n">single_field</span> <span class="o">=</span> <span class="n">Group</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="n">operator</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">list_field</span> <span class="o">=</span> <span class="n">Group</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="p">(</span><span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;=in=&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;=notin=&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="n">value_list</span><span class="p">)</span>
        <span class="n">orderby_field</span> <span class="o">=</span> <span class="n">Group</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">value_list</span><span class="p">)</span>
        <span class="n">field</span> <span class="o">=</span> <span class="p">(</span><span class="n">list_field</span> <span class="o">|</span> <span class="n">orderby_field</span> <span class="o">|</span> <span class="n">single_field</span><span class="p">)</span>

        <span class="c1"># Fields separator</span>
        <span class="n">separator</span> <span class="o">=</span> <span class="n">Suppress</span><span class="p">(</span><span class="n">Literal</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">))</span>

        <span class="c1"># General query string</span>
        <span class="n">general_grammar</span> <span class="o">=</span> <span class="n">SS</span><span class="p">()</span> <span class="o">+</span> <span class="n">Optional</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="o">+</span> <span class="n">ZeroOrMore</span><span class="p">(</span>
            <span class="n">separator</span> <span class="o">+</span> <span class="n">field</span><span class="p">)</span> <span class="o">+</span> \
                         <span class="n">Optional</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="o">+</span> <span class="n">SE</span><span class="p">()</span>

        <span class="c1">## Parse the query string</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">general_grammar</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>

            <span class="c1"># JQuery adds _=timestamp a parameter to not use cached data/response.</span>
            <span class="c1"># To handle query, remove this &quot;_&quot; parameter from the query string</span>
            <span class="c1"># For more details check issue #789</span>
            <span class="c1"># (https://github.com/aiidateam/aiida_core/issues/789) in aiida_core</span>
            <span class="n">field_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">asList</span><span class="p">()</span> <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;_&quot;</span><span class="p">]</span>

        <span class="k">except</span> <span class="n">ParseException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RestInputValidationError</span><span class="p">(</span><span class="s2">&quot;The query string format is invalid. &quot;</span>
                                           <span class="s2">&quot;Parser returned this massage: </span><span class="se">\&quot;</span><span class="s2">{&quot;</span>
                                           <span class="s2">&quot;}.</span><span class="se">\&quot;</span><span class="s2"> Please notice that the column &quot;</span>
                                           <span class="s2">&quot;number &quot;</span>
                                           <span class="s2">&quot;is counted from &quot;</span>
                                           <span class="s2">&quot;the first character of the query &quot;</span>
                                           <span class="s2">&quot;string.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

        <span class="c1">## return the translator instructions elaborated from the field_list</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_translator_parameters</span><span class="p">(</span><span class="n">field_list</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="list_routes"><a class="viewcode-back" href="../../../../apidoc/aiida.restapi.common.html#aiida.restapi.common.utils.list_routes">[docs]</a><span class="k">def</span> <span class="nf">list_routes</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;List available routes&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="n">urllib</span>
    <span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">current_app</span>

    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">current_app</span><span class="o">.</span><span class="n">url_map</span><span class="o">.</span><span class="n">iter_rules</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">endpoint</span> <span class="o">==</span> <span class="s2">&quot;static&quot;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">methods</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">methods</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:15s}</span><span class="s2"> </span><span class="si">{:20s}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">methods</span><span class="p">,</span> <span class="n">rule</span><span class="p">))</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">output</span><span class="p">))</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>