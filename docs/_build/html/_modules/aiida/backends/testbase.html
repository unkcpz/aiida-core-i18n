

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.backends.testbase &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.backends.testbase</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.backends.testbase</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">from</span> <span class="nn">tornado</span> <span class="k">import</span> <span class="n">ioloop</span>

<span class="kn">from</span> <span class="nn">aiida.backends.tests</span> <span class="k">import</span> <span class="n">get_db_test_list</span>
<span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">ConfigurationError</span><span class="p">,</span> <span class="n">TestsNotAllowedError</span><span class="p">,</span> <span class="n">InternalError</span>
<span class="kn">from</span> <span class="nn">aiida.common.lang</span> <span class="k">import</span> <span class="n">classproperty</span>
<span class="kn">from</span> <span class="nn">aiida.manage</span> <span class="k">import</span> <span class="n">configuration</span>
<span class="kn">from</span> <span class="nn">aiida.manage.manager</span> <span class="k">import</span> <span class="n">get_manager</span><span class="p">,</span> <span class="n">reset_manager</span>


<div class="viewcode-block" id="check_if_tests_can_run"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.testbase.check_if_tests_can_run">[docs]</a><span class="k">def</span> <span class="nf">check_if_tests_can_run</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Verify that the currently loaded profile is a test profile, otherwise raise `TestsNotAllowedError`.&quot;&quot;&quot;</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">PROFILE</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">profile</span><span class="o">.</span><span class="n">is_test_profile</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">TestsNotAllowedError</span><span class="p">(</span><span class="s1">&#39;currently loaded profile </span><span class="si">{}</span><span class="s1"> is not a valid test profile&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div>


<div class="viewcode-block" id="AiidaTestCase"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.testbase.AiidaTestCase">[docs]</a><span class="k">class</span> <span class="nc">AiidaTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the base class for AiiDA tests, independent of the backend.</span>

<span class="sd">    Internally it loads the AiidaTestImplementation subclass according to the current backend</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_class_was_setup</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">__backend_instance</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: aiida.orm.Backend</span>

<div class="viewcode-block" id="AiidaTestCase.get_backend_class"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.testbase.AiidaTestCase.get_backend_class">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_backend_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">aiida.backends.testimplbase</span> <span class="k">import</span> <span class="n">AiidaTestImplementation</span>
        <span class="kn">from</span> <span class="nn">aiida.backends</span> <span class="k">import</span> <span class="n">BACKEND_SQLA</span><span class="p">,</span> <span class="n">BACKEND_DJANGO</span>
        <span class="kn">from</span> <span class="nn">aiida.manage.configuration</span> <span class="k">import</span> <span class="n">PROFILE</span>

        <span class="c1"># Freeze the __impl_class after the first run</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;__impl_class&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">PROFILE</span><span class="o">.</span><span class="n">database_backend</span> <span class="o">==</span> <span class="n">BACKEND_SQLA</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">aiida.backends.sqlalchemy.tests.testbase</span> <span class="k">import</span> <span class="p">(</span>
                    <span class="n">SqlAlchemyTests</span><span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">__impl_class</span> <span class="o">=</span> <span class="n">SqlAlchemyTests</span>
            <span class="k">elif</span> <span class="n">PROFILE</span><span class="o">.</span><span class="n">database_backend</span> <span class="o">==</span> <span class="n">BACKEND_DJANGO</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">aiida.backends.djsite.db.testbase</span> <span class="k">import</span> <span class="n">DjangoTests</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">__impl_class</span> <span class="o">=</span> <span class="n">DjangoTests</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;Unknown backend type&quot;</span><span class="p">)</span>

            <span class="c1"># Check that it is of the right class</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__impl_class</span><span class="p">,</span> <span class="n">AiidaTestImplementation</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InternalError</span><span class="p">(</span>
                    <span class="s2">&quot;The AiiDA test implementation is not of type &quot;</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">, that is not a subclass of AiidaTestImplementation&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="n">__impl_class</span><span class="o">.</span><span class="vm">__name__</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__impl_class</span></div>

<div class="viewcode-block" id="AiidaTestCase.setUpClass"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.testbase.AiidaTestCase.setUpClass">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Note: this will raise an exception, that will be seen as a test</span>
        <span class="c1"># failure. To be safe, you should do the same check also in the tearDownClass</span>
        <span class="c1"># to avoid that it is run</span>
        <span class="n">check_if_tests_can_run</span><span class="p">()</span>

        <span class="c1"># Force the loading of the backend which will load the required database environment</span>
        <span class="n">get_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">__backend_instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_backend_class</span><span class="p">()()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">__backend_instance</span><span class="o">.</span><span class="n">setUpClass_method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__backend_instance</span><span class="o">.</span><span class="n">backend</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">insert_data</span><span class="p">()</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">_class_was_setup</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="AiidaTestCase.setUp"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.testbase.AiidaTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Install a new IOLoop so that any messing up of the state of the loop is not propagated</span>
        <span class="c1"># to subsequent tests.</span>
        <span class="c1"># This call should come before the backend instance setup call just in case it uses the loop</span>
        <span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="p">()</span><span class="o">.</span><span class="n">make_current</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__backend_instance</span><span class="o">.</span><span class="n">setUp_method</span><span class="p">()</span></div>

<div class="viewcode-block" id="AiidaTestCase.tearDown"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.testbase.AiidaTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__backend_instance</span><span class="o">.</span><span class="n">tearDown_method</span><span class="p">()</span>
        <span class="c1"># Clean up the loop we created in set up.</span>
        <span class="c1"># Call this after the instance tear down just in case it uses the loop</span>
        <span class="n">reset_manager</span><span class="p">()</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">loop</span><span class="o">.</span><span class="n">_closing</span><span class="p">:</span>
            <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="AiidaTestCase.reset_database"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.testbase.AiidaTestCase.reset_database">[docs]</a>    <span class="k">def</span> <span class="nf">reset_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset the database to the default state deleting any content currently stored&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_data</span><span class="p">()</span></div>

<div class="viewcode-block" id="AiidaTestCase.insert_data"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.testbase.AiidaTestCase.insert_data">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">insert_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">__backend_instance</span><span class="o">.</span><span class="n">insert_data</span><span class="p">()</span></div>

<div class="viewcode-block" id="AiidaTestCase.clean_db"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.testbase.AiidaTestCase.clean_db">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">clean_db</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clean up database and reset caches.</span>

<span class="sd">        Resets AiiDA manager cache, which could otherwise be left in an inconsistent state when cleaning the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">InvalidOperation</span>

        <span class="c1"># Note: this will raise an exception, that will be seen as a test</span>
        <span class="c1"># failure. To be safe, you should do the same check also in the tearDownClass</span>
        <span class="c1"># to avoid that it is run</span>
        <span class="n">check_if_tests_can_run</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_class_was_setup</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidOperation</span><span class="p">(</span><span class="s2">&quot;You cannot call clean_db before running the setUpClass&quot;</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">__backend_instance</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>

        <span class="n">reset_manager</span><span class="p">()</span></div>

<div class="viewcode-block" id="AiidaTestCase.clean_repository"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.testbase.AiidaTestCase.clean_repository">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">clean_repository</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cleans up file repository.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.manage.configuration</span> <span class="k">import</span> <span class="n">get_profile</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">InvalidOperation</span>
        <span class="kn">import</span> <span class="nn">shutil</span>

        <span class="n">dirpath_repository</span> <span class="o">=</span> <span class="n">get_profile</span><span class="p">()</span><span class="o">.</span><span class="n">repository_path</span>

        <span class="n">TEST_KEYWORD</span> <span class="o">=</span> <span class="s1">&#39;test_&#39;</span>
        <span class="n">base_repo_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">dirpath_repository</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">TEST_KEYWORD</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_repo_path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidOperation</span><span class="p">(</span><span class="s2">&quot;Warning: The repository folder </span><span class="si">{}</span><span class="s2"> does not &quot;</span>
                                   <span class="s2">&quot;seem to belong to a test profile and will therefore not be deleted.</span><span class="se">\n</span><span class="s2">&quot;</span>
                                   <span class="s2">&quot;Full repository path: &quot;</span>
                                   <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">base_repo_path</span><span class="p">,</span> <span class="n">dirpath_repository</span><span class="p">))</span>

        <span class="c1"># Clean the test repository</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dirpath_repository</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirpath_repository</span><span class="p">)</span></div>

    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">computer</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the default computer for this test</span>

<span class="sd">        :return: the test computer</span>
<span class="sd">        :rtype: :class:`aiida.orm.Computer`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__backend_instance</span><span class="o">.</span><span class="n">get_computer</span><span class="p">()</span>

    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">user_email</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__backend_instance</span><span class="o">.</span><span class="n">get_user_email</span><span class="p">()</span>

<div class="viewcode-block" id="AiidaTestCase.tearDownClass"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.testbase.AiidaTestCase.tearDownClass">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">tearDownClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Double check for double security to avoid to run the tearDown</span>
        <span class="c1"># if this is not a test profile</span>
        <span class="n">check_if_tests_can_run</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">clean_repository</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">__backend_instance</span><span class="o">.</span><span class="n">tearDownClass_method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AiidaTestCase.assertClickSuccess"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.testbase.AiidaTestCase.assertClickSuccess">[docs]</a>    <span class="k">def</span> <span class="nf">assertClickSuccess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cli_result</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cli_result</span><span class="o">.</span><span class="n">exit_code</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cli_result</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertClickResultNoException</span><span class="p">(</span><span class="n">cli_result</span><span class="p">)</span></div>

<div class="viewcode-block" id="AiidaTestCase.assertClickResultNoException"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.testbase.AiidaTestCase.assertClickResultNoException">[docs]</a>    <span class="k">def</span> <span class="nf">assertClickResultNoException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cli_result</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">cli_result</span><span class="o">.</span><span class="n">exception</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="o">*</span><span class="n">cli_result</span><span class="o">.</span><span class="n">exc_info</span><span class="p">)))</span></div></div>


<div class="viewcode-block" id="AiidaPostgresTestCase"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.testbase.AiidaPostgresTestCase">[docs]</a><span class="k">class</span> <span class="nc">AiidaPostgresTestCase</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="AiidaPostgresTestCase.setUpClass"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.testbase.AiidaPostgresTestCase.setUpClass">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup the PGTest postgres test cluster.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pgtest.pgtest</span> <span class="k">import</span> <span class="n">PGTest</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">pg_test</span> <span class="o">=</span> <span class="n">PGTest</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AiidaPostgresTestCase</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AiidaPostgresTestCase.tearDownClass"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.testbase.AiidaPostgresTestCase.tearDownClass">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">tearDownClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the PGTest postgres test cluster.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AiidaPostgresTestCase</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownClass</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">pg_test</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="run_aiida_db_tests"><a class="viewcode-back" href="../../../apidoc/aiida.backends.html#aiida.backends.testbase.run_aiida_db_tests">[docs]</a><span class="k">def</span> <span class="nf">run_aiida_db_tests</span><span class="p">(</span><span class="n">tests_to_run</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run all tests specified in tests_to_run.</span>
<span class="sd">    Return the list of test results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Empty test suite that will be populated</span>
    <span class="n">test_suite</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">()</span>

    <span class="n">actually_run_tests</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">num_tests_expected</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># To avoid adding more than once the same test</span>
    <span class="c1"># (e.g. if you type both db and db.xxx)</span>
    <span class="n">found_modulenames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">tests_to_run</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">modulenames</span> <span class="o">=</span> <span class="n">get_db_test_list</span><span class="p">()[</span><span class="n">test</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown DB test </span><span class="si">{}</span><span class="s2">... skipping&quot;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">actually_run_tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">modulename</span> <span class="ow">in</span> <span class="n">modulenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">modulename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">found_modulenames</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">test_suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">defaultTestLoader</span><span class="o">.</span><span class="n">loadTestsFromName</span><span class="p">(</span><span class="n">modulename</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">importlib</span>
                        <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">modulename</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[CRITICAL] The module &#39;</span><span class="si">{}</span><span class="s2">&#39; has an import error and the tests cannot be run:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span>
                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">modulename</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(</span><span class="n">exception</span><span class="p">)),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">found_modulenames</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">modulename</span><span class="p">)</span>

        <span class="n">num_tests_expected</span> <span class="o">=</span> <span class="n">test_suite</span><span class="o">.</span><span class="n">countTestCases</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DB tests that will be run: </span><span class="si">{}</span><span class="s2"> (expecting </span><span class="si">{}</span><span class="s2"> tests)&quot;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">actually_run_tests</span><span class="p">),</span> <span class="n">num_tests_expected</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TextTestRunner</span><span class="p">(</span><span class="n">failfast</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">test_suite</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TextTestRunner</span><span class="p">(</span><span class="n">failfast</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">test_suite</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Run tests: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">testsRun</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">results</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>