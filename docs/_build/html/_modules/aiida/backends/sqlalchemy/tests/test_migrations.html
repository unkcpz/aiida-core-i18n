

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.backends.sqlalchemy.tests.test_migrations &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../../aiida.html">aiida</a> &raquo;</li>
        
          <li><a href="../../sqlalchemy.html">aiida.backends.sqlalchemy</a> &raquo;</li>
        
      <li>aiida.backends.sqlalchemy.tests.test_migrations</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.backends.sqlalchemy.tests.test_migrations</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="c1"># pylint: disable=too-many-lines</span>
<span class="sd">&quot;&quot;&quot;Tests for the migration engine (Alembic) as well as for the AiiDA migrations for SQLAlchemy.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="kn">from</span> <span class="nn">contextlib</span> <span class="k">import</span> <span class="n">contextmanager</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">alembic</span> <span class="k">import</span> <span class="n">command</span>
<span class="kn">from</span> <span class="nn">alembic.config</span> <span class="k">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="nb">zip</span>

<span class="kn">from</span> <span class="nn">aiida.backends</span> <span class="k">import</span> <span class="n">sqlalchemy</span> <span class="k">as</span> <span class="n">sa</span>
<span class="kn">from</span> <span class="nn">aiida.backends.general.migrations</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">aiida.backends.sqlalchemy</span> <span class="k">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">sqlalchemy_utils</span>
<span class="kn">from</span> <span class="nn">aiida.backends.sqlalchemy.models.base</span> <span class="k">import</span> <span class="n">Base</span>
<span class="kn">from</span> <span class="nn">aiida.backends.sqlalchemy.tests.test_utils</span> <span class="k">import</span> <span class="n">new_database</span>
<span class="kn">from</span> <span class="nn">aiida.backends.sqlalchemy.utils</span> <span class="k">import</span> <span class="n">flag_modified</span>
<span class="kn">from</span> <span class="nn">aiida.backends.testbase</span> <span class="k">import</span> <span class="n">AiidaTestCase</span>


<div class="viewcode-block" id="TestMigrationsSQLA"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestMigrationsSQLA">[docs]</a><span class="k">class</span> <span class="nc">TestMigrationsSQLA</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class contains tests for the migration mechanism of SQLAlchemy called</span>
<span class="sd">    alembic. It checks if the migrations can be applied and removed correctly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The path to the folder that contains the migration configuration (the</span>
    <span class="c1"># actual configuration - not the testing)</span>
    <span class="n">migr_method_dir_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># The path of the migration configuration (the actual configuration - not</span>
    <span class="c1"># the testing)</span>
    <span class="n">alembic_dpath</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">migrate_from</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">migrate_to</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="TestMigrationsSQLA.setUpClass"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestMigrationsSQLA.setUpClass">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the test class with the alembivc configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestMigrationsSQLA</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">migr_method_dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">sqlalchemy_utils</span><span class="o">.</span><span class="vm">__file__</span><span class="p">))</span>
        <span class="n">alembic_dpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">migr_method_dir_path</span><span class="p">,</span> <span class="n">sqlalchemy_utils</span><span class="o">.</span><span class="n">ALEMBIC_REL_PATH</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">alembic_cfg</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">alembic_cfg</span><span class="o">.</span><span class="n">set_main_option</span><span class="p">(</span><span class="s1">&#39;script_location&#39;</span><span class="p">,</span> <span class="n">alembic_dpath</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestMigrationsSQLA.setUp"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestMigrationsSQLA.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Go to the migrate_from revision, apply setUpBeforeMigration, then</span>
<span class="sd">        run the migration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestMigrationsSQLA</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="k">import</span> <span class="n">autogroup</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_autogroup</span> <span class="o">=</span> <span class="n">autogroup</span><span class="o">.</span><span class="n">current_autogroup</span>
        <span class="n">autogroup</span><span class="o">.</span><span class="n">current_autogroup</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrate_from</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrate_to</span><span class="p">,</span> \
            <span class="s2">&quot;TestCase &#39;</span><span class="si">{}</span><span class="s2">&#39; must define migrate_from and migrate_to properties&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">migrate_db_down</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">migrate_from</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setUpBeforeMigration</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">migrate_db_up</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">migrate_to</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Bring back the DB to the correct state if this setup part fails</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_database_and_schema</span><span class="p">()</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="TestMigrationsSQLA.migrate_db_up"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestMigrationsSQLA.migrate_db_up">[docs]</a>    <span class="k">def</span> <span class="nf">migrate_db_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destination</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a migration upwards (upgrade) with alembic</span>

<span class="sd">        :param destination: the name of the destination migration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Undo all previous real migration of the database</span>
        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alembic_cfg</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;connection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection</span>  <span class="c1"># pylint: disable=unsupported-assignment-operation</span>
            <span class="n">command</span><span class="o">.</span><span class="n">upgrade</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alembic_cfg</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestMigrationsSQLA.migrate_db_down"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestMigrationsSQLA.migrate_db_down">[docs]</a>    <span class="k">def</span> <span class="nf">migrate_db_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destination</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a migration downwards (downgrade) with alembic</span>

<span class="sd">        :param destination: the name of the destination migration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alembic_cfg</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;connection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection</span>  <span class="c1"># pylint: disable=unsupported-assignment-operation</span>
            <span class="n">command</span><span class="o">.</span><span class="n">downgrade</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alembic_cfg</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestMigrationsSQLA.tearDown"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestMigrationsSQLA.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets both the database content and the schema to prepare for the</span>
<span class="sd">        next test</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="k">import</span> <span class="n">autogroup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_database_and_schema</span><span class="p">()</span>
        <span class="n">autogroup</span><span class="o">.</span><span class="n">current_autogroup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_autogroup</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestMigrationsSQLA</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestMigrationsSQLA.setUpBeforeMigration"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestMigrationsSQLA.setUpBeforeMigration">[docs]</a>    <span class="k">def</span> <span class="nf">setUpBeforeMigration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Anything to do before running the migrations.</span>
<span class="sd">        This is typically implemented in test subclasses.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="TestMigrationsSQLA._reset_database_and_schema"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestMigrationsSQLA._reset_database_and_schema">[docs]</a>    <span class="k">def</span> <span class="nf">_reset_database_and_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bring back the DB to the correct state.</span>

<span class="sd">        It is important to also reset the database content to avoid hanging</span>
<span class="sd">        of tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">migrate_db_up</span><span class="p">(</span><span class="s2">&quot;head&quot;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_rev</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Utility method to get the current revision string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">alembic.migration</span> <span class="k">import</span> <span class="n">MigrationContext</span>  <span class="c1"># pylint: disable=import-error</span>
        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">MigrationContext</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
            <span class="n">current_rev</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_current_revision</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">current_rev</span>

<div class="viewcode-block" id="TestMigrationsSQLA.get_auto_base"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestMigrationsSQLA.get_auto_base">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_auto_base</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the automap_base class that automatically inspects the current</span>
<span class="sd">        database and return SQLAlchemy Models.</span>

<span class="sd">        Note that these are NOT the ones in AiiDA SQLAlchemy models, so do not</span>
<span class="sd">        have the special methods that we define there (like .save()).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">alembic.migration</span> <span class="k">import</span> <span class="n">MigrationContext</span>  <span class="c1"># pylint: disable=import-error</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.ext.automap</span> <span class="k">import</span> <span class="n">automap_base</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">MigrationContext</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">bind</span>

            <span class="n">base</span> <span class="o">=</span> <span class="n">automap_base</span><span class="p">()</span>
            <span class="c1"># reflect the tables</span>
            <span class="n">base</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">bind</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="n">reflect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">base</span></div>

<div class="viewcode-block" id="TestMigrationsSQLA.get_session"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestMigrationsSQLA.get_session">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">get_session</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a session that is properly closed after use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">session</span>
            <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestMigrationsSQLA.get_current_table"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestMigrationsSQLA.get_current_table">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a Model instantiated at the correct migration.</span>
<span class="sd">        Note that this is obtained by inspecting the database and not</span>
<span class="sd">        by looking into the models file. So, special methods possibly defined</span>
<span class="sd">        in the models files/classes are not present.</span>

<span class="sd">        For instance, you can do::</span>

<span class="sd">          DbGroup = self.get_current_table(&#39;db_dbgroup&#39;)</span>

<span class="sd">        :param table_name: the name of the table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestMigrationsSQLA.get_node_array"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestMigrationsSQLA.get_node_array">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_node_array</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_numpy_array_from_repository</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestMigrationsSQLA.set_node_array"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestMigrationsSQLA.set_node_array">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">set_node_array</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store a new numpy array inside a node. Possibly overwrite the array if it already existed.</span>

<span class="sd">        Internally, it stores a name.npy file in numpy format.</span>

<span class="sd">        :param name: The name of the array.</span>
<span class="sd">        :param array: The numpy array to store.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">store_numpy_array_in_repository</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">array</span><span class="p">)</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span>
        <span class="k">if</span> <span class="n">attributes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;array|</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="n">attributes</span>
        <span class="n">flag_modified</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;attributes&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestBackwardMigrationsSQLA"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestBackwardMigrationsSQLA">[docs]</a><span class="k">class</span> <span class="nc">TestBackwardMigrationsSQLA</span><span class="p">(</span><span class="n">TestMigrationsSQLA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the equivalent of TestMigrationsSQLA for backward migrations.</span>
<span class="sd">    It assumes that the migrate_from revision is higher in the hierarchy</span>
<span class="sd">    than the migrate_to revision.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestBackwardMigrationsSQLA.setUp"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestBackwardMigrationsSQLA.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Go to the migrate_from revision, apply setUpBeforeMigration, then</span>
<span class="sd">        run the migration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">AiidaTestCase</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># pylint: disable=bad-super-call</span>
        <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="k">import</span> <span class="n">autogroup</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_autogroup</span> <span class="o">=</span> <span class="n">autogroup</span><span class="o">.</span><span class="n">current_autogroup</span>
        <span class="n">autogroup</span><span class="o">.</span><span class="n">current_autogroup</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrate_from</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrate_to</span><span class="p">,</span> \
            <span class="s2">&quot;TestCase &#39;</span><span class="si">{}</span><span class="s2">&#39; must define migrate_from and migrate_to properties&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">migrate_db_down</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">migrate_from</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setUpBeforeMigration</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">migrate_db_down</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">migrate_to</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Bring back the DB to the correct state if this setup part fails</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_database_and_schema</span><span class="p">()</span>
            <span class="k">raise</span></div></div>


<div class="viewcode-block" id="TestMigrationEngine"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestMigrationEngine">[docs]</a><span class="k">class</span> <span class="nc">TestMigrationEngine</span><span class="p">(</span><span class="n">TestMigrationsSQLA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Just a simple test to verify that the TestMigrationsSQLA class indeed</span>
<span class="sd">    works and moves between the expected migration revisions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">migrate_from</span> <span class="o">=</span> <span class="s1">&#39;b8b23ddefad4&#39;</span>  <span class="c1"># b8b23ddefad4_dbgroup_name_to_label_type_to_type_string.py</span>
    <span class="n">migrate_to</span> <span class="o">=</span> <span class="s1">&#39;e72ad251bcdb&#39;</span>  <span class="c1"># e72ad251bcdb_dbgroup_class_change_type_string_values.py</span>

<div class="viewcode-block" id="TestMigrationEngine.setUpBeforeMigration"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestMigrationEngine.setUpBeforeMigration">[docs]</a>    <span class="k">def</span> <span class="nf">setUpBeforeMigration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cache the start revision</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_revision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_rev</span></div>

<div class="viewcode-block" id="TestMigrationEngine.test_revision_numbers"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestMigrationEngine.test_revision_numbers">[docs]</a>    <span class="k">def</span> <span class="nf">test_revision_numbers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that we went to the correct version</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_revision</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrate_from</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_rev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrate_to</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestMigrationSchemaVsModelsSchema"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestMigrationSchemaVsModelsSchema">[docs]</a><span class="k">class</span> <span class="nc">TestMigrationSchemaVsModelsSchema</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class checks that the schema that results from a migration is the</span>
<span class="sd">    same generated by the models. This is important since migrations are</span>
<span class="sd">    frequently written by hand or extended manually and we have to ensure</span>
<span class="sd">    that the final result is what is conceived in the SQLA models.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The path to the folder that contains the migration configuration (the</span>
    <span class="c1"># actual configuration - not the testing)</span>
    <span class="n">migr_method_dir_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># The path of the migration configuration (the actual configuration - not</span>
    <span class="c1"># the testing)</span>
    <span class="n">alembic_dpath</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># The alembic configuration needed for the migrations is stored here</span>
    <span class="n">alembic_cfg_left</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># The URL of the databases</span>
    <span class="n">db_url_left</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">db_url_right</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="TestMigrationSchemaVsModelsSchema.setUp"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestMigrationSchemaVsModelsSchema.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">sqlalchemydiff.util</span> <span class="k">import</span> <span class="n">get_temporary_uri</span>
        <span class="kn">from</span> <span class="nn">aiida.backends.sqlalchemy.migrations</span> <span class="k">import</span> <span class="n">versions</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">migr_method_dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">sqlalchemy_utils</span><span class="o">.</span><span class="vm">__file__</span><span class="p">))</span>
        <span class="c1"># Set the alembic script directory location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alembic_dpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">migr_method_dir_path</span><span class="p">,</span> <span class="n">sqlalchemy_utils</span><span class="o">.</span><span class="n">ALEMBIC_REL_PATH</span><span class="p">)</span>

        <span class="c1"># Constructing the versions directory</span>
        <span class="n">versions_dpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">versions</span><span class="o">.</span><span class="vm">__file__</span><span class="p">))</span>

        <span class="c1"># Setting dynamically the the path to the alembic configuration</span>
        <span class="c1"># (this is where the env.py file can be found)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alembic_cfg_left</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alembic_cfg_left</span><span class="o">.</span><span class="n">set_main_option</span><span class="p">(</span><span class="s1">&#39;script_location&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alembic_dpath</span><span class="p">)</span>
        <span class="c1"># Setting dynamically the versions directory. These are the</span>
        <span class="c1"># migration scripts to pass from one version to the other. The</span>
        <span class="c1"># default ones are overridden with test-specific migrations.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alembic_cfg_left</span><span class="o">.</span><span class="n">set_main_option</span><span class="p">(</span><span class="s1">&#39;version_locations&#39;</span><span class="p">,</span> <span class="n">versions_dpath</span><span class="p">)</span>

        <span class="c1"># The correction URL to the SQLA database of the current</span>
        <span class="c1"># AiiDA connection</span>
        <span class="n">curr_db_url</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">url</span>

        <span class="c1"># Create new urls for the two new databases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_url_left</span> <span class="o">=</span> <span class="n">get_temporary_uri</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">curr_db_url</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_url_right</span> <span class="o">=</span> <span class="n">get_temporary_uri</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">curr_db_url</span><span class="p">))</span>

        <span class="c1"># Put the correct database url to the database used by alembic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alembic_cfg_left</span><span class="o">.</span><span class="n">set_main_option</span><span class="p">(</span><span class="s2">&quot;sqlalchemy.url&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_url_left</span><span class="p">)</span>

        <span class="c1"># Database creation</span>
        <span class="n">new_database</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_url_left</span><span class="p">)</span>
        <span class="n">new_database</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_url_right</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestMigrationSchemaVsModelsSchema.tearDown"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestMigrationSchemaVsModelsSchema.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">sqlalchemydiff.util</span> <span class="k">import</span> <span class="n">destroy_database</span>
        <span class="n">destroy_database</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_url_left</span><span class="p">)</span>
        <span class="n">destroy_database</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_url_right</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestMigrationSchemaVsModelsSchema.test_model_and_migration_schemas_are_the_same"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestMigrationSchemaVsModelsSchema.test_model_and_migration_schemas_are_the_same">[docs]</a>    <span class="k">def</span> <span class="nf">test_model_and_migration_schemas_are_the_same</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="sd">&quot;&quot;&quot;Compare two databases.</span>

<span class="sd">        Compares the database obtained with all migrations against the</span>
<span class="sd">        one we get out of the models.  It produces a text file with the</span>
<span class="sd">        results to help debug differences.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.engine</span> <span class="k">import</span> <span class="n">create_engine</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>
        <span class="kn">from</span> <span class="nn">sqlalchemydiff</span> <span class="k">import</span> <span class="n">compare</span>

        <span class="k">with</span> <span class="n">create_engine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_url_left</span><span class="p">)</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alembic_cfg_left</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;connection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection</span>  <span class="c1"># pylint: disable=unsupported-assignment-operation</span>
            <span class="n">command</span><span class="o">.</span><span class="n">upgrade</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alembic_cfg_left</span><span class="p">,</span> <span class="s2">&quot;head&quot;</span><span class="p">)</span>

        <span class="n">engine_right</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_url_right</span><span class="p">)</span>
        <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine_right</span><span class="p">)</span>
        <span class="n">engine_right</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">compare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_url_left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_url_right</span><span class="p">,</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;alembic_version&#39;</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">is_match</span><span class="p">,</span> <span class="s2">&quot;The migration database doesn&#39;t match to the one &quot;</span>
                        <span class="s2">&quot;created by the models.</span><span class="se">\n</span><span class="s2">Differences: &quot;</span> <span class="o">+</span> <span class="n">result</span><span class="o">.</span><span class="n">_dump_data</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">))</span>  <span class="c1"># pylint: disable=protected-access</span></div></div>


<div class="viewcode-block" id="TestProvenanceRedesignMigration"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestProvenanceRedesignMigration">[docs]</a><span class="k">class</span> <span class="nc">TestProvenanceRedesignMigration</span><span class="p">(</span><span class="n">TestMigrationsSQLA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test the data migration part of the provenance redesign migration.&quot;&quot;&quot;</span>

    <span class="n">migrate_from</span> <span class="o">=</span> <span class="s1">&#39;140c971ae0a3&#39;</span>  <span class="c1"># 140c971ae0a3_migrate_builtin_calculations</span>
    <span class="n">migrate_to</span> <span class="o">=</span> <span class="s1">&#39;239cea6d2452&#39;</span>  <span class="c1"># 239cea6d2452_provenance_redesign</span>

<div class="viewcode-block" id="TestProvenanceRedesignMigration.setUpBeforeMigration"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestProvenanceRedesignMigration.setUpBeforeMigration">[docs]</a>    <span class="k">def</span> <span class="nf">setUpBeforeMigration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="n">DbNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbnode</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">DbUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbuser</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

                <span class="n">user</span> <span class="o">=</span> <span class="n">DbUser</span><span class="p">(</span><span class="n">is_superuser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">@aiida.net&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">()))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="n">node_calc_job_known</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;calculation.job.arithmetic.add.ArithmeticAddCalculation.&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">node_calc_job_unknown</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;calculation.job.unknown.PluginJobCalculation.&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">node_process</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;calculation.process.ProcessCalculation.&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">node_work_chain</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;calculation.work.WorkCalculation.&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">node_work_function</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;calculation.work.WorkCalculation.&#39;</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;function_name&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">},</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">node_inline</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;calculation.inline.InlineCalculation.&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">node_function</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;calculation.function.FunctionCalculation.&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node_calc_job_known</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node_calc_job_unknown</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node_process</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node_work_chain</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node_work_function</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node_inline</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node_function</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">node_calc_job_known_id</span> <span class="o">=</span> <span class="n">node_calc_job_known</span><span class="o">.</span><span class="n">id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node_calc_job_unknown_id</span> <span class="o">=</span> <span class="n">node_calc_job_unknown</span><span class="o">.</span><span class="n">id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node_process_id</span> <span class="o">=</span> <span class="n">node_process</span><span class="o">.</span><span class="n">id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node_work_chain_id</span> <span class="o">=</span> <span class="n">node_work_chain</span><span class="o">.</span><span class="n">id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node_work_function_id</span> <span class="o">=</span> <span class="n">node_work_function</span><span class="o">.</span><span class="n">id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node_inline_id</span> <span class="o">=</span> <span class="n">node_inline</span><span class="o">.</span><span class="n">id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node_function_id</span> <span class="o">=</span> <span class="n">node_function</span><span class="o">.</span><span class="n">id</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestProvenanceRedesignMigration.test_verify_migration"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestProvenanceRedesignMigration.test_verify_migration">[docs]</a>    <span class="k">def</span> <span class="nf">test_verify_migration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify that type string of the Data node was successfully adapted.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="n">DbNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbnode</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

                <span class="c1"># Migration of calculation job with known plugin class</span>
                <span class="n">node_calc_job_known</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbNode</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbNode</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_calc_job_known_id</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_calc_job_known</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;node.process.calculation.calcjob.CalcJobNode.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_calc_job_known</span><span class="o">.</span><span class="n">process_type</span><span class="p">,</span> <span class="s1">&#39;aiida.calculations:arithmetic.add&#39;</span><span class="p">)</span>

                <span class="c1"># Migration of calculation job with unknown plugin class</span>
                <span class="n">node_calc_job_unknown</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbNode</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbNode</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_calc_job_unknown_id</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_calc_job_unknown</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;node.process.calculation.calcjob.CalcJobNode.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_calc_job_unknown</span><span class="o">.</span><span class="n">process_type</span><span class="p">,</span> <span class="s1">&#39;unknown.PluginJobCalculation&#39;</span><span class="p">)</span>

                <span class="c1"># Migration of very old `ProcessNode` class</span>
                <span class="n">node_process</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbNode</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbNode</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_process_id</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_process</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;node.process.workflow.workchain.WorkChainNode.&#39;</span><span class="p">)</span>

                <span class="c1"># Migration of old `WorkCalculation` class</span>
                <span class="n">node_work_chain</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbNode</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbNode</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_work_chain_id</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_work_chain</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;node.process.workflow.workchain.WorkChainNode.&#39;</span><span class="p">)</span>

                <span class="c1"># Migration of old `WorkCalculation` class used for work function</span>
                <span class="n">node_work_function</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbNode</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbNode</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_work_function_id</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_work_function</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;node.process.workflow.workfunction.WorkFunctionNode.&#39;</span><span class="p">)</span>

                <span class="c1"># Migration of old `InlineCalculation` class</span>
                <span class="n">node_inline</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbNode</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbNode</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_inline_id</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_inline</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;node.process.calculation.calcfunction.CalcFunctionNode.&#39;</span><span class="p">)</span>

                <span class="c1"># Migration of old `FunctionCalculation` class</span>
                <span class="n">node_function</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbNode</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbNode</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_function_id</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_function</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;node.process.workflow.workfunction.WorkFunctionNode.&#39;</span><span class="p">)</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="TestGroupRenamingMigration"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestGroupRenamingMigration">[docs]</a><span class="k">class</span> <span class="nc">TestGroupRenamingMigration</span><span class="p">(</span><span class="n">TestMigrationsSQLA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test the migration that renames the DbGroup type strings</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">migrate_from</span> <span class="o">=</span> <span class="s1">&#39;b8b23ddefad4&#39;</span>  <span class="c1"># b8b23ddefad4_dbgroup_name_to_label_type_to_type_string.py</span>
    <span class="n">migrate_to</span> <span class="o">=</span> <span class="s1">&#39;e72ad251bcdb&#39;</span>  <span class="c1"># e72ad251bcdb_dbgroup_class_change_type_string_values.py</span>

<div class="viewcode-block" id="TestGroupRenamingMigration.setUpBeforeMigration"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestGroupRenamingMigration.setUpBeforeMigration">[docs]</a>    <span class="k">def</span> <span class="nf">setUpBeforeMigration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the DbGroups with the old type strings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create group</span>
        <span class="n">DbGroup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_table</span><span class="p">(</span><span class="s1">&#39;db_dbgroup&#39;</span><span class="p">)</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">DbUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_table</span><span class="p">(</span><span class="s1">&#39;db_dbuser&#39;</span><span class="p">)</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">default_user</span> <span class="o">=</span> <span class="n">DbUser</span><span class="p">(</span><span class="n">is_superuser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">@aiida.net&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">()))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">default_user</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="c1"># test user group type_string: &#39;&#39; -&gt; &#39;user&#39;</span>
                <span class="n">group_user</span> <span class="o">=</span> <span class="n">DbGroup</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;test_user_group&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">default_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">type_string</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">group_user</span><span class="p">)</span>
                <span class="c1"># test data.upf group type_string: &#39;data.upf.family&#39; -&gt; &#39;data.upf&#39;</span>
                <span class="n">group_data_upf</span> <span class="o">=</span> <span class="n">DbGroup</span><span class="p">(</span>
                    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test_data_upf_group&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">default_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">type_string</span><span class="o">=</span><span class="s1">&#39;data.upf.family&#39;</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">group_data_upf</span><span class="p">)</span>
                <span class="c1"># test auto.import group type_string: &#39;aiida.import&#39; -&gt; &#39;auto.import&#39;</span>
                <span class="n">group_autoimport</span> <span class="o">=</span> <span class="n">DbGroup</span><span class="p">(</span>
                    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test_import_group&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">default_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">type_string</span><span class="o">=</span><span class="s1">&#39;aiida.import&#39;</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">group_autoimport</span><span class="p">)</span>
                <span class="c1"># test auto.run group type_string: &#39;autogroup.run&#39; -&gt; &#39;auto.run&#39;</span>
                <span class="n">group_autorun</span> <span class="o">=</span> <span class="n">DbGroup</span><span class="p">(</span>
                    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;test_autorun_group&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">default_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">type_string</span><span class="o">=</span><span class="s1">&#39;autogroup.run&#39;</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">group_autorun</span><span class="p">)</span>

                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="c1"># Store values for later tests</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">group_user_pk</span> <span class="o">=</span> <span class="n">group_user</span><span class="o">.</span><span class="n">id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">group_data_upf_pk</span> <span class="o">=</span> <span class="n">group_data_upf</span><span class="o">.</span><span class="n">id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">group_autoimport_pk</span> <span class="o">=</span> <span class="n">group_autoimport</span><span class="o">.</span><span class="n">id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">group_autorun_pk</span> <span class="o">=</span> <span class="n">group_autorun</span><span class="o">.</span><span class="n">id</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestGroupRenamingMigration.test_group_string_update"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestGroupRenamingMigration.test_group_string_update">[docs]</a>    <span class="k">def</span> <span class="nf">test_group_string_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that the type strings are properly migrated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">DbGroup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_table</span><span class="p">(</span><span class="s1">&#39;db_dbgroup&#39;</span><span class="p">)</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># test user group type_string: &#39;&#39; -&gt; &#39;user&#39;</span>
                <span class="n">group_user</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbGroup</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbGroup</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_user_pk</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">group_user</span><span class="o">.</span><span class="n">type_string</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>

                <span class="c1"># test data.upf group type_string: &#39;data.upf.family&#39; -&gt; &#39;data.upf&#39;</span>
                <span class="n">group_data_upf</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbGroup</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbGroup</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_data_upf_pk</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">group_data_upf</span><span class="o">.</span><span class="n">type_string</span><span class="p">,</span> <span class="s1">&#39;data.upf&#39;</span><span class="p">)</span>

                <span class="c1"># test auto.import group type_string: &#39;aiida.import&#39; -&gt; &#39;auto.import&#39;</span>
                <span class="n">group_autoimport</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbGroup</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbGroup</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_autoimport_pk</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">group_autoimport</span><span class="o">.</span><span class="n">type_string</span><span class="p">,</span> <span class="s1">&#39;auto.import&#39;</span><span class="p">)</span>

                <span class="c1"># test auto.run group type_string: &#39;autogroup.run&#39; -&gt; &#39;auto.run&#39;</span>
                <span class="n">group_autorun</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbGroup</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbGroup</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_autorun_pk</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">group_autorun</span><span class="o">.</span><span class="n">type_string</span><span class="p">,</span> <span class="s1">&#39;auto.run&#39;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="TestCalcAttributeKeysMigration"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestCalcAttributeKeysMigration">[docs]</a><span class="k">class</span> <span class="nc">TestCalcAttributeKeysMigration</span><span class="p">(</span><span class="n">TestMigrationsSQLA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test the migration of the keys of certain attribute for ProcessNodes and CalcJobNodes.&quot;&quot;&quot;</span>

    <span class="n">migrate_from</span> <span class="o">=</span> <span class="s1">&#39;e72ad251bcdb&#39;</span>  <span class="c1"># e72ad251bcdb_dbgroup_class_change_type_string_values</span>
    <span class="n">migrate_to</span> <span class="o">=</span> <span class="s1">&#39;7ca08c391c49&#39;</span>  <span class="c1"># 7ca08c391c49_calc_job_option_attribute_keys</span>

    <span class="n">KEY_RESOURCES_OLD</span> <span class="o">=</span> <span class="s1">&#39;jobresource_params&#39;</span>
    <span class="n">KEY_RESOURCES_NEW</span> <span class="o">=</span> <span class="s1">&#39;resources&#39;</span>
    <span class="n">KEY_PARSER_NAME_OLD</span> <span class="o">=</span> <span class="s1">&#39;parser&#39;</span>
    <span class="n">KEY_PARSER_NAME_NEW</span> <span class="o">=</span> <span class="s1">&#39;parser_name&#39;</span>
    <span class="n">KEY_PROCESS_LABEL_OLD</span> <span class="o">=</span> <span class="s1">&#39;_process_label&#39;</span>
    <span class="n">KEY_PROCESS_LABEL_NEW</span> <span class="o">=</span> <span class="s1">&#39;process_label&#39;</span>
    <span class="n">KEY_ENVIRONMENT_VARIABLES_OLD</span> <span class="o">=</span> <span class="s1">&#39;custom_environment_variables&#39;</span>
    <span class="n">KEY_ENVIRONMENT_VARIABLES_NEW</span> <span class="o">=</span> <span class="s1">&#39;environment_variables&#39;</span>

<div class="viewcode-block" id="TestCalcAttributeKeysMigration.setUpBeforeMigration"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestCalcAttributeKeysMigration.setUpBeforeMigration">[docs]</a>    <span class="k">def</span> <span class="nf">setUpBeforeMigration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="n">DbNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbnode</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">DbUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbuser</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

                <span class="n">user</span> <span class="o">=</span> <span class="n">DbUser</span><span class="p">(</span><span class="n">is_superuser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">@aiida.net&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">()))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">resources</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;number_machines&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parser_name</span> <span class="o">=</span> <span class="s1">&#39;aiida.parsers:parser&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_label</span> <span class="o">=</span> <span class="s1">&#39;TestLabel&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">environment_variables</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">KEY_RESOURCES_OLD</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">KEY_PARSER_NAME_OLD</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser_name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">KEY_PROCESS_LABEL_OLD</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_label</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">KEY_ENVIRONMENT_VARIABLES_OLD</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_variables</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">node_work</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;node.process.workflow.WorkflowNode.&#39;</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="n">attributes</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">node_calc</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;node.process.calculation.calcjob.CalcJobNode.&#39;</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="n">attributes</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="c1"># Create a node of a different type to ensure that its attributes are not updated</span>
                <span class="n">node_other</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;node.othernode.&#39;</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="n">attributes</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node_work</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node_calc</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node_other</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">node_work_id</span> <span class="o">=</span> <span class="n">node_work</span><span class="o">.</span><span class="n">id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node_calc_id</span> <span class="o">=</span> <span class="n">node_calc</span><span class="o">.</span><span class="n">id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node_other_id</span> <span class="o">=</span> <span class="n">node_other</span><span class="o">.</span><span class="n">id</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestCalcAttributeKeysMigration.test_attribute_key_changes"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestCalcAttributeKeysMigration.test_attribute_key_changes">[docs]</a>    <span class="k">def</span> <span class="nf">test_attribute_key_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify that the keys are successfully changed of the affected attributes.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="n">DbNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbnode</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="n">not_found</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

                <span class="n">node_work</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbNode</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbNode</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_work_id</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_work</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_PROCESS_LABEL_NEW</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_label</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_work</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_PROCESS_LABEL_OLD</span><span class="p">,</span> <span class="n">not_found</span><span class="p">),</span> <span class="n">not_found</span><span class="p">)</span>

                <span class="n">node_calc</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbNode</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbNode</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_calc_id</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_calc</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_PROCESS_LABEL_NEW</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_label</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_calc</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_PARSER_NAME_NEW</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_calc</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_RESOURCES_NEW</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                    <span class="n">node_calc</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_ENVIRONMENT_VARIABLES_NEW</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_variables</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_calc</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_PROCESS_LABEL_OLD</span><span class="p">,</span> <span class="n">not_found</span><span class="p">),</span> <span class="n">not_found</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_calc</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_PARSER_NAME_OLD</span><span class="p">,</span> <span class="n">not_found</span><span class="p">),</span> <span class="n">not_found</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_calc</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_RESOURCES_OLD</span><span class="p">,</span> <span class="n">not_found</span><span class="p">),</span> <span class="n">not_found</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_calc</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_ENVIRONMENT_VARIABLES_OLD</span><span class="p">,</span> <span class="n">not_found</span><span class="p">),</span> <span class="n">not_found</span><span class="p">)</span>

                <span class="c1"># The following node should not be migrated even if its attributes have the matching keys because</span>
                <span class="c1"># the node is not a ProcessNode</span>
                <span class="n">node_other</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbNode</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbNode</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_other_id</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_other</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_PROCESS_LABEL_OLD</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_label</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_other</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_PARSER_NAME_OLD</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_other</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_RESOURCES_OLD</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                    <span class="n">node_other</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_ENVIRONMENT_VARIABLES_OLD</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_variables</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_other</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_PROCESS_LABEL_NEW</span><span class="p">,</span> <span class="n">not_found</span><span class="p">),</span> <span class="n">not_found</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_other</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_PARSER_NAME_NEW</span><span class="p">,</span> <span class="n">not_found</span><span class="p">),</span> <span class="n">not_found</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_other</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_RESOURCES_NEW</span><span class="p">,</span> <span class="n">not_found</span><span class="p">),</span> <span class="n">not_found</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_other</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_ENVIRONMENT_VARIABLES_NEW</span><span class="p">,</span> <span class="n">not_found</span><span class="p">),</span> <span class="n">not_found</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="TestDbLogMigrationRecordCleaning"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestDbLogMigrationRecordCleaning">[docs]</a><span class="k">class</span> <span class="nc">TestDbLogMigrationRecordCleaning</span><span class="p">(</span><span class="n">TestMigrationsSQLA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test the migration of the keys of certain attribute for ProcessNodes and CalcJobNodes.&quot;&quot;&quot;</span>

    <span class="n">migrate_from</span> <span class="o">=</span> <span class="s1">&#39;7ca08c391c49&#39;</span>  <span class="c1"># 7ca08c391c49_calc_job_option_attribute_keys</span>
    <span class="n">migrate_to</span> <span class="o">=</span> <span class="s1">&#39;041a79fc615f&#39;</span>  <span class="c1"># 041a79fc615f_dblog_cleaning</span>

<div class="viewcode-block" id="TestDbLogMigrationRecordCleaning.tearDown"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestDbLogMigrationRecordCleaning.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Need to manually delete all the workflows created for the test because the model does not exist any more.</span>

<span class="sd">        Because the model does not exist anymore, they are no longer being cleaned in the database reset of the test</span>
<span class="sd">        base class. To prevent foreign keys from other tables still referencing these tables, we have to make sure to</span>
<span class="sd">        clean them here manually, before we call the parent, which will call the standard reset database methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="n">DbWorkflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbworkflow</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbWorkflow</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">TestDbLogMigrationRecordCleaning</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestDbLogMigrationRecordCleaning.setUpBeforeMigration"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestDbLogMigrationRecordCleaning.setUpBeforeMigration">[docs]</a>    <span class="k">def</span> <span class="nf">setUpBeforeMigration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># pylint: disable=too-many-locals,too-many-statements</span>
        <span class="kn">import</span> <span class="nn">importlib</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>
        <span class="kn">from</span> <span class="nn">aiida.backends.sqlalchemy.utils</span> <span class="k">import</span> <span class="n">dumps_json</span>

        <span class="n">log_migration</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span>
            <span class="s1">&#39;aiida.backends.sqlalchemy.migrations.versions.041a79fc615f_dblog_cleaning&#39;</span><span class="p">)</span>

        <span class="n">DbUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbuser</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">DbNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbnode</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">DbWorkflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbworkflow</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">DbLog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dblog</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

                <span class="n">user</span> <span class="o">=</span> <span class="n">DbUser</span><span class="p">(</span><span class="n">is_superuser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">@aiida.net&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">()))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="n">calc_1</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;node.process.calculation.CalculationNode.&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">param</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;data.dict.Dict.&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">leg_workf</span> <span class="o">=</span> <span class="n">DbWorkflow</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Legacy WorkflowNode&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">calc_2</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;node.process.calculation.CalculationNode.&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">calc_1</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">leg_workf</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">calc_2</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="n">log_1</span> <span class="o">=</span> <span class="n">DbLog</span><span class="p">(</span>
                    <span class="n">loggername</span><span class="o">=</span><span class="s1">&#39;CalculationNode logger&#39;</span><span class="p">,</span>
                    <span class="n">objpk</span><span class="o">=</span><span class="n">calc_1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">objname</span><span class="o">=</span><span class="s1">&#39;node.calculation.job.quantumespresso.pw.&#39;</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s1">&#39;calculation node 1&#39;</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;msecs&quot;</span><span class="p">:</span> <span class="mf">719.0849781036377</span><span class="p">,</span>
                        <span class="s2">&quot;objpk&quot;</span><span class="p">:</span> <span class="n">calc_1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="s2">&quot;lineno&quot;</span><span class="p">:</span> <span class="mi">350</span><span class="p">,</span>
                        <span class="s2">&quot;thread&quot;</span><span class="p">:</span> <span class="mi">140011612940032</span><span class="p">,</span>
                        <span class="s2">&quot;asctime&quot;</span><span class="p">:</span> <span class="s2">&quot;10/21/2018 12:39:51 PM&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="mf">1540118391.719085</span><span class="p">,</span>
                        <span class="s2">&quot;levelno&quot;</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;calculation node 1&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;objname&quot;</span><span class="p">:</span> <span class="s2">&quot;node.calculation.job.quantumespresso.pw.&quot;</span><span class="p">,</span>
                    <span class="p">})</span>
                <span class="n">log_2</span> <span class="o">=</span> <span class="n">DbLog</span><span class="p">(</span>
                    <span class="n">loggername</span><span class="o">=</span><span class="s1">&#39;something.else logger&#39;</span><span class="p">,</span>
                    <span class="n">objpk</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">objname</span><span class="o">=</span><span class="s1">&#39;something.else.&#39;</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s1">&#39;parameter data with log message&#39;</span><span class="p">)</span>
                <span class="n">log_3</span> <span class="o">=</span> <span class="n">DbLog</span><span class="p">(</span>
                    <span class="n">loggername</span><span class="o">=</span><span class="s1">&#39;TopologicalWorkflow logger&#39;</span><span class="p">,</span>
                    <span class="n">objpk</span><span class="o">=</span><span class="n">leg_workf</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">objname</span><span class="o">=</span><span class="s1">&#39;aiida.workflows.user.topologicalworkflows.topo.TopologicalWorkflow&#39;</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s1">&#39;parameter data with log message&#39;</span><span class="p">)</span>
                <span class="n">log_4</span> <span class="o">=</span> <span class="n">DbLog</span><span class="p">(</span>
                    <span class="n">loggername</span><span class="o">=</span><span class="s1">&#39;CalculationNode logger&#39;</span><span class="p">,</span>
                    <span class="n">objpk</span><span class="o">=</span><span class="n">calc_2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">objname</span><span class="o">=</span><span class="s1">&#39;node.calculation.job.quantumespresso.pw.&#39;</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s1">&#39;calculation node 2&#39;</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;msecs&quot;</span><span class="p">:</span> <span class="mf">719.0849781036377</span><span class="p">,</span>
                        <span class="s2">&quot;objpk&quot;</span><span class="p">:</span> <span class="n">calc_2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="s2">&quot;lineno&quot;</span><span class="p">:</span> <span class="mi">360</span><span class="p">,</span>
                        <span class="s2">&quot;levelno&quot;</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;calculation node 1&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;objname&quot;</span><span class="p">:</span> <span class="s2">&quot;node.calculation.job.quantumespresso.pw.&quot;</span><span class="p">,</span>
                    <span class="p">})</span>
                <span class="c1"># Creating two more log records that don&#39;t correspond to a node</span>
                <span class="n">log_5</span> <span class="o">=</span> <span class="n">DbLog</span><span class="p">(</span>
                    <span class="n">loggername</span><span class="o">=</span><span class="s1">&#39;CalculationNode logger&#39;</span><span class="p">,</span>
                    <span class="n">objpk</span><span class="o">=</span><span class="p">(</span><span class="n">calc_2</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">),</span>
                    <span class="n">objname</span><span class="o">=</span><span class="s1">&#39;node.calculation.job.quantumespresso.pw.&#39;</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s1">&#39;calculation node 1000&#39;</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;msecs&quot;</span><span class="p">:</span> <span class="mi">718</span><span class="p">,</span>
                        <span class="s2">&quot;objpk&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">calc_2</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">),</span>
                        <span class="s2">&quot;lineno&quot;</span><span class="p">:</span> <span class="mi">361</span><span class="p">,</span>
                        <span class="s2">&quot;levelno&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;calculation node 1000&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;objname&quot;</span><span class="p">:</span> <span class="s2">&quot;node.calculation.job.quantumespresso.pw.&quot;</span><span class="p">,</span>
                    <span class="p">})</span>
                <span class="n">log_6</span> <span class="o">=</span> <span class="n">DbLog</span><span class="p">(</span>
                    <span class="n">loggername</span><span class="o">=</span><span class="s1">&#39;CalculationNode logger&#39;</span><span class="p">,</span>
                    <span class="n">objpk</span><span class="o">=</span><span class="p">(</span><span class="n">calc_2</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1001</span><span class="p">),</span>
                    <span class="n">objname</span><span class="o">=</span><span class="s1">&#39;node.calculation.job.quantumespresso.pw.&#39;</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s1">&#39;calculation node 10001&#39;</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;msecs&quot;</span><span class="p">:</span> <span class="mi">722</span><span class="p">,</span>
                        <span class="s2">&quot;objpk&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">calc_2</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1001</span><span class="p">),</span>
                        <span class="s2">&quot;lineno&quot;</span><span class="p">:</span> <span class="mi">362</span><span class="p">,</span>
                        <span class="s2">&quot;levelno&quot;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;calculation node 1001&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;objname&quot;</span><span class="p">:</span> <span class="s2">&quot;node.calculation.job.quantumespresso.pw.&quot;</span><span class="p">,</span>
                    <span class="p">})</span>

                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">log_1</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">log_2</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">log_3</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">log_4</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">log_5</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">log_6</span><span class="p">)</span>

                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="c1"># Storing temporarily information needed for the check at the test</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">to_check</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="c1"># Keeping calculation &amp; calculation log ids</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">[</span><span class="s1">&#39;CalculationNode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">calc_1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">log_1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">calc_2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">log_4</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># The columns to project</span>
                <span class="n">cols_to_project</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">log_migration</span><span class="o">.</span><span class="n">values_to_export</span><span class="p">:</span>
                    <span class="n">cols_to_project</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">DbLog</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

                <span class="c1"># Getting the serialized Dict logs</span>
                <span class="n">param_data</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbLog</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbLog</span><span class="o">.</span><span class="n">objpk</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">DbLog</span><span class="o">.</span><span class="n">objname</span> <span class="o">==</span> <span class="s1">&#39;something.else.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="o">*</span><span class="n">cols_to_project</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="n">serialized_param_data</span> <span class="o">=</span> <span class="n">dumps_json</span><span class="p">([(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">param_data</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">param_data</span><span class="p">))))])</span>
                <span class="c1"># Getting the serialized logs for the unknown entity logs (as the export migration fuction</span>
                <span class="c1"># provides them) - this should coincide to the above</span>
                <span class="n">serialized_unknown_exp_logs</span> <span class="o">=</span> <span class="n">log_migration</span><span class="o">.</span><span class="n">get_serialized_unknown_entity_logs</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                <span class="c1"># Getting their number</span>
                <span class="n">unknown_exp_logs_number</span> <span class="o">=</span> <span class="n">log_migration</span><span class="o">.</span><span class="n">get_unknown_entity_log_number</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">[</span><span class="s1">&#39;Dict&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">serialized_param_data</span><span class="p">,</span> <span class="n">serialized_unknown_exp_logs</span><span class="p">,</span> <span class="n">unknown_exp_logs_number</span><span class="p">)</span>

                <span class="c1"># Getting the serialized legacy workflow logs</span>
                <span class="c1"># yapf: disable</span>
                <span class="n">leg_wf</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbLog</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbLog</span><span class="o">.</span><span class="n">objpk</span> <span class="o">==</span> <span class="n">leg_workf</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">DbLog</span><span class="o">.</span><span class="n">objname</span> <span class="o">==</span> <span class="s1">&#39;aiida.workflows.user.topologicalworkflows.topo.TopologicalWorkflow&#39;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="o">*</span><span class="n">cols_to_project</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="n">serialized_leg_wf_logs</span> <span class="o">=</span> <span class="n">dumps_json</span><span class="p">([(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">leg_wf</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">leg_wf</span><span class="p">))))])</span>
                <span class="c1"># Getting the serialized logs for the legacy workflow logs (as the export migration function</span>
                <span class="c1"># provides them) - this should coincide to the above</span>
                <span class="n">serialized_leg_wf_exp_logs</span> <span class="o">=</span> <span class="n">log_migration</span><span class="o">.</span><span class="n">get_serialized_legacy_workflow_logs</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                <span class="n">eg_wf_exp_logs_number</span> <span class="o">=</span> <span class="n">log_migration</span><span class="o">.</span><span class="n">get_legacy_workflow_log_number</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">[</span><span class="s1">&#39;WorkflowNode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">serialized_leg_wf_logs</span><span class="p">,</span> <span class="n">serialized_leg_wf_exp_logs</span><span class="p">,</span>
                                                 <span class="n">eg_wf_exp_logs_number</span><span class="p">)</span>

                <span class="c1"># Getting the serialized logs that don&#39;t correspond to a DbNode record</span>
                <span class="n">logs_no_node</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbLog</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">DbLog</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="n">log_5</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">log_6</span><span class="o">.</span><span class="n">id</span><span class="p">]))</span><span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="o">*</span><span class="n">cols_to_project</span><span class="p">)</span>
                <span class="n">logs_no_node_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">log_no_node</span> <span class="ow">in</span> <span class="n">logs_no_node</span><span class="p">:</span>
                    <span class="n">logs_no_node_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">log_no_node</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">log_no_node</span><span class="p">)))))</span>
                <span class="n">serialized_logs_no_node</span> <span class="o">=</span> <span class="n">dumps_json</span><span class="p">(</span><span class="n">logs_no_node_list</span><span class="p">)</span>

                <span class="c1"># Getting the serialized logs that don&#39;t correspond to a node (as the export migration function</span>
                <span class="c1"># provides them) - this should coincide to the above</span>
                <span class="n">serialized_logs_exp_no_node</span> <span class="o">=</span> <span class="n">log_migration</span><span class="o">.</span><span class="n">get_serialized_logs_with_no_nodes</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                <span class="n">logs_no_node_number</span> <span class="o">=</span> <span class="n">log_migration</span><span class="o">.</span><span class="n">get_logs_with_no_nodes_number</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">[</span><span class="s1">&#39;NoNode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">serialized_logs_no_node</span><span class="p">,</span> <span class="n">serialized_logs_exp_no_node</span><span class="p">,</span> <span class="n">logs_no_node_number</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="TestDbLogMigrationRecordCleaning.test_dblog_calculation_node"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestDbLogMigrationRecordCleaning.test_dblog_calculation_node">[docs]</a>    <span class="k">def</span> <span class="nf">test_dblog_calculation_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that after the migration there is only two log records left and verify that they corresponds to</span>
<span class="sd">        the CalculationNodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="n">DbLog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dblog</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

                <span class="c1"># Check that only two log records exist</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbLog</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;There should be two log records left&quot;</span><span class="p">)</span>

                <span class="c1"># Get the node id of the log record referencing the node and verify that it is the correct one</span>
                <span class="n">dbnode_id_1</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbLog</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">DbLog</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">[</span><span class="s1">&#39;CalculationNode&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="s1">&#39;dbnode_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dbnode_id_1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">[</span><span class="s1">&#39;CalculationNode&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;The the referenced node is not &quot;</span>
                                 <span class="s2">&quot;the expected one&quot;</span><span class="p">)</span>
                <span class="n">dbnode_id_2</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbLog</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">DbLog</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">[</span><span class="s1">&#39;CalculationNode&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="s1">&#39;dbnode_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dbnode_id_2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">[</span><span class="s1">&#39;CalculationNode&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;The the referenced node is not &quot;</span>
                                 <span class="s2">&quot;the expected one&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestDbLogMigrationRecordCleaning.test_dblog_correct_export_of_logs"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestDbLogMigrationRecordCleaning.test_dblog_correct_export_of_logs">[docs]</a>    <span class="k">def</span> <span class="nf">test_dblog_correct_export_of_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that export log methods for legacy workflows, unknown entities and log records that</span>
<span class="sd">        don&#39;t correspond to nodes, work as expected</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">json</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">[</span><span class="s1">&#39;Dict&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">[</span><span class="s1">&#39;Dict&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">[</span><span class="s1">&#39;Dict&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">[</span><span class="s1">&#39;WorkflowNode&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">[</span><span class="s1">&#39;WorkflowNode&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">[</span><span class="s1">&#39;WorkflowNode&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">[</span><span class="s1">&#39;NoNode&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]),</span>
                          <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">[</span><span class="s1">&#39;NoNode&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">[</span><span class="s1">&#39;NoNode&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestDbLogMigrationRecordCleaning.test_metadata_correctness"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestDbLogMigrationRecordCleaning.test_metadata_correctness">[docs]</a>    <span class="k">def</span> <span class="nf">test_metadata_correctness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that the metadata of the remaining records don&#39;t have an objpk and objmetadata values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="n">DbLog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dblog</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbLog</span><span class="p">)</span><span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">DbLog</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
                <span class="c1"># Verify that the objpk and objname are no longer part of the metadata</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">m_res</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;objpk&#39;</span><span class="p">,</span> <span class="n">m_res</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="s2">&quot;objpk should not exist any more in metadata&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;objname&#39;</span><span class="p">,</span> <span class="n">m_res</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="s2">&quot;objname should not exist any more in metadata&quot;</span><span class="p">)</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="TestDbLogMigrationBackward"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestDbLogMigrationBackward">[docs]</a><span class="k">class</span> <span class="nc">TestDbLogMigrationBackward</span><span class="p">(</span><span class="n">TestBackwardMigrationsSQLA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that backward migrations work also for the DbLog migration(s).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">migrate_from</span> <span class="o">=</span> <span class="s1">&#39;041a79fc615f&#39;</span>  <span class="c1"># 041a79fc615f_dblog_cleaning</span>
    <span class="n">migrate_to</span> <span class="o">=</span> <span class="s1">&#39;7ca08c391c49&#39;</span>  <span class="c1"># e72ad251bcdb_dbgroup_class_change_type_string_values</span>

<div class="viewcode-block" id="TestDbLogMigrationBackward.setUpBeforeMigration"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestDbLogMigrationBackward.setUpBeforeMigration">[docs]</a>    <span class="k">def</span> <span class="nf">setUpBeforeMigration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># pylint: disable=too-many-locals,too-many-statements</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="n">DbUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbuser</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">DbNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbnode</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">DbLog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dblog</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

                <span class="n">user</span> <span class="o">=</span> <span class="n">DbUser</span><span class="p">(</span><span class="n">is_superuser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">@aiida.net&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">()))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="n">calc_1</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;node.process.calculation.CalculationNode.1&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">calc_2</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;node.process.calculation.CalculationNode.2&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">calc_1</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">calc_2</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="n">log_1</span> <span class="o">=</span> <span class="n">DbLog</span><span class="p">(</span>
                    <span class="n">loggername</span><span class="o">=</span><span class="s1">&#39;CalculationNode logger&#39;</span><span class="p">,</span>
                    <span class="n">dbnode_id</span><span class="o">=</span><span class="n">calc_1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s1">&#39;calculation node 1&#39;</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;msecs&quot;</span><span class="p">:</span> <span class="mf">719.0849781036377</span><span class="p">,</span>
                        <span class="s2">&quot;lineno&quot;</span><span class="p">:</span> <span class="mi">350</span><span class="p">,</span>
                        <span class="s2">&quot;thread&quot;</span><span class="p">:</span> <span class="mi">140011612940032</span><span class="p">,</span>
                        <span class="s2">&quot;asctime&quot;</span><span class="p">:</span> <span class="s2">&quot;10/21/2018 12:39:51 PM&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="mf">1540118391.719085</span><span class="p">,</span>
                        <span class="s2">&quot;levelno&quot;</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;calculation node 1&quot;</span><span class="p">,</span>
                    <span class="p">})</span>
                <span class="n">log_2</span> <span class="o">=</span> <span class="n">DbLog</span><span class="p">(</span>
                    <span class="n">loggername</span><span class="o">=</span><span class="s1">&#39;CalculationNode logger&#39;</span><span class="p">,</span>
                    <span class="n">dbnode_id</span><span class="o">=</span><span class="n">calc_2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s1">&#39;calculation node 2&#39;</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;msecs&quot;</span><span class="p">:</span> <span class="mf">719.0849781036377</span><span class="p">,</span>
                        <span class="s2">&quot;lineno&quot;</span><span class="p">:</span> <span class="mi">360</span><span class="p">,</span>
                        <span class="s2">&quot;levelno&quot;</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;calculation node 1&quot;</span><span class="p">,</span>
                    <span class="p">})</span>

                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">log_1</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">log_2</span><span class="p">)</span>

                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="c1"># Keeping what is needed to be verified at the test</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">to_check</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">[</span><span class="n">log_1</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">log_1</span><span class="o">.</span><span class="n">dbnode_id</span><span class="p">,</span> <span class="n">calc_1</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">[</span><span class="n">log_2</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">log_2</span><span class="o">.</span><span class="n">dbnode_id</span><span class="p">,</span> <span class="n">calc_2</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestDbLogMigrationBackward.test_objpk_objname"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestDbLogMigrationBackward.test_objpk_objname">[docs]</a>    <span class="k">def</span> <span class="nf">test_objpk_objname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This test verifies that the objpk and objname have the right values</span>
<span class="sd">        after a forward and a backward migration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="n">DbLog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dblog</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">log_pk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">:</span>
                    <span class="n">log_entry</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbLog</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbLog</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">log_pk</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                    <span class="n">log_dbnode_id</span><span class="p">,</span> <span class="n">node_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_check</span><span class="p">[</span><span class="n">log_pk</span><span class="p">]</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                        <span class="n">log_dbnode_id</span><span class="p">,</span> <span class="n">log_entry</span><span class="o">.</span><span class="n">objpk</span><span class="p">,</span>
                        <span class="s2">&quot;The dbnode_id (</span><span class="si">{}</span><span class="s2">) of the 0024 schema version should be identical to the objpk (</span><span class="si">{}</span><span class="s2">) of &quot;</span>
                        <span class="s2">&quot;the 0023 schema version.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_dbnode_id</span><span class="p">,</span> <span class="n">log_entry</span><span class="o">.</span><span class="n">objpk</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                        <span class="n">node_type</span><span class="p">,</span> <span class="n">log_entry</span><span class="o">.</span><span class="n">objname</span><span class="p">,</span>
                        <span class="s2">&quot;The type (</span><span class="si">{}</span><span class="s2">) of the linked node of the 0024 schema version should be identical to the &quot;</span>
                        <span class="s2">&quot;objname (</span><span class="si">{}</span><span class="s2">) of the 0023 schema version.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_type</span><span class="p">,</span> <span class="n">log_entry</span><span class="o">.</span><span class="n">objname</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                        <span class="n">log_dbnode_id</span><span class="p">,</span> <span class="n">log_entry</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;objpk&#39;</span><span class="p">],</span>
                        <span class="s2">&quot;The dbnode_id (</span><span class="si">{}</span><span class="s2">) of the 0024 schema version should be identical to the objpk (</span><span class="si">{}</span><span class="s2">) of &quot;</span>
                        <span class="s2">&quot;the 0023 schema version stored in the metadata.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_dbnode_id</span><span class="p">,</span>
                                                                                 <span class="n">log_entry</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;objpk&#39;</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                        <span class="n">node_type</span><span class="p">,</span> <span class="n">log_entry</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;objname&#39;</span><span class="p">],</span>
                        <span class="s2">&quot;The type (</span><span class="si">{}</span><span class="s2">) of the linked node of the 0024 schema version should be identical to the &quot;</span>
                        <span class="s2">&quot;objname (</span><span class="si">{}</span><span class="s2">) of the 0023 schema version stored in the metadata.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">node_type</span><span class="p">,</span> <span class="n">log_entry</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;objname&#39;</span><span class="p">]))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="TestDbLogUUIDAddition"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestDbLogUUIDAddition">[docs]</a><span class="k">class</span> <span class="nc">TestDbLogUUIDAddition</span><span class="p">(</span><span class="n">TestMigrationsSQLA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that the UUID column is correctly added to the DbLog table and that the uniqueness</span>
<span class="sd">    constraint is added without problems (if the migration arrives until 375c2db70663 then the</span>
<span class="sd">    constraint is added properly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">migrate_from</span> <span class="o">=</span> <span class="s1">&#39;041a79fc615f&#39;</span>  <span class="c1"># 041a79fc615f_dblog_cleaning</span>
    <span class="n">migrate_to</span> <span class="o">=</span> <span class="s1">&#39;375c2db70663&#39;</span>  <span class="c1"># 375c2db70663_dblog_uuid_uniqueness_constraint</span>

<div class="viewcode-block" id="TestDbLogUUIDAddition.setUpBeforeMigration"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestDbLogUUIDAddition.setUpBeforeMigration">[docs]</a>    <span class="k">def</span> <span class="nf">setUpBeforeMigration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="n">DbUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbuser</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">DbNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbnode</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">DbLog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dblog</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

                <span class="n">user</span> <span class="o">=</span> <span class="n">DbUser</span><span class="p">(</span><span class="n">is_superuser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">@aiida.net&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">()))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="n">calc_1</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;node.process.calculation.CalculationNode.&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">calc_2</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;node.process.calculation.CalculationNode.&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">calc_1</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">calc_2</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="n">log_1</span> <span class="o">=</span> <span class="n">DbLog</span><span class="p">(</span><span class="n">loggername</span><span class="o">=</span><span class="s1">&#39;CalculationNode logger&#39;</span><span class="p">,</span> <span class="n">dbnode_id</span><span class="o">=</span><span class="n">calc_1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;calculation node 1&#39;</span><span class="p">)</span>
                <span class="n">log_2</span> <span class="o">=</span> <span class="n">DbLog</span><span class="p">(</span><span class="n">loggername</span><span class="o">=</span><span class="s1">&#39;CalculationNode logger&#39;</span><span class="p">,</span> <span class="n">dbnode_id</span><span class="o">=</span><span class="n">calc_2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;calculation node 2&#39;</span><span class="p">)</span>

                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">log_1</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">log_2</span><span class="p">)</span>

                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestDbLogUUIDAddition.test_dblog_unique_uuids"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestDbLogUUIDAddition.test_dblog_unique_uuids">[docs]</a>    <span class="k">def</span> <span class="nf">test_dblog_unique_uuids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that the UUIDs of the log records are unique</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="n">DbLog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dblog</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
                <span class="n">l_uuids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbLog</span><span class="p">)</span><span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">DbLog</span><span class="p">,</span> <span class="s1">&#39;uuid&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
                <span class="n">s_uuids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">l_uuids</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l_uuids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">s_uuids</span><span class="p">),</span> <span class="s2">&quot;The UUIDs are not all unique.&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="TestDataMoveWithinNodeMigration"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestDataMoveWithinNodeMigration">[docs]</a><span class="k">class</span> <span class="nc">TestDataMoveWithinNodeMigration</span><span class="p">(</span><span class="n">TestMigrationsSQLA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test the migration of Data nodes after the data module was moved within the node moduel.&quot;&quot;&quot;</span>

    <span class="n">migrate_from</span> <span class="o">=</span> <span class="s1">&#39;041a79fc615f&#39;</span>  <span class="c1"># 041a79fc615f_dblog_update</span>
    <span class="n">migrate_to</span> <span class="o">=</span> <span class="s1">&#39;6a5c2ea1439d&#39;</span>  <span class="c1"># 6a5c2ea1439d_move_data_within_node_module</span>

<div class="viewcode-block" id="TestDataMoveWithinNodeMigration.setUpBeforeMigration"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestDataMoveWithinNodeMigration.setUpBeforeMigration">[docs]</a>    <span class="k">def</span> <span class="nf">setUpBeforeMigration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="n">DbNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbnode</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">DbUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbuser</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

                <span class="n">user</span> <span class="o">=</span> <span class="n">DbUser</span><span class="p">(</span><span class="n">is_superuser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">@aiida.net&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">()))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="n">node_calc</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;node.process.calculation.calcjob.CalcJobNode.&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">node_data</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;data.int.Int.&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node_data</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node_calc</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">node_calc_id</span> <span class="o">=</span> <span class="n">node_calc</span><span class="o">.</span><span class="n">id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node_data_id</span> <span class="o">=</span> <span class="n">node_data</span><span class="o">.</span><span class="n">id</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestDataMoveWithinNodeMigration.test_data_node_type_string"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestDataMoveWithinNodeMigration.test_data_node_type_string">[docs]</a>    <span class="k">def</span> <span class="nf">test_data_node_type_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify that type string of the Data node was successfully adapted.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="n">DbNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbnode</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

                <span class="c1"># The data node should have been touched and migrated</span>
                <span class="n">node_data</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbNode</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbNode</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_data_id</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_data</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;node.data.int.Int.&#39;</span><span class="p">)</span>

                <span class="c1"># The calc node by contrast should not have been changed</span>
                <span class="n">node_calc</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbNode</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbNode</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_calc_id</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_calc</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;node.process.calculation.calcjob.CalcJobNode.&#39;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="TestTrajectoryDataMigration"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestTrajectoryDataMigration">[docs]</a><span class="k">class</span> <span class="nc">TestTrajectoryDataMigration</span><span class="p">(</span><span class="n">TestMigrationsSQLA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test the migration of the symbols from numpy array to attribute for TrajectoryData nodes.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span>

    <span class="n">migrate_from</span> <span class="o">=</span> <span class="s1">&#39;37f3d4882837&#39;</span>  <span class="c1"># 37f3d4882837_make_all_uuid_columns_unique</span>
    <span class="n">migrate_to</span> <span class="o">=</span> <span class="s1">&#39;ce56d84bcc35&#39;</span>  <span class="c1"># ce56d84bcc35_delete_trajectory_symbols_array</span>

    <span class="n">stepids</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">60</span><span class="p">,</span> <span class="mi">70</span><span class="p">])</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">stepids</span> <span class="o">*</span> <span class="mf">0.01</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[[[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]]])</span>
    <span class="n">velocities</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[[[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">]]])</span>
    <span class="n">cells</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">3.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">]]])</span>

<div class="viewcode-block" id="TestTrajectoryDataMigration.setUpBeforeMigration"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestTrajectoryDataMigration.setUpBeforeMigration">[docs]</a>    <span class="k">def</span> <span class="nf">setUpBeforeMigration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numpy</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="n">DbNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbnode</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">DbUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbuser</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

                <span class="n">user</span> <span class="o">=</span> <span class="n">DbUser</span><span class="p">(</span><span class="n">is_superuser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">@aiida.net&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">()))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="n">node</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;node.data.array.trajectory.TrajectoryData.&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="n">symbols</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">set_node_array</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepids</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_node_array</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;cells&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_node_array</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;symbols&#39;</span><span class="p">,</span> <span class="n">symbols</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_node_array</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;positions&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_node_array</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;times&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_node_array</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;velocities&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocities</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">node_uuid</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestTrajectoryDataMigration.test_trajectory_symbols"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestTrajectoryDataMigration.test_trajectory_symbols">[docs]</a>    <span class="k">def</span> <span class="nf">test_trajectory_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify that migration of symbols from repository array to attribute works properly.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="n">DbNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbnode</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

                <span class="n">node</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbNode</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbNode</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_uuid</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">assertSequenceEqual</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertSequenceEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_node_array</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;velocities&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocities</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertSequenceEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_node_array</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;positions&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">IOError</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_node_array</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;symbols&#39;</span><span class="p">)</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="TestNodePrefixRemovalMigration"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestNodePrefixRemovalMigration">[docs]</a><span class="k">class</span> <span class="nc">TestNodePrefixRemovalMigration</span><span class="p">(</span><span class="n">TestMigrationsSQLA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test the migration of Data nodes after the data module was moved within the node moduel.&quot;&quot;&quot;</span>

    <span class="n">migrate_from</span> <span class="o">=</span> <span class="s1">&#39;ce56d84bcc35&#39;</span>  <span class="c1"># ce56d84bcc35_delete_trajectory_symbols_array</span>
    <span class="n">migrate_to</span> <span class="o">=</span> <span class="s1">&#39;61fc0913fae9&#39;</span>  <span class="c1"># 61fc0913fae9_remove_node_prefix</span>

<div class="viewcode-block" id="TestNodePrefixRemovalMigration.setUpBeforeMigration"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestNodePrefixRemovalMigration.setUpBeforeMigration">[docs]</a>    <span class="k">def</span> <span class="nf">setUpBeforeMigration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="n">DbNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbnode</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">DbUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbuser</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

                <span class="n">user</span> <span class="o">=</span> <span class="n">DbUser</span><span class="p">(</span><span class="n">is_superuser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">@aiida.net&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">()))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="n">node_calc</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;node.process.calculation.calcjob.CalcJobNode.&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">node_data</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;node.data.int.Int.&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node_data</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node_calc</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">node_calc_id</span> <span class="o">=</span> <span class="n">node_calc</span><span class="o">.</span><span class="n">id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node_data_id</span> <span class="o">=</span> <span class="n">node_data</span><span class="o">.</span><span class="n">id</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestNodePrefixRemovalMigration.test_data_node_type_string"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestNodePrefixRemovalMigration.test_data_node_type_string">[docs]</a>    <span class="k">def</span> <span class="nf">test_data_node_type_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify that type string of the Data node was successfully adapted.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="n">DbNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbnode</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

                <span class="c1"># Verify that the `node.` prefix has been dropped from both the data as well as the process node</span>
                <span class="n">node_data</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbNode</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbNode</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_data_id</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_data</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;data.int.Int.&#39;</span><span class="p">)</span>

                <span class="n">node_calc</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbNode</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbNode</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_calc_id</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node_calc</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;process.calculation.calcjob.CalcJobNode.&#39;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="TestParameterDataToDictMigration"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestParameterDataToDictMigration">[docs]</a><span class="k">class</span> <span class="nc">TestParameterDataToDictMigration</span><span class="p">(</span><span class="n">TestMigrationsSQLA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test the data migration after `ParameterData` was renamed to `Dict`.&quot;&quot;&quot;</span>

    <span class="n">migrate_from</span> <span class="o">=</span> <span class="s1">&#39;61fc0913fae9&#39;</span>  <span class="c1"># 61fc0913fae9_remove_node_prefix</span>
    <span class="n">migrate_to</span> <span class="o">=</span> <span class="s1">&#39;d254fdfed416&#39;</span>  <span class="c1"># d254fdfed416_rename_parameter_data_to_dict</span>

<div class="viewcode-block" id="TestParameterDataToDictMigration.setUpBeforeMigration"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestParameterDataToDictMigration.setUpBeforeMigration">[docs]</a>    <span class="k">def</span> <span class="nf">setUpBeforeMigration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="n">DbNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbnode</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">DbUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbuser</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

                <span class="n">user</span> <span class="o">=</span> <span class="n">DbUser</span><span class="p">(</span><span class="n">is_superuser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">@aiida.net&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">()))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="n">node</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;data.parameter.ParameterData.&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestParameterDataToDictMigration.test_type_string"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.sqlalchemy.tests.html#aiida.backends.sqlalchemy.tests.test_migrations.TestParameterDataToDictMigration.test_type_string">[docs]</a>    <span class="k">def</span> <span class="nf">test_type_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify that type string of the Data node was successfully adapted.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Session</span>  <span class="c1"># pylint: disable=import-error,no-name-in-module</span>

        <span class="n">DbNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auto_base</span><span class="p">()</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">db_dbnode</span>  <span class="c1"># pylint: disable=invalid-name</span>

        <span class="k">with</span> <span class="n">sa</span><span class="o">.</span><span class="n">ENGINE</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

                <span class="n">node</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbNode</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbNode</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;data.dict.Dict.&#39;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>