

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.backends.tests.engine.test_work_chain &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../../aiida.html">aiida</a> &raquo;</li>
        
          <li><a href="../../tests.html">aiida.backends.tests</a> &raquo;</li>
        
      <li>aiida.backends.tests.engine.test_work_chain</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.backends.tests.engine.test_work_chain</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">plumpy</span>
<span class="kn">import</span> <span class="nn">plumpy.test_utils</span>
<span class="kn">from</span> <span class="nn">tornado</span> <span class="k">import</span> <span class="n">gen</span>

<span class="kn">from</span> <span class="nn">aiida</span> <span class="k">import</span> <span class="n">orm</span>
<span class="kn">from</span> <span class="nn">aiida.backends.testbase</span> <span class="k">import</span> <span class="n">AiidaTestCase</span>
<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>
<span class="kn">from</span> <span class="nn">aiida.common.utils</span> <span class="k">import</span> <span class="n">Capturing</span>
<span class="kn">from</span> <span class="nn">aiida.engine</span> <span class="k">import</span> <span class="n">ExitCode</span><span class="p">,</span> <span class="n">Process</span><span class="p">,</span> <span class="n">ToContext</span><span class="p">,</span> <span class="n">WorkChain</span><span class="p">,</span> <span class="n">if_</span><span class="p">,</span> <span class="n">while_</span><span class="p">,</span> <span class="n">return_</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">run_get_node</span><span class="p">,</span> <span class="n">submit</span>
<span class="kn">from</span> <span class="nn">aiida.engine</span> <span class="k">import</span> <span class="n">launch</span>
<span class="kn">from</span> <span class="nn">aiida.engine.persistence</span> <span class="k">import</span> <span class="n">ObjectLoader</span>
<span class="kn">from</span> <span class="nn">aiida.manage.manager</span> <span class="k">import</span> <span class="n">get_manager</span>
<span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="k">import</span> <span class="n">load_node</span><span class="p">,</span> <span class="n">Bool</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">Str</span>


<div class="viewcode-block" id="run_until_paused"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.run_until_paused">[docs]</a><span class="k">def</span> <span class="nf">run_until_paused</span><span class="p">(</span><span class="n">proc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Set up a future that will be resolved on entering the WAITING state &quot;&quot;&quot;</span>
    <span class="n">listener</span> <span class="o">=</span> <span class="n">plumpy</span><span class="o">.</span><span class="n">ProcessListener</span><span class="p">()</span>
    <span class="n">paused</span> <span class="o">=</span> <span class="n">plumpy</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">paused</span><span class="p">:</span>
        <span class="n">paused</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">on_paused</span><span class="p">(</span><span class="n">_paused_proc</span><span class="p">):</span>
            <span class="n">paused</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">remove_process_listener</span><span class="p">(</span><span class="n">listener</span><span class="p">)</span>

        <span class="n">listener</span><span class="o">.</span><span class="n">on_process_paused</span> <span class="o">=</span> <span class="n">on_paused</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">add_process_listener</span><span class="p">(</span><span class="n">listener</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">paused</span></div>


<div class="viewcode-block" id="run_until_waiting"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.run_until_waiting">[docs]</a><span class="k">def</span> <span class="nf">run_until_waiting</span><span class="p">(</span><span class="n">proc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Set up a future that will be resolved on entering the WAITING state &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.engine</span> <span class="k">import</span> <span class="n">ProcessState</span>

    <span class="n">listener</span> <span class="o">=</span> <span class="n">plumpy</span><span class="o">.</span><span class="n">ProcessListener</span><span class="p">()</span>
    <span class="n">in_waiting</span> <span class="o">=</span> <span class="n">plumpy</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">ProcessState</span><span class="o">.</span><span class="n">WAITING</span><span class="p">:</span>
        <span class="n">in_waiting</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">on_waiting</span><span class="p">(</span><span class="n">waiting_proc</span><span class="p">):</span>
            <span class="n">in_waiting</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">remove_process_listener</span><span class="p">(</span><span class="n">listener</span><span class="p">)</span>

        <span class="n">listener</span><span class="o">.</span><span class="n">on_process_waiting</span> <span class="o">=</span> <span class="n">on_waiting</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">add_process_listener</span><span class="p">(</span><span class="n">listener</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">in_waiting</span></div>


<div class="viewcode-block" id="run_and_check_success"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.run_and_check_success">[docs]</a><span class="k">def</span> <span class="nf">run_and_check_success</span><span class="p">(</span><span class="n">process_class</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instantiates the process class and executes it followed by a check</span>
<span class="sd">    that it is finished successfully</span>

<span class="sd">    :returns: instance of process</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">process</span> <span class="o">=</span> <span class="n">process_class</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">run</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">process</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">is_finished_ok</span> <span class="ow">is</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">process</span></div>


<div class="viewcode-block" id="Wf"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.Wf">[docs]</a><span class="k">class</span> <span class="nc">Wf</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>
    <span class="c1"># Keep track of which steps were completed by the workflow</span>
    <span class="n">finished_steps</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="Wf.define"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.Wf.define">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Wf</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">Str</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">))</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">Int</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">dynamic</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span>
            <span class="n">if_</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">isA</span><span class="p">)(</span><span class="bp">cls</span><span class="o">.</span><span class="n">s2</span><span class="p">)</span><span class="o">.</span><span class="n">elif_</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">isB</span><span class="p">)(</span><span class="bp">cls</span><span class="o">.</span><span class="n">s3</span><span class="p">)</span><span class="o">.</span><span class="n">else_</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">s4</span><span class="p">),</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">s5</span><span class="p">,</span>
            <span class="n">while_</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">ltN</span><span class="p">)(</span><span class="bp">cls</span><span class="o">.</span><span class="n">s6</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Wf.on_create"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.Wf.on_create">[docs]</a>    <span class="k">def</span> <span class="nf">on_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Wf</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">on_create</span><span class="p">()</span>
        <span class="c1"># Reset the finished step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished_steps</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">s1</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s4</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s5</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">s6</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">isA</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">isB</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ltN</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="p">]</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="Wf.s1"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.Wf.s1">[docs]</a>    <span class="k">def</span> <span class="nf">s1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_finished</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span></div>

<div class="viewcode-block" id="Wf.s2"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.Wf.s2">[docs]</a>    <span class="k">def</span> <span class="nf">s2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_finished</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span></div>

<div class="viewcode-block" id="Wf.s3"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.Wf.s3">[docs]</a>    <span class="k">def</span> <span class="nf">s3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_finished</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span></div>

<div class="viewcode-block" id="Wf.s4"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.Wf.s4">[docs]</a>    <span class="k">def</span> <span class="nf">s4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_finished</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span></div>

<div class="viewcode-block" id="Wf.s5"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.Wf.s5">[docs]</a>    <span class="k">def</span> <span class="nf">s5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_finished</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span></div>

<div class="viewcode-block" id="Wf.s6"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.Wf.s6">[docs]</a>    <span class="k">def</span> <span class="nf">s6</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_finished</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span></div>

<div class="viewcode-block" id="Wf.isA"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.Wf.isA">[docs]</a>    <span class="k">def</span> <span class="nf">isA</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_finished</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span></div>

<div class="viewcode-block" id="Wf.isB"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.Wf.isB">[docs]</a>    <span class="k">def</span> <span class="nf">isB</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_finished</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span></div>

<div class="viewcode-block" id="Wf.ltN"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.Wf.ltN">[docs]</a>    <span class="k">def</span> <span class="nf">ltN</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">keep_looping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">counter</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">n</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_looping</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_finished</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">keep_looping</span></div>

<div class="viewcode-block" id="Wf._set_finished"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.Wf._set_finished">[docs]</a>    <span class="k">def</span> <span class="nf">_set_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished_steps</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div></div>


<div class="viewcode-block" id="PotentialFailureWorkChain"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.PotentialFailureWorkChain">[docs]</a><span class="k">class</span> <span class="nc">PotentialFailureWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>
    <span class="n">EXIT_STATUS</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">EXIT_MESSAGE</span> <span class="o">=</span> <span class="s1">&#39;Well you did ask for it&#39;</span>
    <span class="n">OUTPUT_LABEL</span> <span class="o">=</span> <span class="s1">&#39;optional_output&#39;</span>
    <span class="n">OUTPUT_VALUE</span> <span class="o">=</span> <span class="mi">144</span>

<div class="viewcode-block" id="PotentialFailureWorkChain.define"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.PotentialFailureWorkChain.define">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PotentialFailureWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">Bool</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;through_return&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">Bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;through_exit_code&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">Bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">exit_code</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">EXIT_STATUS</span><span class="p">,</span> <span class="s1">&#39;EXIT_STATUS&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">EXIT_MESSAGE</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="n">if_</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">should_return_out_of_outline</span><span class="p">)(</span><span class="n">return_</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">EXIT_STATUS</span><span class="p">)),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">failure</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">success</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">OUTPUT_LABEL</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="PotentialFailureWorkChain.should_return_out_of_outline"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.PotentialFailureWorkChain.should_return_out_of_outline">[docs]</a>    <span class="k">def</span> <span class="nf">should_return_out_of_outline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">through_return</span><span class="o">.</span><span class="n">value</span></div>

<div class="viewcode-block" id="PotentialFailureWorkChain.failure"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.PotentialFailureWorkChain.failure">[docs]</a>    <span class="k">def</span> <span class="nf">failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">success</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># Returning either 0 or ExitCode with non-zero status should terminate the workchain</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">through_exit_code</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXIT_STATUS</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_codes</span><span class="o">.</span><span class="n">EXIT_STATUS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Returning 0 or ExitCode with zero status should *not* terminate the workchain</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">through_exit_code</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ExitCode</span><span class="p">()</span></div>

<div class="viewcode-block" id="PotentialFailureWorkChain.success"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.PotentialFailureWorkChain.success">[docs]</a>    <span class="k">def</span> <span class="nf">success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTPUT_LABEL</span><span class="p">,</span> <span class="n">Int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTPUT_VALUE</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">())</span>
        <span class="k">return</span></div></div>


<div class="viewcode-block" id="TestExitStatus"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestExitStatus">[docs]</a><span class="k">class</span> <span class="nc">TestExitStatus</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class should test the various ways that one can exit from the outline flow of a WorkChain, other than</span>
<span class="sd">    it running it all the way through. Currently this can be done directly in the outline by calling the `return_`</span>
<span class="sd">    construct, or from an outline step function by returning a non-zero integer or an ExitCode with a non-zero status</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestExitStatus.test_failing_workchain_through_integer"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestExitStatus.test_failing_workchain_through_integer">[docs]</a>    <span class="k">def</span> <span class="nf">test_failing_workchain_through_integer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">node</span> <span class="o">=</span> <span class="n">run_get_node</span><span class="p">(</span><span class="n">PotentialFailureWorkChain</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">exit_status</span><span class="p">,</span> <span class="n">PotentialFailureWorkChain</span><span class="o">.</span><span class="n">EXIT_STATUS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">exit_message</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">is_finished</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">is_failed</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">PotentialFailureWorkChain</span><span class="o">.</span><span class="n">OUTPUT_LABEL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">get_outgoing</span><span class="p">()</span><span class="o">.</span><span class="n">all_link_labels</span><span class="p">())</span></div>

<div class="viewcode-block" id="TestExitStatus.test_failing_workchain_through_exit_code"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestExitStatus.test_failing_workchain_through_exit_code">[docs]</a>    <span class="k">def</span> <span class="nf">test_failing_workchain_through_exit_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">node</span> <span class="o">=</span> <span class="n">run_get_node</span><span class="p">(</span><span class="n">PotentialFailureWorkChain</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span> <span class="n">through_exit_code</span><span class="o">=</span><span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">exit_status</span><span class="p">,</span> <span class="n">PotentialFailureWorkChain</span><span class="o">.</span><span class="n">EXIT_STATUS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">exit_message</span><span class="p">,</span> <span class="n">PotentialFailureWorkChain</span><span class="o">.</span><span class="n">EXIT_MESSAGE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">is_finished</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">is_failed</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">PotentialFailureWorkChain</span><span class="o">.</span><span class="n">OUTPUT_LABEL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">get_outgoing</span><span class="p">()</span><span class="o">.</span><span class="n">all_link_labels</span><span class="p">())</span></div>

<div class="viewcode-block" id="TestExitStatus.test_successful_workchain_through_integer"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestExitStatus.test_successful_workchain_through_integer">[docs]</a>    <span class="k">def</span> <span class="nf">test_successful_workchain_through_integer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">node</span> <span class="o">=</span> <span class="n">run_get_node</span><span class="p">(</span><span class="n">PotentialFailureWorkChain</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">exit_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">is_finished</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">is_failed</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">PotentialFailureWorkChain</span><span class="o">.</span><span class="n">OUTPUT_LABEL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">get_outgoing</span><span class="p">()</span><span class="o">.</span><span class="n">all_link_labels</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get_outgoing</span><span class="p">()</span><span class="o">.</span><span class="n">get_node_by_label</span><span class="p">(</span><span class="n">PotentialFailureWorkChain</span><span class="o">.</span><span class="n">OUTPUT_LABEL</span><span class="p">),</span>
                          <span class="n">PotentialFailureWorkChain</span><span class="o">.</span><span class="n">OUTPUT_VALUE</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestExitStatus.test_successful_workchain_through_exit_code"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestExitStatus.test_successful_workchain_through_exit_code">[docs]</a>    <span class="k">def</span> <span class="nf">test_successful_workchain_through_exit_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">node</span> <span class="o">=</span> <span class="n">run_get_node</span><span class="p">(</span><span class="n">PotentialFailureWorkChain</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">through_exit_code</span><span class="o">=</span><span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">exit_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">is_finished</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">is_failed</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">PotentialFailureWorkChain</span><span class="o">.</span><span class="n">OUTPUT_LABEL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">get_outgoing</span><span class="p">()</span><span class="o">.</span><span class="n">all_link_labels</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get_outgoing</span><span class="p">()</span><span class="o">.</span><span class="n">get_node_by_label</span><span class="p">(</span><span class="n">PotentialFailureWorkChain</span><span class="o">.</span><span class="n">OUTPUT_LABEL</span><span class="p">),</span>
                          <span class="n">PotentialFailureWorkChain</span><span class="o">.</span><span class="n">OUTPUT_VALUE</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestExitStatus.test_return_out_of_outline"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestExitStatus.test_return_out_of_outline">[docs]</a>    <span class="k">def</span> <span class="nf">test_return_out_of_outline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">node</span> <span class="o">=</span> <span class="n">run_get_node</span><span class="p">(</span><span class="n">PotentialFailureWorkChain</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">through_return</span><span class="o">=</span><span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">exit_status</span><span class="p">,</span> <span class="n">PotentialFailureWorkChain</span><span class="o">.</span><span class="n">EXIT_STATUS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">is_finished</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">is_failed</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">PotentialFailureWorkChain</span><span class="o">.</span><span class="n">OUTPUT_LABEL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">get_outgoing</span><span class="p">()</span><span class="o">.</span><span class="n">all_link_labels</span><span class="p">())</span></div></div>


<div class="viewcode-block" id="IfTest"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.IfTest">[docs]</a><span class="k">class</span> <span class="nc">IfTest</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

<div class="viewcode-block" id="IfTest.define"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.IfTest.define">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IfTest</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="n">if_</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">condition</span><span class="p">)(</span><span class="bp">cls</span><span class="o">.</span><span class="n">step1</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">step2</span><span class="p">))</span></div>

<div class="viewcode-block" id="IfTest.on_create"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.IfTest.on_create">[docs]</a>    <span class="k">def</span> <span class="nf">on_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IfTest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">on_create</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">s1</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">s2</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="IfTest.condition"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.IfTest.condition">[docs]</a>    <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="IfTest.step1"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.IfTest.step1">[docs]</a>    <span class="k">def</span> <span class="nf">step1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">s1</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span></div>

<div class="viewcode-block" id="IfTest.step2"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.IfTest.step2">[docs]</a>    <span class="k">def</span> <span class="nf">step2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">s2</span> <span class="o">=</span> <span class="kc">True</span></div></div>


<div class="viewcode-block" id="TestContext"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestContext">[docs]</a><span class="k">class</span> <span class="nc">TestContext</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestContext.test_attributes"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestContext.test_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">test_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wc</span> <span class="o">=</span> <span class="n">IfTest</span><span class="p">()</span>
        <span class="n">wc</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">new_attr</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wc</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">new_attr</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">wc</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">new_attr</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">wc</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">new_attr</span></div>

<div class="viewcode-block" id="TestContext.test_dict"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestContext.test_dict">[docs]</a>    <span class="k">def</span> <span class="nf">test_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wc</span> <span class="o">=</span> <span class="n">IfTest</span><span class="p">()</span>
        <span class="n">wc</span><span class="o">.</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;new_attr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wc</span><span class="o">.</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;new_attr&#39;</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">wc</span><span class="o">.</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;new_attr&#39;</span><span class="p">]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
            <span class="n">wc</span><span class="o">.</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;new_attr&#39;</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="TestWorkchain"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain">[docs]</a><span class="k">class</span> <span class="nc">TestWorkchain</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestWorkchain.setUp"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestWorkchain</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">Process</span><span class="o">.</span><span class="n">current</span><span class="p">())</span></div>

<div class="viewcode-block" id="TestWorkchain.tearDown"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestWorkchain</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">Process</span><span class="o">.</span><span class="n">current</span><span class="p">())</span></div>

<div class="viewcode-block" id="TestWorkchain.test_run_base_class"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_run_base_class">[docs]</a>    <span class="k">def</span> <span class="nf">test_run_base_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify that it is impossible to run, submit or instantiate a base `WorkChain` class.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">InvalidOperation</span><span class="p">):</span>
            <span class="n">WorkChain</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">InvalidOperation</span><span class="p">):</span>
            <span class="n">launch</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">InvalidOperation</span><span class="p">):</span>
            <span class="n">launch</span><span class="o">.</span><span class="n">run_get_node</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">InvalidOperation</span><span class="p">):</span>
            <span class="n">launch</span><span class="o">.</span><span class="n">run_get_pk</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">InvalidOperation</span><span class="p">):</span>
            <span class="n">launch</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkchain.test_run"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_run">[docs]</a>    <span class="k">def</span> <span class="nf">test_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">Str</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">Str</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">Str</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="n">three</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Try the if(..) part</span>
        <span class="n">run</span><span class="p">(</span><span class="n">Wf</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">three</span><span class="p">)</span>
        <span class="c1"># Check the steps that should have been run</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">finished</span> <span class="ow">in</span> <span class="n">Wf</span><span class="o">.</span><span class="n">finished_steps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">step</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">,</span> <span class="s1">&#39;s4&#39;</span><span class="p">,</span> <span class="s1">&#39;isB&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">finished</span><span class="p">,</span> <span class="s2">&quot;Step </span><span class="si">{}</span><span class="s2"> was not called by workflow&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">))</span>

        <span class="c1"># Try the elif(..) part</span>
        <span class="n">finished_steps</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">Wf</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">B</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">three</span><span class="p">)</span>
        <span class="c1"># Check the steps that should have been run</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">finished</span> <span class="ow">in</span> <span class="n">finished_steps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">step</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;isA&#39;</span><span class="p">,</span> <span class="s1">&#39;s2&#39;</span><span class="p">,</span> <span class="s1">&#39;s4&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">finished</span><span class="p">,</span> <span class="s2">&quot;Step </span><span class="si">{}</span><span class="s2"> was not called by workflow&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">))</span>

        <span class="c1"># Try the else... part</span>
        <span class="n">finished_steps</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">Wf</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">C</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">three</span><span class="p">)</span>
        <span class="c1"># Check the steps that should have been run</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">finished</span> <span class="ow">in</span> <span class="n">finished_steps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">step</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;isA&#39;</span><span class="p">,</span> <span class="s1">&#39;s2&#39;</span><span class="p">,</span> <span class="s1">&#39;isB&#39;</span><span class="p">,</span> <span class="s1">&#39;s3&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">finished</span><span class="p">,</span> <span class="s2">&quot;Step </span><span class="si">{}</span><span class="s2"> was not called by workflow&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestWorkchain.test_incorrect_outline"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_incorrect_outline">[docs]</a>    <span class="k">def</span> <span class="nf">test_incorrect_outline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">class</span> <span class="nc">Wf</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">Wf</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="c1"># Try defining an invalid outline</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">Wf</span><span class="o">.</span><span class="n">spec</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestWorkchain.test_define_not_calling_super"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_define_not_calling_super">[docs]</a>    <span class="k">def</span> <span class="nf">test_define_not_calling_super</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A `WorkChain` that does not call super in `define` classmethod should raise.&quot;&quot;&quot;</span>

        <span class="k">class</span> <span class="nc">IncompleteDefineWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="k">pass</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">):</span>
            <span class="n">launch</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">IncompleteDefineWorkChain</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkchain.test_out_unstored"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_out_unstored">[docs]</a>    <span class="k">def</span> <span class="nf">test_out_unstored</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calling `self.out` on an unstored `Node` should raise.</span>

<span class="sd">        It indicates that users created new data whose provenance will be lost.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">class</span> <span class="nc">IllegalWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">IllegalWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">illegal</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">illegal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s1">&#39;not_allowed&#39;</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">launch</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">IllegalWorkChain</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkchain.test_same_input_node"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_same_input_node">[docs]</a>    <span class="k">def</span> <span class="nf">test_same_input_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">class</span> <span class="nc">Wf</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">Wf</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">Int</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">Int</span><span class="p">)</span>
                <span class="c1"># Try defining an invalid outline</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">check_a_b</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">check_a_b</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">assert</span> <span class="s1">&#39;a&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>
                <span class="k">assert</span> <span class="s1">&#39;b&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">run_and_check_success</span><span class="p">(</span><span class="n">Wf</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">x</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkchain.test_context"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_context">[docs]</a>    <span class="k">def</span> <span class="nf">test_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">Str</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">Str</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">test_case</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">class</span> <span class="nc">ReturnA</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">ReturnA</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">dynamic</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s1">&#39;res&#39;</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">ReturnB</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">ReturnB</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">dynamic</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s1">&#39;res&#39;</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">Wf</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">Wf</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">s2</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">s3</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">s1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">ToContext</span><span class="p">(</span><span class="n">r1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">ReturnA</span><span class="p">),</span> <span class="n">r2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">ReturnB</span><span class="p">))</span>

            <span class="k">def</span> <span class="nf">s2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">test_case</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">res</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
                <span class="n">test_case</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">res</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>

                <span class="c1"># Try overwriting r1</span>
                <span class="k">return</span> <span class="n">ToContext</span><span class="p">(</span><span class="n">r1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">ReturnB</span><span class="p">))</span>

            <span class="k">def</span> <span class="nf">s3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">test_case</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">res</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
                <span class="n">test_case</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">res</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>

        <span class="n">run_and_check_success</span><span class="p">(</span><span class="n">Wf</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkchain.test_unstored_nodes_in_context"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_unstored_nodes_in_context">[docs]</a>    <span class="k">def</span> <span class="nf">test_unstored_nodes_in_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">class</span> <span class="nc">TestWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">TestWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">setup_context</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">read_context</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">setup_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;some_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Verify that strings in the context do not cause infinite recursions&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;node&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">read_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;node&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">is_stored</span><span class="p">,</span> <span class="s1">&#39;the node in the context was not stored during step transition&#39;</span>

        <span class="n">run_and_check_success</span><span class="p">(</span><span class="n">TestWorkChain</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkchain.test_str"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_str">[docs]</a>    <span class="k">def</span> <span class="nf">test_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Wf</span><span class="o">.</span><span class="n">spec</span><span class="p">()),</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkchain.test_malformed_outline"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_malformed_outline">[docs]</a>    <span class="k">def</span> <span class="nf">test_malformed_outline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test some malformed outlines</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.engine.processes.workchains.workchain</span> <span class="k">import</span> <span class="n">WorkChainSpec</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="n">WorkChainSpec</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Test a function with wrong number of args</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkchain.test_checkpointing"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_checkpointing">[docs]</a>    <span class="k">def</span> <span class="nf">test_checkpointing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">Str</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">Str</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">Str</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="n">three</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Try the if(..) part</span>
        <span class="n">finished_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_with_checkpoints</span><span class="p">(</span><span class="n">Wf</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">A</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">three</span><span class="p">})</span>
        <span class="c1"># Check the steps that should have been run</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">finished</span> <span class="ow">in</span> <span class="n">finished_steps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">step</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">,</span> <span class="s1">&#39;s4&#39;</span><span class="p">,</span> <span class="s1">&#39;isB&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">finished</span><span class="p">,</span> <span class="s2">&quot;Step </span><span class="si">{}</span><span class="s2"> was not called by workflow&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">))</span>

        <span class="c1"># Try the elif(..) part</span>
        <span class="n">finished_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_with_checkpoints</span><span class="p">(</span><span class="n">Wf</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">B</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">three</span><span class="p">})</span>
        <span class="c1"># Check the steps that should have been run</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">finished</span> <span class="ow">in</span> <span class="n">finished_steps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">step</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;isA&#39;</span><span class="p">,</span> <span class="s1">&#39;s2&#39;</span><span class="p">,</span> <span class="s1">&#39;s4&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">finished</span><span class="p">,</span> <span class="s2">&quot;Step </span><span class="si">{}</span><span class="s2"> was not called by workflow&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">))</span>

        <span class="c1"># Try the else... part</span>
        <span class="n">finished_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_with_checkpoints</span><span class="p">(</span><span class="n">Wf</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">C</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">three</span><span class="p">})</span>
        <span class="c1"># Check the steps that should have been run</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">finished</span> <span class="ow">in</span> <span class="n">finished_steps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">step</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;isA&#39;</span><span class="p">,</span> <span class="s1">&#39;s2&#39;</span><span class="p">,</span> <span class="s1">&#39;isB&#39;</span><span class="p">,</span> <span class="s1">&#39;s3&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">finished</span><span class="p">,</span> <span class="s2">&quot;Step </span><span class="si">{}</span><span class="s2"> was not called by workflow&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestWorkchain.test_return"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_return">[docs]</a>    <span class="k">def</span> <span class="nf">test_return</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">class</span> <span class="nc">WcWithReturn</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">WcWithReturn</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="n">if_</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">isA</span><span class="p">)(</span><span class="n">return_</span><span class="p">),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">after</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">s1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">pass</span>

            <span class="k">def</span> <span class="nf">isA</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">def</span> <span class="nf">after</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Shouldn&#39;t get here&quot;</span><span class="p">)</span>

        <span class="n">run_and_check_success</span><span class="p">(</span><span class="n">WcWithReturn</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkchain.test_tocontext_submit_workchain_no_daemon"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_tocontext_submit_workchain_no_daemon">[docs]</a>    <span class="k">def</span> <span class="nf">test_tocontext_submit_workchain_no_daemon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">class</span> <span class="nc">MainWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">MainWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">do_run</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">check</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">dynamic</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">ToContext</span><span class="p">(</span><span class="n">subwc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">SubWorkChain</span><span class="p">))</span>

            <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">subwc</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">Int</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">SubWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">SubWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">do_run</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">dynamic</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">Int</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">())</span>

        <span class="n">run_and_check_success</span><span class="p">(</span><span class="n">MainWorkChain</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkchain.test_tocontext_schedule_workchain"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_tocontext_schedule_workchain">[docs]</a>    <span class="k">def</span> <span class="nf">test_tocontext_schedule_workchain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">node</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="k">class</span> <span class="nc">MainWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">MainWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">do_run</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">check</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">dynamic</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">ToContext</span><span class="p">(</span><span class="n">subwc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">SubWorkChain</span><span class="p">))</span>

            <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">subwc</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">node</span>

        <span class="k">class</span> <span class="nc">SubWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">SubWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">do_run</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">dynamic</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="n">run_and_check_success</span><span class="p">(</span><span class="n">MainWorkChain</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkchain.test_if_block_persistence"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_if_block_persistence">[docs]</a>    <span class="k">def</span> <span class="nf">test_if_block_persistence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This test was created to capture issue #902</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="n">get_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_runner</span><span class="p">()</span>
        <span class="n">wc</span> <span class="o">=</span> <span class="n">IfTest</span><span class="p">()</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">wc</span><span class="p">)</span>

        <span class="nd">@gen</span><span class="o">.</span><span class="n">coroutine</span>
        <span class="k">def</span> <span class="nf">run_async</span><span class="p">(</span><span class="n">workchain</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">run_until_paused</span><span class="p">(</span><span class="n">workchain</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">workchain</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">s1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">workchain</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">s2</span><span class="p">)</span>

            <span class="c1"># Now bundle the thing</span>
            <span class="n">bundle</span> <span class="o">=</span> <span class="n">plumpy</span><span class="o">.</span><span class="n">Bundle</span><span class="p">(</span><span class="n">workchain</span><span class="p">)</span>
            <span class="c1"># Need to close the process before recreating a new instance</span>
            <span class="n">workchain</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># Load from saved state</span>
            <span class="n">workchain2</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">unbundle</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">workchain2</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">s1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">workchain2</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">s2</span><span class="p">)</span>

            <span class="n">bundle2</span> <span class="o">=</span> <span class="n">plumpy</span><span class="o">.</span><span class="n">Bundle</span><span class="p">(</span><span class="n">workchain2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertDictEqual</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">bundle2</span><span class="p">)</span>

            <span class="n">workchain</span><span class="o">.</span><span class="n">play</span><span class="p">()</span>
            <span class="k">yield</span> <span class="n">workchain</span><span class="o">.</span><span class="n">future</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">workchain</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">s1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">workchain</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">s2</span><span class="p">)</span>

        <span class="n">runner</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">run_async</span><span class="p">(</span><span class="n">wc</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestWorkchain.test_report_dbloghandler"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_report_dbloghandler">[docs]</a>    <span class="k">def</span> <span class="nf">test_report_dbloghandler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test whether the WorkChain, through its Process, has a logger</span>
<span class="sd">        set for which the DbLogHandler has been attached. Because if this</span>
<span class="sd">        is not the case, the &#39;report&#39; method will not actually hit the</span>
<span class="sd">        DbLogHandler and the message will not be stored in the database</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">class</span> <span class="nc">TestWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">TestWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">check</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">dynamic</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Testing the report function&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">find</span><span class="p">()</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="n">run_and_check_success</span><span class="p">(</span><span class="n">TestWorkChain</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkchain.test_to_context"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_to_context">[docs]</a>    <span class="k">def</span> <span class="nf">test_to_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">test_case</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">class</span> <span class="nc">SimpleWc</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">SimpleWc</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">dynamic</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">Workchain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">Workchain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">begin</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">to_context</span><span class="p">(</span><span class="n">result_a</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">SimpleWc</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">ToContext</span><span class="p">(</span><span class="n">result_b</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">SimpleWc</span><span class="p">))</span>

            <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">test_case</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">result_a</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                <span class="n">test_case</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">result_b</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="n">run_and_check_success</span><span class="p">(</span><span class="n">Workchain</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkchain.test_persisting"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_persisting">[docs]</a>    <span class="k">def</span> <span class="nf">test_persisting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">persister</span> <span class="o">=</span> <span class="n">plumpy</span><span class="o">.</span><span class="n">test_utils</span><span class="o">.</span><span class="n">TestPersister</span><span class="p">()</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="n">get_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_runner</span><span class="p">()</span>
        <span class="n">workchain</span> <span class="o">=</span> <span class="n">Wf</span><span class="p">(</span><span class="n">runner</span><span class="o">=</span><span class="n">runner</span><span class="p">)</span>
        <span class="n">run</span><span class="p">(</span><span class="n">workchain</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkchain.test_namespace_nondb_mapping"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_namespace_nondb_mapping">[docs]</a>    <span class="k">def</span> <span class="nf">test_namespace_nondb_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression test for a bug in _flatten_inputs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}}</span>

        <span class="k">class</span> <span class="nc">TestWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">TestWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

                <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;namespace.sub&#39;</span><span class="p">,</span> <span class="n">non_db</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">check_input</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">check_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">namespace</span><span class="o">.</span><span class="n">sub</span> <span class="o">==</span> <span class="n">value</span>

        <span class="n">run_and_check_success</span><span class="p">(</span><span class="n">TestWorkChain</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sub&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span></div>

<div class="viewcode-block" id="TestWorkchain.test_nondb_dynamic"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_nondb_dynamic">[docs]</a>    <span class="k">def</span> <span class="nf">test_nondb_dynamic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that non-db inputs can be passed in a dynamic input namespace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}]</span>

        <span class="k">class</span> <span class="nc">TestWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">TestWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">input_namespace</span><span class="p">(</span><span class="s1">&#39;namespace&#39;</span><span class="p">,</span> <span class="n">dynamic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">check_input</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">check_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">namespace</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">value</span>

        <span class="n">run_and_check_success</span><span class="p">(</span><span class="n">TestWorkChain</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span></div>

<div class="viewcode-block" id="TestWorkchain.test_exit_codes"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain.test_exit_codes">[docs]</a>    <span class="k">def</span> <span class="nf">test_exit_codes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">418</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;SOME_EXIT_CODE&#39;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;I am a teapot&#39;</span>

        <span class="k">class</span> <span class="nc">ExitCodeWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">ExitCodeWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">exit_code</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">pass</span>

        <span class="n">wc</span> <span class="o">=</span> <span class="n">ExitCodeWorkChain</span><span class="p">()</span>

        <span class="c1"># The exit code can be gotten by calling it with the status or label, as well as using attribute dereferencing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">wc</span><span class="o">.</span><span class="n">exit_codes</span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">wc</span><span class="o">.</span><span class="n">exit_codes</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">wc</span><span class="o">.</span><span class="n">exit_codes</span><span class="o">.</span><span class="n">SOME_EXIT_CODE</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">wc</span><span class="o">.</span><span class="n">exit_codes</span><span class="o">.</span><span class="n">NON_EXISTENT_ERROR</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">ExitCodeWorkChain</span><span class="o">.</span><span class="n">exit_codes</span><span class="o">.</span><span class="n">SOME_EXIT_CODE</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">ExitCodeWorkChain</span><span class="o">.</span><span class="n">exit_codes</span><span class="o">.</span><span class="n">SOME_EXIT_CODE</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">ExitCodeWorkChain</span><span class="o">.</span><span class="n">exit_codes</span><span class="p">[</span><span class="s1">&#39;SOME_EXIT_CODE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">ExitCodeWorkChain</span><span class="o">.</span><span class="n">exit_codes</span><span class="p">[</span><span class="s1">&#39;SOME_EXIT_CODE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">ExitCodeWorkChain</span><span class="o">.</span><span class="n">exit_codes</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">ExitCodeWorkChain</span><span class="o">.</span><span class="n">exit_codes</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkchain._run_with_checkpoints"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkchain._run_with_checkpoints">[docs]</a>    <span class="k">def</span> <span class="nf">_run_with_checkpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wf_class</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">run_and_check_success</span><span class="p">(</span><span class="n">wf_class</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">proc</span><span class="o">.</span><span class="n">finished_steps</span></div></div>


<div class="viewcode-block" id="TestWorkChainAbort"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbort">[docs]</a><span class="k">class</span> <span class="nc">TestWorkChainAbort</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test the functionality to abort a workchain</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestWorkChainAbort.setUp"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbort.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestWorkChainAbort</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">Process</span><span class="o">.</span><span class="n">current</span><span class="p">())</span></div>

<div class="viewcode-block" id="TestWorkChainAbort.tearDown"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbort.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestWorkChainAbort</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">Process</span><span class="o">.</span><span class="n">current</span><span class="p">())</span></div>

<div class="viewcode-block" id="TestWorkChainAbort.AbortableWorkChain"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbort.AbortableWorkChain">[docs]</a>    <span class="k">class</span> <span class="nc">AbortableWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

<div class="viewcode-block" id="TestWorkChainAbort.AbortableWorkChain.define"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbort.AbortableWorkChain.define">[docs]</a>        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">TestWorkChainAbort</span><span class="o">.</span><span class="n">AbortableWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">begin</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">check</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkChainAbort.AbortableWorkChain.begin"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbort.AbortableWorkChain.begin">[docs]</a>        <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestWorkChainAbort.AbortableWorkChain.check"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbort.AbortableWorkChain.check">[docs]</a>        <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;should have been aborted by now&#39;</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="TestWorkChainAbort.test_simple_run"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbort.test_simple_run">[docs]</a>    <span class="k">def</span> <span class="nf">test_simple_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the workchain which should hit the exception and therefore end</span>
<span class="sd">        up in the EXCEPTED state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="n">get_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_runner</span><span class="p">()</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">TestWorkChainAbort</span><span class="o">.</span><span class="n">AbortableWorkChain</span><span class="p">()</span>

        <span class="nd">@gen</span><span class="o">.</span><span class="n">coroutine</span>
        <span class="k">def</span> <span class="nf">run_async</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">run_until_paused</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>

            <span class="n">process</span><span class="o">.</span><span class="n">play</span><span class="p">()</span>

            <span class="k">with</span> <span class="n">Capturing</span><span class="p">():</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">process</span><span class="o">.</span><span class="n">future</span><span class="p">()</span>

        <span class="n">runner</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">run_async</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">is_excepted</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">is_killed</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkChainAbort.test_simple_kill_through_process"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbort.test_simple_kill_through_process">[docs]</a>    <span class="k">def</span> <span class="nf">test_simple_kill_through_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the workchain for one step and then kill it by calling kill</span>
<span class="sd">        on the workchain itself. This should have the workchain end up</span>
<span class="sd">        in the KILLED state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="n">get_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_runner</span><span class="p">()</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">TestWorkChainAbort</span><span class="o">.</span><span class="n">AbortableWorkChain</span><span class="p">()</span>

        <span class="nd">@gen</span><span class="o">.</span><span class="n">coroutine</span>
        <span class="k">def</span> <span class="nf">run_async</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">run_until_paused</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">paused</span><span class="p">)</span>
            <span class="n">process</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">plumpy</span><span class="o">.</span><span class="n">ClosedError</span><span class="p">):</span>
                <span class="n">run</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>

        <span class="n">runner</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">run_async</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">is_excepted</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">is_killed</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestWorkChainAbortChildren"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbortChildren">[docs]</a><span class="k">class</span> <span class="nc">TestWorkChainAbortChildren</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test the functionality to abort a workchain and verify that children</span>
<span class="sd">    are also aborted appropriately</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestWorkChainAbortChildren.setUp"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbortChildren.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestWorkChainAbortChildren</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">Process</span><span class="o">.</span><span class="n">current</span><span class="p">())</span></div>

<div class="viewcode-block" id="TestWorkChainAbortChildren.tearDown"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbortChildren.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestWorkChainAbortChildren</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">Process</span><span class="o">.</span><span class="n">current</span><span class="p">())</span></div>

<div class="viewcode-block" id="TestWorkChainAbortChildren.SubWorkChain"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbortChildren.SubWorkChain">[docs]</a>    <span class="k">class</span> <span class="nc">SubWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

<div class="viewcode-block" id="TestWorkChainAbortChildren.SubWorkChain.define"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbortChildren.SubWorkChain.define">[docs]</a>        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">TestWorkChainAbortChildren</span><span class="o">.</span><span class="n">SubWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;kill&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">begin</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">check</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkChainAbortChildren.SubWorkChain.begin"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbortChildren.SubWorkChain.begin">[docs]</a>        <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If the Main should be killed, pause the child to give the Main a chance to call kill on its children</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">kill</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestWorkChainAbortChildren.SubWorkChain.check"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbortChildren.SubWorkChain.check">[docs]</a>        <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;should have been aborted by now&#39;</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="TestWorkChainAbortChildren.MainWorkChain"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbortChildren.MainWorkChain">[docs]</a>    <span class="k">class</span> <span class="nc">MainWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

<div class="viewcode-block" id="TestWorkChainAbortChildren.MainWorkChain.define"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbortChildren.MainWorkChain.define">[docs]</a>        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">TestWorkChainAbortChildren</span><span class="o">.</span><span class="n">MainWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;kill&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">submit_child</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">check</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkChainAbortChildren.MainWorkChain.submit_child"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbortChildren.MainWorkChain.submit_child">[docs]</a>        <span class="k">def</span> <span class="nf">submit_child</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ToContext</span><span class="p">(</span><span class="n">child</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">TestWorkChainAbortChildren</span><span class="o">.</span><span class="n">SubWorkChain</span><span class="p">,</span> <span class="n">kill</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">kill</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestWorkChainAbortChildren.MainWorkChain.check"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbortChildren.MainWorkChain.check">[docs]</a>        <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;should have been aborted by now&#39;</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="TestWorkChainAbortChildren.test_simple_run"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbortChildren.test_simple_run">[docs]</a>    <span class="k">def</span> <span class="nf">test_simple_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the workchain which should hit the exception and therefore end</span>
<span class="sd">        up in the EXCEPTED state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">TestWorkChainAbortChildren</span><span class="o">.</span><span class="n">MainWorkChain</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">Capturing</span><span class="p">():</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
                <span class="n">run</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">is_excepted</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">is_killed</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkChainAbortChildren.test_simple_kill_through_process"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainAbortChildren.test_simple_kill_through_process">[docs]</a>    <span class="k">def</span> <span class="nf">test_simple_kill_through_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the workchain for one step and then kill it. This should have the</span>
<span class="sd">        workchain and its children end up in the KILLED state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="n">get_manager</span><span class="p">()</span><span class="o">.</span><span class="n">get_runner</span><span class="p">()</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">TestWorkChainAbortChildren</span><span class="o">.</span><span class="n">MainWorkChain</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;kill&#39;</span><span class="p">:</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">)})</span>

        <span class="nd">@gen</span><span class="o">.</span><span class="n">coroutine</span>
        <span class="k">def</span> <span class="nf">run_async</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">run_until_waiting</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>

            <span class="n">process</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">plumpy</span><span class="o">.</span><span class="n">KilledError</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">process</span><span class="o">.</span><span class="n">future</span><span class="p">()</span>

        <span class="n">runner</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">run_async</span><span class="p">())</span>

        <span class="n">child</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_outgoing</span><span class="p">(</span><span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">is_excepted</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">is_killed</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">is_excepted</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">is_killed</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestImmutableInputWorkchain"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestImmutableInputWorkchain">[docs]</a><span class="k">class</span> <span class="nc">TestImmutableInputWorkchain</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that inputs cannot be modified</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestImmutableInputWorkchain.setUp"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestImmutableInputWorkchain.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestImmutableInputWorkchain</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">Process</span><span class="o">.</span><span class="n">current</span><span class="p">())</span></div>

<div class="viewcode-block" id="TestImmutableInputWorkchain.tearDown"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestImmutableInputWorkchain.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestImmutableInputWorkchain</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">Process</span><span class="o">.</span><span class="n">current</span><span class="p">())</span></div>

<div class="viewcode-block" id="TestImmutableInputWorkchain.test_immutable_input"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestImmutableInputWorkchain.test_immutable_input">[docs]</a>    <span class="k">def</span> <span class="nf">test_immutable_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that from within the WorkChain self.inputs returns an AttributesFrozendict which should be immutable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">test_class</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">class</span> <span class="nc">Wf</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">Wf</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">Int</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">Int</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">step_one</span><span class="p">,</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">step_two</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">def</span> <span class="nf">step_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="c1"># Attempt to manipulate the inputs dictionary which since it is a AttributesFrozendict should raise</span>
                <span class="k">with</span> <span class="n">test_class</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">test_class</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">test_class</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">step_two</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="c1"># Verify that original inputs are still there with same value and no inputs were added</span>
                <span class="n">test_class</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
                <span class="n">test_class</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
                <span class="n">test_class</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
                <span class="n">test_class</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">run_and_check_success</span><span class="p">(</span><span class="n">Wf</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">b</span><span class="o">=</span><span class="n">Int</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestImmutableInputWorkchain.test_immutable_input_groups"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestImmutableInputWorkchain.test_immutable_input_groups">[docs]</a>    <span class="k">def</span> <span class="nf">test_immutable_input_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that namespaced inputs also return AttributeFrozendicts and are hence immutable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">test_class</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">class</span> <span class="nc">Wf</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">Wf</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">input_namespace</span><span class="p">(</span><span class="s1">&#39;subspace&#39;</span><span class="p">,</span> <span class="n">dynamic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">step_one</span><span class="p">,</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">step_two</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">def</span> <span class="nf">step_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="c1"># Attempt to manipulate the namespaced inputs dictionary which should raise</span>
                <span class="k">with</span> <span class="n">test_class</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">subspace</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">test_class</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">subspace</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;two&#39;</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">test_class</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">subspace</span><span class="p">[</span><span class="s1">&#39;four&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">step_two</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="c1"># Verify that original inputs are still there with same value and no inputs were added</span>
                <span class="n">test_class</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">subspace</span><span class="p">)</span>
                <span class="n">test_class</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">subspace</span><span class="p">)</span>
                <span class="n">test_class</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;four&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">subspace</span><span class="p">)</span>
                <span class="n">test_class</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">subspace</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">run_and_check_success</span><span class="p">(</span><span class="n">Wf</span><span class="p">,</span> <span class="n">subspace</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;one&#39;</span><span class="p">:</span> <span class="n">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;two&#39;</span><span class="p">:</span> <span class="n">Int</span><span class="p">(</span><span class="mi">2</span><span class="p">)})</span></div></div>


<div class="viewcode-block" id="SerializeWorkChain"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.SerializeWorkChain">[docs]</a><span class="k">class</span> <span class="nc">SerializeWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

<div class="viewcode-block" id="SerializeWorkChain.define"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.SerializeWorkChain.define">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SerializeWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span>
            <span class="s1">&#39;test&#39;</span><span class="p">,</span>
            <span class="n">valid_type</span><span class="o">=</span><span class="n">Str</span><span class="p">,</span>
            <span class="n">serializer</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Str</span><span class="p">(</span><span class="n">ObjectLoader</span><span class="p">()</span><span class="o">.</span><span class="n">identify_object</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">Str</span><span class="p">)</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">do_test</span><span class="p">)</span></div>

<div class="viewcode-block" id="SerializeWorkChain.do_test"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.SerializeWorkChain.do_test">[docs]</a>    <span class="k">def</span> <span class="nf">do_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">Str</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">test</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">reference</span></div></div>


<div class="viewcode-block" id="TestSerializeWorkChain"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestSerializeWorkChain">[docs]</a><span class="k">class</span> <span class="nc">TestSerializeWorkChain</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test workchains with serialized input / output.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestSerializeWorkChain.setUp"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestSerializeWorkChain.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestSerializeWorkChain</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">Process</span><span class="o">.</span><span class="n">current</span><span class="p">())</span></div>

<div class="viewcode-block" id="TestSerializeWorkChain.tearDown"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestSerializeWorkChain.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestSerializeWorkChain</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">Process</span><span class="o">.</span><span class="n">current</span><span class="p">())</span></div>

<div class="viewcode-block" id="TestSerializeWorkChain.test_serialize"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestSerializeWorkChain.test_serialize">[docs]</a>    <span class="k">def</span> <span class="nf">test_serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test a simple serialization of a class to its identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">run_and_check_success</span><span class="p">(</span><span class="n">SerializeWorkChain</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">Int</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="n">Str</span><span class="p">(</span><span class="n">ObjectLoader</span><span class="p">()</span><span class="o">.</span><span class="n">identify_object</span><span class="p">(</span><span class="n">Int</span><span class="p">)))</span></div>

<div class="viewcode-block" id="TestSerializeWorkChain.test_serialize_builder"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestSerializeWorkChain.test_serialize_builder">[docs]</a>    <span class="k">def</span> <span class="nf">test_serialize_builder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test serailization when using a builder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">SerializeWorkChain</span><span class="o">.</span><span class="n">get_builder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="n">Int</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">Str</span><span class="p">(</span><span class="n">ObjectLoader</span><span class="p">()</span><span class="o">.</span><span class="n">identify_object</span><span class="p">(</span><span class="n">Int</span><span class="p">))</span>
        <span class="n">run</span><span class="p">(</span><span class="n">builder</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="GrandParentExposeWorkChain"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.GrandParentExposeWorkChain">[docs]</a><span class="k">class</span> <span class="nc">GrandParentExposeWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

<div class="viewcode-block" id="GrandParentExposeWorkChain.define"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.GrandParentExposeWorkChain.define">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GrandParentExposeWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">expose_inputs</span><span class="p">(</span><span class="n">ParentExposeWorkChain</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;sub.sub&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">expose_outputs</span><span class="p">(</span><span class="n">ParentExposeWorkChain</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;sub.sub&#39;</span><span class="p">)</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">do_run</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">finalize</span><span class="p">)</span></div>

<div class="viewcode-block" id="GrandParentExposeWorkChain.do_run"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.GrandParentExposeWorkChain.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ToContext</span><span class="p">(</span>
            <span class="n">child</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">ParentExposeWorkChain</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">exposed_inputs</span><span class="p">(</span><span class="n">ParentExposeWorkChain</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;sub.sub&#39;</span><span class="p">)))</span></div>

<div class="viewcode-block" id="GrandParentExposeWorkChain.finalize"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.GrandParentExposeWorkChain.finalize">[docs]</a>    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_many</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposed_outputs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">child</span><span class="p">,</span> <span class="n">ParentExposeWorkChain</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;sub.sub&#39;</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="ParentExposeWorkChain"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.ParentExposeWorkChain">[docs]</a><span class="k">class</span> <span class="nc">ParentExposeWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

<div class="viewcode-block" id="ParentExposeWorkChain.define"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.ParentExposeWorkChain.define">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ParentExposeWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">expose_inputs</span><span class="p">(</span><span class="n">ChildExposeWorkChain</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">expose_inputs</span><span class="p">(</span>
            <span class="n">ChildExposeWorkChain</span><span class="p">,</span>
            <span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span>
            <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;sub_1&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">expose_inputs</span><span class="p">(</span>
            <span class="n">ChildExposeWorkChain</span><span class="p">,</span>
            <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">],</span>
            <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;sub_2&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">expose_inputs</span><span class="p">(</span>
            <span class="n">ChildExposeWorkChain</span><span class="p">,</span>
            <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">],</span>
            <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;sub_2.sub_3&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">expose_outputs</span><span class="p">(</span><span class="n">ChildExposeWorkChain</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">expose_outputs</span><span class="p">(</span><span class="n">ChildExposeWorkChain</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;sub_1&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">expose_outputs</span><span class="p">(</span><span class="n">ChildExposeWorkChain</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">],</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;sub_2&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">expose_outputs</span><span class="p">(</span><span class="n">ChildExposeWorkChain</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">],</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;sub_2.sub_3&#39;</span><span class="p">)</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">start_children</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">finalize</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParentExposeWorkChain.start_children"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.ParentExposeWorkChain.start_children">[docs]</a>    <span class="k">def</span> <span class="nf">start_children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">child_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
            <span class="n">ChildExposeWorkChain</span><span class="p">,</span>
            <span class="n">a</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exposed_inputs</span><span class="p">(</span><span class="n">ChildExposeWorkChain</span><span class="p">)[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">exposed_inputs</span><span class="p">(</span><span class="n">ChildExposeWorkChain</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;sub_1&#39;</span><span class="p">,</span> <span class="n">agglomerate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">child_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">ChildExposeWorkChain</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">exposed_inputs</span><span class="p">(</span>
            <span class="n">ChildExposeWorkChain</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;sub_2.sub_3&#39;</span><span class="p">,</span>
        <span class="p">))</span>
        <span class="k">return</span> <span class="n">ToContext</span><span class="p">(</span><span class="n">child_1</span><span class="o">=</span><span class="n">child_1</span><span class="p">,</span> <span class="n">child_2</span><span class="o">=</span><span class="n">child_2</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParentExposeWorkChain.finalize"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.ParentExposeWorkChain.finalize">[docs]</a>    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">exposed_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposed_outputs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">child_1</span><span class="p">,</span> <span class="n">ChildExposeWorkChain</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;sub_1&#39;</span><span class="p">,</span> <span class="n">agglomerate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_many</span><span class="p">(</span><span class="n">exposed_1</span><span class="p">)</span>
        <span class="n">exposed_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposed_outputs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">child_2</span><span class="p">,</span> <span class="n">ChildExposeWorkChain</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;sub_2.sub_3&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_many</span><span class="p">(</span><span class="n">exposed_2</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ChildExposeWorkChain"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.ChildExposeWorkChain">[docs]</a><span class="k">class</span> <span class="nc">ChildExposeWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

<div class="viewcode-block" id="ChildExposeWorkChain.define"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.ChildExposeWorkChain.define">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ChildExposeWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">Int</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">Float</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">Bool</span><span class="p">)</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">Float</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">Float</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">Bool</span><span class="p">)</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">do_run</span><span class="p">)</span></div>

<div class="viewcode-block" id="ChildExposeWorkChain.do_run"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.ChildExposeWorkChain.do_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">summed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">b</span>
        <span class="n">summed</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">summed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">c</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestWorkChainExpose"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainExpose">[docs]</a><span class="k">class</span> <span class="nc">TestWorkChainExpose</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test the expose inputs / outputs functionality</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestWorkChainExpose.test_expose"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainExpose.test_expose">[docs]</a>    <span class="k">def</span> <span class="nf">test_expose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span>
            <span class="n">ParentExposeWorkChain</span><span class="p">,</span>
            <span class="n">a</span><span class="o">=</span><span class="n">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">sub_1</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">Float</span><span class="p">(</span><span class="mf">2.3</span><span class="p">),</span>
                <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="n">sub_2</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">Float</span><span class="p">(</span><span class="mf">1.2</span><span class="p">),</span>
                <span class="s1">&#39;sub_3&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span>
            <span class="n">res</span><span class="p">,</span> <span class="p">{</span>
                <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">Float</span><span class="p">(</span><span class="mf">2.2</span><span class="p">),</span>
                <span class="s1">&#39;sub_1&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">Float</span><span class="p">(</span><span class="mf">2.3</span><span class="p">),</span>
                    <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">},</span>
                <span class="s1">&#39;sub_2&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">Float</span><span class="p">(</span><span class="mf">1.2</span><span class="p">),</span>
                    <span class="s1">&#39;sub_3&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">})</span></div>

<div class="viewcode-block" id="TestWorkChainExpose.test_nested_expose"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainExpose.test_nested_expose">[docs]</a>    <span class="nd">@unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;Reenable when issue #2515 is solved: references to deleted ORM instances&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_nested_expose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span>
            <span class="n">GrandParentExposeWorkChain</span><span class="p">,</span>
            <span class="n">sub</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">sub</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">a</span><span class="o">=</span><span class="n">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                    <span class="n">sub_1</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">Float</span><span class="p">(</span><span class="mf">2.3</span><span class="p">),</span>
                        <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="p">},</span>
                    <span class="n">sub_2</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">Float</span><span class="p">(</span><span class="mf">1.2</span><span class="p">),</span>
                        <span class="s1">&#39;sub_3&#39;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                        <span class="p">}</span>
                    <span class="p">},</span>
                <span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span>
            <span class="n">res</span><span class="p">,</span> <span class="p">{</span>
                <span class="s1">&#39;sub&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;sub&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">Float</span><span class="p">(</span><span class="mf">2.2</span><span class="p">),</span>
                        <span class="s1">&#39;sub_1&#39;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">Float</span><span class="p">(</span><span class="mf">2.3</span><span class="p">),</span>
                            <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                        <span class="p">},</span>
                        <span class="s1">&#39;sub_2&#39;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">Float</span><span class="p">(</span><span class="mf">1.2</span><span class="p">),</span>
                            <span class="s1">&#39;sub_3&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">})</span></div>

<div class="viewcode-block" id="TestWorkChainExpose.test_issue_1741_expose_inputs"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainExpose.test_issue_1741_expose_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">test_issue_1741_expose_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test that expose inputs works correctly when copying a stored default value&quot;&quot;&quot;</span>

        <span class="n">stored_a</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="k">class</span> <span class="nc">Parent</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">Parent</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">stored_a</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">step1</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">step1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">pass</span>

        <span class="k">class</span> <span class="nc">Child</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">Child</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">expose_inputs</span><span class="p">(</span><span class="n">Parent</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">step1</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">step1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">pass</span>

        <span class="n">run</span><span class="p">(</span><span class="n">Child</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestWorkChainMisc"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainMisc">[docs]</a><span class="k">class</span> <span class="nc">TestWorkChainMisc</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestWorkChainMisc.PointlessWorkChain"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainMisc.PointlessWorkChain">[docs]</a>    <span class="k">class</span> <span class="nc">PointlessWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

<div class="viewcode-block" id="TestWorkChainMisc.PointlessWorkChain.define"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainMisc.PointlessWorkChain.define">[docs]</a>        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">TestWorkChainMisc</span><span class="o">.</span><span class="n">PointlessWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">return_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkChainMisc.PointlessWorkChain.return_dict"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainMisc.PointlessWorkChain.return_dict">[docs]</a>        <span class="k">def</span> <span class="nf">return_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Only return a dictionary, which should be allowed, even though it accomplishes nothing.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">{}</span></div></div>

<div class="viewcode-block" id="TestWorkChainMisc.IllegalSubmitWorkChain"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainMisc.IllegalSubmitWorkChain">[docs]</a>    <span class="k">class</span> <span class="nc">IllegalSubmitWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

<div class="viewcode-block" id="TestWorkChainMisc.IllegalSubmitWorkChain.define"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainMisc.IllegalSubmitWorkChain.define">[docs]</a>        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">TestWorkChainMisc</span><span class="o">.</span><span class="n">IllegalSubmitWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">illegal_submit</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkChainMisc.IllegalSubmitWorkChain.illegal_submit"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainMisc.IllegalSubmitWorkChain.illegal_submit">[docs]</a>        <span class="k">def</span> <span class="nf">illegal_submit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Only return a dictionary, which should be allowed, even though it accomplishes nothing.&quot;&quot;&quot;</span>
            <span class="kn">from</span> <span class="nn">aiida.engine</span> <span class="k">import</span> <span class="n">submit</span>
            <span class="n">submit</span><span class="p">(</span><span class="n">TestWorkChainMisc</span><span class="o">.</span><span class="n">PointlessWorkChain</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="TestWorkChainMisc.test_run_pointless_workchain"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainMisc.test_run_pointless_workchain">[docs]</a>    <span class="k">def</span> <span class="nf">test_run_pointless_workchain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Running the pointless workchain should not incur any exceptions&quot;&quot;&quot;</span>
        <span class="n">run</span><span class="p">(</span><span class="n">TestWorkChainMisc</span><span class="o">.</span><span class="n">PointlessWorkChain</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestWorkChainMisc.test_global_submit_raises"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestWorkChainMisc.test_global_submit_raises">[docs]</a>    <span class="k">def</span> <span class="nf">test_global_submit_raises</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Using top-level submit should raise.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">InvalidOperation</span><span class="p">):</span>
            <span class="n">run</span><span class="p">(</span><span class="n">TestWorkChainMisc</span><span class="o">.</span><span class="n">IllegalSubmitWorkChain</span><span class="p">)</span></div></div>



<div class="viewcode-block" id="TestDefaultUniqueness"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestDefaultUniqueness">[docs]</a><span class="k">class</span> <span class="nc">TestDefaultUniqueness</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test that default inputs of exposed nodes will get unique UUIDS.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestDefaultUniqueness.Parent"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestDefaultUniqueness.Parent">[docs]</a>    <span class="k">class</span> <span class="nc">Parent</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

<div class="viewcode-block" id="TestDefaultUniqueness.Parent.define"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestDefaultUniqueness.Parent.define">[docs]</a>        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">TestDefaultUniqueness</span><span class="o">.</span><span class="n">Parent</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">expose_inputs</span><span class="p">(</span><span class="n">TestDefaultUniqueness</span><span class="o">.</span><span class="n">Child</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;child_one&#39;</span><span class="p">)</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">expose_inputs</span><span class="p">(</span><span class="n">TestDefaultUniqueness</span><span class="o">.</span><span class="n">Child</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;child_two&#39;</span><span class="p">)</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">do_run</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestDefaultUniqueness.Parent.do_run"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestDefaultUniqueness.Parent.do_run">[docs]</a>        <span class="k">def</span> <span class="nf">do_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposed_inputs</span><span class="p">(</span><span class="n">TestDefaultUniqueness</span><span class="o">.</span><span class="n">Child</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;child_one&#39;</span><span class="p">)</span>
            <span class="n">child_one</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">TestDefaultUniqueness</span><span class="o">.</span><span class="n">Child</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposed_inputs</span><span class="p">(</span><span class="n">TestDefaultUniqueness</span><span class="o">.</span><span class="n">Child</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;child_two&#39;</span><span class="p">)</span>
            <span class="n">child_two</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">TestDefaultUniqueness</span><span class="o">.</span><span class="n">Child</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ToContext</span><span class="p">(</span><span class="n">workchain_child_one</span><span class="o">=</span><span class="n">child_one</span><span class="p">,</span> <span class="n">workchain_child_two</span><span class="o">=</span><span class="n">child_two</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="TestDefaultUniqueness.Child"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestDefaultUniqueness.Child">[docs]</a>    <span class="k">class</span> <span class="nc">Child</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>

<div class="viewcode-block" id="TestDefaultUniqueness.Child.define"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestDefaultUniqueness.Child.define">[docs]</a>        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">TestDefaultUniqueness</span><span class="o">.</span><span class="n">Child</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">Bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestDefaultUniqueness.Child.run"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestDefaultUniqueness.Child.run">[docs]</a>        <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">pass</span></div></div>

<div class="viewcode-block" id="TestDefaultUniqueness.test_unique_default_inputs"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.tests.engine.html#aiida.backends.tests.engine.test_work_chain.TestDefaultUniqueness.test_unique_default_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">test_unique_default_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The default value for the Child will be constructed at import time, which will be an unstored Bool node with a</span>
<span class="sd">        given ID. When `expose_inputs` is called on the ProcessSpec of the Parent workchain, for the Child workchain,</span>
<span class="sd">        the ports of the Child will be deepcopied into the portnamespace of the Parent, in this case twice, into</span>
<span class="sd">        different namespaces. The port in each namespace will have a deepcopied version of the unstored Bool node. When</span>
<span class="sd">        the Parent workchain is now called without inputs, both those nodes will be stored and used as inputs, but they</span>
<span class="sd">        will have the same UUID, unless the deepcopy will have guaranteed that a new UUID is generated for unstored</span>
<span class="sd">        nodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;child_one&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;child_two&#39;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">node</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">TestDefaultUniqueness</span><span class="o">.</span><span class="n">Parent</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">)</span>

        <span class="n">nodes</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">()</span><span class="o">.</span><span class="n">all_nodes</span><span class="p">()</span>
        <span class="n">uuids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">])</span>

        <span class="c1"># Trying to load one of the inputs through the UUID should fail,</span>
        <span class="c1"># as both `child_one.a` and `child_two.a` should have the same UUID.</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">()</span><span class="o">.</span><span class="n">get_node_by_label</span><span class="p">(</span><span class="s1">&#39;child_one__a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">uuids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">),</span> <span class="s1">&#39;Only </span><span class="si">{}</span><span class="s1"> unique UUIDS for </span><span class="si">{}</span><span class="s1"> input nodes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uuids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)))</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>