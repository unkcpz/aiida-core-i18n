

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.backends.tests.test_nodes &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
          <li><a href="../tests.html">aiida.backends.tests</a> &raquo;</li>
        
      <li>aiida.backends.tests.test_nodes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.backends.tests.test_nodes</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="c1"># pylint: disable=too-many-lines,invalid-name,protected-access</span>
<span class="c1"># pylint: disable=missing-docstring,too-many-locals,too-many-statements</span>
<span class="c1"># pylint: disable=too-many-public-methods</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="nb">range</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="k">import</span> <span class="n">StatementError</span>

<span class="kn">from</span> <span class="nn">aiida</span> <span class="k">import</span> <span class="n">orm</span>
<span class="kn">from</span> <span class="nn">aiida.backends.testbase</span> <span class="k">import</span> <span class="n">AiidaTestCase</span>
<span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">InvalidOperation</span><span class="p">,</span> <span class="n">ModificationNotAllowed</span><span class="p">,</span> <span class="n">StoringNotAllowed</span>
<span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>
<span class="kn">from</span> <span class="nn">aiida.common.utils</span> <span class="k">import</span> <span class="n">Capturing</span>
<span class="kn">from</span> <span class="nn">aiida.manage.database.delete.nodes</span> <span class="k">import</span> <span class="n">delete_nodes</span>


<div class="viewcode-block" id="TestNodeIsStorable"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeIsStorable">[docs]</a><span class="k">class</span> <span class="nc">TestNodeIsStorable</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test if one can store specific Node subclasses, and that Node and</span>
<span class="sd">    ProcessType are not storable, intead.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestNodeIsStorable.test_storable_unstorable"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeIsStorable.test_storable_unstorable">[docs]</a>    <span class="k">def</span> <span class="nf">test_storable_unstorable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test storability of Nodes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">StoringNotAllowed</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">process</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">ProcessNode</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">StoringNotAllowed</span><span class="p">):</span>
            <span class="n">process</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># These below should be allowed instead</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">calc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">work</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span>
        <span class="n">work</span><span class="o">.</span><span class="n">store</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="TestNodeCopyDeepcopy"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeCopyDeepcopy">[docs]</a><span class="k">class</span> <span class="nc">TestNodeCopyDeepcopy</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test that calling copy and deepcopy on a Node does the right thing.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestNodeCopyDeepcopy.test_copy_not_supported"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeCopyDeepcopy.test_copy_not_supported">[docs]</a>    <span class="k">def</span> <span class="nf">test_copy_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copying a base Node instance is not supported.&quot;&quot;&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">InvalidOperation</span><span class="p">):</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">node</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeCopyDeepcopy.test_deepcopy_not_supported"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeCopyDeepcopy.test_deepcopy_not_supported">[docs]</a>    <span class="k">def</span> <span class="nf">test_deepcopy_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deep copying a base Node instance is not supported.&quot;&quot;&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">InvalidOperation</span><span class="p">):</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">node</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestNodeHashing"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeHashing">[docs]</a><span class="k">class</span> <span class="nc">TestNodeHashing</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests the functionality of hashing a node</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestNodeHashing.create_simple_node"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeHashing.create_simple_node">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_simple_node</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">n</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">n</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n</span></div>

<div class="viewcode-block" id="TestNodeHashing.test_simple_equal_nodes"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeHashing.test_simple_equal_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">test_simple_equal_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">),</span> <span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="s1">&#39;d&#39;</span><span class="p">},</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">})]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_simple_node</span><span class="p">(</span><span class="o">*</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_simple_node</span><span class="p">(</span><span class="o">*</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">n1</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">n2</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">n1</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">n2</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;_aiida_cached_from&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestNodeHashing.test_node_uuid_hashing_for_querybuidler"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeHashing.test_node_uuid_hashing_for_querybuidler">[docs]</a>    <span class="k">def</span> <span class="nf">test_node_uuid_hashing_for_querybuidler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        QueryBuilder results should be reusable and shouldn&#39;t brake hashing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Search for the UUID of the stored node</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">],</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;==&#39;</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">id</span><span class="p">}})</span>
        <span class="p">[</span><span class="n">uuid</span><span class="p">]</span> <span class="o">=</span> <span class="n">qb</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="c1"># Look the node with the previously returned UUID</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;uuid&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;==&#39;</span><span class="p">:</span> <span class="n">uuid</span><span class="p">}})</span>

        <span class="c1"># Check that the query doesn&#39;t fail</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="c1"># And that the results are correct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeHashing.create_folderdata_with_empty_file"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeHashing.create_folderdata_with_empty_file">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_folderdata_with_empty_file</span><span class="p">():</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">FolderData</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">put_object_from_filelike</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s1">&#39;path/name&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span></div>

<div class="viewcode-block" id="TestNodeHashing.create_folderdata_with_empty_folder"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeHashing.create_folderdata_with_empty_folder">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_folderdata_with_empty_folder</span><span class="p">():</span>
        <span class="n">dirpath</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">FolderData</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">put_object_from_tree</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="s1">&#39;path/name&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span></div>

<div class="viewcode-block" id="TestNodeHashing.test_folder_file_different"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeHashing.test_folder_file_different">[docs]</a>    <span class="k">def</span> <span class="nf">test_folder_file_different</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_folderdata_with_empty_file</span><span class="p">()</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_folderdata_with_empty_folder</span><span class="p">()</span>

        <span class="k">assert</span> <span class="p">(</span><span class="n">f1</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">f2</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">f1</span><span class="o">.</span><span class="n">get_hash</span><span class="p">()</span> <span class="o">!=</span> <span class="n">f2</span><span class="o">.</span><span class="n">get_hash</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestNodeHashing.test_folder_same"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeHashing.test_folder_same">[docs]</a>    <span class="k">def</span> <span class="nf">test_folder_same</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_folderdata_with_empty_folder</span><span class="p">()</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_folderdata_with_empty_folder</span><span class="p">()</span>
        <span class="n">f1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">f2</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">f1</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">f2</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;_aiida_cached_from&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeHashing.test_file_same"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeHashing.test_file_same">[docs]</a>    <span class="k">def</span> <span class="nf">test_file_same</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_folderdata_with_empty_file</span><span class="p">()</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_folderdata_with_empty_file</span><span class="p">()</span>
        <span class="n">f1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">f2</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">f1</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">f2</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;_aiida_cached_from&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeHashing.test_simple_unequal_nodes"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeHashing.test_simple_unequal_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">test_simple_unequal_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">),</span> <span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)],</span>
            <span class="p">[(</span><span class="mf">1e-14</span><span class="p">,),</span> <span class="p">(</span><span class="mf">2e-14</span><span class="p">,)],</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">attr1</span><span class="p">,</span> <span class="n">attr2</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_simple_node</span><span class="p">(</span><span class="o">*</span><span class="n">attr1</span><span class="p">)</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_simple_node</span><span class="p">(</span><span class="o">*</span><span class="n">attr2</span><span class="p">)</span>
            <span class="n">n1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
            <span class="n">n2</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEquals</span><span class="p">(</span><span class="n">n1</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">n2</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="s1">&#39;_aiida_cached_from&#39;</span> <span class="ow">in</span> <span class="n">n2</span><span class="o">.</span><span class="n">extras</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeHashing.test_unequal_arrays"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeHashing.test_unequal_arrays">[docs]</a>    <span class="k">def</span> <span class="nf">test_unequal_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="n">arrays</span> <span class="o">=</span> <span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1001</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1005</span><span class="p">)),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]))]</span>

        <span class="k">def</span> <span class="nf">create_arraydata</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">ArrayData</span><span class="p">()</span>
            <span class="n">a</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">a</span>

        <span class="k">for</span> <span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span> <span class="ow">in</span> <span class="n">arrays</span><span class="p">:</span>
            <span class="n">a1</span> <span class="o">=</span> <span class="n">create_arraydata</span><span class="p">(</span><span class="n">arr1</span><span class="p">)</span>
            <span class="n">a1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
            <span class="n">a2</span> <span class="o">=</span> <span class="n">create_arraydata</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span>
            <span class="n">a2</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEquals</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="s1">&#39;_aiida_cached_from&#39;</span> <span class="ow">in</span> <span class="n">a2</span><span class="o">.</span><span class="n">extras</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeHashing.test_updatable_attributes"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeHashing.test_updatable_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">test_updatable_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests that updatable attributes are ignored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">ProcessNode</span><span class="p">()</span>
        <span class="n">hash1</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_hash</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">set_process_state</span><span class="p">(</span><span class="s1">&#39;finished&#39;</span><span class="p">)</span>
        <span class="n">hash2</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_hash</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEquals</span><span class="p">(</span><span class="n">hash1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">hash1</span><span class="p">,</span> <span class="n">hash2</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestTransitiveNoLoops"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestTransitiveNoLoops">[docs]</a><span class="k">class</span> <span class="nc">TestTransitiveNoLoops</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test the transitive closure functionality</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestTransitiveNoLoops.test_loop_not_allowed"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestTransitiveNoLoops.test_loop_not_allowed">[docs]</a>    <span class="k">def</span> <span class="nf">test_loop_not_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>

        <span class="n">c1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>
        <span class="n">c1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">d2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>  <span class="c1"># This would generate a loop</span>
            <span class="n">d1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestTypes"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestTypes">[docs]</a><span class="k">class</span> <span class="nc">TestTypes</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generic test class to test types</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestTypes.test_uuid_type"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestTypes.test_uuid_type">[docs]</a>    <span class="k">def</span> <span class="nf">test_uuid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checking whether the UUID is returned as a string. In old implementations it was returned as uuid type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="TestQueryWithAiidaObjects"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestQueryWithAiidaObjects">[docs]</a><span class="k">class</span> <span class="nc">TestQueryWithAiidaObjects</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test if queries work properly also with aiida.orm.Node classes instead of</span>
<span class="sd">    aiida.backends.djsite.db.models.DbNode objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestQueryWithAiidaObjects.test_with_subclasses"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestQueryWithAiidaObjects.test_with_subclasses">[docs]</a>    <span class="k">def</span> <span class="nf">test_with_subclasses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">aiida.plugins</span> <span class="k">import</span> <span class="n">DataFactory</span>

        <span class="n">extra_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;/test_with_subclasses&quot;</span>

        <span class="n">Dict</span> <span class="o">=</span> <span class="n">DataFactory</span><span class="p">(</span><span class="s1">&#39;dict&#39;</span><span class="p">)</span>

        <span class="n">a1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">(</span><span class="n">computer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;num_machines&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;num_mpiprocs_per_machine&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">a1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="c1"># To query only these nodes later</span>
        <span class="n">a1</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="n">extra_name</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">a3</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">a3</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="n">extra_name</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">a4</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="s1">&#39;b&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">a4</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="n">extra_name</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># I don&#39;t set the extras, just to be sure that the filtering works</span>
        <span class="c1"># The filtering is needed because other tests will put stuff int he DB</span>
        <span class="n">a6</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">(</span><span class="n">computer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">)</span>
        <span class="n">a6</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;num_machines&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;num_mpiprocs_per_machine&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">a1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">a7</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">a7</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Query by calculation</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;extras&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;has_key&#39;</span><span class="p">:</span> <span class="n">extra_name</span><span class="p">}})</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span> <span class="k">for</span> <span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
        <span class="c1"># a3, a4 should not be found because they are not CalcJobNodes.</span>
        <span class="c1"># a6, a7 should not be found because they have not the attribute set.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">pk</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]),</span> <span class="nb">set</span><span class="p">([</span><span class="n">a1</span><span class="o">.</span><span class="n">pk</span><span class="p">]))</span>

        <span class="c1"># Same query, but by the generic Node class</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;extras&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;has_key&#39;</span><span class="p">:</span> <span class="n">extra_name</span><span class="p">}})</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span> <span class="k">for</span> <span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">pk</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]),</span> <span class="nb">set</span><span class="p">([</span><span class="n">a1</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">a3</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">a4</span><span class="o">.</span><span class="n">pk</span><span class="p">]))</span>

        <span class="c1"># Same query, but by the Data class</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;extras&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;has_key&#39;</span><span class="p">:</span> <span class="n">extra_name</span><span class="p">}})</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span> <span class="k">for</span> <span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">pk</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]),</span> <span class="nb">set</span><span class="p">([</span><span class="n">a3</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">a4</span><span class="o">.</span><span class="n">pk</span><span class="p">]))</span>

        <span class="c1"># Same query, but by the Dict subclass</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;extras&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;has_key&#39;</span><span class="p">:</span> <span class="n">extra_name</span><span class="p">}})</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span> <span class="k">for</span> <span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">pk</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]),</span> <span class="nb">set</span><span class="p">([</span><span class="n">a4</span><span class="o">.</span><span class="n">pk</span><span class="p">]))</span></div></div>


<div class="viewcode-block" id="TestNodeBasic"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic">[docs]</a><span class="k">class</span> <span class="nc">TestNodeBasic</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    These tests check the basic features of nodes</span>
<span class="sd">    (setting of attributes, copying of files, ...)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">boolval</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">intval</span> <span class="o">=</span> <span class="mi">123</span>
    <span class="n">floatval</span> <span class="o">=</span> <span class="mf">4.56</span>
    <span class="n">stringval</span> <span class="o">=</span> <span class="s2">&quot;aaaa&quot;</span>
    <span class="c1"># A recursive dictionary</span>
    <span class="n">dictval</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;num&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s1">&#39;something&#39;</span><span class="p">:</span> <span class="s1">&#39;else&#39;</span><span class="p">,</span>
        <span class="s1">&#39;emptydict&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;recursive&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span>
            <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
            <span class="s1">&#39;e&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span>
                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;xx&#39;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s1">&#39;yy&#39;</span><span class="p">:</span> <span class="p">[]</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">listval</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">emptydict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">emptylist</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="TestNodeBasic.test_uuid_uniquess"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_uuid_uniquess">[docs]</a>    <span class="k">def</span> <span class="nf">test_uuid_uniquess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A uniqueness constraint on the UUID column of the Node model should prevent multiple nodes with identical UUID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">DjIntegrityError</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="k">import</span> <span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">SqlaIntegrityError</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">b</span><span class="o">.</span><span class="n">backend_entity</span><span class="o">.</span><span class="n">dbmodel</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">uuid</span>
        <span class="n">a</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">((</span><span class="n">DjIntegrityError</span><span class="p">,</span> <span class="n">SqlaIntegrityError</span><span class="p">)):</span>
            <span class="n">b</span><span class="o">.</span><span class="n">store</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_attribute_mutability"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_attribute_mutability">[docs]</a>    <span class="k">def</span> <span class="nf">test_attribute_mutability</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attributes of a node should be immutable after storing, unless the stored_check is</span>
<span class="sd">        disabled in the call</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boolval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># After storing attributes should now be immutable</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ModificationNotAllowed</span><span class="p">):</span>
            <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ModificationNotAllowed</span><span class="p">):</span>
            <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intval</span><span class="p">)</span>

        <span class="c1"># Passing stored_check=False should disable the mutability check</span>
        <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="n">stored_check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intval</span><span class="p">,</span> <span class="n">stored_check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">intval</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_attr_before_storing"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_attr_before_storing">[docs]</a>    <span class="k">def</span> <span class="nf">test_attr_before_storing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boolval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k2&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k3&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">floatval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k4&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stringval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k5&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k6&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">listval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k7&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emptydict</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k8&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emptylist</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k9&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Now I check if I can retrieve them, before the storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boolval</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;k1&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intval</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;k2&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">floatval</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;k3&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stringval</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;k4&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dictval</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;k5&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listval</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;k6&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emptydict</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;k7&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emptylist</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;k8&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;k9&#39;</span><span class="p">))</span>

        <span class="c1"># And now I try to delete the keys</span>
        <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;k1&#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;k2&#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;k3&#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;k4&#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;k5&#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;k6&#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;k7&#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;k8&#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;k9&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
            <span class="c1"># I delete twice the same attribute</span>
            <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;k1&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
            <span class="c1"># I delete a non-existing attribute</span>
            <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;nonexisting&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
            <span class="c1"># I get a deleted attribute</span>
            <span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;k1&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
            <span class="c1"># I get a non-existing attribute</span>
            <span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;nonexisting&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_get_attrs_before_storing"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_get_attrs_before_storing">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_attrs_before_storing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boolval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k2&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k3&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">floatval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k4&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stringval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k5&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k6&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">listval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k7&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emptydict</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k8&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emptylist</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k9&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">target_attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;k1&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">boolval</span><span class="p">,</span>
            <span class="s1">&#39;k2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intval</span><span class="p">,</span>
            <span class="s1">&#39;k3&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">floatval</span><span class="p">,</span>
            <span class="s1">&#39;k4&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stringval</span><span class="p">,</span>
            <span class="s1">&#39;k5&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictval</span><span class="p">,</span>
            <span class="s1">&#39;k6&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">listval</span><span class="p">,</span>
            <span class="s1">&#39;k7&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">emptydict</span><span class="p">,</span>
            <span class="s1">&#39;k8&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">emptylist</span><span class="p">,</span>
            <span class="s1">&#39;k9&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>

        <span class="c1"># Now I check if I can retrieve them, before the storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span> <span class="n">target_attrs</span><span class="p">)</span>

        <span class="c1"># And now I try to delete the keys</span>
        <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;k1&#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;k2&#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;k3&#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;k4&#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;k5&#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;k6&#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;k7&#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;k8&#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">delete_attribute</span><span class="p">(</span><span class="s1">&#39;k9&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span> <span class="p">{})</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_get_attrs_after_storing"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_get_attrs_after_storing">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_attrs_after_storing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boolval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k2&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k3&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">floatval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k4&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stringval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k5&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k6&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">listval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k7&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emptydict</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k8&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emptylist</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;k9&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">a</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">target_attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;k1&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">boolval</span><span class="p">,</span>
            <span class="s1">&#39;k2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intval</span><span class="p">,</span>
            <span class="s1">&#39;k3&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">floatval</span><span class="p">,</span>
            <span class="s1">&#39;k4&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stringval</span><span class="p">,</span>
            <span class="s1">&#39;k5&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictval</span><span class="p">,</span>
            <span class="s1">&#39;k6&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">listval</span><span class="p">,</span>
            <span class="s1">&#39;k7&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">emptydict</span><span class="p">,</span>
            <span class="s1">&#39;k8&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">emptylist</span><span class="p">,</span>
            <span class="s1">&#39;k9&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>

        <span class="c1"># Now I check if I can retrieve them, before the storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span> <span class="n">target_attrs</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_store_object"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_store_object">[docs]</a>    <span class="k">def</span> <span class="nf">test_store_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Trying to store objects should fail&quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="nb">object</span><span class="p">(),</span> <span class="n">clean</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># django raises ValueError</span>
        <span class="c1"># sqlalchemy raises StatementError</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">((</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">StatementError</span><span class="p">)):</span>
            <span class="n">a</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">b</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;object_list&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nb">object</span><span class="p">(),</span> <span class="nb">object</span><span class="p">()],</span> <span class="n">clean</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">((</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">StatementError</span><span class="p">)):</span>
            <span class="c1"># objects are not json-serializable</span>
            <span class="n">b</span><span class="o">.</span><span class="n">store</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_append_to_empty_attr"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_append_to_empty_attr">[docs]</a>    <span class="k">def</span> <span class="nf">test_append_to_empty_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appending to an empty attribute&quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">a</span><span class="o">.</span><span class="n">append_to_attr</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">append_to_attr</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_append_no_side_effects"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_append_no_side_effects">[docs]</a>    <span class="k">def</span> <span class="nf">test_append_no_side_effects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that append_to_attr has no side effects&quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">mylist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="n">mylist</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">append_to_attr</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">mylist</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_datetime_attribute"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_datetime_attribute">[docs]</a>    <span class="k">def</span> <span class="nf">test_datetime_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">aiida.common.timezone</span> <span class="k">import</span> <span class="p">(</span><span class="n">get_current_timezone</span><span class="p">,</span> <span class="n">is_naive</span><span class="p">,</span> <span class="n">make_aware</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>

        <span class="n">date</span> <span class="o">=</span> <span class="n">now</span><span class="p">()</span>

        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;some_date&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">retrieved</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;some_date&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_naive</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
            <span class="n">date_to_compare</span> <span class="o">=</span> <span class="n">make_aware</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">get_current_timezone</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">date_to_compare</span> <span class="o">=</span> <span class="n">date</span>

        <span class="c1"># Do not compare microseconds (they are not stored in the case of MySQL)</span>
        <span class="n">date_to_compare</span> <span class="o">=</span> <span class="n">date_to_compare</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">retrieved</span> <span class="o">=</span> <span class="n">retrieved</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">date_to_compare</span><span class="p">,</span> <span class="n">retrieved</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_attributes_on_clone"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_attributes_on_clone">[docs]</a>    <span class="k">def</span> <span class="nf">test_attributes_on_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">copy</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">attrs_to_set</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;none&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;bool&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">boolval</span><span class="p">,</span>
            <span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intval</span><span class="p">,</span>
            <span class="s1">&#39;float&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">floatval</span><span class="p">,</span>
            <span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stringval</span><span class="p">,</span>
            <span class="s1">&#39;dict&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictval</span><span class="p">,</span>
            <span class="s1">&#39;list&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">listval</span><span class="p">,</span>
            <span class="s1">&#39;emptydict&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;emptylist&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs_to_set</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="c1"># Create a copy</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="c1"># I modify an attribute and add a new one; I mirror it in the dictionary</span>
        <span class="c1"># for later checking</span>
        <span class="n">b_expected_attributes</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">attrs_to_set</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="mi">489</span><span class="p">)</span>
        <span class="n">b_expected_attributes</span><span class="p">[</span><span class="s1">&#39;integer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">489</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="s1">&#39;cvb&#39;</span><span class="p">)</span>
        <span class="n">b_expected_attributes</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cvb&#39;</span>

        <span class="c1"># I check before storing that the attributes are ok</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span> <span class="n">b_expected_attributes</span><span class="p">)</span>
        <span class="c1"># Note that during copy, I do not copy the extras!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="p">{})</span>

        <span class="c1"># I store now</span>
        <span class="n">b</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="c1"># and I finally add a extras</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="s1">&#39;textofext&#39;</span><span class="p">)</span>
        <span class="n">b_expected_extras</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;meta&#39;</span><span class="p">:</span> <span class="s1">&#39;textofext&#39;</span><span class="p">,</span> <span class="s1">&#39;_aiida_hash&#39;</span><span class="p">:</span> <span class="n">AnyValue</span><span class="p">()}</span>

        <span class="c1"># Now I check that the attributes of the original node have not changed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">attrs_to_set</span><span class="p">)</span>

        <span class="c1"># I check then on the &#39;b&#39; copy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">b_expected_attributes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">b_expected_extras</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_files"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_files">[docs]</a>    <span class="k">def</span> <span class="nf">test_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>

        <span class="n">file_content</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;some text ABCDE&#39;</span>
        <span class="n">file_content_different</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;other values 12345&#39;</span>

        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">a</span><span class="o">.</span><span class="n">put_object_from_file</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;file1.txt&#39;</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">put_object_from_file</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">()),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">]))</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">fhandle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;file2.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">fhandle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>

        <span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="c1"># Check that the content is there</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">()),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">]))</span>
        <span class="k">with</span> <span class="n">b</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">b</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;file2.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>

        <span class="c1"># I overwrite a file and create a new one in the clone only</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content_different</span><span class="p">)</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">b</span><span class="o">.</span><span class="n">put_object_from_file</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">put_object_from_file</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;file3.txt&#39;</span><span class="p">)</span>

        <span class="c1"># I check the new content, and that the old one has not changed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">()),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">]))</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;file2.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">()),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;file3.txt&#39;</span><span class="p">]))</span>
        <span class="k">with</span> <span class="n">b</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">b</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;file2.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content_different</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">b</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;file3.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content_different</span><span class="p">)</span>

        <span class="c1"># This should in principle change the location of the files,</span>
        <span class="c1"># so I recheck</span>
        <span class="n">a</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># I now clone after storing</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="c1"># I overwrite a file and create a new one in the clone only</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content_different</span><span class="p">)</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">put_object_from_file</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;file1.txt&#39;</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">put_object_from_file</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;file4.txt&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">()),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">]))</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;file2.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">()),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;file4.txt&#39;</span><span class="p">]))</span>
        <span class="k">with</span> <span class="n">c</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content_different</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">c</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;file2.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">c</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;file4.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content_different</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_folders"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_folders">[docs]</a>    <span class="k">def</span> <span class="nf">test_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Similar as test_files, but I manipulate a tree of folders</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">shutil</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">import</span> <span class="nn">string</span>
        <span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="n">StringIO</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>

        <span class="c1"># Since Node uses the same method of Folder(),</span>
        <span class="c1"># for this test I create a test folder by hand</span>
        <span class="c1"># For any non-test usage, use SandboxFolder()!</span>

        <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp_try&#39;</span><span class="p">))</span>
        <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">)):</span>
            <span class="c1"># I append a random letter/number until it is unique</span>
            <span class="n">directory</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>

        <span class="c1"># create a folder structure to copy around</span>
        <span class="n">tree_1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;tree_1&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tree_1</span><span class="p">)</span>
        <span class="n">file_content</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;some text ABCDE&#39;</span>
        <span class="n">file_content_different</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;other values 12345&#39;</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tree_1</span><span class="p">,</span> <span class="s1">&#39;file1.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="n">fhandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tree_1</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tree_1</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">,</span> <span class="s1">&#39;dir2&#39;</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tree_1</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="n">fhandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tree_1</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">,</span> <span class="s1">&#39;dir2&#39;</span><span class="p">,</span> <span class="s1">&#39;dir3&#39;</span><span class="p">))</span>

        <span class="c1"># add the tree to the node</span>
        <span class="n">a</span><span class="o">.</span><span class="n">put_object_from_tree</span><span class="p">(</span><span class="n">tree_1</span><span class="p">,</span> <span class="s1">&#39;tree_1&#39;</span><span class="p">)</span>

        <span class="c1"># verify if the node has the structure I expect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">()),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;tree_1&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">)),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">))),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;dir2&#39;</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">]))</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;file1.txt&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">fhandle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">fhandle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>

        <span class="c1"># try to exit from the folder</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">a</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>

        <span class="c1"># clone into a new node</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="c1"># Check that the content is there</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;tree_1&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">)),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">))),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;dir2&#39;</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">]))</span>
        <span class="k">with</span> <span class="n">b</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;file1.txt&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">fhandle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">b</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">fhandle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>

        <span class="c1"># I overwrite a file and create a new one in the copy only</span>
        <span class="n">dir3</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;dir3&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dir3</span><span class="p">)</span>

        <span class="n">b</span><span class="o">.</span><span class="n">put_object_from_tree</span><span class="p">(</span><span class="n">dir3</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;dir3&#39;</span><span class="p">))</span>
        <span class="c1"># no absolute path here</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">b</span><span class="o">.</span><span class="n">put_object_from_tree</span><span class="p">(</span><span class="s1">&#39;dir3&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;dir3&#39;</span><span class="p">))</span>

        <span class="n">stream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">file_content_different</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">put_object_from_filelike</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s1">&#39;file3.txt&#39;</span><span class="p">)</span>

        <span class="c1"># I check the new content, and that the old one has not changed old</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;tree_1&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">)),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">))),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;dir2&#39;</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">]))</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;file1.txt&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">fhandle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">fhandle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>
        <span class="c1"># new</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;file3.txt&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">)),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">,</span> <span class="s1">&#39;dir3&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">))),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;dir2&#39;</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">]))</span>
        <span class="k">with</span> <span class="n">b</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;file1.txt&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">fhandle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">b</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">fhandle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>

        <span class="c1"># This should in principle change the location of the files, so I recheck</span>
        <span class="n">a</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># I now copy after storing</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="c1"># I overwrite a file, create a new one and remove a directory</span>
        <span class="c1"># in the copy only</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">file_content_different</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">put_object_from_filelike</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;file1.txt&#39;</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">put_object_from_filelike</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">,</span> <span class="s1">&#39;file4.txt&#39;</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">delete_object</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">,</span> <span class="s1">&#39;dir2&#39;</span><span class="p">))</span>

        <span class="c1"># check old</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;tree_1&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">)),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">))),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;dir2&#39;</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">]))</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;file1.txt&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">fhandle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">a</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">fhandle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>

        <span class="c1"># check new</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;tree_1&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">)),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">list_object_names</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">))),</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;file2.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;file4.txt&#39;</span><span class="p">]))</span>
        <span class="k">with</span> <span class="n">c</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;file1.txt&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">fhandle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content_different</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">c</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tree_1&#39;</span><span class="p">,</span> <span class="s1">&#39;dir1&#39;</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">fhandle</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">file_content</span><span class="p">)</span>

        <span class="c1"># garbage cleaning</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_attr_after_storing"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_attr_after_storing">[docs]</a>    <span class="k">def</span> <span class="nf">test_attr_after_storing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boolval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">floatval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stringval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;dict&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">listval</span><span class="p">)</span>

        <span class="n">a</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Now I check if I can retrieve them, before the storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boolval</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intval</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">floatval</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stringval</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dictval</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;dict&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listval</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_attr_with_reload"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_attr_with_reload">[docs]</a>    <span class="k">def</span> <span class="nf">test_attr_with_reload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boolval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">floatval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stringval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;dict&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">listval</span><span class="p">)</span>

        <span class="n">a</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">b</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boolval</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intval</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">floatval</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stringval</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dictval</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;dict&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listval</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">))</span>

        <span class="c1"># Reload directly</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="n">from_backend_entity</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">backend_entity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boolval</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intval</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">floatval</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stringval</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dictval</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;dict&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listval</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_attr_and_extras"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_attr_and_extras">[docs]</a>    <span class="k">def</span> <span class="nf">test_attr_and_extras</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boolval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">floatval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stringval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;dict&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictval</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">listval</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ModificationNotAllowed</span><span class="p">):</span>
            <span class="c1"># I did not store, I cannot modify</span>
            <span class="n">a</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="s1">&#39;blablabla&#39;</span><span class="p">)</span>

        <span class="n">a</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">a_string</span> <span class="o">=</span> <span class="s1">&#39;some non-boolean value&#39;</span>
        <span class="c1"># I now set an extra with the same name of an attr</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="n">a_string</span><span class="p">)</span>
        <span class="c1"># and I check that there is no name clash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boolval</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a_string</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">extras</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;bool&#39;</span><span class="p">:</span> <span class="n">a_string</span><span class="p">,</span> <span class="s1">&#39;_aiida_hash&#39;</span><span class="p">:</span> <span class="n">AnyValue</span><span class="p">()})</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_get_extras_with_default"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_get_extras_with_default">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_extras_with_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">a</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">a</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;def&#39;</span><span class="p">),</span> <span class="s1">&#39;def&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_attr_and_extras_multikey"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_attr_and_extras_multikey">[docs]</a>    <span class="k">def</span> <span class="nf">test_attr_and_extras_multikey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Multiple nodes with the same key. This should not be a problem</span>

<span class="sd">        I test only extras because the two tables are formally identical</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">n1</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="s1">&#39;samename&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># No problem, they are two different nodes</span>
        <span class="n">n2</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="s1">&#39;samename&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_settings_methods"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_settings_methods">[docs]</a>    <span class="k">def</span> <span class="nf">test_settings_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">aiida.backends.utils</span> <span class="k">import</span> <span class="p">(</span><span class="n">get_global_setting_description</span><span class="p">,</span> <span class="n">get_global_setting</span><span class="p">,</span> <span class="n">set_global_setting</span><span class="p">,</span>
                                          <span class="n">del_global_setting</span><span class="p">)</span>

        <span class="n">set_global_setting</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;aaa&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="s1">&#39;c&#39;</span><span class="p">},</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;pippo&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">get_global_setting</span><span class="p">(</span><span class="s1">&#39;aaa&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="s1">&#39;c&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">get_global_setting_description</span><span class="p">(</span><span class="s1">&#39;aaa&#39;</span><span class="p">),</span> <span class="s2">&quot;pippo&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">get_global_setting</span><span class="p">(</span><span class="s1">&#39;aaa.b&#39;</span><span class="p">),</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span>

        <span class="c1"># The following is disabled because it is not supported in SQLAlchemy</span>
        <span class="c1"># Only top level elements can have descriptions</span>
        <span class="c1"># self.assertEqual(get_global_setting_description(&#39;aaa.b&#39;), &quot;&quot;)</span>

        <span class="n">del_global_setting</span><span class="p">(</span><span class="s1">&#39;aaa&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
            <span class="n">get_global_setting</span><span class="p">(</span><span class="s1">&#39;aaa.b&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
            <span class="n">get_global_setting</span><span class="p">(</span><span class="s1">&#39;aaa&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_attr_listing"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_attr_listing">[docs]</a>    <span class="k">def</span> <span class="nf">test_attr_listing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks that the list of attributes and extras is ok.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">attrs_to_set</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;none&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;bool&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">boolval</span><span class="p">,</span>
            <span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intval</span><span class="p">,</span>
            <span class="s1">&#39;float&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">floatval</span><span class="p">,</span>
            <span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stringval</span><span class="p">,</span>
            <span class="s1">&#39;dict&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictval</span><span class="p">,</span>
            <span class="s1">&#39;list&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">listval</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs_to_set</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="n">a</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># I now set extras</span>
        <span class="n">extras_to_set</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bool&#39;</span><span class="p">:</span> <span class="s1">&#39;some non-boolean value&#39;</span><span class="p">,</span> <span class="s1">&#39;some_other_name&#39;</span><span class="p">:</span> <span class="mi">987</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">extras_to_set</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">a</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="n">all_extras</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_aiida_hash</span><span class="o">=</span><span class="n">AnyValue</span><span class="p">(),</span> <span class="o">**</span><span class="n">extras_to_set</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span> <span class="nb">set</span><span class="p">(</span><span class="n">attrs_to_set</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_extras</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span> <span class="n">attrs_to_set</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">extras</span><span class="p">,</span> <span class="n">all_extras</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_versioning"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_versioning">[docs]</a>    <span class="k">def</span> <span class="nf">test_versioning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test the versioning of the node when setting attributes and extras</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">attrs_to_set</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;bool&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">boolval</span><span class="p">,</span>
            <span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intval</span><span class="p">,</span>
            <span class="s1">&#39;float&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">floatval</span><span class="p">,</span>
            <span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stringval</span><span class="p">,</span>
            <span class="s1">&#39;dict&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictval</span><span class="p">,</span>
            <span class="s1">&#39;list&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">listval</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attrs_to_set</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">a</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Check after storing</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attrs_to_set</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># Even if I stored many attributes, this should stay at 1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># I check increment on new version</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># In both cases, the node version must increase</span>
        <span class="n">a</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;test&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">a</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;test description&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_delete_extras"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_delete_extras">[docs]</a>    <span class="k">def</span> <span class="nf">test_delete_extras</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks the ability of deleting extras, also when they are dictionaries</span>
<span class="sd">        or lists.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">extras_to_set</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;bool&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">boolval</span><span class="p">,</span>
            <span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intval</span><span class="p">,</span>
            <span class="s1">&#39;float&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">floatval</span><span class="p">,</span>
            <span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stringval</span><span class="p">,</span>
            <span class="s1">&#39;dict&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictval</span><span class="p">,</span>
            <span class="s1">&#39;list&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">listval</span><span class="p">,</span>
            <span class="s1">&#39;further&#39;</span><span class="p">:</span> <span class="mi">267</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">all_extras</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_aiida_hash</span><span class="o">=</span><span class="n">AnyValue</span><span class="p">(),</span> <span class="o">**</span><span class="n">extras_to_set</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">extras_to_set</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">a</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">all_extras</span><span class="p">)</span>

        <span class="c1"># I pregenerate it, it cannot change during iteration</span>
        <span class="n">list_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extras_to_set</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">list_keys</span><span class="p">:</span>
            <span class="c1"># I delete one by one the keys and check if the operation is</span>
            <span class="c1"># performed correctly</span>
            <span class="n">a</span><span class="o">.</span><span class="n">delete_extra</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">all_extras</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">all_extras</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_replace_extras_1"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_replace_extras_1">[docs]</a>    <span class="k">def</span> <span class="nf">test_replace_extras_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks the ability of replacing extras, removing the subkeys also when</span>
<span class="sd">        these are dictionaries or lists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">extras_to_set</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;bool&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
            <span class="s1">&#39;float&#39;</span><span class="p">:</span> <span class="mf">26.2</span><span class="p">,</span>
            <span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
            <span class="s1">&#39;dict&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sublist&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                <span class="s2">&quot;subdict&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="s2">&quot;d&quot;</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;list&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;ggg&quot;</span><span class="p">,</span> <span class="p">{</span>
                <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="s1">&#39;j&#39;</span>
            <span class="p">},</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">]],</span>
        <span class="p">}</span>
        <span class="n">all_extras</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_aiida_hash</span><span class="o">=</span><span class="n">AnyValue</span><span class="p">(),</span> <span class="o">**</span><span class="n">extras_to_set</span><span class="p">)</span>

        <span class="c1"># I redefine the keys with more complicated data, and</span>
        <span class="c1"># changing the data type too</span>
        <span class="n">new_extras</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;bool&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
            <span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;a&#39;</span><span class="p">],</span>
            <span class="s1">&#39;float&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span>
                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="p">{}]</span>
            <span class="p">},</span>
            <span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;dict&#39;</span><span class="p">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
            <span class="s1">&#39;list&#39;</span><span class="p">:</span> <span class="mf">66.3</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">extras_to_set</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">a</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">extras</span><span class="p">,</span> <span class="n">all_extras</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">new_extras</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># I delete one by one the keys and check if the operation is</span>
            <span class="c1"># performed correctly</span>
            <span class="n">a</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="c1"># I update extras_to_set with the new entries, and do the comparison</span>
        <span class="c1"># again</span>
        <span class="n">all_extras</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_extras</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">extras</span><span class="p">,</span> <span class="n">all_extras</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_basetype_as_attr"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_basetype_as_attr">[docs]</a>    <span class="k">def</span> <span class="nf">test_basetype_as_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that setting a basetype as an attribute works transparently</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This one is unstored</span>
        <span class="n">l1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">List</span><span class="p">()</span>
        <span class="n">l1</span><span class="o">.</span><span class="n">set_list</span><span class="p">([</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>

        <span class="c1"># This one is stored</span>
        <span class="n">l2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">List</span><span class="p">()</span>
        <span class="n">l2</span><span class="o">.</span><span class="n">set_list</span><span class="p">([</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;gg&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}])</span>
        <span class="n">l2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Manages to store, and value is converted to its base type</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">orm</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="s2">&quot;sometext&quot;</span><span class="p">),</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">l1</span><span class="p">})</span>
        <span class="n">p</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="s2">&quot;sometext&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span>

        <span class="c1"># Check also before storing</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="s2">&quot;sometext2&quot;</span><span class="p">))</span>
        <span class="n">n</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">l2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="s2">&quot;sometext2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;gg&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span>

        <span class="c1"># Check also deep in a dictionary/list</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">orm</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="s2">&quot;sometext3&quot;</span><span class="p">)]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)[</span><span class="s1">&#39;b&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;sometext3&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)[</span><span class="s1">&#39;b&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span>
        <span class="n">n</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)[</span><span class="s1">&#39;b&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;sometext3&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)[</span><span class="s1">&#39;b&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_basetype_as_extra"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_basetype_as_extra">[docs]</a>    <span class="k">def</span> <span class="nf">test_basetype_as_extra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that setting a basetype as an attribute works transparently</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This one is unstored</span>
        <span class="n">l1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">List</span><span class="p">()</span>
        <span class="n">l1</span><span class="o">.</span><span class="n">set_list</span><span class="p">([</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>

        <span class="c1"># This one is stored</span>
        <span class="n">l2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">List</span><span class="p">()</span>
        <span class="n">l2</span><span class="o">.</span><span class="n">set_list</span><span class="p">([</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;gg&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}])</span>
        <span class="n">l2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Check also before storing</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">n</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="s2">&quot;sometext2&quot;</span><span class="p">))</span>
        <span class="n">n</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">l1</span><span class="p">)</span>
        <span class="n">n</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">l2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="s2">&quot;sometext2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;gg&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span>

        <span class="c1"># Check also deep in a dictionary/list</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">n</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">orm</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="s2">&quot;sometext3&quot;</span><span class="p">)]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)[</span><span class="s1">&#39;b&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;sometext3&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)[</span><span class="s1">&#39;b&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_versioning_lowlevel"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_versioning_lowlevel">[docs]</a>    <span class="k">def</span> <span class="nf">test_versioning_lowlevel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks the versioning.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">a</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Even if I stored many attributes, this should stay at 1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">a</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;label1&quot;</span>
        <span class="n">a</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;label2&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">a</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;desc1&quot;</span>
        <span class="n">a</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;desc2&quot;</span>
        <span class="n">a</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;desc3&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_comments"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_comments">[docs]</a>    <span class="k">def</span> <span class="nf">test_comments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This is the best way to compare dates with the stored ones, instead</span>
        <span class="c1"># of directly loading datetime.datetime.now(), or you can get a</span>
        <span class="c1"># &quot;can&#39;t compare offset-naive and offset-aware datetimes&quot; error</span>
        <span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">timedelta</span>
        <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">timezone</span>
        <span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">sleep</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_default</span><span class="p">()</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ModificationNotAllowed</span><span class="p">):</span>
            <span class="n">a</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>

        <span class="n">a</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get_comments</span><span class="p">(),</span> <span class="p">[])</span>

        <span class="n">before</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="s1">&#39;text2&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Make sure comments are sorted to avoid</span>
        <span class="c1"># random test failures</span>
        <span class="n">comments</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get_comments</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">comment</span><span class="p">:</span> <span class="n">comment</span><span class="o">.</span><span class="n">ctime</span><span class="p">)</span>

        <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">ctime</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">comments</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">times</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">time</span> <span class="o">&gt;</span> <span class="n">before</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">time</span> <span class="o">&lt;</span> <span class="n">after</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">([(</span><span class="n">i</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">comments</span><span class="p">],</span> <span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_email</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_email</span><span class="p">,</span> <span class="s1">&#39;text2&#39;</span><span class="p">),</span>
        <span class="p">])</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_code_loading_from_string"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_code_loading_from_string">[docs]</a>    <span class="k">def</span> <span class="nf">test_code_loading_from_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks that the method Code.get_from_string works correctly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">NotExistent</span><span class="p">,</span> <span class="n">MultipleObjectsError</span><span class="p">,</span> <span class="n">InputValidationError</span>

        <span class="c1"># Create some code nodes</span>
        <span class="n">code1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="p">()</span>
        <span class="n">code1</span><span class="o">.</span><span class="n">set_remote_computer_exec</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">,</span> <span class="s1">&#39;/bin/true&#39;</span><span class="p">))</span>
        <span class="n">code1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;test_code1&#39;</span>
        <span class="n">code1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">code2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="p">()</span>
        <span class="n">code2</span><span class="o">.</span><span class="n">set_remote_computer_exec</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">,</span> <span class="s1">&#39;/bin/true&#39;</span><span class="p">))</span>
        <span class="n">code2</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;test_code2&#39;</span>
        <span class="n">code2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Test that the code1 can be loaded correctly with its label</span>
        <span class="n">q_code_1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">get_from_string</span><span class="p">(</span><span class="n">code1</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">code1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_1</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">code1</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_1</span><span class="o">.</span><span class="n">get_remote_exec_path</span><span class="p">(),</span> <span class="n">code1</span><span class="o">.</span><span class="n">get_remote_exec_path</span><span class="p">())</span>

        <span class="c1"># Test that the code2 can be loaded correctly with its label</span>
        <span class="n">q_code_2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">get_from_string</span><span class="p">(</span><span class="n">code2</span><span class="o">.</span><span class="n">label</span> <span class="o">+</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">code2</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_2</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">code2</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_2</span><span class="o">.</span><span class="n">get_remote_exec_path</span><span class="p">(),</span> <span class="n">code2</span><span class="o">.</span><span class="n">get_remote_exec_path</span><span class="p">())</span>

        <span class="c1"># Calling get_from_string for a non string type raises exception</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">InputValidationError</span><span class="p">):</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">get_from_string</span><span class="p">(</span><span class="n">code1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Test that the lookup of a nonexistent code works as expected</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">NotExistent</span><span class="p">):</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">get_from_string</span><span class="p">(</span><span class="s1">&#39;nonexistent_code&#39;</span><span class="p">)</span>

        <span class="c1"># Add another code with the label of code1</span>
        <span class="n">code3</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="p">()</span>
        <span class="n">code3</span><span class="o">.</span><span class="n">set_remote_computer_exec</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">,</span> <span class="s1">&#39;/bin/true&#39;</span><span class="p">))</span>
        <span class="n">code3</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;test_code1&#39;</span>
        <span class="n">code3</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Query with the common label</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">MultipleObjectsError</span><span class="p">):</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">get_from_string</span><span class="p">(</span><span class="n">code3</span><span class="o">.</span><span class="n">label</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_code_loading_using_get"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_code_loading_using_get">[docs]</a>    <span class="k">def</span> <span class="nf">test_code_loading_using_get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks that the method Code.get(pk) works correctly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">NotExistent</span><span class="p">,</span> <span class="n">MultipleObjectsError</span>

        <span class="c1"># Create some code nodes</span>
        <span class="n">code1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="p">()</span>
        <span class="n">code1</span><span class="o">.</span><span class="n">set_remote_computer_exec</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">,</span> <span class="s1">&#39;/bin/true&#39;</span><span class="p">))</span>
        <span class="n">code1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;test_code3&#39;</span>
        <span class="n">code1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">code2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="p">()</span>
        <span class="n">code2</span><span class="o">.</span><span class="n">set_remote_computer_exec</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">,</span> <span class="s1">&#39;/bin/true&#39;</span><span class="p">))</span>
        <span class="n">code2</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;test_code4&#39;</span>
        <span class="n">code2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Test that the code1 can be loaded correctly with its label only</span>
        <span class="n">q_code_1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">code1</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">code1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_1</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">code1</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_1</span><span class="o">.</span><span class="n">get_remote_exec_path</span><span class="p">(),</span> <span class="n">code1</span><span class="o">.</span><span class="n">get_remote_exec_path</span><span class="p">())</span>

        <span class="c1"># Test that the code1 can be loaded correctly with its id/pk</span>
        <span class="n">q_code_1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">code1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_1</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">code1</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_1</span><span class="o">.</span><span class="n">get_remote_exec_path</span><span class="p">(),</span> <span class="n">code1</span><span class="o">.</span><span class="n">get_remote_exec_path</span><span class="p">())</span>

        <span class="c1"># Test that the code2 can be loaded correctly with its label and computername</span>
        <span class="n">q_code_2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">code2</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">machinename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">code2</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_2</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">code2</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_2</span><span class="o">.</span><span class="n">get_remote_exec_path</span><span class="p">(),</span> <span class="n">code2</span><span class="o">.</span><span class="n">get_remote_exec_path</span><span class="p">())</span>

        <span class="c1"># Test that the code2 can be loaded correctly with its id/pk</span>
        <span class="n">q_code_2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code2</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">code2</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_2</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">code2</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_2</span><span class="o">.</span><span class="n">get_remote_exec_path</span><span class="p">(),</span> <span class="n">code2</span><span class="o">.</span><span class="n">get_remote_exec_path</span><span class="p">())</span>

        <span class="c1"># Test that the lookup of a nonexistent code works as expected</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">NotExistent</span><span class="p">):</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;nonexistent_code&#39;</span><span class="p">)</span>

        <span class="c1"># Add another code with the label of code1</span>
        <span class="n">code3</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="p">()</span>
        <span class="n">code3</span><span class="o">.</span><span class="n">set_remote_computer_exec</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">,</span> <span class="s1">&#39;/bin/true&#39;</span><span class="p">))</span>
        <span class="n">code3</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;test_code3&#39;</span>
        <span class="n">code3</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Query with the common label</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">MultipleObjectsError</span><span class="p">):</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">code3</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>

        <span class="c1"># Add another code whose label is equal to pk of another code</span>
        <span class="n">pk_label_duplicate</span> <span class="o">=</span> <span class="n">code1</span><span class="o">.</span><span class="n">pk</span>
        <span class="n">code4</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="p">()</span>
        <span class="n">code4</span><span class="o">.</span><span class="n">set_remote_computer_exec</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">,</span> <span class="s1">&#39;/bin/true&#39;</span><span class="p">))</span>
        <span class="n">code4</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">pk_label_duplicate</span>
        <span class="n">code4</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Since the label of code4 is identical to the pk of code1, calling</span>
        <span class="c1"># Code.get(pk_label_duplicate) should return code1, as the pk takes</span>
        <span class="c1"># precedence</span>
        <span class="n">q_code_4</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code4</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_4</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">code1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_4</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">code1</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">q_code_4</span><span class="o">.</span><span class="n">get_remote_exec_path</span><span class="p">(),</span> <span class="n">code1</span><span class="o">.</span><span class="n">get_remote_exec_path</span><span class="p">())</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_code_description"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_code_description">[docs]</a>    <span class="k">def</span> <span class="nf">test_code_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This test checks that the code description is retrieved correctly</span>
<span class="sd">        when the code is searched with its id and label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a code node</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="p">()</span>
        <span class="n">code</span><span class="o">.</span><span class="n">set_remote_computer_exec</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">,</span> <span class="s1">&#39;/bin/true&#39;</span><span class="p">))</span>
        <span class="n">code</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;test_code_label&#39;</span>
        <span class="n">code</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;test code description&#39;</span>
        <span class="n">code</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">q_code1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">code</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">q_code1</span><span class="o">.</span><span class="n">description</span><span class="p">))</span>

        <span class="n">q_code2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">q_code2</span><span class="o">.</span><span class="n">description</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_list_for_plugin"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_list_for_plugin">[docs]</a>    <span class="k">def</span> <span class="nf">test_list_for_plugin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This test checks the Code.list_for_plugin()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">code1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="p">()</span>
        <span class="n">code1</span><span class="o">.</span><span class="n">set_remote_computer_exec</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">,</span> <span class="s1">&#39;/bin/true&#39;</span><span class="p">))</span>
        <span class="n">code1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;test_code1&#39;</span>
        <span class="n">code1</span><span class="o">.</span><span class="n">set_input_plugin_name</span><span class="p">(</span><span class="s1">&#39;plugin_name&#39;</span><span class="p">)</span>
        <span class="n">code1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">code2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="p">()</span>
        <span class="n">code2</span><span class="o">.</span><span class="n">set_remote_computer_exec</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">,</span> <span class="s1">&#39;/bin/true&#39;</span><span class="p">))</span>
        <span class="n">code2</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;test_code2&#39;</span>
        <span class="n">code2</span><span class="o">.</span><span class="n">set_input_plugin_name</span><span class="p">(</span><span class="s1">&#39;plugin_name&#39;</span><span class="p">)</span>
        <span class="n">code2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">retrieved_pks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">list_for_plugin</span><span class="p">(</span><span class="s1">&#39;plugin_name&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">retrieved_pks</span><span class="p">,</span> <span class="nb">set</span><span class="p">([</span><span class="n">code1</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">code2</span><span class="o">.</span><span class="n">pk</span><span class="p">]))</span>

        <span class="n">retrieved_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">list_for_plugin</span><span class="p">(</span><span class="s1">&#39;plugin_name&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">retrieved_labels</span><span class="p">,</span> <span class="nb">set</span><span class="p">([</span><span class="n">code1</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">code2</span><span class="o">.</span><span class="n">label</span><span class="p">]))</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_load_node"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_load_node">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests the load node functionality</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">NotExistent</span>

        <span class="c1"># I only need one node to test</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">uuid_stored</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span>  <span class="c1"># convenience to store the uuid</span>
        <span class="c1"># Simple test to see whether I load correctly from the pk:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">uuid_stored</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="c1"># Testing the loading with the uuid:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">uuid_stored</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">uuid_stored</span><span class="p">)</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="c1"># Here I&#39;m testing whether loading the node with the beginnings of a uuid works</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">uuid_stored</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">start_uuid</span> <span class="o">=</span> <span class="n">uuid_stored</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">uuid_stored</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">start_uuid</span><span class="p">)</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="c1"># Testing whether loading the node with part of UUID works, removing the dashes</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">uuid_stored</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">start_uuid</span> <span class="o">=</span> <span class="n">uuid_stored</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">uuid_stored</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">start_uuid</span><span class="p">)</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="c1"># If I don&#39;t allow load_node to fix the dashes, this has to raise:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">NotExistent</span><span class="p">):</span>
                <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">start_uuid</span><span class="p">,</span> <span class="n">query_with_dashes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Now I am reverting the order of the uuid, this will raise a NotExistent error:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">NotExistent</span><span class="p">):</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">uuid_stored</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># I am giving a non-sensical pk, this should also raise</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">NotExistent</span><span class="p">):</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Last check, when asking for specific subclass, this should raise:</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">uuid_stored</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">NotExistent</span><span class="p">):</span>
                <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">sub_classes</span><span class="o">=</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">ArrayData</span><span class="p">,))</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_load_unknown_calculation_type"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_load_unknown_calculation_type">[docs]</a>    <span class="nd">@unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;open issue JobCalculations cannot be stored&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_load_unknown_calculation_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that the loader will choose a common calculation ancestor for an unknown data type.</span>
<span class="sd">        For the case where, e.g., the user doesn&#39;t have the necessary plugin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.plugins</span> <span class="k">import</span> <span class="n">CalculationFactory</span>

        <span class="n">TemplateReplacerCalc</span> <span class="o">=</span> <span class="n">CalculationFactory</span><span class="p">(</span><span class="s1">&#39;templatereplacer&#39;</span><span class="p">)</span>
        <span class="n">testcalc</span> <span class="o">=</span> <span class="n">TemplateReplacerCalc</span><span class="p">(</span><span class="n">computer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">)</span>
        <span class="n">testcalc</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;num_machines&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;num_mpiprocs_per_machine&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">testcalc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># compare if plugin exist</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">testcalc</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">testcalc</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>

        <span class="c1"># Create a custom calculation type that inherits from CalcJobNode but change the plugin type string</span>
        <span class="k">class</span> <span class="nc">TestCalculation</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="n">TestCalculation</span><span class="o">.</span><span class="n">_plugin_type_string</span> <span class="o">=</span> <span class="s1">&#39;nodes.process.calculation.calcjob.notexisting.TemplatereplacerCalculation.&#39;</span>
        <span class="n">TestCalculation</span><span class="o">.</span><span class="n">_query_type_string</span> <span class="o">=</span> <span class="s1">&#39;nodes.process.calculation.calcjob.notexisting.TemplatereplacerCalculation&#39;</span>

        <span class="n">jobcalc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">(</span><span class="n">computer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">)</span>
        <span class="n">jobcalc</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;num_machines&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;num_mpiprocs_per_machine&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">jobcalc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">testcalc</span> <span class="o">=</span> <span class="n">TestCalculation</span><span class="p">(</span><span class="n">computer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">)</span>
        <span class="n">testcalc</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;num_machines&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;num_mpiprocs_per_machine&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">testcalc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Changed node should return CalcJobNode type as its plugin does not exist</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">testcalc</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">jobcalc</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestNodeBasic.test_load_unknown_data_type"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeBasic.test_load_unknown_data_type">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_unknown_data_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that the loader will choose a common data ancestor for an unknown data type.</span>
<span class="sd">        For the case where, e.g., the user doesn&#39;t have the necessary plugin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.plugins</span> <span class="k">import</span> <span class="n">DataFactory</span>

        <span class="n">KpointsData</span> <span class="o">=</span> <span class="n">DataFactory</span><span class="p">(</span><span class="s1">&#39;array.kpoints&#39;</span><span class="p">)</span>
        <span class="n">kpoint</span> <span class="o">=</span> <span class="n">KpointsData</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># compare if plugin exist</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">kpoint</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">kpoint</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>

        <span class="k">class</span> <span class="nc">TestKpointsData</span><span class="p">(</span><span class="n">KpointsData</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="c1"># change node type and save in database again</span>
        <span class="n">TestKpointsData</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># changed node should return data node as its plugin is not exist</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">kpoint</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">kpoint</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>

        <span class="c1"># for node</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">n1</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="TestSubNodesAndLinks"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestSubNodesAndLinks">[docs]</a><span class="k">class</span> <span class="nc">TestSubNodesAndLinks</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestSubNodesAndLinks.test_cachelink"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestSubNodesAndLinks.test_cachelink">[docs]</a>    <span class="k">def</span> <span class="nf">test_cachelink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test the proper functionality of the links cache, with different</span>
<span class="sd">        scenarios.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n3</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">n4</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">endcalc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>

        <span class="c1"># Nothing stored</span>
        <span class="n">endcalc</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="s2">&quot;N1&quot;</span><span class="p">)</span>
        <span class="c1"># Try also reverse storage</span>
        <span class="n">endcalc</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="s2">&quot;N2&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">([(</span><span class="n">i</span><span class="o">.</span><span class="n">link_label</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">endcalc</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">()]),</span>
            <span class="nb">set</span><span class="p">([(</span><span class="s2">&quot;N1&quot;</span><span class="p">,</span> <span class="n">n1</span><span class="o">.</span><span class="n">uuid</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N2&quot;</span><span class="p">,</span> <span class="n">n2</span><span class="o">.</span><span class="n">uuid</span><span class="p">)]))</span>

        <span class="c1"># Endnode not stored yet, n3 and n4 already stored</span>
        <span class="n">endcalc</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n3</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="s2">&quot;N3&quot;</span><span class="p">)</span>
        <span class="c1"># Try also reverse storage</span>
        <span class="n">endcalc</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n4</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="s2">&quot;N4&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">([(</span><span class="n">i</span><span class="o">.</span><span class="n">link_label</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">endcalc</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">()]),</span>
            <span class="nb">set</span><span class="p">([(</span><span class="s2">&quot;N1&quot;</span><span class="p">,</span> <span class="n">n1</span><span class="o">.</span><span class="n">uuid</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N2&quot;</span><span class="p">,</span> <span class="n">n2</span><span class="o">.</span><span class="n">uuid</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N3&quot;</span><span class="p">,</span> <span class="n">n3</span><span class="o">.</span><span class="n">uuid</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N4&quot;</span><span class="p">,</span> <span class="n">n4</span><span class="o">.</span><span class="n">uuid</span><span class="p">)]))</span>

        <span class="c1"># Some parent nodes are not stored yet</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ModificationNotAllowed</span><span class="p">):</span>
            <span class="n">endcalc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">([(</span><span class="n">i</span><span class="o">.</span><span class="n">link_label</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">endcalc</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">()]),</span>
            <span class="nb">set</span><span class="p">([(</span><span class="s2">&quot;N1&quot;</span><span class="p">,</span> <span class="n">n1</span><span class="o">.</span><span class="n">uuid</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N2&quot;</span><span class="p">,</span> <span class="n">n2</span><span class="o">.</span><span class="n">uuid</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N3&quot;</span><span class="p">,</span> <span class="n">n3</span><span class="o">.</span><span class="n">uuid</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N4&quot;</span><span class="p">,</span> <span class="n">n4</span><span class="o">.</span><span class="n">uuid</span><span class="p">)]))</span>

        <span class="c1"># This will also store n1 and n2!</span>
        <span class="n">endcalc</span><span class="o">.</span><span class="n">store_all</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">([(</span><span class="n">i</span><span class="o">.</span><span class="n">link_label</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">endcalc</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">()]),</span>
            <span class="nb">set</span><span class="p">([(</span><span class="s2">&quot;N1&quot;</span><span class="p">,</span> <span class="n">n1</span><span class="o">.</span><span class="n">uuid</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N2&quot;</span><span class="p">,</span> <span class="n">n2</span><span class="o">.</span><span class="n">uuid</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N3&quot;</span><span class="p">,</span> <span class="n">n3</span><span class="o">.</span><span class="n">uuid</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N4&quot;</span><span class="p">,</span> <span class="n">n4</span><span class="o">.</span><span class="n">uuid</span><span class="p">)]))</span></div>

<div class="viewcode-block" id="TestSubNodesAndLinks.test_store_with_unstored_parents"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestSubNodesAndLinks.test_store_with_unstored_parents">[docs]</a>    <span class="k">def</span> <span class="nf">test_store_with_unstored_parents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        I want to check that if parents are unstored I cannot store</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">endcalc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>

        <span class="n">endcalc</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="s2">&quot;N1&quot;</span><span class="p">)</span>
        <span class="n">endcalc</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="s2">&quot;N2&quot;</span><span class="p">)</span>

        <span class="c1"># Some parent nodes are not stored yet</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ModificationNotAllowed</span><span class="p">):</span>
            <span class="n">endcalc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">n1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="c1"># Now I can store</span>
        <span class="n">endcalc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">([(</span><span class="n">i</span><span class="o">.</span><span class="n">link_label</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">endcalc</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">()]),</span>
            <span class="nb">set</span><span class="p">([(</span><span class="s2">&quot;N1&quot;</span><span class="p">,</span> <span class="n">n1</span><span class="o">.</span><span class="n">uuid</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N2&quot;</span><span class="p">,</span> <span class="n">n2</span><span class="o">.</span><span class="n">uuid</span><span class="p">)]))</span></div>

<div class="viewcode-block" id="TestSubNodesAndLinks.test_storeall_with_unstored_grandparents"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestSubNodesAndLinks.test_storeall_with_unstored_grandparents">[docs]</a>    <span class="k">def</span> <span class="nf">test_storeall_with_unstored_grandparents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        I want to check that if grandparents are unstored I cannot store_all</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">endcalc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>

        <span class="n">n2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="s2">&quot;N1&quot;</span><span class="p">)</span>
        <span class="n">endcalc</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="s2">&quot;N2&quot;</span><span class="p">)</span>

        <span class="c1"># Grandparents are unstored</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ModificationNotAllowed</span><span class="p">):</span>
            <span class="n">endcalc</span><span class="o">.</span><span class="n">store_all</span><span class="p">()</span>

        <span class="n">n1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="c1"># Now it should work</span>
        <span class="n">endcalc</span><span class="o">.</span><span class="n">store_all</span><span class="p">()</span>

        <span class="c1"># Check the parents...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">([(</span><span class="n">i</span><span class="o">.</span><span class="n">link_label</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">n2</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">()]),</span> <span class="nb">set</span><span class="p">([(</span><span class="s2">&quot;N1&quot;</span><span class="p">,</span> <span class="n">n1</span><span class="o">.</span><span class="n">uuid</span><span class="p">)]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">([(</span><span class="n">i</span><span class="o">.</span><span class="n">link_label</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">endcalc</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">()]),</span> <span class="nb">set</span><span class="p">([(</span><span class="s2">&quot;N2&quot;</span><span class="p">,</span> <span class="n">n2</span><span class="o">.</span><span class="n">uuid</span><span class="p">)]))</span></div>

    <span class="c1"># pylint: disable=unused-variable,no-member,no-self-use</span>
<div class="viewcode-block" id="TestSubNodesAndLinks.test_calculation_load"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestSubNodesAndLinks.test_calculation_load">[docs]</a>    <span class="k">def</span> <span class="nf">test_calculation_load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="k">import</span> <span class="n">CalcJobNode</span>

        <span class="c1"># I check with a string, with an object and with the computer pk/id</span>
        <span class="n">calc</span> <span class="o">=</span> <span class="n">CalcJobNode</span><span class="p">(</span><span class="n">computer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">)</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;num_machines&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;num_mpiprocs_per_machine&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="c1"># I should get an error if I ask for a computer id/pk that doesn&#39;t exist</span>
            <span class="n">CalcJobNode</span><span class="p">(</span><span class="n">computer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="mi">100000</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestSubNodesAndLinks.test_links_label_constraints"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestSubNodesAndLinks.test_links_label_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">test_links_label_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">d1bis</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">calc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">d3</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">d4</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">calc2a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">calc2b</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>

        <span class="n">calc</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;label1&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">calc</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">d1bis</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;label1&#39;</span><span class="p">)</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># This should be allowed since it is an output label with the same name</span>
        <span class="c1"># as an input label: no problem</span>
        <span class="n">d2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;label1&#39;</span><span class="p">)</span>
        <span class="c1"># This should be allowed, it&#39;s a different label</span>
        <span class="n">d3</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;label2&#39;</span><span class="p">)</span>

        <span class="c1"># This shouldn&#39;t be allowed, it&#39;s an output CREATE link with</span>
        <span class="c1"># the same same of an existing output CREATE link</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">d4</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;label2&#39;</span><span class="p">)</span>

        <span class="c1"># instead, for outputs, I can have multiple times the same label</span>
        <span class="c1"># (think to the case where d4 is a StructureData, and both calc2a and calc2b</span>
        <span class="c1"># are calculations that use as label &#39;input_cell&#39;)</span>
        <span class="n">calc2a</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">d4</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;label3&#39;</span><span class="p">)</span>
        <span class="n">calc2b</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">d4</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;label3&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestSubNodesAndLinks.test_links_label_autogenerator"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestSubNodesAndLinks.test_links_label_autogenerator">[docs]</a>    <span class="nd">@unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;activate this test once #2238 is addressed&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_links_label_autogenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test the auto generation of link labels when labels are no longer required to be explicitly specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">n3</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">n4</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">n5</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">n6</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">n7</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">n8</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">n9</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">data</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">)</span>
        <span class="c1"># Label should be automatically generated</span>
        <span class="n">data</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n3</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n4</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n5</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n6</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n7</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n8</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n9</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">)</span>

        <span class="n">all_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">link_label</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_labels</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_labels</span><span class="p">),</span> <span class="s2">&quot;There are duplicate links, that are not expected&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestSubNodesAndLinks.test_link_label_autogenerator"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestSubNodesAndLinks.test_link_label_autogenerator">[docs]</a>    <span class="nd">@unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;activate this test once #2238 is addressed&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_link_label_autogenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When the uniqueness constraints on links are reimplemented on the database level, auto generation of</span>
<span class="sd">        labels that relies directly on those database level constraints should be reinstated and tested for here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="TestSubNodesAndLinks.test_link_with_unstored"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestSubNodesAndLinks.test_link_with_unstored">[docs]</a>    <span class="k">def</span> <span class="nf">test_link_with_unstored</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        It is possible to store links between nodes even if they are unstored these links are cached.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span>
        <span class="n">n3</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">n4</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>

        <span class="c1"># Caching the links</span>
        <span class="n">n2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_WORK</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">)</span>
        <span class="n">n3</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;l3&#39;</span><span class="p">)</span>
        <span class="n">n3</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">)</span>

        <span class="c1"># Twice the same link name</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">n3</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n4</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;l3&#39;</span><span class="p">)</span>

        <span class="n">n2</span><span class="o">.</span><span class="n">store_all</span><span class="p">()</span>
        <span class="n">n3</span><span class="o">.</span><span class="n">store_all</span><span class="p">()</span>

        <span class="n">n2_in_links</span> <span class="o">=</span> <span class="p">[(</span><span class="n">n</span><span class="o">.</span><span class="n">link_label</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">n2</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">n2_in_links</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="n">n1</span><span class="o">.</span><span class="n">uuid</span><span class="p">),</span>
        <span class="p">]))</span>
        <span class="n">n3_in_links</span> <span class="o">=</span> <span class="p">[(</span><span class="n">n</span><span class="o">.</span><span class="n">link_label</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">n3</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">n3_in_links</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="n">n2</span><span class="o">.</span><span class="n">uuid</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;l3&#39;</span><span class="p">,</span> <span class="n">n1</span><span class="o">.</span><span class="n">uuid</span><span class="p">),</span>
        <span class="p">]))</span>

        <span class="n">n1_out_links</span> <span class="o">=</span> <span class="p">[(</span><span class="n">entry</span><span class="o">.</span><span class="n">link_label</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">n1</span><span class="o">.</span><span class="n">get_outgoing</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">n1_out_links</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="n">n2</span><span class="o">.</span><span class="n">pk</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;l3&#39;</span><span class="p">,</span> <span class="n">n3</span><span class="o">.</span><span class="n">pk</span><span class="p">),</span>
        <span class="p">]))</span>
        <span class="n">n2_out_links</span> <span class="o">=</span> <span class="p">[(</span><span class="n">entry</span><span class="o">.</span><span class="n">link_label</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">n2</span><span class="o">.</span><span class="n">get_outgoing</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">n2_out_links</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">([(</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="n">n3</span><span class="o">.</span><span class="n">pk</span><span class="p">)]))</span></div>

<div class="viewcode-block" id="TestSubNodesAndLinks.test_multiple_create_links"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestSubNodesAndLinks.test_multiple_create_links">[docs]</a>    <span class="k">def</span> <span class="nf">test_multiple_create_links</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cannot have two CREATE links for the same node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">n3</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>

        <span class="c1"># Caching the links</span>
        <span class="n">n3</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;CREATE&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">n3</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;CREATE&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestSubNodesAndLinks.test_valid_links"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestSubNodesAndLinks.test_valid_links">[docs]</a>    <span class="k">def</span> <span class="nf">test_valid_links</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>
        <span class="kn">from</span> <span class="nn">aiida.plugins</span> <span class="k">import</span> <span class="n">DataFactory</span>

        <span class="n">SinglefileData</span> <span class="o">=</span> <span class="n">DataFactory</span><span class="p">(</span><span class="s1">&#39;singlefile&#39;</span><span class="p">)</span>

        <span class="c1"># I create some objects</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">d2</span> <span class="o">=</span> <span class="n">SinglefileData</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">handle</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">unsavedcomputer</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;localhost2&#39;</span><span class="p">,</span> <span class="n">hostname</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">scheduler_type</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">,</span> <span class="n">transport_type</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="c1"># I need to save the localhost entry first</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">(</span><span class="n">computer</span><span class="o">=</span><span class="n">unsavedcomputer</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Load calculations with two different ways</span>
        <span class="n">calc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">(</span><span class="n">computer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">)</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;num_machines&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;num_mpiprocs_per_machine&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

        <span class="n">calc2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">(</span><span class="n">computer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">)</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;num_machines&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;num_mpiprocs_per_machine&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">calc</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;some_label&#39;</span><span class="p">)</span>

        <span class="c1"># Cannot link to itself</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">d1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>

        <span class="c1"># I try to add wrong links (data to data, calc to calc, etc.)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">d2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">d1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">calc</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">calc2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>

        <span class="n">calc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">calc_a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">(</span><span class="n">computer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">)</span>
        <span class="n">calc_a</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;num_machines&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;num_mpiprocs_per_machine&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">calc_a</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">calc_b</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">(</span><span class="n">computer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">)</span>
        <span class="n">calc_b</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;num_machines&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;num_mpiprocs_per_machine&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">calc_b</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">data_node</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">data_node</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">calc_a</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>
        <span class="c1"># A data cannot have two input calculations</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">data_node</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">calc_b</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>

        <span class="n">calculation_inputs</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># This calculation has two data inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">calculation_inputs</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestSubNodesAndLinks.test_check_single_calc_source"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestSubNodesAndLinks.test_check_single_calc_source">[docs]</a>    <span class="k">def</span> <span class="nf">test_check_single_calc_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Each data node can only have one input calculation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">calc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">(</span><span class="n">computer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">)</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;num_machines&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;num_mpiprocs_per_machine&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">calc2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">(</span><span class="n">computer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">)</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;num_machines&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;num_mpiprocs_per_machine&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">d1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>

        <span class="c1"># more than one input to the same data object!</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">d1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">calc2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestSubNodesAndLinks.test_node_get_incoming_outgoing_links"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestSubNodesAndLinks.test_node_get_incoming_outgoing_links">[docs]</a>    <span class="k">def</span> <span class="nf">test_node_get_incoming_outgoing_links</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that the link_type parameter in get_incoming and get_outgoing only</span>
<span class="sd">        returns those nodes with the correct link type for stored nodes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">node_origin</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span>
        <span class="n">node_origin2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span>
        <span class="n">node_caller_stored</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">node_called</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span>
        <span class="n">node_input_stored</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">node_output</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">node_return</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Input links of node_origin</span>
        <span class="n">node_origin</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">node_caller_stored</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;caller_stored&#39;</span><span class="p">)</span>
        <span class="n">node_origin</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">node_input_stored</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_WORK</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;input_stored&#39;</span><span class="p">)</span>
        <span class="n">node_origin</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">node_origin2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">node_caller_stored</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;caller_unstored&#39;</span><span class="p">)</span>
        <span class="n">node_origin2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Output links of node_origin</span>
        <span class="n">node_called</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">node_origin</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;called&#39;</span><span class="p">)</span>
        <span class="n">node_called</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">node_output</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">node_origin</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;return1&#39;</span><span class="p">)</span>
        <span class="n">node_return</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">node_origin</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;return2&#39;</span><span class="p">)</span>

        <span class="c1"># All incoming and outgoing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node_origin</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node_origin</span><span class="o">.</span><span class="n">get_outgoing</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Link specific incoming</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node_origin</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">(</span><span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node_origin2</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">(</span><span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node_origin</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">(</span><span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_WORK</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node_origin</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">(</span><span class="n">link_label_filter</span><span class="o">=</span><span class="s2">&quot;in_ut%&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node_origin</span><span class="o">.</span><span class="n">get_incoming</span><span class="p">(</span><span class="n">node_class</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Link specific outgoing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node_origin</span><span class="o">.</span><span class="n">get_outgoing</span><span class="p">(</span><span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node_origin</span><span class="o">.</span><span class="n">get_outgoing</span><span class="p">(</span><span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">2</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="AnyValue"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.AnyValue">[docs]</a><span class="k">class</span> <span class="nc">AnyValue</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper class that compares equal to everything.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AnyValue.__eq__"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.AnyValue.__eq__">[docs]</a>    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div></div>


<div class="viewcode-block" id="TestNodeDeletion"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeDeletion">[docs]</a><span class="k">class</span> <span class="nc">TestNodeDeletion</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestNodeDeletion._check_existence"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeDeletion._check_existence">[docs]</a>    <span class="k">def</span> <span class="nf">_check_existence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uuids_check_existence</span><span class="p">,</span> <span class="n">uuids_check_deleted</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        I get 2 lists of uuids</span>

<span class="sd">        :param uuids_check_existence: The list of uuids that have to exist</span>
<span class="sd">        :param uuids_check_deleted: The list of uuids that should not exist,</span>
<span class="sd">            I check that NotExistent is raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">NotExistent</span>

        <span class="c1"># Shouldn&#39;t be needed, but just to avoid an exception being</span>
        <span class="c1"># raised from the exception management block below</span>
        <span class="n">uuid</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">uuids_check_existence</span><span class="p">:</span>
                <span class="c1"># This will raise if node is not existent:</span>
                <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">uuids_check_deleted</span><span class="p">:</span>
                <span class="c1"># I check that it raises</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">NotExistent</span><span class="p">):</span>
                    <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
            <span class="kn">import</span> <span class="nn">sys</span>
            <span class="n">six</span><span class="o">.</span><span class="n">reraise</span><span class="p">(</span>
                <span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Current UUID being processed: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Full uuids_check_existence: </span><span class="si">{}</span><span class="s2">; full uuids_check_deleted: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">uuid</span><span class="p">,</span> <span class="n">uuids_check_existence</span><span class="p">,</span> <span class="n">uuids_check_deleted</span><span class="p">),</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span></div>

<div class="viewcode-block" id="TestNodeDeletion._create_calls_n_returns_graph"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeDeletion._create_calls_n_returns_graph">[docs]</a>    <span class="k">def</span> <span class="nf">_create_calls_n_returns_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a complicated graph with a master with 1 inputs,</span>
<span class="sd">        2 slaves of it also using that input and an additional 1,</span>
<span class="sd">        producing output that is either returned or not returned by the master.</span>
<span class="sd">        Master also creates one nodes. This allows to check whether the delete_nodes</span>
<span class="sd">        command works as anticipated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># in1 -&gt; wf</span>
        <span class="c1">#     `-&gt; slave1</span>
        <span class="c1">#      ____^  ^</span>
        <span class="c1">#     /       &quot;CALL</span>
        <span class="c1"># in2 -&gt; slave2</span>
        <span class="c1"># ind</span>
        <span class="n">in1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">in2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">wf</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span>
        <span class="n">slave1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span>
        <span class="n">outp1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">outp2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">slave2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">outp3</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">outp4</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_WORK</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link1&#39;</span><span class="p">)</span>
        <span class="n">slave1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_WORK</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link2&#39;</span><span class="p">)</span>
        <span class="n">slave1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">in2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_WORK</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link3&#39;</span><span class="p">)</span>
        <span class="n">slave2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">in2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link4&#39;</span><span class="p">)</span>
        <span class="n">slave1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link5&#39;</span><span class="p">)</span>
        <span class="n">slave2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link6&#39;</span><span class="p">)</span>

        <span class="n">wf</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">slave1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">slave2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">outp1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">slave1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link7&#39;</span><span class="p">)</span>
        <span class="n">outp2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">slave2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link8&#39;</span><span class="p">)</span>
        <span class="n">outp2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link9&#39;</span><span class="p">)</span>
        <span class="n">outp3</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link10&#39;</span><span class="p">)</span>
        <span class="n">outp4</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link11&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">in1</span><span class="p">,</span> <span class="n">in2</span><span class="p">,</span> <span class="n">wf</span><span class="p">,</span> <span class="n">slave1</span><span class="p">,</span> <span class="n">outp1</span><span class="p">,</span> <span class="n">outp2</span><span class="p">,</span> <span class="n">slave2</span><span class="p">,</span> <span class="n">outp3</span><span class="p">,</span> <span class="n">outp4</span></div>

<div class="viewcode-block" id="TestNodeDeletion.test_deletion_simple"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeDeletion.test_deletion_simple">[docs]</a>    <span class="k">def</span> <span class="nf">test_deletion_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        I&#39;m setting up a sequence of nodes connected by data provenance links.</span>
<span class="sd">        Testing whether I will delete the right ones.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">(),</span>  <span class="c1"># 0</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">(),</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">(),</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">(),</span>  <span class="c1"># 1, 2, 3</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">(),</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">(),</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">(),</span>  <span class="c1"># 4, 5, 6</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">(),</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">(),</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">(),</span>  <span class="c1"># 7, 8, 9</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">(),</span>  <span class="c1"># 10</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">(),</span>  <span class="c1"># 11</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">(),</span>  <span class="c1"># 12</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">(),</span>  <span class="c1"># 13</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">(),</span>  <span class="c1"># 14</span>
        <span class="p">]</span>

        <span class="n">uuids_check_existence</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[:</span><span class="mi">3</span><span class="p">]]</span>
        <span class="n">uuids_check_deleted</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">3</span><span class="p">:]]</span>

        <span class="c1"># Now I am linking the nodes in a branched network</span>
        <span class="c1"># Connecting nodes 1,2,3 to 0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="c1"># Connecting nodes 4,5,6 to 3</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
            <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="c1"># Connecting nodes 7,8 to 4</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">):</span>
            <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="c1"># Connecting node 9 (WF) to 5 (input data)</span>
        <span class="n">nodes</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link9&#39;</span><span class="p">)</span>

        <span class="c1"># Connect each node to the next one</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">):</span>
            <span class="c1"># First link to create: 10 (Data) -&gt; 11 (Calc) via a INPUT_CALC</span>
            <span class="n">link_type</span> <span class="o">=</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span>
            <span class="n">nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">link_type</span><span class="o">=</span><span class="n">link_type</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">Capturing</span><span class="p">():</span>
            <span class="n">delete_nodes</span><span class="p">((</span><span class="n">nodes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">pk</span><span class="p">),</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_existence</span><span class="p">(</span><span class="n">uuids_check_existence</span><span class="p">,</span> <span class="n">uuids_check_deleted</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeDeletion.test_deletion_non_existing_pk"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeDeletion.test_deletion_non_existing_pk">[docs]</a>    <span class="k">def</span> <span class="nf">test_deletion_non_existing_pk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify that passing a non-existing pk should not raise.&quot;&quot;&quot;</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_calls_n_returns_graph</span><span class="p">()</span>
        <span class="n">existing_pks</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">pk</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">]</span>

        <span class="n">non_existing_pk</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Starting from pk=1, find a pk that does not exist</span>
        <span class="k">while</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">non_existing_pk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_pks</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">non_existing_pk</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">with</span> <span class="n">Capturing</span><span class="p">():</span>
            <span class="n">delete_nodes</span><span class="p">([</span><span class="n">non_existing_pk</span><span class="p">],</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeDeletion.test_deletion_with_calls_with_returns"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeDeletion.test_deletion_with_calls_with_returns">[docs]</a>    <span class="k">def</span> <span class="nf">test_deletion_with_calls_with_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checking the case where I follow calls and return links for deletion</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">in1</span><span class="p">,</span> <span class="n">in2</span><span class="p">,</span> <span class="n">wf</span><span class="p">,</span> <span class="n">slave1</span><span class="p">,</span> <span class="n">outp1</span><span class="p">,</span> <span class="n">outp2</span><span class="p">,</span> <span class="n">slave2</span><span class="p">,</span> <span class="n">outp3</span><span class="p">,</span> <span class="n">outp4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_calls_n_returns_graph</span><span class="p">()</span>
        <span class="c1"># The inputs are not harmed.</span>
        <span class="n">uuids_check_existence</span> <span class="o">=</span> <span class="p">(</span><span class="n">in1</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">in2</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="c1"># the slaves and their outputs have to disappear since calls are followed!</span>
        <span class="n">uuids_check_deleted</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">slave1</span><span class="p">,</span> <span class="n">outp1</span><span class="p">,</span> <span class="n">outp2</span><span class="p">,</span> <span class="n">outp3</span><span class="p">,</span> <span class="n">slave2</span><span class="p">,</span> <span class="n">outp4</span><span class="p">)]</span>

        <span class="k">with</span> <span class="n">Capturing</span><span class="p">():</span>
            <span class="n">delete_nodes</span><span class="p">([</span><span class="n">wf</span><span class="o">.</span><span class="n">pk</span><span class="p">],</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">follow_calls</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">follow_returns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_existence</span><span class="p">(</span><span class="n">uuids_check_existence</span><span class="p">,</span> <span class="n">uuids_check_deleted</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeDeletion.test_deletion_with_calls_no_returns"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeDeletion.test_deletion_with_calls_no_returns">[docs]</a>    <span class="k">def</span> <span class="nf">test_deletion_with_calls_no_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checking the case where I follow calls and not return links for deletion</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">in1</span><span class="p">,</span> <span class="n">in2</span><span class="p">,</span> <span class="n">wf</span><span class="p">,</span> <span class="n">slave1</span><span class="p">,</span> <span class="n">outp1</span><span class="p">,</span> <span class="n">outp2</span><span class="p">,</span> <span class="n">slave2</span><span class="p">,</span> <span class="n">outp3</span><span class="p">,</span> <span class="n">outp4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_calls_n_returns_graph</span><span class="p">()</span>
        <span class="c1"># The inputs are not harmed.</span>
        <span class="n">uuids_check_existence</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">in2</span><span class="p">,</span> <span class="n">outp1</span><span class="p">,</span> <span class="n">outp3</span><span class="p">,</span> <span class="n">outp4</span><span class="p">)]</span>
        <span class="c1"># the slaves and their outputs have to disappear since calls are followed!</span>
        <span class="n">uuids_check_deleted</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">slave1</span><span class="p">,</span> <span class="n">slave2</span><span class="p">,</span> <span class="n">outp2</span><span class="p">)]</span>

        <span class="k">with</span> <span class="n">Capturing</span><span class="p">():</span>
            <span class="n">delete_nodes</span><span class="p">([</span><span class="n">wf</span><span class="o">.</span><span class="n">pk</span><span class="p">],</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">follow_calls</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">follow_returns</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_existence</span><span class="p">(</span><span class="n">uuids_check_existence</span><span class="p">,</span> <span class="n">uuids_check_deleted</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeDeletion.test_deletion_no_calls_no_returns"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeDeletion.test_deletion_no_calls_no_returns">[docs]</a>    <span class="k">def</span> <span class="nf">test_deletion_no_calls_no_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checking the case where I don&#39;t follow calls and also not return links for deletion</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">in1</span><span class="p">,</span> <span class="n">in2</span><span class="p">,</span> <span class="n">wf</span><span class="p">,</span> <span class="n">slave1</span><span class="p">,</span> <span class="n">outp1</span><span class="p">,</span> <span class="n">outp2</span><span class="p">,</span> <span class="n">slave2</span><span class="p">,</span> <span class="n">outp3</span><span class="p">,</span> <span class="n">outp4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_calls_n_returns_graph</span><span class="p">()</span>
        <span class="c1"># I don&#39;t follow calls, so the slaves and their output are unharmed, as well as input</span>
        <span class="n">uuids_check_existence</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">in2</span><span class="p">,</span> <span class="n">slave1</span><span class="p">,</span> <span class="n">outp1</span><span class="p">,</span> <span class="n">outp2</span><span class="p">,</span> <span class="n">outp3</span><span class="p">,</span> <span class="n">slave2</span><span class="p">,</span> <span class="n">outp4</span><span class="p">)]</span>
        <span class="c1"># the wf and it&#39;s direct output</span>
        <span class="n">uuids_check_deleted</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="n">wf</span><span class="p">,)]</span>

        <span class="k">with</span> <span class="n">Capturing</span><span class="p">():</span>
            <span class="n">delete_nodes</span><span class="p">([</span><span class="n">wf</span><span class="o">.</span><span class="n">pk</span><span class="p">],</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">follow_calls</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">follow_returns</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_existence</span><span class="p">(</span><span class="n">uuids_check_existence</span><span class="p">,</span> <span class="n">uuids_check_deleted</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_existence</span><span class="p">(</span><span class="n">uuids_check_existence</span><span class="p">,</span> <span class="n">uuids_check_deleted</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeDeletion.test_deletion_no_calls_with_returns"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeDeletion.test_deletion_no_calls_with_returns">[docs]</a>    <span class="k">def</span> <span class="nf">test_deletion_no_calls_with_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checking the case where I follow returns and not calls for deletion</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">in1</span><span class="p">,</span> <span class="n">in2</span><span class="p">,</span> <span class="n">wf</span><span class="p">,</span> <span class="n">slave1</span><span class="p">,</span> <span class="n">outp1</span><span class="p">,</span> <span class="n">outp2</span><span class="p">,</span> <span class="n">slave2</span><span class="p">,</span> <span class="n">outp3</span><span class="p">,</span> <span class="n">outp4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_calls_n_returns_graph</span><span class="p">()</span>
        <span class="c1"># I don&#39;t follow calls, so the slaves and their output are unharmed, as well as input</span>
        <span class="n">uuids_check_existence</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">in2</span><span class="p">,</span> <span class="n">slave1</span><span class="p">,</span> <span class="n">outp1</span><span class="p">,</span> <span class="n">slave2</span><span class="p">)]</span>
        <span class="c1"># the wf and it&#39;s direct output and what it returned</span>
        <span class="n">uuids_check_deleted</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outp3</span><span class="p">,</span> <span class="n">outp2</span><span class="p">,</span> <span class="n">outp4</span><span class="p">)]</span>

        <span class="k">with</span> <span class="n">Capturing</span><span class="p">():</span>
            <span class="n">delete_nodes</span><span class="p">([</span><span class="n">wf</span><span class="o">.</span><span class="n">pk</span><span class="p">],</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">follow_calls</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">follow_returns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_existence</span><span class="p">(</span><span class="n">uuids_check_existence</span><span class="p">,</span> <span class="n">uuids_check_deleted</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_existence</span><span class="p">(</span><span class="n">uuids_check_existence</span><span class="p">,</span> <span class="n">uuids_check_deleted</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeDeletion.test_deletion_with_returns_n_loops"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeDeletion.test_deletion_with_returns_n_loops">[docs]</a>    <span class="k">def</span> <span class="nf">test_deletion_with_returns_n_loops</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setting up a simple loop, to check that the following doesn&#39;t go bananas.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">in1</span><span class="p">,</span> <span class="n">in2</span><span class="p">,</span> <span class="n">wf</span> <span class="o">=</span> <span class="p">[</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">(),</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">(),</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()]</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_WORK</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link1&#39;</span><span class="p">)</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">in2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_WORK</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link2&#39;</span><span class="p">)</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">in2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link3&#39;</span><span class="p">)</span>

        <span class="n">uuids_check_existence</span> <span class="o">=</span> <span class="p">(</span><span class="n">in1</span><span class="o">.</span><span class="n">uuid</span><span class="p">,)</span>
        <span class="n">uuids_check_deleted</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">in2</span><span class="p">)]</span>

        <span class="k">with</span> <span class="n">Capturing</span><span class="p">():</span>
            <span class="n">delete_nodes</span><span class="p">([</span><span class="n">wf</span><span class="o">.</span><span class="n">pk</span><span class="p">],</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">follow_returns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_existence</span><span class="p">(</span><span class="n">uuids_check_existence</span><span class="p">,</span> <span class="n">uuids_check_deleted</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestNodeDeletion.test_delete_called_but_not_caller"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_nodes.TestNodeDeletion.test_delete_called_but_not_caller">[docs]</a>    <span class="k">def</span> <span class="nf">test_delete_called_but_not_caller</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that deleting a ProcessNode that was called by another ProcessNode which won&#39;t be</span>
<span class="sd">        deleted works, even though it will raise a warning</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">caller</span><span class="p">,</span> <span class="n">called</span> <span class="o">=</span> <span class="p">[</span><span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
        <span class="n">called</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>
        <span class="n">caller</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">called</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">uuids_check_existence</span> <span class="o">=</span> <span class="p">(</span><span class="n">caller</span><span class="o">.</span><span class="n">uuid</span><span class="p">,)</span>
        <span class="n">uuids_check_deleted</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="n">called</span><span class="p">,)]</span>

        <span class="k">with</span> <span class="n">Capturing</span><span class="p">():</span>
            <span class="n">delete_nodes</span><span class="p">([</span><span class="n">called</span><span class="o">.</span><span class="n">pk</span><span class="p">],</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">follow_returns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_existence</span><span class="p">(</span><span class="n">uuids_check_existence</span><span class="p">,</span> <span class="n">uuids_check_deleted</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>