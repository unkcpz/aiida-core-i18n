

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.backends.tests.test_export_and_import &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
          <li><a href="../tests.html">aiida.backends.tests</a> &raquo;</li>
        
      <li>aiida.backends.tests.test_export_and_import</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.backends.tests.test_export_and_import</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Tests for the export and import routines.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">with_statement</span>

<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">zip</span>

<span class="kn">from</span> <span class="nn">aiida</span> <span class="k">import</span> <span class="n">orm</span>
<span class="kn">from</span> <span class="nn">aiida.backends.testbase</span> <span class="k">import</span> <span class="n">AiidaTestCase</span>
<span class="kn">from</span> <span class="nn">aiida.common.utils</span> <span class="k">import</span> <span class="n">get_new_uuid</span>
<span class="kn">from</span> <span class="nn">aiida.orm.importexport</span> <span class="k">import</span> <span class="n">import_data</span><span class="p">,</span> <span class="n">export</span>
<span class="kn">from</span> <span class="nn">aiida.backends.tests.utils.configuration</span> <span class="k">import</span> <span class="n">with_temp_dir</span>


<div class="viewcode-block" id="TestSpecificImport"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestSpecificImport">[docs]</a><span class="k">class</span> <span class="nc">TestSpecificImport</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test specific ex-/import cases&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestSpecificImport.setUp"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestSpecificImport.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestSpecificImport</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestSpecificImport.tearDown"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestSpecificImport.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestSpecificImport.test_simple_import"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestSpecificImport.test_simple_import">[docs]</a>    <span class="k">def</span> <span class="nf">test_simple_import</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a very simple test which checks that an export file with nodes</span>
<span class="sd">        that are not associated to a computer is imported correctly. In Django</span>
<span class="sd">        when such nodes are exported, there is an empty set for computers</span>
<span class="sd">        in the export file. In SQLA there is such a set only when a computer is</span>
<span class="sd">        associated with the exported nodes. When an empty computer set is</span>
<span class="sd">        found at the export file (when imported to an SQLA profile), the SQLA</span>
<span class="sd">        import code used to crash. This test demonstrates this problem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;Pr&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;cutoff&#39;</span><span class="p">:</span> <span class="mf">50.0</span><span class="p">,</span>
                <span class="s1">&#39;pseudo_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Wentzcovitch&#39;</span><span class="p">,</span>
                <span class="s1">&#39;dual&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                <span class="s1">&#39;cutoff_units&#39;</span><span class="p">:</span> <span class="s1">&#39;Ry&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;Ru&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;cutoff&#39;</span><span class="p">:</span> <span class="mf">40.0</span><span class="p">,</span>
                <span class="s1">&#39;pseudo_type&#39;</span><span class="p">:</span> <span class="s1">&#39;SG15&#39;</span><span class="p">,</span>
                <span class="s1">&#39;dual&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                <span class="s1">&#39;cutoff_units&#39;</span><span class="p">:</span> <span class="s1">&#39;Ry&#39;</span>
            <span class="p">},</span>
        <span class="p">})</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameters</span><span class="p">]</span>
            <span class="n">export</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">handle</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Check that we have the expected number of nodes in the database</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">))</span>

            <span class="c1"># Clean the database and verify there are no nodes left</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># After importing we should have the original number of nodes again</span>
            <span class="n">import_data</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestSpecificImport.test_cycle_structure_data"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestSpecificImport.test_cycle_structure_data">[docs]</a>    <span class="k">def</span> <span class="nf">test_cycle_structure_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an export with some orm.CalculationNode and Data nodes and import it after having</span>
<span class="sd">        cleaned the database. Verify that the nodes and their attributes are restored</span>
<span class="sd">        properly after importing the created export archive</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>

        <span class="n">test_label</span> <span class="o">=</span> <span class="s1">&#39;Test structure&#39;</span>
        <span class="n">test_cell</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mf">8.34</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.298041701839357</span><span class="p">,</span> <span class="mf">8.53479766274308</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.842650688117053</span><span class="p">,</span> <span class="mf">0.47118495164127</span><span class="p">,</span> <span class="mf">10.6965192730702</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">test_kinds</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;symbols&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">u</span><span class="s1">&#39;Fe&#39;</span><span class="p">],</span>
                <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">],</span>
                <span class="s1">&#39;mass&#39;</span><span class="p">:</span> <span class="mf">55.845</span><span class="p">,</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Fe&#39;</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s1">&#39;symbols&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">u</span><span class="s1">&#39;S&#39;</span><span class="p">],</span>
                <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">],</span>
                <span class="s1">&#39;mass&#39;</span><span class="p">:</span> <span class="mf">32.065</span><span class="p">,</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;S&#39;</span>
            <span class="p">}</span>
        <span class="p">]</span>

        <span class="n">structure</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="n">test_cell</span><span class="p">)</span>
        <span class="n">structure</span><span class="o">.</span><span class="n">append_atom</span><span class="p">(</span><span class="n">symbols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Fe&#39;</span><span class="p">],</span> <span class="n">position</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">structure</span><span class="o">.</span><span class="n">append_atom</span><span class="p">(</span><span class="n">symbols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">],</span> <span class="n">position</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">structure</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">test_label</span>
        <span class="n">structure</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">parent_process</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">parent_process</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
        <span class="n">parent_process</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">child_calculation</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">child_calculation</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
        <span class="n">remote_folder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">RemoteData</span><span class="p">(</span><span class="n">computer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">,</span> <span class="n">remote_path</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">remote_folder</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">parent_process</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>
        <span class="n">child_calculation</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">remote_folder</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>
        <span class="n">child_calculation</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">structure</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">child_calculation</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>

            <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">structure</span><span class="p">,</span> <span class="n">child_calculation</span><span class="p">,</span> <span class="n">parent_process</span><span class="p">,</span> <span class="n">remote_folder</span><span class="p">]</span>
            <span class="n">export</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">handle</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Check that we have the expected number of nodes in the database</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">))</span>

            <span class="c1"># Clean the database and verify there are no nodes left</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># After importing we should have the original number of nodes again</span>
            <span class="n">import_data</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">))</span>

            <span class="c1"># Verify that orm.CalculationNodes have non-empty attribute dictionaries</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">[</span><span class="n">calculation</span><span class="p">]</span> <span class="ow">in</span> <span class="n">builder</span><span class="o">.</span><span class="n">iterall</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">calculation</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">calculation</span><span class="o">.</span><span class="n">attributes</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Verify that the structure data maintained its label, cell and kinds</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">[</span><span class="n">structure</span><span class="p">]</span> <span class="ow">in</span> <span class="n">builder</span><span class="o">.</span><span class="n">iterall</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">test_label</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">test_cell</span><span class="p">)</span>

            <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;attributes.kinds&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="p">[</span><span class="n">kinds</span><span class="p">]</span> <span class="ow">in</span> <span class="n">builder</span><span class="o">.</span><span class="n">iterall</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kinds</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="n">kinds</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">test_kinds</span><span class="p">)</span>

            <span class="c1"># Check that there is a StructureData that is an output of a orm.CalculationNode</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;calculation&#39;</span><span class="p">)</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">,</span> <span class="n">with_incoming</span><span class="o">=</span><span class="s1">&#39;calculation&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertGreater</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Check that there is a RemoteData that is a child and parent of a orm.CalculationNode</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;parent&#39;</span><span class="p">)</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">RemoteData</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">],</span> <span class="n">with_incoming</span><span class="o">=</span><span class="s1">&#39;parent&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">with_incoming</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertGreater</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestSimple"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestSimple">[docs]</a><span class="k">class</span> <span class="nc">TestSimple</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test simple ex-/import cases&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestSimple.setUp"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestSimple.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestSimple.tearDown"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestSimple.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span></div>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_base_data_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test ex-/import of Base Data nodes&quot;&quot;&quot;</span>
        <span class="c1"># producing values for each base type</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2399834e12</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1"># , [&quot;Bla&quot;, 1, 1e-10])</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export.tar.gz&quot;</span><span class="p">)</span>

        <span class="c1"># producing nodes:</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span> <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Str</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Bool</span><span class="p">))]</span>
        <span class="c1"># my uuid - list to reload the node:</span>
        <span class="n">uuids</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">]</span>
        <span class="c1"># exporting the nodes:</span>
        <span class="n">export</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># cleaning:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
        <span class="c1"># Importing back the data:</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Checking whether values are preserved:</span>
        <span class="k">for</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">refval</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">uuids</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">refval</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_calc_of_structuredata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simple ex-/import of CalcJobNode with input StructureData&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>
        <span class="kn">from</span> <span class="nn">aiida.plugins</span> <span class="k">import</span> <span class="n">DataFactory</span>

        <span class="n">StructureData</span> <span class="o">=</span> <span class="n">DataFactory</span><span class="p">(</span><span class="s1">&#39;structure&#39;</span><span class="p">)</span>
        <span class="n">struct</span> <span class="o">=</span> <span class="n">StructureData</span><span class="p">()</span>
        <span class="n">struct</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">calc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">()</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;num_machines&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;num_mpiprocs_per_machine&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">pks</span> <span class="o">=</span> <span class="p">[</span><span class="n">struct</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">calc</span><span class="o">.</span><span class="n">pk</span><span class="p">]</span>

        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">pks</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
            <span class="n">attrs</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">attrs</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export.tar.gz&quot;</span><span class="p">)</span>

        <span class="n">export</span><span class="p">([</span><span class="n">calc</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>

        <span class="c1"># NOTE: it is better to load new nodes by uuid, rather than assuming</span>
        <span class="c1"># that they will have the first 3 pks. In fact, a recommended policy in</span>
        <span class="c1"># databases is that pk always increment, even if you&#39;ve deleted elements</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">uuid</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>

<div class="viewcode-block" id="TestSimple.test_check_for_export_format_version"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestSimple.test_check_for_export_format_version">[docs]</a>    <span class="k">def</span> <span class="nf">test_check_for_export_format_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test the check for the export format version.&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">tarfile</span>

        <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">exceptions</span>
        <span class="kn">from</span> <span class="nn">aiida.plugins</span> <span class="k">import</span> <span class="n">DataFactory</span>
        <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">json</span>

        <span class="c1"># Creating a folder for the import/export files</span>
        <span class="n">export_file_tmp_folder</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="n">unpack_tmp_folder</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">StructureData</span> <span class="o">=</span> <span class="n">DataFactory</span><span class="p">(</span><span class="s1">&#39;structure&#39;</span><span class="p">)</span>
            <span class="n">struct</span> <span class="o">=</span> <span class="n">StructureData</span><span class="p">()</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">export_file_tmp_folder</span><span class="p">,</span> <span class="s2">&quot;export.tar.gz&quot;</span><span class="p">)</span>
            <span class="n">export</span><span class="p">([</span><span class="n">struct</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r:gz&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">tarfile</span><span class="o">.</span><span class="n">PAX_FORMAT</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
                <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">unpack_tmp_folder</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unpack_tmp_folder</span><span class="p">,</span>
                                      <span class="s1">&#39;metadata.json&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fhandle</span><span class="p">)</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;export_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unpack_tmp_folder</span><span class="p">,</span> <span class="s1">&#39;metadata.json&#39;</span><span class="p">),</span>
                         <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w:gz&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">tarfile</span><span class="o">.</span><span class="n">PAX_FORMAT</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
                <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">unpack_tmp_folder</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tearDownClass</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">IncompatibleArchiveVersionError</span><span class="p">):</span>
                <span class="n">import_data</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Deleting the created temporary folders</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">export_file_tmp_folder</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">unpack_tmp_folder</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestSimple.test_control_of_licenses"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestSimple.test_control_of_licenses">[docs]</a>    <span class="k">def</span> <span class="nf">test_control_of_licenses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test control of licenses.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">LicensingException</span>
        <span class="kn">from</span> <span class="nn">aiida.common.folders</span> <span class="k">import</span> <span class="n">SandboxFolder</span>
        <span class="kn">from</span> <span class="nn">aiida.orm.importexport</span> <span class="k">import</span> <span class="n">export_tree</span>

        <span class="kn">from</span> <span class="nn">aiida.plugins</span> <span class="k">import</span> <span class="n">DataFactory</span>

        <span class="n">StructureData</span> <span class="o">=</span> <span class="n">DataFactory</span><span class="p">(</span><span class="s1">&#39;structure&#39;</span><span class="p">)</span>
        <span class="n">struct</span> <span class="o">=</span> <span class="n">StructureData</span><span class="p">()</span>
        <span class="n">struct</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;license&#39;</span><span class="p">:</span> <span class="s1">&#39;GPL&#39;</span><span class="p">}</span>
        <span class="n">struct</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="n">SandboxFolder</span><span class="p">()</span>
        <span class="n">export_tree</span><span class="p">([</span><span class="n">struct</span><span class="p">],</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">allowed_licenses</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GPL&#39;</span><span class="p">])</span>
        <span class="c1"># Folder should contain two files of metadata + nodes/</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">get_content_list</span><span class="p">()),</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="n">SandboxFolder</span><span class="p">()</span>
        <span class="n">export_tree</span><span class="p">([</span><span class="n">struct</span><span class="p">],</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">forbidden_licenses</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Academic&#39;</span><span class="p">])</span>
        <span class="c1"># Folder should contain two files of metadata + nodes/</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">get_content_list</span><span class="p">()),</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="n">SandboxFolder</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">LicensingException</span><span class="p">):</span>
            <span class="n">export_tree</span><span class="p">([</span><span class="n">struct</span><span class="p">],</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">allowed_licenses</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CC0&#39;</span><span class="p">])</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="n">SandboxFolder</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">LicensingException</span><span class="p">):</span>
            <span class="n">export_tree</span><span class="p">([</span><span class="n">struct</span><span class="p">],</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">forbidden_licenses</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GPL&#39;</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">cc_filter</span><span class="p">(</span><span class="n">license_</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">license_</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;CC&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">gpl_filter</span><span class="p">(</span><span class="n">license_</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">license_</span> <span class="o">==</span> <span class="s1">&#39;GPL&#39;</span>

        <span class="k">def</span> <span class="nf">crashing_filter</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;not implemented yet&quot;</span><span class="p">)</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="n">SandboxFolder</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">LicensingException</span><span class="p">):</span>
            <span class="n">export_tree</span><span class="p">([</span><span class="n">struct</span><span class="p">],</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">allowed_licenses</span><span class="o">=</span><span class="n">cc_filter</span><span class="p">)</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="n">SandboxFolder</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">LicensingException</span><span class="p">):</span>
            <span class="n">export_tree</span><span class="p">([</span><span class="n">struct</span><span class="p">],</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">forbidden_licenses</span><span class="o">=</span><span class="n">gpl_filter</span><span class="p">)</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="n">SandboxFolder</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">LicensingException</span><span class="p">):</span>
            <span class="n">export_tree</span><span class="p">([</span><span class="n">struct</span><span class="p">],</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">allowed_licenses</span><span class="o">=</span><span class="n">crashing_filter</span><span class="p">)</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="n">SandboxFolder</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">LicensingException</span><span class="p">):</span>
            <span class="n">export_tree</span><span class="p">([</span><span class="n">struct</span><span class="p">],</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">forbidden_licenses</span><span class="o">=</span><span class="n">crashing_filter</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestUsers"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestUsers">[docs]</a><span class="k">class</span> <span class="nc">TestUsers</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test ex-/import cases related to Users&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestUsers.setUp"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestUsers.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestUsers.tearDown"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestUsers.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span></div>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_nodes_belonging_to_different_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This test checks that nodes belonging to different users are correctly</span>
<span class="sd">        exported &amp; imported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>
        <span class="kn">from</span> <span class="nn">aiida.manage.manager</span> <span class="k">import</span> <span class="n">get_manager</span>

        <span class="n">manager</span> <span class="o">=</span> <span class="n">get_manager</span><span class="p">()</span>

        <span class="c1"># Create another user</span>
        <span class="n">new_email</span> <span class="o">=</span> <span class="s2">&quot;newuser@new.n&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">new_email</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Create a structure data node that has a calculation as output</span>
        <span class="n">sd1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">()</span>
        <span class="n">sd1</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="n">sd1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;sd1&#39;</span>
        <span class="n">sd1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">jc1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">()</span>
        <span class="n">jc1</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>
        <span class="n">jc1</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;num_machines&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;num_mpiprocs_per_machine&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">jc1</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="n">jc1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;jc1&#39;</span>
        <span class="n">jc1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">sd1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>
        <span class="n">jc1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Create some nodes from a different user</span>
        <span class="n">sd2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">()</span>
        <span class="n">sd2</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="n">sd2</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;sd2&#39;</span>
        <span class="n">sd2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">sd2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">jc1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">)</span>  <span class="c1"># I assume jc1 CREATED sd2</span>

        <span class="n">jc2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">()</span>
        <span class="n">jc2</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>
        <span class="n">jc2</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;num_machines&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;num_mpiprocs_per_machine&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">jc2</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;jc2&#39;</span>
        <span class="n">jc2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">sd2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">)</span>
        <span class="n">jc2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">sd3</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">()</span>
        <span class="n">sd3</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;sd3&#39;</span>
        <span class="n">sd3</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">sd3</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">jc2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;l3&#39;</span><span class="p">)</span>

        <span class="n">uuids_u1</span> <span class="o">=</span> <span class="p">[</span><span class="n">sd1</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">jc1</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">sd2</span><span class="o">.</span><span class="n">uuid</span><span class="p">]</span>
        <span class="n">uuids_u2</span> <span class="o">=</span> <span class="p">[</span><span class="n">jc2</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">sd3</span><span class="o">.</span><span class="n">uuid</span><span class="p">]</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export.tar.gz&quot;</span><span class="p">)</span>

        <span class="n">export</span><span class="p">([</span><span class="n">sd3</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check that the imported nodes are correctly imported and that</span>
        <span class="c1"># the user assigned to the nodes is the right one</span>
        <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">uuids_u1</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">uuid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">new_email</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">uuids_u2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_profile</span><span class="p">()</span><span class="o">.</span><span class="n">default_user</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_non_default_user_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This test checks that nodes belonging to user A (which is not the</span>
<span class="sd">        default user) can be correctly exported, imported, enriched with nodes</span>
<span class="sd">        from the default user, re-exported &amp; re-imported and that in the end</span>
<span class="sd">        all the nodes that have been finally imported belonging to the right</span>
<span class="sd">        users.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>
        <span class="kn">from</span> <span class="nn">aiida.manage.manager</span> <span class="k">import</span> <span class="n">get_manager</span>

        <span class="n">manager</span> <span class="o">=</span> <span class="n">get_manager</span><span class="p">()</span>

        <span class="c1"># Create another user</span>
        <span class="n">new_email</span> <span class="o">=</span> <span class="s2">&quot;newuser@new.n&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">new_email</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Create a structure data node that has a calculation as output</span>
        <span class="n">sd1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">()</span>
        <span class="n">sd1</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="n">sd1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;sd1&#39;</span>
        <span class="n">sd1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">jc1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">()</span>
        <span class="n">jc1</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>
        <span class="n">jc1</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;num_machines&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;num_mpiprocs_per_machine&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">jc1</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="n">jc1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;jc1&#39;</span>
        <span class="n">jc1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">sd1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>
        <span class="n">jc1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Create some nodes from a different user</span>
        <span class="n">sd2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">()</span>
        <span class="n">sd2</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="n">sd2</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;sd2&#39;</span>
        <span class="n">sd2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">sd2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">jc1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">)</span>
        <span class="n">sd2_uuid</span> <span class="o">=</span> <span class="n">sd2</span><span class="o">.</span><span class="n">uuid</span>

        <span class="c1"># At this point we export the generated data</span>
        <span class="n">filename1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export1.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">sd2</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">uuids1</span> <span class="o">=</span> <span class="p">[</span><span class="n">sd1</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">jc1</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">sd2</span><span class="o">.</span><span class="n">uuid</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_data</span><span class="p">()</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check that the imported nodes are correctly imported and that</span>
        <span class="c1"># the user assigned to the nodes is the right one</span>
        <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">uuids1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">new_email</span><span class="p">)</span>

        <span class="c1"># Now we continue to generate more data based on the imported</span>
        <span class="c1"># data</span>
        <span class="n">sd2_imp</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">sd2_uuid</span><span class="p">)</span>

        <span class="n">jc2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">()</span>
        <span class="n">jc2</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>
        <span class="n">jc2</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;num_machines&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;num_mpiprocs_per_machine&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">jc2</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;jc2&#39;</span>
        <span class="n">jc2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">sd2_imp</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">)</span>
        <span class="n">jc2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">sd3</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">()</span>
        <span class="n">sd3</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;sd3&#39;</span>
        <span class="n">sd3</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">sd3</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">jc2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;l3&#39;</span><span class="p">)</span>

        <span class="c1"># Store the UUIDs of the nodes that should be checked</span>
        <span class="c1"># if they can be imported correctly.</span>
        <span class="n">uuids2</span> <span class="o">=</span> <span class="p">[</span><span class="n">jc2</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">sd3</span><span class="o">.</span><span class="n">uuid</span><span class="p">]</span>

        <span class="n">filename2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export2.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">sd3</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename2</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_data</span><span class="p">()</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename2</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check that the imported nodes are correctly imported and that</span>
        <span class="c1"># the user assigned to the nodes is the right one</span>
        <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">uuids1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">new_email</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">uuids2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_profile</span><span class="p">()</span><span class="o">.</span><span class="n">default_user</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestGroups"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestGroups">[docs]</a><span class="k">class</span> <span class="nc">TestGroups</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test ex-/import cases related to Groups&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestGroups.setUp"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestGroups.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestGroups.tearDown"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestGroups.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span></div>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_nodes_in_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This test checks that nodes that belong to a specific group are</span>
<span class="sd">        correctly imported and exported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>

        <span class="c1"># Create another user</span>
        <span class="n">new_email</span> <span class="o">=</span> <span class="s2">&quot;newuser@new.n&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">new_email</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Create a structure data node that has a calculation as output</span>
        <span class="n">sd1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">()</span>
        <span class="n">sd1</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="n">sd1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;sd1&#39;</span>
        <span class="n">sd1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">jc1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">()</span>
        <span class="n">jc1</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>
        <span class="n">jc1</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;num_machines&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;num_mpiprocs_per_machine&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">jc1</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="n">jc1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;jc1&#39;</span>
        <span class="n">jc1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">sd1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>
        <span class="n">jc1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Create a group and add the data inside</span>
        <span class="n">gr1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;node_group&quot;</span><span class="p">)</span>
        <span class="n">gr1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">gr1</span><span class="o">.</span><span class="n">add_nodes</span><span class="p">([</span><span class="n">sd1</span><span class="p">,</span> <span class="n">jc1</span><span class="p">])</span>
        <span class="n">gr1_uuid</span> <span class="o">=</span> <span class="n">gr1</span><span class="o">.</span><span class="n">uuid</span>

        <span class="c1"># At this point we export the generated data</span>
        <span class="n">filename1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export1.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">sd1</span><span class="p">,</span> <span class="n">jc1</span><span class="p">,</span> <span class="n">gr1</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename1</span><span class="p">,</span>
                <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">n_uuids</span> <span class="o">=</span> <span class="p">[</span><span class="n">sd1</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">jc1</span><span class="o">.</span><span class="n">uuid</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_data</span><span class="p">()</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check that the imported nodes are correctly imported and that</span>
        <span class="c1"># the user assigned to the nodes is the right one</span>
        <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">n_uuids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">new_email</span><span class="p">)</span>

        <span class="c1"># Check that the exported group is imported correctly</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;uuid&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;==&#39;</span><span class="p">:</span> <span class="n">gr1_uuid</span><span class="p">}})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;The group was not found.&quot;</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_group_export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test that when exporting just a group, its nodes are also exported&quot;&quot;&quot;</span>
        <span class="c1"># Create another user</span>
        <span class="n">new_email</span> <span class="o">=</span> <span class="s2">&quot;newuser@new.n&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">new_email</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Create a structure data node</span>
        <span class="n">sd1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">()</span>
        <span class="n">sd1</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="n">sd1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;sd1&#39;</span>
        <span class="n">sd1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Create a group and add the data inside</span>
        <span class="n">g1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;node_group&quot;</span><span class="p">)</span>
        <span class="n">g1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">g1</span><span class="o">.</span><span class="n">add_nodes</span><span class="p">([</span><span class="n">sd1</span><span class="p">])</span>
        <span class="n">g1_uuid</span> <span class="o">=</span> <span class="n">g1</span><span class="o">.</span><span class="n">uuid</span>

        <span class="c1"># At this point we export the generated data</span>
        <span class="n">filename1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export1.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">g1</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">n_uuids</span> <span class="o">=</span> <span class="p">[</span><span class="n">sd1</span><span class="o">.</span><span class="n">uuid</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_data</span><span class="p">()</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check that the imported nodes are correctly imported and that</span>
        <span class="c1"># the user assigned to the nodes is the right one</span>
        <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">n_uuids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">new_email</span><span class="p">)</span>

        <span class="c1"># Check that the exported group is imported correctly</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;uuid&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;==&#39;</span><span class="p">:</span> <span class="n">g1_uuid</span><span class="p">}})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;The group was not found.&quot;</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_group_import_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Testing what happens when I try to import a group that already exists in the</span>
<span class="sd">        database. This should raise an appropriate exception</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grouplabel</span> <span class="o">=</span> <span class="s2">&quot;node_group_existing&quot;</span>

        <span class="c1"># Create another user</span>
        <span class="n">new_email</span> <span class="o">=</span> <span class="s2">&quot;newuser@new.n&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">new_email</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Create a structure data node</span>
        <span class="n">sd1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">()</span>
        <span class="n">sd1</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="n">sd1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;sd&#39;</span>
        <span class="n">sd1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Create a group and add the data inside</span>
        <span class="n">g1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">grouplabel</span><span class="p">)</span>
        <span class="n">g1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">g1</span><span class="o">.</span><span class="n">add_nodes</span><span class="p">([</span><span class="n">sd1</span><span class="p">])</span>

        <span class="c1"># At this point we export the generated data</span>
        <span class="n">filename1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export1.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">g1</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_data</span><span class="p">()</span>

        <span class="c1"># Creating a group of the same name</span>
        <span class="n">g1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;node_group_existing&quot;</span><span class="p">)</span>
        <span class="n">g1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># The import should have created a new group with a suffix</span>
        <span class="c1"># I check for this:</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;like&#39;</span><span class="p">:</span> <span class="n">grouplabel</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">}})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Now I check for the group having one member, and whether the name is different:</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;like&#39;</span><span class="p">:</span> <span class="n">grouplabel</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">}},</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">,</span> <span class="n">with_group</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># I check that the group name was changed:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">grouplabel</span><span class="p">)</span>
        <span class="c1"># I import another name, the group should not be imported again</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;like&#39;</span><span class="p">:</span> <span class="n">grouplabel</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">}})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestCalculations"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestCalculations">[docs]</a><span class="k">class</span> <span class="nc">TestCalculations</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test ex-/import cases related to Calculations&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestCalculations.setUp"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestCalculations.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestCalculations.tearDown"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestCalculations.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span></div>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_calcfunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test @calcfunction&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.engine</span> <span class="k">import</span> <span class="n">calcfunction</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">NotExistent</span>

        <span class="nd">@calcfunction</span>
        <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Add 2 numbers&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;res&#39;</span><span class="p">:</span> <span class="n">orm</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)}</span>

        <span class="k">def</span> <span class="nf">max_</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;select the max value&quot;&quot;&quot;</span>
            <span class="n">max_val</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([(</span><span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;res&#39;</span><span class="p">:</span> <span class="n">max_val</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>

        <span class="c1"># I&#39;m creating a bunch of numbers</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="c1"># this adds the maximum number between bcde to a.</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">max_</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">)[</span><span class="s1">&#39;res&#39;</span><span class="p">])[</span><span class="s1">&#39;res&#39;</span><span class="p">]</span>
        <span class="c1"># These are the uuids that would be exported as well (as parents) if I wanted the final result</span>
        <span class="n">uuids_values</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">value</span><span class="p">)]</span>
        <span class="c1"># These are the uuids that shouldn&#39;t be exported since it&#39;s a selection.</span>
        <span class="n">not_wanted_uuids</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)]</span>
        <span class="c1"># At this point we export the generated data</span>
        <span class="n">filename1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export1.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">res</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_reversed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_data</span><span class="p">()</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Check that the imported nodes are correctly imported and that the value is preserved</span>
        <span class="k">for</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">uuids_values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">not_wanted_uuids</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">NotExistent</span><span class="p">):</span>
                <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_workcalculation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test simple master/slave WorkChainNodes&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>

        <span class="n">master</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkChainNode</span><span class="p">()</span>
        <span class="n">slave</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkChainNode</span><span class="p">()</span>

        <span class="n">input_1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">input_2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">output_1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">master</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">input_1</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_WORK</span><span class="p">,</span> <span class="s1">&#39;input_1&#39;</span><span class="p">)</span>
        <span class="n">slave</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="p">,</span> <span class="s1">&#39;CALL&#39;</span><span class="p">)</span>
        <span class="n">slave</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">input_2</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_WORK</span><span class="p">,</span> <span class="s1">&#39;input_2&#39;</span><span class="p">)</span>

        <span class="n">master</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">slave</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">output_1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">,</span> <span class="s1">&#39;RETURN&#39;</span><span class="p">)</span>

        <span class="n">uuids_values</span> <span class="o">=</span> <span class="p">[(</span><span class="n">v</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">output_1</span><span class="p">,)]</span>
        <span class="n">filename1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export1.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">output_1</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_data</span><span class="p">()</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">uuids_values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestComplex"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestComplex">[docs]</a><span class="k">class</span> <span class="nc">TestComplex</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test complex ex-/import cases&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestComplex.setUp"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestComplex.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestComplex.tearDown"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestComplex.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span></div>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_complex_graph_import_export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This test checks that a small and bit complex graph can be correctly</span>
<span class="sd">        exported and imported.</span>

<span class="sd">        It will create the graph, store it to the database, export it to a file</span>
<span class="sd">        and import it. In the end it will check if the initial nodes are present</span>
<span class="sd">        at the imported graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">NotExistent</span>

        <span class="n">calc1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">()</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;num_machines&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;num_mpiprocs_per_machine&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;calc1&quot;</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">pd1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">()</span>
        <span class="n">pd1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;pd1&quot;</span>
        <span class="n">pd1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">pd2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">()</span>
        <span class="n">pd2</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;pd2&quot;</span>
        <span class="n">pd2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">rd1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">RemoteData</span><span class="p">()</span>
        <span class="n">rd1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;rd1&quot;</span>
        <span class="n">rd1</span><span class="o">.</span><span class="n">set_remote_path</span><span class="p">(</span><span class="s2">&quot;/x/y.py&quot;</span><span class="p">)</span>
        <span class="n">rd1</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>
        <span class="n">rd1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">rd1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">calc1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>

        <span class="n">calc2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">()</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;num_machines&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;num_mpiprocs_per_machine&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;calc2&quot;</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">pd1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link1&#39;</span><span class="p">)</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">pd2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link2&#39;</span><span class="p">)</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">rd1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link3&#39;</span><span class="p">)</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">fd1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">FolderData</span><span class="p">()</span>
        <span class="n">fd1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;fd1&quot;</span>
        <span class="n">fd1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">fd1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">calc2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>

        <span class="n">node_uuids_labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">calc1</span><span class="o">.</span><span class="n">uuid</span><span class="p">:</span> <span class="n">calc1</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">pd1</span><span class="o">.</span><span class="n">uuid</span><span class="p">:</span> <span class="n">pd1</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                                <span class="n">pd2</span><span class="o">.</span><span class="n">uuid</span><span class="p">:</span> <span class="n">pd2</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">rd1</span><span class="o">.</span><span class="n">uuid</span><span class="p">:</span> <span class="n">rd1</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                                <span class="n">calc2</span><span class="o">.</span><span class="n">uuid</span><span class="p">:</span> <span class="n">calc2</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">fd1</span><span class="o">.</span><span class="n">uuid</span><span class="p">:</span> <span class="n">fd1</span><span class="o">.</span><span class="n">label</span><span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">fd1</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>

        <span class="n">import_data</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_unknown_nodes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">node_uuids_labels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">NotExistent</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Node with UUID </span><span class="si">{}</span><span class="s2"> and label </span><span class="si">{}</span><span class="s2"> was not &quot;</span>
                            <span class="s2">&quot;found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_reexport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export something, import and reexport and check if everything is valid.</span>
<span class="sd">        The export is rather easy::</span>

<span class="sd">            ___       ___          ___</span>
<span class="sd">           |   | INP |   | CREATE |   |</span>
<span class="sd">           | p | --&gt; | c | -----&gt; | a |</span>
<span class="sd">           |___|     |___|        |___|</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">import</span> <span class="nn">string</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>

        <span class="kn">from</span> <span class="nn">aiida.common.hashing</span> <span class="k">import</span> <span class="n">make_hash</span>
        <span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>

        <span class="k">def</span> <span class="nf">get_hash_from_db_content</span><span class="p">(</span><span class="n">grouplabel</span><span class="p">):</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">edge_tag</span><span class="o">=</span><span class="s1">&#39;p2c&#39;</span><span class="p">,</span> <span class="n">edge_project</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">))</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">ArrayData</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">edge_tag</span><span class="o">=</span><span class="s1">&#39;c2a&#39;</span><span class="p">,</span> <span class="n">edge_project</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">))</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">grouplabel</span><span class="p">},</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">with_node</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="c1"># I want the query to contain something!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># The hash is given from the preservable entries in an export-import cycle,</span>
            <span class="c1"># uuids, attributes, labels, descriptions, arrays, link-labels, link-types:</span>
            <span class="n">hash_</span> <span class="o">=</span> <span class="n">make_hash</span><span class="p">([(</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span>
                <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_arraynames</span><span class="p">()],</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;p2c&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">],</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;p2c&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;c2a&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">],</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;c2a&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">builder</span><span class="o">.</span><span class="n">dict</span><span class="p">()])</span>
            <span class="k">return</span> <span class="n">hash_</span>

        <span class="c1"># Creating a folder for the import/export files</span>
        <span class="n">chars</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">grouplabel</span> <span class="o">=</span> <span class="s1">&#39;test-group&#39;</span>

        <span class="n">nparr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">trial_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># give some integers:</span>
        <span class="n">trial_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)})</span>
        <span class="c1"># give some floats:</span>
        <span class="n">trial_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)})</span>
        <span class="c1"># give some booleans:</span>
        <span class="n">trial_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="nb">bool</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">)})</span>
        <span class="c1"># give some datetime:</span>
        <span class="n">trial_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">datetime</span><span class="p">(</span>
            <span class="n">year</span><span class="o">=</span><span class="mi">2017</span><span class="p">,</span>
            <span class="n">month</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
            <span class="n">day</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">)})</span>
        <span class="c1"># give some text:</span>
        <span class="n">trial_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">)})</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="n">trial_dict</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="n">p</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;d_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="n">p</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="c1"># setting also trial dict as attributes, but randomizing the keys)</span>
        <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">10</span><span class="p">)),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">trial_dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">ArrayData</span><span class="p">()</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="n">nparr</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="c1"># LINKS</span>
        <span class="c1"># the calculation has input the parameters-instance</span>
        <span class="n">c</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;input_parameters&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="c1"># I want the array to be an output of the calculation</span>
        <span class="n">a</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;output_array&#39;</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;test-group&#39;</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">add_nodes</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="n">hash_from_dbcontent</span> <span class="o">=</span> <span class="n">get_hash_from_db_content</span><span class="p">(</span><span class="n">grouplabel</span><span class="p">)</span>

        <span class="c1"># I export and reimport 3 times in a row:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="c1"># Always new filename:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export-</span><span class="si">{}</span><span class="s2">.zip&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="c1"># Loading the group from the string</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">grouplabel</span><span class="p">)</span>
            <span class="c1"># exporting based on all members of the group</span>
            <span class="c1"># this also checks if group memberships are preserved!</span>
            <span class="n">export</span><span class="p">([</span><span class="n">g</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># cleaning the DB!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
            <span class="c1"># reimporting the data from the file</span>
            <span class="n">import_data</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_unknown_nodes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># creating the hash from db content</span>
            <span class="n">new_hash</span> <span class="o">=</span> <span class="n">get_hash_from_db_content</span><span class="p">(</span><span class="n">grouplabel</span><span class="p">)</span>
            <span class="c1"># I check for equality against the first hash created, which implies that hashes</span>
            <span class="c1"># are equal in all iterations of this process</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">hash_from_dbcontent</span><span class="p">,</span> <span class="n">new_hash</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestComputer"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestComputer">[docs]</a><span class="k">class</span> <span class="nc">TestComputer</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test ex-/import cases related to Computers&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestComputer.setUp"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestComputer.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestComputer.tearDown"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestComputer.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span></div>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_same_computer_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that you can import nodes in steps without any problems. In this</span>
<span class="sd">        test we will import a first calculation and then a second one. The</span>
<span class="sd">        import should work as expected and have in the end two job</span>
<span class="sd">        calculations.</span>

<span class="sd">        Each calculation is related to the same computer. In the end we should</span>
<span class="sd">        have only one computer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use local computer</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>

        <span class="c1"># Store two job calculation related to the same computer</span>
        <span class="n">calc1_label</span> <span class="o">=</span> <span class="s2">&quot;calc1&quot;</span>
        <span class="n">calc1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">()</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="n">comp</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;num_machines&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="s2">&quot;num_mpiprocs_per_machine&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">calc1_label</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">calc2_label</span> <span class="o">=</span> <span class="s2">&quot;calc2&quot;</span>
        <span class="n">calc2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">()</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="n">comp</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;num_machines&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                        <span class="s2">&quot;num_mpiprocs_per_machine&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">calc2_label</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Store locally the computer name</span>
        <span class="n">comp_name</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">comp_uuid</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="c1"># Export the first job calculation</span>
        <span class="n">filename1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export1.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc1</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Export the second job calculation</span>
        <span class="n">filename2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export2.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc2</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename2</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Clean the local database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>

        <span class="c1"># Check that there are no computers</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;There should not be any computers in the database at this point.&quot;</span><span class="p">)</span>

        <span class="c1"># Check that there are no calculations</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;There should not be any calculations in the database at this point.&quot;</span><span class="p">)</span>

        <span class="c1"># Import the first calculation</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check that the calculation computer is imported correctly.</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Only one calculation should be found.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">calc1_label</span><span class="p">,</span> <span class="s2">&quot;The calculation label is not correct.&quot;</span><span class="p">)</span>

        <span class="c1"># Check that the referenced computer is imported correctly.</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Only one computer should be found.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">comp_name</span><span class="p">,</span> <span class="s2">&quot;The computer name is not correct.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">comp_uuid</span><span class="p">,</span> <span class="s2">&quot;The computer uuid is not correct.&quot;</span><span class="p">)</span>

        <span class="c1"># Store the id of the computer</span>
        <span class="n">comp_id</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Import the second calculation</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename2</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check that the number of computers remains the same and its data</span>
        <span class="c1"># did not change.</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Found </span><span class="si">{}</span><span class="s2"> computers&quot;</span>
                            <span class="s2">&quot;but only one computer should be found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">comp_name</span><span class="p">,</span>
                            <span class="s2">&quot;The computer name is not correct.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">comp_uuid</span><span class="p">,</span>
                            <span class="s2">&quot;The computer uuid is not correct.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">2</span><span class="p">],</span> <span class="n">comp_id</span><span class="p">,</span>
                            <span class="s2">&quot;The computer id is not correct.&quot;</span><span class="p">)</span>

        <span class="c1"># Check that now you have two calculations attached to the same</span>
        <span class="c1"># computer.</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;comp&#39;</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">,</span> <span class="n">with_computer</span><span class="o">=</span><span class="s1">&#39;comp&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Two calculations should be found.&quot;</span><span class="p">)</span>
        <span class="n">ret_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">_</span> <span class="k">for</span> <span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="ow">in</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ret_labels</span><span class="p">,</span> <span class="nb">set</span><span class="p">([</span><span class="n">calc1_label</span><span class="p">,</span> <span class="n">calc2_label</span><span class="p">]),</span>
                            <span class="s2">&quot;The labels of the calculations are not correct.&quot;</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_same_computer_different_name_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This test checks that if the computer is re-imported with a different</span>
<span class="sd">        name to the same database, then the original computer will not be</span>
<span class="sd">        renamed. It also checks that the names were correctly imported (without</span>
<span class="sd">        any change since there is no computer name collision)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get computer</span>
        <span class="n">comp1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>

        <span class="c1"># Store a calculation</span>
        <span class="n">calc1_label</span> <span class="o">=</span> <span class="s2">&quot;calc1&quot;</span>
        <span class="n">calc1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">()</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;num_machines&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="s2">&quot;num_mpiprocs_per_machine&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">calc1_label</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Store locally the computer name</span>
        <span class="n">comp1_name</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">comp1</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Export the first job calculation</span>
        <span class="n">filename1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export1.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc1</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Rename the computer</span>
        <span class="n">comp1</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">comp1_name</span> <span class="o">+</span> <span class="s2">&quot;_updated&quot;</span><span class="p">)</span>

        <span class="c1"># Store a second calculation</span>
        <span class="n">calc2_label</span> <span class="o">=</span> <span class="s2">&quot;calc2&quot;</span>
        <span class="n">calc2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">()</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;num_machines&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                        <span class="s2">&quot;num_mpiprocs_per_machine&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">calc2_label</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Export the second job calculation</span>
        <span class="n">filename2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export2.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc2</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename2</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Clean the local database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>

        <span class="c1"># Check that there are no computers</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;There should not be any computers in the database at this point.&quot;</span><span class="p">)</span>

        <span class="c1"># Check that there are no calculations</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;There should not be any calculations in the database at this point.&quot;</span><span class="p">)</span>

        <span class="c1"># Import the first calculation</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check that the calculation computer is imported correctly.</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Only one calculation should be found.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">calc1_label</span><span class="p">,</span> <span class="s2">&quot;The calculation label is not correct.&quot;</span><span class="p">)</span>

        <span class="c1"># Check that the referenced computer is imported correctly.</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Only one computer should be found.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">comp1_name</span><span class="p">,</span> <span class="s2">&quot;The computer name is not correct.&quot;</span><span class="p">)</span>

        <span class="c1"># Import the second calculation</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename2</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check that the number of computers remains the same and its data</span>
        <span class="c1"># did not change.</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Found </span><span class="si">{}</span><span class="s2"> computers&quot;</span>
                            <span class="s2">&quot;but only one computer should be found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">comp1_name</span><span class="p">,</span>
                            <span class="s2">&quot;The computer name is not correct.&quot;</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_different_computer_same_name_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This test checks that if there is a name collision, the imported</span>
<span class="sd">        computers are renamed accordingly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.orm.importexport</span> <span class="k">import</span> <span class="n">DUPL_SUFFIX</span>

        <span class="c1"># Set the computer name</span>
        <span class="n">comp1_name</span> <span class="o">=</span> <span class="s2">&quot;localhost_1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">comp1_name</span><span class="p">)</span>

        <span class="c1"># Store a calculation</span>
        <span class="n">calc1_label</span> <span class="o">=</span> <span class="s2">&quot;calc1&quot;</span>
        <span class="n">calc1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">()</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;num_machines&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="s2">&quot;num_mpiprocs_per_machine&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">calc1_label</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Export the first job calculation</span>
        <span class="n">filename1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export1.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc1</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Reset the database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_data</span><span class="p">()</span>

        <span class="c1"># Set the computer name to the same name as before</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">comp1_name</span><span class="p">)</span>

        <span class="c1"># Store a second calculation</span>
        <span class="n">calc2_label</span> <span class="o">=</span> <span class="s2">&quot;calc2&quot;</span>
        <span class="n">calc2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">()</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;num_machines&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                        <span class="s2">&quot;num_mpiprocs_per_machine&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">calc2_label</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Export the second job calculation</span>
        <span class="n">filename2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export2.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc2</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename2</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Reset the database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_data</span><span class="p">()</span>

        <span class="c1"># Set the computer name to the same name as before</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">comp1_name</span><span class="p">)</span>

        <span class="c1"># Store a third calculation</span>
        <span class="n">calc3_label</span> <span class="o">=</span> <span class="s2">&quot;calc3&quot;</span>
        <span class="n">calc3</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">()</span>
        <span class="n">calc3</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>
        <span class="n">calc3</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;num_machines&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                        <span class="s2">&quot;num_mpiprocs_per_machine&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
        <span class="n">calc3</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">calc3_label</span>
        <span class="n">calc3</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Export the third job calculation</span>
        <span class="n">filename3</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export3.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc3</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename3</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Clean the local database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>

        <span class="c1"># Check that there are no computers</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;There should not be any computers&quot;</span>
                                                <span class="s2">&quot;in the database at this point.&quot;</span><span class="p">)</span>

        <span class="c1"># Check that there are no calculations</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;There should not be any &quot;</span>
                                                <span class="s2">&quot;calculations in the database at &quot;</span>
                                                <span class="s2">&quot;this point.&quot;</span><span class="p">)</span>

        <span class="c1"># Import all the calculations</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename2</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename3</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Retrieve the calculation-computer pairs</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;jcalc&#39;</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                    <span class="n">with_node</span><span class="o">=</span><span class="s1">&#39;jcalc&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;Three combinations expected.&quot;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">([</span><span class="n">calc1_label</span><span class="p">,</span> <span class="n">comp1_name</span><span class="p">],</span> <span class="n">res</span><span class="p">,</span>
                        <span class="s2">&quot;Calc-Computer combination not found.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">([</span><span class="n">calc2_label</span><span class="p">,</span>
                        <span class="n">comp1_name</span> <span class="o">+</span> <span class="n">DUPL_SUFFIX</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">)],</span> <span class="n">res</span><span class="p">,</span>
                        <span class="s2">&quot;Calc-Computer combination not found.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">([</span><span class="n">calc3_label</span><span class="p">,</span>
                        <span class="n">comp1_name</span> <span class="o">+</span> <span class="n">DUPL_SUFFIX</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">1</span><span class="p">)],</span> <span class="n">res</span><span class="p">,</span>
                        <span class="s2">&quot;Calc-Computer combination not found.&quot;</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_correct_import_of_computer_json_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This test checks that the metadata and transport params are</span>
<span class="sd">        exported and imported correctly in both backends.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the computer name</span>
        <span class="n">comp1_name</span> <span class="o">=</span> <span class="s2">&quot;localhost_1&quot;</span>
        <span class="n">comp1_metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">u</span><span class="s1">&#39;workdir&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;/tmp/aiida&#39;</span>
        <span class="p">}</span>
        <span class="n">comp1_transport_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">u</span><span class="s1">&#39;key1&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;value1&#39;</span><span class="p">,</span>
            <span class="sa">u</span><span class="s1">&#39;key2&#39;</span><span class="p">:</span> <span class="mi">2</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">comp1_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="n">comp1_metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">set_transport_params</span><span class="p">(</span><span class="n">comp1_transport_params</span><span class="p">)</span>

        <span class="c1"># Store a calculation</span>
        <span class="n">calc1_label</span> <span class="o">=</span> <span class="s2">&quot;calc1&quot;</span>
        <span class="n">calc1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">()</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;num_machines&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="s2">&quot;num_mpiprocs_per_machine&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">calc1_label</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Export the first job calculation</span>
        <span class="n">filename1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export1.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc1</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Clean the local database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
        <span class="c1"># Import the data</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;transport_params&#39;</span><span class="p">,</span> <span class="s1">&#39;_metadata&#39;</span><span class="p">],</span>
                    <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;comp&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Expected only one computer&quot;</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">dict</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">][</span><span class="s1">&#39;transport_params&#39;</span><span class="p">],</span>
                            <span class="n">comp1_transport_params</span><span class="p">,</span>
                            <span class="s2">&quot;Not the expected transport parameters &quot;</span>
                            <span class="s2">&quot;were found&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">][</span><span class="s1">&#39;_metadata&#39;</span><span class="p">],</span>
                            <span class="n">comp1_metadata</span><span class="p">,</span>
                            <span class="s2">&quot;Not the expected metadata were found&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="TestComputer.test_import_of_django_sqla_export_file"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestComputer.test_import_of_django_sqla_export_file">[docs]</a>    <span class="nd">@unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Reenable when issue #2426 has been solved (migrate exported files from 0.3 to 0.4)&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_import_of_django_sqla_export_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that sqla import manages to import the django export file correctly&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.backends.tests.utils.fixtures</span> <span class="k">import</span> <span class="n">import_archive_fixture</span>

        <span class="k">for</span> <span class="n">archive</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;export/compare/django.aiida&#39;</span><span class="p">,</span> <span class="s1">&#39;export/compare/sqlalchemy.aiida&#39;</span><span class="p">]:</span>
            <span class="c1"># Clean the database</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>

            <span class="c1"># Import the needed data</span>
            <span class="n">import_archive_fixture</span><span class="p">(</span><span class="n">archive</span><span class="p">)</span>

            <span class="c1"># The expected metadata &amp; transport parameters</span>
            <span class="n">comp1_metadata</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sa">u</span><span class="s1">&#39;workdir&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;/tmp/aiida&#39;</span>
            <span class="p">}</span>
            <span class="n">comp1_transport_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sa">u</span><span class="s1">&#39;key1&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;value1&#39;</span><span class="p">,</span>
                <span class="sa">u</span><span class="s1">&#39;key2&#39;</span><span class="p">:</span> <span class="mi">2</span>
            <span class="p">}</span>

            <span class="c1"># Check that we got the correct metadata &amp; transport parameters</span>
            <span class="c1"># Make sure to exclude the default computer</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;transport_params&#39;</span><span class="p">,</span> <span class="s1">&#39;_metadata&#39;</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;comp&quot;</span><span class="p">,</span>
                      <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;!==&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="o">.</span><span class="n">name</span><span class="p">}})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Expected only one computer&quot;</span><span class="p">)</span>

            <span class="n">res</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">dict</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">][</span><span class="s1">&#39;transport_params&#39;</span><span class="p">],</span> <span class="n">comp1_transport_params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">][</span><span class="s1">&#39;_metadata&#39;</span><span class="p">],</span> <span class="n">comp1_metadata</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestLinks"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestLinks">[docs]</a><span class="k">class</span> <span class="nc">TestLinks</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test ex-/import cases related to Links&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestLinks.setUp"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestLinks.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestLinks.tearDown"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestLinks.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestLinks.get_all_node_links"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestLinks.get_all_node_links">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_node_links</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get all Node links currently in the DB &quot;&quot;&quot;</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;input&#39;</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">edge_project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">with_incoming</span><span class="o">=</span><span class="s1">&#39;input&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_links_to_unknown_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test importing of nodes, that have links to unknown nodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">tarfile</span>

        <span class="kn">from</span> <span class="nn">aiida.common.folders</span> <span class="k">import</span> <span class="n">SandboxFolder</span>
        <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">json</span>

        <span class="n">node_label</span> <span class="o">=</span> <span class="s2">&quot;Test structure data&quot;</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">()</span>
        <span class="n">sd</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">node_label</span><span class="p">)</span>
        <span class="n">sd</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">sd_uuid</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="n">uuid</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">sd</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">unpack</span> <span class="o">=</span> <span class="n">SandboxFolder</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r:gz&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">tarfile</span><span class="o">.</span><span class="n">PAX_FORMAT</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
            <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">unpack</span><span class="o">.</span><span class="n">abspath</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">unpack</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="s1">&#39;data.json&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fhandle</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;links_uuid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="n">sd</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
            <span class="c1"># note: this uuid is supposed to not be in the DB</span>
            <span class="s1">&#39;input&#39;</span><span class="p">:</span> <span class="n">get_new_uuid</span><span class="p">(),</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;parent&#39;</span>
        <span class="p">})</span>

        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">unpack</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="s1">&#39;data.json&#39;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">fhandle</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w:gz&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">tarfile</span><span class="o">.</span><span class="n">PAX_FORMAT</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
            <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">unpack</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">import_data</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">import_data</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ignore_unknown_nodes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">sd_uuid</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">node_label</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_input_and_create_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simple test that will verify that INPUT and CREATE links are properly exported and</span>
<span class="sd">        correctly recreated upon import.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>

        <span class="n">node_work</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">node_input</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">node_output</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">node_work</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">node_input</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">)</span>
        <span class="n">node_work</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">node_output</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">node_work</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">)</span>

        <span class="n">export_links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_node_links</span><span class="p">()</span>
        <span class="n">export_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">node_output</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>

        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">import_links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_node_links</span><span class="p">()</span>

        <span class="n">export_set</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">export_links</span><span class="p">]</span>
        <span class="n">import_set</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">import_links</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">export_set</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="n">import_set</span><span class="p">))</span>

<div class="viewcode-block" id="TestLinks.construct_complex_graph"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestLinks.construct_complex_graph">[docs]</a>    <span class="k">def</span> <span class="nf">construct_complex_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">export_combination</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">work_nodes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">calc_nodes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method creates a &quot;complex&quot; graph with all available link types:</span>
<span class="sd">        INPUT_WORK, INPUT_CALC, CALL_WORK, CALL_CALC, CREATE, and RETURN</span>
<span class="sd">        and returns the nodes of the graph. It also returns various combinations</span>
<span class="sd">        of nodes that need to be extracted but also the final expected set of nodes</span>
<span class="sd">        (after adding the expected predecessors, desuccessors).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>

        <span class="k">if</span> <span class="n">export_combination</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">export_combination</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">work_nodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">work_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;WorkflowNode&quot;</span><span class="p">,</span> <span class="s2">&quot;WorkflowNode&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">calc_nodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">calc_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;orm.CalculationNode&quot;</span><span class="p">,</span> <span class="s2">&quot;orm.CalculationNode&quot;</span><span class="p">]</span>

        <span class="c1"># Class mapping</span>
        <span class="c1"># &quot;CalcJobNode&quot; is left out, since it is special.</span>
        <span class="n">string_to_class</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;WorkflowNode&quot;</span><span class="p">:</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">,</span>
            <span class="s2">&quot;WorkChainNode&quot;</span><span class="p">:</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkChainNode</span><span class="p">,</span>
            <span class="s2">&quot;WorkFunctionNode&quot;</span><span class="p">:</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkFunctionNode</span><span class="p">,</span>
            <span class="s2">&quot;orm.CalculationNode&quot;</span><span class="p">:</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span>
            <span class="s2">&quot;CalcFunctionNode&quot;</span><span class="p">:</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcFunctionNode</span>
        <span class="p">}</span>

        <span class="c1"># Node creation</span>
        <span class="n">data1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">data2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">work1</span> <span class="o">=</span> <span class="n">string_to_class</span><span class="p">[</span><span class="n">work_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]()</span>
        <span class="n">work2</span> <span class="o">=</span> <span class="n">string_to_class</span><span class="p">[</span><span class="n">work_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]]()</span>

        <span class="k">if</span> <span class="n">calc_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CalcJobNode&quot;</span><span class="p">:</span>
            <span class="n">calc1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">()</span>
            <span class="n">calc1</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;num_machines&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;num_mpiprocs_per_machine&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">calc1</span> <span class="o">=</span> <span class="n">string_to_class</span><span class="p">[</span><span class="n">calc_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]()</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>

        <span class="c1"># Waiting to store Data nodes until they have been &quot;created&quot; with the links below,</span>
        <span class="c1"># because @calcfunctions cannot return data, i.e. return stored Data nodes</span>
        <span class="n">data3</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data4</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">calc_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CalcJobNode&quot;</span><span class="p">:</span>
            <span class="n">calc2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">()</span>
            <span class="n">calc2</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;num_machines&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;num_mpiprocs_per_machine&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">calc2</span> <span class="o">=</span> <span class="n">string_to_class</span><span class="p">[</span><span class="n">calc_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]]()</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>

        <span class="c1"># Waiting to store Data nodes until they have been &quot;created&quot; with the links below,</span>
        <span class="c1"># because @calcfunctions cannot return data, i.e. return stored Data nodes</span>
        <span class="n">data5</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data6</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Link creation</span>
        <span class="n">work1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_WORK</span><span class="p">,</span> <span class="s1">&#39;input1&#39;</span><span class="p">)</span>
        <span class="n">work1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">data2</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_WORK</span><span class="p">,</span> <span class="s1">&#39;input2&#39;</span><span class="p">)</span>

        <span class="n">work2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_WORK</span><span class="p">,</span> <span class="s1">&#39;input1&#39;</span><span class="p">)</span>
        <span class="n">work2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">work1</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="p">,</span> <span class="s1">&#39;call2&#39;</span><span class="p">)</span>

        <span class="n">work1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">work2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">calc1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="s1">&#39;input1&#39;</span><span class="p">)</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">work2</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_CALC</span><span class="p">,</span> <span class="s1">&#39;call1&#39;</span><span class="p">)</span>
        <span class="n">calc1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">data3</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">calc1</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="s1">&#39;create3&#39;</span><span class="p">)</span>
        <span class="c1"># data3 is stored now, because a @workfunction cannot return unstored Data,</span>
        <span class="c1"># i.e. create data.</span>
        <span class="n">data3</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">data3</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">work2</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">,</span> <span class="s1">&#39;return3&#39;</span><span class="p">)</span>

        <span class="n">data4</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">calc1</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="s1">&#39;create4&#39;</span><span class="p">)</span>
        <span class="c1"># data3 is stored now, because a @workfunction cannot return unstored Data,</span>
        <span class="c1"># i.e. create data.</span>
        <span class="n">data4</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">data4</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">work2</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">,</span> <span class="s1">&#39;return4&#39;</span><span class="p">)</span>

        <span class="n">calc2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">data4</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="s1">&#39;input4&#39;</span><span class="p">)</span>
        <span class="n">calc2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">data5</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">calc2</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="s1">&#39;create5&#39;</span><span class="p">)</span>
        <span class="n">data6</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">calc2</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="s1">&#39;create6&#39;</span><span class="p">)</span>

        <span class="n">data5</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">data6</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">graph_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">data3</span><span class="p">,</span> <span class="n">data4</span><span class="p">,</span> <span class="n">data5</span><span class="p">,</span> <span class="n">data6</span><span class="p">,</span> <span class="n">calc1</span><span class="p">,</span> <span class="n">calc2</span><span class="p">,</span> <span class="n">work1</span><span class="p">,</span> <span class="n">work2</span><span class="p">]</span>

        <span class="c1"># Create various combinations of nodes that should be exported</span>
        <span class="c1"># and the final set of nodes that are exported in each case, following</span>
        <span class="c1"># predecessor(INPUT, CREATE)/successor(CALL, RETURN, CREATE) links.</span>
        <span class="n">export_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">work1</span><span class="p">,</span> <span class="p">[</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">data3</span><span class="p">,</span> <span class="n">data4</span><span class="p">,</span> <span class="n">calc1</span><span class="p">,</span> <span class="n">work1</span><span class="p">,</span> <span class="n">work2</span><span class="p">]),</span>
            <span class="p">(</span><span class="n">work2</span><span class="p">,</span> <span class="p">[</span><span class="n">data1</span><span class="p">,</span> <span class="n">data3</span><span class="p">,</span> <span class="n">data4</span><span class="p">,</span> <span class="n">calc1</span><span class="p">,</span> <span class="n">work2</span><span class="p">]),</span>
            <span class="p">(</span><span class="n">data3</span><span class="p">,</span> <span class="p">[</span><span class="n">data1</span><span class="p">,</span> <span class="n">data3</span><span class="p">,</span> <span class="n">data4</span><span class="p">,</span> <span class="n">calc1</span><span class="p">]),</span>
            <span class="p">(</span><span class="n">data4</span><span class="p">,</span> <span class="p">[</span><span class="n">data1</span><span class="p">,</span> <span class="n">data3</span><span class="p">,</span> <span class="n">data4</span><span class="p">,</span> <span class="n">calc1</span><span class="p">]),</span>
            <span class="p">(</span><span class="n">data5</span><span class="p">,</span> <span class="p">[</span><span class="n">data1</span><span class="p">,</span> <span class="n">data3</span><span class="p">,</span> <span class="n">data4</span><span class="p">,</span> <span class="n">data5</span><span class="p">,</span> <span class="n">data6</span><span class="p">,</span> <span class="n">calc1</span><span class="p">,</span> <span class="n">calc2</span><span class="p">]),</span>
            <span class="p">(</span><span class="n">data6</span><span class="p">,</span> <span class="p">[</span><span class="n">data1</span><span class="p">,</span> <span class="n">data3</span><span class="p">,</span> <span class="n">data4</span><span class="p">,</span> <span class="n">data5</span><span class="p">,</span> <span class="n">data6</span><span class="p">,</span> <span class="n">calc1</span><span class="p">,</span> <span class="n">calc2</span><span class="p">]),</span>
            <span class="p">(</span><span class="n">calc1</span><span class="p">,</span> <span class="p">[</span><span class="n">data1</span><span class="p">,</span> <span class="n">data3</span><span class="p">,</span> <span class="n">data4</span><span class="p">,</span> <span class="n">calc1</span><span class="p">]),</span>
            <span class="p">(</span><span class="n">calc2</span><span class="p">,</span> <span class="p">[</span><span class="n">data1</span><span class="p">,</span> <span class="n">data3</span><span class="p">,</span> <span class="n">data4</span><span class="p">,</span> <span class="n">data5</span><span class="p">,</span> <span class="n">data6</span><span class="p">,</span> <span class="n">calc1</span><span class="p">,</span> <span class="n">calc2</span><span class="p">]),</span>
            <span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="p">[</span><span class="n">data1</span><span class="p">]),</span>
            <span class="p">(</span><span class="n">data2</span><span class="p">,</span> <span class="p">[</span><span class="n">data2</span><span class="p">])</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">graph_nodes</span><span class="p">,</span> <span class="n">export_list</span><span class="p">[</span><span class="n">export_combination</span><span class="p">]</span></div>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_data_create_reversed_false</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify that create_reversed = False is respected when only exporting Data nodes.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>

        <span class="n">data_input</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">data_output</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">calc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">()</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;num_machines&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;num_mpiprocs_per_machine&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

        <span class="n">calc</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">data_input</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">)</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">data_output</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">)</span>
        <span class="n">data_output_uuid</span> <span class="o">=</span> <span class="n">data_output</span><span class="o">.</span><span class="n">uuid</span>

        <span class="n">group</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;test_group&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_nodes</span><span class="p">(</span><span class="n">data_output</span><span class="p">)</span>

        <span class="n">export_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">group</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">create_reversed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>

        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Expected a single Data node but got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">data_output_uuid</span><span class="p">)</span>

        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Expected no Calculation nodes&#39;</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_complex_workflow_graph_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This test checks that all the needed links are correctly exported and</span>
<span class="sd">        imported. More precisely, it checks that INPUT, CREATE, RETURN and CALL</span>
<span class="sd">        links connecting Data nodes, CalcJobNodes and WorkCalculations are</span>
<span class="sd">        exported and imported correctly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>

        <span class="n">graph_nodes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_complex_graph</span><span class="p">()</span>

        <span class="c1"># Getting the input, create, return and call links</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span>
                    <span class="n">edge_project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">],</span>
                    <span class="n">edge_filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                                <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_WORK</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                                <span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                                <span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                                <span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_CALC</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                                <span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="o">.</span><span class="n">value</span><span class="p">)}})</span>
        <span class="n">export_links</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="n">export_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">(</span><span class="n">graph_nodes</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>

        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">import_links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_node_links</span><span class="p">()</span>

        <span class="n">export_set</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">export_links</span><span class="p">]</span>
        <span class="n">import_set</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">import_links</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">export_set</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="n">import_set</span><span class="p">))</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_complex_workflow_graph_export_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test ex-/import of individual nodes in complex graph&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">export_conf</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">):</span>

            <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">export_node</span><span class="p">,</span> <span class="n">export_target</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_complex_graph</span><span class="p">(</span><span class="n">export_conf</span><span class="p">)</span>
            <span class="n">export_target_uuids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">export_target</span><span class="p">)</span>

            <span class="n">export_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export.tar.gz&#39;</span><span class="p">)</span>
            <span class="n">export</span><span class="p">([</span><span class="n">export_node</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">export_node_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">export_node</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>

            <span class="n">import_data</span><span class="p">(</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Get all the nodes of the database</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>
            <span class="n">imported_node_uuids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span>
                <span class="n">export_target_uuids</span><span class="p">,</span>
                <span class="n">imported_node_uuids</span><span class="p">,</span>
                <span class="s2">&quot;Problem in comparison of export node: &quot;</span> <span class="o">+</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">export_node_str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Expected set: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">export_target_uuids</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Imported set: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">imported_node_uuids</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Difference: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">([</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span>
                                        <span class="n">export_target_uuids</span><span class="o">.</span><span class="n">symmetric_difference</span><span class="p">(</span>
                                            <span class="n">imported_node_uuids</span><span class="p">)])</span>
            <span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_high_level_workflow_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This test checks that all the needed links are correctly exported and imported.</span>
<span class="sd">        INPUT_CALC, INPUT_WORK, CALL_CALC, CALL_WORK, CREATE, and RETURN</span>
<span class="sd">        links connecting Data nodes and high-level Calculation and Workflow nodes:</span>
<span class="sd">        CalcJobNode, CalcFunctionNode, WorkChainNode, WorkFunctionNode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>

        <span class="n">high_level_calc_nodes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;CalcJobNode&quot;</span><span class="p">,</span> <span class="s2">&quot;CalcJobNode&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;CalcJobNode&quot;</span><span class="p">,</span> <span class="s2">&quot;CalcFunctionNode&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;CalcFunctionNode&quot;</span><span class="p">,</span> <span class="s2">&quot;CalcJobNode&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;CalcFunctionNode&quot;</span><span class="p">,</span> <span class="s2">&quot;CalcFunctionNode&quot;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="n">high_level_work_nodes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;WorkChainNode&quot;</span><span class="p">,</span> <span class="s2">&quot;WorkChainNode&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;WorkChainNode&quot;</span><span class="p">,</span> <span class="s2">&quot;WorkFunctionNode&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;WorkFunctionNode&quot;</span><span class="p">,</span> <span class="s2">&quot;WorkChainNode&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;WorkFunctionNode&quot;</span><span class="p">,</span> <span class="s2">&quot;WorkFunctionNode&quot;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">calcs</span> <span class="ow">in</span> <span class="n">high_level_calc_nodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">works</span> <span class="ow">in</span> <span class="n">high_level_work_nodes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>

                <span class="n">graph_nodes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_complex_graph</span><span class="p">(</span><span class="n">calc_nodes</span><span class="o">=</span><span class="n">calcs</span><span class="p">,</span> <span class="n">work_nodes</span><span class="o">=</span><span class="n">works</span><span class="p">)</span>

                <span class="c1"># Getting the input, create, return and call links</span>
                <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
                <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>
                <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span>
                        <span class="n">edge_project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">],</span>
                        <span class="n">edge_filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                                        <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_WORK</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                                        <span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                                        <span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                                        <span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_CALC</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                                        <span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="o">.</span><span class="n">value</span><span class="p">)}})</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">13</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span>
                <span class="s2">&quot;Failed with c1=</span><span class="si">{}</span><span class="s2">, c2=</span><span class="si">{}</span><span class="s2">, w1=</span><span class="si">{}</span><span class="s2">, w2=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">calcs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">calcs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">works</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">works</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

                <span class="n">export_links</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

                <span class="n">export_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export.tar.gz&#39;</span><span class="p">)</span>
                <span class="n">export</span><span class="p">(</span><span class="n">graph_nodes</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>

                <span class="n">import_data</span><span class="p">(</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">import_links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_node_links</span><span class="p">()</span>

                <span class="n">export_set</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">export_links</span><span class="p">]</span>
                <span class="n">import_set</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">import_links</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">export_set</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="n">import_set</span><span class="p">),</span> <span class="n">msg</span><span class="o">=</span>
                <span class="s2">&quot;Failed with c1=</span><span class="si">{}</span><span class="s2">, c2=</span><span class="si">{}</span><span class="s2">, w1=</span><span class="si">{}</span><span class="s2">, w2=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">calcs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">calcs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">works</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">works</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_links_for_workflows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check export flag `return_reversed=True`.</span>
<span class="sd">        Check that CALL links are not followed in the export procedure,</span>
<span class="sd">        and the only creation is followed for data::</span>

<span class="sd">            ____       ____        ____</span>
<span class="sd">           |    | INP |    | CALL |    |</span>
<span class="sd">           | i1 | --&gt; | w1 | &lt;--- | w2 |</span>
<span class="sd">           |____|     |____|      |____|</span>
<span class="sd">                        |</span>
<span class="sd">                        v RETURN</span>
<span class="sd">                       ____</span>
<span class="sd">                      |    |</span>
<span class="sd">                      | o1 |</span>
<span class="sd">                      |____|</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>

        <span class="n">w1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span>
        <span class="n">w2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">o1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">w1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_WORK</span><span class="p">,</span> <span class="s1">&#39;input_i1&#39;</span><span class="p">)</span>
        <span class="n">w1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">w2</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>
        <span class="n">w1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">o1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">,</span> <span class="s1">&#39;returned&#39;</span><span class="p">)</span>

        <span class="n">links_count_wanted</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># All 3 links, except CALL links (the CALL_WORK)</span>
        <span class="n">links_wanted</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_node_links</span><span class="p">()</span> <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span>
                        <span class="p">(</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                        <span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_CALC</span><span class="o">.</span><span class="n">value</span><span class="p">)]</span>
        <span class="c1"># Check all links except CALL links are retrieved</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">links_count_wanted</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">links_wanted</span><span class="p">))</span>

        <span class="n">export_file_1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export-1.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export_file_2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export-2.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">o1</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file_1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_reversed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">w1</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file_2</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_reversed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>

        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file_1</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">import_links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_node_links</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertListEqual</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">links_wanted</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">import_links</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">links_count_wanted</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">import_links</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>

        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file_2</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">import_links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_node_links</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertListEqual</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">links_wanted</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">import_links</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">links_count_wanted</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">import_links</span><span class="p">))</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_double_return_links_for_workflows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This test checks that double return links to a node can be exported</span>
<span class="sd">        and imported without problems,</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>

        <span class="n">w1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span>
        <span class="n">w2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkflowNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">o1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">w1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_WORK</span><span class="p">,</span> <span class="s1">&#39;input_i1&#39;</span><span class="p">)</span>
        <span class="n">w1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">w2</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">CALL_WORK</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>
        <span class="n">w1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">o1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">,</span> <span class="s1">&#39;return1&#39;</span><span class="p">)</span>
        <span class="n">o1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">w2</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">RETURN</span><span class="p">,</span> <span class="s1">&#39;return2&#39;</span><span class="p">)</span>
        <span class="n">links_count</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="n">uuids_wanted</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">o1</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">w2</span><span class="p">))</span>
        <span class="n">links_wanted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_node_links</span><span class="p">()</span>

        <span class="n">export_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">o1</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">i1</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>

        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">uuids_in_db</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span> <span class="k">for</span> <span class="p">[</span><span class="n">uuid</span><span class="p">]</span> <span class="ow">in</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertListEqual</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">uuids_wanted</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">uuids_in_db</span><span class="p">))</span>

        <span class="n">links_in_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_node_links</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertListEqual</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">links_wanted</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">links_in_db</span><span class="p">))</span>

        <span class="c1"># Assert number of links, checking both RETURN links are included</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">links_wanted</span><span class="p">),</span> <span class="n">links_count</span><span class="p">)</span>  <span class="c1"># Before export</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">links_in_db</span><span class="p">),</span> <span class="n">links_count</span><span class="p">)</span>   <span class="c1"># After import</span></div>


<div class="viewcode-block" id="TestCode"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestCode">[docs]</a><span class="k">class</span> <span class="nc">TestCode</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test ex-/import cases related to Codes&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestCode.setUp"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestCode.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestCode.tearDown"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestCode.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestCode.get_all_node_links"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestCode.get_all_node_links">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_node_links</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get all Node links currently in the DB &quot;&quot;&quot;</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;input&#39;</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">edge_project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">with_incoming</span><span class="o">=</span><span class="s1">&#39;input&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_that_solo_code_is_exported_correctly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This test checks that when a calculation is exported then the</span>
<span class="sd">        corresponding code is also exported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">code_label</span> <span class="o">=</span> <span class="s1">&#39;test_code1&#39;</span>

        <span class="n">code</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="p">()</span>
        <span class="n">code</span><span class="o">.</span><span class="n">set_remote_computer_exec</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">,</span> <span class="s1">&#39;/bin/true&#39;</span><span class="p">))</span>
        <span class="n">code</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">code_label</span>
        <span class="n">code</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">code_uuid</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">uuid</span>

        <span class="n">export_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">code</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>

        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">code_uuid</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">code_label</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_input_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This test checks that when a calculation is exported then the</span>
<span class="sd">        corresponding code is also exported. It also checks that the links</span>
<span class="sd">        are also in place after the import.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>

        <span class="n">code_label</span> <span class="o">=</span> <span class="s1">&#39;test_code1&#39;</span>

        <span class="n">code</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="p">()</span>
        <span class="n">code</span><span class="o">.</span><span class="n">set_remote_computer_exec</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">,</span> <span class="s1">&#39;/bin/true&#39;</span><span class="p">))</span>
        <span class="n">code</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">code_label</span>
        <span class="n">code</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">code_uuid</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">uuid</span>

        <span class="n">jc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">()</span>
        <span class="n">jc</span><span class="o">.</span><span class="n">computer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computer</span>
        <span class="n">jc</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span>
                     <span class="p">{</span><span class="s2">&quot;num_machines&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;num_mpiprocs_per_machine&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

        <span class="n">jc</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">)</span>
        <span class="n">jc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">links_count</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">export_links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_node_links</span><span class="p">()</span>

        <span class="n">export_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">jc</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>

        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check that the code node is there</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">code_uuid</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">code_label</span><span class="p">)</span>

        <span class="c1"># Check that the link is in place</span>
        <span class="n">import_links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_node_links</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertListEqual</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">export_links</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">import_links</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">export_links</span><span class="p">),</span> <span class="n">links_count</span><span class="p">,</span>
                         <span class="s2">&quot;Expected to find only one link from code to &quot;</span>
                         <span class="s2">&quot;the calculation node before export. </span><span class="si">{}</span><span class="s2"> found.&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">export_links</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">import_links</span><span class="p">),</span> <span class="n">links_count</span><span class="p">,</span>
                         <span class="s2">&quot;Expected to find only one link from code to &quot;</span>
                         <span class="s2">&quot;the calculation node after import. </span><span class="si">{}</span><span class="s2"> found.&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">import_links</span><span class="p">)))</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_solo_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This test checks that when a calculation is exported then the</span>
<span class="sd">        corresponding code is also exported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">code_label</span> <span class="o">=</span> <span class="s1">&#39;test_code1&#39;</span>

        <span class="n">code</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="p">()</span>
        <span class="n">code</span><span class="o">.</span><span class="n">set_remote_computer_exec</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">,</span> <span class="s1">&#39;/bin/true&#39;</span><span class="p">))</span>
        <span class="n">code</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">code_label</span>
        <span class="n">code</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">code_uuid</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">uuid</span>

        <span class="n">export_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">code</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_data</span><span class="p">()</span>

        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">code_uuid</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">code_label</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestLogs"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestLogs">[docs]</a><span class="k">class</span> <span class="nc">TestLogs</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test ex-/import cases related to Logs&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestLogs.setUp"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestLogs.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset database prior to all tests&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestLogs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestLogs.tearDown"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestLogs.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete all the created log entries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestLogs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>
        <span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({})</span></div>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_export_import_of_critical_log_msg_and_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Testing logging of critical message &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Testing logging of critical failure&#39;</span>
        <span class="n">calc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>

        <span class="c1"># Firing a log for an unstored node should not end up in the database</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="c1"># There should be no log messages for the unstored object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># After storing the node, logs above log level should be stored</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="c1"># Store Log metadata</span>
        <span class="n">log_metadata</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dbnode_id</span><span class="o">=</span><span class="n">calc</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">metadata</span>

        <span class="n">export_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>

        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Finding all the log messages</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">logs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">logs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">log_metadata</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_exclude_logs_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test that the `include_logs` argument for `export` works.&quot;&quot;&quot;</span>
        <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Testing logging of critical failure&#39;</span>

        <span class="c1"># Create node</span>
        <span class="n">calc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Create log message</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>

        <span class="c1"># Save uuids prior to export</span>
        <span class="n">calc_uuid</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">uuid</span>

        <span class="c1"># Export, excluding logs</span>
        <span class="n">export_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_logs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Clean database and reimport exported data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Finding all the log messages</span>
        <span class="n">import_calcs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">import_logs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># There should be exactly: 1 orm.CalculationNode, 0 Logs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">import_calcs</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">import_logs</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Check it&#39;s the correct node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_calcs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">calc_uuid</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_export_of_imported_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test export of imported Log&quot;&quot;&quot;</span>
        <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Testing export of imported log&#39;</span>

        <span class="c1"># Create node</span>
        <span class="n">calc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Create log message</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>

        <span class="c1"># Save uuids prior to export</span>
        <span class="n">calc_uuid</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">uuid</span>
        <span class="n">log_uuid</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">log_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">log_uuid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Export</span>
        <span class="n">export_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Clean database and reimport exported data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Finding all the log messages</span>
        <span class="n">import_calcs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">import_logs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># There should be exactly: 1 CalculationNode, 1 Log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">import_calcs</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">import_logs</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Check the UUIDs are the same</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_calcs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">calc_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_logs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">log_uuid</span><span class="p">)</span>

        <span class="c1"># Re-export</span>
        <span class="n">calc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">import_calcs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">re_export_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;re_export.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">re_export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Clean database and reimport exported data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">re_export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Finding all the log messages</span>
        <span class="n">import_calcs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">import_logs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># There should be exactly: 1 CalculationNode, 1 Log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">import_calcs</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">import_logs</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Check the UUIDs are the same</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_calcs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">calc_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_logs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">log_uuid</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_multiple_imports_for_single_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test multiple imports for single node with different logs are imported correctly&quot;&quot;&quot;</span>
        <span class="n">log_msgs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Life is like riding a bicycle.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;To keep your balance,&quot;</span><span class="p">,</span>
            <span class="s2">&quot;you must keep moving.&quot;</span>
        <span class="p">]</span>

        <span class="c1"># Create Node and initial log message and save UUIDs prior to export</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">log_msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">node_uuid</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span>
        <span class="n">log_uuid_existing</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">log_uuid_existing</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">log_uuid_existing</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Export as &quot;EXISTING&quot; DB</span>
        <span class="n">export_file_existing</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export_EXISTING.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">node</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file_existing</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Add 2 more Logs and save UUIDs for all three Logs prior to export</span>
        <span class="n">node</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">log_msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">node</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">log_msgs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">log_uuids_full</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">log_uuids_full</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">log_uuids_full</span><span class="p">]</span>

        <span class="c1"># Export as &quot;FULL&quot; DB</span>
        <span class="n">export_file_full</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export_FULL.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">node</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file_full</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Clean database and reimport &quot;EXISTING&quot; DB</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file_existing</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check correct import</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="p">,</span> <span class="n">with_node</span><span class="o">=</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">])</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">builder</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># There is 1 Log in &quot;EXISTING&quot; DB</span>

        <span class="n">imported_node_uuid</span> <span class="o">=</span> <span class="n">builder</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_node_uuid</span><span class="p">,</span> <span class="n">node_uuid</span><span class="p">)</span>

        <span class="n">imported_log_uuid</span> <span class="o">=</span> <span class="n">builder</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">imported_log_message</span> <span class="o">=</span> <span class="n">builder</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_log_uuid</span><span class="p">,</span> <span class="n">log_uuid_existing</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_log_message</span><span class="p">,</span> <span class="n">log_msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Import &quot;FULL&quot; DB</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file_full</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Since the UUID of the node is identical with the node already in the DB,</span>
        <span class="c1"># the Logs should be added to the existing node, avoiding the addition of</span>
        <span class="c1"># the single Log already present.</span>
        <span class="c1"># Check this by retrieving all Logs for the node.</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="p">,</span> <span class="n">with_node</span><span class="o">=</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">])</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">builder</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_msgs</span><span class="p">))</span> <span class="c1"># There should now be 3 Logs</span>

        <span class="n">imported_node_uuid</span> <span class="o">=</span> <span class="n">builder</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_node_uuid</span><span class="p">,</span> <span class="n">node_uuid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">builder</span><span class="p">:</span>
            <span class="n">imported_log_uuid</span> <span class="o">=</span> <span class="n">log</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">imported_log_content</span> <span class="o">=</span> <span class="n">log</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">imported_log_uuid</span><span class="p">,</span> <span class="n">log_uuids_full</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">imported_log_content</span><span class="p">,</span> <span class="n">log_msgs</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_reimport_of_logs_for_single_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When a node with logs already exist in the DB, and more logs are imported</span>
<span class="sd">        for the same node (same UUID), test that only new log-entries are added.</span>

<span class="sd">        Part I:</span>
<span class="sd">        Create CalculationNode and 1 Log for it.</span>
<span class="sd">        Export CalculationNode with its 1 Log to export file #1 &quot;EXISTING database&quot;.</span>
<span class="sd">        Add 2 Logs to CalculationNode.</span>
<span class="sd">        Export CalculationNode with its 3 Logs to export file #2 &quot;FULL database&quot;.</span>
<span class="sd">        Reset database.</span>

<span class="sd">        Part II:</span>
<span class="sd">        Reimport export file #1 &quot;EXISTING database&quot;.</span>
<span class="sd">        Add 2 Logs to CalculationNode (different UUID than for &quot;FULL database&quot;).</span>
<span class="sd">        Export CalculationNode with its 3 Logs to export file #3 &quot;NEW database&quot;.</span>
<span class="sd">        Reset database.</span>

<span class="sd">        Part III:</span>
<span class="sd">        Reimport export file #1 &quot;EXISTING database&quot; (1 CalculationNode, 1 Log).</span>
<span class="sd">        Import export file #2 &quot;FULL database&quot; (1 CalculationNode, 3 Logs).</span>
<span class="sd">        Check the database EXACTLY contains 1 CalculationNode and 3 Logs,</span>
<span class="sd">        with matching UUIDS all the way through all previous Parts.</span>

<span class="sd">        Part IV:</span>
<span class="sd">        Import export file #3 &quot;NEW database&quot; (1 CalculationNode, 3 Logs).</span>
<span class="sd">        Check the database EXACTLY contains 1 CalculationNode and 5 Logs,</span>
<span class="sd">        with matching UUIDS all the way through all previous Parts.</span>
<span class="sd">        NB! There should now be 5 Logs in the database. 4 of which are identical</span>
<span class="sd">        in pairs, except for their UUID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">export_filenames</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;EXISTING&quot;</span><span class="p">:</span> <span class="s2">&quot;export_EXISTING_db.tar.gz&quot;</span><span class="p">,</span>
            <span class="s2">&quot;FULL&quot;</span><span class="p">:</span> <span class="s2">&quot;export_FULL_db.tar.gz&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NEW&quot;</span><span class="p">:</span> <span class="s2">&quot;export_NEW_db.tar.gz&quot;</span>
        <span class="p">}</span>

        <span class="n">log_msgs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Life is like riding a bicycle.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;To keep your balance,&quot;</span><span class="p">,</span>
            <span class="s2">&quot;you must keep moving.&quot;</span>
        <span class="p">]</span>

        <span class="c1">## Part I</span>
        <span class="c1"># Create node and save UUID</span>
        <span class="n">calc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">calc_uuid</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">uuid</span>

        <span class="c1"># Create first log message</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">log_msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># There should be exactly: 1 CalculationNode, 1 Log</span>
        <span class="n">export_calcs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">export_logs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">export_calcs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">export_logs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Save Log UUID before export</span>
        <span class="n">existing_log_uuids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">export_logs</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span>

        <span class="c1"># Export &quot;EXISTING&quot; DB</span>
        <span class="n">export_file_existing</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">export_filenames</span><span class="p">[</span><span class="s2">&quot;EXISTING&quot;</span><span class="p">])</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file_existing</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Add remaining Log messages</span>
        <span class="k">for</span> <span class="n">log_msg</span> <span class="ow">in</span> <span class="n">log_msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">calc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>

        <span class="c1"># There should be exactly: 1 CalculationNode, 3 Logs (len(log_msgs))</span>
        <span class="n">export_calcs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">export_logs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">export_calcs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">export_logs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_msgs</span><span class="p">))</span>

        <span class="c1"># Save Log UUIDs before export, there should be 3 UUIDs in total (len(log_msgs))</span>
        <span class="n">full_log_uuids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">existing_log_uuids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">log_uuid</span> <span class="ow">in</span> <span class="n">export_logs</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">full_log_uuids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">log_uuid</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">full_log_uuids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_msgs</span><span class="p">))</span>

        <span class="c1"># Export &quot;FULL&quot; DB</span>
        <span class="n">export_file_full</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">export_filenames</span><span class="p">[</span><span class="s2">&quot;FULL&quot;</span><span class="p">])</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file_full</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Clean database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>

        <span class="c1">## Part II</span>
        <span class="c1"># Reimport &quot;EXISTING&quot; DB</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file_existing</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check the database is correctly imported.</span>
        <span class="c1"># There should be exactly: 1 CalculationNode, 1 Log</span>
        <span class="n">import_calcs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">import_logs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_logs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Furthermore, the UUIDs should be the same</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">calc_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_logs</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">existing_log_uuids</span><span class="p">)</span>

        <span class="c1"># Add remaining Log messages (again)</span>
        <span class="n">calc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">log_msg</span> <span class="ow">in</span> <span class="n">log_msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">calc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>

        <span class="c1"># There should be exactly: 1 CalculationNode, 3 Logs (len(log_msgs))</span>
        <span class="n">export_calcs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">export_logs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">export_calcs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">export_logs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_msgs</span><span class="p">))</span>

        <span class="c1"># Save Log UUIDs before export, there should be 3 UUIDs in total (len(log_msgs))</span>
        <span class="n">new_log_uuids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">existing_log_uuids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">log_uuid</span> <span class="ow">in</span> <span class="n">export_logs</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">new_log_uuids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">log_uuid</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_log_uuids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_msgs</span><span class="p">))</span>

        <span class="c1"># Export &quot;NEW&quot; DB</span>
        <span class="n">export_file_new</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">export_filenames</span><span class="p">[</span><span class="s2">&quot;NEW&quot;</span><span class="p">])</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file_new</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Clean database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>

        <span class="c1">## Part III</span>
        <span class="c1"># Reimport &quot;EXISTING&quot; DB</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file_existing</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check the database is correctly imported.</span>
        <span class="c1"># There should be exactly: 1 CalculationNode, 1 Log</span>
        <span class="n">import_calcs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">import_logs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_logs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Furthermore, the UUIDs should be the same</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">calc_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_logs</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">existing_log_uuids</span><span class="p">)</span>

        <span class="c1"># Import &quot;FULL&quot; DB</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file_full</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check the database is correctly imported.</span>
        <span class="c1"># There should be exactly: 1 CalculationNode, 3 Logs (len(log_msgs))</span>
        <span class="n">import_calcs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">import_logs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_logs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_msgs</span><span class="p">))</span>
        <span class="c1"># Furthermore, the UUIDs should be the same</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">calc_uuid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">import_logs</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">log_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">log_uuid</span><span class="p">,</span> <span class="n">full_log_uuids</span><span class="p">)</span>

        <span class="c1">## Part IV</span>
        <span class="c1"># Import &quot;NEW&quot; DB</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file_new</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check the database is correctly imported.</span>
        <span class="c1"># There should be exactly: 1 CalculationNode, 5 Logs (len(log_msgs))</span>
        <span class="c1"># 4 of the logs are identical in pairs, except for the UUID.</span>
        <span class="n">import_calcs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">import_logs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Log</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_logs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">5</span><span class="p">)</span>
        <span class="c1"># Furthermore, the UUIDs should be the same</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">calc_uuid</span><span class="p">)</span>
        <span class="n">total_log_uuids</span> <span class="o">=</span> <span class="n">full_log_uuids</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">total_log_uuids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_log_uuids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">import_logs</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">log_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">log_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">log_uuid</span><span class="p">,</span> <span class="n">total_log_uuids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">log_message</span><span class="p">,</span> <span class="n">log_msgs</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestComments"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestComments">[docs]</a><span class="k">class</span> <span class="nc">TestComments</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test ex-/import cases related to Comments&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestComments.setUp"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestComments.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestComments</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;We&#39;re no strangers to love&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You know the rules and so do I&quot;</span><span class="p">,</span>
            <span class="s2">&quot;A full commitment&#39;s what I&#39;m thinking of&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You wouldn&#39;t get this from any other guy&quot;</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="TestComments.tearDown"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestComments.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestComments</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span></div>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_multiple_imports_for_single_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test multiple imports for single node with different comments are imported correctly&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_default</span><span class="p">()</span>

        <span class="c1"># Create Node and initial comments and save UUIDs prior to export</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">comment_one</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">comment_two</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">node_uuid</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span>
        <span class="n">comment_uuids</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="n">comment_one</span><span class="p">,</span> <span class="n">comment_two</span><span class="p">]]</span>

        <span class="c1"># Export as &quot;EXISTING&quot; DB</span>
        <span class="n">export_file_existing</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export_EXISTING.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">node</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file_existing</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Add 2 more Comments and save UUIDs prior to export</span>
        <span class="n">comment_three</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">comment_four</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">comment_uuids</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="n">comment_three</span><span class="p">,</span> <span class="n">comment_four</span><span class="p">]]</span>

        <span class="c1"># Export as &quot;FULL&quot; DB</span>
        <span class="n">export_file_full</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export_FULL.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">node</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file_full</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Clean database and reimport &quot;EXISTING&quot; DB</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file_existing</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check correct import</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">,</span> <span class="n">with_node</span><span class="o">=</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">])</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">builder</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># There are 2 Comments in &quot;EXISTING&quot; DB</span>

        <span class="n">imported_node_uuid</span> <span class="o">=</span> <span class="n">builder</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_node_uuid</span><span class="p">,</span> <span class="n">node_uuid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">builder</span><span class="p">:</span>
            <span class="n">imported_comment_uuid</span> <span class="o">=</span> <span class="n">comment</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">imported_comment_content</span> <span class="o">=</span> <span class="n">comment</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">imported_comment_uuid</span><span class="p">,</span> <span class="n">comment_uuids</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">imported_comment_content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Import &quot;FULL&quot; DB</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file_full</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Since the UUID of the node is identical with the node already in the DB,</span>
        <span class="c1"># the Comments should be added to the existing node, avoiding the addition</span>
        <span class="c1"># of the two Comments already present.</span>
        <span class="c1"># Check this by retrieving all Comments for the node.</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">,</span> <span class="n">with_node</span><span class="o">=</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">])</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">builder</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">))</span> <span class="c1"># There should now be 4 Comments</span>

        <span class="n">imported_node_uuid</span> <span class="o">=</span> <span class="n">builder</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_node_uuid</span><span class="p">,</span> <span class="n">node_uuid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">builder</span><span class="p">:</span>
            <span class="n">imported_comment_uuid</span> <span class="o">=</span> <span class="n">comment</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">imported_comment_content</span> <span class="o">=</span> <span class="n">comment</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">imported_comment_uuid</span><span class="p">,</span> <span class="n">comment_uuids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">imported_comment_content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_exclude_comments_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test comments and associated commenting users are not exported when using `include_comments=False`.&quot;&quot;&quot;</span>
        <span class="c1"># Create users, node, and comments</span>
        <span class="n">user_one</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_default</span><span class="p">()</span>
        <span class="n">user_two</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s2">&quot;commenting@user.s&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">node</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">comment_one</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">user_one</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">comment_two</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">user_one</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">comment_three</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">user_two</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">comment_four</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">user_two</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Get values prior to export</span>
        <span class="n">users_email</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">email</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="p">[</span><span class="n">user_one</span><span class="p">,</span> <span class="n">user_two</span><span class="p">]]</span>
        <span class="n">node_uuid</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span>

        <span class="c1"># Check that node belongs to user_one</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">users_email</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Export nodes, excluding comments</span>
        <span class="n">export_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">node</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_comments</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Clean database and reimport exported file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Get node, users, and comments</span>
        <span class="n">import_nodes</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">import_comments</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">import_users</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># There should be exactly: 1 Node, 0 Comments, 1 User</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">import_nodes</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">import_comments</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">import_users</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Check it&#39;s the correct user (and node)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">node_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_users</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">users_email</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_calc_and_data_nodes_with_comments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Test comments for CalculatioNode and Data node are correctly ex-/imported &quot;&quot;&quot;</span>
        <span class="c1"># Create user, nodes, and comments</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_default</span><span class="p">()</span>

        <span class="n">calc_node</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">data_node</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">comment_one</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">calc_node</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">comment_two</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">calc_node</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">comment_three</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">data_node</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">comment_four</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">data_node</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Get values prior to export</span>
        <span class="n">calc_uuid</span> <span class="o">=</span> <span class="n">calc_node</span><span class="o">.</span><span class="n">uuid</span>
        <span class="n">data_uuid</span> <span class="o">=</span> <span class="n">data_node</span><span class="o">.</span><span class="n">uuid</span>
        <span class="n">calc_comments_uuid</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="n">comment_one</span><span class="p">,</span> <span class="n">comment_two</span><span class="p">]]</span>
        <span class="n">data_comments_uuid</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="n">comment_three</span><span class="p">,</span> <span class="n">comment_four</span><span class="p">]]</span>

        <span class="c1"># Export nodes</span>
        <span class="n">export_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc_node</span><span class="p">,</span> <span class="n">data_node</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Clean database and reimport exported file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Get nodes and comments</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">,</span> <span class="n">with_node</span><span class="o">=</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">nodes_and_comments</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes_and_comments</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">nodes_and_comments</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 1 Node + 1 Comment</span>

            <span class="n">import_node_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">import_comment_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">import_node_uuid</span><span class="p">,</span> <span class="p">[</span><span class="n">calc_uuid</span><span class="p">,</span> <span class="n">data_uuid</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">import_node_uuid</span> <span class="o">==</span> <span class="n">calc_uuid</span><span class="p">:</span>
                <span class="c1"># Calc node comments</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">import_comment_uuid</span><span class="p">,</span> <span class="n">calc_comments_uuid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Data node comments</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">import_comment_uuid</span><span class="p">,</span> <span class="n">data_comments_uuid</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_multiple_user_comments_for_single_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Test multiple users commenting on a single orm.CalculationNode &quot;&quot;&quot;</span>
        <span class="c1"># Create users, node, and comments</span>
        <span class="n">user_one</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_default</span><span class="p">()</span>
        <span class="n">user_two</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s2">&quot;commenting@user.s&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">node</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">comment_one</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">user_one</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">comment_two</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">user_one</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">comment_three</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">user_two</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">comment_four</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">user_two</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Get values prior to export</span>
        <span class="n">users_email</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">email</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="p">[</span><span class="n">user_one</span><span class="p">,</span> <span class="n">user_two</span><span class="p">]]</span>
        <span class="n">node_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="n">user_one_comments_uuid</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="n">comment_one</span><span class="p">,</span> <span class="n">comment_two</span><span class="p">]]</span>
        <span class="n">user_two_comments_uuid</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="n">comment_three</span><span class="p">,</span> <span class="n">comment_four</span><span class="p">]]</span>

        <span class="c1"># Export node, along with comments and users recursively</span>
        <span class="n">export_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">node</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Clean database and reimport exported file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Get node, users, and comments</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="n">with_node</span><span class="o">=</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="n">with_comment</span><span class="o">=</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># Check that all 4 comments are retrieved, along with their respective node and user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">))</span>

        <span class="c1"># Go through [Node.uuid, Comment.uuid, User.email]-entries</span>
        <span class="n">imported_node_uuids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">imported_user_one_comment_uuids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">imported_user_two_comment_uuids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">imported_user_emails</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># 1 Node + 1 Comment + 1 User</span>

            <span class="c1"># Add node to set of imported nodes</span>
            <span class="n">imported_node_uuids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

            <span class="c1"># Add user to set of imported users</span>
            <span class="n">import_user_email</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">imported_user_emails</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_user_email</span><span class="p">))</span>

            <span class="c1"># Add comment to set of imported comments pertaining to correct user</span>
            <span class="k">if</span> <span class="n">import_user_email</span> <span class="o">==</span> <span class="n">users_email</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="c1"># User_one comments</span>
                <span class="n">imported_user_one_comment_uuids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># User_two comments</span>
                <span class="n">imported_user_two_comment_uuids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># Check same number of nodes (1) and users (2) were ex- and imported</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imported_node_uuids</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imported_user_emails</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">users_email</span><span class="p">))</span>

        <span class="c1"># Check imported node equals exported node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span><span class="n">imported_node_uuids</span><span class="p">,</span> <span class="p">{</span><span class="n">node_uuid</span><span class="p">})</span>

        <span class="c1"># Check imported user is part of exported users</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span><span class="n">imported_user_emails</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">users_email</span><span class="p">))</span>

        <span class="c1"># Check same number of comments (2) pertaining to each user were ex- and imported</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imported_user_one_comment_uuids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_one_comments_uuid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imported_user_two_comment_uuids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_two_comments_uuid</span><span class="p">))</span>

        <span class="c1"># Check imported comments equal exported comments pertaining to specific user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span><span class="n">imported_user_one_comment_uuids</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">user_one_comments_uuid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertSetEqual</span><span class="p">(</span><span class="n">imported_user_two_comment_uuids</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">user_two_comments_uuid</span><span class="p">))</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_mtime_of_imported_comments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test mtime does not change for imported comments</span>
<span class="sd">        This is related to correct usage of `comment_mode` when importing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get user</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_default</span><span class="p">()</span>

        <span class="n">comment_content</span> <span class="o">=</span> <span class="s2">&quot;You get what you give&quot;</span>

        <span class="c1"># Create node</span>
        <span class="n">calc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Create comment</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">comment_content</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Save UUIDs and mtime</span>
        <span class="n">calc_uuid</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">uuid</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;mtime&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">comment_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">builder</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">comment_mtime</span> <span class="o">=</span> <span class="n">builder</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;mtime&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">calc_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">builder</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">calc_mtime</span> <span class="o">=</span> <span class="n">builder</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Export, reset database and reimport</span>
        <span class="n">export_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;export.tar.gz&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Retrieve node and comment</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;calc&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;mtime&#39;</span><span class="p">])</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">,</span> <span class="n">with_node</span><span class="o">=</span><span class="s1">&#39;calc&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;mtime&#39;</span><span class="p">])</span>

        <span class="n">import_entities</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">import_entities</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span> <span class="c1"># Check we have the correct amount of returned values</span>

        <span class="n">import_calc_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">import_entities</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">import_calc_mtime</span> <span class="o">=</span> <span class="n">import_entities</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">import_comment_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">import_entities</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">import_comment_mtime</span> <span class="o">=</span> <span class="n">import_entities</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="c1"># Check we have the correct UUIDs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_calc_uuid</span><span class="p">,</span> <span class="n">calc_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_comment_uuid</span><span class="p">,</span> <span class="n">comment_uuid</span><span class="p">)</span>

        <span class="c1"># Make sure the mtime is the same after import as it was before export</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_comment_mtime</span><span class="p">,</span> <span class="n">comment_mtime</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_calc_mtime</span><span class="p">,</span> <span class="n">calc_mtime</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_import_arg_comment_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test the import keyword `comment_mode`.</span>
<span class="sd">        It may be `&#39;newest&#39;` or `&#39;overwrite&#39;`.</span>
<span class="sd">        Test import of &#39;old&#39; comment that has since been changed in DB.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get user</span>
        <span class="c1"># Will have to do this again after resetting the DB</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_default</span><span class="p">()</span>

        <span class="c1">## Test comment_mode=&#39;newest&#39;</span>
        <span class="c1"># Create node</span>
        <span class="n">calc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">calc_uuid</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">uuid</span>

        <span class="c1"># Creates comment</span>
        <span class="n">cmt</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">cmt_uuid</span> <span class="o">=</span> <span class="n">cmt</span><span class="o">.</span><span class="n">uuid</span>

        <span class="c1"># Export calc and comment</span>
        <span class="n">export_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export_file.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Update comment</span>
        <span class="n">cmt</span><span class="o">.</span><span class="n">set_content</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Check that Comment has been updated, and that there is only 1</span>
        <span class="n">export_comments</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">export_comments</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">export_comments</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmt_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">export_comments</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Export calc and UPDATED comment</span>
        <span class="n">export_file_updated</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export_file_updated.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file_updated</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Reimport exported &#39;old&#39; calc and comment</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">comment_mode</span><span class="o">=</span><span class="s1">&#39;newest&#39;</span><span class="p">)</span>

        <span class="c1"># Check there are exactly 1 CalculationNode and 1 Comment</span>
        <span class="n">import_calcs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;calc&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">import_comments</span> <span class="o">=</span> <span class="n">import_calcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">,</span> <span class="n">with_node</span><span class="o">=</span><span class="s1">&#39;calc&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_comments</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Check the uuids have not changed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">calc_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_comments</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmt_uuid</span><span class="p">)</span>

        <span class="c1"># Check the content of the comment has NOT been rewritten (&#39;newest&#39; mode)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_comments</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1">## Test comment_mode=&#39;overwrite&#39;</span>
        <span class="c1"># Reimport exported &#39;old&#39; calc and comment</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">comment_mode</span><span class="o">=</span><span class="s1">&#39;overwrite&#39;</span><span class="p">)</span>

        <span class="c1"># Check there are exactly 1 CalculationNode and 1 Comment</span>
        <span class="n">import_calcs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;calc&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">import_comments</span> <span class="o">=</span> <span class="n">import_calcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">,</span> <span class="n">with_node</span><span class="o">=</span><span class="s1">&#39;calc&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_comments</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Check the uuids have not changed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">calc_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_comments</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmt_uuid</span><span class="p">)</span>

        <span class="c1"># Check the content of the comment HAS been rewritten (&#39;overwrite&#39; mode)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_comments</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1">## Test ValueError is raised when using a wrong comment_mode:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">import_data</span><span class="p">(</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">comment_mode</span><span class="o">=</span><span class="s1">&#39;invalid&#39;</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_reimport_of_comments_for_single_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When a node with comments already exist in the DB, and more comments are</span>
<span class="sd">        imported for the same node (same UUID), test that only new comment-entries</span>
<span class="sd">        are added.</span>

<span class="sd">        Part I:</span>
<span class="sd">        Create CalculationNode and 1 Comment for it.</span>
<span class="sd">        Export CalculationNode with its 1 Comment to export file #1 &quot;EXISTING database&quot;.</span>
<span class="sd">        Add 3 Comments to CalculationNode.</span>
<span class="sd">        Export CalculationNode with its 4 Comments to export file #2 &quot;FULL database&quot;.</span>
<span class="sd">        Reset database.</span>

<span class="sd">        Part II:</span>
<span class="sd">        Reimport export file #1 &quot;EXISTING database&quot;.</span>
<span class="sd">        Add 3 Comments to CalculationNode.</span>
<span class="sd">        Export CalculationNode with its 4 Comments to export file #3 &quot;NEW database&quot;.</span>
<span class="sd">        Reset database.</span>

<span class="sd">        Part III:</span>
<span class="sd">        Reimport export file #1 &quot;EXISTING database&quot; (1 CalculationNode, 1 Comment).</span>
<span class="sd">        Import export file #2 &quot;FULL database&quot; (1 CalculationNode, 4 Comments).</span>
<span class="sd">        Check the database EXACTLY contains 1 CalculationNode and 4 Comments,</span>
<span class="sd">        with matching UUIDS all the way through all previous Parts.</span>

<span class="sd">        Part IV:</span>
<span class="sd">        Import export file #3 &quot;NEW database&quot; (1 CalculationNode, 4 Comments).</span>
<span class="sd">        Check the database EXACTLY contains 1 CalculationNode and 7 Comments,</span>
<span class="sd">        with matching UUIDS all the way through all previous Parts.</span>
<span class="sd">        NB! There should now be 7 Comments in the database. 6 of which are identical</span>
<span class="sd">        in pairs, except for their UUID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">export_filenames</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;EXISTING&quot;</span><span class="p">:</span> <span class="s2">&quot;export_EXISTING_db.tar.gz&quot;</span><span class="p">,</span>
            <span class="s2">&quot;FULL&quot;</span><span class="p">:</span> <span class="s2">&quot;export_FULL_db.tar.gz&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NEW&quot;</span><span class="p">:</span> <span class="s2">&quot;export_NEW_db.tar.gz&quot;</span>
        <span class="p">}</span>

        <span class="c1"># Get user</span>
        <span class="c1"># Will have to do this again after resetting the DB</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_default</span><span class="p">()</span>

        <span class="c1">## Part I</span>
        <span class="c1"># Create node and save UUID</span>
        <span class="n">calc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">calc_uuid</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">uuid</span>

        <span class="c1"># Create first comment</span>
        <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># There should be exactly: 1 CalculationNode, 1 Comment</span>
        <span class="n">export_calcs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">export_comments</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">export_calcs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">export_comments</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Save Comment UUID before export</span>
        <span class="n">existing_comment_uuids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">export_comments</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span>

        <span class="c1"># Export &quot;EXISTING&quot; DB</span>
        <span class="n">export_file_existing</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">export_filenames</span><span class="p">[</span><span class="s2">&quot;EXISTING&quot;</span><span class="p">])</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file_existing</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Add remaining Comments</span>
        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># There should be exactly: 1 CalculationNode, 3 Comments (len(self.comments))</span>
        <span class="n">export_calcs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">export_comments</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">export_calcs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">export_comments</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">))</span>

        <span class="c1"># Save Comment UUIDs before export, there should be 4 UUIDs in total (len(self.comments))</span>
        <span class="n">full_comment_uuids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">existing_comment_uuids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">comment_uuid</span> <span class="ow">in</span> <span class="n">export_comments</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">full_comment_uuids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">comment_uuid</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">full_comment_uuids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">))</span>

        <span class="c1"># Export &quot;FULL&quot; DB</span>
        <span class="n">export_file_full</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">export_filenames</span><span class="p">[</span><span class="s2">&quot;FULL&quot;</span><span class="p">])</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file_full</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Clean database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>

        <span class="c1">## Part II</span>
        <span class="c1"># Reimport &quot;EXISTING&quot; DB</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file_existing</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check the database is correctly imported.</span>
        <span class="c1"># There should be exactly: 1 CalculationNode, 1 Comment</span>
        <span class="n">import_calcs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">import_comments</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_comments</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Furthermore, the UUIDs should be the same</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">calc_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_comments</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">existing_comment_uuids</span><span class="p">)</span>

        <span class="c1"># Add remaining Comments (again)</span>
        <span class="n">calc</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># Reload CalculationNode</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_default</span><span class="p">()</span>           <span class="c1"># Get user - again</span>
        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># There should be exactly: 1 CalculationNode, 4 Comments (len(self.comments))</span>
        <span class="n">export_calcs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">export_comments</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">export_calcs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">export_comments</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">))</span>

        <span class="c1"># Save Comment UUIDs before export, there should be 4 UUIDs in total (len(self.comments))</span>
        <span class="n">new_comment_uuids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">existing_comment_uuids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">comment_uuid</span> <span class="ow">in</span> <span class="n">export_comments</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">new_comment_uuids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">comment_uuid</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_comment_uuids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">))</span>

        <span class="c1"># Export &quot;NEW&quot; DB</span>
        <span class="n">export_file_new</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">export_filenames</span><span class="p">[</span><span class="s2">&quot;NEW&quot;</span><span class="p">])</span>
        <span class="n">export</span><span class="p">([</span><span class="n">calc</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">export_file_new</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Clean database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>

        <span class="c1">## Part III</span>
        <span class="c1"># Reimport &quot;EXISTING&quot; DB</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file_existing</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check the database is correctly imported.</span>
        <span class="c1"># There should be exactly: 1 CalculationNode, 1 Comment</span>
        <span class="n">import_calcs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">import_comments</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_comments</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Furthermore, the UUIDs should be the same</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">calc_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_comments</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">existing_comment_uuids</span><span class="p">)</span>

        <span class="c1"># Import &quot;FULL&quot; DB</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file_full</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check the database is correctly imported.</span>
        <span class="c1"># There should be exactly: 1 CalculationNode, 4 Comments (len(self.comments))</span>
        <span class="n">import_calcs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">import_comments</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_comments</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">))</span>
        <span class="c1"># Furthermore, the UUIDs should be the same</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">calc_uuid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">import_comments</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">comment_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">comment</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">comment_uuid</span><span class="p">,</span> <span class="n">full_comment_uuids</span><span class="p">)</span>

        <span class="c1">## Part IV</span>
        <span class="c1"># Import &quot;NEW&quot; DB</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">export_file_new</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check the database is correctly imported.</span>
        <span class="c1"># There should be exactly: 1 CalculationNode, 7 Comments (org. (1) + 2 x added (3) Comments)</span>
        <span class="c1"># 4 of the comments are identical in pairs, except for the UUID.</span>
        <span class="n">import_calcs</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">import_comments</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Comment</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_comments</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">7</span><span class="p">)</span>
        <span class="c1"># Furthermore, the UUIDs should be the same</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_calcs</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">calc_uuid</span><span class="p">)</span>
        <span class="n">total_comment_uuids</span> <span class="o">=</span> <span class="n">full_comment_uuids</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">total_comment_uuids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_comment_uuids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">import_comments</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">comment_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">comment</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">comment_content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">comment</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">comment_uuid</span><span class="p">,</span> <span class="n">total_comment_uuids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">comment_content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestExtras"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestExtras">[docs]</a><span class="k">class</span> <span class="nc">TestExtras</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test ex-/import cases related to Extras&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestExtras.setUpClass"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestExtras.setUpClass">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Only run to prepare an export file&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestExtras</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;my_test_data_node&#39;</span>
        <span class="n">data</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">set_extras</span><span class="p">({</span><span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">tmp_folder</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">export_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">tmp_folder</span><span class="p">,</span> <span class="s1">&#39;export.aiida&#39;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">data</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestExtras.tearDownClass"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestExtras.tearDownClass">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">tearDownClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove tmp_folder&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestExtras</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownClass</span><span class="p">()</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">tmp_folder</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestExtras.setUp"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestExtras.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function runs before every test execution&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_data</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestExtras.import_extras"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestExtras.import_extras">[docs]</a>    <span class="k">def</span> <span class="nf">import_extras</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode_new</span><span class="o">=</span><span class="s1">&#39;import&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Import an aiida database&quot;&quot;&quot;</span>
        <span class="n">import_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extras_mode_new</span><span class="o">=</span><span class="n">mode_new</span><span class="p">)</span>

        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;my_test_data_node&#39;</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imported_node</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="TestExtras.modify_extras"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestExtras.modify_extras">[docs]</a>    <span class="k">def</span> <span class="nf">modify_extras</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode_existing</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Import the same aiida database again&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imported_node</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imported_node</span><span class="o">.</span><span class="n">set_extra</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imported_node</span><span class="o">.</span><span class="n">delete_extra</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>

        <span class="n">import_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extras_mode_existing</span><span class="o">=</span><span class="n">mode_existing</span><span class="p">)</span>

        <span class="c1"># Query again the database</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;my_test_data_node&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="TestExtras.tearDown"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestExtras.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="TestExtras.test_import_of_extras"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestExtras.test_import_of_extras">[docs]</a>    <span class="k">def</span> <span class="nf">test_import_of_extras</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if extras are properly imported&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_extras</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imported_node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imported_node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestExtras.test_absence_of_extras"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestExtras.test_absence_of_extras">[docs]</a>    <span class="k">def</span> <span class="nf">test_absence_of_extras</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check whether extras are not imported if the mode is set to &#39;none&#39;&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_extras</span><span class="p">(</span><span class="n">mode_new</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
            <span class="c1"># the extra &#39;b&#39; should not exist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imported_node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
            <span class="c1"># the extra &#39;c&#39; should not exist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imported_node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestExtras.test_extras_import_mode_keep_existing"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestExtras.test_extras_import_mode_keep_existing">[docs]</a>    <span class="k">def</span> <span class="nf">test_extras_import_mode_keep_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if old extras are not modified in case of name collision&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_extras</span><span class="p">()</span>
        <span class="n">imported_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify_extras</span><span class="p">(</span><span class="n">mode_existing</span><span class="o">=</span><span class="s1">&#39;kcl&#39;</span><span class="p">)</span>

        <span class="c1"># Check that extras are imported correctly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestExtras.test_extras_import_mode_update_existing"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestExtras.test_extras_import_mode_update_existing">[docs]</a>    <span class="k">def</span> <span class="nf">test_extras_import_mode_update_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if old extras are modified in case of name collision&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_extras</span><span class="p">()</span>
        <span class="n">imported_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify_extras</span><span class="p">(</span><span class="n">mode_existing</span><span class="o">=</span><span class="s1">&#39;kcu&#39;</span><span class="p">)</span>

        <span class="c1"># Check that extras are imported correctly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestExtras.test_extras_import_mode_mirror"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestExtras.test_extras_import_mode_mirror">[docs]</a>    <span class="k">def</span> <span class="nf">test_extras_import_mode_mirror</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if old extras are fully overwritten by the imported ones&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_extras</span><span class="p">()</span>
        <span class="n">imported_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify_extras</span><span class="p">(</span><span class="n">mode_existing</span><span class="o">=</span><span class="s1">&#39;ncu&#39;</span><span class="p">)</span>

        <span class="c1"># Check that extras are imported correctly</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>  <span class="c1"># the extra</span>
            <span class="c1"># &#39;a&#39; should not exist, as the extras were fully mirrored with respect to</span>
            <span class="c1"># the imported node</span>
            <span class="n">imported_node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestExtras.test_extras_import_mode_none"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestExtras.test_extras_import_mode_none">[docs]</a>    <span class="k">def</span> <span class="nf">test_extras_import_mode_none</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if old extras are fully overwritten by the imported ones&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_extras</span><span class="p">()</span>
        <span class="n">imported_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify_extras</span><span class="p">(</span><span class="n">mode_existing</span><span class="o">=</span><span class="s1">&#39;knl&#39;</span><span class="p">)</span>

        <span class="c1"># Check if extras are imported correctly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>  <span class="c1"># the extra</span>
            <span class="c1"># &#39;c&#39; should not exist, as the extras were keept untached</span>
            <span class="n">imported_node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestExtras.test_extras_import_mode_strange"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestExtras.test_extras_import_mode_strange">[docs]</a>    <span class="k">def</span> <span class="nf">test_extras_import_mode_strange</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check a mode that is probably does not make much sense but is still available&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_extras</span><span class="p">()</span>
        <span class="n">imported_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify_extras</span><span class="p">(</span><span class="n">mode_existing</span><span class="o">=</span><span class="s1">&#39;kcd&#39;</span><span class="p">)</span>

        <span class="c1"># Check if extras are imported correctly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>  <span class="c1"># the extra</span>
            <span class="c1"># &#39;b&#39; should not exist, as the collided extras are deleted</span>
            <span class="n">imported_node</span><span class="o">.</span><span class="n">get_extra</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestExtras.test_extras_import_mode_correct"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestExtras.test_extras_import_mode_correct">[docs]</a>    <span class="k">def</span> <span class="nf">test_extras_import_mode_correct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test all possible import modes except &#39;ask&#39; &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_extras</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">l1</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">]:</span>  <span class="c1"># keep or not keep old extras</span>
            <span class="k">for</span> <span class="n">l2</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]:</span>  <span class="c1"># create or not create new extras</span>
                <span class="k">for</span> <span class="n">l3</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">]:</span>  <span class="c1"># leave old, update or delete collided extras</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">l1</span> <span class="o">+</span> <span class="n">l2</span> <span class="o">+</span> <span class="n">l3</span>
                    <span class="n">import_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extras_mode_existing</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestExtras.test_extras_import_mode_wrong"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestExtras.test_extras_import_mode_wrong">[docs]</a>    <span class="k">def</span> <span class="nf">test_extras_import_mode_wrong</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check a mode that is wrong&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_extras</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">import_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extras_mode_existing</span><span class="o">=</span><span class="s1">&#39;xnd&#39;</span><span class="p">)</span>  <span class="c1"># first letter is wrong</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">import_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extras_mode_existing</span><span class="o">=</span><span class="s1">&#39;nxd&#39;</span><span class="p">)</span>  <span class="c1"># second letter is wrong</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">import_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extras_mode_existing</span><span class="o">=</span><span class="s1">&#39;nnx&#39;</span><span class="p">)</span>  <span class="c1"># third letter is wrong</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">import_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extras_mode_existing</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>  <span class="c1"># too short</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">import_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extras_mode_existing</span><span class="o">=</span><span class="s1">&#39;nndnn&#39;</span><span class="p">)</span>  <span class="c1"># too long</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">import_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_file</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extras_mode_existing</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># wrong type</span></div></div>


<div class="viewcode-block" id="TestProvenanceRedesign"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestProvenanceRedesign">[docs]</a><span class="k">class</span> <span class="nc">TestProvenanceRedesign</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check changes in database schema after upgrading to v0.4 (Provenance Redesign)</span>
<span class="sd">    This includes all migrations from &quot;base_data_plugin_type_string&quot; (django: 0008)</span>
<span class="sd">    until &quot;dbgroup_type_string_change_content&quot; (django: 0022), both included.</span>

<span class="sd">    The effects of the large db migration &quot;provenance_redesign&quot; (django: 0020)</span>
<span class="sd">    is tested in `TestLinks`, since the greatest change concerns links.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestProvenanceRedesign.setUp"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestProvenanceRedesign.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestProvenanceRedesign</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestProvenanceRedesign.tearDown"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestProvenanceRedesign.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestProvenanceRedesign</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span></div>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_base_data_type_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Base Data types type string changed</span>
<span class="sd">        Example: Bool: data.base.Bool.  data.bool.Bool.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Test content</span>
        <span class="n">test_content</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2399834e12</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">test_types</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">]:</span>
            <span class="n">add_type</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;data.</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_type</span><span class="p">,</span> <span class="n">node_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()),)</span>
            <span class="n">test_types</span> <span class="o">=</span> <span class="n">test_types</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">add_type</span><span class="p">)</span>

        <span class="c1"># List of nodes to be exported</span>
        <span class="n">export_nodes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Create list of base type nodes</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span> <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">test_content</span><span class="p">,</span> <span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Str</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Bool</span><span class="p">))]</span>
        <span class="n">export_nodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

        <span class="c1"># Collect uuids for created nodes</span>
        <span class="n">uuids</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">]</span>

        <span class="c1"># Create List() and insert already created nodes into it</span>
        <span class="n">list_node</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">List</span><span class="p">()</span>
        <span class="n">list_node</span><span class="o">.</span><span class="n">set_list</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
        <span class="n">list_node</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">list_node_uuid</span> <span class="o">=</span> <span class="n">list_node</span><span class="o">.</span><span class="n">uuid</span>
        <span class="n">export_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">list_node</span><span class="p">)</span>

        <span class="c1"># Export nodes</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">(</span><span class="n">export_nodes</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Clean the database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>

        <span class="c1"># Import nodes again</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check whether types are correctly imported</span>
        <span class="n">nlist</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">list_node_uuid</span><span class="p">)</span>  <span class="c1"># List</span>
        <span class="k">for</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">list_value</span><span class="p">,</span> <span class="n">refval</span><span class="p">,</span> <span class="n">reftype</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">uuids</span><span class="p">,</span> <span class="n">nlist</span><span class="o">.</span><span class="n">get_list</span><span class="p">(),</span> <span class="n">test_content</span><span class="p">,</span> <span class="n">test_types</span><span class="p">):</span>
            <span class="c1"># Str, Int, Float, Bool</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
            <span class="c1"># Check value/content</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">refval</span><span class="p">)</span>
            <span class="c1"># Check type</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;type of node (&#39;</span><span class="si">{}</span><span class="s2">&#39;) is not updated according to db schema v0.4&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">node_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">node_type</span><span class="p">,</span> <span class="n">reftype</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># List</span>
            <span class="c1"># Check value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">list_value</span><span class="p">,</span> <span class="n">refval</span><span class="p">)</span>

        <span class="c1"># Check List type</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;type of node (&#39;</span><span class="si">{}</span><span class="s2">&#39;) is not updated according to db schema v0.4&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nlist</span><span class="o">.</span><span class="n">node_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">nlist</span><span class="o">.</span><span class="n">node_type</span><span class="p">,</span> <span class="s1">&#39;data.list.List.&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_node_process_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Column `process_type` added to `Node` entity DB table &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.backends.tests.utils.processes</span> <span class="k">import</span> <span class="n">AddProcess</span>
        <span class="kn">from</span> <span class="nn">aiida.engine</span> <span class="k">import</span> <span class="n">run_get_node</span>

        <span class="c1"># Create temporary folder for the import/export files</span>
        <span class="n">tmp_folder</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

        <span class="c1"># Node types</span>
        <span class="n">node_type</span> <span class="o">=</span> <span class="s2">&quot;process.workflow.WorkflowNode.&quot;</span>
        <span class="n">node_process_type</span> <span class="o">=</span> <span class="s2">&quot;aiida.backends.tests.utils.processes.AddProcess&quot;</span>

        <span class="c1"># Run workflow</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">3</span><span class="p">)}</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">node</span> <span class="o">=</span> <span class="n">run_get_node</span><span class="p">(</span><span class="n">AddProcess</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">)</span>

        <span class="c1"># Save node uuid</span>
        <span class="n">node_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="c1"># Assert correct type and process_type strings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node_type</span><span class="p">,</span> <span class="n">node_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">process_type</span><span class="p">,</span> <span class="n">node_process_type</span><span class="p">)</span>

        <span class="c1"># Export nodes</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">node</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Clean the database and reimport data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Retrieve node and check exactly one node is imported</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">ProcessNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Get node uuid and check it is the same as the one exported</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">imported_node_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_node_uuid</span><span class="p">,</span> <span class="n">node_uuid</span><span class="p">)</span>

        <span class="c1"># Check imported node type and process type</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">imported_node_uuid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node_type</span><span class="p">,</span> <span class="n">node_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">process_type</span><span class="p">,</span> <span class="n">node_process_type</span><span class="p">)</span>

    <span class="nd">@with_temp_dir</span>
    <span class="k">def</span> <span class="nf">test_code_type_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Code type string changed</span>
<span class="sd">        Change: code.Bool.  data.code.Code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create Code instance</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="p">()</span>
        <span class="n">code</span><span class="o">.</span><span class="n">set_remote_computer_exec</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">computer</span><span class="p">,</span> <span class="s1">&#39;/bin/true&#39;</span><span class="p">))</span>
        <span class="n">code</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Save uuid and type</span>
        <span class="n">code_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="n">code_type</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">node_type</span>

        <span class="c1"># Assert correct type exists prior to export</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">code_type</span><span class="p">,</span> <span class="s2">&quot;data.code.Code.&quot;</span><span class="p">)</span>

        <span class="c1"># Export node</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;export.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">export</span><span class="p">([</span><span class="n">code</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Clean the database and reimport</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>
        <span class="n">import_data</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Retrieve Code node and make sure exactly 1 is retrieved</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Code</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="n">imported_code</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Check uuid is the same after import</span>
        <span class="n">imported_code_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">imported_code</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_code_uuid</span><span class="p">,</span> <span class="n">code_uuid</span><span class="p">)</span>

        <span class="c1"># Check whether types are correctly imported</span>
        <span class="n">imported_code_type</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">imported_code_uuid</span><span class="p">)</span><span class="o">.</span><span class="n">node_type</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">imported_code_type</span><span class="p">,</span> <span class="n">code_type</span><span class="p">)</span>

<div class="viewcode-block" id="TestProvenanceRedesign.test_group_name_and_type_change"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_export_and_import.TestProvenanceRedesign.test_group_name_and_type_change">[docs]</a>    <span class="k">def</span> <span class="nf">test_group_name_and_type_change</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Group&#39;s name and type columns have changed</span>
<span class="sd">        Change for columns:</span>
<span class="sd">        name            --&gt; label</span>
<span class="sd">        &quot;type&quot;            --&gt; &quot;type_string&quot;</span>
<span class="sd">        Furthermore, type_strings have been updated to:</span>
<span class="sd">        &quot;&quot;                --&gt; &quot;user&quot;</span>
<span class="sd">        &quot;data.upf.family&quot; --&gt; &quot;data.upf&quot;</span>
<span class="sd">        &quot;aiida.import&quot;    --&gt; &quot;auto.import&quot;</span>
<span class="sd">        &quot;autogroup.run&quot;   --&gt; &quot;auto.run&quot;</span>

<span class="sd">        The new columns are called on group instances, and will fail if not present.</span>
<span class="sd">        A user created Group is validated to have the &quot;user&quot; value as a type_string.</span>
<span class="sd">        A UPF file is created and imported/uploaded as a UPF family,</span>
<span class="sd">        in order to create a Group with type_string=&quot;data.upf&quot;.</span>
<span class="sd">        Any import will create a Group with type_string &quot;auto.import&quot;, which is checked.</span>
<span class="sd">        The type_string=&quot;auto.run&quot; is not directly checked, but if the three checks</span>
<span class="sd">        above succeed, it is understood that &quot;auto.run&quot; is also correctly ex-/imported</span>
<span class="sd">        as the type_string content for the relevant Groups.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.orm.nodes.data.upf</span> <span class="k">import</span> <span class="n">upload_upf_family</span>

        <span class="c1"># Create temporary folders for the import/export files</span>
        <span class="n">export_tmp_folder</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="n">upf_tmp_folder</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

        <span class="c1"># To be saved</span>
        <span class="n">groups_label</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Users&quot;</span><span class="p">,</span> <span class="s2">&quot;UpfData&quot;</span><span class="p">]</span>
        <span class="n">upf_filename</span> <span class="o">=</span> <span class="s2">&quot;Al.test_file.UPF&quot;</span>
        <span class="c1"># regular upf file version 2 header</span>
        <span class="n">upf_contents</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="s2">&quot;&lt;UPF version=</span><span class="se">\&quot;</span><span class="s2">2.0.1</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Human readable section is completely irrelevant for parsing!&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&lt;PP_HEADER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;contents before element tag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;element=</span><span class="se">\&quot;</span><span class="s2">Al</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;contents following element tag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span>
        <span class="p">])</span>
        <span class="n">path_to_upf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">upf_tmp_folder</span><span class="p">,</span> <span class="n">upf_filename</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_upf</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">upf_file</span><span class="p">:</span>
            <span class="n">upf_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">upf_contents</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create Groups</span>
            <span class="n">node1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
            <span class="n">node2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
            <span class="n">group_user</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">groups_label</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
            <span class="n">group_user</span><span class="o">.</span><span class="n">add_nodes</span><span class="p">([</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">])</span>

            <span class="n">nfiles</span><span class="p">,</span> <span class="n">nuploads</span> <span class="o">=</span> <span class="n">upload_upf_family</span><span class="p">(</span><span class="n">upf_tmp_folder</span><span class="p">,</span> <span class="n">groups_label</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">group_upf</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_group</span><span class="p">(</span><span class="n">groups_label</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># Save uuids and type</span>
            <span class="n">users_uuid</span>         <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>   <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">group_user</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span>
            <span class="n">upfs_uuid</span>          <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>   <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">group_upf</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span>
            <span class="n">groups_uuid</span>        <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>   <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="p">[</span><span class="n">group_user</span><span class="p">,</span> <span class="n">group_upf</span><span class="p">]]</span>
            <span class="n">groups_type_string</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">type_string</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="p">[</span><span class="n">group_user</span><span class="p">,</span> <span class="n">group_upf</span><span class="p">]]</span>

            <span class="c1"># Assert correct type strings exists prior to export</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertListEqual</span><span class="p">(</span><span class="n">groups_type_string</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;data.upf&quot;</span><span class="p">])</span>

            <span class="c1"># Export node</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">export_tmp_folder</span><span class="p">,</span> <span class="s2">&quot;export.tar.gz&quot;</span><span class="p">)</span>
            <span class="n">export</span><span class="p">([</span><span class="n">group_user</span><span class="p">,</span> <span class="n">group_upf</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Clean the database and reimport</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_database</span><span class="p">()</span>
            <span class="n">import_data</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Retrieve Groups and make sure exactly 3 are retrieved (including the &quot;import group&quot;)</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
            <span class="n">imported_groups</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span>

            <span class="c1"># Check uuids are the same after import</span>
            <span class="n">imported_groups_uuid</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">imported_groups</span><span class="p">]</span>

            <span class="c1"># We do not know the &quot;import group&quot;&#39;s uuid, so go through known uuids</span>
            <span class="k">for</span> <span class="n">group_uuid</span> <span class="ow">in</span> <span class="n">groups_uuid</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">,</span> <span class="n">imported_groups_uuid</span><span class="p">)</span>

                <span class="c1"># Pop known uuid from imported_groups_uuid, eventually leaving</span>
                <span class="c1"># only the &quot;import group&quot;</span>
                <span class="n">imported_groups_uuid</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span>

                <span class="c1"># Load group</span>
                <span class="n">imported_group</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_group</span><span class="p">(</span><span class="n">group_uuid</span><span class="p">)</span>

                <span class="c1"># Check whether types are correctly imported</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">imported_group</span><span class="o">.</span><span class="n">type_string</span><span class="p">,</span> <span class="n">groups_type_string</span><span class="p">)</span>

                <span class="c1"># Assert labels are imported correctly</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">imported_group</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">groups_label</span><span class="p">)</span>

            <span class="c1"># Check type_string content of &quot;import group&quot;</span>
            <span class="n">import_group</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">load_group</span><span class="p">(</span><span class="n">imported_groups_uuid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">import_group</span><span class="o">.</span><span class="n">type_string</span><span class="p">,</span> <span class="s2">&quot;auto.import&quot;</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Deleting the created temporary folders</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">export_tmp_folder</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">upf_tmp_folder</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>