

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.backends.tests.test_query &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../aiida.html">aiida</a> &raquo;</li>
        
          <li><a href="../tests.html">aiida.backends.tests</a> &raquo;</li>
        
      <li>aiida.backends.tests.test_query</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.backends.tests.test_query</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;Tests for the QueryBuilder.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">zip</span>

<span class="kn">from</span> <span class="nn">aiida</span> <span class="k">import</span> <span class="n">orm</span>
<span class="kn">from</span> <span class="nn">aiida.manage</span> <span class="k">import</span> <span class="n">configuration</span>
<span class="kn">from</span> <span class="nn">aiida.backends.testbase</span> <span class="k">import</span> <span class="n">AiidaTestCase</span>
<span class="kn">from</span> <span class="nn">aiida.common.links</span> <span class="k">import</span> <span class="n">LinkType</span>

<span class="c1"># pylint: disable=invalid-name,missing-docstring,too-many-lines</span>


<div class="viewcode-block" id="TestQueryBuilder"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestQueryBuilder">[docs]</a><span class="k">class</span> <span class="nc">TestQueryBuilder</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestQueryBuilder.setUp"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestQueryBuilder.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestQueryBuilder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_data</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestQueryBuilder.test_ormclass_type_classification"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestQueryBuilder.test_ormclass_type_classification">[docs]</a>    <span class="k">def</span> <span class="nf">test_ormclass_type_classification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This tests the classifications of the QueryBuilder</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=protected-access</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">DbContentError</span>

        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>

        <span class="c1"># Asserting that improper declarations of the class type raise an error</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">DbContentError</span><span class="p">):</span>
            <span class="n">qb</span><span class="o">.</span><span class="n">_get_ormclass</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">DbContentError</span><span class="p">):</span>
            <span class="n">qb</span><span class="o">.</span><span class="n">_get_ormclass</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;data.Data&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">DbContentError</span><span class="p">):</span>
            <span class="n">qb</span><span class="o">.</span><span class="n">_get_ormclass</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>

        <span class="c1"># Asserting that the query type string and plugin type string are returned:</span>
        <span class="k">for</span> <span class="n">_cls</span><span class="p">,</span> <span class="n">classifiers</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">qb</span><span class="o">.</span><span class="n">_get_ormclass</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">qb</span><span class="o">.</span><span class="n">_get_ormclass</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;data.structure.StructureData.&#39;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">classifiers</span><span class="p">[</span><span class="s1">&#39;ormclass_type_string&#39;</span><span class="p">],</span> <span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="o">.</span><span class="n">_plugin_type_string</span><span class="p">)</span>  <span class="c1"># pylint: disable=no-member</span>

        <span class="k">for</span> <span class="n">_cls</span><span class="p">,</span> <span class="n">classifiers</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">qb</span><span class="o">.</span><span class="n">_get_ormclass</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">qb</span><span class="o">.</span><span class="n">_get_ormclass</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">),</span>
                <span class="n">qb</span><span class="o">.</span><span class="n">_get_ormclass</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Group&#39;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">classifiers</span><span class="p">[</span><span class="s1">&#39;ormclass_type_string&#39;</span><span class="p">],</span> <span class="s1">&#39;group&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_cls</span><span class="p">,</span> <span class="n">classifiers</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">qb</span><span class="o">.</span><span class="n">_get_ormclass</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">qb</span><span class="o">.</span><span class="n">_get_ormclass</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">),</span>
                <span class="n">qb</span><span class="o">.</span><span class="n">_get_ormclass</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;User&quot;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">classifiers</span><span class="p">[</span><span class="s1">&#39;ormclass_type_string&#39;</span><span class="p">],</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_cls</span><span class="p">,</span> <span class="n">classifiers</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">qb</span><span class="o">.</span><span class="n">_get_ormclass</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">qb</span><span class="o">.</span><span class="n">_get_ormclass</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;computer&#39;</span><span class="p">),</span>
                <span class="n">qb</span><span class="o">.</span><span class="n">_get_ormclass</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Computer&#39;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">classifiers</span><span class="p">[</span><span class="s1">&#39;ormclass_type_string&#39;</span><span class="p">],</span> <span class="s1">&#39;computer&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_cls</span><span class="p">,</span> <span class="n">classifiers</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">qb</span><span class="o">.</span><span class="n">_get_ormclass</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">qb</span><span class="o">.</span><span class="n">_get_ormclass</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;data.Data.&#39;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">classifiers</span><span class="p">[</span><span class="s1">&#39;ormclass_type_string&#39;</span><span class="p">],</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="n">_plugin_type_string</span><span class="p">)</span>  <span class="c1"># pylint: disable=no-member</span></div>

<div class="viewcode-block" id="TestQueryBuilder.test_process_type_classification"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestQueryBuilder.test_process_type_classification">[docs]</a>    <span class="k">def</span> <span class="nf">test_process_type_classification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This tests the classifications of the QueryBuilder</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.engine</span> <span class="k">import</span> <span class="n">WorkChain</span>
        <span class="kn">from</span> <span class="nn">aiida.plugins</span> <span class="k">import</span> <span class="n">CalculationFactory</span>

        <span class="n">ArithmeticAdd</span> <span class="o">=</span> <span class="n">CalculationFactory</span><span class="p">(</span><span class="s1">&#39;arithmetic.add&#39;</span><span class="p">)</span>

        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>

        <span class="c1"># pylint: disable=protected-access</span>

        <span class="c1"># When passing a WorkChain class, it should return the type of the corresponding Node</span>
        <span class="c1"># including the appropriate filter on the process_type</span>
        <span class="n">_cls</span><span class="p">,</span> <span class="n">classifiers</span> <span class="o">=</span> <span class="n">qb</span><span class="o">.</span><span class="n">_get_ormclass</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">classifiers</span><span class="p">[</span><span class="s1">&#39;ormclass_type_string&#39;</span><span class="p">],</span> <span class="s1">&#39;process.workflow.workchain.WorkChainNode.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">classifiers</span><span class="p">[</span><span class="s1">&#39;process_type_string&#39;</span><span class="p">],</span> <span class="s1">&#39;aiida.engine.processes.workchains.workchain.WorkChain&#39;</span><span class="p">)</span>

        <span class="c1"># When passing a WorkChainNode, no process_type filter is applied</span>
        <span class="n">_cls</span><span class="p">,</span> <span class="n">classifiers</span> <span class="o">=</span> <span class="n">qb</span><span class="o">.</span><span class="n">_get_ormclass</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">WorkChainNode</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">classifiers</span><span class="p">[</span><span class="s1">&#39;ormclass_type_string&#39;</span><span class="p">],</span> <span class="s1">&#39;process.workflow.workchain.WorkChainNode.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">classifiers</span><span class="p">[</span><span class="s1">&#39;process_type_string&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Same tests for a calculation</span>
        <span class="n">_cls</span><span class="p">,</span> <span class="n">classifiers</span> <span class="o">=</span> <span class="n">qb</span><span class="o">.</span><span class="n">_get_ormclass</span><span class="p">(</span><span class="n">ArithmeticAdd</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">classifiers</span><span class="p">[</span><span class="s1">&#39;ormclass_type_string&#39;</span><span class="p">],</span> <span class="s1">&#39;process.calculation.calcjob.CalcJobNode.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">classifiers</span><span class="p">[</span><span class="s1">&#39;process_type_string&#39;</span><span class="p">],</span> <span class="s1">&#39;aiida.calculations:arithmetic.add&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestQueryBuilder.test_process_query"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestQueryBuilder.test_process_query">[docs]</a>    <span class="k">def</span> <span class="nf">test_process_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test querying for a process class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.engine</span> <span class="k">import</span> <span class="n">run</span><span class="p">,</span> <span class="n">WorkChain</span><span class="p">,</span> <span class="n">if_</span><span class="p">,</span> <span class="n">return_</span><span class="p">,</span> <span class="n">ExitCode</span>
        <span class="kn">from</span> <span class="nn">aiida.common.warnings</span> <span class="k">import</span> <span class="n">AiidaEntryPointWarning</span>

        <span class="k">class</span> <span class="nc">PotentialFailureWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>
            <span class="n">EXIT_STATUS</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">EXIT_MESSAGE</span> <span class="o">=</span> <span class="s1">&#39;Well you did ask for it&#39;</span>
            <span class="n">OUTPUT_LABEL</span> <span class="o">=</span> <span class="s1">&#39;optional_output&#39;</span>
            <span class="n">OUTPUT_VALUE</span> <span class="o">=</span> <span class="mi">144</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">PotentialFailureWorkChain</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">Bool</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;through_return&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">Bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;through_exit_code&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">Bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">exit_code</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">EXIT_STATUS</span><span class="p">,</span> <span class="s1">&#39;EXIT_STATUS&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">EXIT_MESSAGE</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="n">if_</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">should_return_out_of_outline</span><span class="p">)(</span><span class="n">return_</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">EXIT_STATUS</span><span class="p">)),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">failure</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">success</span><span class="p">)</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">OUTPUT_LABEL</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">should_return_out_of_outline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">through_return</span><span class="o">.</span><span class="n">value</span>

            <span class="k">def</span> <span class="nf">failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="c1"># pylint: disable=no-else-return</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">success</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="c1"># Returning either 0 or ExitCode with non-zero status should terminate the workchain</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">through_exit_code</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXIT_STATUS</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_codes</span><span class="o">.</span><span class="n">EXIT_STATUS</span>  <span class="c1"># pylint: disable=no-member</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Returning 0 or ExitCode with zero status should *not* terminate the workchain</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">through_exit_code</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">return</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">ExitCode</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTPUT_LABEL</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTPUT_VALUE</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">())</span>

        <span class="k">class</span> <span class="nc">DummyWorkChain</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="c1"># Run a simple test WorkChain</span>
        <span class="n">_result</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">PotentialFailureWorkChain</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>

        <span class="c1"># Query for nodes associated with this type of WorkChain</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>  <span class="c1"># pylint: disable=no-member</span>
            <span class="c1"># Cause all warnings to always be triggered.</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;always&quot;</span><span class="p">)</span>  <span class="c1"># pylint: disable=no-member</span>

            <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PotentialFailureWorkChain</span><span class="p">)</span>

            <span class="c1"># Verify some things</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="n">AiidaEntryPointWarning</span><span class="p">)</span>

        <span class="c1"># There should be one result of type WorkChainNode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkChainNode</span><span class="p">))</span>

        <span class="c1"># Query for nodes of a different type of WorkChain</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>  <span class="c1"># pylint: disable=no-member</span>
            <span class="c1"># Cause all warnings to always be triggered.</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;always&quot;</span><span class="p">)</span>  <span class="c1"># pylint: disable=no-member</span>

            <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DummyWorkChain</span><span class="p">)</span>

            <span class="c1"># Verify some things</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="n">AiidaEntryPointWarning</span><span class="p">)</span>

        <span class="c1"># There should be no result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Query for all WorkChain nodes</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">WorkChain</span><span class="p">)</span>

        <span class="c1"># There should be one result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestQueryBuilder.test_simple_query_1"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestQueryBuilder.test_simple_query_1">[docs]</a>    <span class="k">def</span> <span class="nf">test_simple_query_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Testing a simple query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=too-many-statements</span>

        <span class="n">n1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;node1&#39;</span>
        <span class="n">n1</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;goodbye&#39;</span><span class="p">])</span>
        <span class="n">n1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">n2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">n2</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;node2&#39;</span>
        <span class="n">n2</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">n3</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n3</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;node3&#39;</span>
        <span class="n">n3</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">)</span>  <span class="c1"># Stored as fval</span>
        <span class="n">n3</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">n4</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">n4</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;node4&#39;</span>
        <span class="n">n4</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>

        <span class="n">n5</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n5</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;node5&#39;</span>
        <span class="n">n5</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">n5</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">n2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link1&#39;</span><span class="p">)</span>
        <span class="n">n2</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">n3</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link2&#39;</span><span class="p">)</span>

        <span class="n">n4</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n3</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link3&#39;</span><span class="p">)</span>
        <span class="n">n4</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">n5</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n4</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link4&#39;</span><span class="p">)</span>

        <span class="n">qb1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.foo&#39;</span><span class="p">:</span> <span class="mf">1.000</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qb1</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">qb2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb2</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">qb2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity_type</span><span class="o">=</span><span class="s1">&#39;data.Data.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb2</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">qb3</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;node1&#39;</span><span class="p">)</span>
        <span class="n">qb3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;node2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb3</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">4</span><span class="p">)</span>

        <span class="n">qb4</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;node1&#39;</span><span class="p">)</span>
        <span class="n">qb4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;node2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb4</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">qb5</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb5</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;node1&#39;</span><span class="p">)</span>
        <span class="n">qb5</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;node2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb5</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">qb6</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb6</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;node1&#39;</span><span class="p">)</span>
        <span class="n">qb6</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;node2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb6</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestQueryBuilder.test_simple_query_2"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestQueryBuilder.test_simple_query_2">[docs]</a>    <span class="k">def</span> <span class="nf">test_simple_query_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">MultipleObjectsError</span><span class="p">,</span> <span class="n">NotExistent</span>
        <span class="n">n0</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n0</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;hello&#39;</span>
        <span class="n">n0</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">n0</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>

        <span class="n">n1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">n1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>
        <span class="n">n1</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;I am FoO&#39;</span>

        <span class="n">n2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n2</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span>
        <span class="n">n2</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;I am BaR&#39;</span>

        <span class="n">n2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;random_2&#39;</span><span class="p">)</span>
        <span class="n">n1</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n0</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;random_1&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="n">n0</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
            <span class="n">n</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">qb1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;hello&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">qb1</span><span class="o">.</span><span class="n">all</span><span class="p">())),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">qh</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s1">&#39;cls&#39;</span><span class="p">:</span> <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span>
                <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;n1&#39;</span>
            <span class="p">},</span> <span class="p">{</span>
                <span class="s1">&#39;cls&#39;</span><span class="p">:</span> <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span>
                <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;n2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;with_incoming&#39;</span><span class="p">:</span> <span class="s1">&#39;n1&#39;</span>
            <span class="p">}],</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;n1&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;ilike&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">oO%&#39;</span>
                    <span class="p">},</span>
                <span class="p">},</span>
                <span class="s1">&#39;n2&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;ilike&#39;</span><span class="p">:</span> <span class="s1">&#39;bar%&#39;</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;project&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;n1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;ctime&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">],</span>
                <span class="s1">&#39;n2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">qb2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">(</span><span class="o">**</span><span class="n">qh</span><span class="p">)</span>

        <span class="n">resdict</span> <span class="o">=</span> <span class="n">qb2</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resdict</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">resdict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;n1&#39;</span><span class="p">][</span><span class="s1">&#39;ctime&#39;</span><span class="p">],</span> <span class="n">datetime</span><span class="p">))</span>

        <span class="n">res_one</span> <span class="o">=</span> <span class="n">qb2</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span> <span class="ow">in</span> <span class="n">res_one</span><span class="p">)</span>

        <span class="n">qh</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s1">&#39;cls&#39;</span><span class="p">:</span> <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span>
                <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;n1&#39;</span>
            <span class="p">},</span> <span class="p">{</span>
                <span class="s1">&#39;cls&#39;</span><span class="p">:</span> <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span>
                <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;n2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;with_incoming&#39;</span><span class="p">:</span> <span class="s1">&#39;n1&#39;</span>
            <span class="p">}],</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;n1--n2&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;like&#39;</span><span class="p">:</span> <span class="s1">&#39;%_2&#39;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">(</span><span class="o">**</span><span class="n">qh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Test the hashing:</span>
        <span class="n">query1</span> <span class="o">=</span> <span class="n">qb</span><span class="o">.</span><span class="n">get_query</span><span class="p">()</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s1">&#39;n2&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;nonexistentlabel&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">NotExistent</span><span class="p">):</span>
            <span class="n">qb</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">MultipleObjectsError</span><span class="p">):</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>

        <span class="n">query2</span> <span class="o">=</span> <span class="n">qb</span><span class="o">.</span><span class="n">get_query</span><span class="p">()</span>
        <span class="n">query3</span> <span class="o">=</span> <span class="n">qb</span><span class="o">.</span><span class="n">get_query</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">query1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">id</span><span class="p">(</span><span class="n">query2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">query2</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">query3</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestQueryBuilder.test_operators_eq_lt_gt"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestQueryBuilder.test_operators_eq_lt_gt">[docs]</a>    <span class="k">def</span> <span class="nf">test_operators_eq_lt_gt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>

        <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;fa&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;fa&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">nodes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;fa&#39;</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">)</span>
        <span class="n">nodes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;fa&#39;</span><span class="p">,</span> <span class="mf">1.02</span><span class="p">)</span>
        <span class="n">nodes</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;fa&#39;</span><span class="p">,</span> <span class="mf">1.03</span><span class="p">)</span>
        <span class="n">nodes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;fa&#39;</span><span class="p">,</span> <span class="mf">1.04</span><span class="p">)</span>
        <span class="n">nodes</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;fa&#39;</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">)</span>
        <span class="n">nodes</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;fa&#39;</span><span class="p">,</span> <span class="mf">1.06</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">n</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.fa&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}})</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.fa&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;==&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}})</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.fa&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="mf">1.02</span><span class="p">}})</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.fa&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span> <span class="mf">1.02</span><span class="p">}})</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.fa&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="mf">1.02</span><span class="p">}})</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.fa&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;&gt;=&#39;</span><span class="p">:</span> <span class="mf">1.02</span><span class="p">}})</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">5</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestQueryBuilder.test_subclassing"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestQueryBuilder.test_subclassing">[docs]</a>    <span class="k">def</span> <span class="nf">test_subclassing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="s1">&#39;miau&#39;</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">d</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="s1">&#39;miau&#39;</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">cat</span><span class="o">=</span><span class="s1">&#39;miau&#39;</span><span class="p">))</span>
        <span class="n">p</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Now when asking for a node with attr.cat==miau, I want 3 esults:</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.cat&#39;</span><span class="p">:</span> <span class="s1">&#39;miau&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.cat&#39;</span><span class="p">:</span> <span class="s1">&#39;miau&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># If I&#39;m asking for the specific lowest subclass, I want one result</span>
        <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">):</span>
            <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.cat&#39;</span><span class="p">:</span> <span class="s1">&#39;miau&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Now I am not allow the subclassing, which should give 1 result for each</span>
        <span class="k">for</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="p">((</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.cat&#39;</span><span class="p">:</span> <span class="s1">&#39;miau&#39;</span><span class="p">},</span> <span class="n">subclassing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">count</span><span class="p">)</span>

        <span class="c1"># Now I am testing the subclassing with tuples:</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">),</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.cat&#39;</span><span class="p">:</span> <span class="s1">&#39;miau&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">entity_type</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;data.structure.StructureData.&#39;</span><span class="p">,</span> <span class="s1">&#39;data.dict.Dict.&#39;</span><span class="p">),</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.cat&#39;</span><span class="p">:</span> <span class="s1">&#39;miau&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">=</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">),</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.cat&#39;</span><span class="p">:</span> <span class="s1">&#39;miau&#39;</span><span class="p">},</span> <span class="n">subclassing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">=</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">),</span>
            <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.cat&#39;</span><span class="p">:</span> <span class="s1">&#39;miau&#39;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">entity_type</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;data.structure.StructureData.&#39;</span><span class="p">,</span> <span class="s1">&#39;data.dict.Dict.&#39;</span><span class="p">),</span>
            <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.cat&#39;</span><span class="p">:</span> <span class="s1">&#39;miau&#39;</span><span class="p">},</span>
            <span class="n">subclassing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">entity_type</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;data.structure.StructureData.&#39;</span><span class="p">,</span> <span class="s1">&#39;data.Data.&#39;</span><span class="p">),</span>
            <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.cat&#39;</span><span class="p">:</span> <span class="s1">&#39;miau&#39;</span><span class="p">},</span>
            <span class="n">subclassing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestQueryBuilder.test_list_behavior"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestQueryBuilder.test_list_behavior">[docs]</a>    <span class="k">def</span> <span class="nf">test_list_behavior</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">dict</span><span class="p">()),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dict</span><span class="p">()),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dict</span><span class="p">()),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dict</span><span class="p">()),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">iterall</span><span class="p">())),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">iterall</span><span class="p">())),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">iterall</span><span class="p">())),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">iterall</span><span class="p">())),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">iterdict</span><span class="p">())),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">iterdict</span><span class="p">())),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">iterdict</span><span class="p">())),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">iterdict</span><span class="p">())),</span> <span class="mi">4</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestQueryBuilder.test_append_validation"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestQueryBuilder.test_append_validation">[docs]</a>    <span class="k">def</span> <span class="nf">test_append_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">InputValidationError</span>

        <span class="c1"># So here I am giving two times the same tag</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">InputValidationError</span><span class="p">):</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
        <span class="c1"># here I am giving a wrong filter specifications</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">InputValidationError</span><span class="p">):</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;jajjsd&#39;</span><span class="p">])</span>
        <span class="c1"># here I am giving a nonsensical projection:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">InputValidationError</span><span class="p">):</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># here I am giving a nonsensical projection for the edge:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">InputValidationError</span><span class="p">):</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">ProcessNode</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">,</span> <span class="n">edge_tag</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">add_projection</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Giving a nonsensical limit</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">InputValidationError</span><span class="p">):</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">ProcessNode</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mf">2.3</span><span class="p">)</span>
        <span class="c1"># Giving a nonsensical offset</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">InputValidationError</span><span class="p">):</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="mf">2.3</span><span class="p">)</span>

        <span class="c1"># So, I mess up one append, I want the QueryBuilder to clean it!</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">InputValidationError</span><span class="p">):</span>
            <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
            <span class="c1"># This also checks if we correctly raise for wrong keywords</span>
            <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">randomkeyword</span><span class="o">=</span><span class="p">{})</span>

        <span class="c1"># Now I&#39;m checking whether this keyword appears anywhere in the internal dictionaries:</span>
        <span class="c1"># pylint: disable=protected-access</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;s&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">_projections</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;s&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">_filters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;s&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">_tag_to_alias_map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">_cls_to_tag_map</span><span class="p">)</span>
        <span class="c1"># So this should work now:</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestQueryBuilder.test_tags"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestQueryBuilder.test_tags">[docs]</a>    <span class="k">def</span> <span class="nf">test_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;n1&#39;</span><span class="p">)</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;n2&#39;</span><span class="p">,</span> <span class="n">edge_tag</span><span class="o">=</span><span class="s1">&#39;e1&#39;</span><span class="p">,</span> <span class="n">with_incoming</span><span class="o">=</span><span class="s1">&#39;n1&#39;</span><span class="p">)</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;n3&#39;</span><span class="p">,</span> <span class="n">edge_tag</span><span class="o">=</span><span class="s1">&#39;e2&#39;</span><span class="p">,</span> <span class="n">with_incoming</span><span class="o">=</span><span class="s1">&#39;n2&#39;</span><span class="p">)</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="p">,</span> <span class="n">with_node</span><span class="o">=</span><span class="s1">&#39;n3&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="n">edge_tag</span><span class="o">=</span><span class="s1">&#39;nonsense&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">get_used_tags</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;n1&#39;</span><span class="p">,</span> <span class="s1">&#39;n2&#39;</span><span class="p">,</span> <span class="s1">&#39;e1&#39;</span><span class="p">,</span> <span class="s1">&#39;n3&#39;</span><span class="p">,</span> <span class="s1">&#39;e2&#39;</span><span class="p">,</span> <span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;nonsense&#39;</span><span class="p">])</span>

        <span class="c1"># Now I am testing the default tags,</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">ProcessNode</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">,</span> <span class="n">with_outgoing</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">ProcessNode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">get_used_tags</span><span class="p">(),</span> <span class="p">[</span>
            <span class="s1">&#39;StructureData_1&#39;</span><span class="p">,</span> <span class="s1">&#39;ProcessNode_1&#39;</span><span class="p">,</span> <span class="s1">&#39;StructureData_1--ProcessNode_1&#39;</span><span class="p">,</span> <span class="s1">&#39;StructureData_2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ProcessNode_1--StructureData_2&#39;</span><span class="p">,</span> <span class="s1">&#39;Dict_1&#39;</span><span class="p">,</span> <span class="s1">&#39;ProcessNode_1--Dict_1&#39;</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">qb</span><span class="o">.</span><span class="n">get_used_tags</span><span class="p">(</span><span class="n">edges</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="p">[</span>
                <span class="s1">&#39;StructureData_1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ProcessNode_1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;StructureData_2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Dict_1&#39;</span><span class="p">,</span>
            <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">qb</span><span class="o">.</span><span class="n">get_used_tags</span><span class="p">(</span><span class="n">vertices</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="p">[</span><span class="s1">&#39;StructureData_1--ProcessNode_1&#39;</span><span class="p">,</span> <span class="s1">&#39;ProcessNode_1--StructureData_2&#39;</span><span class="p">,</span> <span class="s1">&#39;ProcessNode_1--Dict_1&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">qb</span><span class="o">.</span><span class="n">get_used_tags</span><span class="p">(</span><span class="n">edges</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="p">[</span>
                <span class="s1">&#39;StructureData_1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ProcessNode_1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;StructureData_2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Dict_1&#39;</span><span class="p">,</span>
            <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">qb</span><span class="o">.</span><span class="n">get_used_tags</span><span class="p">(</span><span class="n">vertices</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="p">[</span><span class="s1">&#39;StructureData_1--ProcessNode_1&#39;</span><span class="p">,</span> <span class="s1">&#39;ProcessNode_1--StructureData_2&#39;</span><span class="p">,</span> <span class="s1">&#39;ProcessNode_1--Dict_1&#39;</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="TestQueryHelp"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestQueryHelp">[docs]</a><span class="k">class</span> <span class="nc">TestQueryHelp</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestQueryHelp.test_queryhelp"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestQueryHelp.test_queryhelp">[docs]</a>    <span class="k">def</span> <span class="nf">test_queryhelp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Here I test the queryhelp by seeing whether results are the same as using the append method.</span>
<span class="sd">        I also check passing of tuples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;helloworld&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;foo-qh2&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_nodes</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="k">for</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">expected_count</span><span class="p">,</span> <span class="n">subclassing</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">((</span><span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">((</span><span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">((</span><span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">((</span><span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">((</span><span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
            <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.foo-qh2&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">},</span> <span class="n">subclassing</span><span class="o">=</span><span class="n">subclassing</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">expected_count</span><span class="p">)</span>

            <span class="n">qh</span> <span class="o">=</span> <span class="n">qb</span><span class="o">.</span><span class="n">get_json_compatible_queryhelp</span><span class="p">()</span>
            <span class="n">qb_new</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">(</span><span class="o">**</span><span class="n">qh</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb_new</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">expected_count</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">uuid</span><span class="p">,</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()]),</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">uuid</span><span class="p">,</span> <span class="ow">in</span> <span class="n">qb_new</span><span class="o">.</span><span class="n">all</span><span class="p">()]))</span>

        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;helloworld&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">,),</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;helloworld&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestQueryBuilderCornerCases"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestQueryBuilderCornerCases">[docs]</a><span class="k">class</span> <span class="nc">TestQueryBuilderCornerCases</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In this class corner cases of QueryBuilder are added.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestQueryBuilderCornerCases.test_computer_json"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestQueryBuilderCornerCases.test_computer_json">[docs]</a>    <span class="k">def</span> <span class="nf">test_computer_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pylint: disable=no-self-use</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In this test we check the correct behavior of QueryBuilder when</span>
<span class="sd">        retrieving the _metadata and the transport_params with no content.</span>
<span class="sd">        Note that they are in JSON format in both backends. Forcing the</span>
<span class="sd">        decoding of a None value leads to an exception (this was the case</span>
<span class="sd">        under Django).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">n1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;node2&#39;</span>
        <span class="n">n1</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">n1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Checking the correct retrieval of transport_params which is</span>
        <span class="c1"># a JSON field (in both backends).</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;calc&#39;</span><span class="p">)</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;transport_params&#39;</span><span class="p">],</span> <span class="n">outerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_node</span><span class="o">=</span><span class="s1">&#39;calc&#39;</span><span class="p">)</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># Checking the correct retrieval of _metadata which is</span>
        <span class="c1"># a JSON field (in both backends).</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;calc&#39;</span><span class="p">)</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Computer</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;_metadata&#39;</span><span class="p">],</span> <span class="n">outerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_node</span><span class="o">=</span><span class="s1">&#39;calc&#39;</span><span class="p">)</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="TestAttributes"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestAttributes">[docs]</a><span class="k">class</span> <span class="nc">TestAttributes</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestAttributes.test_attribute_existence"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestAttributes.test_attribute_existence">[docs]</a>    <span class="k">def</span> <span class="nf">test_attribute_existence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># I&#39;m storing a value under key whatever:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">res_uuids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n1</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;whatever&quot;</span><span class="p">,</span> <span class="mf">3.</span><span class="p">)</span>
        <span class="n">n1</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;test_case&quot;</span><span class="p">,</span> <span class="s2">&quot;test_attribute_existence&quot;</span><span class="p">)</span>
        <span class="n">n1</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># I want all the nodes where whatever is smaller than 1. or there is no such value:</span>

        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;or&#39;</span><span class="p">:</span> <span class="p">[{</span>
                    <span class="s1">&#39;attributes&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;!has_key&#39;</span><span class="p">:</span> <span class="s1">&#39;whatever&#39;</span>
                    <span class="p">}</span>
                <span class="p">},</span> <span class="p">{</span>
                    <span class="s1">&#39;attributes.whatever&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="n">val</span>
                    <span class="p">}</span>
                <span class="p">}],</span>
            <span class="p">},</span>
            <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>
        <span class="n">res_query</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res_query</span><span class="p">,</span> <span class="n">res_uuids</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestAttributes.test_attribute_type"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestAttributes.test_attribute_type">[docs]</a>    <span class="k">def</span> <span class="nf">test_attribute_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;value_test_attr_type&#39;</span>
        <span class="n">n_int</span><span class="p">,</span> <span class="n">n_float</span><span class="p">,</span> <span class="n">n_str</span><span class="p">,</span> <span class="n">n_str2</span><span class="p">,</span> <span class="n">n_bool</span><span class="p">,</span> <span class="n">n_arr</span> <span class="o">=</span> <span class="p">[</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
        <span class="n">n_int</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">n_float</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">n_bool</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">n_str</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
        <span class="n">n_str2</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span><span class="p">)</span>
        <span class="n">n_arr</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="n">n_str2</span><span class="p">,</span> <span class="n">n_str</span><span class="p">,</span> <span class="n">n_int</span><span class="p">,</span> <span class="n">n_float</span><span class="p">,</span> <span class="n">n_bool</span><span class="p">,</span> <span class="n">n_arr</span><span class="p">):</span>
            <span class="n">n</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Here I am testing which values contain a number 1.</span>
        <span class="c1"># Both 1 and 1.0 are legitimate values if ask for either 1 or 1.0</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="n">val</span><span class="p">},</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="nb">set</span><span class="p">((</span><span class="n">n_float</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">n_int</span><span class="o">.</span><span class="n">uuid</span><span class="p">)))</span>
            <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="p">{</span><span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}},</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="nb">set</span><span class="p">((</span><span class="n">n_float</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">n_int</span><span class="o">.</span><span class="n">uuid</span><span class="p">)))</span>
            <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="p">{</span><span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">}},</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="nb">set</span><span class="p">((</span><span class="n">n_float</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">n_int</span><span class="o">.</span><span class="n">uuid</span><span class="p">)))</span>
        <span class="c1"># Now I am testing the boolean value:</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="kc">True</span><span class="p">},</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="nb">set</span><span class="p">((</span><span class="n">n_bool</span><span class="o">.</span><span class="n">uuid</span><span class="p">,)))</span>

        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="p">{</span><span class="s1">&#39;like&#39;</span><span class="p">:</span> <span class="s1">&#39;%n%&#39;</span><span class="p">}},</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="nb">set</span><span class="p">((</span><span class="n">n_str2</span><span class="o">.</span><span class="n">uuid</span><span class="p">,)))</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="p">{</span>
                                   <span class="s1">&#39;ilike&#39;</span><span class="p">:</span> <span class="s1">&#39;On%&#39;</span>
                               <span class="p">}},</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="nb">set</span><span class="p">((</span><span class="n">n_str2</span><span class="o">.</span><span class="n">uuid</span><span class="p">,)))</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="p">{</span><span class="s1">&#39;like&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">}},</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="nb">set</span><span class="p">((</span><span class="n">n_str</span><span class="o">.</span><span class="n">uuid</span><span class="p">,)))</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="p">{</span><span class="s1">&#39;==&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">}},</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="nb">set</span><span class="p">((</span><span class="n">n_str</span><span class="o">.</span><span class="n">uuid</span><span class="p">,)))</span>
        <span class="k">if</span> <span class="n">configuration</span><span class="o">.</span><span class="n">PROFILE</span><span class="o">.</span><span class="n">database_backend</span> <span class="o">==</span> <span class="sa">u</span><span class="s1">&#39;sqlalchemy&#39;</span><span class="p">:</span>
            <span class="c1"># I can&#39;t query the length of an array with Django,</span>
            <span class="c1"># so I exclude. Not the nicest way, But I would like to keep this piece</span>
            <span class="c1"># of code because of the initialization part, that would need to be</span>
            <span class="c1"># duplicated or wrapped otherwise.</span>
            <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="p">{</span>
                                       <span class="s1">&#39;of_length&#39;</span><span class="p">:</span> <span class="mi">3</span>
                                   <span class="p">}},</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="nb">set</span><span class="p">((</span><span class="n">n_arr</span><span class="o">.</span><span class="n">uuid</span><span class="p">,)))</span></div></div>


<div class="viewcode-block" id="QueryBuilderDateTimeAttribute"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.QueryBuilderDateTimeAttribute">[docs]</a><span class="k">class</span> <span class="nc">QueryBuilderDateTimeAttribute</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="QueryBuilderDateTimeAttribute.test_date"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.QueryBuilderDateTimeAttribute.test_date">[docs]</a>    <span class="nd">@unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">PROFILE</span><span class="o">.</span><span class="n">database_backend</span> <span class="o">==</span> <span class="sa">u</span><span class="s1">&#39;sqlalchemy&#39;</span><span class="p">,</span>
                     <span class="s2">&quot;SQLA doesn&#39;t have full datetime support in attributes&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">timezone</span>
        <span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">timedelta</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">n</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;now&#39;</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
        <span class="n">n</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;attributes.now&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;and&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="n">now</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="p">},</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="QueryBuilderLimitOffsetsTest"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.QueryBuilderLimitOffsetsTest">[docs]</a><span class="k">class</span> <span class="nc">QueryBuilderLimitOffsetsTest</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="QueryBuilderLimitOffsetsTest.test_ordering_limits_offsets_of_results_general"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.QueryBuilderLimitOffsetsTest.test_ordering_limits_offsets_of_results_general">[docs]</a>    <span class="k">def</span> <span class="nf">test_ordering_limits_offsets_of_results_general</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Creating 10 nodes with an attribute that can be ordered</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
            <span class="n">n</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">n</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;attributes.foo&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">({</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">:</span> <span class="s1">&#39;ctime&#39;</span><span class="p">})</span>

        <span class="n">res</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>

        <span class="c1"># Now applying an offset:</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)))</span>

        <span class="c1"># Now also applying a limit:</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">)))</span>

        <span class="c1"># Specifying the order  explicitly the order:</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;attributes.foo&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">({</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;ctime&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="s1">&#39;asc&#39;</span>
                <span class="p">}</span>
            <span class="p">}})</span>

        <span class="n">res</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>

        <span class="c1"># Now applying an offset:</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)))</span>

        <span class="c1"># Now also applying a limit:</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">)))</span>

        <span class="c1"># Reversing the order:</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;attributes.foo&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">({</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;ctime&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="s1">&#39;desc&#39;</span>
                <span class="p">}</span>
            <span class="p">}})</span>

        <span class="n">res</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>

        <span class="c1"># Now applying an offset:</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>

        <span class="c1"># Now also applying a limit:</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span></div></div>


<div class="viewcode-block" id="QueryBuilderJoinsTests"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.QueryBuilderJoinsTests">[docs]</a><span class="k">class</span> <span class="nc">QueryBuilderJoinsTests</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="QueryBuilderJoinsTests.test_joins1"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.QueryBuilderJoinsTests.test_joins1">[docs]</a>    <span class="k">def</span> <span class="nf">test_joins1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Creating n1, who will be a parent:</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;mother&#39;</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">good_child</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">good_child</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;good_child&#39;</span>
        <span class="n">good_child</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;is_good&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">bad_child</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">bad_child</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;bad_child&#39;</span>
        <span class="n">bad_child</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;is_good&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">unrelated</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">unrelated</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;unrelated&#39;</span>
        <span class="n">unrelated</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="n">good_child</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;parent&#39;</span><span class="p">)</span>
        <span class="n">bad_child</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;parent&#39;</span><span class="p">)</span>
        <span class="n">good_child</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">bad_child</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Using a standard inner join</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;parent&#39;</span><span class="p">)</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;children&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.is_good&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;parent&#39;</span><span class="p">)</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;children&#39;</span><span class="p">,</span> <span class="n">outerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attributes.is_good&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="QueryBuilderJoinsTests.test_joins2"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.QueryBuilderJoinsTests.test_joins2">[docs]</a>    <span class="k">def</span> <span class="nf">test_joins2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Creating n1, who will be a parent:</span>

        <span class="n">students</span> <span class="o">=</span> <span class="p">[</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
        <span class="n">advisors</span> <span class="o">=</span> <span class="p">[</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">advisors</span><span class="p">):</span>
            <span class="n">a</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;advisor </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;advisor_id&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">advisors</span> <span class="o">+</span> <span class="n">students</span><span class="p">:</span>
            <span class="n">n</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># advisor 0 get student 0, 1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">students</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">advisors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;is_advisor_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="c1"># advisor 1 get student 3, 4</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">students</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">advisors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;is_advisor_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="c1"># advisor 2 get student 5, 6, 7</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
            <span class="n">students</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">advisors</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;is_advisor_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="c1"># let&#39;s add a differnt relationship than advisor:</span>
        <span class="n">students</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">advisors</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;lover&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">edge_filters</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;like&#39;</span><span class="p">:</span> <span class="s1">&#39;is</span><span class="se">\\</span><span class="s1">_advisor</span><span class="se">\\</span><span class="s1">_%&#39;</span>
                    <span class="p">}</span>
                <span class="p">},</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;student&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">7</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">adv_id</span><span class="p">,</span> <span class="n">number_students</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;attributes.advisor_id&#39;</span><span class="p">:</span> <span class="n">adv_id</span>
                <span class="p">})</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">edge_filters</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;like&#39;</span><span class="p">:</span> <span class="s1">&#39;is</span><span class="se">\\</span><span class="s1">_advisor</span><span class="se">\\</span><span class="s1">_%&#39;</span>
                    <span class="p">}</span>
                <span class="p">},</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;student&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">number_students</span><span class="p">)</span></div>

<div class="viewcode-block" id="QueryBuilderJoinsTests.test_joins3_user_group"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.QueryBuilderJoinsTests.test_joins3_user_group">[docs]</a>    <span class="k">def</span> <span class="nf">test_joins3_user_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Create another user</span>
        <span class="n">new_email</span> <span class="o">=</span> <span class="s2">&quot;newuser@new.n&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">new_email</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Create a group that belongs to that user</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;node_group&quot;</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="n">group</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># Search for the group of the user</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;==&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">}})</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">with_user</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;==&#39;</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">id</span><span class="p">}})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;The expected group that belongs to &quot;</span> <span class="s2">&quot;the selected user was not found.&quot;</span><span class="p">)</span>

        <span class="c1"># Search for the user that owns a group</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;==&#39;</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">id</span><span class="p">}})</span>
        <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="n">with_group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;==&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">}})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;The expected user that owns the &quot;</span> <span class="s2">&quot;selected group was not found.&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="QueryBuilderPath"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.QueryBuilderPath">[docs]</a><span class="k">class</span> <span class="nc">QueryBuilderPath</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="QueryBuilderPath.test_query_path"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.QueryBuilderPath.test_query_path">[docs]</a>    <span class="k">def</span> <span class="nf">test_query_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># pylint: disable=too-many-statements</span>

        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">query_manager</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n1</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;n1&#39;</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">n2</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;n2&#39;</span>
        <span class="n">n3</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n3</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;n3&#39;</span>
        <span class="n">n4</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n4</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;n4&#39;</span>
        <span class="n">n5</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">n5</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;n5&#39;</span>
        <span class="n">n6</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n6</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;n6&#39;</span>
        <span class="n">n7</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span>
        <span class="n">n7</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;n7&#39;</span>
        <span class="n">n8</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n8</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;n8&#39;</span>
        <span class="n">n9</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
        <span class="n">n9</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;n9&#39;</span>

        <span class="c1"># I create a strange graph, inserting links in a order</span>
        <span class="c1"># such that I often have to create the transitive closure</span>
        <span class="c1"># between two graphs</span>
        <span class="n">n3</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link1&#39;</span><span class="p">)</span>
        <span class="n">n2</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link2&#39;</span><span class="p">)</span>
        <span class="n">n5</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n3</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link3&#39;</span><span class="p">)</span>
        <span class="n">n5</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n4</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link4&#39;</span><span class="p">)</span>
        <span class="n">n4</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link5&#39;</span><span class="p">)</span>
        <span class="n">n7</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n6</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">INPUT_CALC</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link6&#39;</span><span class="p">)</span>
        <span class="n">n8</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n7</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link7&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="p">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">n4</span><span class="p">,</span> <span class="n">n5</span><span class="p">,</span> <span class="n">n6</span><span class="p">,</span> <span class="n">n7</span><span class="p">,</span> <span class="n">n8</span><span class="p">,</span> <span class="n">n9</span><span class="p">]:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="c1"># There are no parents to n9, checking that</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">([]),</span> <span class="nb">set</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">get_all_parents</span><span class="p">([</span><span class="n">n9</span><span class="o">.</span><span class="n">pk</span><span class="p">])))</span>
        <span class="c1"># There is one parent to n6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({(</span><span class="n">_</span><span class="p">,)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">(</span><span class="n">n6</span><span class="o">.</span><span class="n">pk</span><span class="p">,)},</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">q</span><span class="o">.</span><span class="n">get_all_parents</span><span class="p">([</span><span class="n">n7</span><span class="o">.</span><span class="n">pk</span><span class="p">])})</span>
        <span class="c1"># There are several parents to n4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({(</span><span class="n">_</span><span class="o">.</span><span class="n">pk</span><span class="p">,)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">)},</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">q</span><span class="o">.</span><span class="n">get_all_parents</span><span class="p">([</span><span class="n">n4</span><span class="o">.</span><span class="n">pk</span><span class="p">])})</span>
        <span class="c1"># There are several parents to n5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({(</span><span class="n">_</span><span class="o">.</span><span class="n">pk</span><span class="p">,)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">n4</span><span class="p">)},</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">q</span><span class="o">.</span><span class="n">get_all_parents</span><span class="p">([</span><span class="n">n5</span><span class="o">.</span><span class="n">pk</span><span class="p">])})</span>

        <span class="c1"># Yet, no links from 1 to 8</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">n1</span><span class="o">.</span><span class="n">pk</span>
            <span class="p">},</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;anc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">with_ancestors</span><span class="o">=</span><span class="s1">&#39;anc&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">n8</span><span class="o">.</span><span class="n">pk</span>
            <span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">n8</span><span class="o">.</span><span class="n">pk</span>
            <span class="p">},</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;desc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">with_descendants</span><span class="o">=</span><span class="s1">&#39;desc&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">n1</span><span class="o">.</span><span class="n">pk</span>
            <span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">n6</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">n5</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link1&#39;</span><span class="p">)</span>
        <span class="c1"># Yet, now 2 links from 1 to 8</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">n1</span><span class="o">.</span><span class="n">pk</span>
            <span class="p">},</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;anc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">with_ancestors</span><span class="o">=</span><span class="s1">&#39;anc&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">n8</span><span class="o">.</span><span class="n">pk</span>
            <span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">n8</span><span class="o">.</span><span class="n">pk</span>
            <span class="p">},</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;desc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">with_descendants</span><span class="o">=</span><span class="s1">&#39;desc&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">n1</span><span class="o">.</span><span class="n">pk</span>
            <span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">n8</span><span class="o">.</span><span class="n">pk</span>
            <span class="p">},</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;desc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span>
                <span class="n">with_descendants</span><span class="o">=</span><span class="s1">&#39;desc&#39;</span><span class="p">,</span>
                <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">n1</span><span class="o">.</span><span class="n">pk</span>
                <span class="p">},</span>
                <span class="n">edge_filters</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="mi">6</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">n8</span><span class="o">.</span><span class="n">pk</span>
            <span class="p">},</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;desc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span>
                <span class="n">with_descendants</span><span class="o">=</span><span class="s1">&#39;desc&#39;</span><span class="p">,</span>
                <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">n1</span><span class="o">.</span><span class="n">pk</span>
                <span class="p">},</span>
                <span class="n">edge_filters</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">5</span>
                <span class="p">},</span>
            <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">n8</span><span class="o">.</span><span class="n">pk</span>
            <span class="p">},</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;desc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span>
                <span class="n">with_descendants</span><span class="o">=</span><span class="s1">&#39;desc&#39;</span><span class="p">,</span>
                <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">n1</span><span class="o">.</span><span class="n">pk</span>
                <span class="p">},</span>
                <span class="n">edge_filters</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="mi">5</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># TODO write a query that can filter certain paths by traversed ID # pylint: disable=fixme</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">n8</span><span class="o">.</span><span class="n">pk</span>
            <span class="p">},</span>
            <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;desc&#39;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">with_descendants</span><span class="o">=</span><span class="s1">&#39;desc&#39;</span><span class="p">,</span> <span class="n">edge_project</span><span class="o">=</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">n1</span><span class="o">.</span><span class="n">pk</span><span class="p">})</span>
        <span class="n">queried_path_set</span> <span class="o">=</span> <span class="p">{</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()}</span>

        <span class="n">paths_there_should_be</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nb">frozenset</span><span class="p">([</span><span class="n">n1</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n2</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n3</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n5</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n6</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n7</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n8</span><span class="o">.</span><span class="n">pk</span><span class="p">]),</span>
            <span class="nb">frozenset</span><span class="p">([</span><span class="n">n1</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n2</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n4</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n5</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n6</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n7</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n8</span><span class="o">.</span><span class="n">pk</span><span class="p">])</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">queried_path_set</span> <span class="o">==</span> <span class="n">paths_there_should_be</span><span class="p">)</span>

        <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">n1</span><span class="o">.</span><span class="n">pk</span>
            <span class="p">},</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;anc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">with_ancestors</span><span class="o">=</span><span class="s1">&#39;anc&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">n8</span><span class="o">.</span><span class="n">pk</span><span class="p">},</span> <span class="n">edge_project</span><span class="o">=</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="ow">in</span> <span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()},</span> <span class="p">{</span>
            <span class="nb">frozenset</span><span class="p">([</span><span class="n">n1</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n2</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n3</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n5</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n6</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n7</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n8</span><span class="o">.</span><span class="n">pk</span><span class="p">]),</span>
            <span class="nb">frozenset</span><span class="p">([</span><span class="n">n1</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n2</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n4</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n5</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n6</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n7</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">n8</span><span class="o">.</span><span class="n">pk</span><span class="p">])</span>
        <span class="p">})</span></div></div>

        <span class="c1"># This part of the test is no longer possible as the nodes have already been stored and the previous parts of</span>
        <span class="c1"># the test rely on this, which means however, that here, no more links can be added as that will raise.</span>

        <span class="c1"># n7.add_incoming(n9, link_type=LinkType.INPUT_CALC, link_label=&#39;link0&#39;)</span>
        <span class="c1"># # Still two links...</span>

        <span class="c1"># self.assertEqual(</span>
        <span class="c1">#     orm.QueryBuilder().append(orm.Node, filters={</span>
        <span class="c1">#         &#39;id&#39;: n1.pk</span>
        <span class="c1">#     }, tag=&#39;anc&#39;).append(orm.Node, with_ancestors=&#39;anc&#39;, filters={</span>
        <span class="c1">#         &#39;id&#39;: n8.pk</span>
        <span class="c1">#     }).count(), 2)</span>

        <span class="c1"># self.assertEqual(</span>
        <span class="c1">#     orm.QueryBuilder().append(orm.Node, filters={</span>
        <span class="c1">#         &#39;id&#39;: n8.pk</span>
        <span class="c1">#     }, tag=&#39;desc&#39;).append(orm.Node, with_descendants=&#39;desc&#39;, filters={</span>
        <span class="c1">#         &#39;id&#39;: n1.pk</span>
        <span class="c1">#     }).count(), 2)</span>
        <span class="c1"># n9.add_incoming(n5, link_type=LinkType.CREATE, link_label=&#39;link6&#39;)</span>
        <span class="c1"># # And now there should be 4 nodes</span>

        <span class="c1"># self.assertEqual(</span>
        <span class="c1">#     orm.QueryBuilder().append(orm.Node, filters={</span>
        <span class="c1">#         &#39;id&#39;: n1.pk</span>
        <span class="c1">#     }, tag=&#39;anc&#39;).append(orm.Node, with_ancestors=&#39;anc&#39;, filters={</span>
        <span class="c1">#         &#39;id&#39;: n8.pk</span>
        <span class="c1">#     }).count(), 4)</span>

        <span class="c1"># self.assertEqual(</span>
        <span class="c1">#     orm.QueryBuilder().append(orm.Node, filters={</span>
        <span class="c1">#         &#39;id&#39;: n8.pk</span>
        <span class="c1">#     }, tag=&#39;desc&#39;).append(orm.Node, with_descendants=&#39;desc&#39;, filters={</span>
        <span class="c1">#         &#39;id&#39;: n1.pk</span>
        <span class="c1">#     }).count(), 4)</span>

        <span class="c1"># qb = orm.QueryBuilder().append(</span>
        <span class="c1">#     orm.Node, filters={</span>
        <span class="c1">#         &#39;id&#39;: n1.pk</span>
        <span class="c1">#     }, tag=&#39;anc&#39;).append(</span>
        <span class="c1">#         orm.Node, with_ancestors=&#39;anc&#39;, filters={&#39;id&#39;: n8.pk}, edge_tag=&#39;edge&#39;)</span>
        <span class="c1"># qb.add_projection(&#39;edge&#39;, &#39;depth&#39;)</span>
        <span class="c1"># self.assertTrue(set(next(zip(*qb.all()))), set([5, 6]))</span>
        <span class="c1"># qb.add_filter(&#39;edge&#39;, {&#39;depth&#39;: 5})</span>
        <span class="c1"># self.assertTrue(set(next(zip(*qb.all()))), set([5]))</span>


<div class="viewcode-block" id="TestConsistency"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestConsistency">[docs]</a><span class="k">class</span> <span class="nc">TestConsistency</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestConsistency.test_create_node_and_query"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestConsistency.test_create_node_and_query">[docs]</a>    <span class="k">def</span> <span class="nf">test_create_node_and_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Testing whether creating nodes within a iterall iteration changes the results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
            <span class="n">n</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">_item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span>
                                                                                 <span class="s1">&#39;label&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">iterall</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
                <span class="n">n</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span>  <span class="c1"># pylint: disable=undefined-loop-variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">99</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestConsistency.test_len_results"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestConsistency.test_len_results">[docs]</a>    <span class="k">def</span> <span class="nf">test_len_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test whether the len of results matches the count returned.</span>
<span class="sd">        See also https://github.com/aiidateam/aiida_core/issues/1600</span>
<span class="sd">        SQLAlchemy has a deduplication strategy that leads to strange behavior, tested against here</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="c1"># adding 5 links going out:</span>
        <span class="k">for</span> <span class="n">inode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">output_node</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
            <span class="n">output_node</span><span class="o">.</span><span class="n">add_incoming</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">link_type</span><span class="o">=</span><span class="n">LinkType</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">link_label</span><span class="o">=</span><span class="s1">&#39;link_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">projection</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
            <span class="n">qb</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">QueryBuilder</span><span class="p">()</span>
            <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">},</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;parent&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span>
            <span class="n">qb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span> <span class="n">with_incoming</span><span class="o">=</span><span class="s1">&#39;parent&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qb</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="n">qb</span><span class="o">.</span><span class="n">count</span><span class="p">())</span></div></div>


<div class="viewcode-block" id="TestManager"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestManager">[docs]</a><span class="k">class</span> <span class="nc">TestManager</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestManager.test_statistics"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestManager.test_statistics">[docs]</a>    <span class="k">def</span> <span class="nf">test_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test if the statistics query works properly.</span>

<span class="sd">        I try to implement it in a way that does not depend on the past state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>

        <span class="c1"># pylint: disable=protected-access</span>

        <span class="k">def</span> <span class="nf">store_and_add</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">statistics</span><span class="p">):</span>
            <span class="n">n</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
            <span class="n">statistics</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">statistics</span><span class="p">[</span><span class="s1">&#39;types&#39;</span><span class="p">][</span><span class="n">n</span><span class="o">.</span><span class="n">_plugin_type_string</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># pylint: disable=no-member</span>
            <span class="n">statistics</span><span class="p">[</span><span class="s1">&#39;ctime_by_day&#39;</span><span class="p">][</span><span class="n">n</span><span class="o">.</span><span class="n">ctime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">qmanager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">query_manager</span>
        <span class="n">current_db_statistics</span> <span class="o">=</span> <span class="n">qmanager</span><span class="o">.</span><span class="n">get_creation_statistics</span><span class="p">()</span>
        <span class="n">types</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">types</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">current_db_statistics</span><span class="p">[</span><span class="s1">&#39;types&#39;</span><span class="p">])</span>
        <span class="n">ctime_by_day</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ctime_by_day</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">current_db_statistics</span><span class="p">[</span><span class="s1">&#39;ctime_by_day&#39;</span><span class="p">])</span>

        <span class="n">expected_db_statistics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">current_db_statistics</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">],</span> <span class="s1">&#39;types&#39;</span><span class="p">:</span> <span class="n">types</span><span class="p">,</span> <span class="s1">&#39;ctime_by_day&#39;</span><span class="p">:</span> <span class="n">ctime_by_day</span><span class="p">}</span>

        <span class="n">store_and_add</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">(),</span> <span class="n">expected_db_statistics</span><span class="p">)</span>
        <span class="n">store_and_add</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">(),</span> <span class="n">expected_db_statistics</span><span class="p">)</span>
        <span class="n">store_and_add</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">(),</span> <span class="n">expected_db_statistics</span><span class="p">)</span>
        <span class="n">store_and_add</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">(),</span> <span class="n">expected_db_statistics</span><span class="p">)</span>

        <span class="n">new_db_statistics</span> <span class="o">=</span> <span class="n">qmanager</span><span class="o">.</span><span class="n">get_creation_statistics</span><span class="p">()</span>
        <span class="c1"># I only check a few fields</span>
        <span class="n">new_db_statistics</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">new_db_statistics</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">expected_db_statistics</span><span class="p">}</span>

        <span class="n">expected_db_statistics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">defaultdict</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">expected_db_statistics</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_db_statistics</span><span class="p">,</span> <span class="n">expected_db_statistics</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestManager.test_statistics_default_class"><a class="viewcode-back" href="../../../../apidoc/aiida.backends.tests.html#aiida.backends.tests.test_query.TestManager.test_statistics_default_class">[docs]</a>    <span class="k">def</span> <span class="nf">test_statistics_default_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test if the statistics query works properly.</span>

<span class="sd">        I try to implement it in a way that does not depend on the past state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>

        <span class="k">def</span> <span class="nf">store_and_add</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">statistics</span><span class="p">):</span>
            <span class="n">n</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
            <span class="n">statistics</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">statistics</span><span class="p">[</span><span class="s1">&#39;types&#39;</span><span class="p">][</span><span class="n">n</span><span class="o">.</span><span class="n">_plugin_type_string</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># pylint: disable=no-member,protected-access</span>
            <span class="n">statistics</span><span class="p">[</span><span class="s1">&#39;ctime_by_day&#39;</span><span class="p">][</span><span class="n">n</span><span class="o">.</span><span class="n">ctime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">current_db_statistics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">query_manager</span><span class="o">.</span><span class="n">get_creation_statistics</span><span class="p">()</span>
        <span class="n">types</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">types</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">current_db_statistics</span><span class="p">[</span><span class="s1">&#39;types&#39;</span><span class="p">])</span>
        <span class="n">ctime_by_day</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ctime_by_day</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">current_db_statistics</span><span class="p">[</span><span class="s1">&#39;ctime_by_day&#39;</span><span class="p">])</span>

        <span class="n">expected_db_statistics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">current_db_statistics</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">],</span> <span class="s1">&#39;types&#39;</span><span class="p">:</span> <span class="n">types</span><span class="p">,</span> <span class="s1">&#39;ctime_by_day&#39;</span><span class="p">:</span> <span class="n">ctime_by_day</span><span class="p">}</span>

        <span class="n">store_and_add</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Data</span><span class="p">(),</span> <span class="n">expected_db_statistics</span><span class="p">)</span>
        <span class="n">store_and_add</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">(),</span> <span class="n">expected_db_statistics</span><span class="p">)</span>
        <span class="n">store_and_add</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">(),</span> <span class="n">expected_db_statistics</span><span class="p">)</span>
        <span class="n">store_and_add</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">CalculationNode</span><span class="p">(),</span> <span class="n">expected_db_statistics</span><span class="p">)</span>

        <span class="n">new_db_statistics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">query_manager</span><span class="o">.</span><span class="n">get_creation_statistics</span><span class="p">()</span>
        <span class="c1"># I only check a few fields</span>
        <span class="n">new_db_statistics</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">new_db_statistics</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">expected_db_statistics</span><span class="p">}</span>

        <span class="n">expected_db_statistics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">defaultdict</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">expected_db_statistics</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_db_statistics</span><span class="p">,</span> <span class="n">expected_db_statistics</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>