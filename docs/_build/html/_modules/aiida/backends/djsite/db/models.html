

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.backends.djsite.db.models &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.backends.djsite.db.models</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.backends.djsite.db.models</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="nb">zip</span><span class="p">,</span> <span class="nb">range</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">models</span> <span class="k">as</span> <span class="n">m</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">AbstractBaseUser</span><span class="p">,</span> <span class="n">BaseUserManager</span><span class="p">,</span> <span class="n">PermissionsMixin</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">django.contrib.postgres.fields</span> <span class="k">import</span> <span class="n">JSONField</span>
<span class="kn">from</span> <span class="nn">django.utils.encoding</span> <span class="k">import</span> <span class="n">python_2_unicode_compatible</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="k">import</span> <span class="n">ObjectDoesNotExist</span>
<span class="kn">from</span> <span class="nn">django.db.models.query</span> <span class="k">import</span> <span class="n">QuerySet</span>

<span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">aiida.common.utils</span> <span class="k">import</span> <span class="n">get_new_uuid</span>
<span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="n">DbContentError</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">aiida.backends.djsite.settings</span> <span class="k">import</span> <span class="n">AUTH_USER_MODEL</span>
<span class="kn">import</span> <span class="nn">aiida.backends.djsite.db.migrations</span> <span class="k">as</span> <span class="nn">migrations</span>
<span class="kn">from</span> <span class="nn">aiida.backends.utils</span> <span class="k">import</span> <span class="n">AIIDA_ATTRIBUTE_SEP</span>

<span class="c1"># This variable identifies the schema version of this file.</span>
<span class="c1"># Every time you change the schema below in *ANY* way, REMEMBER TO CHANGE</span>
<span class="c1"># the version here in the migration file and update migrations/__init__.py.</span>
<span class="c1"># See the documentation for how to do all this.</span>
<span class="c1">#</span>
<span class="c1"># The version is checked at code load time to verify that the code schema</span>
<span class="c1"># version and the DB schema version are the same. (The DB schema version</span>
<span class="c1"># is stored in the DbSetting table and the check is done in the</span>
<span class="c1"># load_dbenv() function).</span>
<span class="n">SCHEMA_VERSION</span> <span class="o">=</span> <span class="n">migrations</span><span class="o">.</span><span class="n">current_schema_version</span><span class="p">()</span>


<div class="viewcode-block" id="AiidaQuerySet"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.AiidaQuerySet">[docs]</a><span class="k">class</span> <span class="nc">AiidaQuerySet</span><span class="p">(</span><span class="n">QuerySet</span><span class="p">):</span>
<div class="viewcode-block" id="AiidaQuerySet.iterator"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.AiidaQuerySet.iterator">[docs]</a>    <span class="k">def</span> <span class="nf">iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">aiida.orm.implementation.django</span> <span class="k">import</span> <span class="n">convert</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">AiidaQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">iterator</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">convert</span><span class="o">.</span><span class="n">get_backend_entity</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="AiidaQuerySet.__iter__"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.AiidaQuerySet.__iter__">[docs]</a>    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate for list comprehensions.</span>

<span class="sd">        Note: used to rely on the iterator in django 1.8 but does no longer in django 1.11.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.orm.implementation.django</span> <span class="k">import</span> <span class="n">convert</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">convert</span><span class="o">.</span><span class="n">get_backend_entity</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">AiidaQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">())</span></div>

<div class="viewcode-block" id="AiidaQuerySet.__getitem__"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.AiidaQuerySet.__getitem__">[docs]</a>    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get item for [] operator</span>

<span class="sd">        Note: used to rely on the iterator in django 1.8 but does no longer in django 1.11.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.orm.implementation.django</span> <span class="k">import</span> <span class="n">convert</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">AiidaQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">convert</span><span class="o">.</span><span class="n">get_backend_entity</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="AiidaObjectManager"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.AiidaObjectManager">[docs]</a><span class="k">class</span> <span class="nc">AiidaObjectManager</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Manager</span><span class="p">):</span>
<div class="viewcode-block" id="AiidaObjectManager.get_queryset"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.AiidaObjectManager.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">AiidaQuerySet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DbUserManager"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbUserManager">[docs]</a><span class="k">class</span> <span class="nc">DbUserManager</span><span class="p">(</span><span class="n">BaseUserManager</span><span class="p">):</span>
<div class="viewcode-block" id="DbUserManager.create_user"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbUserManager.create_user">[docs]</a>    <span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_fields</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates and saves a User with the given email (that is the</span>
<span class="sd">        username) and password.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The given email must be set&#39;</span><span class="p">)</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">BaseUserManager</span><span class="o">.</span><span class="n">normalize_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
                          <span class="n">is_staff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_superuser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">last_login</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">date_joined</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_fields</span><span class="p">)</span>

        <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span></div>

<div class="viewcode-block" id="DbUserManager.create_superuser"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbUserManager.create_superuser">[docs]</a>    <span class="k">def</span> <span class="nf">create_superuser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_fields</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_fields</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">u</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">u</span><span class="o">.</span><span class="n">is_superuser</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">u</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">u</span></div></div>


<div class="viewcode-block" id="DbUser"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbUser">[docs]</a><span class="k">class</span> <span class="nc">DbUser</span><span class="p">(</span><span class="n">AbstractBaseUser</span><span class="p">,</span> <span class="n">PermissionsMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class replaces the default User class of Django</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set unique email field</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">254</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">254</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">institution</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">254</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">is_staff</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Designates whether the user can log into this admin &#39;</span>
                                        <span class="s1">&#39;site.&#39;</span><span class="p">)</span>
    <span class="n">is_active</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Designates whether this user should be treated as &#39;</span>
                                         <span class="s1">&#39;active. Unselect this instead of deleting accounts.&#39;</span><span class="p">)</span>
    <span class="n">date_joined</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>

    <span class="n">USERNAME_FIELD</span> <span class="o">=</span> <span class="s1">&#39;email&#39;</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">DbUserManager</span><span class="p">()</span></div>


<div class="viewcode-block" id="DbNode"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbNode">[docs]</a><span class="nd">@python_2_unicode_compatible</span>
<span class="k">class</span> <span class="nc">DbNode</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generic node: data or calculation or code.</span>

<span class="sd">    Nodes can be linked (DbLink table)</span>
<span class="sd">    Naming convention for Node relationships: A --&gt; C --&gt; B.</span>

<span class="sd">    * A is &#39;input&#39; of C.</span>
<span class="sd">    * C is &#39;output&#39; of A.</span>

<span class="sd">    Internal attributes, that define the node itself,</span>
<span class="sd">    are stored in the DbAttribute table; further user-defined attributes,</span>
<span class="sd">    called &#39;extra&#39;, are stored in the DbExtra table (same schema and methods</span>
<span class="sd">    of the DbAttribute table, but the code does not rely on the content of the</span>
<span class="sd">    table, therefore the user can use it at his will to tag or annotate nodes.</span>

<span class="sd">    :note: Attributes in the DbAttribute table have to be thought as belonging</span>
<span class="sd">       to the DbNode, (this is the reason for which there is no &#39;user&#39; field</span>
<span class="sd">       in the DbAttribute field). Moreover, Attributes define uniquely the</span>
<span class="sd">       Node so should be immutable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">uuid</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">UUIDField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">get_new_uuid</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># in the form data.upffile., data.structure., calculation., ...</span>
    <span class="c1"># Note that there is always a final dot, to allow to do queries of the</span>
    <span class="c1"># type (node_type__startswith=&quot;calculation.&quot;) and avoid problems with classes</span>
    <span class="c1"># starting with the same string</span>
    <span class="c1"># max_length required for index by MySql</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">process_type</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># creation time</span>
    <span class="n">ctime</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">mtime</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># Cannot delete a user if something is associated to it</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span>
                        <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;dbnodes&#39;</span><span class="p">)</span>

    <span class="c1"># Direct links</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="n">symmetrical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;inputs&#39;</span><span class="p">,</span> <span class="n">through</span><span class="o">=</span><span class="s1">&#39;DbLink&#39;</span><span class="p">)</span>

    <span class="c1"># Used only if dbnode is a calculation, or remotedata</span>
    <span class="c1"># Avoid that computers can be deleted if at least a node exists pointing</span>
    <span class="c1"># to it.</span>
    <span class="n">dbcomputer</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;DbComputer&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span>
                              <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;dbnodes&#39;</span><span class="p">)</span>

    <span class="c1"># Index that is incremented every time a modification is done on itself or on attributes.</span>
    <span class="c1"># Managed by the aiida.orm.Node class. Do not modify</span>
    <span class="n">nodeversion</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># For the API: whether this node</span>
    <span class="n">public</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
    <span class="c1"># Return aiida Node instances or their subclasses instead of DbNode instances</span>
    <span class="n">aiidaobjects</span> <span class="o">=</span> <span class="n">AiidaObjectManager</span><span class="p">()</span>

<div class="viewcode-block" id="DbNode.get_simple_name"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbNode.get_simple_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_simple_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invalid_result</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string with the last part of the type name.</span>

<span class="sd">        If the type is empty, use &#39;Node&#39;.</span>
<span class="sd">        If the type is invalid, return the content of the input variable</span>
<span class="sd">        ``invalid_result``.</span>

<span class="sd">        :param invalid_result: The value to be returned if the node type is</span>
<span class="sd">            not recognized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">thistype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span>
        <span class="c1"># Fix for base class</span>
        <span class="k">if</span> <span class="n">thistype</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">thistype</span> <span class="o">=</span> <span class="s2">&quot;node.Node.&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">thistype</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">invalid_result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thistype</span> <span class="o">=</span> <span class="n">thistype</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Strip final dot</span>
            <span class="k">return</span> <span class="n">thistype</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return all attributes of the given node as a single dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DbAttribute</span><span class="o">.</span><span class="n">get_all_values_for_node</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">extras</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return all extras of the given node as a single dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DbExtra</span><span class="o">.</span><span class="n">get_all_values_for_node</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="DbNode.__str__"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbNode.__str__">[docs]</a>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">simplename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_simple_name</span><span class="p">(</span><span class="n">invalid_result</span><span class="o">=</span><span class="s2">&quot;Unknown&quot;</span><span class="p">)</span>
        <span class="c1"># node pk + type</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> node [</span><span class="si">{}</span><span class="s2">]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">simplename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> node [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">simplename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DbLink"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbLink">[docs]</a><span class="nd">@python_2_unicode_compatible</span>
<span class="k">class</span> <span class="nc">DbLink</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Direct connection between two dbnodes. The label is identifying thelink type.&quot;&quot;&quot;</span>

    <span class="c1"># If I delete an output, delete also the link; if I delete an input, stop</span>
    <span class="c1"># NOTE: this will in most cases render a DbNode.objects.filter(...).delete()</span>
    <span class="c1"># call unusable because some nodes will be inputs; Nodes will have to</span>
    <span class="c1">#    be deleted in the proper order (or links will need to be deleted first)</span>
    <span class="c1"># The `input` and `output` columns do not need an explicit `db_index` as it is `True` by default for foreign keys</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;DbNode&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;output_links&#39;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;DbNode&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;input_links&#39;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="DbLink.__str__"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbLink.__str__">[docs]</a>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">) --&gt; </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">get_simple_name</span><span class="p">(</span><span class="n">invalid_result</span><span class="o">=</span><span class="s2">&quot;Unknown node&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">get_simple_name</span><span class="p">(</span><span class="n">invalid_result</span><span class="o">=</span><span class="s2">&quot;Unknown node&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="p">)</span></div></div>


<span class="n">attrdatatype_choice</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;txt&#39;</span><span class="p">,</span> <span class="s1">&#39;txt&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;dict&#39;</span><span class="p">,</span> <span class="s1">&#39;dict&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">AiidaException</span>


<div class="viewcode-block" id="DeserializationException"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DeserializationException">[docs]</a><span class="k">class</span> <span class="nc">DeserializationException</span><span class="p">(</span><span class="n">AiidaException</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="_deserialize_attribute"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models._deserialize_attribute">[docs]</a><span class="k">def</span> <span class="nf">_deserialize_attribute</span><span class="p">(</span><span class="n">mainitem</span><span class="p">,</span> <span class="n">subitems</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">original_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">original_pk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lesserrors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deserialize a single attribute.</span>

<span class="sd">    :param mainitem: the main item (either the attribute itself for base</span>
<span class="sd">      types (None, string, ...) or the main item for lists and dicts.</span>
<span class="sd">      Must contain the &#39;key&#39; key and also the following keys:</span>
<span class="sd">      datatype, tval, fval, ival, bval, dval.</span>
<span class="sd">      NOTE that a type check is not performed! tval is expected to be a string,</span>
<span class="sd">      dval a date, etc.</span>
<span class="sd">    :param subitems: must be a dictionary of dictionaries. In the top-level dictionary,</span>
<span class="sd">      the key must be the key of the attribute, stripped of all prefixes</span>
<span class="sd">      (i.e., if the mainitem has key &#39;a.b&#39; and we pass subitems</span>
<span class="sd">      &#39;a.b.0&#39;, &#39;a.b.1&#39;, &#39;a.b.1.c&#39;, their keys must be &#39;0&#39;, &#39;1&#39;, &#39;1.c&#39;).</span>
<span class="sd">      It must be None if the value is not iterable (int, str,</span>
<span class="sd">      float, ...).</span>
<span class="sd">      It is an empty dictionary if there are no subitems.</span>
<span class="sd">    :param sep: a string, the separator between subfields (to separate the</span>
<span class="sd">      name of a dictionary from the keys it contains, for instance)</span>
<span class="sd">    :param original_class: if these elements come from a specific subclass</span>
<span class="sd">      of DbMultipleValueAttributeBaseClass, pass here the class (note: the class,</span>
<span class="sd">      not the instance!). This is used only in case the wrong number of elements</span>
<span class="sd">      is found in the raw data, to print a more meaningful message (if the class</span>
<span class="sd">      has a dbnode associated to it)</span>
<span class="sd">    :param original_pk: if the elements come from a specific subclass</span>
<span class="sd">      of DbMultipleValueAttributeBaseClass that has a dbnode associated to it,</span>
<span class="sd">      pass here the PK integer. This is used only in case the wrong number</span>
<span class="sd">      of elements is found in the raw data, to print a more meaningful message</span>
<span class="sd">    :param lesserrors: If set to True, in some cases where the content of the</span>
<span class="sd">      DB is not consistent but data is still recoverable,</span>
<span class="sd">      it will just log the message rather than raising</span>
<span class="sd">      an exception (e.g. if the number of elements of a dictionary is different</span>
<span class="sd">      from the number declared in the ival field).</span>

<span class="sd">    :return: the deserialized value</span>
<span class="sd">    :raise aiida.backends.djsite.db.models.DeserializationException: if an error occurs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">json</span>
    <span class="kn">from</span> <span class="nn">aiida.common.timezone</span> <span class="k">import</span> <span class="p">(</span>
        <span class="n">is_naive</span><span class="p">,</span> <span class="n">make_aware</span><span class="p">,</span> <span class="n">get_current_timezone</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">AIIDA_LOGGER</span>

    <span class="k">if</span> <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">subitems</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DeserializationException</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; is of a base type, &quot;</span>
                                           <span class="s2">&quot;but has subitems!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mainitem</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bool&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">subitems</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DeserializationException</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; is of a base type, &quot;</span>
                                           <span class="s2">&quot;but has subitems!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mainitem</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;bval&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;int&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">subitems</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DeserializationException</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; is of a base type, &quot;</span>
                                           <span class="s2">&quot;but has subitems!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mainitem</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;ival&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;float&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">subitems</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DeserializationException</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; is of a base type, &quot;</span>
                                           <span class="s2">&quot;but has subitems!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mainitem</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;fval&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;txt&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">subitems</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DeserializationException</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; is of a base type, &quot;</span>
                                           <span class="s2">&quot;but has subitems!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mainitem</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;tval&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;date&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">subitems</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DeserializationException</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; is of a base type, &quot;</span>
                                           <span class="s2">&quot;but has subitems!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mainitem</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">is_naive</span><span class="p">(</span><span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;dval&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">make_aware</span><span class="p">(</span><span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;dval&#39;</span><span class="p">],</span> <span class="n">get_current_timezone</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;dval&#39;</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;list&#39;</span><span class="p">:</span>
        <span class="c1"># subitems contains all subitems, here I store only those of</span>
        <span class="c1"># deepness 1, i.e. if I have subitems &#39;0&#39;, &#39;1&#39; and &#39;1.c&#39; I</span>
        <span class="c1"># store only &#39;0&#39; and &#39;1&#39;</span>
        <span class="n">firstlevelsubdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">subitems</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                             <span class="k">if</span> <span class="n">sep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">}</span>

        <span class="c1"># For checking, I verify the expected values</span>
        <span class="n">expected_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;ival&#39;</span><span class="p">])])</span>
        <span class="n">received_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">firstlevelsubdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="c1"># If there are more entries than expected, but all expected</span>
        <span class="c1"># ones are there, I just issue an error but I do not stop.</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">expected_set</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">received_set</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">original_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">original_class</span><span class="o">.</span><span class="n">_subspecifier_field_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">subspecifier_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">=</span><span class="si">{}</span><span class="s2"> and &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">original_class</span><span class="o">.</span><span class="n">_subspecifier_field_name</span><span class="p">,</span>
                    <span class="n">original_pk</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subspecifier_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">original_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sourcestr</span> <span class="o">=</span> <span class="s2">&quot;the data passed&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sourcestr</span> <span class="o">=</span> <span class="n">original_class</span><span class="o">.</span><span class="vm">__name__</span>

            <span class="k">raise</span> <span class="n">DeserializationException</span><span class="p">(</span><span class="s2">&quot;Wrong list elements stored in </span><span class="si">{}</span><span class="s2"> for &quot;</span>
                                           <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">key=&#39;</span><span class="si">{}</span><span class="s2">&#39; (</span><span class="si">{}</span><span class="s2"> vs </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">sourcestr</span><span class="p">,</span>
                <span class="n">subspecifier_string</span><span class="p">,</span>
                <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span> <span class="n">expected_set</span><span class="p">,</span> <span class="n">received_set</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">expected_set</span> <span class="o">!=</span> <span class="n">received_set</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">original_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                    <span class="n">original_class</span><span class="o">.</span><span class="n">_subspecifier_field_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">subspecifier_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">=</span><span class="si">{}</span><span class="s2"> and &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">original_class</span><span class="o">.</span><span class="n">_subspecifier_field_name</span><span class="p">,</span>
                    <span class="n">original_pk</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subspecifier_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">original_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sourcestr</span> <span class="o">=</span> <span class="s2">&quot;the data passed&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sourcestr</span> <span class="o">=</span> <span class="n">original_class</span><span class="o">.</span><span class="vm">__name__</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Wrong list elements stored in </span><span class="si">{}</span><span class="s2"> for &quot;</span>
                   <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">key=&#39;</span><span class="si">{}</span><span class="s2">&#39; (</span><span class="si">{}</span><span class="s2"> vs </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">sourcestr</span><span class="p">,</span>
                <span class="n">subspecifier_string</span><span class="p">,</span>
                <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span> <span class="n">expected_set</span><span class="p">,</span> <span class="n">received_set</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">lesserrors</span><span class="p">:</span>
                <span class="n">AIIDA_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DeserializationException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># I get the values in memory as a dictionary</span>
        <span class="n">tempdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">firstsubk</span><span class="p">,</span> <span class="n">firstsubv</span> <span class="ow">in</span> <span class="n">firstlevelsubdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># I call recursively the same function to get subitems</span>
            <span class="n">newsubitems</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">firstsubk</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sep</span><span class="p">):]:</span> <span class="n">v</span>
                           <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">subitems</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                           <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">firstsubk</span> <span class="o">+</span> <span class="n">sep</span><span class="p">)}</span>
            <span class="n">tempdict</span><span class="p">[</span><span class="n">firstsubk</span><span class="p">]</span> <span class="o">=</span> <span class="n">_deserialize_attribute</span><span class="p">(</span><span class="n">mainitem</span><span class="o">=</span><span class="n">firstsubv</span><span class="p">,</span>
                                                         <span class="n">subitems</span><span class="o">=</span><span class="n">newsubitems</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">original_class</span><span class="o">=</span><span class="n">original_class</span><span class="p">,</span>
                                                         <span class="n">original_pk</span><span class="o">=</span><span class="n">original_pk</span><span class="p">)</span>

        <span class="c1"># And then I put them in a list</span>
        <span class="n">retlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">tempdict</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;ival&#39;</span><span class="p">])]</span>
        <span class="k">return</span> <span class="n">retlist</span>
    <span class="k">elif</span> <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;dict&#39;</span><span class="p">:</span>
        <span class="c1"># subitems contains all subitems, here I store only those of</span>
        <span class="c1"># deepness 1, i.e. if I have subitems &#39;0&#39;, &#39;1&#39; and &#39;1.c&#39; I</span>
        <span class="c1"># store only &#39;0&#39; and &#39;1&#39;</span>
        <span class="n">firstlevelsubdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">subitems</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                             <span class="k">if</span> <span class="n">sep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">firstlevelsubdict</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;ival&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">original_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                    <span class="n">original_class</span><span class="o">.</span><span class="n">_subspecifier_field_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">subspecifier_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">=</span><span class="si">{}</span><span class="s2"> and &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">original_class</span><span class="o">.</span><span class="n">_subspecifier_field_name</span><span class="p">,</span>
                    <span class="n">original_pk</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subspecifier_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">original_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sourcestr</span> <span class="o">=</span> <span class="s2">&quot;the data passed&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sourcestr</span> <span class="o">=</span> <span class="n">original_class</span><span class="o">.</span><span class="vm">__name__</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Wrong dict length stored in </span><span class="si">{}</span><span class="s2"> for &quot;</span>
                   <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">key=&#39;</span><span class="si">{}</span><span class="s2">&#39; (</span><span class="si">{}</span><span class="s2"> vs </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">sourcestr</span><span class="p">,</span>
                <span class="n">subspecifier_string</span><span class="p">,</span>
                <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">firstlevelsubdict</span><span class="p">),</span>
                <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;ival&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">lesserrors</span><span class="p">:</span>
                <span class="n">AIIDA_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DeserializationException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># I get the values in memory as a dictionary</span>
        <span class="n">tempdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">firstsubk</span><span class="p">,</span> <span class="n">firstsubv</span> <span class="ow">in</span> <span class="n">firstlevelsubdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># I call recursively the same function to get subitems</span>
            <span class="n">newsubitems</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">firstsubk</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sep</span><span class="p">):]:</span> <span class="n">v</span>
                           <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">subitems</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                           <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">firstsubk</span> <span class="o">+</span> <span class="n">sep</span><span class="p">)}</span>
            <span class="n">tempdict</span><span class="p">[</span><span class="n">firstsubk</span><span class="p">]</span> <span class="o">=</span> <span class="n">_deserialize_attribute</span><span class="p">(</span><span class="n">mainitem</span><span class="o">=</span><span class="n">firstsubv</span><span class="p">,</span>
                                                         <span class="n">subitems</span><span class="o">=</span><span class="n">newsubitems</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">original_class</span><span class="o">=</span><span class="n">original_class</span><span class="p">,</span>
                                                         <span class="n">original_pk</span><span class="o">=</span><span class="n">original_pk</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tempdict</span>
    <span class="k">elif</span> <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;tval&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DeserializationException</span><span class="p">(</span><span class="s2">&quot;Error in the content of the json field&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DeserializationException</span><span class="p">(</span><span class="s2">&quot;The type field &#39;</span><span class="si">{}</span><span class="s2">&#39; is not recognized&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]))</span></div>


<div class="viewcode-block" id="deserialize_attributes"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.deserialize_attributes">[docs]</a><span class="k">def</span> <span class="nf">deserialize_attributes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">original_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">original_pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deserialize the attributes from the format internally stored in the DB</span>
<span class="sd">    to the actual format (dictionaries, lists, integers, ...</span>

<span class="sd">    :param data: must be a dictionary of dictionaries. In the top-level dictionary,</span>
<span class="sd">      the key must be the key of the attribute. The value must be a dictionary</span>
<span class="sd">      with the following keys: datatype, tval, fval, ival, bval, dval. Other</span>
<span class="sd">      keys are ignored.</span>
<span class="sd">      NOTE that a type check is not performed! tval is expected to be a string,</span>
<span class="sd">      dval a date, etc.</span>
<span class="sd">    :param sep: a string, the separator between subfields (to separate the</span>
<span class="sd">      name of a dictionary from the keys it contains, for instance)</span>
<span class="sd">    :param original_class: if these elements come from a specific subclass</span>
<span class="sd">      of DbMultipleValueAttributeBaseClass, pass here the class (note: the class,</span>
<span class="sd">      not the instance!). This is used only in case the wrong number of elements</span>
<span class="sd">      is found in the raw data, to print a more meaningful message (if the class</span>
<span class="sd">      has a dbnode associated to it)</span>
<span class="sd">    :param original_pk: if the elements come from a specific subclass</span>
<span class="sd">      of DbMultipleValueAttributeBaseClass that has a dbnode associated to it,</span>
<span class="sd">      pass here the PK integer. This is used only in case the wrong number</span>
<span class="sd">      of elements is found in the raw data, to print a more meaningful message</span>

<span class="sd">    :return: a dictionary, where for each entry the corresponding value is</span>
<span class="sd">      returned, deserialized back to lists, dictionaries, etc.</span>
<span class="sd">      Example: if ``data = {&#39;a&#39;: {&#39;datatype&#39;: &quot;list&quot;, &quot;ival&quot;: 2, ...},</span>
<span class="sd">      &#39;a.0&#39;: {&#39;datatype&#39;: &quot;int&quot;, &quot;ival&quot;: 2, ...},</span>
<span class="sd">      &#39;a.1&#39;: {&#39;datatype&#39;: &quot;txt&quot;, &quot;tval&quot;:  &quot;yy&quot;}]``,</span>
<span class="sd">      it will return ``{&quot;a&quot;: [2, &quot;yy&quot;]}``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>

    <span class="c1"># I group results by zero-level entity</span>
    <span class="n">found_mainitems</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">found_subitems</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">mainkey</span><span class="p">,</span> <span class="n">descriptiondict</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">prefix</span><span class="p">,</span> <span class="n">thissep</span><span class="p">,</span> <span class="n">postfix</span> <span class="o">=</span> <span class="n">mainkey</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">thissep</span><span class="p">:</span>
            <span class="n">found_subitems</span><span class="p">[</span><span class="n">prefix</span><span class="p">][</span><span class="n">postfix</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span>
                                               <span class="ow">in</span> <span class="n">descriptiondict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;key&quot;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mainitem</span> <span class="o">=</span> <span class="n">descriptiondict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">mainitem</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefix</span>
            <span class="n">found_mainitems</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span> <span class="o">=</span> <span class="n">mainitem</span>

    <span class="c1"># There can be mainitems without subitems, but there should not be subitems</span>
    <span class="c1"># without mainitmes.</span>
    <span class="n">lone_subitems</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">found_subitems</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">found_mainitems</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">lone_subitems</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DeserializationException</span><span class="p">(</span><span class="s2">&quot;Missing base keys for the following &quot;</span>
                                       <span class="s2">&quot;items: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lone_subitems</span><span class="p">)))</span>

    <span class="c1"># For each zero-level entity, I call the _deserialize_attribute function</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">found_mainitems</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Note: found_subitems[k] will return an empty dictionary it the</span>
        <span class="c1"># key does not exist, as it is a defaultdict</span>
        <span class="n">retval</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">_deserialize_attribute</span><span class="p">(</span><span class="n">mainitem</span><span class="o">=</span><span class="n">v</span><span class="p">,</span>
                                           <span class="n">subitems</span><span class="o">=</span><span class="n">found_subitems</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">original_class</span><span class="o">=</span><span class="n">original_class</span><span class="p">,</span>
                                           <span class="n">original_pk</span><span class="o">=</span><span class="n">original_pk</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">retval</span></div>


<div class="viewcode-block" id="DbMultipleValueAttributeBaseClass"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbMultipleValueAttributeBaseClass">[docs]</a><span class="k">class</span> <span class="nc">DbMultipleValueAttributeBaseClass</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for tables storing attribute + value data, of</span>
<span class="sd">    different data types (without any association to a Node).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">datatype</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                           <span class="n">default</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                           <span class="n">choices</span><span class="o">=</span><span class="n">attrdatatype_choice</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">tval</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fval</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ival</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">bval</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">NullBooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dval</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># separator for subfields</span>
    <span class="n">_sep</span> <span class="o">=</span> <span class="n">AIIDA_ATTRIBUTE_SEP</span>

<div class="viewcode-block" id="DbMultipleValueAttributeBaseClass.Meta"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbMultipleValueAttributeBaseClass.Meta">[docs]</a>    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;key&#39;</span><span class="p">,),)</span></div>

    <span class="c1"># There are no subspecifiers. If instead you want to group attributes</span>
    <span class="c1"># (e.g. by node, as it is done in the DbAttributeBaseClass), specify here</span>
    <span class="c1"># the field name</span>
    <span class="n">_subspecifier_field_name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subspecifiers_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dict to narrow down the query to only those matching also the</span>
<span class="sd">        subspecifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subspecifier_field_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_subspecifier_field_name</span><span class="p">:</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subspecifier_field_name</span><span class="p">)}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subspecifier_pk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the subspecifier PK in the database (or None, if no</span>
<span class="sd">        subspecifier should be used)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subspecifier_field_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subspecifier_field_name</span><span class="p">)</span><span class="o">.</span><span class="n">pk</span>

<div class="viewcode-block" id="DbMultipleValueAttributeBaseClass.validate_key"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbMultipleValueAttributeBaseClass.validate_key">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_key</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the key string to check if it is valid (e.g., if it does not</span>
<span class="sd">        contain the separator symbol.).</span>

<span class="sd">        :return: None if the key is valid</span>
<span class="sd">        :raise aiida.common.ValidationError: if the key is not valid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.backends.utils</span> <span class="k">import</span> <span class="n">validate_attribute_key</span>
        <span class="k">return</span> <span class="n">validate_attribute_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="DbMultipleValueAttributeBaseClass.set_value"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbMultipleValueAttributeBaseClass.set_value">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_value</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">with_transaction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">subspecifier_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">other_attribs</span><span class="o">=</span><span class="p">{},</span>
                  <span class="n">stop_if_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set a new value in the DB, possibly associated to the given subspecifier.</span>

<span class="sd">        :note: This method also stored directly in the DB.</span>

<span class="sd">        :param key: a string with the key to create (must be a level-0</span>
<span class="sd">          attribute, that is it cannot contain the separator cls._sep).</span>
<span class="sd">        :param value: the value to store (a basic data type or a list or a dict)</span>
<span class="sd">        :param subspecifier_value: must be None if this class has no</span>
<span class="sd">          subspecifier set (e.g., the DbSetting class).</span>
<span class="sd">          Must be the value of the subspecifier (e.g., the dbnode) for classes</span>
<span class="sd">          that define it (e.g. DbAttribute and DbExtra)</span>
<span class="sd">        :param with_transaction: True if you want this function to be managed</span>
<span class="sd">          with transactions. Set to False if you already have a manual</span>
<span class="sd">          management of transactions in the block where you are calling this</span>
<span class="sd">          function (useful for speed improvements to avoid recursive</span>
<span class="sd">          transactions)</span>
<span class="sd">        :param other_attribs: a dictionary of other parameters, to store</span>
<span class="sd">          only on the level-zero attribute (e.g. for description in DbSetting).</span>
<span class="sd">        :param stop_if_existing: if True, it will stop with an</span>
<span class="sd">           UniquenessError exception if the new entry would violate an</span>
<span class="sd">           uniqueness constraint in the DB (same key, or same key+node,</span>
<span class="sd">           depending on the specific subclass). Otherwise, it will</span>
<span class="sd">           first delete the old value, if existent. The use with True is</span>
<span class="sd">           useful if you want to use a given attribute as a &quot;locking&quot; value,</span>
<span class="sd">           e.g. to avoid to perform an action twice on the same node.</span>
<span class="sd">           Note that, if you are using transactions, you may get the error</span>
<span class="sd">           only when the transaction is committed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">transaction</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">validate_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">with_transaction</span><span class="p">:</span>
                <span class="n">sid</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">savepoint</span><span class="p">()</span>

            <span class="c1"># create_value returns a list of nodes to store</span>
            <span class="n">to_store</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
                                        <span class="n">subspecifier_value</span><span class="o">=</span><span class="n">subspecifier_value</span><span class="p">,</span>
                                        <span class="n">other_attribs</span><span class="o">=</span><span class="n">other_attribs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">to_store</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">stop_if_existing</span><span class="p">:</span>
                    <span class="c1"># Delete the olf values if stop_if_existing is False,</span>
                    <span class="c1"># otherwise don&#39;t delete them and hope they don&#39;t</span>
                    <span class="c1"># exist. If they exist, I&#39;ll get an UniquenessError</span>

                    <span class="c1">## NOTE! Be careful in case the extra/attribute to</span>
                    <span class="c1">## store is not a simple attribute but a list or dict:</span>
                    <span class="c1">## like this, it should be ok because if we are</span>
                    <span class="c1">## overwriting an entry it will stop anyway to avoid</span>
                    <span class="c1">## to overwrite the main entry, but otherwise</span>
                    <span class="c1">## there is the risk that trailing pieces remain</span>
                    <span class="c1">## so in general it is good to recursively clean</span>
                    <span class="c1">## all sub-items.</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">del_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span>
                                  <span class="n">subspecifier_value</span><span class="o">=</span><span class="n">subspecifier_value</span><span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span><span class="n">to_store</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">with_transaction</span><span class="p">:</span>
                <span class="n">transaction</span><span class="o">.</span><span class="n">savepoint_commit</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># All exceptions including CTRL+C, ...</span>
            <span class="kn">from</span> <span class="nn">django.db.utils</span> <span class="k">import</span> <span class="n">IntegrityError</span>
            <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">UniquenessError</span>

            <span class="k">if</span> <span class="n">with_transaction</span><span class="p">:</span>
                <span class="n">transaction</span><span class="o">.</span><span class="n">savepoint_rollback</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">IntegrityError</span><span class="p">)</span> <span class="ow">and</span> <span class="n">stop_if_existing</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UniquenessError</span><span class="p">(</span><span class="s2">&quot;Impossible to create the required &quot;</span>
                                      <span class="s2">&quot;entry &quot;</span>
                                      <span class="s2">&quot;in table &#39;</span><span class="si">{}</span><span class="s2">&#39;, &quot;</span>
                                      <span class="s2">&quot;another entry already exists and the creation would &quot;</span>
                                      <span class="s2">&quot;violate an uniqueness constraint.</span><span class="se">\n</span><span class="s2">Further details: &quot;</span>
                                      <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="DbMultipleValueAttributeBaseClass.create_value"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbMultipleValueAttributeBaseClass.create_value">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_value</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">subspecifier_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">other_attribs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new list of attributes, without storing them, associated</span>
<span class="sd">        with the current key/value pair (and to the given subspecifier,</span>
<span class="sd">        e.g. the DbNode for DbAttributes and DbExtras).</span>

<span class="sd">        :note: No hits are done on the DB, in particular no check is done</span>
<span class="sd">          on the existence of the given nodes.</span>

<span class="sd">        :param key: a string with the key to create (can contain the</span>
<span class="sd">          separator cls._sep if this is a sub-attribute: indeed, this</span>
<span class="sd">          function calls itself recursively)</span>
<span class="sd">        :param value: the value to store (a basic data type or a list or a dict)</span>
<span class="sd">        :param subspecifier_value: must be None if this class has no</span>
<span class="sd">          subspecifier set (e.g., the DbSetting class).</span>
<span class="sd">          Must be the value of the subspecifier (e.g., the dbnode) for classes</span>
<span class="sd">          that define it (e.g. DbAttribute and DbExtra)</span>
<span class="sd">        :param other_attribs: a dictionary of other parameters, to store</span>
<span class="sd">          only on the level-zero attribute (e.g. for description in DbSetting).</span>

<span class="sd">        :return: always a list of class instances; it is the user</span>
<span class="sd">          responsibility to store such entries (typically with a Django</span>
<span class="sd">          bulk_create() call).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">datetime</span>

        <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">json</span>
        <span class="kn">from</span> <span class="nn">aiida.common.timezone</span> <span class="k">import</span> <span class="n">is_naive</span><span class="p">,</span> <span class="n">make_aware</span><span class="p">,</span> <span class="n">get_current_timezone</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_subspecifier_field_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">subspecifier_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You cannot specify a subspecifier value for &quot;</span>
                                 <span class="s2">&quot;class </span><span class="si">{}</span><span class="s2"> because it has no subspecifiers&quot;</span>
                                 <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="n">new_entry</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">other_attribs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">subspecifier_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You also have to specify a subspecifier value &quot;</span>
                                 <span class="s2">&quot;for class </span><span class="si">{}</span><span class="s2"> (the </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                                                <span class="bp">cls</span><span class="o">.</span><span class="n">_subspecifier_field_name</span><span class="p">))</span>
            <span class="n">further_params</span> <span class="o">=</span> <span class="n">other_attribs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">further_params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">cls</span><span class="o">.</span><span class="n">_subspecifier_field_name</span><span class="p">:</span>
                                       <span class="n">subspecifier_value</span><span class="p">})</span>
            <span class="n">new_entry</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">further_params</span><span class="p">)</span>

        <span class="n">list_to_return</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_entry</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">bval</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">tval</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">ival</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">fval</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">dval</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;bool&#39;</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">bval</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">tval</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">ival</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">fval</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">dval</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">integer_types</span><span class="p">):</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;int&#39;</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">ival</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">tval</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">bval</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">fval</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">dval</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;float&#39;</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">fval</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">tval</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">ival</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">bval</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">dval</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;txt&#39;</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">tval</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">bval</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">ival</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">fval</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">dval</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>

            <span class="c1"># current timezone is taken from the settings file of django</span>
            <span class="k">if</span> <span class="n">is_naive</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="n">value_to_set</span> <span class="o">=</span> <span class="n">make_aware</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">get_current_timezone</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value_to_set</span> <span class="o">=</span> <span class="n">value</span>

            <span class="n">new_entry</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>
            <span class="c1"># TODO: time-aware and time-naive datetime objects, see</span>
            <span class="c1"># https://docs.djangoproject.com/en/dev/topics/i18n/timezones/#naive-and-aware-datetime-objects</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">dval</span> <span class="o">=</span> <span class="n">value_to_set</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">tval</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">bval</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">ival</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">fval</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>

            <span class="n">new_entry</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;list&#39;</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">dval</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">tval</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">bval</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">ival</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">fval</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">subv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="c1"># I do not need get_or_create here, because</span>
                <span class="c1"># above I deleted all children (and I</span>
                <span class="c1"># expect no concurrency)</span>
                <span class="c1"># NOTE: I do not pass other_attribs</span>
                <span class="n">list_to_return</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">create_value</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_sep</span><span class="p">,</span> <span class="n">i</span><span class="p">)),</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">subv</span><span class="p">,</span>
                    <span class="n">subspecifier_value</span><span class="o">=</span><span class="n">subspecifier_value</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>

            <span class="n">new_entry</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;dict&#39;</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">dval</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">tval</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">bval</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">ival</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">fval</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">subk</span><span class="p">,</span> <span class="n">subv</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">validate_key</span><span class="p">(</span><span class="n">subk</span><span class="p">)</span>

                <span class="c1"># I do not need get_or_create here, because</span>
                <span class="c1"># above I deleted all children (and I</span>
                <span class="c1"># expect no concurrency)</span>
                <span class="c1"># NOTE: I do not pass other_attribs</span>
                <span class="n">list_to_return</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">create_value</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_sep</span><span class="p">,</span> <span class="n">subk</span><span class="p">),</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">subv</span><span class="p">,</span>
                    <span class="n">subspecifier_value</span><span class="o">=</span><span class="n">subspecifier_value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jsondata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to store the value: it must be either a basic datatype, or json-serializable: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

            <span class="n">new_entry</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;json&#39;</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">tval</span> <span class="o">=</span> <span class="n">jsondata</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">bval</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">ival</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_entry</span><span class="o">.</span><span class="n">fval</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">list_to_return</span></div>

<div class="viewcode-block" id="DbMultipleValueAttributeBaseClass.get_query_dict"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbMultipleValueAttributeBaseClass.get_query_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_query_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dictionary that can be used in a django filter to query</span>
<span class="sd">        for a specific value. This takes care of checking the type of the</span>
<span class="sd">        input parameter &#39;value&#39; and to convert it to the right query.</span>

<span class="sd">        :param value: The value that should be queried. Note: can only be</span>
<span class="sd">           base datatype, not a list or dict. For those, query directly for</span>
<span class="sd">           one of the sub-elements.</span>

<span class="sd">        :todo: see if we want to give the possibility to query for the existence</span>
<span class="sd">           of a (possibly empty) dictionary or list, of for their length.</span>

<span class="sd">        :note: this will of course not find a data if this was stored in the</span>
<span class="sd">           DB as a serialized JSON.</span>

<span class="sd">        :return: a dictionary to be used in the django .filter() method.</span>
<span class="sd">            For instance, if &#39;value&#39; is a string, it will return the dictionary</span>
<span class="sd">            ``{&#39;datatype&#39;: &#39;txt&#39;, &#39;tval&#39;: value}``.</span>

<span class="sd">        :raise: ValueError if value is not of a base datatype (string, integer,</span>
<span class="sd">            float, bool, None, or date)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">datetime</span>
        <span class="kn">from</span> <span class="nn">aiida.common.timezone</span> <span class="k">import</span> <span class="p">(</span>
            <span class="n">is_naive</span><span class="p">,</span> <span class="n">make_aware</span><span class="p">,</span> <span class="n">get_current_timezone</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;datatype&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;datatype&#39;</span><span class="p">:</span> <span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="s1">&#39;bval&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">integer_types</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;datatype&#39;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;ival&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;datatype&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;fval&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;datatype&#39;</span><span class="p">:</span> <span class="s1">&#39;txt&#39;</span><span class="p">,</span> <span class="s1">&#39;tval&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="c1"># current timezone is taken from the settings file of django</span>
            <span class="k">if</span> <span class="n">is_naive</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="n">value_to_set</span> <span class="o">=</span> <span class="n">make_aware</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">get_current_timezone</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value_to_set</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;datatype&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;dval&#39;</span><span class="p">:</span> <span class="n">value_to_set</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lists are not supported for getting the &quot;</span>
                             <span class="s2">&quot;query_dict&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dicts are not supported for getting the &quot;</span>
                             <span class="s2">&quot;query_dict&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported type for getting the &quot;</span>
                             <span class="s2">&quot;query_dict, it is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))))</span></div>

<div class="viewcode-block" id="DbMultipleValueAttributeBaseClass.getvalue"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbMultipleValueAttributeBaseClass.getvalue">[docs]</a>    <span class="k">def</span> <span class="nf">getvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This can be called on a given row and will get the corresponding value,</span>
<span class="sd">        casting it correctly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;list&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;dict&#39;</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sep</span><span class="p">)</span>
                <span class="n">prefix_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
                <span class="n">dballsubvalues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">key__startswith</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">subspecifiers_dict</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span>
                                                           <span class="s1">&#39;datatype&#39;</span><span class="p">,</span> <span class="s1">&#39;tval&#39;</span><span class="p">,</span> <span class="s1">&#39;fval&#39;</span><span class="p">,</span>
                                                           <span class="s1">&#39;ival&#39;</span><span class="p">,</span> <span class="s1">&#39;bval&#39;</span><span class="p">,</span> <span class="s1">&#39;dval&#39;</span><span class="p">)</span>
                <span class="c1"># Strip the FULL prefix and replace it with the simple</span>
                <span class="c1"># &quot;attr&quot; prefix</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;attr.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">prefix_len</span><span class="p">:]):</span> <span class="p">{</span>
                    <span class="s2">&quot;datatype&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s2">&quot;tval&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="s2">&quot;fval&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                    <span class="s2">&quot;ival&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                    <span class="s2">&quot;bval&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                    <span class="s2">&quot;dval&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                <span class="p">}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">dballsubvalues</span>
                <span class="p">}</span>
                <span class="c1"># for _ in dballsubvalues}</span>
                <span class="c1"># Append also the item itself</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;attr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="c1"># Replace the key (which may contain the separator) with the</span>
                    <span class="c1"># simple &quot;attr&quot; key. In any case I do not need to return it!</span>
                    <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;attr&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;datatype&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span>
                    <span class="s2">&quot;tval&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">,</span>
                    <span class="s2">&quot;fval&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fval</span><span class="p">,</span>
                    <span class="s2">&quot;ival&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ival</span><span class="p">,</span>
                    <span class="s2">&quot;bval&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bval</span><span class="p">,</span>
                    <span class="s2">&quot;dval&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dval</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">deserialize_attributes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sep</span><span class="p">,</span>
                                              <span class="n">original_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                                              <span class="n">original_pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subspecifier_pk</span><span class="p">)[</span><span class="s1">&#39;attr&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;attr&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="c1"># Replace the key (which may contain the separator) with the</span>
                    <span class="c1"># simple &quot;attr&quot; key. In any case I do not need to return it!</span>
                    <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;attr&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;datatype&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span>
                    <span class="s2">&quot;tval&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">,</span>
                    <span class="s2">&quot;fval&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fval</span><span class="p">,</span>
                    <span class="s2">&quot;ival&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ival</span><span class="p">,</span>
                    <span class="s2">&quot;bval&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bval</span><span class="p">,</span>
                    <span class="s2">&quot;dval&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dval</span><span class="p">}}</span>

                <span class="k">return</span> <span class="n">deserialize_attributes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sep</span><span class="p">,</span>
                                              <span class="n">original_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                                              <span class="n">original_pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subspecifier_pk</span><span class="p">)[</span><span class="s1">&#39;attr&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">DeserializationException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">DbContentError</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="n">exc</span><span class="o">.</span><span class="n">original_exception</span> <span class="o">=</span> <span class="n">exc</span>
            <span class="k">raise</span> <span class="n">exc</span></div>

<div class="viewcode-block" id="DbMultipleValueAttributeBaseClass.del_value"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbMultipleValueAttributeBaseClass.del_value">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">del_value</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">only_children</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">subspecifier_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a value associated with the given key (if existing).</span>

<span class="sd">        :note: No exceptions are raised if no entry is found.</span>

<span class="sd">        :param key: the key to delete. Can contain the separator cls._sep if</span>
<span class="sd">          you want to delete a subkey.</span>
<span class="sd">        :param only_children: if True, delete only children and not the</span>
<span class="sd">          entry itself.</span>
<span class="sd">        :param subspecifier_value: must be None if this class has no</span>
<span class="sd">          subspecifier set (e.g., the DbSetting class).</span>
<span class="sd">          Must be the value of the subspecifier (e.g., the dbnode) for classes</span>
<span class="sd">          that define it (e.g. DbAttribute and DbExtra)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">django.db.models</span> <span class="k">import</span> <span class="n">Q</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_subspecifier_field_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">subspecifier_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You cannot specify a subspecifier value for &quot;</span>
                                 <span class="s2">&quot;class </span><span class="si">{}</span><span class="s2"> because it has no subspecifiers&quot;</span>
                                 <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="n">subspecifiers_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">subspecifier_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You also have to specify a subspecifier value &quot;</span>
                                 <span class="s2">&quot;for class </span><span class="si">{}</span><span class="s2"> (the </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                                                <span class="bp">cls</span><span class="o">.</span><span class="n">_subspecifier_field_name</span><span class="p">))</span>
            <span class="n">subspecifiers_dict</span> <span class="o">=</span> <span class="p">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">_subspecifier_field_name</span><span class="p">:</span>
                                      <span class="n">subspecifier_value</span><span class="p">}</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">key__startswith</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{parentkey}{sep}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">parentkey</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_sep</span><span class="p">),</span>
            <span class="o">**</span><span class="n">subspecifiers_dict</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">only_children</span><span class="p">:</span>
            <span class="n">query</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">subspecifiers_dict</span><span class="p">),</span> <span class="n">Q</span><span class="o">.</span><span class="n">OR</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="DbAttributeBaseClass"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbAttributeBaseClass">[docs]</a><span class="nd">@python_2_unicode_compatible</span>
<span class="k">class</span> <span class="nc">DbAttributeBaseClass</span><span class="p">(</span><span class="n">DbMultipleValueAttributeBaseClass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for tables storing element-attribute-value data.</span>
<span class="sd">    Element is the dbnode; attribute is the key name.</span>
<span class="sd">    Value is the specific value to store.</span>

<span class="sd">    This table had different SQL columns to store different types of data, and</span>
<span class="sd">    a datatype field to know the actual datatype.</span>

<span class="sd">    Moreover, this class unpacks dictionaries and lists when possible, so that</span>
<span class="sd">    it is possible to query inside recursive lists and dicts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># In this way, the related name for the DbAttribute inherited class will be</span>
    <span class="c1"># &#39;dbattributes&#39; and for &#39;dbextra&#39; will be &#39;dbextras&#39;</span>
    <span class="c1"># Moreover, automatically destroy attributes and extras if the parent</span>
    <span class="c1"># node is deleted</span>
    <span class="n">dbnode</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;DbNode&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(class)s</span><span class="s1">s&#39;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="c1"># max_length is required by MySql to have indexes and unique constraints</span>

    <span class="n">_subspecifier_field_name</span> <span class="o">=</span> <span class="s1">&#39;dbnode&#39;</span>

<div class="viewcode-block" id="DbAttributeBaseClass.Meta"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbAttributeBaseClass.Meta">[docs]</a>    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;dbnode&quot;</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="p">))</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="DbAttributeBaseClass.list_all_node_elements"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbAttributeBaseClass.list_all_node_elements">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">list_all_node_elements</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dbnode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a django queryset with the attributes of the given node,</span>
<span class="sd">        only at deepness level zero (i.e., keys not containing the separator).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">django.db.models</span> <span class="k">import</span> <span class="n">Q</span>

        <span class="c1"># This node, and does not contain the separator</span>
        <span class="c1"># (=&gt; show only level-zero entries)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">dbnode</span><span class="o">=</span><span class="n">dbnode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">key__contains</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_sep</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></div>

<div class="viewcode-block" id="DbAttributeBaseClass.get_value_for_node"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbAttributeBaseClass.get_value_for_node">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_value_for_node</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dbnode</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get an attribute from the database for the given dbnode.</span>

<span class="sd">        :return: the value stored in the Db table, correctly converted</span>
<span class="sd">            to the right type.</span>
<span class="sd">        :raise AttributeError: if no key is found for the given dbnode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dbnode</span><span class="o">=</span><span class="n">dbnode</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> with key </span><span class="si">{}</span><span class="s2"> for node </span><span class="si">{}</span><span class="s2"> not found &quot;</span>
                                 <span class="s2">&quot;in db&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">dbnode</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">attr</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span></div>

<div class="viewcode-block" id="DbAttributeBaseClass.get_all_values_for_node"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbAttributeBaseClass.get_all_values_for_node">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_all_values_for_node</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dbnode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dictionary with all attributes for the given dbnode.</span>

<span class="sd">        :return: a dictionary where each key is a level-0 attribute</span>
<span class="sd">            stored in the Db table, correctly converted</span>
<span class="sd">            to the right type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_all_values_for_nodepk</span><span class="p">(</span><span class="n">dbnode</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span></div>

<div class="viewcode-block" id="DbAttributeBaseClass.get_all_values_for_nodepk"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbAttributeBaseClass.get_all_values_for_nodepk">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_all_values_for_nodepk</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dbnodepk</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dictionary with all attributes for the dbnode with given PK.</span>

<span class="sd">        :return: a dictionary where each key is a level-0 attribute</span>
<span class="sd">            stored in the Db table, correctly converted</span>
<span class="sd">            to the right type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dballsubvalues</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dbnode__id</span><span class="o">=</span><span class="n">dbnodepk</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
            <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;datatype&#39;</span><span class="p">,</span> <span class="s1">&#39;tval&#39;</span><span class="p">,</span> <span class="s1">&#39;fval&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ival&#39;</span><span class="p">,</span> <span class="s1">&#39;bval&#39;</span><span class="p">,</span> <span class="s1">&#39;dval&#39;</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">{</span>
            <span class="s2">&quot;datatype&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;tval&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;fval&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="s2">&quot;ival&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
            <span class="s2">&quot;bval&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
            <span class="s2">&quot;dval&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
        <span class="p">}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">dballsubvalues</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">deserialize_attributes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_sep</span><span class="p">,</span>
                                          <span class="n">original_class</span><span class="o">=</span><span class="bp">cls</span><span class="p">,</span>
                                          <span class="n">original_pk</span><span class="o">=</span><span class="n">dbnodepk</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">DeserializationException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">DbContentError</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="n">exc</span><span class="o">.</span><span class="n">original_exception</span> <span class="o">=</span> <span class="n">exc</span>
            <span class="k">raise</span> <span class="n">exc</span></div>

<div class="viewcode-block" id="DbAttributeBaseClass.reset_values_for_node"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbAttributeBaseClass.reset_values_for_node">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">reset_values_for_node</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dbnode</span><span class="p">,</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">with_transaction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">return_not_store</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">transaction</span>

        <span class="c1"># cls.validate_key(key)</span>

        <span class="n">nodes_to_store</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">with_transaction</span><span class="p">:</span>
                <span class="n">sid</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">savepoint</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dbnode</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">integer_types</span><span class="p">):</span>
                <span class="n">dbnode_node</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">dbnode</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dbnode_node</span> <span class="o">=</span> <span class="n">dbnode</span>

            <span class="c1"># create_value returns a list of nodes to store</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">nodes_to_store</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">create_value</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span>
                                     <span class="n">subspecifier_value</span><span class="o">=</span><span class="n">dbnode_node</span><span class="p">,</span>
                                     <span class="p">))</span>

            <span class="k">if</span> <span class="n">return_not_store</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">nodes_to_store</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Reset. For set, use also a filter for key__in=attributes.keys()</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dbnode</span><span class="o">=</span><span class="n">dbnode_node</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">nodes_to_store</span><span class="p">:</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span><span class="n">nodes_to_store</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">with_transaction</span><span class="p">:</span>
                <span class="n">transaction</span><span class="o">.</span><span class="n">savepoint_commit</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">with_transaction</span><span class="p">:</span>
                <span class="n">transaction</span><span class="o">.</span><span class="n">savepoint_rollback</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="DbAttributeBaseClass.set_value_for_node"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbAttributeBaseClass.set_value_for_node">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_value_for_node</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dbnode</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">with_transaction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">stop_if_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is the raw-level method that accesses the DB. No checks are done</span>
<span class="sd">        to prevent the user from (re)setting a valid key.</span>
<span class="sd">        To be used only internally.</span>

<span class="sd">        :todo: there may be some error on concurrent write;</span>
<span class="sd">           not checked in this unlucky case!</span>

<span class="sd">        :param dbnode: the dbnode for which the attribute should be stored;</span>
<span class="sd">          in an integer is passed, this is used as the PK of the dbnode,</span>
<span class="sd">          without any further check (for speed reasons)</span>
<span class="sd">        :param key: the key of the attribute to store; must be a level-zero</span>
<span class="sd">          attribute (i.e., no separators in the key)</span>
<span class="sd">        :param value: the value of the attribute to store</span>
<span class="sd">        :param with_transaction: if True (default), do this within a transaction,</span>
<span class="sd">           so that nothing gets stored if a subitem cannot be created.</span>
<span class="sd">           Otherwise, if this parameter is False, no transaction management</span>
<span class="sd">           is performed.</span>
<span class="sd">        :param stop_if_existing: if True, it will stop with an</span>
<span class="sd">           UniquenessError exception if the key already exists</span>
<span class="sd">           for the given node. Otherwise, it will</span>
<span class="sd">           first delete the old value, if existent. The use with True is</span>
<span class="sd">           useful if you want to use a given attribute as a &quot;locking&quot; value,</span>
<span class="sd">           e.g. to avoid to perform an action twice on the same node.</span>
<span class="sd">           Note that, if you are using transactions, you may get the error</span>
<span class="sd">           only when the transaction is committed.</span>

<span class="sd">        :raise ValueError: if the key contains the separator symbol used</span>
<span class="sd">            internally to unpack dictionaries and lists (defined in cls._sep).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dbnode</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">integer_types</span><span class="p">):</span>
            <span class="n">dbnode_node</span> <span class="o">=</span> <span class="n">DbNode</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">dbnode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dbnode_node</span> <span class="o">=</span> <span class="n">dbnode</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">with_transaction</span><span class="o">=</span><span class="n">with_transaction</span><span class="p">,</span>
                      <span class="n">subspecifier_value</span><span class="o">=</span><span class="n">dbnode_node</span><span class="p">,</span>
                      <span class="n">stop_if_existing</span><span class="o">=</span><span class="n">stop_if_existing</span><span class="p">)</span></div>

<div class="viewcode-block" id="DbAttributeBaseClass.del_value_for_node"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbAttributeBaseClass.del_value_for_node">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">del_value_for_node</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dbnode</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete an attribute from the database for the given dbnode.</span>

<span class="sd">        :note: no exception is raised if no attribute with the given key is</span>
<span class="sd">          found in the DB.</span>

<span class="sd">        :param dbnode: the dbnode for which you want to delete the key.</span>
<span class="sd">        :param key: the key to delete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">del_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">subspecifier_value</span><span class="o">=</span><span class="n">dbnode</span><span class="p">)</span></div>

<div class="viewcode-block" id="DbAttributeBaseClass.has_key"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbAttributeBaseClass.has_key">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">has_key</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dbnode</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True if the given dbnode has an attribute with the given key,</span>
<span class="sd">        False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dbnode</span><span class="o">=</span><span class="n">dbnode</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">))</span></div>

<div class="viewcode-block" id="DbAttributeBaseClass.__str__"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbAttributeBaseClass.__str__">[docs]</a>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)].</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbnode</span><span class="o">.</span><span class="n">get_simple_name</span><span class="p">(</span><span class="n">invalid_result</span><span class="o">=</span><span class="s2">&quot;Unknown node&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbnode</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span> <span class="p">)</span></div></div>


<div class="viewcode-block" id="DbSetting"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbSetting">[docs]</a><span class="nd">@python_2_unicode_compatible</span>
<span class="k">class</span> <span class="nc">DbSetting</span><span class="p">(</span><span class="n">DbMultipleValueAttributeBaseClass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This will store generic settings that should be database-wide.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># I also add a description field for the variables</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Modification time of this attribute</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<div class="viewcode-block" id="DbSetting.__str__"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbSetting.__str__">[docs]</a>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39;=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span></div></div>


<div class="viewcode-block" id="DbAttribute"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbAttribute">[docs]</a><span class="k">class</span> <span class="nc">DbAttribute</span><span class="p">(</span><span class="n">DbAttributeBaseClass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This table stores attributes that uniquely define the content of the</span>
<span class="sd">    node. Therefore, their modification corrupts the data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="DbExtra"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbExtra">[docs]</a><span class="k">class</span> <span class="nc">DbExtra</span><span class="p">(</span><span class="n">DbAttributeBaseClass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This table stores extra data, still in the key-value format,</span>
<span class="sd">    that the user can attach to a node.</span>
<span class="sd">    Therefore, their modification simply changes the user-defined data,</span>
<span class="sd">    but does not corrupt the node (it will still be loadable without errors).</span>
<span class="sd">    Could be useful to add &quot;duplicate&quot; information for easier querying, or</span>
<span class="sd">    for tagging nodes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="DbGroup"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbGroup">[docs]</a><span class="nd">@python_2_unicode_compatible</span>
<span class="k">class</span> <span class="nc">DbGroup</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A group of nodes.</span>

<span class="sd">    Any group of nodes can be created, but some groups may have specific meaning</span>
<span class="sd">    if they satisfy specific rules (for instance, groups of UpdData objects are</span>
<span class="sd">    pseudopotential families - if no two pseudos are included for the same</span>
<span class="sd">    atomic element).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">uuid</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">UUIDField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">get_new_uuid</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># max_length is required by MySql to have indexes and unique constraints</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># The type_string of group: a user group, a pseudopotential group,...</span>
    <span class="c1"># User groups have type_string equal to an empty string</span>
    <span class="n">type_string</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dbnodes</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="s1">&#39;DbNode&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;dbgroups&#39;</span><span class="p">)</span>
    <span class="c1"># Creation time</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># The owner of the group, not of the calculations</span>
    <span class="c1"># On user deletion, remove his/her groups too (not the calcuations, only</span>
    <span class="c1"># the groups</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span>
                        <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;dbgroups&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;type_string&quot;</span><span class="p">),)</span>

<div class="viewcode-block" id="DbGroup.__str__"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbGroup.__str__">[docs]</a>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;DbGroup [type_string: </span><span class="si">{}</span><span class="s1">] &quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type_string</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DbComputer"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbComputer">[docs]</a><span class="nd">@python_2_unicode_compatible</span>
<span class="k">class</span> <span class="nc">DbComputer</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Table of computers or clusters.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    * name: A name to be used to refer to this computer. Must be unique.</span>
<span class="sd">    * hostname: Fully-qualified hostname of the host</span>
<span class="sd">    * transport_type: a string with a valid transport type</span>


<span class="sd">    Note: other things that may be set in the metadata:</span>

<span class="sd">        * mpirun command</span>

<span class="sd">        * num cores per node</span>

<span class="sd">        * max num cores</span>

<span class="sd">        * workdir: Full path of the aiida folder on the host. It can contain\</span>
<span class="sd">            the string {username} that will be substituted by the username\</span>
<span class="sd">            of the user on that machine.\</span>
<span class="sd">            The actual workdir is then obtained as\</span>
<span class="sd">            workdir.format(username=THE_ACTUAL_USERNAME)\</span>
<span class="sd">            Example: \</span>
<span class="sd">            workdir = &quot;/scratch/{username}/aiida/&quot;</span>


<span class="sd">        * allocate full node = True or False</span>

<span class="sd">        * ... (further limits per user etc.)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">uuid</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">UUIDField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">get_new_uuid</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">hostname</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># TODO: next three fields should not be blank...</span>
    <span class="n">transport_type</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">scheduler_type</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">transport_params</span> <span class="o">=</span> <span class="n">JSONField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">JSONField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

<div class="viewcode-block" id="DbComputer.__str__"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbComputer.__str__">[docs]</a>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DbAuthInfo"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbAuthInfo">[docs]</a><span class="nd">@python_2_unicode_compatible</span>
<span class="k">class</span> <span class="nc">DbAuthInfo</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Table that pairs aiida users and computers, with all required authentication</span>
<span class="sd">    information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Delete the DbAuthInfo if either the user or the computer are removed</span>
    <span class="n">aiidauser</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">dbcomputer</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">DbComputer</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">auth_params</span> <span class="o">=</span> <span class="n">JSONField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>  <span class="c1"># contains mainly the remoteuser and the private_key</span>

    <span class="c1"># The keys defined in the metadata of the DbAuthInfo will override the</span>
    <span class="c1"># keys with the same name defined in the DbComputer (using a dict.update()</span>
    <span class="c1"># call of python).</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">JSONField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># Whether this computer is enabled (user-level enabling feature)</span>
    <span class="n">enabled</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;aiidauser&quot;</span><span class="p">,</span> <span class="s2">&quot;dbcomputer&quot;</span><span class="p">),)</span>

<div class="viewcode-block" id="DbAuthInfo.__str__"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbAuthInfo.__str__">[docs]</a>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;DB authorization info for </span><span class="si">{}</span><span class="s2"> on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aiidauser</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbcomputer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;DB authorization info for </span><span class="si">{}</span><span class="s2"> on </span><span class="si">{}</span><span class="s2"> [DISABLED]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aiidauser</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbcomputer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DbComment"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbComment">[docs]</a><span class="nd">@python_2_unicode_compatible</span>
<span class="k">class</span> <span class="nc">DbComment</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">uuid</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">UUIDField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">get_new_uuid</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Delete comments if the node is removed</span>
    <span class="n">dbnode</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">DbNode</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;dbcomments&#39;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">ctime</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">mtime</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># Delete the comments of a deleted user (TODO: check if this is a good policy)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="DbComment.__str__"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbComment.__str__">[docs]</a>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;DbComment for [</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbnode</span><span class="o">.</span><span class="n">get_simple_name</span><span class="p">(),</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">dbnode</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">timezone</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctime</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="DbLog"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbLog">[docs]</a><span class="nd">@python_2_unicode_compatible</span>
<span class="k">class</span> <span class="nc">DbLog</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">uuid</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">UUIDField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">get_new_uuid</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">loggername</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">levelname</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dbnode</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">DbNode</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;dblogs&#39;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">JSONField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

<div class="viewcode-block" id="DbLog.__str__"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.DbLog.__str__">[docs]</a>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;DbLog: </span><span class="si">{}</span><span class="s1"> for node </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levelname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbnode</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="suppress_auto_now"><a class="viewcode-back" href="../../../../../apidoc/aiida.backends.djsite.db.html#aiida.backends.djsite.db.models.suppress_auto_now">[docs]</a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">suppress_auto_now</span><span class="p">(</span><span class="n">list_of_models_fields</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This context manager disables the auto_now &amp; editable flags for the</span>
<span class="sd">    fields of the given models.</span>
<span class="sd">    This is useful when we would like to update the datetime fields of an</span>
<span class="sd">    entry bypassing the automatic set of the date (with the current time).</span>
<span class="sd">    This is very useful when entries are imported and we would like to keep e.g.</span>
<span class="sd">    the modification time that we set during the import and not allow Django</span>
<span class="sd">    to set it to the datetime that corresponds to when the entry was saved.</span>
<span class="sd">    In the end the flags are returned to their original value.</span>
<span class="sd">    :param list_of_models_fields: A list of (model, fields) tuples for</span>
<span class="sd">    which the flags will be updated. The model is an object that corresponds</span>
<span class="sd">    to the model objects and fields is a list of strings with the field names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Here we store the original values of the fields of the models that will</span>
    <span class="c1"># be updated</span>
    <span class="c1"># E.g.</span>
    <span class="c1"># _original_model_values = {</span>
    <span class="c1">#   ModelA: [fieldA: {</span>
    <span class="c1">#                       &#39;auto_now&#39;: orig_valA1</span>
    <span class="c1">#                       &#39;editable&#39;: orig_valA2</span>
    <span class="c1">#            },</span>
    <span class="c1">#            fieldB: {</span>
    <span class="c1">#                       &#39;auto_now&#39;: orig_valB1</span>
    <span class="c1">#                       &#39;editable&#39;: orig_valB2</span>
    <span class="c1">#            }</span>
    <span class="c1">#    ]</span>
    <span class="c1">#   ...</span>
    <span class="c1"># }</span>
    <span class="n">_original_model_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">fields</span> <span class="ow">in</span> <span class="n">list_of_models_fields</span><span class="p">:</span>
        <span class="n">_original_field_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">local_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">_original_field_values</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;auto_now&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">auto_now</span><span class="p">,</span>
                    <span class="s1">&#39;editable&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">editable</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">field</span><span class="o">.</span><span class="n">auto_now</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">field</span><span class="o">.</span><span class="n">editable</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">_original_model_values</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">_original_field_values</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">_original_model_values</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">_original_model_values</span><span class="p">[</span><span class="n">model</span><span class="p">]:</span>
                <span class="n">field</span><span class="o">.</span><span class="n">auto_now</span> <span class="o">=</span> <span class="n">_original_model_values</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;auto_now&#39;</span><span class="p">]</span>
                <span class="n">field</span><span class="o">.</span><span class="n">editable</span> <span class="o">=</span> <span class="n">_original_model_values</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="n">field</span><span class="p">][</span><span class="s1">&#39;editable&#39;</span><span class="p">]</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>