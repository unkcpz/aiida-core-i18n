

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.orm.nodes.data.array.bands &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../../" src="../../../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.orm.nodes.data.array.bands</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.orm.nodes.data.array.bands</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module defines the classes related to band structures or dispersions</span>
<span class="sd">in a Brillouin zone, and how to operate on them.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="k">import</span> <span class="n">Template</span>

<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">zip</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">aiida.common.utils</span> <span class="k">import</span> <span class="n">prettify_labels</span><span class="p">,</span> <span class="n">join_labels</span>
<span class="kn">from</span> <span class="nn">.kpoints</span> <span class="k">import</span> <span class="n">KpointsData</span>


<div class="viewcode-block" id="prepare_header_comment"><a class="viewcode-back" href="../../../../../../apidoc/aiida.orm.nodes.data.array.html#aiida.orm.prepare_header_comment">[docs]</a><span class="k">def</span> <span class="nf">prepare_header_comment</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">plot_info</span><span class="p">,</span> <span class="n">comment_char</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">aiida</span> <span class="k">import</span> <span class="n">get_file_header</span>

    <span class="n">filetext</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">filetext</span> <span class="o">+=</span> <span class="n">get_file_header</span><span class="p">(</span><span class="n">comment_char</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">filetext</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">filetext</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Dumped from BandsData UUID=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="p">))</span>
    <span class="n">filetext</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">points</span><span class="se">\t</span><span class="s2">bands&quot;</span><span class="p">)</span>
    <span class="n">filetext</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">filetext</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">filetext</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">label</span><span class="se">\t</span><span class="s2">point&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;raw_labels&#39;</span><span class="p">]:</span>
        <span class="n">filetext</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{:.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comment_char</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">filetext</span><span class="p">)</span></div>


<span class="c1"># TODO: set and get bands could have more functionalities: how do I know the number of bands for example?</span>


<div class="viewcode-block" id="find_bandgap"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.find_bandgap">[docs]</a><span class="k">def</span> <span class="nf">find_bandgap</span><span class="p">(</span><span class="n">bandsdata</span><span class="p">,</span> <span class="n">number_electrons</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fermi_energy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tries to guess whether the bandsdata represent an insulator.</span>
<span class="sd">    This method is meant to be used only for electronic bands (not phonons)</span>
<span class="sd">    By default, it will try to use the occupations to guess the number of</span>
<span class="sd">    electrons and find the Fermi Energy, otherwise, it can be provided</span>
<span class="sd">    explicitely.</span>
<span class="sd">    Also, there is an implicit assumption that the kpoints grid is</span>
<span class="sd">    &quot;sufficiently&quot; dense, so that the bandsdata are not missing the</span>
<span class="sd">    intersection between valence and conduction band if present.</span>
<span class="sd">    Use this function with care!</span>

<span class="sd">    :param number_electrons: (optional, float) number of electrons in the unit cell</span>
<span class="sd">    :param fermi_energy: (optional, float) value of the fermi energy.</span>

<span class="sd">    :note: By default, the algorithm uses the occupations array</span>
<span class="sd">      to guess the number of electrons and the occupied bands. This is to be</span>
<span class="sd">      used with care, because the occupations could be smeared so at a</span>
<span class="sd">      non-zero temperature, with the unwanted effect that the conduction bands</span>
<span class="sd">      might be occupied in an insulator.</span>
<span class="sd">      Prefer to pass the number_of_electrons explicitly</span>

<span class="sd">    :note: Only one between number_electrons and fermi_energy can be specified at the</span>
<span class="sd">      same time.</span>

<span class="sd">    :return: (is_insulator, gap), where is_insulator is a boolean, and gap a</span>
<span class="sd">             float. The gap is None in case of a metal, zero when the homo is</span>
<span class="sd">             equal to the lumo (e.g. in semi-metals).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">nint</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stable rounding function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span> <span class="o">+</span> <span class="o">.</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="o">.</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fermi_energy</span> <span class="ow">and</span> <span class="n">number_electrons</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Specify either the number of electrons or the Fermi energy, but not both&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">stored_bands</span> <span class="o">=</span> <span class="n">bandsdata</span><span class="o">.</span><span class="n">get_bands</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Cannot do much of a band analysis without bands&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stored_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># I write the algorithm for the generic case of having both the</span>
        <span class="c1"># spin up and spin down array</span>

        <span class="c1"># put all spins on one band per kpoint</span>
        <span class="n">bands</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">stored_bands</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bands</span> <span class="o">=</span> <span class="n">stored_bands</span>

    <span class="c1"># analysis on occupations:</span>
    <span class="k">if</span> <span class="n">fermi_energy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">num_kpoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">number_electrons</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">stored_occupations</span> <span class="o">=</span> <span class="n">bandsdata</span><span class="o">.</span><span class="n">get_bands</span><span class="p">(</span><span class="n">also_occupations</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Cannot determine metallicity if I don&#39;t have either fermi energy, or occupations&quot;</span><span class="p">)</span>

            <span class="c1"># put the occupations in the same order of bands, also in case of multiple bands</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stored_occupations</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># I write the algorithm for the generic case of having both the</span>
                <span class="c1"># spin up and spin down array</span>

                <span class="c1"># put all spins on one band per kpoint</span>
                <span class="n">occupations</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">stored_occupations</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">occupations</span> <span class="o">=</span> <span class="n">stored_occupations</span>

            <span class="c1"># now sort the bands by energy</span>
            <span class="c1"># Note: I am sort of assuming that I have an electronic ground state</span>

            <span class="c1"># sort the bands by energy, and reorder the occupations accordingly</span>
            <span class="c1"># since after joining the two spins, I might have unsorted stuff</span>
            <span class="n">bands</span><span class="p">,</span> <span class="n">occupations</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
                    <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">j</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span>
                    <span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bands</span><span class="p">,</span> <span class="n">occupations</span><span class="p">)]</span>
                <span class="p">])</span>
            <span class="p">]</span>
            <span class="n">number_electrons</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="nb">sum</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">occupations</span><span class="p">])</span> <span class="o">/</span> <span class="n">num_kpoints</span><span class="p">))</span>

            <span class="n">homo_indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nint</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">occupations</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">homo_indexes</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># there must be intersections of valence and conduction bands</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">homo</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">_</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bands</span><span class="p">,</span> <span class="n">homo_indexes</span><span class="p">)]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">lumo</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bands</span><span class="p">,</span> <span class="n">homo_indexes</span><span class="p">)]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;To understand if it is a metal or insulator, &quot;</span>
                                     <span class="s2">&quot;need more bands than n_band=number_electrons&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">bands</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>
            <span class="n">number_electrons</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">number_electrons</span><span class="p">)</span>

            <span class="c1"># find the zero-temperature occupation per band (1 for spin-polarized</span>
            <span class="c1"># calculation, 2 otherwise)</span>
            <span class="n">number_electrons_per_band</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">stored_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># 1 or 2</span>
            <span class="c1"># gather the energies of the homo band, for every kpoint</span>
            <span class="n">homo</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">number_electrons</span> <span class="o">//</span> <span class="n">number_electrons_per_band</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">]</span>  <span class="c1"># take the nth level</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># gather the energies of the lumo band, for every kpoint</span>
                <span class="n">lumo</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">number_electrons</span> <span class="o">//</span> <span class="n">number_electrons_per_band</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">]</span>  <span class="c1"># take the n+1th level</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;To understand if it is a metal or insulator, &quot;</span>
                                 <span class="s2">&quot;need more bands than n_band=number_electrons&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">number_electrons</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">stored_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># if #electrons is odd and we have a non spin polarized calculation</span>
            <span class="c1"># it must be a metal and I don&#39;t need further checks</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># if the nth band crosses the (n+1)th, it is an insulator</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lumo</span><span class="p">)</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">homo</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gap</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mf">0.</span>
        <span class="k">elif</span> <span class="n">gap</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">gap</span>

    <span class="c1"># analysis on the fermi energy</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># reorganize the bands, rather than per kpoint, per energy level</span>

        <span class="c1"># I need the bands sorted by energy</span>
        <span class="n">bands</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">levels</span> <span class="o">=</span> <span class="n">bands</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">max_mins</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">max</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">fermi_energy</span> <span class="o">&gt;</span> <span class="n">bands</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The Fermi energy is above all band energies, don&#39;t know what to do&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fermi_energy</span> <span class="o">&lt;</span> <span class="n">bands</span><span class="o">.</span><span class="n">min</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The Fermi energy is below all band energies, don&#39;t know what to do.&quot;</span><span class="p">)</span>

        <span class="c1"># one band is crossed by the fermi energy</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">fermi_energy</span> <span class="ow">and</span> <span class="n">fermi_energy</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">max_mins</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># case of semimetals, fermi energy at the crossing of two bands</span>
        <span class="c1"># this will only work if the dirac point is computed!</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">fermi_energy</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">max_mins</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">fermi_energy</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">max_mins</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mf">0.</span>
        <span class="c1"># insulating case</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># take the max of the band maxima below the fermi energy</span>
            <span class="n">homo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">max_mins</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">fermi_energy</span><span class="p">])</span>
            <span class="c1"># take the min of the band minima above the fermi energy</span>
            <span class="n">lumo</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">max_mins</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">fermi_energy</span><span class="p">])</span>
            <span class="n">gap</span> <span class="o">=</span> <span class="n">lumo</span> <span class="o">-</span> <span class="n">homo</span>
            <span class="k">if</span> <span class="n">gap</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Something wrong has been implemented. Revise the code!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">gap</span></div>


<div class="viewcode-block" id="BandsData"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData">[docs]</a><span class="k">class</span> <span class="nc">BandsData</span><span class="p">(</span><span class="n">KpointsData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to handle bands data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Associate file extensions to default plotting formats</span>
    <span class="n">_custom_export_format_replacements</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;dat&#39;</span><span class="p">:</span> <span class="s1">&#39;dat_multicolumn&#39;</span><span class="p">,</span>
        <span class="s1">&#39;png&#39;</span><span class="p">:</span> <span class="s1">&#39;mpl_png&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pdf&#39;</span><span class="p">:</span> <span class="s1">&#39;mpl_pdf&#39;</span><span class="p">,</span>
        <span class="s1">&#39;py&#39;</span><span class="p">:</span> <span class="s1">&#39;mpl_singlefile&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gnu&#39;</span><span class="p">:</span> <span class="s1">&#39;gnuplot&#39;</span>
    <span class="p">}</span>

<div class="viewcode-block" id="BandsData.set_kpointsdata"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData.set_kpointsdata">[docs]</a>    <span class="k">def</span> <span class="nf">set_kpointsdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kpointsdata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the kpoints from a kpoint object.</span>
<span class="sd">        :param kpointsdata: an instance of KpointsData class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kpointsdata</span><span class="p">,</span> <span class="n">KpointsData</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;kpointsdata must be of the KpointsData class&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">kpointsdata</span><span class="o">.</span><span class="n">cell</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pbc</span> <span class="o">=</span> <span class="n">kpointsdata</span><span class="o">.</span><span class="n">pbc</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bravais_lattice</span> <span class="o">=</span> <span class="n">kpointsdata</span><span class="o">.</span><span class="n">bravais_lattice</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">the_kpoints</span> <span class="o">=</span> <span class="n">kpointsdata</span><span class="o">.</span><span class="n">get_kpoints</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">the_kpoints</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">the_weights</span> <span class="o">=</span> <span class="n">kpointsdata</span><span class="o">.</span><span class="n">get_kpoints</span><span class="p">(</span><span class="n">also_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">the_weights</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_kpoints</span><span class="p">(</span><span class="n">the_kpoints</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">the_weights</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">kpointsdata</span><span class="o">.</span><span class="n">labels</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="BandsData._validate_bands_occupations"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData._validate_bands_occupations">[docs]</a>    <span class="k">def</span> <span class="nf">_validate_bands_occupations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">occupations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the list of bands and of occupations before storage.</span>
<span class="sd">        Kpoints must be set in advance.</span>
<span class="sd">        Bands and occupations must be convertible into arrays of</span>
<span class="sd">        Nkpoints x Nbands floats or Nspins x Nkpoints x Nbands; Nkpoints must</span>
<span class="sd">        correspond to the number of kpoints.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kpoints</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Must first set the kpoints, then the bands&quot;</span><span class="p">)</span>

        <span class="n">the_bands</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">the_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bands must be an array of dimension 2&quot;</span>
                             <span class="s2">&quot;([N_kpoints, N_bands]) or of dimension 3 &quot;</span>
                             <span class="s2">&quot; ([N_arrays, N_kpoints, N_bands]), found instead </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">the_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span>

        <span class="n">list_of_arrays_to_be_checked</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># check that the shape of everything is consistent with the kpoints</span>
        <span class="n">num_kpoints_from_bands</span> <span class="o">=</span> <span class="n">the_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">the_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">the_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">num_kpoints_from_bands</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">kpoints</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There must be energy values for every kpoint&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">occupations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">the_occupations</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">occupations</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">the_occupations</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">the_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shape of occupations </span><span class="si">{}</span><span class="s2"> different from shape&quot;</span>
                                 <span class="s2">&quot;shape of bands </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">the_occupations</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">the_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">the_bands</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                <span class="n">list_of_arrays_to_be_checked</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">the_occupations</span><span class="p">,</span> <span class="s1">&#39;occupations&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">the_occupations</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># list_of_arrays_to_be_checked = [ [the_bands,&#39;bands&#39;] ]</span>

        <span class="c1"># check that there every element is a float</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">the_bands</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
            <span class="n">list_of_arrays_to_be_checked</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">the_bands</span><span class="p">,</span> <span class="s1">&#39;bands&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">list_of_arrays_to_be_checked</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">if</span> <span class="n">_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> array can only contain float or None values&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

        <span class="c1"># check the labels</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="n">the_labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">labels</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]):</span>
                <span class="n">the_labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Band labels have an unrecognized type (</span><span class="si">{}</span><span class="s2">)&quot;</span>
                                      <span class="s2">&quot;but should be a string or a list of strings&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="vm">__class__</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">the_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">the_labels</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;More array labels than the number of arrays&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">the_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">the_labels</span><span class="p">)</span> <span class="o">!=</span> <span class="n">the_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;More array labels than the number of arrays&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">the_labels</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">the_bands</span><span class="p">,</span> <span class="n">the_occupations</span><span class="p">,</span> <span class="n">the_labels</span></div>

<div class="viewcode-block" id="BandsData.set_bands"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData.set_bands">[docs]</a>    <span class="k">def</span> <span class="nf">set_bands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">occupations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set an array of band energies of dimension (nkpoints x nbands).</span>
<span class="sd">        Kpoints must be set in advance. Can contain floats or None.</span>
<span class="sd">        :param bands: a list of nkpoints lists of nbands bands, or a 2D array</span>
<span class="sd">        of shape (nkpoints x nbands), with band energies for each kpoint</span>
<span class="sd">        :param units: optional, energy units</span>
<span class="sd">        :param occupations: optional, a 2D list or array of floats of same</span>
<span class="sd">        shape as bands, with the occupation associated to each band</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># checks bands and occupations</span>
        <span class="n">the_bands</span><span class="p">,</span> <span class="n">the_occupations</span><span class="p">,</span> <span class="n">the_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_bands_occupations</span><span class="p">(</span><span class="n">bands</span><span class="p">,</span> <span class="n">occupations</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="c1"># set bands and their units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="s1">&#39;bands&#39;</span><span class="p">,</span> <span class="n">the_bands</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">units</span>

        <span class="k">if</span> <span class="n">the_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;array_labels&#39;</span><span class="p">,</span> <span class="n">the_labels</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">the_occupations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># set occupations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="s1">&#39;occupations&#39;</span><span class="p">,</span> <span class="n">the_occupations</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">array_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the labels associated with the band arrays</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;array_labels&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Units in which the data in bands were stored. A string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># return copy.deepcopy(self._pbc)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">)</span>

    <span class="nd">@units</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the value of pbc, i.e. a tuple of three booleans, indicating if the</span>
<span class="sd">        cell is periodic in the 1,2,3 crystal direction</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">the_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="n">the_str</span><span class="p">)</span>

<div class="viewcode-block" id="BandsData._set_pbc"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData._set_pbc">[docs]</a>    <span class="k">def</span> <span class="nf">_set_pbc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        validate the pbc, then store them</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">ModificationNotAllowed</span>
        <span class="kn">from</span> <span class="nn">aiida.orm.nodes.data.structure</span> <span class="k">import</span> <span class="n">get_valid_pbc</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stored</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ModificationNotAllowed</span><span class="p">(</span><span class="s2">&quot;The KpointsData object cannot be modified, it has already been stored&quot;</span><span class="p">)</span>
        <span class="n">the_pbc</span> <span class="o">=</span> <span class="n">get_valid_pbc</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;pbc1&#39;</span><span class="p">,</span> <span class="n">the_pbc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;pbc2&#39;</span><span class="p">,</span> <span class="n">the_pbc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s1">&#39;pbc3&#39;</span><span class="p">,</span> <span class="n">the_pbc</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span></div>

<div class="viewcode-block" id="BandsData.get_bands"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData.get_bands">[docs]</a>    <span class="k">def</span> <span class="nf">get_bands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">also_occupations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">also_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an array (nkpoints x num_bands or nspins x nkpoints x num_bands)</span>
<span class="sd">        of energies.</span>
<span class="sd">        :param also_occupations: if True, returns also the occupations array.</span>
<span class="sd">        Default = False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bands</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="s1">&#39;bands&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No stored bands has been found&quot;</span><span class="p">)</span>

        <span class="n">to_return</span> <span class="o">=</span> <span class="p">[</span><span class="n">bands</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">also_occupations</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">occupations</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="s1">&#39;occupations&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;No occupations were set&#39;</span><span class="p">)</span>
            <span class="n">to_return</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">occupations</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">also_labels</span><span class="p">:</span>
            <span class="n">to_return</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array_labels</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_return</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bands</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">to_return</span></div>

<div class="viewcode-block" id="BandsData._get_bandplot_data"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData._get_bandplot_data">[docs]</a>    <span class="k">def</span> <span class="nf">_get_bandplot_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cartesian</span><span class="p">,</span> <span class="n">prettify_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">join_symbol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">get_segments</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">y_origin</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get data to plot a band structure</span>

<span class="sd">        :param cartesian: if True, distances (for the x-axis) are computed in</span>
<span class="sd">                cartesian coordinates, otherwise they are computed in reciprocal</span>
<span class="sd">                coordinates. cartesian=True will fail if no cell has been set.</span>
<span class="sd">        :param prettify_format: by default, strings are not prettified. If you want</span>
<span class="sd">             to prettify them, pass a valid prettify_format string (see valid options</span>
<span class="sd">             in the docstring of :py:func:prettify_labels).</span>
<span class="sd">        :param join_symbols: by default, strings are not joined. If you pass a string,</span>
<span class="sd">             this is used to join strings that are much closer than a given threshold.</span>
<span class="sd">             The most typical string is the pipe symbol: ``|``.</span>
<span class="sd">        :param get_segments: if True, also computes the band split into segments</span>
<span class="sd">        :param y_origin: if present, shift bands so to set the value specified at ``y=0``</span>
<span class="sd">        :return: a plot_info dictiorary, whose keys are ``x`` (array of distances</span>
<span class="sd">           for the x axis of the plot); ``y`` (array of bands), ``labels`` (list</span>
<span class="sd">           of tuples in the format (float x value of the label, label string),</span>
<span class="sd">           ``band_type_idx`` (array containing an index for each band: if there is only</span>
<span class="sd">           one spin, then it&#39;s an array of zeros, of length equal to the number of bands</span>
<span class="sd">           at each point; if there are two spins, then it&#39;s an array of zeros or ones</span>
<span class="sd">           depending on the type of spin; the length is always equalt to the total</span>
<span class="sd">           number of bands per kpoint).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># load the x and y&#39;s of the graph</span>
        <span class="n">stored_bands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bands</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stored_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">bands</span> <span class="o">=</span> <span class="n">stored_bands</span>
            <span class="n">band_type_idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">stored_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">two_band_types</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">stored_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">bands</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">stored_bands</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">band_type_idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">stored_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">stored_bands</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">two_band_types</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected shape of bands&quot;</span><span class="p">)</span>

        <span class="n">bands</span> <span class="o">-=</span> <span class="n">y_origin</span>

        <span class="c1"># here I build the x distances on the graph (in cartesian coordinates</span>
        <span class="c1"># if cartesian==True AND if the cell was set, otherwise in reciprocal</span>
        <span class="c1"># coordinates)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kpoints</span><span class="p">(</span><span class="n">cartesian</span><span class="o">=</span><span class="n">cartesian</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># this error is happening if cartesian==True and if no cell has been</span>
            <span class="c1"># set -&gt; we switch to reciprocal coordinates to compute distances</span>
            <span class="n">kpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kpoints</span><span class="p">()</span>
        <span class="c1"># I take advantage of the path to recognize discontinuities</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span>
            <span class="n">labels_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">labels_indices</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># since I can have discontinuous paths, I set on those points the distance to zero</span>
        <span class="c1"># as a result, where there are discontinuities in the path,</span>
        <span class="c1"># I have two consecutive points with the same x coordinate</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">kpoints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">kpoints</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">labels_indices</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">labels_indices</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">kpoints</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">distances</span><span class="p">[:</span><span class="n">i</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="c1"># transform the index of the labels in the coordinates of x</span>
        <span class="n">raw_labels</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>

        <span class="n">the_labels</span> <span class="o">=</span> <span class="n">raw_labels</span>

        <span class="k">if</span> <span class="n">prettify_format</span><span class="p">:</span>
            <span class="n">the_labels</span> <span class="o">=</span> <span class="n">prettify_labels</span><span class="p">(</span><span class="n">the_labels</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">prettify_format</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">join_symbol</span><span class="p">:</span>
            <span class="n">the_labels</span> <span class="o">=</span> <span class="n">join_labels</span><span class="p">(</span><span class="n">the_labels</span><span class="p">,</span> <span class="n">join_symbol</span><span class="o">=</span><span class="n">join_symbol</span><span class="p">)</span>

        <span class="n">plot_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bands</span>
        <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;band_type_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_type_idx</span>
        <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;raw_labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_labels</span>
        <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">the_labels</span>

        <span class="k">if</span> <span class="n">get_segments</span><span class="p">:</span>
            <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># I add an empty label that points to the first band if the first label does not do it</span>
                <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">labels</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="c1"># I add an empty label that points to the last band if the last label does not do it</span>
                <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span>
                    <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">position_from</span><span class="p">,</span> <span class="n">label_from</span><span class="p">),</span> <span class="p">(</span><span class="n">position_to</span><span class="p">,</span> <span class="n">label_to</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                    <span class="k">if</span> <span class="n">position_to</span> <span class="o">-</span> <span class="n">position_from</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># Create a new path line only if there are at least two points,</span>
                        <span class="c1"># otherwise it is probably just a discontinuity point in the band</span>
                        <span class="c1"># structure (e.g. Gamma-X|Y-Gamma), where X and Y would be two</span>
                        <span class="c1"># consecutive points, but there is no path between them</span>
                        <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">label_from</span><span class="p">,</span> <span class="n">label_to</span><span class="p">])</span>
                    <span class="n">path_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="n">position_to</span> <span class="o">-</span> <span class="n">position_from</span><span class="p">,</span>
                        <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">label_from</span><span class="p">,</span>
                        <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">label_to</span><span class="p">,</span>
                        <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="n">bands</span><span class="p">[</span><span class="n">position_from</span><span class="p">:</span><span class="n">position_to</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                        <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">position_from</span><span class="p">:</span><span class="n">position_to</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="s1">&#39;two_band_types&#39;</span><span class="p">:</span> <span class="n">two_band_types</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_dict</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label_from</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
                <span class="n">label_to</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
                <span class="n">path_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="n">bands</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">label_from</span><span class="p">,</span>
                    <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">label_to</span><span class="p">,</span>
                    <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="n">bands</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
                    <span class="s1">&#39;two_band_types&#39;</span><span class="p">:</span> <span class="n">two_band_types</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_dict</span><span class="p">)</span>
                <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">label_from</span><span class="p">,</span> <span class="n">label_to</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">plot_info</span></div>

<div class="viewcode-block" id="BandsData._prepare_agr_batch"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData._prepare_agr_batch">[docs]</a>    <span class="k">def</span> <span class="nf">_prepare_agr_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_file_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prettify_format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare two files, data and batch, to be plot with xmgrace as:</span>
<span class="sd">        xmgrace -batch file.dat</span>

<span class="sd">        :param main_file_name: if the user asks to write the main content on a</span>
<span class="sd">             file, this contains the filename. This should be used to infer a</span>
<span class="sd">             good filename for the additional files.</span>
<span class="sd">             In this case, we remove the extension, and add &#39;_data.dat&#39;</span>
<span class="sd">        :param comments: if True, print comments (if it makes sense for the given</span>
<span class="sd">            format)</span>
<span class="sd">        :param prettify_format: if None, use the default prettify format. Otherwise</span>
<span class="sd">            specify a string with the prettifier to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="n">dat_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">main_file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_data.dat&quot;</span>

        <span class="k">if</span> <span class="n">prettify_format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Default. Specified like this to allow caller functions to pass &#39;None&#39;</span>
            <span class="n">prettify_format</span> <span class="o">=</span> <span class="s1">&#39;agr_seekpath&#39;</span>

        <span class="n">plot_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bandplot_data</span><span class="p">(</span><span class="n">cartesian</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prettify_format</span><span class="o">=</span><span class="n">prettify_format</span><span class="p">,</span> <span class="n">join_symbol</span><span class="o">=</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>

        <span class="n">bands</span> <span class="o">=</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span>

        <span class="n">num_labels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">num_bands</span> <span class="o">=</span> <span class="n">bands</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># axis limits</span>
        <span class="n">y_max_lim</span> <span class="o">=</span> <span class="n">bands</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">y_min_lim</span> <span class="o">=</span> <span class="n">bands</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">x_min_lim</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># this isn&#39;t a numpy array, but a list</span>
        <span class="n">x_max_lim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># first prepare the xy coordinates of the sets</span>
        <span class="n">raw_data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_dat_blocks</span><span class="p">(</span><span class="n">plot_info</span><span class="p">)</span>

        <span class="c1">## Manually add the xy coordinates of the vertical lines - not needed! Use gridlines</span>
        <span class="c1">#new_block = []</span>
        <span class="c1">#for l in labels:</span>
        <span class="c1">#    new_block.append(&quot;{}\t{}&quot;.format(l[0], y_min_lim))</span>
        <span class="c1">#    new_block.append(&quot;{}\t{}&quot;.format(l[0], y_max_lim))</span>
        <span class="c1">#    new_block.append(&quot;&quot;)</span>
        <span class="c1">#raw_data += &quot;\n&quot;.join(new_block)</span>

        <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">comments</span><span class="p">:</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prepare_header_comment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">plot_info</span><span class="p">,</span> <span class="n">comment_char</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="p">))</span>

        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;READ XY &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dat_filename</span><span class="p">))</span>

        <span class="c1"># axis limits</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;world </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x_min_lim</span><span class="p">,</span> <span class="n">y_min_lim</span><span class="p">,</span> <span class="n">x_max_lim</span><span class="p">,</span> <span class="n">y_max_lim</span><span class="p">))</span>

        <span class="c1"># axis label</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;yaxis label &quot;Dispersion&quot;&#39;</span><span class="p">)</span>

        <span class="c1"># axis ticks</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;xaxis  tick place both&#39;</span><span class="p">)</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;xaxis  tick spec type both&#39;</span><span class="p">)</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;xaxis  tick spec </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)))</span>
        <span class="c1"># set the name of the special points</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;xaxis  tick major </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;xaxis  ticklabel </span><span class="si">{}</span><span class="s1">, &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;xaxis  tick major color 7&#39;</span><span class="p">)</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;xaxis  tick major grid on&#39;</span><span class="p">)</span>

        <span class="c1"># minor graphical tweak</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;yaxis  tick minor ticks 3&quot;</span><span class="p">)</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;frame linewidth 1.0&quot;</span><span class="p">)</span>

        <span class="c1"># use helvetica fonts</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;map font 4 to &quot;Helvetica&quot;, &quot;Helvetica&quot;&#39;</span><span class="p">)</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;yaxis  label font 4&quot;</span><span class="p">)</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;xaxis  label font 4&quot;</span><span class="p">)</span>

        <span class="c1"># set color and linewidths of bands</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_bands</span><span class="p">):</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;s</span><span class="si">{}</span><span class="s2"> line color 1&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;s</span><span class="si">{}</span><span class="s2"> linewidth 1&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="c1">## set color and linewidths of label lines - not needed! use gridlines</span>
        <span class="c1">#for i in range(num_bands, num_bands + num_labels):</span>
        <span class="c1">#    batch.append(&quot;s{} hidden true&quot;.format(i))</span>

        <span class="n">batch_data</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">extra_files</span> <span class="o">=</span> <span class="p">{</span><span class="n">dat_filename</span><span class="p">:</span> <span class="n">raw_data</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">batch_data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">extra_files</span></div>

<div class="viewcode-block" id="BandsData._prepare_dat_1"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData._prepare_dat_1">[docs]</a>    <span class="k">def</span> <span class="nf">_prepare_dat_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Output data in .dat format, using multiple columns for all y values</span>
<span class="sd">        associated to the same x.</span>

<span class="sd">        .. deprecated:: 0.8.1</span>
<span class="sd">            Use &#39;dat_multicolumn&#39; format instead</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">warnings</span>
        <span class="kn">from</span> <span class="nn">aiida.common.warnings</span> <span class="k">import</span> <span class="n">AiidaDeprecationWarning</span> <span class="k">as</span> <span class="ne">DeprecationWarning</span>  <span class="c1"># pylint: disable=redefined-builtin</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;dat_1 format is deprecated, use dat_multicolumn instead&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_dat_multicolumn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="BandsData._prepare_dat_multicolumn"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData._prepare_dat_multicolumn">[docs]</a>    <span class="k">def</span> <span class="nf">_prepare_dat_multicolumn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_file_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write an N x M matrix. First column is the distance between kpoints,</span>
<span class="sd">        The other columns are the bands. Header contains number of kpoints and</span>
<span class="sd">        the number of bands (commented).</span>

<span class="sd">        :param comments: if True, print comments (if it makes sense for the given</span>
<span class="sd">            format)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plot_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bandplot_data</span><span class="p">(</span><span class="n">cartesian</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prettify_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">join_symbol</span><span class="o">=</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>

        <span class="n">bands</span> <span class="o">=</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>

        <span class="n">return_text</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">comments</span><span class="p">:</span>
            <span class="n">return_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prepare_header_comment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">plot_info</span><span class="p">,</span> <span class="n">comment_char</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bands</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">return_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">return_text</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="BandsData._prepare_dat_2"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData._prepare_dat_2">[docs]</a>    <span class="k">def</span> <span class="nf">_prepare_dat_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Output data in .dat format, using blocks.</span>

<span class="sd">        .. deprecated:: 0.8.1</span>
<span class="sd">            Use &#39;dat_block&#39; format instead</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">warnings</span>
        <span class="kn">from</span> <span class="nn">aiida.common.warnings</span> <span class="k">import</span> <span class="n">AiidaDeprecationWarning</span> <span class="k">as</span> <span class="ne">DeprecationWarning</span>  <span class="c1"># pylint: disable=redefined-builtin</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;dat_2 format is deprecated, use dat_blocks instead&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_dat_blocks</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="BandsData._prepare_dat_blocks"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData._prepare_dat_blocks">[docs]</a>    <span class="k">def</span> <span class="nf">_prepare_dat_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_file_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Format suitable for gnuplot using blocks.</span>
<span class="sd">        Columns with x and y (path and band energy). Several blocks, separated</span>
<span class="sd">        by two empty lines, one per energy band.</span>

<span class="sd">        :param comments: if True, print comments (if it makes sense for the given</span>
<span class="sd">            format)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plot_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bandplot_data</span><span class="p">(</span><span class="n">cartesian</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prettify_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">join_symbol</span><span class="o">=</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>

        <span class="n">bands</span> <span class="o">=</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>

        <span class="n">return_text</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">comments</span><span class="p">:</span>
            <span class="n">return_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prepare_header_comment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">plot_info</span><span class="p">,</span> <span class="n">comment_char</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="p">))</span>

        <span class="n">the_bands</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">the_bands</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s2">&quot;</span><span class="si">{:.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                <span class="n">return_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            <span class="n">return_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">return_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">return_text</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="BandsData._matplotlib_get_dict"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData._matplotlib_get_dict">[docs]</a>    <span class="k">def</span> <span class="nf">_matplotlib_get_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                             <span class="n">main_file_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                             <span class="n">comments</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                             <span class="n">legend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">legend2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">y_max_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">y_min_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">y_origin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                             <span class="n">prettify_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the data to send to the python-matplotlib plotting script.</span>

<span class="sd">        :param comments: if True, print comments (if it makes sense for the given</span>
<span class="sd">            format)</span>
<span class="sd">        :param plot_info: a dictionary</span>
<span class="sd">        :param setnumber_offset: an offset to be applied to all set numbers</span>
<span class="sd">            (i.e. s0 is replaced by s[offset], s1 by s[offset+1], etc.)</span>
<span class="sd">        :param color_number: the color number for lines, symbols, error bars</span>
<span class="sd">            and filling (should be less than the parameter max_num_agr_colors</span>
<span class="sd">            defined below)</span>
<span class="sd">        :param title: the title</span>
<span class="sd">        :param legend: the legend (applied only to the first of the set)</span>
<span class="sd">        :param legend2: the legend for second-type spins </span>
<span class="sd">            (applied only to the first of the set)</span>
<span class="sd">        :param y_max_lim: the maximum on the y axis (if None, put the</span>
<span class="sd">            maximum of the bands)</span>
<span class="sd">        :param y_min_lim: the minimum on the y axis (if None, put the</span>
<span class="sd">            minimum of the bands)</span>
<span class="sd">        :param y_origin: the new origin of the y axis -&gt; all bands are replaced</span>
<span class="sd">            by bands-y_origin</span>
<span class="sd">        :param prettify_format: if None, use the default prettify format. Otherwise</span>
<span class="sd">            specify a string with the prettifier to use.</span>
<span class="sd">        :param kwargs: additional customization variables; only a subset is</span>
<span class="sd">            accepted, see internal variable &#39;valid_additional_keywords</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#import math</span>

        <span class="c1"># Only these keywords are accepted in kwargs, and then set into the json</span>
        <span class="n">valid_additional_keywords</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;bands_color&quot;</span><span class="p">,</span>  <span class="c1"># Color of band lines</span>
            <span class="s2">&quot;bands_linewidth&quot;</span><span class="p">,</span>  <span class="c1"># linewidth of bands</span>
            <span class="s2">&quot;bands_linestyle&quot;</span><span class="p">,</span>  <span class="c1"># linestyle of bands</span>
            <span class="s2">&quot;bands_marker&quot;</span><span class="p">,</span>  <span class="c1"># marker for bands</span>
            <span class="s2">&quot;bands_markersize&quot;</span><span class="p">,</span>  <span class="c1"># size of the marker of bands</span>
            <span class="s2">&quot;bands_markeredgecolor&quot;</span><span class="p">,</span>  <span class="c1"># marker edge color for bands</span>
            <span class="s2">&quot;bands_markeredgewidth&quot;</span><span class="p">,</span>  <span class="c1"># marker edge width for bands</span>
            <span class="s2">&quot;bands_markerfacecolor&quot;</span><span class="p">,</span>  <span class="c1"># marker face color for bands</span>
            <span class="s2">&quot;bands_color2&quot;</span><span class="p">,</span>  <span class="c1"># Color of band lines (for other spin, if present)</span>
            <span class="s2">&quot;bands_linewidth2&quot;</span><span class="p">,</span>  <span class="c1"># linewidth of bands (for other spin, if present)</span>
            <span class="s2">&quot;bands_linestyle2&quot;</span><span class="p">,</span>  <span class="c1"># linestyle of bands (for other spin, if present)</span>
            <span class="s2">&quot;bands_marker2&quot;</span><span class="p">,</span>  <span class="c1"># marker for bands (for other spin, if present)</span>
            <span class="s2">&quot;bands_markersize2&quot;</span><span class="p">,</span>  <span class="c1"># size of the marker of bands (for other spin, if present)</span>
            <span class="s2">&quot;bands_markeredgecolor2&quot;</span><span class="p">,</span>  <span class="c1"># marker edge color for bands (for other spin, if present)</span>
            <span class="s2">&quot;bands_markeredgewidth2&quot;</span><span class="p">,</span>  <span class="c1"># marker edge width for bands (for other spin, if present)</span>
            <span class="s2">&quot;bands_markerfacecolor2&quot;</span><span class="p">,</span>  <span class="c1"># marker face color for bands (for other spin, if present)</span>
            <span class="s2">&quot;plot_zero_axis&quot;</span><span class="p">,</span>  <span class="c1"># If true, plot an axis at y=0</span>
            <span class="s2">&quot;zero_axis_color&quot;</span><span class="p">,</span>  <span class="c1"># Color of the axis at y=0</span>
            <span class="s2">&quot;zero_axis_linestyle&quot;</span><span class="p">,</span>  <span class="c1"># linestyle of the axis at y=0</span>
            <span class="s2">&quot;zero_axis_linewidth&quot;</span><span class="p">,</span>  <span class="c1"># linewidth of the axis at y=0</span>
            <span class="s2">&quot;use_latex&quot;</span><span class="p">,</span>  <span class="c1"># If true, use latex to render captions</span>
        <span class="p">]</span>

        <span class="c1"># Note: I do not want to import matplotlib here, for two reasons:</span>
        <span class="c1"># 1. I would like to be able to print the script for the user</span>
        <span class="c1"># 2. I don&#39;t want to mess up with the user matplotlib backend</span>
        <span class="c1">#    (that I should do if the user does not have a X server, but that</span>
        <span class="c1">#    I do not want to do if he&#39;s e.g. in jupyter)</span>
        <span class="c1"># Therefore I just create a string that can be executed as needed, e.g. with eval.</span>
        <span class="c1"># I take care of sanitizing the output.</span>
        <span class="k">if</span> <span class="n">prettify_format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Default. Specified like this to allow caller functions to pass &#39;None&#39;</span>
            <span class="n">prettify_format</span> <span class="o">=</span> <span class="s1">&#39;latex_seekpath&#39;</span>

        <span class="c1"># The default for use_latex is False</span>
        <span class="n">join_symbol</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\textbar</span><span class="si">{}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_latex&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;|&quot;</span>

        <span class="n">plot_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bandplot_data</span><span class="p">(</span>
            <span class="n">cartesian</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">prettify_format</span><span class="o">=</span><span class="n">prettify_format</span><span class="p">,</span>
            <span class="n">join_symbol</span><span class="o">=</span><span class="n">join_symbol</span><span class="p">,</span>
            <span class="n">get_segments</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">y_origin</span><span class="o">=</span><span class="n">y_origin</span><span class="p">)</span>

        <span class="n">all_data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">bands</span> <span class="o">=</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span>
        <span class="c1"># prepare xticks labels</span>
        <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
            <span class="n">tick_pos</span><span class="p">,</span> <span class="n">tick_labels</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">labels</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tick_pos</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">tick_labels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#all_data[&#39;bands&#39;] = the_bands.tolist()</span>
        <span class="n">all_data</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">]</span>
        <span class="n">all_data</span><span class="p">[</span><span class="s1">&#39;band_type_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;band_type_idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="c1">#all_data[&#39;x&#39;] = x</span>

        <span class="n">all_data</span><span class="p">[</span><span class="s1">&#39;tick_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tick_pos</span>
        <span class="n">all_data</span><span class="p">[</span><span class="s1">&#39;tick_labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tick_labels</span>
        <span class="n">all_data</span><span class="p">[</span><span class="s1">&#39;legend_text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">legend</span>
        <span class="n">all_data</span><span class="p">[</span><span class="s1">&#39;legend_text2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">legend2</span>
        <span class="n">all_data</span><span class="p">[</span><span class="s1">&#39;yaxis_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Dispersion (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="n">all_data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
        <span class="k">if</span> <span class="n">comments</span><span class="p">:</span>
            <span class="n">all_data</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prepare_header_comment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">plot_info</span><span class="p">,</span> <span class="n">comment_char</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>

        <span class="c1"># axis limits</span>
        <span class="k">if</span> <span class="n">y_max_lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_max_lim</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">y_min_lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_min_lim</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">x_min_lim</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># this isn&#39;t a numpy array, but a list</span>
        <span class="n">x_max_lim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1">#ytick_spacing = 10 ** int(math.log10((y_max_lim - y_min_lim)))</span>
        <span class="n">all_data</span><span class="p">[</span><span class="s1">&#39;x_min_lim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_min_lim</span>
        <span class="n">all_data</span><span class="p">[</span><span class="s1">&#39;x_max_lim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_max_lim</span>
        <span class="n">all_data</span><span class="p">[</span><span class="s1">&#39;y_min_lim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_min_lim</span>
        <span class="n">all_data</span><span class="p">[</span><span class="s1">&#39;y_max_lim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_max_lim</span>
        <span class="c1">#all_data[&#39;ytick_spacing&#39;] = ytick_spacing</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_additional_keywords</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;_matplotlib_get_dict() got an unexpected keyword argument &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="n">all_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">return</span> <span class="n">all_data</span></div>

<div class="viewcode-block" id="BandsData._prepare_mpl_singlefile"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData._prepare_mpl_singlefile">[docs]</a>    <span class="k">def</span> <span class="nf">_prepare_mpl_singlefile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare a python script using matplotlib to plot the bands</span>

<span class="sd">        For the possible parameters, see documentation of</span>
<span class="sd">        :py:meth:`~aiida.orm.nodes.data.array.bands.BandsData._matplotlib_get_dict`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">json</span>

        <span class="n">all_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matplotlib_get_dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">s_header</span> <span class="o">=</span> <span class="n">matplotlib_header_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">()</span>
        <span class="n">s_import</span> <span class="o">=</span> <span class="n">matplotlib_import_data_inline_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">all_data_json</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">all_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">s_body</span> <span class="o">=</span> <span class="n">matplotlib_body_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">()</span>
        <span class="n">s_footer</span> <span class="o">=</span> <span class="n">matplotlib_footer_template_show</span><span class="o">.</span><span class="n">substitute</span><span class="p">()</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">s_header</span> <span class="o">+</span> <span class="n">s_import</span> <span class="o">+</span> <span class="n">s_body</span> <span class="o">+</span> <span class="n">s_footer</span>

        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="BandsData._prepare_mpl_withjson"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData._prepare_mpl_withjson">[docs]</a>    <span class="k">def</span> <span class="nf">_prepare_mpl_withjson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_file_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare a python script using matplotlib to plot the bands, with the JSON</span>
<span class="sd">        returned as an independent file.</span>

<span class="sd">        For the possible parameters, see documentation of</span>
<span class="sd">        :py:meth:`~aiida.orm.nodes.data.array.bands.BandsData._matplotlib_get_dict`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">json</span>

        <span class="n">all_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matplotlib_get_dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">main_file_name</span><span class="o">=</span><span class="n">main_file_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">json_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">main_file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_data.json&quot;</span>
        <span class="c1"># Escape double_quotes</span>
        <span class="n">json_fname</span> <span class="o">=</span> <span class="n">json_fname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">ext_files</span> <span class="o">=</span> <span class="p">{</span><span class="n">json_fname</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">all_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)}</span>

        <span class="n">s_header</span> <span class="o">=</span> <span class="n">matplotlib_header_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">()</span>
        <span class="n">s_import</span> <span class="o">=</span> <span class="n">matplotlib_import_data_fromfile_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">json_fname</span><span class="o">=</span><span class="n">json_fname</span><span class="p">)</span>
        <span class="n">s_body</span> <span class="o">=</span> <span class="n">matplotlib_body_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">()</span>
        <span class="n">s_footer</span> <span class="o">=</span> <span class="n">matplotlib_footer_template_show</span><span class="o">.</span><span class="n">substitute</span><span class="p">()</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">s_header</span> <span class="o">+</span> <span class="n">s_import</span> <span class="o">+</span> <span class="n">s_body</span> <span class="o">+</span> <span class="n">s_footer</span>

        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">ext_files</span></div>

<div class="viewcode-block" id="BandsData._prepare_gnuplot"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData._prepare_gnuplot">[docs]</a>    <span class="k">def</span> <span class="nf">_prepare_gnuplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">main_file_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                         <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                         <span class="n">comments</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">prettify_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">y_max_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">y_min_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">y_origin</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare an gnuplot script to plot the bands, with the .dat file</span>
<span class="sd">        returned as an independent file.</span>

<span class="sd">        :param main_file_name: if the user asks to write the main content on a</span>
<span class="sd">             file, this contains the filename. This should be used to infer a</span>
<span class="sd">             good filename for the additional files.</span>
<span class="sd">             In this case, we remove the extension, and add &#39;_data.dat&#39;</span>
<span class="sd">        :param title: if specified, add a title to the plot</span>
<span class="sd">        :param comments: if True, print comments (if it makes sense for the given</span>
<span class="sd">            format)</span>
<span class="sd">        :param prettify_format: if None, use the default prettify format. Otherwise</span>
<span class="sd">            specify a string with the prettifier to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="n">dat_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">main_file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_data.dat&quot;</span>

        <span class="k">if</span> <span class="n">prettify_format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Default. Specified like this to allow caller functions to pass &#39;None&#39;</span>
            <span class="n">prettify_format</span> <span class="o">=</span> <span class="s1">&#39;gnuplot_seekpath&#39;</span>

        <span class="n">plot_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bandplot_data</span><span class="p">(</span>
            <span class="n">cartesian</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prettify_format</span><span class="o">=</span><span class="n">prettify_format</span><span class="p">,</span> <span class="n">join_symbol</span><span class="o">=</span><span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="n">y_origin</span><span class="o">=</span><span class="n">y_origin</span><span class="p">)</span>

        <span class="n">bands</span> <span class="o">=</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span>

        <span class="n">num_labels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">num_bands</span> <span class="o">=</span> <span class="n">bands</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># axis limits</span>
        <span class="k">if</span> <span class="n">y_max_lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_max_lim</span> <span class="o">=</span> <span class="n">bands</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">y_min_lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_min_lim</span> <span class="o">=</span> <span class="n">bands</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">x_min_lim</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># this isn&#39;t a numpy array, but a list</span>
        <span class="n">x_max_lim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># first prepare the xy coordinates of the sets</span>
        <span class="n">raw_data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_dat_blocks</span><span class="p">(</span><span class="n">plot_info</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="n">comments</span><span class="p">)</span>

        <span class="n">xtics_string</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">])</span>

        <span class="n">script</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Start with some useful comments</span>

        <span class="k">if</span> <span class="n">comments</span><span class="p">:</span>
            <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prepare_header_comment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">plot_info</span><span class="o">=</span><span class="n">plot_info</span><span class="p">,</span> <span class="n">comment_char</span><span class="o">=</span><span class="s2">&quot;# &quot;</span><span class="p">))</span>
        <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;&quot;&quot;## Uncomment the next two lines to write directly to PDF</span>
<span class="s2">## Note: You need to have gnuplot installed with pdfcairo support!</span>
<span class="s2">#set term pdfcairo</span>
<span class="s2">#set output &#39;out.pdf&#39;</span>

<span class="s2">### Uncomment one of the options below to change font</span>
<span class="s2">### For the LaTeX fonts, you can download them from here:</span>
<span class="s2">### https://sourceforge.net/projects/cm-unicode/</span>
<span class="s2">### And then install them in your system</span>
<span class="s2">## LaTeX Serif font, if installed</span>
<span class="s2">#set termopt font &quot;CMU Serif, 12&quot;</span>
<span class="s2">## LaTeX Sans Serif font, if installed</span>
<span class="s2">#set termopt font &quot;CMU Sans Serif, 12&quot;</span>
<span class="s2">## Classical Times New Roman</span>
<span class="s2">#set termopt font &quot;Times New Roman, 12&quot;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Actual logic</span>
        <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;set termopt enhanced&#39;</span><span class="p">)</span>  <span class="c1"># Properly deals with e.g. subscripts</span>
        <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;set encoding utf8&#39;</span><span class="p">)</span>  <span class="c1"># To deal with Greek letters</span>
        <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;set xtics (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xtics_string</span><span class="p">))</span>
        <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;set grid xtics lt 1 lc rgb &quot;#888888&quot;&#39;</span><span class="p">)</span>

        <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;unset key&#39;</span><span class="p">)</span>

        <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;set xrange [</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x_min_lim</span><span class="p">,</span> <span class="n">x_max_lim</span><span class="p">))</span>
        <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;set yrange [</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y_min_lim</span><span class="p">,</span> <span class="n">y_max_lim</span><span class="p">))</span>

        <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;set ylabel &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;Dispersion (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;set title &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">)))</span>

        <span class="c1"># Plot, escaping filename</span>
        <span class="n">script</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;plot &quot;</span><span class="si">{}</span><span class="s1">&quot; with l lc rgb &quot;#000000&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dat_filename</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">)))</span>

        <span class="n">script_data</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script</span><span class="p">)</span> <span class="o">+</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">extra_files</span> <span class="o">=</span> <span class="p">{</span><span class="n">dat_filename</span><span class="p">:</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)}</span>

        <span class="k">return</span> <span class="n">script_data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">extra_files</span></div>

<div class="viewcode-block" id="BandsData._prepare_mpl_pdf"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData._prepare_mpl_pdf">[docs]</a>    <span class="k">def</span> <span class="nf">_prepare_mpl_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_file_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare a python script using matplotlib to plot the bands, with the JSON</span>
<span class="sd">        returned as an independent file.</span>

<span class="sd">        For the possible parameters, see documentation of</span>
<span class="sd">        :py:meth:`~aiida.orm.nodes.data.array.bands.BandsData._matplotlib_get_dict`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="kn">import</span> <span class="nn">sys</span>

        <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">json</span>

        <span class="n">all_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matplotlib_get_dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Use the Agg backend</span>
        <span class="n">s_header</span> <span class="o">=</span> <span class="n">matplotlib_header_agg_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">()</span>
        <span class="n">s_import</span> <span class="o">=</span> <span class="n">matplotlib_import_data_inline_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">all_data_json</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">all_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">s_body</span> <span class="o">=</span> <span class="n">matplotlib_body_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">()</span>

        <span class="c1"># I get a temporary file name</span>
        <span class="n">handle</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">escaped_fname</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">s_footer</span> <span class="o">=</span> <span class="n">matplotlib_footer_template_exportfile</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">escaped_fname</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">s_header</span> <span class="o">+</span> <span class="n">s_import</span> <span class="o">+</span> <span class="n">s_body</span> <span class="o">+</span> <span class="n">s_footer</span>

        <span class="c1"># I don&#39;t exec it because I might mess up with the matplotlib backend etc.</span>
        <span class="c1"># I run instead in a different process, with the same executable</span>
        <span class="c1"># (so it should work properly with virtualenvs)</span>
        <span class="c1">#exec s</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unable to generate the PDF...&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">imgdata</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">imgdata</span><span class="p">,</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="BandsData._prepare_mpl_png"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData._prepare_mpl_png">[docs]</a>    <span class="k">def</span> <span class="nf">_prepare_mpl_png</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_file_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare a python script using matplotlib to plot the bands, with the JSON</span>
<span class="sd">        returned as an independent file.</span>

<span class="sd">        For the possible parameters, see documentation of</span>
<span class="sd">        :py:meth:`~aiida.orm.nodes.data.array.bands.BandsData._matplotlib_get_dict`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">json</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="kn">import</span> <span class="nn">sys</span>

        <span class="n">all_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matplotlib_get_dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Use the Agg backend</span>
        <span class="n">s_header</span> <span class="o">=</span> <span class="n">matplotlib_header_agg_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">()</span>
        <span class="n">s_import</span> <span class="o">=</span> <span class="n">matplotlib_import_data_inline_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">all_data_json</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">all_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">s_body</span> <span class="o">=</span> <span class="n">matplotlib_body_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">()</span>

        <span class="c1"># I get a temporary file name</span>
        <span class="n">handle</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">escaped_fname</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">s_footer</span> <span class="o">=</span> <span class="n">matplotlib_footer_template_exportfile_with_dpi</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">escaped_fname</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">s_header</span> <span class="o">+</span> <span class="n">s_import</span> <span class="o">+</span> <span class="n">s_body</span> <span class="o">+</span> <span class="n">s_footer</span>

        <span class="c1"># I don&#39;t exec it because I might mess up with the matplotlib backend etc.</span>
        <span class="c1"># I run instead in a different process, with the same executable</span>
        <span class="c1"># (so it should work properly with virtualenvs)</span>
        <span class="c1">#exec s</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unable to generate the PNG...&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">imgdata</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">imgdata</span><span class="p">,</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="BandsData.show_mpl"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData.show_mpl">[docs]</a>    <span class="k">def</span> <span class="nf">show_mpl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call a show() command for the band structure using matplotlib.</span>
<span class="sd">        This uses internally the &#39;mpl_singlefile&#39; format, with empty</span>
<span class="sd">        main_file_name.</span>
<span class="sd">        </span>
<span class="sd">        Other kwargs are passed to self._exportcontent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># In Python 2, exec is a statement which was extended to also take a tuple, while Python 3&#39;s exec</span>
        <span class="c1"># is a real function. We could unpack the tuple into arguments in Python 3 as follows:</span>
        <span class="c1">#    exec(*self._exportcontent(...))</span>
        <span class="c1"># but this does not work in Python 2. But it is anyway clearer to explicitly unpack the 2-tuple instead.</span>
        <span class="n">code_obj</span><span class="p">,</span> <span class="n">code_globals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exportcontent</span><span class="p">(</span><span class="n">fileformat</span><span class="o">=</span><span class="s1">&#39;mpl_singlefile&#39;</span><span class="p">,</span> <span class="n">main_file_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">exec</span> <span class="p">(</span><span class="n">code_obj</span><span class="p">,</span> <span class="n">code_globals</span><span class="p">)</span>  <span class="c1"># pylint: disable=exec-used</span></div>

<div class="viewcode-block" id="BandsData._prepare_agr"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData._prepare_agr">[docs]</a>    <span class="k">def</span> <span class="nf">_prepare_agr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">main_file_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                     <span class="n">comments</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">setnumber_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                     <span class="n">color_number</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">color_number2</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                     <span class="n">legend</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                     <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                     <span class="n">y_max_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">y_min_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">y_origin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                     <span class="n">prettify_format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare an xmgrace agr file.</span>

<span class="sd">        :param comments: if True, print comments </span>
<span class="sd">            (if it makes sense for the given format)</span>
<span class="sd">        :param plot_info: a dictionary</span>
<span class="sd">        :param setnumber_offset: an offset to be applied to all set numbers</span>
<span class="sd">            (i.e. s0 is replaced by s[offset], s1 by s[offset+1], etc.)</span>
<span class="sd">        :param color_number: the color number for lines, symbols, error bars</span>
<span class="sd">            and filling (should be less than the parameter max_num_agr_colors</span>
<span class="sd">            defined below)</span>
<span class="sd">        :param color_number2: the color number for lines, symbols, error bars</span>
<span class="sd">            and filling for the second-type spins (should be less than the</span>
<span class="sd">            parameter max_num_agr_colors defined below)</span>
<span class="sd">        :param legend: the legend (applied only to the first set)</span>
<span class="sd">        :param title: the title</span>
<span class="sd">        :param y_max_lim: the maximum on the y axis (if None, put the</span>
<span class="sd">            maximum of the bands); applied *after* shifting the origin</span>
<span class="sd">            by ``y_origin``</span>
<span class="sd">        :param y_min_lim: the minimum on the y axis (if None, put the</span>
<span class="sd">            minimum of the bands); applied *after* shifting the origin</span>
<span class="sd">            by ``y_origin``</span>
<span class="sd">        :param y_origin: the new origin of the y axis -&gt; all bands are replaced</span>
<span class="sd">            by bands-y_origin</span>
<span class="sd">        :param prettify_format: if None, use the default prettify format. Otherwise</span>
<span class="sd">            specify a string with the prettifier to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">prettify_format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Default. Specified like this to allow caller functions to pass &#39;None&#39;</span>
            <span class="n">prettify_format</span> <span class="o">=</span> <span class="s1">&#39;agr_seekpath&#39;</span>

        <span class="n">plot_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bandplot_data</span><span class="p">(</span>
            <span class="n">cartesian</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prettify_format</span><span class="o">=</span><span class="n">prettify_format</span><span class="p">,</span> <span class="n">join_symbol</span><span class="o">=</span><span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="n">y_origin</span><span class="o">=</span><span class="n">y_origin</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">math</span>
        <span class="c1"># load the x and y of every set</span>
        <span class="k">if</span> <span class="n">color_number</span> <span class="o">&gt;</span> <span class="n">max_num_agr_colors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Color number is too high (should be less than </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_num_agr_colors</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">color_number2</span> <span class="o">&gt;</span> <span class="n">max_num_agr_colors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Color number 2 is too high (should be less than </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_num_agr_colors</span><span class="p">))</span>

        <span class="n">bands</span> <span class="o">=</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">the_bands</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span>
        <span class="n">num_labels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

        <span class="c1"># axis limits</span>
        <span class="k">if</span> <span class="n">y_max_lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_max_lim</span> <span class="o">=</span> <span class="n">the_bands</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">y_min_lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_min_lim</span> <span class="o">=</span> <span class="n">the_bands</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">x_min_lim</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># this isn&#39;t a numpy array, but a list</span>
        <span class="n">x_max_lim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">ytick_spacing</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">((</span><span class="n">y_max_lim</span> <span class="o">-</span> <span class="n">y_min_lim</span><span class="p">)))</span>

        <span class="c1"># prepare xticks labels</span>
        <span class="n">sx1</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
            <span class="n">sx1</span> <span class="o">+=</span> <span class="n">agr_single_xtick_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span>
                <span class="n">index</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                <span class="n">coord</span><span class="o">=</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">name</span><span class="o">=</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="n">xticks</span> <span class="o">=</span> <span class="n">agr_xticks_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span>
            <span class="n">num_labels</span><span class="o">=</span><span class="n">num_labels</span><span class="p">,</span>
            <span class="n">single_xtick_templates</span><span class="o">=</span><span class="n">sx1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># build the arrays with the xy coordinates</span>
        <span class="n">all_sets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">the_bands</span><span class="p">:</span>
            <span class="n">this_set</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">this_set</span> <span class="o">+=</span> <span class="n">line</span>
            <span class="n">all_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_set</span><span class="p">)</span>

        <span class="n">set_descriptions</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">this_set</span><span class="p">,</span> <span class="n">band_type</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">all_sets</span><span class="p">,</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;band_type_idx&#39;</span><span class="p">])):</span>
            <span class="k">if</span> <span class="n">band_type</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">linecolor</span> <span class="o">=</span> <span class="n">color_number</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">linecolor</span> <span class="o">=</span> <span class="n">color_number2</span>
            <span class="n">width</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="n">set_descriptions</span> <span class="o">+=</span> <span class="n">agr_set_description_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span>
                <span class="n">set_number</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="n">setnumber_offset</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
                <span class="n">color_number</span><span class="o">=</span><span class="n">linecolor</span><span class="p">,</span>
                <span class="n">legend</span><span class="o">=</span><span class="n">legend</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span>

        <span class="n">graphs</span> <span class="o">=</span> <span class="n">agr_graph_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span>
            <span class="n">x_min_lim</span><span class="o">=</span><span class="n">x_min_lim</span><span class="p">,</span>
            <span class="n">y_min_lim</span><span class="o">=</span><span class="n">y_min_lim</span><span class="p">,</span>
            <span class="n">x_max_lim</span><span class="o">=</span><span class="n">x_max_lim</span><span class="p">,</span>
            <span class="n">y_max_lim</span><span class="o">=</span><span class="n">y_max_lim</span><span class="p">,</span>
            <span class="n">yaxislabel</span><span class="o">=</span><span class="s2">&quot;Dispersion (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="p">),</span>
            <span class="n">xticks_template</span><span class="o">=</span><span class="n">xticks</span><span class="p">,</span>
            <span class="n">set_descriptions</span><span class="o">=</span><span class="n">set_descriptions</span><span class="p">,</span>
            <span class="n">ytick_spacing</span><span class="o">=</span><span class="n">ytick_spacing</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">sets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">this_set</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_sets</span><span class="p">):</span>
            <span class="n">sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agr_singleset_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">set_number</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="n">setnumber_offset</span><span class="p">,</span> <span class="n">xydata</span><span class="o">=</span><span class="n">this_set</span><span class="p">))</span>
        <span class="n">the_sets</span> <span class="o">=</span> <span class="s2">&quot;&amp;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sets</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">agr_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">graphs</span><span class="o">=</span><span class="n">graphs</span><span class="p">,</span> <span class="n">sets</span><span class="o">=</span><span class="n">the_sets</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">comments</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">prepare_header_comment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">plot_info</span><span class="p">,</span> <span class="n">comment_char</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">s</span>

        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="BandsData._get_band_segments"><a class="viewcode-back" href="../../../../../../apidoc/aiida.orm.nodes.data.array.html#aiida.orm.BandsData._get_band_segments">[docs]</a>    <span class="k">def</span> <span class="nf">_get_band_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cartesian</span><span class="p">):</span>
        <span class="n">plot_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bandplot_data</span><span class="p">(</span>
            <span class="n">cartesian</span><span class="o">=</span><span class="n">cartesian</span><span class="p">,</span> <span class="n">prettify_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">join_symbol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">get_segments</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">}</span>

        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">out_dict</span></div>

<div class="viewcode-block" id="BandsData._prepare_json"><a class="viewcode-back" href="../../../../../../developer_guide/core/orm_overview.html#aiida.orm.BandsData._prepare_json">[docs]</a>    <span class="k">def</span> <span class="nf">_prepare_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_file_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare a json file in a format compatible with the AiiDA band visualizer</span>

<span class="sd">        :param comments: if True, print comments (if it makes sense for the given</span>
<span class="sd">            format)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida</span> <span class="k">import</span> <span class="n">get_file_header</span>
        <span class="kn">from</span> <span class="nn">aiida.common</span> <span class="k">import</span> <span class="n">json</span>

        <span class="n">json_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_band_segments</span><span class="p">(</span><span class="n">cartesian</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;original_uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span>

        <span class="k">if</span> <span class="n">comments</span><span class="p">:</span>
            <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_file_header</span><span class="p">(</span><span class="n">comment_char</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_dict</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="p">{}</span></div></div>


<span class="n">max_num_agr_colors</span> <span class="o">=</span> <span class="mi">15</span>

<span class="n">agr_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # Grace project file</span>
<span class="s2">    #</span>
<span class="s2">    @version 50122</span>
<span class="s2">    @page size 792, 612</span>
<span class="s2">    @page scroll 5%</span>
<span class="s2">    @page inout 5%</span>
<span class="s2">    @link page off</span>
<span class="s2">    @map font 8 to &quot;Courier&quot;, &quot;Courier&quot;</span>
<span class="s2">    @map font 10 to &quot;Courier-Bold&quot;, &quot;Courier-Bold&quot;</span>
<span class="s2">    @map font 11 to &quot;Courier-BoldOblique&quot;, &quot;Courier-BoldOblique&quot;</span>
<span class="s2">    @map font 9 to &quot;Courier-Oblique&quot;, &quot;Courier-Oblique&quot;</span>
<span class="s2">    @map font 4 to &quot;Helvetica&quot;, &quot;Helvetica&quot;</span>
<span class="s2">    @map font 6 to &quot;Helvetica-Bold&quot;, &quot;Helvetica-Bold&quot;</span>
<span class="s2">    @map font 7 to &quot;Helvetica-BoldOblique&quot;, &quot;Helvetica-BoldOblique&quot;</span>
<span class="s2">    @map font 5 to &quot;Helvetica-Oblique&quot;, &quot;Helvetica-Oblique&quot;</span>
<span class="s2">    @map font 14 to &quot;NimbusMonoL-BoldOblique&quot;, &quot;NimbusMonoL-BoldOblique&quot;</span>
<span class="s2">    @map font 15 to &quot;NimbusMonoL-Regular&quot;, &quot;NimbusMonoL-Regular&quot;</span>
<span class="s2">    @map font 16 to &quot;NimbusMonoL-RegularOblique&quot;, &quot;NimbusMonoL-RegularOblique&quot;</span>
<span class="s2">    @map font 17 to &quot;NimbusRomanNo9L-Medium&quot;, &quot;NimbusRomanNo9L-Medium&quot;</span>
<span class="s2">    @map font 18 to &quot;NimbusRomanNo9L-MediumItalic&quot;, &quot;NimbusRomanNo9L-MediumItalic&quot;</span>
<span class="s2">    @map font 19 to &quot;NimbusRomanNo9L-Regular&quot;, &quot;NimbusRomanNo9L-Regular&quot;</span>
<span class="s2">    @map font 20 to &quot;NimbusRomanNo9L-RegularItalic&quot;, &quot;NimbusRomanNo9L-RegularItalic&quot;</span>
<span class="s2">    @map font 21 to &quot;NimbusSansL-Bold&quot;, &quot;NimbusSansL-Bold&quot;</span>
<span class="s2">    @map font 22 to &quot;NimbusSansL-BoldCondensed&quot;, &quot;NimbusSansL-BoldCondensed&quot;</span>
<span class="s2">    @map font 23 to &quot;NimbusSansL-BoldCondensedItalic&quot;, &quot;NimbusSansL-BoldCondensedItalic&quot;</span>
<span class="s2">    @map font 24 to &quot;NimbusSansL-BoldItalic&quot;, &quot;NimbusSansL-BoldItalic&quot;</span>
<span class="s2">    @map font 25 to &quot;NimbusSansL-Regular&quot;, &quot;NimbusSansL-Regular&quot;</span>
<span class="s2">    @map font 26 to &quot;NimbusSansL-RegularCondensed&quot;, &quot;NimbusSansL-RegularCondensed&quot;</span>
<span class="s2">    @map font 27 to &quot;NimbusSansL-RegularCondensedItalic&quot;, &quot;NimbusSansL-RegularCondensedItalic&quot;</span>
<span class="s2">    @map font 28 to &quot;NimbusSansL-RegularItalic&quot;, &quot;NimbusSansL-RegularItalic&quot;</span>
<span class="s2">    @map font 29 to &quot;StandardSymbolsL-Regular&quot;, &quot;StandardSymbolsL-Regular&quot;</span>
<span class="s2">    @map font 12 to &quot;Symbol&quot;, &quot;Symbol&quot;</span>
<span class="s2">    @map font 31 to &quot;Symbol-Regular&quot;, &quot;Symbol-Regular&quot;</span>
<span class="s2">    @map font 2 to &quot;Times-Bold&quot;, &quot;Times-Bold&quot;</span>
<span class="s2">    @map font 3 to &quot;Times-BoldItalic&quot;, &quot;Times-BoldItalic&quot;</span>
<span class="s2">    @map font 1 to &quot;Times-Italic&quot;, &quot;Times-Italic&quot;</span>
<span class="s2">    @map font 0 to &quot;Times-Roman&quot;, &quot;Times-Roman&quot;</span>
<span class="s2">    @map font 36 to &quot;URWBookmanL-DemiBold&quot;, &quot;URWBookmanL-DemiBold&quot;</span>
<span class="s2">    @map font 37 to &quot;URWBookmanL-DemiBoldItalic&quot;, &quot;URWBookmanL-DemiBoldItalic&quot;</span>
<span class="s2">    @map font 38 to &quot;URWBookmanL-Light&quot;, &quot;URWBookmanL-Light&quot;</span>
<span class="s2">    @map font 39 to &quot;URWBookmanL-LightItalic&quot;, &quot;URWBookmanL-LightItalic&quot;</span>
<span class="s2">    @map font 40 to &quot;URWChanceryL-MediumItalic&quot;, &quot;URWChanceryL-MediumItalic&quot;</span>
<span class="s2">    @map font 41 to &quot;URWGothicL-Book&quot;, &quot;URWGothicL-Book&quot;</span>
<span class="s2">    @map font 42 to &quot;URWGothicL-BookOblique&quot;, &quot;URWGothicL-BookOblique&quot;</span>
<span class="s2">    @map font 43 to &quot;URWGothicL-Demi&quot;, &quot;URWGothicL-Demi&quot;</span>
<span class="s2">    @map font 44 to &quot;URWGothicL-DemiOblique&quot;, &quot;URWGothicL-DemiOblique&quot;</span>
<span class="s2">    @map font 45 to &quot;URWPalladioL-Bold&quot;, &quot;URWPalladioL-Bold&quot;</span>
<span class="s2">    @map font 46 to &quot;URWPalladioL-BoldItalic&quot;, &quot;URWPalladioL-BoldItalic&quot;</span>
<span class="s2">    @map font 47 to &quot;URWPalladioL-Italic&quot;, &quot;URWPalladioL-Italic&quot;</span>
<span class="s2">    @map font 48 to &quot;URWPalladioL-Roman&quot;, &quot;URWPalladioL-Roman&quot;</span>
<span class="s2">    @map font 13 to &quot;ZapfDingbats&quot;, &quot;ZapfDingbats&quot;</span>
<span class="s2">    @map color 0 to (255, 255, 255), &quot;white&quot;</span>
<span class="s2">    @map color 1 to (0, 0, 0), &quot;black&quot;</span>
<span class="s2">    @map color 2 to (255, 0, 0), &quot;red&quot;</span>
<span class="s2">    @map color 3 to (0, 255, 0), &quot;green&quot;</span>
<span class="s2">    @map color 4 to (0, 0, 255), &quot;blue&quot;</span>
<span class="s2">    @map color 5 to (255, 215, 0), &quot;yellow&quot;</span>
<span class="s2">    @map color 6 to (188, 143, 143), &quot;brown&quot;</span>
<span class="s2">    @map color 7 to (220, 220, 220), &quot;grey&quot;</span>
<span class="s2">    @map color 8 to (148, 0, 211), &quot;violet&quot;</span>
<span class="s2">    @map color 9 to (0, 255, 255), &quot;cyan&quot;</span>
<span class="s2">    @map color 10 to (255, 0, 255), &quot;magenta&quot;</span>
<span class="s2">    @map color 11 to (255, 165, 0), &quot;orange&quot;</span>
<span class="s2">    @map color 12 to (114, 33, 188), &quot;indigo&quot;</span>
<span class="s2">    @map color 13 to (103, 7, 72), &quot;maroon&quot;</span>
<span class="s2">    @map color 14 to (64, 224, 208), &quot;turquoise&quot;</span>
<span class="s2">    @map color 15 to (0, 139, 0), &quot;green4&quot;</span>
<span class="s2">    @reference date 0</span>
<span class="s2">    @date wrap off</span>
<span class="s2">    @date wrap year 1950</span>
<span class="s2">    @default linewidth 1.0</span>
<span class="s2">    @default linestyle 1</span>
<span class="s2">    @default color 1</span>
<span class="s2">    @default pattern 1</span>
<span class="s2">    @default font 0</span>
<span class="s2">    @default char size 1.000000</span>
<span class="s2">    @default symbol size 1.000000</span>
<span class="s2">    @default sformat &quot;</span><span class="si">%.8g</span><span class="s2">&quot;</span>
<span class="s2">    @background color 0</span>
<span class="s2">    @page background fill on</span>
<span class="s2">    @timestamp off</span>
<span class="s2">    @timestamp 0.03, 0.03</span>
<span class="s2">    @timestamp color 1</span>
<span class="s2">    @timestamp rot 0</span>
<span class="s2">    @timestamp font 0</span>
<span class="s2">    @timestamp char size 1.000000</span>
<span class="s2">    @timestamp def &quot;Wed Jul 30 16:44:34 2014&quot;</span>
<span class="s2">    @r0 off</span>
<span class="s2">    @link r0 to g0</span>
<span class="s2">    @r0 type above</span>
<span class="s2">    @r0 linestyle 1</span>
<span class="s2">    @r0 linewidth 1.0</span>
<span class="s2">    @r0 color 1</span>
<span class="s2">    @r0 line 0, 0, 0, 0</span>
<span class="s2">    @r1 off</span>
<span class="s2">    @link r1 to g0</span>
<span class="s2">    @r1 type above</span>
<span class="s2">    @r1 linestyle 1</span>
<span class="s2">    @r1 linewidth 1.0</span>
<span class="s2">    @r1 color 1</span>
<span class="s2">    @r1 line 0, 0, 0, 0</span>
<span class="s2">    @r2 off</span>
<span class="s2">    @link r2 to g0</span>
<span class="s2">    @r2 type above</span>
<span class="s2">    @r2 linestyle 1</span>
<span class="s2">    @r2 linewidth 1.0</span>
<span class="s2">    @r2 color 1</span>
<span class="s2">    @r2 line 0, 0, 0, 0</span>
<span class="s2">    @r3 off</span>
<span class="s2">    @link r3 to g0</span>
<span class="s2">    @r3 type above</span>
<span class="s2">    @r3 linestyle 1</span>
<span class="s2">    @r3 linewidth 1.0</span>
<span class="s2">    @r3 color 1</span>
<span class="s2">    @r3 line 0, 0, 0, 0</span>
<span class="s2">    @r4 off</span>
<span class="s2">    @link r4 to g0</span>
<span class="s2">    @r4 type above</span>
<span class="s2">    @r4 linestyle 1</span>
<span class="s2">    @r4 linewidth 1.0</span>
<span class="s2">    @r4 color 1</span>
<span class="s2">    @r4 line 0, 0, 0, 0</span>
<span class="s2">    $graphs</span>
<span class="s2">    $sets</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">agr_xticks_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    @    xaxis  tick spec $num_labels</span>
<span class="s2">    $single_xtick_templates</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">agr_single_xtick_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    @    xaxis  tick major $index, $coord</span>
<span class="s2">    @    xaxis  ticklabel $index, &quot;$name&quot;</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">agr_graph_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    @g0 on</span>
<span class="s2">    @g0 hidden false</span>
<span class="s2">    @g0 type XY</span>
<span class="s2">    @g0 stacked false</span>
<span class="s2">    @g0 bar hgap 0.000000</span>
<span class="s2">    @g0 fixedpoint off</span>
<span class="s2">    @g0 fixedpoint type 0</span>
<span class="s2">    @g0 fixedpoint xy 0.000000, 0.000000</span>
<span class="s2">    @g0 fixedpoint format general general</span>
<span class="s2">    @g0 fixedpoint prec 6, 6</span>
<span class="s2">    @with g0</span>
<span class="s2">    @    world $x_min_lim, $y_min_lim, $x_max_lim, $y_max_lim</span>
<span class="s2">    @    stack world 0, 0, 0, 0</span>
<span class="s2">    @    znorm 1</span>
<span class="s2">    @    view 0.150000, 0.150000, 1.150000, 0.850000</span>
<span class="s2">    @    title &quot;$title&quot;</span>
<span class="s2">    @    title font 0</span>
<span class="s2">    @    title size 1.500000</span>
<span class="s2">    @    title color 1</span>
<span class="s2">    @    subtitle &quot;&quot;</span>
<span class="s2">    @    subtitle font 0</span>
<span class="s2">    @    subtitle size 1.000000</span>
<span class="s2">    @    subtitle color 1</span>
<span class="s2">    @    xaxes scale Normal</span>
<span class="s2">    @    yaxes scale Normal</span>
<span class="s2">    @    xaxes invert off</span>
<span class="s2">    @    yaxes invert off</span>
<span class="s2">    @    xaxis  on</span>
<span class="s2">    @    xaxis  type zero false</span>
<span class="s2">    @    xaxis  offset 0.000000 , 0.000000</span>
<span class="s2">    @    xaxis  bar on</span>
<span class="s2">    @    xaxis  bar color 1</span>
<span class="s2">    @    xaxis  bar linestyle 1</span>
<span class="s2">    @    xaxis  bar linewidth 1.0</span>
<span class="s2">    @    xaxis  label &quot;&quot;</span>
<span class="s2">    @    xaxis  label layout para</span>
<span class="s2">    @    xaxis  label place auto</span>
<span class="s2">    @    xaxis  label char size 1.000000</span>
<span class="s2">    @    xaxis  label font 4</span>
<span class="s2">    @    xaxis  label color 1</span>
<span class="s2">    @    xaxis  label place normal</span>
<span class="s2">    @    xaxis  tick on</span>
<span class="s2">    @    xaxis  tick major 5</span>
<span class="s2">    @    xaxis  tick minor ticks 0</span>
<span class="s2">    @    xaxis  tick default 6</span>
<span class="s2">    @    xaxis  tick place rounded true</span>
<span class="s2">    @    xaxis  tick in</span>
<span class="s2">    @    xaxis  tick major size 1.000000</span>
<span class="s2">    @    xaxis  tick major color 1</span>
<span class="s2">    @    xaxis  tick major linewidth 1.0</span>
<span class="s2">    @    xaxis  tick major linestyle 1</span>
<span class="s2">    @    xaxis  tick major grid on</span>
<span class="s2">    @    xaxis  tick minor color 1</span>
<span class="s2">    @    xaxis  tick minor linewidth 1.0</span>
<span class="s2">    @    xaxis  tick minor linestyle 1</span>
<span class="s2">    @    xaxis  tick minor grid off</span>
<span class="s2">    @    xaxis  tick minor size 0.500000</span>
<span class="s2">    @    xaxis  ticklabel on</span>
<span class="s2">    @    xaxis  ticklabel format general</span>
<span class="s2">    @    xaxis  ticklabel prec 5</span>
<span class="s2">    @    xaxis  ticklabel formula &quot;&quot;</span>
<span class="s2">    @    xaxis  ticklabel append &quot;&quot;</span>
<span class="s2">    @    xaxis  ticklabel prepend &quot;&quot;</span>
<span class="s2">    @    xaxis  ticklabel angle 0</span>
<span class="s2">    @    xaxis  ticklabel skip 0</span>
<span class="s2">    @    xaxis  ticklabel stagger 0</span>
<span class="s2">    @    xaxis  ticklabel place normal</span>
<span class="s2">    @    xaxis  ticklabel offset auto</span>
<span class="s2">    @    xaxis  ticklabel offset 0.000000 , 0.010000</span>
<span class="s2">    @    xaxis  ticklabel start type auto</span>
<span class="s2">    @    xaxis  ticklabel start 0.000000</span>
<span class="s2">    @    xaxis  ticklabel stop type auto</span>
<span class="s2">    @    xaxis  ticklabel stop 0.000000</span>
<span class="s2">    @    xaxis  ticklabel char size 1.500000</span>
<span class="s2">    @    xaxis  ticklabel font 4</span>
<span class="s2">    @    xaxis  ticklabel color 1</span>
<span class="s2">    @    xaxis  tick place both</span>
<span class="s2">    @    xaxis  tick spec type both</span>
<span class="s2">    $xticks_template</span>
<span class="s2">    @    yaxis  on</span>
<span class="s2">    @    yaxis  type zero false</span>
<span class="s2">    @    yaxis  offset 0.000000 , 0.000000</span>
<span class="s2">    @    yaxis  bar on</span>
<span class="s2">    @    yaxis  bar color 1</span>
<span class="s2">    @    yaxis  bar linestyle 1</span>
<span class="s2">    @    yaxis  bar linewidth 1.0</span>
<span class="s2">    @    yaxis  label &quot;$yaxislabel&quot;</span>
<span class="s2">    @    yaxis  label layout para</span>
<span class="s2">    @    yaxis  label place auto</span>
<span class="s2">    @    yaxis  label char size 1.500000</span>
<span class="s2">    @    yaxis  label font 4</span>
<span class="s2">    @    yaxis  label color 1</span>
<span class="s2">    @    yaxis  label place normal</span>
<span class="s2">    @    yaxis  tick on</span>
<span class="s2">    @    yaxis  tick major $ytick_spacing</span>
<span class="s2">    @    yaxis  tick minor ticks 1</span>
<span class="s2">    @    yaxis  tick default 6</span>
<span class="s2">    @    yaxis  tick place rounded true</span>
<span class="s2">    @    yaxis  tick in</span>
<span class="s2">    @    yaxis  tick major size 1.000000</span>
<span class="s2">    @    yaxis  tick major color 1</span>
<span class="s2">    @    yaxis  tick major linewidth 1.0</span>
<span class="s2">    @    yaxis  tick major linestyle 1</span>
<span class="s2">    @    yaxis  tick major grid off</span>
<span class="s2">    @    yaxis  tick minor color 1</span>
<span class="s2">    @    yaxis  tick minor linewidth 1.0</span>
<span class="s2">    @    yaxis  tick minor linestyle 1</span>
<span class="s2">    @    yaxis  tick minor grid off</span>
<span class="s2">    @    yaxis  tick minor size 0.500000</span>
<span class="s2">    @    yaxis  ticklabel on</span>
<span class="s2">    @    yaxis  ticklabel format general</span>
<span class="s2">    @    yaxis  ticklabel prec 5</span>
<span class="s2">    @    yaxis  ticklabel formula &quot;&quot;</span>
<span class="s2">    @    yaxis  ticklabel append &quot;&quot;</span>
<span class="s2">    @    yaxis  ticklabel prepend &quot;&quot;</span>
<span class="s2">    @    yaxis  ticklabel angle 0</span>
<span class="s2">    @    yaxis  ticklabel skip 0</span>
<span class="s2">    @    yaxis  ticklabel stagger 0</span>
<span class="s2">    @    yaxis  ticklabel place normal</span>
<span class="s2">    @    yaxis  ticklabel offset auto</span>
<span class="s2">    @    yaxis  ticklabel offset 0.000000 , 0.010000</span>
<span class="s2">    @    yaxis  ticklabel start type auto</span>
<span class="s2">    @    yaxis  ticklabel start 0.000000</span>
<span class="s2">    @    yaxis  ticklabel stop type auto</span>
<span class="s2">    @    yaxis  ticklabel stop 0.000000</span>
<span class="s2">    @    yaxis  ticklabel char size 1.250000</span>
<span class="s2">    @    yaxis  ticklabel font 4</span>
<span class="s2">    @    yaxis  ticklabel color 1</span>
<span class="s2">    @    yaxis  tick place both</span>
<span class="s2">    @    yaxis  tick spec type none</span>
<span class="s2">    @    altxaxis  off</span>
<span class="s2">    @    altyaxis  off</span>
<span class="s2">    @    legend on</span>
<span class="s2">    @    legend loctype view</span>
<span class="s2">    @    legend 0.85, 0.8</span>
<span class="s2">    @    legend box color 1</span>
<span class="s2">    @    legend box pattern 1</span>
<span class="s2">    @    legend box linewidth 1.0</span>
<span class="s2">    @    legend box linestyle 1</span>
<span class="s2">    @    legend box fill color 0</span>
<span class="s2">    @    legend box fill pattern 1</span>
<span class="s2">    @    legend font 0</span>
<span class="s2">    @    legend char size 1.000000</span>
<span class="s2">    @    legend color 1</span>
<span class="s2">    @    legend length 4</span>
<span class="s2">    @    legend vgap 1</span>
<span class="s2">    @    legend hgap 1</span>
<span class="s2">    @    legend invert false</span>
<span class="s2">    @    frame type 0</span>
<span class="s2">    @    frame linestyle 1</span>
<span class="s2">    @    frame linewidth 1.0</span>
<span class="s2">    @    frame color 1</span>
<span class="s2">    @    frame pattern 1</span>
<span class="s2">    @    frame background color 0</span>
<span class="s2">    @    frame background pattern 0</span>
<span class="s2">    $set_descriptions</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">agr_set_description_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    @    s$set_number hidden false</span>
<span class="s2">    @    s$set_number type xy</span>
<span class="s2">    @    s$set_number symbol 0</span>
<span class="s2">    @    s$set_number symbol size 1.000000</span>
<span class="s2">    @    s$set_number symbol color $color_number</span>
<span class="s2">    @    s$set_number symbol pattern 1</span>
<span class="s2">    @    s$set_number symbol fill color $color_number</span>
<span class="s2">    @    s$set_number symbol fill pattern 0</span>
<span class="s2">    @    s$set_number symbol linewidth 1.0</span>
<span class="s2">    @    s$set_number symbol linestyle 1</span>
<span class="s2">    @    s$set_number symbol char 65</span>
<span class="s2">    @    s$set_number symbol char font 0</span>
<span class="s2">    @    s$set_number symbol skip 0</span>
<span class="s2">    @    s$set_number line type 1</span>
<span class="s2">    @    s$set_number line linestyle 1</span>
<span class="s2">    @    s$set_number line linewidth $linewidth</span>
<span class="s2">    @    s$set_number line color $color_number</span>
<span class="s2">    @    s$set_number line pattern 1</span>
<span class="s2">    @    s$set_number baseline type 0</span>
<span class="s2">    @    s$set_number baseline off</span>
<span class="s2">    @    s$set_number dropline off</span>
<span class="s2">    @    s$set_number fill type 0</span>
<span class="s2">    @    s$set_number fill rule 0</span>
<span class="s2">    @    s$set_number fill color $color_number</span>
<span class="s2">    @    s$set_number fill pattern 1</span>
<span class="s2">    @    s$set_number avalue off</span>
<span class="s2">    @    s$set_number avalue type 2</span>
<span class="s2">    @    s$set_number avalue char size 1.000000</span>
<span class="s2">    @    s$set_number avalue font 0</span>
<span class="s2">    @    s$set_number avalue color 1</span>
<span class="s2">    @    s$set_number avalue rot 0</span>
<span class="s2">    @    s$set_number avalue format general</span>
<span class="s2">    @    s$set_number avalue prec 3</span>
<span class="s2">    @    s$set_number avalue prepend &quot;&quot;</span>
<span class="s2">    @    s$set_number avalue append &quot;&quot;</span>
<span class="s2">    @    s$set_number avalue offset 0.000000 , 0.000000</span>
<span class="s2">    @    s$set_number errorbar on</span>
<span class="s2">    @    s$set_number errorbar place both</span>
<span class="s2">    @    s$set_number errorbar color $color_number</span>
<span class="s2">    @    s$set_number errorbar pattern 1</span>
<span class="s2">    @    s$set_number errorbar size 1.000000</span>
<span class="s2">    @    s$set_number errorbar linewidth 1.0</span>
<span class="s2">    @    s$set_number errorbar linestyle 1</span>
<span class="s2">    @    s$set_number errorbar riser linewidth 1.0</span>
<span class="s2">    @    s$set_number errorbar riser linestyle 1</span>
<span class="s2">    @    s$set_number errorbar riser clip off</span>
<span class="s2">    @    s$set_number errorbar riser clip length 0.100000</span>
<span class="s2">    @    s$set_number comment &quot;Cols 1:2&quot;</span>
<span class="s2">    @    s$set_number legend &quot;$legend&quot;</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">agr_singleset_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    @target G0.S$set_number</span>
<span class="s2">    @type xy</span>
<span class="s2">    $xydata</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># text.latex.preview=True is needed to have a proper alignment of</span>
<span class="c1"># tick marks with and without subscripts</span>
<span class="c1"># see e.g. http://matplotlib.org/1.3.0/examples/pylab_examples/usetex_baseline_test.html</span>
<span class="n">matplotlib_header_agg_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;# -*- coding: utf-8 -*-</span>

<span class="s1">import matplotlib</span>
<span class="s1">matplotlib.use(&#39;Agg&#39;)</span>

<span class="s1">from matplotlib import rc</span>
<span class="s1"># Uncomment to change default font</span>
<span class="s1">#rc(&#39;font&#39;,**{&#39;family&#39;:&#39;sans-serif&#39;,&#39;sans-serif&#39;:[&#39;Helvetica&#39;]})</span>
<span class="s1">rc(&#39;font&#39;, **{&#39;family&#39;: &#39;serif&#39;, &#39;serif&#39;: [&#39;Computer Modern&#39;, &#39;CMU Serif&#39;, &#39;Times New Roman&#39;]})</span>
<span class="s1"># To use proper font for, e.g., Gamma if usetex is set to False</span>
<span class="s1">rc(&#39;mathtext&#39;, fontset=&#39;cm&#39;)</span>

<span class="s1">rc(&#39;text&#39;, usetex=True)</span>
<span class="s1">import matplotlib.pyplot as plt</span>
<span class="s1">plt.rcParams.update({&#39;text.latex.preview&#39;: True})</span>

<span class="s1">import pylab as pl</span>

<span class="s1"># I use json to make sure the input is sanitized</span>
<span class="s1">import json</span>

<span class="s1">print_comment = False</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>

<span class="c1"># text.latex.preview=True is needed to have a proper alignment of</span>
<span class="c1"># tick marks with and without subscripts</span>
<span class="c1"># see e.g. http://matplotlib.org/1.3.0/examples/pylab_examples/usetex_baseline_test.html</span>
<span class="n">matplotlib_header_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;# -*- coding: utf-8 -*-</span>

<span class="s1">from __future__ import print_function</span>
<span class="s1">from matplotlib import rc</span>
<span class="s1"># Uncomment to change default font</span>
<span class="s1">#rc(&#39;font&#39;,**{&#39;family&#39;:&#39;sans-serif&#39;,&#39;sans-serif&#39;:[&#39;Helvetica&#39;]})</span>
<span class="s1">rc(&#39;font&#39;, **{&#39;family&#39;: &#39;serif&#39;, &#39;serif&#39;: [&#39;Computer Modern&#39;, &#39;CMU Serif&#39;, &#39;Times New Roman&#39;]})</span>
<span class="s1"># To use proper font for, e.g., Gamma if usetex is set to False</span>
<span class="s1">rc(&#39;mathtext&#39;, fontset=&#39;cm&#39;)</span>

<span class="s1">rc(&#39;text&#39;, usetex=True)</span>
<span class="s1">import matplotlib.pyplot as plt</span>
<span class="s1">plt.rcParams.update({&#39;text.latex.preview&#39;: True})</span>

<span class="s1">import pylab as pl</span>

<span class="s1"># I use json to make sure the input is sanitized</span>
<span class="s1">import json</span>

<span class="s1">print_comment = False</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>

<span class="n">matplotlib_import_data_inline_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;all_data_str = r&quot;&quot;&quot;$all_data_json&quot;&quot;&quot;</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>

<span class="n">matplotlib_import_data_fromfile_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;with io.open(&quot;$json_fname&quot;, encoding=&#39;utf8&#39;) as f:</span>
<span class="s1">    all_data_str = f.read()</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>

<span class="n">matplotlib_body_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;all_data = json.loads(all_data_str)</span>

<span class="s1">if not all_data.get(&#39;use_latex&#39;, False):</span>
<span class="s1">    rc(&#39;text&#39;, usetex=False)</span>

<span class="s1">#x = all_data[&#39;x&#39;]</span>
<span class="s1">#bands = all_data[&#39;bands&#39;]</span>
<span class="s1">paths = all_data[&#39;paths&#39;]</span>
<span class="s1">tick_pos = all_data[&#39;tick_pos&#39;]</span>
<span class="s1">tick_labels = all_data[&#39;tick_labels&#39;]</span>

<span class="s1"># Option for bands (all, or those of type 1 if there are two spins)</span>
<span class="s1">further_plot_options1 = </span><span class="si">{}</span><span class="s1"></span>
<span class="s1">further_plot_options1[&#39;color&#39;] = all_data.get(&#39;bands_color&#39;, &#39;k&#39;)</span>
<span class="s1">further_plot_options1[&#39;linewidth&#39;] = all_data.get(&#39;bands_linewidth&#39;, 0.5)</span>
<span class="s1">further_plot_options1[&#39;linestyle&#39;] = all_data.get(&#39;bands_linestyle&#39;, None)</span>
<span class="s1">further_plot_options1[&#39;marker&#39;] = all_data.get(&#39;bands_marker&#39;, None)</span>
<span class="s1">further_plot_options1[&#39;markersize&#39;] = all_data.get(&#39;bands_markersize&#39;, None)</span>
<span class="s1">further_plot_options1[&#39;markeredgecolor&#39;] = all_data.get(&#39;bands_markeredgecolor&#39;, None)</span>
<span class="s1">further_plot_options1[&#39;markeredgewidth&#39;] = all_data.get(&#39;bands_markeredgewidth&#39;, None)</span>
<span class="s1">further_plot_options1[&#39;markerfacecolor&#39;] = all_data.get(&#39;bands_markerfacecolor&#39;, None)</span>

<span class="s1"># Options for second-type of bands if present (e.g. spin up vs. spin down)</span>
<span class="s1">further_plot_options2 = </span><span class="si">{}</span><span class="s1"></span>
<span class="s1">further_plot_options2[&#39;color&#39;] = all_data.get(&#39;bands_color2&#39;, &#39;r&#39;)</span>
<span class="s1"># Use the values of further_plot_options1 by default</span>
<span class="s1">further_plot_options2[&#39;linewidth&#39;] = all_data.get(&#39;bands_linewidth2&#39;,</span>
<span class="s1">    further_plot_options1[&#39;linewidth&#39;]</span>
<span class="s1">    )</span>
<span class="s1">further_plot_options2[&#39;linestyle&#39;] = all_data.get(&#39;bands_linestyle2&#39;,</span>
<span class="s1">    further_plot_options1[&#39;linestyle&#39;]</span>
<span class="s1">    )</span>
<span class="s1">further_plot_options2[&#39;marker&#39;] = all_data.get(&#39;bands_marker2&#39;,</span>
<span class="s1">    further_plot_options1[&#39;marker&#39;]</span>
<span class="s1">    )</span>
<span class="s1">further_plot_options2[&#39;markersize&#39;] = all_data.get(&#39;bands_markersize2&#39;,</span>
<span class="s1">    further_plot_options1[&#39;markersize&#39;]</span>
<span class="s1">    )</span>
<span class="s1">further_plot_options2[&#39;markeredgecolor&#39;] = all_data.get(&#39;bands_markeredgecolor2&#39;,</span>
<span class="s1">    further_plot_options1[&#39;markeredgecolor&#39;]</span>
<span class="s1">    )</span>
<span class="s1">further_plot_options2[&#39;markeredgewidth&#39;] = all_data.get(&#39;bands_markeredgewidth2&#39;,</span>
<span class="s1">    further_plot_options1[&#39;markeredgewidth&#39;]</span>
<span class="s1">    )</span>
<span class="s1">further_plot_options2[&#39;markerfacecolor&#39;] = all_data.get(&#39;bands_markerfacecolor2&#39;,</span>
<span class="s1">    further_plot_options1[&#39;markerfacecolor&#39;]</span>
<span class="s1">    )</span>

<span class="s1">fig = pl.figure()</span>
<span class="s1">p = fig.add_subplot(1,1,1)</span>

<span class="s1">first_band_1 = True</span>
<span class="s1">first_band_2 = True</span>

<span class="s1">for path in paths:</span>
<span class="s1">    if path[&#39;length&#39;] &lt;= 1:</span>
<span class="s1">        # Avoid printing empty lines</span>
<span class="s1">        continue</span>
<span class="s1">    x = path[&#39;x&#39;]</span>
<span class="s1">    #for band in bands:</span>
<span class="s1">    for band, band_type in zip(path[&#39;values&#39;], all_data[&#39;band_type_idx&#39;]):</span>

<span class="s1">        # For now we support only two colors</span>
<span class="s1">        if band_type % 2 == 0:</span>
<span class="s1">            further_plot_options = further_plot_options1</span>
<span class="s1">        else:</span>
<span class="s1">            further_plot_options = further_plot_options2</span>

<span class="s1">        # Put the legend text only once</span>
<span class="s1">        label = None</span>
<span class="s1">        if first_band_1 and band_type % 2 == 0:</span>
<span class="s1">            first_band_1 = False</span>
<span class="s1">            label = all_data.get(&#39;legend_text&#39;, None)</span>
<span class="s1">        elif first_band_2 and band_type % 2 == 1:</span>
<span class="s1">            first_band_2 = False</span>
<span class="s1">            label = all_data.get(&#39;legend_text2&#39;, None)</span>

<span class="s1">        p.plot(x, band, label=label,</span>
<span class="s1">               **further_plot_options</span>
<span class="s1">        )</span>


<span class="s1">p.set_xticks(tick_pos)</span>
<span class="s1">p.set_xticklabels(tick_labels)</span>
<span class="s1">p.set_xlim([all_data[&#39;x_min_lim&#39;], all_data[&#39;x_max_lim&#39;]])</span>
<span class="s1">p.set_ylim([all_data[&#39;y_min_lim&#39;], all_data[&#39;y_max_lim&#39;]])</span>
<span class="s1">p.xaxis.grid(True, which=&#39;major&#39;, color=&#39;#888888&#39;, linestyle=&#39;-&#39;, linewidth=0.5)</span>

<span class="s1">if all_data.get(&#39;plot_zero_axis&#39;, False):</span>
<span class="s1">    p.axhline(</span>
<span class="s1">        0.,</span>
<span class="s1">        color=all_data.get(&#39;zero_axis_color&#39;, &#39;#888888&#39;),</span>
<span class="s1">        linestyle=all_data.get(&#39;zero_axis_linestyle&#39;, &#39;--&#39;),</span>
<span class="s1">        linewidth=all_data.get(&#39;zero_axis_linewidth&#39;, 0.5),</span>
<span class="s1">        )</span>
<span class="s1">if all_data[&#39;title&#39;]:</span>
<span class="s1">    p.set_title(all_data[&#39;title&#39;])</span>
<span class="s1">if all_data[&#39;legend_text&#39;]:</span>
<span class="s1">    p.legend(loc=&#39;best&#39;)</span>
<span class="s1">p.set_ylabel(all_data[&#39;yaxis_label&#39;])</span>

<span class="s1">try:</span>
<span class="s1">    if print_comment:</span>
<span class="s1">        print(all_data[&#39;comment&#39;])</span>
<span class="s1">except KeyError:</span>
<span class="s1">    pass</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>

<span class="n">matplotlib_footer_template_show</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;pl.show()</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>

<span class="n">matplotlib_footer_template_exportfile</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;pl.savefig(&quot;$fname&quot;, format=&quot;$format&quot;)</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>

<span class="n">matplotlib_footer_template_exportfile_with_dpi</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;pl.savefig(&quot;$fname&quot;, format=&quot;$format&quot;, dpi=$dpi)</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>