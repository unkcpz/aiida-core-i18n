

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aiida.orm.implementation.sqlalchemy.groups &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../developer_guide/index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../../aiida.html">aiida</a> &raquo;</li>
        
      <li>aiida.orm.implementation.sqlalchemy.groups</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aiida.orm.implementation.sqlalchemy.groups</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;SQLA groups&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">from</span> <span class="nn">aiida.backends</span> <span class="k">import</span> <span class="n">sqlalchemy</span> <span class="k">as</span> <span class="n">sa</span>
<span class="kn">from</span> <span class="nn">aiida.backends.sqlalchemy.models.group</span> <span class="k">import</span> <span class="n">DbGroup</span><span class="p">,</span> <span class="n">table_groups_nodes</span>
<span class="kn">from</span> <span class="nn">aiida.backends.sqlalchemy.models.node</span> <span class="k">import</span> <span class="n">DbNode</span>
<span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="k">import</span> <span class="n">UniquenessError</span>
<span class="kn">from</span> <span class="nn">aiida.common.lang</span> <span class="k">import</span> <span class="n">type_check</span>
<span class="kn">from</span> <span class="nn">aiida.orm.implementation.groups</span> <span class="k">import</span> <span class="n">BackendGroup</span><span class="p">,</span> <span class="n">BackendGroupCollection</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">entities</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">users</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">utils</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;SqlaGroup&#39;</span><span class="p">,</span> <span class="s1">&#39;SqlaGroupCollection&#39;</span><span class="p">)</span>

<span class="n">_LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># Unfortunately the linter doesn&#39;t seem to be able to pick up on the fact that the abstract property &#39;id&#39;</span>
<span class="c1"># of BackendGroup is actually implemented in SqlaModelEntity so disable the abstract check</span>
<div class="viewcode-block" id="SqlaGroup"><a class="viewcode-back" href="../../../../../apidoc/aiida.orm.implementation.sqlalchemy.html#aiida.orm.implementation.sqlalchemy.groups.SqlaGroup">[docs]</a><span class="k">class</span> <span class="nc">SqlaGroup</span><span class="p">(</span><span class="n">entities</span><span class="o">.</span><span class="n">SqlaModelEntity</span><span class="p">[</span><span class="n">DbGroup</span><span class="p">],</span> <span class="n">BackendGroup</span><span class="p">):</span>  <span class="c1"># pylint: disable=abstract-method</span>
    <span class="sd">&quot;&quot;&quot;The SQLAlchemy Group object&quot;&quot;&quot;</span>

    <span class="n">MODEL_CLASS</span> <span class="o">=</span> <span class="n">DbGroup</span>

<div class="viewcode-block" id="SqlaGroup.__init__"><a class="viewcode-back" href="../../../../../apidoc/aiida.orm.implementation.sqlalchemy.html#aiida.orm.implementation.sqlalchemy.groups.SqlaGroup.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">type_string</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a new SQLA group</span>

<span class="sd">        :param backend: the backend to use</span>
<span class="sd">        :param label: the group label</span>
<span class="sd">        :param user: the owner of the group</span>
<span class="sd">        :param description: an optional group description</span>
<span class="sd">        :param type_string: an optional type for the group to contain</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">type_check</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">users</span><span class="o">.</span><span class="n">SqlaUser</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SqlaGroup</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>

        <span class="n">dbgroup</span> <span class="o">=</span> <span class="n">DbGroup</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">dbmodel</span><span class="p">,</span> <span class="n">type_string</span><span class="o">=</span><span class="n">type_string</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dbmodel</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ModelWrapper</span><span class="p">(</span><span class="n">dbgroup</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbmodel</span><span class="o">.</span><span class="n">label</span>

    <span class="nd">@label</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempt to change the label of the group instance. If the group is already stored</span>
<span class="sd">        and the another group of the same type already exists with the desired label, a</span>
<span class="sd">        UniquenessError will be raised</span>

<span class="sd">        :param label: the new group label</span>
<span class="sd">        :raises aiida.common.UniquenessError: if another group of same type and label already exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dbmodel</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stored</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dbmodel</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UniquenessError</span><span class="p">(</span><span class="s1">&#39;a group of the same type with the label </span><span class="si">{}</span><span class="s1"> already exists&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbmodel</span><span class="o">.</span><span class="n">description</span>

    <span class="nd">@description</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dbmodel</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># Update the entry in the DB, if the group is already stored</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stored</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbmodel</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">type_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbmodel</span><span class="o">.</span><span class="n">type_string</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">from_dbmodel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dbmodel</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

    <span class="nd">@user</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_user</span><span class="p">):</span>
        <span class="n">type_check</span><span class="p">(</span><span class="n">new_user</span><span class="p">,</span> <span class="n">users</span><span class="o">.</span><span class="n">SqlaUser</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dbmodel</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">new_user</span><span class="o">.</span><span class="n">dbmodel</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbmodel</span><span class="o">.</span><span class="n">id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uuid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dbmodel</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

<div class="viewcode-block" id="SqlaGroup.__int__"><a class="viewcode-back" href="../../../../../apidoc/aiida.orm.implementation.sqlalchemy.html#aiida.orm.implementation.sqlalchemy.groups.SqlaGroup.__int__">[docs]</a>    <span class="k">def</span> <span class="nf">__int__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stored</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbnode</span><span class="o">.</span><span class="n">id</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_stored</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<div class="viewcode-block" id="SqlaGroup.store"><a class="viewcode-back" href="../../../../../apidoc/aiida.orm.implementation.sqlalchemy.html#aiida.orm.implementation.sqlalchemy.groups.SqlaGroup.store">[docs]</a>    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dbmodel</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="SqlaGroup.count"><a class="viewcode-back" href="../../../../../apidoc/aiida.orm.implementation.sqlalchemy.html#aiida.orm.implementation.sqlalchemy.groups.SqlaGroup.count">[docs]</a>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of entities in this group.</span>

<span class="sd">        :return: integer number of entities contained within the group</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.backends.sqlalchemy</span> <span class="k">import</span> <span class="n">get_scoped_session</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">get_scoped_session</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_CLASS</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_CLASS</span><span class="o">.</span><span class="n">dbnodes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbGroup</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></div>

<div class="viewcode-block" id="SqlaGroup.clear"><a class="viewcode-back" href="../../../../../apidoc/aiida.orm.implementation.sqlalchemy.html#aiida.orm.implementation.sqlalchemy.groups.SqlaGroup.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all the nodes from this group.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.backends.sqlalchemy</span> <span class="k">import</span> <span class="n">get_scoped_session</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">get_scoped_session</span><span class="p">()</span>
        <span class="c1"># Note we have to call `dbmodel` and `_dbmodel` to circumvent the `ModelWrapper`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbmodel</span><span class="o">.</span><span class="n">dbnodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get an iterator to all the nodes in the group&quot;&quot;&quot;</span>

        <span class="k">class</span> <span class="nc">Iterator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  <span class="c1"># pylint: disable=useless-object-inheritance</span>
            <span class="sd">&quot;&quot;&quot;Nodes iterator&quot;&quot;&quot;</span>

            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbnodes</span><span class="p">,</span> <span class="n">backend</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span> <span class="o">=</span> <span class="n">backend</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dbnodes</span> <span class="o">=</span> <span class="n">dbnodes</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span> <span class="o">=</span> <span class="n">dbnodes</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_genfunction</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">_genfunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">get_backend_entity</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span>

            <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbnodes</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
                    <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">get_backend_entity</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbnodes</span><span class="p">[</span><span class="n">value</span><span class="p">]]</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">get_backend_entity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dbnodes</span><span class="p">[</span><span class="n">value</span><span class="p">])</span>

            <span class="c1"># For future python-3 compatibility</span>
            <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Iterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dbmodel</span><span class="o">.</span><span class="n">dbnodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">)</span>

<div class="viewcode-block" id="SqlaGroup.add_nodes"><a class="viewcode-back" href="../../../../../apidoc/aiida.orm.implementation.sqlalchemy.html#aiida.orm.implementation.sqlalchemy.groups.SqlaGroup.add_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">add_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a node or a set of nodes to the group.</span>

<span class="sd">        :note: all the nodes *and* the group itself have to be stored.</span>

<span class="sd">        :param nodes: a list of `BackendNode` instance to be added to this group</span>

<span class="sd">        :param kwargs:</span>
<span class="sd">            skip_orm: When the flag is on, the SQLA ORM is skipped and SQLA is used</span>
<span class="sd">            to create a direct SQL INSERT statement to the group-node relationship</span>
<span class="sd">            table (to improve speed).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="k">import</span> <span class="n">IntegrityError</span>  <span class="c1"># pylint: disable=import-error, no-name-in-module</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.dialects.postgresql</span> <span class="k">import</span> <span class="n">insert</span>  <span class="c1"># pylint: disable=import-error, no-name-in-module</span>
        <span class="kn">from</span> <span class="nn">aiida.orm.implementation.sqlalchemy.nodes</span> <span class="k">import</span> <span class="n">SqlaNode</span>
        <span class="kn">from</span> <span class="nn">aiida.backends.sqlalchemy</span> <span class="k">import</span> <span class="n">get_scoped_session</span>
        <span class="kn">from</span> <span class="nn">aiida.backends.sqlalchemy.models.base</span> <span class="k">import</span> <span class="n">Base</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">SqlaGroup</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_nodes</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
        <span class="n">skip_orm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;skip_orm&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">check_node</span><span class="p">(</span><span class="n">given_node</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Check if given node is of correct type and stored &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">given_node</span><span class="p">,</span> <span class="n">SqlaNode</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;invalid type </span><span class="si">{}</span><span class="s1">, has to be </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">given_node</span><span class="p">),</span> <span class="n">SqlaNode</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">given_node</span><span class="o">.</span><span class="n">is_stored</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;At least one of the provided nodes is unstored, stopping...&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">disable_expire_on_commit</span><span class="p">(</span><span class="n">get_scoped_session</span><span class="p">())</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_orm</span><span class="p">:</span>
                <span class="c1"># Get dbnodes here ONCE, otherwise each call to dbnodes will re-read the current value in the database</span>
                <span class="n">dbnodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbmodel</span><span class="o">.</span><span class="n">dbnodes</span>

                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                    <span class="n">check_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

                    <span class="c1"># Use pattern as suggested here:</span>
                    <span class="c1"># http://docs.sqlalchemy.org/en/latest/orm/session_transaction.html#using-savepoint</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">begin_nested</span><span class="p">():</span>
                            <span class="n">dbnodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">dbmodel</span><span class="p">)</span>
                            <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="k">except</span> <span class="n">IntegrityError</span><span class="p">:</span>
                        <span class="c1"># Duplicate entry, skip</span>
                        <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ins_dict</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                    <span class="n">check_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="n">ins_dict</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;dbnode_id&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;dbgroup_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>

                <span class="n">my_table</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;db_dbgroup_dbnodes&#39;</span><span class="p">]</span>
                <span class="n">ins</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">my_table</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">ins_dict</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ins</span><span class="o">.</span><span class="n">on_conflict_do_nothing</span><span class="p">(</span><span class="n">index_elements</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dbnode_id&#39;</span><span class="p">,</span> <span class="s1">&#39;dbgroup_id&#39;</span><span class="p">]))</span>

            <span class="c1"># Commit everything as up till now we&#39;ve just flushed</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="SqlaGroup.remove_nodes"><a class="viewcode-back" href="../../../../../apidoc/aiida.orm.implementation.sqlalchemy.html#aiida.orm.implementation.sqlalchemy.groups.SqlaGroup.remove_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">remove_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a node or a set of nodes from the group.</span>

<span class="sd">        :note: all the nodes *and* the group itself have to be stored.</span>

<span class="sd">        :param nodes: a list of `BackendNode` instance to be added to this group</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.orm.implementation.sqlalchemy.nodes</span> <span class="k">import</span> <span class="n">SqlaNode</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">SqlaGroup</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">remove_nodes</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

        <span class="c1"># Get dbnodes here ONCE, otherwise each call to dbnodes will re-read the current value in the database</span>
        <span class="n">dbnodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbmodel</span><span class="o">.</span><span class="n">dbnodes</span>

        <span class="n">list_nodes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">SqlaNode</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;invalid type </span><span class="si">{}</span><span class="s1">, has to be </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">SqlaNode</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;At least one of the provided nodes is unstored, stopping...&#39;</span><span class="p">)</span>

            <span class="c1"># If we don&#39;t check first, SqlA might issue a DELETE statement for an unexisting key, resulting in an error</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">dbmodel</span> <span class="ow">in</span> <span class="n">dbnodes</span><span class="p">:</span>
                <span class="n">list_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">dbmodel</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">list_nodes</span><span class="p">:</span>
            <span class="n">dbnodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">sa</span><span class="o">.</span><span class="n">get_scoped_session</span><span class="p">()</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="SqlaGroupCollection"><a class="viewcode-back" href="../../../../../apidoc/aiida.orm.implementation.sqlalchemy.html#aiida.orm.implementation.sqlalchemy.groups.SqlaGroupCollection">[docs]</a><span class="k">class</span> <span class="nc">SqlaGroupCollection</span><span class="p">(</span><span class="n">BackendGroupCollection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The SLQA collection of groups&quot;&quot;&quot;</span>

    <span class="n">ENTITY_CLASS</span> <span class="o">=</span> <span class="n">SqlaGroup</span>

<div class="viewcode-block" id="SqlaGroupCollection.query"><a class="viewcode-back" href="../../../../../apidoc/aiida.orm.implementation.sqlalchemy.html#aiida.orm.implementation.sqlalchemy.groups.SqlaGroupCollection.query">[docs]</a>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">type_string</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">uuid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">nodes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">node_attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">past_days</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">label_filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pylint: disable=too-many-arguments</span>
        <span class="c1"># pylint: disable=too-many-branches</span>
        <span class="kn">from</span> <span class="nn">aiida.orm.implementation.sqlalchemy.nodes</span> <span class="k">import</span> <span class="n">SqlaNode</span>

        <span class="n">session</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">get_scoped_session</span><span class="p">()</span>

        <span class="n">filters</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DbGroup</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">type_string</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DbGroup</span><span class="o">.</span><span class="n">type_string</span> <span class="o">==</span> <span class="n">type_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DbGroup</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">pk</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">uuid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DbGroup</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">uuid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">past_days</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DbGroup</span><span class="o">.</span><span class="n">time</span> <span class="o">&gt;=</span> <span class="n">past_days</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">nodes</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">SqlaNode</span><span class="p">,</span> <span class="n">DbNode</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;At least one of the elements passed as &quot;</span>
                                <span class="s2">&quot;nodes for the query on Group is neither &quot;</span>
                                <span class="s2">&quot;a Node nor a DbNode&quot;</span><span class="p">)</span>

            <span class="c1"># In the case of the Node orm from Sqlalchemy, there is an id</span>
            <span class="c1"># property on it.</span>
            <span class="n">sub_query</span> <span class="o">=</span> <span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">table_groups_nodes</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">table_groups_nodes</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;dbnode_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">]),</span>
                <span class="n">table_groups_nodes</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;dbgroup_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">DbGroup</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>

            <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DbGroup</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">type_check</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">users</span><span class="o">.</span><span class="n">SqlaUser</span><span class="p">)</span>
                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DbGroup</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">dbmodel</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">label_filters</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">label_filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;startswith&quot;</span><span class="p">:</span>
                    <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DbGroup</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;endswith&quot;</span><span class="p">:</span>
                    <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DbGroup</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s2">&quot;%</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;contains&quot;</span><span class="p">:</span>
                    <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DbGroup</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s2">&quot;%</span><span class="si">{}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">node_attributes</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;SQLA query doesn&#39;t support node attribute filters, ignoring &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">node_attributes</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;SQLA query doesn&#39;t support additional filters, ignoring &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbGroup</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">DbGroup</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">SqlaGroup</span><span class="o">.</span><span class="n">from_dbmodel</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">)</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">]</span></div>

<div class="viewcode-block" id="SqlaGroupCollection.delete"><a class="viewcode-back" href="../../../../../apidoc/aiida.orm.implementation.sqlalchemy.html#aiida.orm.implementation.sqlalchemy.groups.SqlaGroupCollection.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>  <span class="c1"># pylint: disable=redefined-builtin</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">get_scoped_session</span><span class="p">()</span>

        <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DbGroup</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>