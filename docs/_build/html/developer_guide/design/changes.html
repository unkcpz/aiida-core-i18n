

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Design change justifications &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="AiiDA internals" href="../core/internals.html" />
    <link rel="prev" title="AiiDA design" href="../index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">AiiDA design</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Design change justifications</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#version-1-0-0">Version 1.0.0</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-provenance-redesign">The provenance redesign</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-calculation-job-redesign">The calculation job redesign</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-module-hierarchy-and-importing">The module hierarchy and importing</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">AiiDA design</a> &raquo;</li>
        
      <li>Design change justifications</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/developer_guide/design/changes.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="design-change-justifications">
<h1>Design change justifications<a class="headerlink" href="#design-change-justifications" title="Permalink to this headline">¶</a></h1>
<p>This document records big changes in the design and architecture of AiiDA and especially details the justification for the change</p>
<div class="section" id="version-1-0-0">
<h2>Version 1.0.0<a class="headerlink" href="#version-1-0-0" title="Permalink to this headline">¶</a></h2>
<div class="section" id="the-provenance-redesign">
<span id="design-changes-1-0-0-provenance-redesign"></span><h3>The provenance redesign<a class="headerlink" href="#the-provenance-redesign" title="Permalink to this headline">¶</a></h3>
<p>In the early stages of AiiDA, the concept of its provenance graph was simple.
Data is used as input for calculations, that in turn create new data as output.
The data and calculations, produced and ran by AiiDA, were stored as nodes in a graph.
Due to the causality principle, the resulting graph was naturally acyclic, as no piece of data could possibly be an input to its own creation.
The directed acyclic graph that stored the data provenance in AiiDA was well defined and all was good.</p>
<p>However, as AiiDA matured, its use cases became more complex and soon there was a need to be able to define and run workflows.
Workflows allow the user to define a sequence of calculations, that ultimately produce a result.
In order to be able to retrieve the final result directly from the workflow, it needed to be able to return the data created by the calculations that it ran.
“Easy peasy: we simply add a <code class="docutils literal notranslate"><span class="pre">return</span></code> link from the workflow node in the graph to the created data node”.
But wat seemed like an easy solution brought a host of unforeseen problems with it.
By introducing the concept of a <code class="docutils literal notranslate"><span class="pre">return</span></code> link, the acyclicity of the graph was broken, and with it, much of AiiDA’s graph traversal API that assumed this property.</p>
<p>After more than a year of discussion, AiiDA developers and users concluded that the concept of the <code class="docutils literal notranslate"><span class="pre">return</span></code> link was absolutely crucial.
Without them, for complicated and heavily nested workflows, their results will be buried deep within their call stack and difficult to retrieve.
The alternative was to redesign the provenance graph architecture such that acyclicity would be returned to part of the provenance graph, while keeping the utility of the <code class="docutils literal notranslate"><span class="pre">return</span></code> link.
The AiiDA development team, in close collaboration with advanced users, spent a year and a half, redesigning the provenance architecture and implementing the changes into AiiDA’s API.
As always, we have tried our best to allow early adopters of AiiDA to migrate their existing databases to newer versions as easy as possible, by providing automatic migration.
This time around is no different, except for the fact that the migration was a lot more complicated and unfortunately this time some backwards-incompatible changes had to be introduced in the API.</p>
<p>A more detailed explanation of the new provenance design and the motivation can be found <a class="reference internal" href="../../concepts/provenance.html#concepts-provenance"><span class="std std-ref">here</span></a>.</p>
</div>
<div class="section" id="the-calculation-job-redesign">
<span id="design-changes-1-0-0-calcjob-redesign"></span><h3>The calculation job redesign<a class="headerlink" href="#the-calculation-job-redesign" title="Permalink to this headline">¶</a></h3>
<p>The calculation job has been one of the most used and important components of AiiDA as it represents a calculation that is submitted to a scheduler, often on a remote cluster.
From its earliest conception, the class that implemented this feature, the <code class="docutils literal notranslate"><span class="pre">JobCalculation</span></code>, fulfilled two major but very distinct tasks.
On one side, it provided the means to the user to specify what inputs the calculation required, how the actual input files should be constructed, and what files should be retrieved after completion.
In addition to that, since it was a sub class of the <code class="docutils literal notranslate"><span class="pre">Node</span></code> class, it also functioned as a record in the provenance graph of an actual calculation that was executed.
This double role was leading to problems with the <code class="docutils literal notranslate"><span class="pre">Node</span></code> class becoming too complicated as well as inconsistent.
For example, an instance representing an already completed calculation would also still have the methods on how to run it again.</p>
<p>This problem was solved with the introduction of the <code class="docutils literal notranslate"><span class="pre">WorkChain</span></code> in <code class="docutils literal notranslate"><span class="pre">aiida-core</span></code> version <code class="docutils literal notranslate"><span class="pre">0.7.0</span></code>.
Like the <code class="docutils literal notranslate"><span class="pre">JobCalculation</span></code>, the <code class="docutils literal notranslate"><span class="pre">WorkChain</span></code> was a process that takes certain inputs and then performs operations on those in order to produce outputs.
However, unlike the <code class="docutils literal notranslate"><span class="pre">JobCalculation</span></code>, the <code class="docutils literal notranslate"><span class="pre">WorkChain</span></code> class was only concerned with knowledge of <em>how</em> the process should be run.
To represent the execution of the <code class="docutils literal notranslate"><span class="pre">WorkChain</span></code> in the provenance graph, a different class was used, namely the <code class="docutils literal notranslate"><span class="pre">WorkChainNode</span></code>.
This separation of responsibilities leads to two entities with a clearer interface and behavior.</p>
<p>For quite a few versions, the old and new way of defining and running processes were kept functional alongside one another, but slowly the old way was adapted to use the new mechanism.
In <code class="docutils literal notranslate"><span class="pre">aiida-core</span></code> version <code class="docutils literal notranslate"><span class="pre">1.0.0</span></code> we fully deprecate the old way and all calculations now use the process/node duality.
As a result the <code class="docutils literal notranslate"><span class="pre">JobCalculation</span></code> class has disappeared.
Now, instead, a <code class="docutils literal notranslate"><span class="pre">CalcJobNode</span></code> is created in the provenance graph to represent the execution of a calculation through a scheduler.
Moreover, to implement the plugin for a calculation job, one now subclasses the <code class="docutils literal notranslate"><span class="pre">Process</span></code> subclass <code class="docutils literal notranslate"><span class="pre">CalcJob</span></code>, whose interface is the same as that of the <code class="docutils literal notranslate"><span class="pre">WorkChain</span></code>.</p>
<p>Inputs, outputs and potentially exit codes are simply implemented in the <code class="docutils literal notranslate"><span class="pre">define</span></code> class method, just as you would for the <code class="docutils literal notranslate"><span class="pre">WorkChain</span></code>.
Unlike the <code class="docutils literal notranslate"><span class="pre">WorkChain</span></code>, however, the <code class="docutils literal notranslate"><span class="pre">CalcJob</span></code> does not have an outline, but instead just has a single method that should be implemented, namely <code class="docutils literal notranslate"><span class="pre">prepare_for_submission</span></code>.
This method takes a single argument <code class="docutils literal notranslate"><span class="pre">folder</span></code> which will point to a temporary folder to which the required input files for the calculation can be written.
From a plugin developer standpoint, the rest works exactly as before, and the <code class="docutils literal notranslate"><span class="pre">prepare_for_submission</span></code> method should return a <code class="docutils literal notranslate"><span class="pre">CalcInfo</span></code> object, containing information for the engine on what files to copy over and to retrieve.</p>
<p>A more detailed explanation about the new <code class="docutils literal notranslate"><span class="pre">CalcJob</span></code> and best practices for writing <code class="docutils literal notranslate"><span class="pre">Parser</span></code> implementations can be found <a class="reference internal" href="../../working/calculations.html#working-calcjobs"><span class="std std-ref">here</span></a>.</p>
</div>
<div class="section" id="the-module-hierarchy-and-importing">
<span id="design-changes-1-0-0-module-hierarchy"></span><h3>The module hierarchy and importing<a class="headerlink" href="#the-module-hierarchy-and-importing" title="Permalink to this headline">¶</a></h3>
<p>AiiDA has been developed and used since 2013 and in the past six years we have tried, as much as possible, to reduce the changes to the python API over time to a minimum.
At the same time, a lot of new functionality has been added to the code, with a potentially complex submodule structure for the AiiDA python package, that had started to become too complex even just to remember where to find a given function or class.</p>
<p>With <code class="docutils literal notranslate"><span class="pre">aiida-core</span></code> version <code class="docutils literal notranslate"><span class="pre">1.0.0</span></code>, we have decided to restructure the package module hierarchy, moving functions and classes to more intutive locations, and exposing functionality that is commonly used by users at higher levels (e.g. now one can do <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">aiida.orm</span> <span class="pre">import</span> <span class="pre">CalcJobNode</span></code> in addition to <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">aiida.orm.nodes.process.calculation.calcjob.CalcJobNode</span></code>).</p>
<p>Albeit this change was essential to increase usability, we want to guarantee a high-degree of stability for users for the components that are intended to be public.
To facilitiate this, we explain here first the module hierarchy of <code class="docutils literal notranslate"><span class="pre">aiida-core</span></code>, what parts of its API are intended to be public and how those should be preferentially imported.</p>
<p>The first level of the package hierarchy is the <code class="docutils literal notranslate"><span class="pre">aiida</span></code> module.
It contains many other packages within it, such as <code class="docutils literal notranslate"><span class="pre">orm</span></code> and <code class="docutils literal notranslate"><span class="pre">engine</span></code>, which we will refer to as second-level packages, each of which can have a much deeper hierarchy within it.
Since this internal structure is mostly to simplify development and for organizational purposes, the components of the <code class="docutils literal notranslate"><span class="pre">aiida</span></code> package that should be usable are exposed on the second-level packages at most.
Practically this means that anything that is intended to be used should be importable from a second-level package, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aiida.engine</span> <span class="k">import</span> <span class="n">WorkChain</span><span class="p">,</span> <span class="n">calcfunction</span>
<span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="k">import</span> <span class="n">load_node</span><span class="p">,</span> <span class="n">CalcJobNode</span>
</pre></div>
</div>
<p>With the definition of public components of the <code class="docutils literal notranslate"><span class="pre">aiida-core</span></code> package in place, from <code class="docutils literal notranslate"><span class="pre">1.0.0</span></code> we will maintain a standard deprecation policy to minimize the amount of breaking changes for plugins and users.
In particular we will strive to:</p>
<blockquote>
<div><ul class="simple">
<li>not change the API of public components as much as possible</li>
<li>if we are forced to change it anyway, deprecate a signifcant amount of time in advance</li>
<li>for backwards incompatible changes, increase the major version</li>
</ul>
</div></blockquote>
<p>For better clarity, we are curating a list of classes and functions (exposed at the second level) that are intended to be public and for which the above policy will be enforced.
The list is currently maintained on <a class="reference external" href="https://github.com/aiidateam/aiida_core/wiki/AiiDA-public-modules,-classes-and-functions">GitHub</a>.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../core/internals.html" class="btn btn-neutral float-right" title="AiiDA internals" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../index.html" class="btn btn-neutral float-left" title="AiiDA design" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>