

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Modifying the schema &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="How to extend the AiiDA REST API" href="extend_restapi.html" />
    <link rel="prev" title="Database schema" href="database_schema.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">AiiDA design</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html#aiida-core">AiiDA core</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="internals.html">AiiDA internals</a></li>
<li class="toctree-l2"><a class="reference internal" href="transport.html">Transport plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="database_schema.html">Database schema</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Modifying the schema</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#django">Django</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sqlalchemy">SQLAlchemy</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview-of-alembic-manage-py-commands">Overview of alembic_manage.py commands</a></li>
<li class="toctree-l4"><a class="reference internal" href="#debugging-alembic">Debugging Alembic</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="extend_restapi.html">How to extend the AiiDA REST API</a></li>
<li class="toctree-l2"><a class="reference internal" href="caching.html">Caching: implementation details</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugin_system.html">Developing The Plugin System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tools/sphinx_cheatsheet.html">Sphinx cheatsheet</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/index.html#plugin-development">Plugin development</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">AiiDA design</a> &raquo;</li>
        
      <li>Modifying the schema</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/developer_guide/core/modifying_the_schema.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="modifying-the-schema">
<h1>Modifying the schema<a class="headerlink" href="#modifying-the-schema" title="Permalink to this headline">¶</a></h1>
<div class="section" id="django">
<h2>Django<a class="headerlink" href="#django" title="Permalink to this headline">¶</a></h2>
<p>The Django database schema can be found in <a class="reference internal" href="../../apidoc/aiida.backends.djsite.db.html#module-aiida.backends.djsite.db.models" title="aiida.backends.djsite.db.models"><code class="xref py py-mod docutils literal notranslate"><span class="pre">aiida.backends.djsite.db.models</span></code></a>.</p>
<p>If you need to change the database schema follow these steps:</p>
<ol class="arabic">
<li><p class="first">Make all the necessary changes to <a class="reference internal" href="../../apidoc/aiida.backends.djsite.db.html#module-aiida.backends.djsite.db.models" title="aiida.backends.djsite.db.models"><code class="xref py py-mod docutils literal notranslate"><span class="pre">aiida.backends.djsite.db.models</span></code></a></p>
</li>
<li><p class="first">Create a new migration file.  From <code class="docutils literal notranslate"><span class="pre">aiida/backends/djsite</span></code>, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">makemigrations</span>
</pre></div>
</div>
<p>This will create the migration file in <code class="docutils literal notranslate"><span class="pre">aiida/backends/djsite/db/migrations</span></code> whose
name begins with a number followed by some description.  If the description
is not appropriate then change it to something better but retain the number.</p>
</li>
<li><p class="first">Open the generated file and make the following changes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aiida.backends.djsite.db.migrations</span> <span class="k">import</span> <span class="n">upgrade_schema_version</span>
<span class="o">...</span>
<span class="n">REVISION</span> <span class="o">=</span> <span class="c1"># choose an appropriate version number (hint: higher than the last migration!)</span>
<span class="n">DOWN_REVISION</span> <span class="o">=</span> <span class="c1"># the revision number of the previous migration</span>
<span class="o">...</span>
<span class="k">class</span> <span class="nc">Migration</span><span class="p">(</span><span class="n">migrations</span><span class="o">.</span><span class="n">Migration</span><span class="p">):</span>
  <span class="o">...</span>
  <span class="n">operations</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">..</span>
    <span class="n">upgrade_schema_version</span><span class="p">(</span><span class="n">REVISION</span><span class="p">,</span> <span class="n">DOWN_REVISION</span><span class="p">)</span>
  <span class="p">]</span>
</pre></div>
</div>
</li>
<li><p class="first">The migration file now contains some migrations steps that were generated automatically.
Please make sure that they are correct. Also, if you want to add some changes that affect
the content of the database – you should do it ‘’manually’’ by adding some sql commands
that will run directly on your database:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">forward_sql</span> <span class="o">=</span> <span class="p">[</span>
     <span class="sd">&quot;&quot;&quot;UPDATE db_dbgroup SET type_string = &#39;auto.import&#39; WHERE type_string = &#39;aiida.import&#39;;&quot;&quot;&quot;</span><span class="p">,</span>
     <span class="sd">&quot;&quot;&quot;UPDATE db_dbgroup SET type_string = &#39;auto.run&#39; WHERE type_string = &#39;autogroup.run&#39;;&quot;&quot;&quot;</span><span class="p">,</span>
     <span class="p">]</span>

<span class="n">reverse_sql</span> <span class="o">=</span> <span class="p">[</span>
     <span class="sd">&quot;&quot;&quot;UPDATE db_dbgroup SET type_string = &#39;aiida.import&#39; WHERE type_string = &#39;auto.import&#39;;&quot;&quot;&quot;</span><span class="p">,</span>
     <span class="sd">&quot;&quot;&quot;UPDATE db_dbgroup SET type_string = &#39;autogroup.run&#39; WHERE type_string = &#39;auto.run&#39;;&quot;&quot;&quot;</span><span class="p">,</span>

     <span class="p">]</span>
<span class="o">...</span>

<span class="n">operations</span> <span class="o">=</span> <span class="p">[</span>
   <span class="o">...</span>
   <span class="n">migrations</span><span class="o">.</span><span class="n">RunSQL</span><span class="p">(</span>
       <span class="n">sql</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">forward_sql</span><span class="p">),</span>
       <span class="n">reverse_sql</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reverse_sql</span><span class="p">)),</span>
   <span class="n">upgrade_schema_version</span><span class="p">(</span><span class="n">REVISION</span><span class="p">,</span> <span class="n">DOWN_REVISION</span><span class="p">),</span>
   <span class="o">...</span>
<span class="p">]</span>
</pre></div>
</div>
<p>As you can see here, you should not only provide the sql commands to upgrade your database,
but also the commands to revert these changes in case you want to perform a downgrade (see:
<code class="docutils literal notranslate"><span class="pre">sql=forward_sql</span></code>, <code class="docutils literal notranslate"><span class="pre">reverse_sql=reverse_sql</span></code>)</p>
</li>
<li><p class="first">Change the <code class="docutils literal notranslate"><span class="pre">LATEST_MIGRATION</span></code> variable in
<code class="docutils literal notranslate"><span class="pre">aiida/backends/djsite/db/migrations/__init__.py</span></code> to the name of your migration
file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LATEST_MIGRATION</span> <span class="o">=</span> <span class="s1">&#39;0003_my_db_update&#39;</span>
</pre></div>
</div>
<p>This allows AiiDA to get the version number from your migration and make sure the
database and the code are in sync.</p>
</li>
<li><p class="first">Migrate your database to the new version, (again from <code class="docutils literal notranslate"><span class="pre">aiida/backends/djsite</span></code>),
run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">migrate</span>
</pre></div>
</div>
<p>In case you want to (and, most probably, you should) test the downgrade operation, please
check the list of available versions of the database:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">showmigrations</span> <span class="n">db</span>
</pre></div>
</div>
<p>The output will look as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">db</span>
 <span class="p">[</span><span class="n">X</span><span class="p">]</span> <span class="mi">0001</span><span class="n">_initial</span>
 <span class="p">[</span><span class="n">X</span><span class="p">]</span> <span class="mi">0002</span><span class="n">_db_state_change</span>
 <span class="p">[</span><span class="n">X</span><span class="p">]</span> <span class="mi">0003</span><span class="n">_add_link_type</span>
 <span class="p">[</span><span class="n">X</span><span class="p">]</span> <span class="mi">0004</span><span class="n">_add_daemon_and_uuid_indices</span>
 <span class="p">[</span><span class="n">X</span><span class="p">]</span> <span class="mi">0005</span><span class="n">_add_cmtime_indices</span>
 <span class="p">[</span><span class="n">X</span><span class="p">]</span> <span class="mi">0006</span><span class="n">_delete_dbpath</span>
 <span class="p">[</span><span class="n">X</span><span class="p">]</span> <span class="mi">0007</span><span class="n">_update_linktypes</span>
 <span class="p">[</span><span class="n">X</span><span class="p">]</span> <span class="mi">0008</span><span class="n">_code_hidden_to_extra</span>
 <span class="p">[</span><span class="n">X</span><span class="p">]</span> <span class="mi">0009</span><span class="n">_base_data_plugin_type_string</span>
 <span class="p">[</span><span class="n">X</span><span class="p">]</span> <span class="mi">0010</span><span class="n">_process_type</span>
 <span class="p">[</span><span class="n">X</span><span class="p">]</span> <span class="mi">0011</span><span class="n">_delete_kombu_tables</span>
 <span class="p">[</span><span class="n">X</span><span class="p">]</span> <span class="mi">0012</span><span class="n">_drop_dblock</span>
 <span class="p">[</span><span class="n">X</span><span class="p">]</span> <span class="mi">0013</span><span class="n">_django_1_8</span>
 <span class="p">[</span><span class="n">X</span><span class="p">]</span> <span class="mi">0014</span><span class="n">_add_node_uuid_unique_constraint</span>
 <span class="p">[</span><span class="n">X</span><span class="p">]</span> <span class="mi">0015</span><span class="n">_invalidating_node_hash</span>
 <span class="p">[</span><span class="n">X</span><span class="p">]</span> <span class="mi">0016</span><span class="n">_code_sub_class_of_data</span>
 <span class="p">[</span><span class="n">X</span><span class="p">]</span> <span class="mi">0017</span><span class="n">_drop_dbcalcstate</span>
 <span class="p">[</span><span class="n">X</span><span class="p">]</span> <span class="mi">0018</span><span class="n">_django_1_11</span>
</pre></div>
</div>
<p>Chose the previous migration step and migrate to it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">migrate</span> <span class="n">db</span> <span class="mi">0017</span><span class="n">_drop_dbcalcstate</span>
</pre></div>
</div>
<p>Check that both: upgrade and downgrade changes are succesfull and if yes, go
to the next step.</p>
</li>
<li><p class="first">Prepare tests for your migrations. An example of a test can be found here:
<code class="docutils literal notranslate"><span class="pre">aiida_core/aiida/backends/djsite/db/subtests/migrations.py</span></code></p>
</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Such a test can only be applied to the migration of the database
content. For example, you can <strong>not</strong> test modifications of the database
column names.</p>
</div>
</div>
<div class="section" id="sqlalchemy">
<h2>SQLAlchemy<a class="headerlink" href="#sqlalchemy" title="Permalink to this headline">¶</a></h2>
<p>The SQLAlchemy database schema can be found in <code class="docutils literal notranslate"><span class="pre">aiida/backends/sqlalchemy/models</span></code></p>
<p>If you need to change the database schema follow these steps:</p>
<ol class="arabic">
<li><p class="first">Make all the necessary changes to the model than you would like to modify
located in the <code class="docutils literal notranslate"><span class="pre">aiida/backends/sqlalchemy/models</span></code> directory.</p>
</li>
<li><p class="first">Create new migration file by going to <code class="docutils literal notranslate"><span class="pre">aiida/backends/sqlalchemy</span></code> and
executing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">alembic_manage</span><span class="o">.</span><span class="n">py</span> <span class="n">revision</span> <span class="s2">&quot;This is the description for the next revision&quot;</span>
</pre></div>
</div>
<p>This will create a new migration file in <code class="docutils literal notranslate"><span class="pre">aiida/backends/sqlalchemy/migrations/versions</span></code>
whose names begins with an automatically generated hash code and the
provided message for this new migration. Modify the migration message
for your convinience.</p>
</li>
<li><p class="first">Have a look at the generated migration file and ensure that migration
is correct. The file should contain automatically generated hashes that
point to the previous and to the current revision:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">revision</span> <span class="o">=</span> <span class="s1">&#39;e72ad251bcdb&#39;</span>
<span class="n">down_revision</span> <span class="o">=</span> <span class="s1">&#39;b8b23ddefad4&#39;</span>
</pre></div>
</div>
<p>Also <code class="docutils literal notranslate"><span class="pre">upgrade()</span></code> and <code class="docutils literal notranslate"><span class="pre">downgrade()</span></code> function defenitions should be
present in the file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">upgrade</span><span class="p">():</span>
   <span class="c1"># some upgrage operations</span>
<span class="k">def</span> <span class="nf">downgrade</span><span class="p">():</span>
   <span class="c1"># some downgrade operations</span>
</pre></div>
</div>
<p>If you want to add some changes that affect the content of the database –
you should do it ‘’manually’’ by adding some sql commands that will run
directly on your database. Learn the following example and adapt it for your
needs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="k">import</span> <span class="n">text</span>

<span class="n">forward_sql</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sd">&quot;&quot;&quot;UPDATE db_dbgroup SET type_string = &#39;auto.import&#39; WHERE type_string = &#39;aiida.import&#39;;&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;UPDATE db_dbgroup SET type_string = &#39;auto.run&#39; WHERE type_string = &#39;autogroup.run&#39;;&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">]</span>

<span class="n">reverse_sql</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sd">&quot;&quot;&quot;UPDATE db_dbgroup SET type_string = &#39;aiida.import&#39; WHERE type_string = &#39;auto.import&#39;;&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;UPDATE db_dbgroup SET type_string = &#39;autogroup.run&#39; WHERE type_string = &#39;auto.run&#39;;&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">]</span>

<span class="k">def</span> <span class="nf">upgrade</span><span class="p">():</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">get_bind</span><span class="p">()</span>
    <span class="n">statement</span> <span class="o">=</span> <span class="n">text</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">forward_sql</span><span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">downgrade</span><span class="p">():</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">get_bind</span><span class="p">()</span>
    <span class="n">statement</span> <span class="o">=</span> <span class="n">text</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reverse_sql</span><span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
</pre></div>
</div>
<p>If you want to learn more about the migration operations, you can have a
look at the Alembic documentation.</p>
</li>
<li><p class="first">Your database will be automatically migrated to the latest revision as soon
as you run your first verdi command. You can also migrate it manually with
the help of the alembic_manage.py script as you can see below.</p>
</li>
<li><p class="first">Prepare tests for your migrations. An example of a test can be found here:
<code class="docutils literal notranslate"><span class="pre">aiida_core/aiida/backends/sqlalchemy/tests/migrations.py</span></code></p>
</li>
</ol>
<div class="section" id="overview-of-alembic-manage-py-commands">
<h3>Overview of alembic_manage.py commands<a class="headerlink" href="#overview-of-alembic-manage-py-commands" title="Permalink to this headline">¶</a></h3>
<p>The alembic_manage.py provides several options to control your SQLAlchemy
migrations. By executing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">alembic_manage</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">help</span>
</pre></div>
</div>
<p>you will get a full list of the available arguments that you can pass and
commands. Briefly, the available commands are:</p>
<ul class="simple">
<li><strong>upgrade</strong> This command allows you to upgrade to the later version. For the
moment, you can only upgrade to the latest version.</li>
<li><strong>downgrade</strong> This command allows you to downgrade the version of your
database. For the moment, you can only downgrade to the base version.</li>
<li><strong>history</strong> This command lists the available migrations in chronological
order.</li>
<li><strong>current</strong> This command displays the current version of the database.</li>
<li><strong>revision</strong> This command creates a new migration file based on the model
changes.</li>
</ul>
</div>
<div class="section" id="debugging-alembic">
<span id="first-alembic-migration"></span><h3>Debugging Alembic<a class="headerlink" href="#debugging-alembic" title="Permalink to this headline">¶</a></h3>
<p>Alembic migrations should work automatically and migrate your database to the
latest version. However, if you were using SQLAlchemy before we introduced
Alembic, you may get a message like to following during the first migration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span> <span class="p">(</span><span class="n">psycopg2</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">)</span> <span class="n">relation</span>
<span class="s2">&quot;db_dbuser&quot;</span> <span class="n">already</span> <span class="n">exists</span> <span class="p">[</span><span class="n">SQL</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">CREATE TABLE db_dbuser (</span><span class="se">\n\t</span><span class="s1">id SERIAL</span>
<span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span> \<span class="n">n</span>\<span class="n">temail</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">254</span><span class="p">),</span> \<span class="n">n</span>\<span class="n">tpassword</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
\<span class="n">n</span>\<span class="n">tis_superuser</span> <span class="n">BOOLEAN</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span> \<span class="n">n</span>\<span class="n">tfirst_name</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">254</span><span class="p">),</span>
\<span class="n">n</span>\<span class="n">tlast_name</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">254</span><span class="p">),</span> \<span class="n">n</span>\<span class="n">tinstitution</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">254</span><span class="p">),</span> \<span class="n">n</span>\<span class="n">tis_staff</span>
<span class="n">BOOLEAN</span><span class="p">,</span> \<span class="n">n</span>\<span class="n">tis_active</span> <span class="n">BOOLEAN</span><span class="p">,</span> \<span class="n">n</span>\<span class="n">tlast_login</span> <span class="n">TIMESTAMP</span> <span class="n">WITH</span> <span class="n">TIME</span> <span class="n">ZONE</span><span class="p">,</span>
\<span class="n">n</span>\<span class="n">tdate_joined</span> <span class="n">TIMESTAMP</span> <span class="n">WITH</span> <span class="n">TIME</span> <span class="n">ZONE</span><span class="p">,</span> \<span class="n">n</span>\<span class="n">tCONSTRAINT</span> <span class="n">db_dbuser_pkey</span>
<span class="n">PRIMARY</span> <span class="n">KEY</span> <span class="p">(</span><span class="nb">id</span><span class="p">)</span>\<span class="n">n</span><span class="p">)</span>\<span class="n">n</span>\<span class="n">n</span><span class="s1">&#39;]</span>
</pre></div>
</div>
<p>In this case, you should create manually the Alembic table in your database and
add a line with the database version number. To do so, use psql to connect
to the desired database:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">psql</span> <span class="n">aiidadb_sqla</span>
</pre></div>
</div>
<p>(you should replace <code class="docutils literal notranslate"><span class="pre">aiidadb_sqla</span></code> with the name of the database that you
would like to modify). Then, execute the following commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">alembic_version</span> <span class="p">(</span><span class="n">version_num</span> <span class="n">character</span> <span class="n">varying</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="ow">not</span> <span class="n">null</span><span class="p">,</span> <span class="n">PRIMARY</span> <span class="n">KEY</span><span class="p">(</span><span class="n">version_num</span><span class="p">));</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">alembic_version</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;e15ef2630a1b&#39;</span><span class="p">);</span>
<span class="n">GRANT</span> <span class="n">ALL</span> <span class="n">ON</span> <span class="n">alembic_version</span> <span class="n">TO</span> <span class="n">aiida</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="extend_restapi.html" class="btn btn-neutral float-right" title="How to extend the AiiDA REST API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="database_schema.html" class="btn btn-neutral float-left" title="Database schema" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>