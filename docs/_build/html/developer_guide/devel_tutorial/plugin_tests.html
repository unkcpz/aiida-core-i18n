

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Writing tests for plugin &mdash; AiiDA 1.0.0b2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/contentui.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/contentui.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Commandline plugin - Data subcommand" href="cmdline_plugin.html" />
    <link rel="prev" title="Data plugin - Float Summation" href="code_plugin_float_sum.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> AiiDA
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install/quick_installation.html">Quick installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/updating_installation.html">Updating AiiDA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/index.html">First things first</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/daemon.html">Setup the daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/computers.html">Setup a computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/codes.html">Setup a code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get_started/plugins.html">Plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../working/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working/functions.html">Calculation and work functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working/calculations.html">Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working/workflows.html">Workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AiiDA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#scripting">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#data-types">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#groups">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#schedulers">Schedulers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#querying-data">Querying data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#caching">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#result-manager">Result manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#backups">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#rest-api">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../working_with_aiida/index.html#cookbook">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../import_export/index.html">Import and Export</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">AiiDA design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#aiida-core">AiiDA core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#aiida-plugins">AiiDA plugins</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/index.html">StructureData</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/index.html#pseudopotentials">Pseudopotentials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../tutorial/index.html#plugin-development">Plugin development</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="code_plugin_float_sum.html">Data plugin - Float Summation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Writing tests for plugin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#using-the-pytest-framework">Using the pytest framework</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#preparing-the-fixtures">Preparing the fixtures</a></li>
<li class="toctree-l4"><a class="reference internal" href="#import-statements-in-tests">Import statements in tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-the-tests">Running the tests</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-unittest-framework">Using the unittest framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="#migrating-existing-aiidatestcase-tests">Migrating existing AiidaTestCase tests</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cmdline_plugin.html">Commandline plugin - Data subcommand</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_">`aiida package &lt;https://aiida-core.readthedocs.io/en/latest/apidoc/aiida.html&gt;`_</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">AiiDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">AiiDA design</a> &raquo;</li>
        
      <li>Writing tests for plugin</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/developer_guide/devel_tutorial/plugin_tests.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="writing-tests-for-plugin">
<span id="plugin-testing"></span><h1>Writing tests for plugin<a class="headerlink" href="#writing-tests-for-plugin" title="Permalink to this headline">¶</a></h1>
<p>When developing a plugin it is important to write tests. The main concern of running
tests is that the test environment has to be separated from the production environment
and care should be taken to avoid any unwanted change to the user’s database.
You may have noticed that <code class="docutils literal notranslate"><span class="pre">aiida_core</span></code> has its own test framework for developments.
While it is possible to use the same framework for the plugins,
it is not ideal as any tests of plugins has to be run with
the <code class="docutils literal notranslate"><span class="pre">verdi</span> <span class="pre">devel</span> <span class="pre">tests</span></code> command-line interface.
Special profiles also have to be set mannually by the user and in automated test environments.</p>
<p>AiiDA ships with tools to simplify tests for plugins.
The recommended way is to use the <a class="reference external" href="https://pytest.org">pytest</a> framework, while the <a class="reference external" href="https://docs.python.org/library/unittest.html">unittest</a> package is also supported.
Internally, test environments are created and managed by the <a class="reference internal" href="../../apidoc/aiida.manage.html#aiida.manage.fixtures.fixture_manager" title="aiida.manage.fixtures.fixture_manager"><code class="xref py py-func docutils literal notranslate"><span class="pre">aiida.manage.fixtures.fixture_manager()</span></code></a> defined in <a class="reference internal" href="../../apidoc/aiida.manage.html#module-aiida.manage.fixtures" title="aiida.manage.fixtures"><code class="xref py py-mod docutils literal notranslate"><span class="pre">aiida.manage.fixtures</span></code></a>.</p>
<div class="section" id="using-the-pytest-framework">
<h2>Using the pytest framework<a class="headerlink" href="#using-the-pytest-framework" title="Permalink to this headline">¶</a></h2>
<p>In this section we will introduce using the <code class="docutils literal notranslate"><span class="pre">pytest</span></code> framework to write tests for
plugins.</p>
<div class="section" id="preparing-the-fixtures">
<h3>Preparing the fixtures<a class="headerlink" href="#preparing-the-fixtures" title="Permalink to this headline">¶</a></h3>
<p>One important concept of the pytest framework is the <a class="reference external" href="https://docs.pytest.org/en/latest/fixture.html">fixture</a>.
A fixture is something that a test requires. It could be a predefined object that the
test act on, resources for the tests, or just some code you want to run before the
test starts. Please see pytest’s <a class="reference external" href="https://docs.pytest.org/en/latest/">documentation</a> for details, especially if you are new to writing testes.</p>
<p>To utilize the <code class="docutils literal notranslate"><span class="pre">fixture_manager</span></code>, we first need to define the actual fixtures:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida_core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">For pytest</span>
<span class="sd">This file should be put into the root directory of the package to make</span>
<span class="sd">the fixtures available to all tests.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">aiida.manage.fixtures</span> <span class="k">import</span> <span class="n">fixture_manager</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">aiida_profile</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;setup a test profile for the duration of the tests&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">fixture_manager</span><span class="p">()</span> <span class="k">as</span> <span class="n">fixture_mgr</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">fixture_mgr</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">new_database</span><span class="p">(</span><span class="n">aiida_profile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a the database for the test and clean it up after it finishes&quot;&quot;&quot;</span>
    <span class="n">aiida_profile</span><span class="o">.</span><span class="n">reset_db</span><span class="p">()</span>
    <span class="k">return</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">new_workdir</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;get a new temporary folder to use as the computer&#39;s wrkdir&quot;&quot;&quot;</span>
    <span class="n">dirpath</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">dirpath</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">aiida_profile</span></code> fixture initialize the <code class="docutils literal notranslate"><span class="pre">fixture_manager</span></code> yields it to the test function.
By using the <em>with</em> clause, we ensure that the test profile to run tests are destroyed in the end.
The scope of this fixture should be <em>session</em>, since there is no need to re-initialize the
test profile mid-way.
The next fixture <code class="docutils literal notranslate"><span class="pre">new_database</span></code> request the <code class="docutils literal notranslate"><span class="pre">aiida_profile</span></code> fixture and tells the received <code class="docutils literal notranslate"><span class="pre">FixtureManager</span></code> instance to reset the database.
By requesting the <code class="docutils literal notranslate"><span class="pre">new_database</span></code> fixture, the test function will start with a fresh aiida environment.
The next fixture, <code class="docutils literal notranslate"><span class="pre">new_workdir</span></code>, returns an temporary directory for file operations and delete it when the test is finished.
You may also want to define other fixtures such as those setup and return <code class="docutils literal notranslate"><span class="pre">Data</span></code> nodes or prepare calculations.</p>
<p>To make these fixtures available to all tests, they can be put into the <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code>
in root level of the package or <code class="docutils literal notranslate"><span class="pre">tests</span></code> sub-packages. The code shown above can be downloaded <a class="reference download internal" download="" href="../../_downloads/ce7c991d724ee18802a4e00863e68801/conftest.py"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">More information of <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> can be found <a class="reference external" href="conftest">here</a>.</p>
</div>
</div>
<div class="section" id="import-statements-in-tests">
<h3>Import statements in tests<a class="headerlink" href="#import-statements-in-tests" title="Permalink to this headline">¶</a></h3>
<p>When running test, it is important that you DO NOT explicitly load the aiida database
via <code class="docutils literal notranslate"><span class="pre">load_dbenv()</span></code>, which could result in corruption of your database with actual data.
However, many AiiDA modules, such as those in <code class="docutils literal notranslate"><span class="pre">aiida.orm</span></code> cannot be loaded without calling <code class="docutils literal notranslate"><span class="pre">load_dbenv()</span></code> first.
Modules in your plugin may also import such aiida modules at the top level.
Hence, they can not be imported directly in test modules.
To solve this issue, import should be delayed until the test profile has been loaded.
You can always import these required modules inside the test function.
A better way is to define a fixture as a loader for module imports.
For example, instead of having:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">aiida.orm</span> <span class="k">as</span> <span class="nn">orm</span>
</pre></div>
</div>
<p>at the module level, you can define a fixture:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;module&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">orm</span><span class="p">(</span><span class="n">aiida_profile</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">aiida.orm</span> <span class="k">as</span> <span class="nn">orm</span>
    <span class="k">return</span> <span class="n">orm</span>
</pre></div>
</div>
<p>and simply request this fixture for your test function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_load_dataclass</span><span class="p">(</span><span class="n">orm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test loading a data class defined by the plugin&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">aiida.plugins</span> <span class="k">import</span> <span class="n">DataFactory</span>
    <span class="n">MyData</span> <span class="o">=</span> <span class="n">DataFactory</span><span class="p">(</span><span class="s1">&#39;myplugin.maydata&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We set <code class="docutils literal notranslate"><span class="pre">'scope='module'</span></code> to declare that this is module scope fixture and
avoids repetitively doing the import for each test.
It is also possible to group many imports in a single fixture:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;module&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">imps</span><span class="p">(</span><span class="n">aiida_profile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return an class with all imports as its attributes&quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">Imports</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">aiida.orm</span> <span class="k">as</span> <span class="nn">orm</span>

    <span class="k">return</span> <span class="n">Imports</span>


<span class="k">def</span> <span class="nf">test_load_dataclass</span><span class="p">(</span><span class="n">imps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test loading a data class defined by the plugin&quot;&quot;&quot;</span>
    <span class="n">MyData</span> <span class="o">=</span> <span class="n">imps</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">DataFactory</span><span class="p">(</span><span class="s1">&#39;my_plugin.maydata&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Requesting the <code class="docutils literal notranslate"><span class="pre">aiida_profile</span></code> fixture in the <code class="docutils literal notranslate"><span class="pre">imps</span></code> fixture guarantees
that the test environment will be loaded before the any import statement are executed.</p>
</div>
<div class="section" id="running-the-tests">
<h3>Running the tests<a class="headerlink" href="#running-the-tests" title="Permalink to this headline">¶</a></h3>
<p>Finally, to run the tests, simply type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pytest</span>
</pre></div>
</div>
<p>in your terminal from the code directory.
The discovery of the tests will be handled by pytest (file, class and function name should start with the word <strong>test</strong>)</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Your terminal will print something out during the creation of a test profile.
Do not panic, as and the aiida profile and database are completely isolated and
will not affect your <code class="docutils literal notranslate"><span class="pre">.aiida</span></code> folder and file repositories.
Internally, at temporary folder is used as the <code class="docutils literal notranslate"><span class="pre">.aiida</span></code> folder and the test
database are created using the <a class="reference external" href="https://github.com/jamesnunn/pgtest">pgtest</a> package.</p>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">Before jumping in and start writing your own tests, please takes a look at the tests provided in the
<a class="reference external" href="https://github.com/aiidateam/aiida-plugin-cutter/">aiida-cutter</a> plugin template.</p>
</div>
</div>
</div>
<div class="section" id="using-the-unittest-framework">
<h2>Using the unittest framework<a class="headerlink" href="#using-the-unittest-framework" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">uniitest</span></code> package is included in the python standard library.
It is widely used despite some limitations (it is also used for testing <code class="docutils literal notranslate"><span class="pre">aiida_core</span></code>).
We provide a <a class="reference internal" href="../../apidoc/aiida.manage.html#aiida.manage.fixtures.PluginTestCase" title="aiida.manage.fixtures.PluginTestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">aiida.manage.fixtures.PluginTestCase</span></code></a> to be used for inheritance.
By default, each test method in the test case class runs with a fresh aiida database.
Due to the limitation of <code class="docutils literal notranslate"><span class="pre">uniitest</span></code>, sub-clasess of <code class="docutils literal notranslate"><span class="pre">PluginTestCase</span></code> has to be run
with the special runner in  <a class="reference internal" href="../../apidoc/aiida.manage.html#aiida.manage.fixtures.TestRunner" title="aiida.manage.fixtures.TestRunner"><code class="xref py py-class docutils literal notranslate"><span class="pre">aiida.manage.fixtures.TestRunner</span></code></a>.
To run the actually tests, you need to prepare a run script in python:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">uniitest</span>
<span class="kn">from</span> <span class="nn">aiida.manage.fixtures</span> <span class="k">import</span> <span class="n">TestRunner</span>

<span class="n">test</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">deaultTestLoader</span><span class="o">.</span><span class="n">discover</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">TestRunner</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tests</span><span class="p">)</span>
</pre></div>
</div>
<p>Save it as <code class="docutils literal notranslate"><span class="pre">run_tests.py</span></code> and tests can be discovered and run using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">run_test</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</div>
<div class="section" id="migrating-existing-aiidatestcase-tests">
<h2>Migrating existing AiidaTestCase tests<a class="headerlink" href="#migrating-existing-aiidatestcase-tests" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">pytest</span></code> framework can also be used to run <code class="docutils literal notranslate"><span class="pre">unittest</span></code> tests.
Here, we will explain how to migrate existing tests for the plugins,
written as sub-classes of <code class="docutils literal notranslate"><span class="pre">AiidaTestCase</span></code> to work with <code class="docutils literal notranslate"><span class="pre">pytest</span></code>.
First, let’s see a typical test class using the <code class="docutils literal notranslate"><span class="pre">unittest</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aiida.plugins</span> <span class="k">import</span> <span class="n">DataFactory</span>

<span class="c1"># Assuming our new date type has entry point myplugin.complex</span>
<span class="n">ComplexData</span> <span class="o">=</span> <span class="n">DataFactory</span><span class="p">(</span><span class="s2">&quot;myplugin.complex&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TestComplexData</span><span class="p">(</span><span class="n">AiidaTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clean up database for each test&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_db</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">store_complex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp_num</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store a complex number, returns pk&quot;&quot;&quot;</span>
        <span class="n">comdata</span> <span class="o">=</span> <span class="n">ComplexData</span><span class="p">()</span>
        <span class="n">comdata</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">comp_num</span>
        <span class="k">return</span> <span class="n">comdata</span><span class="o">.</span><span class="n">pk</span>

    <span class="k">def</span> <span class="nf">test_complex_store</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test if the complex numbers can be stored&quot;&quot;&quot;</span>

        <span class="n">comdata</span> <span class="o">=</span> <span class="n">ComplexData</span><span class="p">()</span>
        <span class="n">comdata</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="n">j</span>
        <span class="n">comdata</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_complex_retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;&quot;&quot;Test if the complex</span>

<span class="s2">        comp_num = 1 + 2j</span>
<span class="s2">        pk = self.store_complex(cnum)</span>
<span class="s2">        comdata = load_node(pk)</span>
<span class="s2">        self.assertEqual(comdata.value == comp_num)</span>
</pre></div>
</div>
<p>We can modify this test class using some of the pytest features to allow it to be
run with <code class="docutils literal notranslate"><span class="pre">pytest</span></code> directly, as shown below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Assuming our new date type has entry point myplugin.complex</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="hll"><span class="nd">@pytest.fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;module&#39;</span><span class="p">)</span>
</span><span class="hll"><span class="k">def</span> <span class="nf">module_import</span><span class="p">(</span><span class="n">aiida_profile</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span><span class="hll">    <span class="kn">from</span> <span class="nn">aiida.plugins</span> <span class="kn">import</span> <span class="n">DataFactory</span>
</span><span class="hll">    <span class="n">ComplexData</span> <span class="o">=</span> <span class="n">DataFactory</span><span class="p">(</span><span class="s2">&quot;myplugin.complex&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
</span><span class="hll">        <span class="nb">setattr</span><span class="p">(</span><span class="n">resquest</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span>

<span class="hll"><span class="nd">@pytest.mark.usefixtures</span><span class="p">(</span><span class="s1">&#39;module_import&#39;</span><span class="p">)</span>
</span><span class="k">class</span> <span class="nc">TestComplexData</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test ComplexData. Compatible with pytest.&quot;&quot;&quot;</span>

<span class="hll">    <span class="nd">@pytest.fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">reset_db</span><span class="p">(</span><span class="n">aiida_profile</span><span class="p">):</span>
</span><span class="hll">        <span class="n">aiida_profile</span><span class="o">.</span><span class="n">reset_db</span><span class="p">()</span>
</span><span class="hll">        <span class="k">yield</span>
</span><span class="hll">        <span class="n">aiida_profile</span><span class="o">.</span><span class="n">reset_db</span><span class="p">()</span>
</span>
    <span class="k">def</span> <span class="nf">store_complex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp_num</span><span class="p">):</span>
        <span class="n">comdata</span> <span class="o">=</span> <span class="n">ComplexData</span><span class="p">()</span>
        <span class="n">comdata</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">comp_num</span>
        <span class="k">return</span> <span class="n">comdata</span><span class="o">.</span><span class="n">pk</span>

    <span class="k">def</span> <span class="nf">test_complex_store</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test if the complex numbers can be stored&quot;&quot;&quot;</span>
        <span class="n">comdata</span> <span class="o">=</span> <span class="n">ComplexData</span><span class="p">()</span>
        <span class="n">comdata</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2j</span>
        <span class="n">comdata</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_complex_retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test if the complex number stored can be retrieved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">comp_num</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2j</span>
        <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_complex</span><span class="p">(</span><span class="n">cnum</span><span class="p">)</span>
        <span class="n">comdata</span> <span class="o">=</span> <span class="n">load_node</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">comdata</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">comp_num</span><span class="p">)</span>
</pre></div>
</div>
<p>To allow pytest to run the tests, we first swap the <code class="docutils literal notranslate"><span class="pre">AiidaTestCase</span></code> with the generic
<code class="docutils literal notranslate"><span class="pre">TestCase</span></code>. We define a module scope fixture <code class="docutils literal notranslate"><span class="pre">module_import</span></code> to import the
required AiiDA modules and make them available in the module namespace.
All previous module levels imports should be encapsulated inside this fixture.
The <a class="reference external" href="https://docs.pytest.org/en/3.6.3/reference.html#request">request</a> is a built-in fixture in pytest to allow introspect of the function
from which the fixture is requested.
Here, we simply add every things in the function scope back into the module of the
class which requested the fixture.</p>
<p>Instead of the <code class="docutils literal notranslate"><span class="pre">setUp</span></code> and <code class="docutils literal notranslate"><span class="pre">tearDown</span></code> methods,
we define a <code class="docutils literal notranslate"><span class="pre">reset_db</span></code> fixture to reset the database for every tests.
The <code class="docutils literal notranslate"><span class="pre">autouse=True</span></code> flag tells all test methods inside the class to use it automatically.</p>
<p>When migrating your code to use the pytest, you may define a base class with these
modifications and use it as the superclass for other test classes.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">More details can be found in the <a class="reference external" href="https://docs.pytest.org/en/latest/unittest.html">pytest documentation</a> about running <code class="docutils literal notranslate"><span class="pre">unittest</span></code> tests.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The modification will break the compatibility of <code class="docutils literal notranslate"><span class="pre">uniitest</span></code> and you will not be able
to run with <code class="docutils literal notranslate"><span class="pre">verdi</span> <span class="pre">devel</span> <span class="pre">tests</span></code> interface.
Do not forget to remove redundant entry points in your setup.json.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="cmdline_plugin.html" class="btn btn-neutral float-right" title="Commandline plugin - Data subcommand" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="code_plugin_float_sum.html" class="btn btn-neutral float-left" title="Data plugin - Float Summation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE (Theory and Simulation of Materials (THEOS) and National Centre for Computational Design and Discovery of Novel Materials (NCCR MARVEL)), Switzerland and ROBERT BOSCH LLC, USA. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>